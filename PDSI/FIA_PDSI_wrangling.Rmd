---
title: "FIA PDSI DATA WRANGLING"
author: "JAH"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_float: yes
    toc_collapsed: yes
    toc_depth: 3
---

```{r, include=FALSE, echo = FALSE}
knitr::opts_chunk$set(tidy.opts=list(width.cutoff=60),tidy=TRUE, echo = FALSE, message = TRUE, warning = TRUE, cache.lazy = FALSE)
```

# Background

In this analysis, PDSI data is extracted for all FIA plot locations from the .nc files obtained from: 
https://wrcc.dri.edu/wwdt/index.php?folder=pdsi  and  https://wrcc.dri.edu/wwdt/data/PRISM/pdsi/

PDSI data will only be used over the growing season -- i.e., from January to August.  Analyses were explored using June, July and August only (summer growing season) and were found to not be different 

The climate deviation (Î”PDSI) is calculated as difference in between the mean over a growth or biomass interval and the baseline mean.  The baseline mean is calculated over a 30-year climate normal from 1960-1989.  

```{r}
### working directory
setwd("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI")

## libraries
library(terra)

## read in the the G data file (has spatial coordinates for plot locations)
load("C:/Users/hogan.jaaron/Dropbox/FIA_R/Starter_FIA_data_processing/G_dataset.Rdata")

load("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/G_pdsi_data.Rdata")

load("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/G_pdsi_data_PlotBiomass.Rdata")

load("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/P_pdsi_data.Rdata")
```

```{r}
### read in the data -
pdsi1 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_1_PRISM.nc")
names(pdsi1) <- as.character(1895:2022)

pdsi2 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_2_PRISM.nc")
names(pdsi2) <- as.character(1895:2022)

pdsi3 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_3_PRISM.nc")
names(pdsi3) <- as.character(1895:2022)

pdsi4 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_4_PRISM.nc")
names(pdsi4) <- as.character(1895:2022)

pdsi5 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_5_PRISM.nc")
names(pdsi5) <- as.character(1895:2022)

###### first pass: limited analysis to growing season - June, July and August -
pdsi6 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_6_PRISM.nc")
names(pdsi6) <- as.character(1895:2022)

pdsi7 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_7_PRISM.nc")
names(pdsi7) <- as.character(1895:2022)

pdsi8 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_8_PRISM.nc")
names(pdsi8) <- as.character(1895:2022)
```

```{r}
## make null dataframe
G_pdsi_data <-  data.frame(pltID = G$pltID,
                         LAT = G$LAT,
                         LON = G$LON,
                         MEASTIME_t1 = G$MEASTIME_t1,
                         MEASTIME_t2 = G$MEASTIME_t2,
                         REMPER = G$REMPER,
                         pdsi_baseline = rep(-9999, length(G$pltID)),
                         pdsi_growInt = rep(-9999, length(G$pltID)))


### if missing MEASTIME_t1: take MEASTIME_t2 minus REMPER
G_pdsi_data[is.na(G_pdsi_data$MEASTIME_t1),]$MEASTIME_t1 <- G_pdsi_data[is.na(G_pdsi_data$MEASTIME_t1),]$MEASTIME_t2 - G_pdsi_data[is.na(G_pdsi_data$MEASTIME_t1),]$REMPER

```

```{r}
## makes spatVector for spatial points of plot locations
G_pts <- vect(cbind(G_pdsi_data$LON, G_pdsi_data$LAT), crs="+proj=longlat +datum=WGS84")
```


```{r}
##################################################### START FOR LOOP
### for loop to extract time-series data for each plot location
for(i in 1:length(G_pdsi_data$pltID)){

  ### extract values
  pdsi_vec.1 <- unlist(terra::extract(pdsi1, G_pts[i]))

  pdsi_vec.2 <- unlist(terra::extract(pdsi2, G_pts[i]))

  pdsi_vec.3 <- unlist(terra::extract(pdsi3, G_pts[i]))

  pdsi_vec.4 <- unlist(terra::extract(pdsi4, G_pts[i]))

  pdsi_vec.5 <- unlist(terra::extract(pdsi5, G_pts[i]))

  pdsi_vec.6 <- unlist(terra::extract(pdsi6, G_pts[i]))

  pdsi_vec.7 <- unlist(terra::extract(pdsi7, G_pts[i]))

  pdsi_vec.8 <- unlist(terra::extract(pdsi8, G_pts[i]))

  ### calculate the average baseline value 1960-1989 --- 30 year climate normal
  G_pdsi_data$pdsi_baseline[i] <- mean(c(pdsi_vec.1[as.character(rep(1960:1989))],
                                         pdsi_vec.2[as.character(rep(1960:1989))],
                                         pdsi_vec.3[as.character(rep(1960:1989))],
                                         pdsi_vec.4[as.character(rep(1960:1989))],
                                         pdsi_vec.5[as.character(rep(1960:1989))],
                                         pdsi_vec.6[as.character(rep(1960:1989))],
                                         pdsi_vec.7[as.character(rep(1960:1989))],
                                         pdsi_vec.8[as.character(rep(1960:1989))]),
                                       na.rm = T)

  ### calculate the mean over the growth interval
  G_pdsi_data$pdsi_growInt[i] <- mean(c(pdsi_vec.1[names(pdsi_vec.1) %in%
                                                            seq(floor(G_pdsi_data$MEASTIME_t1[i]), floor(G_pdsi_data$MEASTIME_t2[i]))],
                                        pdsi_vec.2[names(pdsi_vec.2) %in%
                                                            seq(floor(G_pdsi_data$MEASTIME_t1[i]), floor(G_pdsi_data$MEASTIME_t2[i]))],
                                        pdsi_vec.3[names(pdsi_vec.3) %in%
                                                            seq(floor(G_pdsi_data$MEASTIME_t1[i]), floor(G_pdsi_data$MEASTIME_t2[i]))],
                                        pdsi_vec.4[names(pdsi_vec.4) %in%
                                                            seq(floor(G_pdsi_data$MEASTIME_t1[i]), floor(G_pdsi_data$MEASTIME_t2[i]))],
                                        pdsi_vec.5[names(pdsi_vec.5) %in%
                                                            seq(floor(G_pdsi_data$MEASTIME_t1[i]), floor(G_pdsi_data$MEASTIME_t2[i]))],
                                        pdsi_vec.6[names(pdsi_vec.6) %in%
                                                             seq(floor(G_pdsi_data$MEASTIME_t1[i]), floor(G_pdsi_data$MEASTIME_t2[i]))],
                                        pdsi_vec.7[names(pdsi_vec.7) %in%
                                                             seq(floor(G_pdsi_data$MEASTIME_t1[i]), floor(G_pdsi_data$MEASTIME_t2[i]))],
                                        pdsi_vec.8[names(pdsi_vec.8) %in%
                                                             seq(floor(G_pdsi_data$MEASTIME_t1[i]), floor(G_pdsi_data$MEASTIME_t2[i]))]),
                                    na.rm = T)

} ## end for loop
#####################################################

## make column for difference
G_pdsi_data$DeltaPDSI <-  G_pdsi_data$pdsi_growInt - G_pdsi_data$pdsi_baseline
```

```{r}
### deal with NaNs

## for some plots - the PDSI caclcuation did not compute usint lat lon point estimation.  For those plots, we use the bilinear method of raster::extract, which interpolates values using the four nearest raster cells.

NaN_vec  <- as.numeric(row.names(G_pdsi_data[is.na(G_pdsi_data$DeltaPDSI),]))

### for loop to extract time-series data for each plot location
for(i in 1:length(NaN_vec)){

  ### extract values
  pdsi_vec.1 <- unlist(terra::extract(pdsi1, G_pts[NaN_vec[i]], method = "bilinear"))

  pdsi_vec.2 <- unlist(terra::extract(pdsi2, G_pts[NaN_vec[i]], method = "bilinear"))

  pdsi_vec.3 <- unlist(terra::extract(pdsi3, G_pts[NaN_vec[i]], method = "bilinear"))

  pdsi_vec.4 <- unlist(terra::extract(pdsi4, G_pts[NaN_vec[i]], method = "bilinear"))

  pdsi_vec.5 <- unlist(terra::extract(pdsi5, G_pts[NaN_vec[i]], method = "bilinear"))

  pdsi_vec.6 <- unlist(terra::extract(pdsi6, G_pts[NaN_vec[i]], method = "bilinear"))

  pdsi_vec.7 <- unlist(terra::extract(pdsi7, G_pts[NaN_vec[i]], method = "bilinear"))

  pdsi_vec.8 <- unlist(terra::extract(pdsi8, G_pts[NaN_vec[i]], method = "bilinear"))

  ### calculate the average baseline value 1960-1989 --- 30 year climate normal
  G_pdsi_data$pdsi_baseline[NaN_vec[i]] <- mean(c(pdsi_vec.1[as.character(rep(1960:1989))],
                                                  pdsi_vec.2[as.character(rep(1960:1989))],
                                                  pdsi_vec.3[as.character(rep(1960:1989))],
                                                  pdsi_vec.4[as.character(rep(1960:1989))],
                                                  pdsi_vec.5[as.character(rep(1960:1989))],
                                                  pdsi_vec.6[as.character(rep(1960:1989))],
                                                  pdsi_vec.7[as.character(rep(1960:1989))],
                                                  pdsi_vec.8[as.character(rep(1960:1989))]),
                                                na.rm = T)

  ### calculate the mean over the growth interval
  G_pdsi_data$pdsi_growInt[NaN_vec[i]] <- mean(c(pdsi_vec.1[names(pdsi_vec.1) %in%
                                                          seq(floor(G_pdsi_data$MEASTIME_t1[NaN_vec[i]]), floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]]))],
                                                 pdsi_vec.2[names(pdsi_vec.2) %in%
                                                           seq(floor(G_pdsi_data$MEASTIME_t1[NaN_vec[i]]), floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]]))],
                                                 pdsi_vec.3[names(pdsi_vec.3) %in%
                                                           seq(floor(G_pdsi_data$MEASTIME_t1[NaN_vec[i]]), floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]]))],
                                                 pdsi_vec.4[names(pdsi_vec.4) %in%
                                                           seq(floor(G_pdsi_data$MEASTIME_t1[NaN_vec[i]]), floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]]))],
                                                 pdsi_vec.5[names(pdsi_vec.5) %in%
                                                          seq(floor(G_pdsi_data$MEASTIME_t1[NaN_vec[i]]), floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]]))],
                                                 pdsi_vec.6[names(pdsi_vec.6) %in%
                                                            seq(floor(G_pdsi_data$MEASTIME_t1[NaN_vec[i]]), floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]]))],
                                                 pdsi_vec.7[names(pdsi_vec.7) %in%
                                                            seq(floor(G_pdsi_data$MEASTIME_t1[NaN_vec[i]]), floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]]))],
                                                 pdsi_vec.8[names(pdsi_vec.8) %in%
                                                            seq(floor(G_pdsi_data$MEASTIME_t1[NaN_vec[i]]), floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]]))]),
                                               na.rm = T)

} ## end for loop
#####################################################

## make column for difference
G_pdsi_data$DeltaPDSI <-  G_pdsi_data$pdsi_growInt - G_pdsi_data$pdsi_baseline
```
 
```{r}
setwd("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI")

### save the result
save(G_pdsi_data, file = "G_pdsi_data.Rdata")
```

# Plots - G dataset growth

```{r}
plot(pdsi6$`2022`, las = 1, xlab = "Longitude", ylab = "latitiude", Main = "PDSI 2022 (June-August Avg.)")
points(G_pts, cex = 0.1, alpha = 0.25)
```


## 
```{r}
library(ggplot2)

MainStates <- map_data("state")

gg_pdsi.1 <- ggplot() +
             geom_polygon(aes(x=long, y=lat, group=group), data=MainStates,
                          color="black", fill="#9fe2bf" ) +
             geom_point(data=G_pdsi_data, aes(x=LON, y=LAT, color = DeltaPDSI),
                        alpha = .25, size = 0.5) +
             metR::scale_color_divergent(
                     name = expression(Delta~"PDSI"),
                     # here we use guide_colourbar because it is still a continuous scale
                     guide = guide_colorbar(
                       direction = "horizontal",
                       barheight = unit(2, units = "mm"),
                       barwidth = unit(50, units = "mm"),
                       draw.ulim = F,
                       title.position = 'top',
                       # some shifting around
                       title.hjust = 0.5,
                       label.hjust = 0.5)) + theme_classic() + theme(legend.position = "bottom") +
                    ggtitle("G_dataset growth interval - baseiline")

gg_pdsi.1

```

```{r}
par(mfrow = c(1,3))

hist(G_pdsi_data$pdsi_baseline, breaks = 10, xlim = c(-10,10), main = expression("PDSI"["baseline"]), xlab = "PDSI 1970-1990 (Jan-Aug)", las =1)

hist(G_pdsi_data$pdsi_growInt, breaks = 40, xlim = c(-10,10), main = expression("PDSI"["growInt"]), xlab = "PDSI over growth interval (Jan-Aug)", las =1)

hist(G_pdsi_data$DeltaPDSI, breaks = 40, xlim = c(-10,10), main = expression(Delta~"PDSI"), xlab = "PDSI_GrowInt - PDSI_baseline", las =1)

```

---


```{r}

# FOR the G DATASET ------ using 10 year previous interval

## make null dataframe
G_pdsi_data_PlotBiomass <-  data.frame(pltID = G$pltID,
                         LAT = G$LAT,
                         LON = G$LON,
                         MEASTIME_t1 = G$MEASTIME_t2 - 10,
                         MEASTIME_t2 = G$MEASTIME_t2 ,
                         pdsi_baseline = rep(-9999, length(G$pltID)),
                         pdsi_growInt = rep(-9999, length(G$pltID)))
```

```{r}
## makes spatVector for spatial points of plot locations
G_pts <- vect(cbind(G_pdsi_data_PlotBiomass$LON, G_pdsi_data_PlotBiomass$LAT), crs="+proj=longlat +datum=WGS84")
```


```{r}
##################################################### START FOR LOOP
### for loop to extract time-series data for each plot location
for(i in 1:length(G_pdsi_data_PlotBiomass$pltID)){

  ### extract values
  pdsi_vec.1 <- unlist(terra::extract(pdsi1, G_pts[i]))

  pdsi_vec.2 <- unlist(terra::extract(pdsi2, G_pts[i]))

  pdsi_vec.3 <- unlist(terra::extract(pdsi3, G_pts[i]))

  pdsi_vec.4 <- unlist(terra::extract(pdsi4, G_pts[i]))

  pdsi_vec.5 <- unlist(terra::extract(pdsi5, G_pts[i]))

  pdsi_vec.6 <- unlist(terra::extract(pdsi6, G_pts[i]))

  pdsi_vec.7 <- unlist(terra::extract(pdsi7, G_pts[i]))

  pdsi_vec.8 <- unlist(terra::extract(pdsi8, G_pts[i]))

  ### calculate the average baseline value 1960-1989 --- 30 year climate normal
  G_pdsi_data_PlotBiomass$pdsi_baseline[i] <- mean(c(pdsi_vec.1[as.character(rep(1960:1989))],
                                         pdsi_vec.2[as.character(rep(1960:1989))],
                                         pdsi_vec.3[as.character(rep(1960:1989))],
                                         pdsi_vec.4[as.character(rep(1960:1989))],
                                         pdsi_vec.5[as.character(rep(1960:1989))],
                                         pdsi_vec.6[as.character(rep(1960:1989))],
                                         pdsi_vec.7[as.character(rep(1960:1989))],
                                         pdsi_vec.8[as.character(rep(1960:1989))]),
                                       na.rm = T)

  ### calculate the mean over the growth interval
  G_pdsi_data_PlotBiomass$pdsi_growInt[i] <- mean(c(pdsi_vec.1[names(pdsi_vec.1) %in%
                                                            seq(floor(G_pdsi_data_PlotBiomass$MEASTIME_t1[i]), floor(G_pdsi_data_PlotBiomass$MEASTIME_t2[i]))],
                                        pdsi_vec.2[names(pdsi_vec.2) %in%
                                                            seq(floor(G_pdsi_data_PlotBiomass$MEASTIME_t1[i]), floor(G_pdsi_data_PlotBiomass$MEASTIME_t2[i]))],
                                        pdsi_vec.3[names(pdsi_vec.3) %in%
                                                            seq(floor(G_pdsi_data_PlotBiomass$MEASTIME_t1[i]), floor(G_pdsi_data_PlotBiomass$MEASTIME_t2[i]))],
                                        pdsi_vec.4[names(pdsi_vec.4) %in%
                                                            seq(floor(G_pdsi_data_PlotBiomass$MEASTIME_t1[i]), floor(G_pdsi_data_PlotBiomass$MEASTIME_t2[i]))],
                                        pdsi_vec.5[names(pdsi_vec.5) %in%
                                                            seq(floor(G_pdsi_data_PlotBiomass$MEASTIME_t1[i]), floor(G_pdsi_data_PlotBiomass$MEASTIME_t2[i]))],
                                        pdsi_vec.6[names(pdsi_vec.6) %in%
                                                             seq(floor(G_pdsi_data_PlotBiomass$MEASTIME_t1[i]), floor(G_pdsi_data_PlotBiomass$MEASTIME_t2[i]))],
                                        pdsi_vec.7[names(pdsi_vec.7) %in%
                                                             seq(floor(G_pdsi_data_PlotBiomass$MEASTIME_t1[i]), floor(G_pdsi_data_PlotBiomass$MEASTIME_t2[i]))],
                                        pdsi_vec.8[names(pdsi_vec.8) %in%
                                                             seq(floor(G_pdsi_data_PlotBiomass$MEASTIME_t1[i]), floor(G_pdsi_data_PlotBiomass$MEASTIME_t2[i]))]),
                                    na.rm = T)

} ## end for loop
#####################################################

## make column for difference
G_pdsi_data_PlotBiomass$DeltaPDSI <-  G_pdsi_data_PlotBiomass$pdsi_growInt - G_pdsi_data_PlotBiomass$pdsi_baseline
```

```{r}
### deal with NaNs
NaN_vec  <- as.numeric(row.names(G_pdsi_data_PlotBiomass[is.na(G_pdsi_data_PlotBiomass$DeltaPDSI),]))

### for loop to extract time-series data for each plot location
for(i in 1:length(NaN_vec)){

  ### extract values
  pdsi_vec.1 <- unlist(terra::extract(pdsi1, G_pts[NaN_vec[i]], method = "bilinear"))

  pdsi_vec.2 <- unlist(terra::extract(pdsi2, G_pts[NaN_vec[i]], method = "bilinear"))

  pdsi_vec.3 <- unlist(terra::extract(pdsi3, G_pts[NaN_vec[i]], method = "bilinear"))

  pdsi_vec.4 <- unlist(terra::extract(pdsi4, G_pts[NaN_vec[i]], method = "bilinear"))

  pdsi_vec.5 <- unlist(terra::extract(pdsi5, G_pts[NaN_vec[i]], method = "bilinear"))

  pdsi_vec.6 <- unlist(terra::extract(pdsi6, G_pts[NaN_vec[i]], method = "bilinear"))

  pdsi_vec.7 <- unlist(terra::extract(pdsi7, G_pts[NaN_vec[i]], method = "bilinear"))

  pdsi_vec.8 <- unlist(terra::extract(pdsi8, G_pts[NaN_vec[i]], method = "bilinear"))

  ### calculate the average baseline value 1960-1989 --- 30 year climate normal
  G_pdsi_data_PlotBiomass$pdsi_baseline[NaN_vec[i]] <- mean(c(pdsi_vec.1[as.character(rep(1960:1989))],
                                                  pdsi_vec.2[as.character(rep(1960:1989))],
                                                  pdsi_vec.3[as.character(rep(1960:1989))],
                                                  pdsi_vec.4[as.character(rep(1960:1989))],
                                                  pdsi_vec.5[as.character(rep(1960:1989))],
                                                  pdsi_vec.6[as.character(rep(1960:1989))],
                                                  pdsi_vec.7[as.character(rep(1960:1989))],
                                                  pdsi_vec.8[as.character(rep(1960:1989))]),
                                                na.rm = T)

  ### calculate the mean over the growth interval
  G_pdsi_data_PlotBiomass$pdsi_growInt[NaN_vec[i]] <- mean(c(pdsi_vec.1[names(pdsi_vec.1) %in%
                                                           seq(floor(G_pdsi_data_PlotBiomass$MEASTIME_t1[NaN_vec[i]]), floor(G_pdsi_data_PlotBiomass$MEASTIME_t2[NaN_vec[i]]))],
                                                 pdsi_vec.2[names(pdsi_vec.2) %in%
                                                           seq(floor(G_pdsi_data_PlotBiomass$MEASTIME_t1[NaN_vec[i]]), floor(G_pdsi_data_PlotBiomass$MEASTIME_t2[NaN_vec[i]]))],
                                                 pdsi_vec.3[names(pdsi_vec.3) %in%
                                                           seq(floor(G_pdsi_data_PlotBiomass$MEASTIME_t1[NaN_vec[i]]), floor(G_pdsi_data_PlotBiomass$MEASTIME_t2[NaN_vec[i]]))],
                                                 pdsi_vec.4[names(pdsi_vec.4) %in%
                                                           seq(floor(G_pdsi_data_PlotBiomass$MEASTIME_t1[NaN_vec[i]]), floor(G_pdsi_data_PlotBiomass$MEASTIME_t2[NaN_vec[i]]))],
                                                 pdsi_vec.5[names(pdsi_vec.5) %in%
                                                           seq(floor(G_pdsi_data_PlotBiomass$MEASTIME_t1[NaN_vec[i]]), floor(G_pdsi_data_PlotBiomass$MEASTIME_t2[NaN_vec[i]]))],
                                                 pdsi_vec.6[names(pdsi_vec.6) %in%
                                                            seq(floor(G_pdsi_data_PlotBiomass$MEASTIME_t1[NaN_vec[i]]), floor(G_pdsi_data_PlotBiomass$MEASTIME_t2[NaN_vec[i]]))],
                                                 pdsi_vec.7[names(pdsi_vec.7) %in%
                                                            seq(floor(G_pdsi_data_PlotBiomass$MEASTIME_t1[NaN_vec[i]]), floor(G_pdsi_data_PlotBiomass$MEASTIME_t2[NaN_vec[i]]))],
                                                 pdsi_vec.8[names(pdsi_vec.8) %in%
                                                            seq(floor(G_pdsi_data_PlotBiomass$MEASTIME_t1[NaN_vec[i]]), floor(G_pdsi_data_PlotBiomass$MEASTIME_t2[NaN_vec[i]]))]),
                                               na.rm = T)

} ## end for loop
#####################################################

## make column for difference
G_pdsi_data_PlotBiomass$DeltaPDSI <-  G_pdsi_data_PlotBiomass$pdsi_growInt - G_pdsi_data_PlotBiomass$pdsi_baseline
```
 
```{r}
setwd("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI")

### save the result
save(G_pdsi_data_PlotBiomass, file = "G_pdsi_data_PlotBiomass.Rdata")
```

# Plots - G dataset biomass 

```{r}
library(ggplot2)

MainStates <- map_data("state")

gg_pdsi.1 <- ggplot() +
             geom_polygon(aes(x=long, y=lat, group=group), data=MainStates,
                          color="black", fill="#9fe2bf" ) +
             geom_point(data=G_pdsi_data_PlotBiomass, aes(x=LON, y=LAT, color = DeltaPDSI),
                        alpha = .25, size = 0.5) +
             metR::scale_color_divergent(
                     name = expression(Delta~"PDSI"),
                     # here we use guide_colourbar because it is still a continuous scale
                     guide = guide_colorbar(
                       direction = "horizontal",
                       barheight = unit(2, units = "mm"),
                       barwidth = unit(50, units = "mm"),
                       draw.ulim = F,
                       title.position = 'top',
                       # some shifting around
                       title.hjust = 0.5,
                       label.hjust = 0.5)) + theme_classic() + theme(legend.position = "bottom") +
                    ggtitle("G_dataset biomass t2 to -10 yr interval - baseiline")

gg_pdsi.1

```

```{r}
par(mfrow = c(1,3))

hist(G_pdsi_data$pdsi_baseline, breaks = 10, xlim = c(-10,10), main = expression("PDSI"["baseline"]), xlab = "PDSI 1970-1990 (Jan-Aug)", las =1)

hist(G_pdsi_data$pdsi_growInt, breaks = 40, xlim = c(-10,10), main = expression("PDSI"["growInt"]), xlab = "PDSI over biomass interval (Jan-Aug)", las =1)

hist(G_pdsi_data$DeltaPDSI, breaks = 40, xlim = c(-10,10), main = expression(Delta~"PDSI"), xlab = "G dataset PDSI_BiomassInt - PDSI_baseline", las =1)

```


---

```{r}
#  FOR THE P DATASET ------  PDSI wrangling

### load the P dataset
load("C:/Users/hogan.jaaron/Dropbox/FIA_R/Starter_FIA_data_processing/P_dataset.Rdata")

###  CODE TO CALCULATE delta_PDSI

## libraries
library(terra)

### read in the data -
pdsi1 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_1_PRISM.nc")
names(pdsi1) <- as.character(1895:2022)

pdsi2 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_2_PRISM.nc")
names(pdsi2) <- as.character(1895:2022)

pdsi3 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_3_PRISM.nc")
names(pdsi3) <- as.character(1895:2022)

pdsi4 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_4_PRISM.nc")
names(pdsi4) <- as.character(1895:2022)

pdsi5 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_5_PRISM.nc")
names(pdsi5) <- as.character(1895:2022)

###### first pass: limited analysis to growing season - June, July and August -
### monthly RASTERS FROM PRISM  ---  https://wrcc.dri.edu/wwdt/index.php?folder=pdsi

pdsi6 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_6_PRISM.nc")
names(pdsi6) <- as.character(1895:2022)

pdsi7 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_7_PRISM.nc")
names(pdsi7) <- as.character(1895:2022)

pdsi8 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_8_PRISM.nc")
names(pdsi8) <- as.character(1895:2022)

## make null dataframe
P_pdsi_data <-  data.frame(pltID = P$pltID,
                           LAT = P$LAT,
                           LON = P$LON,
                           MEASTIME_t1 = P$MEASYEAR-10,
                           MEASTIME_t2 = P$MEASYEAR,
                           pdsi_baseline = rep(-9999, length(P$pltID)),
                           pdsi_growInt = rep(-9999, length(P$pltID)))

## makes spatVector for spatial points of plot locations
P_pts <- vect(cbind(P_pdsi_data$LON, P_pdsi_data$LAT), crs="+proj=longlat +datum=WGS84")

##################################################### START FOR LOOP
### for loop to extract time-series data for each plot location
for(i in 1:length(P_pdsi_data$pltID)){

  ### extract values
  pdsi_vec.1 <- unlist(terra::extract(pdsi1, P_pts[i]))

  pdsi_vec.2 <- unlist(terra::extract(pdsi2, P_pts[i]))

  pdsi_vec.3 <- unlist(terra::extract(pdsi3, P_pts[i]))

  pdsi_vec.4 <- unlist(terra::extract(pdsi4, P_pts[i]))

  pdsi_vec.5 <- unlist(terra::extract(pdsi5, P_pts[i]))

  pdsi_vec.6 <- unlist(terra::extract(pdsi6, P_pts[i]))

  pdsi_vec.7 <- unlist(terra::extract(pdsi7, P_pts[i]))

  pdsi_vec.8 <- unlist(terra::extract(pdsi8, P_pts[i]))

  ### ccalculate the average baseline value 1960-1989 --- 30 year climate normal
  P_pdsi_data$pdsi_baseline[i] <- mean(c(pdsi_vec.1[as.character(rep(1960:1989))],
                                         pdsi_vec.2[as.character(rep(1960:1989))],
                                         pdsi_vec.3[as.character(rep(1960:1989))],
                                         pdsi_vec.4[as.character(rep(1960:1989))],
                                         pdsi_vec.5[as.character(rep(1960:1989))],
                                         pdsi_vec.6[as.character(rep(1960:1989))],
                                         pdsi_vec.7[as.character(rep(1960:1989))],
                                         pdsi_vec.8[as.character(rep(1960:1989))]),
                                       na.rm = T)

  ### calculate the mean over the growth interval
  P_pdsi_data$pdsi_growInt[i] <- mean(c(pdsi_vec.1[names(pdsi_vec.1) %in%
                                                               seq(P_pdsi_data$MEASTIME_t1[i], P_pdsi_data$MEASTIME_t2[i])],
                                        pdsi_vec.2[names(pdsi_vec.2) %in%
                                                               seq(P_pdsi_data$MEASTIME_t1[i], P_pdsi_data$MEASTIME_t2[i])],
                                        pdsi_vec.3[names(pdsi_vec.3) %in%
                                                               seq(P_pdsi_data$MEASTIME_t1[i], P_pdsi_data$MEASTIME_t2[i])],
                                        pdsi_vec.4[names(pdsi_vec.4) %in%
                                                               seq(P_pdsi_data$MEASTIME_t1[i], P_pdsi_data$MEASTIME_t2[i])],
                                        pdsi_vec.5[names(pdsi_vec.5) %in%
                                                               seq(P_pdsi_data$MEASTIME_t1[i], P_pdsi_data$MEASTIME_t2[i])] ,
                                        pdsi_vec.6[names(pdsi_vec.6) %in%
                                                               seq(P_pdsi_data$MEASTIME_t1[i], P_pdsi_data$MEASTIME_t2[i])],
                                        pdsi_vec.7[names(pdsi_vec.7) %in%
                                                               seq(P_pdsi_data$MEASTIME_t1[i], P_pdsi_data$MEASTIME_t2[i])],
                                        pdsi_vec.8[names(pdsi_vec.8) %in%
                                                               seq(P_pdsi_data$MEASTIME_t1[i], P_pdsi_data$MEASTIME_t2[i])]),
                                      na.rm = T)

} ## end for loop
#####################################################

## make column for difference
P_pdsi_data$DeltaPDSI <-  P_pdsi_data$pdsi_growInt - P_pdsi_data$pdsi_baseline


### deal with NaNs
NaN_vec  <- as.numeric(row.names(P_pdsi_data[is.na(P_pdsi_data$DeltaPDSI),]))

### for loop to extract time-series data for each plot location
for(i in 1:length(NaN_vec)){

  ### extract values
  pdsi_vec.1 <- unlist(terra::extract(pdsi1, P_pts[NaN_vec[i]], method = "bilinear"))

  pdsi_vec.2 <- unlist(terra::extract(pdsi2, P_pts[NaN_vec[i]], method = "bilinear"))

  pdsi_vec.3 <- unlist(terra::extract(pdsi3, P_pts[NaN_vec[i]], method = "bilinear"))

  pdsi_vec.4 <- unlist(terra::extract(pdsi4, P_pts[NaN_vec[i]], method = "bilinear"))

  pdsi_vec.5 <- unlist(terra::extract(pdsi5, P_pts[NaN_vec[i]], method = "bilinear"))

  pdsi_vec.6 <- unlist(terra::extract(pdsi6, P_pts[NaN_vec[i]], method = "bilinear"))

  pdsi_vec.7 <- unlist(terra::extract(pdsi7, P_pts[NaN_vec[i]], method = "bilinear"))

  pdsi_vec.8 <- unlist(terra::extract(pdsi8, P_pts[NaN_vec[i]], method = "bilinear"))

  ### calculate the average baseline value 1960-1989 --- 30 year climate normal
  P_pdsi_data$pdsi_baseline[NaN_vec[i]] <- mean(c(pdsi_vec.1[as.character(rep(1960:1989))],
                                                  pdsi_vec.2[as.character(rep(1960:1989))],
                                                  pdsi_vec.3[as.character(rep(1960:1989))],
                                                  pdsi_vec.4[as.character(rep(1960:1989))],
                                                  pdsi_vec.5[as.character(rep(1960:1989))],
                                                  pdsi_vec.6[as.character(rep(1960:1989))],
                                                  pdsi_vec.7[as.character(rep(1960:1989))],
                                                  pdsi_vec.8[as.character(rep(1960:1989))]),
                                                na.rm = T)

  ### calculate the mean over the growth interval
  P_pdsi_data$pdsi_growInt[NaN_vec[i]] <- mean(c(pdsi_vec.1[names(pdsi_vec.1) %in%
                                                           seq(P_pdsi_data$MEASTIME_t1[NaN_vec[i]], P_pdsi_data$MEASTIME_t2[NaN_vec[i]])],
                                                 pdsi_vec.2[names(pdsi_vec.2) %in%
                                                           seq(P_pdsi_data$MEASTIME_t1[NaN_vec[i]], P_pdsi_data$MEASTIME_t2[NaN_vec[i]])],
                                                 pdsi_vec.3[names(pdsi_vec.3) %in%
                                                           seq(P_pdsi_data$MEASTIME_t1[NaN_vec[i]], P_pdsi_data$MEASTIME_t2[NaN_vec[i]])],
                                                 pdsi_vec.4[names(pdsi_vec.4) %in%
                                                           seq(P_pdsi_data$MEASTIME_t1[NaN_vec[i]], P_pdsi_data$MEASTIME_t2[NaN_vec[i]])],
                                                 pdsi_vec.5[names(pdsi_vec.5) %in%
                                                           seq(P_pdsi_data$MEASTIME_t1[NaN_vec[i]], P_pdsi_data$MEASTIME_t2[NaN_vec[i]])],
                                                 pdsi_vec.6[names(pdsi_vec.6) %in%
                                                             seq(P_pdsi_data$MEASTIME_t1[NaN_vec[i]], P_pdsi_data$MEASTIME_t2[NaN_vec[i]])],
                                                 pdsi_vec.7[names(pdsi_vec.7) %in%
                                                             seq(P_pdsi_data$MEASTIME_t1[NaN_vec[i]], P_pdsi_data$MEASTIME_t2[NaN_vec[i]])],
                                                 pdsi_vec.8[names(pdsi_vec.8) %in%
                                                             seq(P_pdsi_data$MEASTIME_t1[NaN_vec[i]], P_pdsi_data$MEASTIME_t2[NaN_vec[i]])]),
                                               na.rm = T)

} ## end for loop
#####################################################

## make column for difference
P_pdsi_data$DeltaPDSI <-  P_pdsi_data$pdsi_growInt - P_pdsi_data$pdsi_baseline


#### save result

setwd("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI")

### save the result
save(P_pdsi_data, file = "P_pdsi_data.Rdata")
```


# Plots - P dataset

```{r}
library(ggplot2)

MainStates <- map_data("state")

gg_pdsi.1 <- ggplot() +
             geom_polygon(aes(x=long, y=lat, group=group), data=MainStates,
                          color="black", fill="#9fe2bf" ) +
             geom_point(data=P_pdsi_data, aes(x=LON, y=LAT, color = DeltaPDSI),
                        alpha = .25, size = 0.5) +
             metR::scale_color_divergent(
                     name = expression(Delta~"PDSI"),
                     # here we use guide_colourbar because it is still a continuous scale
                     guide = guide_colorbar(
                       direction = "horizontal",
                       barheight = unit(2, units = "mm"),
                       barwidth = unit(50, units = "mm"),
                       draw.ulim = F,
                       title.position = 'top',
                       # some shifting around
                       title.hjust = 0.5,
                       label.hjust = 0.5)) + theme_classic() + theme(legend.position = "bottom") +
                    ggtitle("P_dataset MEASTIME to MEASTIME-10 yr interval - baseiline")

gg_pdsi.1

```

```{r}
par(mfrow = c(1,3))

hist(G_pdsi_data$pdsi_baseline, breaks = 10, xlim = c(-10,10), main = expression("PDSI"["baseline"]), xlab = "PDSI 1970-1990 (Jan-Aug)", las =1)

hist(G_pdsi_data$pdsi_growInt, breaks = 40, xlim = c(-10,10), main = expression("PDSI"["growInt"]), xlab = "PDSI over biomass interval (Jan-Aug)", las =1)

hist(G_pdsi_data$DeltaPDSI, breaks = 40, xlim = c(-10,10), main = expression(Delta~"PDSI"), xlab = "P dataset PDSI_BiomassInt - PDSI_baseline", las =1)

```

