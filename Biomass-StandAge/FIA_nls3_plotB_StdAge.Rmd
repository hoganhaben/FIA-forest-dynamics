---
title: "FIA - NLS Models: Biomass vs. Stand Age"
author: "JAH"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_float: yes
    toc_collapsed: yes
    toc_depth: 3
    
---

```{r include=FALSE}
knitr::opts_chunk$set(tidy.opts=list(width.cutoff=60), tidy=TRUE, echo = FALSE, cache.lazy = T)
```

```{r, message = FALSE, warning=FALSE}
### libraries
library(dplyr)
library(ggplot2)
library(nlstools)
library(propagate)

### CI functions -- (for later)
high.CI <-  function(x) {mean(x, na.rm =T) + 1.96*plotrix::std.error(x, na.rm =T)}
low.CI <-  function(x) {mean(x, na.rm =T) - 1.96*plotrix::std.error(x, na.rm =T)}
```

```{r}
#### set wd
setwd("C:/Users/hogan.jaaron/Dropbox/FIA_R/NLS_modeling")
# setwd("C:/Users/hogie/Dropbox/FIA_R/NLS_modeling")       # if working on p_50

# load P  data set
load("C:/Users/hogan.jaaron/Dropbox/FIA_R/Starter_FIA_data_processing/P_dataset.Rdata")
# ("C:/Users/hogie/Dropbox/FIA_R/Starter_FIA_data_processing/P_dataset.Rdata")       # if working on p_50

## change second colname to PLT_CN from CN to be consitent with G dataset  (CN from FIA plot table)
colnames(P)[2] <- "PLT_CN"
```


# Background

This document has nls (non-linear least squares) regression fits using the Michaelis-Menten functional form to USFS FIA (United States Forest Service Forest Inventory & Analysis) __Biomass growth vs. stand biomass__ relationships.  We calculated the biomass of each FIA plot by summing alive tree biomass (as reported by FIA).  Stand age is also reported by FIA, using tree-core age estimates from two trees from the dominant size class of the FIA plot. 


We considered the following Michaelis-Menten functional form $B = (1 + (yr-1990)* ge/100) \times (1 + \phi \cdot \Delta PDSI) \times \left( \frac{A \cdot StdAge}{k+StdAge}\right)$, where $B$ is the plot biomass, $B_l$ is the calculated biomass loss (proportion) for the previous FIA plot census interval, $StdAge$ is the stand age at the second of two FIA plot tree censuses, $\Delta PDSI$ is the difference in the peak growing season (June-August) annual average PDSI values over the FIA plot measurement intervals and a 30-year climate normal (1960-1989), and $yr$ is the measurement year (all FI A data).  Free parameters are $\alpha$: the growth compensation of lost plot biomass, $ge$: biomass growth enhancement over time, $A$: the Michaelis-Menten asymptote and $k$: the Michaelis-Menten half-saturation constant.

Model selection is used to determine the best fitting models, which is implemented in two parts. The first part selected the best model form using $\alpha$: the biomass compensation effect due to lost biomass (natural mortality or harvest) and $\phi$: the effect of changing climate (quantified as $\Delta PDSI$, or the difference in the Palmer drought severity index from June - August for the 10 years preceding the biomass measurement and the 1960-1989 period).  

__model 1:  simple model__
$B = (1 + (yr-1990)* ge/100) \times \left( \frac {A \cdot StdAge} {k+StdAge} \right)$

__model 2: phi model__
$B = (1 + (yr-1990)* ge/100) \times (1 + \phi \cdot \Delta PDSI)  \times \left( \frac {A \cdot StdAge} {k+StdAge} \right)$


Then, model selection part two takes the best fitting model from part 1 and and adds the $p$ and $s$ parameters (individually then together) to modify the Micheaelis-Menten functional form.  The $p$ parameter allows for an intercept in the model (i.e., for the model to not be forced through the origin), and the $s$ parameter increases model flexibility, with $s$>1 leading to more-sigmoidal shape. 

__sub-model a: p form__
$pA + \left( \frac {(1-p) * A \cdot StdAge} {k+StdAge} \right)$

__sub-model b: s form__
$\left( \frac {A \cdot StdAge^s} {k^s+StdAge^s} \right)$

__sub-model c: p and s together__
$pA + \left( \frac {(1-p) *A \cdot StdAge^s} {k^s + StdAge^s} \right)$

*Note:* 

*This analysis uses* __ALL__ *available plot biomass data*

which includes the following plot-based filtering criteria:

1. exclude FIA plots in plantation forests
2. exclude FIA plots with multiple plot conditions (COND_PROP_UNADJ > 0.95)
3. exclude FIA plots non-productive stands (i.e., those with less than 20 ft^3/acre/year timber producing capability; SITECLCD of 7)
4. exclude FIA plots in non-stocked stands (i.e., those with STDSZCD of 5)
5. exclude FIA plots in non-accessible areas (i.e., private lands etc., COND_STATUS_CD not equal to 1)
6. exclude FIA plot visits that are not part of the annual inventories (which also includes FIA plot visits for Phase 3 ozone measurements)


Below the model fitting procedure is implemented by ecoprovince:

```{r}
### create nls formulae for modeling

### model 1
f_1 <- formula(BIO_MgHa ~ (1 + (MEASTIME-1990)*ge/100) * A*STDAGE / (k+STDAGE))
## model 2
f_2 <-  formula(BIO_MgHa ~ (1 + (MEASTIME-1990)*ge/100) * (1 + phi*DeltaPDSI) * A*STDAGE / (k+STDAGE))

## model 1 variants
f_1a <- formula(BIO_MgHa ~ (1 + (MEASTIME-1990)*ge/100) * (p*A+((1-p)*A*STDAGE/(k+STDAGE))))
f_1b <- formula(BIO_MgHa ~ (1 + (MEASTIME-1990)*ge/100) * (A*STDAGE^s/(k^s+STDAGE^s)))
f_1c <- formula(BIO_MgHa ~ (1 + (MEASTIME-1990)*ge/100) * (p*A+((1-p)*A*STDAGE^s/(k^s+STDAGE^s))))

## model 2 variants
f_2a <- formula(BIO_MgHa ~ (1 + (MEASTIME-1990)*ge/100) * (1 + phi*DeltaPDSI) * (p*A+((1-p)*A*STDAGE/(k+STDAGE))))
f_2b <- formula(BIO_MgHa ~ (1 + (MEASTIME-1990)*ge/100) * (1 + phi*DeltaPDSI) * (A*STDAGE^s/(k^s+STDAGE^s)))
f_2c <- formula(BIO_MgHa ~ (1 + (MEASTIME-1990)*ge/100) * (1 + phi*DeltaPDSI) * (p*A+((1-p)*A*STDAGE^s/(k^s+STDAGE^s))))

###########################################

## define nls starting parameters 
A.start = 50
k.start = 20
ge.start= 0.1
phi.start = 0 
```

```{r, message = F, warning = F}
###  CODE TO CALCULATE delta_PDSI

## Note: This code calculates delta_PDSI -- the difference in the Palmer Drought Severity Index from the baseline (1960-1989) 
## and the census interval -- uncomment to run -- it takes a little while (a few hours) to run, so the output is saved and read in below 

#####################################################
#####################################################

# ## libraries
# library(terra)
# 
# ### read in the data -  
# pdsi1 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_1_PRISM.nc")
# names(pdsi1) <- as.character(1895:2022)
# 
# pdsi2 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_2_PRISM.nc")
# names(pdsi2) <- as.character(1895:2022)
# 
# pdsi3 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_3_PRISM.nc")
# names(pdsi3) <- as.character(1895:2022)
# 
# pdsi4 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_4_PRISM.nc")
# names(pdsi4) <- as.character(1895:2022)
# 
# pdsi5 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_5_PRISM.nc")
# names(pdsi5) <- as.character(1895:2022)
# 
# ###### first pass: limited analysis to growing season - June, July and August - 
# ### monthly RASTERS FROM PRISM  ---  https://wrcc.dri.edu/wwdt/index.php?folder=pdsi  
# 
# pdsi6 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_6_PRISM.nc")
# names(pdsi6) <- as.character(1895:2022)
# 
# pdsi7 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_7_PRISM.nc")
# names(pdsi7) <- as.character(1895:2022)
# 
# pdsi8 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_8_PRISM.nc")
# names(pdsi8) <- as.character(1895:2022)
# 
# ## make null dataframe 
# P_pdsi_data <-  data.frame(pltID = P$pltID, 
#                            LAT = P$LAT,  
#                            LON = P$LON, 
#                            MEASTIME_t1 = P$MEASYEAR-10,
#                            MEASTIME_t2 = P$MEASYEAR,
#                            pdsi_baseline = rep(-9999, length(P$pltID)), 
#                            pdsi_growInt = rep(-9999, length(P$pltID)))
# 
# ## makes spatVector for spatial points of plot locations
# P_pts <- vect(cbind(P_pdsi_data$LON, P_pdsi_data$LAT), crs="+proj=longlat +datum=WGS84")
# 
# ##################################################### START FOR LOOP
# ### for loop to extract time-series data for each plot location
# for(i in 1:length(P_pdsi_data$pltID)){
#   
#   ### extract values 
#   pdsi_vec.1 <- unlist(terra::extract(pdsi1, P_pts[i]))
#   
#   pdsi_vec.2 <- unlist(terra::extract(pdsi2, P_pts[i]))
# 
#   pdsi_vec.3 <- unlist(terra::extract(pdsi3, P_pts[i]))
#     
#   pdsi_vec.4 <- unlist(terra::extract(pdsi4, P_pts[i]))
#   
#   pdsi_vec.5 <- unlist(terra::extract(pdsi5, P_pts[i]))
#   
#   pdsi_vec.6 <- unlist(terra::extract(pdsi6, P_pts[i]))
#   
#   pdsi_vec.7 <- unlist(terra::extract(pdsi7, P_pts[i]))
#   
#   pdsi_vec.8 <- unlist(terra::extract(pdsi8, P_pts[i]))
#   
#   ### calculate the average baseline value 1960-1989 --- 30 year climate normal 
#   P_pdsi_data$pdsi_baseline[i] <- mean(c(pdsi_vec.1[as.character(rep(1960:1989))], 
#                                          pdsi_vec.2[as.character(rep(1960:1989))],
#                                          pdsi_vec.3[as.character(rep(1960:1989))],
#                                          pdsi_vec.4[as.character(rep(1960:1989))],
#                                          pdsi_vec.5[as.character(rep(1960:1989))],
#                                          pdsi_vec.6[as.character(rep(1960:1989))],
#                                          pdsi_vec.7[as.character(rep(1960:1989))], 
#                                          pdsi_vec.8[as.character(rep(1960:1989))]),
#                                        na.rm = T)
#   
#   ### calculate the mean over the growth interval
#   P_pdsi_data$pdsi_growInt[i] <- mean(c(pdsi_vec.1[names(pdsi_vec.1) %in% 
#                                                                seq(P_pdsi_data$MEASTIME_t1[i], 
#                                                                    P_pdsi_data$MEASTIME_t2[i])], 
#                                         pdsi_vec.2[names(pdsi_vec.2) %in% 
#                                                                seq(P_pdsi_data$MEASTIME_t1[i], 
#                                                                    P_pdsi_data$MEASTIME_t2[i])], 
#                                         pdsi_vec.3[names(pdsi_vec.3) %in% 
#                                                                seq(P_pdsi_data$MEASTIME_t1[i], 
#                                                                    P_pdsi_data$MEASTIME_t2[i])], 
#                                         pdsi_vec.4[names(pdsi_vec.4) %in% 
#                                                                seq(P_pdsi_data$MEASTIME_t1[i], 
#                                                                    P_pdsi_data$MEASTIME_t2[i])], 
#                                         pdsi_vec.5[names(pdsi_vec.5) %in% 
#                                                                seq(P_pdsi_data$MEASTIME_t1[i], 
#                                                                    P_pdsi_data$MEASTIME_t2[i])] ,
#                                         pdsi_vec.6[names(pdsi_vec.6) %in% 
#                                                                seq(P_pdsi_data$MEASTIME_t1[i], 
#                                                                    P_pdsi_data$MEASTIME_t2[i])], 
#                                         pdsi_vec.7[names(pdsi_vec.7) %in% 
#                                                                seq(P_pdsi_data$MEASTIME_t1[i], 
#                                                                    P_pdsi_data$MEASTIME_t2[i])], 
#                                         pdsi_vec.8[names(pdsi_vec.8) %in% 
#                                                                seq(P_pdsi_data$MEASTIME_t1[i], 
#                                                                    P_pdsi_data$MEASTIME_t2[i])]),
#                                       na.rm = T)
# 
# } ## end for loop
# #####################################################
# 
# ## make column for difference
# P_pdsi_data$DeltaPDSI <-  P_pdsi_data$pdsi_growInt - P_pdsi_data$pdsi_baseline
# 
# 
# ### deal with NaNs
# NaN_vec  <- as.numeric(row.names(P_pdsi_data[is.na(P_pdsi_data$DeltaPDSI),]))
# 
# ### for loop to extract time-series data for each plot location
# for(i in 1:length(NaN_vec)){
#   
#   ### extract values 
#   pdsi_vec.1 <- unlist(terra::extract(pdsi1, P_pts[NaN_vec[i]], method = "bilinear"))
#   
#   pdsi_vec.2 <- unlist(terra::extract(pdsi2, P_pts[NaN_vec[i]], method = "bilinear"))
#   
#   pdsi_vec.3 <- unlist(terra::extract(pdsi3, P_pts[NaN_vec[i]], method = "bilinear"))
#   
#   pdsi_vec.4 <- unlist(terra::extract(pdsi4, P_pts[NaN_vec[i]], method = "bilinear"))
#   
#   pdsi_vec.5 <- unlist(terra::extract(pdsi5, P_pts[NaN_vec[i]], method = "bilinear"))
#   
#   pdsi_vec.6 <- unlist(terra::extract(pdsi6, P_pts[NaN_vec[i]], method = "bilinear"))
#   
#   pdsi_vec.7 <- unlist(terra::extract(pdsi7, P_pts[NaN_vec[i]], method = "bilinear"))
#   
#   pdsi_vec.8 <- unlist(terra::extract(pdsi8, P_pts[NaN_vec[i]], method = "bilinear"))
#   
#   ### calculate the average baseline value 1960-1989 --- 30 year climate normal 
#   P_pdsi_data$pdsi_baseline[NaN_vec[i]] <- mean(c(pdsi_vec.1[as.character(rep(1960:1989))],
#                                                   pdsi_vec.2[as.character(rep(1960:1989))],
#                                                   pdsi_vec.3[as.character(rep(1960:1989))],
#                                                   pdsi_vec.4[as.character(rep(1960:1989))],
#                                                   pdsi_vec.5[as.character(rep(1960:1989))],
#                                                   pdsi_vec.6[as.character(rep(1960:1989))],
#                                                   pdsi_vec.7[as.character(rep(1960:1989))], 
#                                                   pdsi_vec.8[as.character(rep(1960:1989))]),
#                                                 na.rm = T)
#   
#   ### calculate the mean over the growth interval
#   P_pdsi_data$pdsi_growInt[NaN_vec[i]] <- mean(c(pdsi_vec.1[names(pdsi_vec.1) %in% 
#                                                              seq(P_pdsi_data$MEASTIME_t1[NaN_vec[i]], 
#                                                                  P_pdsi_data$MEASTIME_t2[NaN_vec[i]])],
#                                                  pdsi_vec.2[names(pdsi_vec.2) %in% 
#                                                              seq(P_pdsi_data$MEASTIME_t1[NaN_vec[i]], 
#                                                                  P_pdsi_data$MEASTIME_t2[NaN_vec[i]])], 
#                                                  pdsi_vec.3[names(pdsi_vec.3) %in% 
#                                                              seq(P_pdsi_data$MEASTIME_t1[NaN_vec[i]], 
#                                                                  P_pdsi_data$MEASTIME_t2[NaN_vec[i]])], 
#                                                  pdsi_vec.4[names(pdsi_vec.4) %in% 
#                                                              seq(P_pdsi_data$MEASTIME_t1[NaN_vec[i]], 
#                                                                  P_pdsi_data$MEASTIME_t2[NaN_vec[i]])], 
#                                                  pdsi_vec.5[names(pdsi_vec.5) %in% 
#                                                              seq(P_pdsi_data$MEASTIME_t1[NaN_vec[i]], 
#                                                                  P_pdsi_data$MEASTIME_t2[NaN_vec[i]])], 
#                                                  pdsi_vec.6[names(pdsi_vec.6) %in% 
#                                                              seq(P_pdsi_data$MEASTIME_t1[NaN_vec[i]], 
#                                                                  P_pdsi_data$MEASTIME_t2[NaN_vec[i]])], 
#                                                  pdsi_vec.7[names(pdsi_vec.7) %in% 
#                                                              seq(P_pdsi_data$MEASTIME_t1[NaN_vec[i]], 
#                                                                  P_pdsi_data$MEASTIME_t2[NaN_vec[i]])], 
#                                                  pdsi_vec.8[names(pdsi_vec.8) %in% 
#                                                              seq(P_pdsi_data$MEASTIME_t1[NaN_vec[i]], 
#                                                                  P_pdsi_data$MEASTIME_t2[NaN_vec[i]])]),
#                                                na.rm = T)
# 
# } ## end for loop
# #####################################################
# 
# ## make column for difference
# P_pdsi_data$DeltaPDSI <-  P_pdsi_data$pdsi_growInt - P_pdsi_data$pdsi_baseline
# 
# ### save the result
# setwd("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI")
# save(P_pdsi_data, file = "P_pdsi_data_2_JAN-AUG.Rdata") 

#####################################################
#####################################################

# load PDSI data -- (just load the save data product the above code takes a while to run)
load("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/P_pdsi_data_2_JAN-AUG.Rdata")
# load("C:/Users/hogie/Dropbox/FIA_R/data_PDSI/P_pdsi_data_2_JAN-AUG.Rdata")       # if working on p_50


P$DeltaPDSI <- P_pdsi_data$DeltaPDSI
```

```{r}
### MAKE DATASETS FOR ECOPROVINCES 
## M242 - Cascade Mixed Forest
P_M242 <- droplevels(P[P$ECOPROVCD == "M242",])
## M261 - Sierran Steppe - Mixed Forest - Coniferous Forest - Alpine Meadow
P_M261 <- droplevels(P[P$ECOPROVCD == "M261",])
## 234 - Lower Mississippi Riverine Forest
P_234 <- droplevels(P[P$ECOPROVCD == "234",])
## 242 - Pacific Lowland Mixed Forest
P_242 <- droplevels(P[P$ECOPROVCD == "242",])
## 263 - California Coastal Steppe - Mixed Forest and Redwood Forest
P_263 <- droplevels(P[P$ECOPROVCD == "263",])
P_263 <- P_263[P_263$BIO_MgHa <2000,]  ## filter out 2 outliers in Redwood forests with huge plot biomass
## 232 - Outer Coastal Plain Mixed Forest
P_232 <- droplevels(P[P$ECOPROVCD == "232",])
## M332 - Middle Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow
P_M332 <- droplevels(P[P$ECOPROVCD == "M332",])
## 223 - Central Interior Broadleaf Forest
P_223 <- droplevels(P[P$ECOPROVCD == "223",])
## M221 - Central Appalachian Broadleaf Forest - Coniferous Forest - Meadow
P_M221 <- droplevels(P[P$ECOPROVCD == "M221",])
## 231 - Southeastern Mixed Forest
P_231 <- droplevels(P[P$ECOPROVCD == "231",])
## 212 - Laurentian Mixed Forest
P_212 <- droplevels(P[P$ECOPROVCD == "212",])
## 221 -  Eastern Broadleaf Forest
P_221 <- droplevels(P[P$ECOPROVCD == "221",])
## 211 - Northeastern Mixed Forest
P_211 <- droplevels(P[P$ECOPROVCD == "211",])
## 222 - Midwest Broadleaf Forest
P_222 <- droplevels(P[P$ECOPROVCD == "222",])
## M211 - Adirondack-New England Mixed forest - Coniferous Forest - Alpine Meadow
P_M211 <- droplevels(P[P$ECOPROVCD == "M211",])
## 332 - Great Plains Steppe
P_332 <- droplevels(P[P$ECOPROVCD == "332",])
## 251 - Prairie Parkland (Temperate)
P_251 <- droplevels(P[P$ECOPROVCD == "251",])
## M223 - Central Interior Broadleaf Forest
P_M223 <- droplevels(P[P$ECOPROVCD == "M223",])
## M231 - Ouachita Mixed Forest
P_M231 <- droplevels(P[P$ECOPROVCD == "M231",])
## 255 - Prairie Parkland (Subtropical)
P_255 <- droplevels(P[P$ECOPROVCD == "255",])
## M334 - Black Hills Coniferous Forest
P_M334 <- droplevels(P[P$ECOPROVCD == "M334",])
## 411 - Everglades
P_411 <- droplevels(P[P$ECOPROVCD == "411",])
## 342 - Intermountain Semi-Desert
P_342 <- droplevels(P[P$ECOPROVCD == "342",])
## 331 - Great Plains/Palouse Dry Steppe
P_331 <- droplevels(P[P$ECOPROVCD == "331",])
# 261 - California Coastal Chaparral Forest and Shrub
P_261 <- droplevels(P[P$ECOPROVCD == "261",])
# 262 - California Dry Steppe
P_262 <- droplevels(P[P$ECOPROVCD == "262",])  # ONLY has 5 observations can exlude
## 313 - Colorado Plateau Semi-Desert
P_313 <- droplevels(P[P$ECOPROVCD == "313",])
##  315 - Southwest Plateau and Plains Dry Steppe and Shrub
P_315 <- droplevels(P[P$ECOPROVCD == "315",])
## 321 - Chihuahuan Semi-Desert 
P_321 <- droplevels(P[P$ECOPROVCD == "321",])
## 322 - American Semidesert and Desert
P_322 <- droplevels(P[P$ECOPROVCD == "322",])
## 341 - Intermountain Semi-Desert and Desert
P_341 <- droplevels(P[P$ECOPROVCD == "341",])
## M262- California Coastal Range Coniferous Forest - Open Woodland - Shrub - Meadow
P_M262 <- droplevels(P[P$ECOPROVCD == "M262",])
## M313 - Arizona-New Mexico Mountains Semi-Desert - Open Woodland - Coniferous Forest - Alpine Meadow
P_M313 <- droplevels(P[P$ECOPROVCD == "M313",])
## M331 - Southern Rocky Mountain Steppe - Open Woodland - Coniferous Forest - Alpine Meadow
P_M331 <- droplevels(P[P$ECOPROVCD == "M331",])
# M333 - Northern Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow
P_M333 <- droplevels(P[P$ECOPROVCD == "M333",])
# M341 - Nevada-Utah Mountains Semi-Desert - Coniferous Forest - Alpine Meadow
P_M341 <- droplevels(P[P$ECOPROVCD == "M341",])
```

```{r}
#### create BEST MODEL DATA FRAME -- to be filled in later 

Best_mods.P <- data.frame(
  Code = c("211", "212", "221", "222", "223", "231", 
           "232", "234", "242", "251", "255", "261", 
           "262", "263", "313", "315", "321", "322", 
           "331", "332", "341", "342", "411", "M211", 
           "M221", "M223", "M231", "M242", "M261", "M262", "M313", 
           "M331", "M332", "M333", "M334", "M341"),
  Ecoregion = c(
      "Northeastern Mixed Forest", "Laurentian Mixed Forest", "Eastern Broadleaf Forest",
      "Midwest Broadleaf Forest", "Central Interior Broadleaf Forest", "Southeastern Mixed Forest",
      "Outer Coastal Plain Mixed Forest", "Lower Mississippi Riverine Forest", "Pacific Lowland Mixed Forest",
      "Prairie Parkland (Temperate)", "Prairie Parkland (Subtropical)", "California Coastal Chaparral Forest and Shrub",
      "California Dry Steppe", "California Coastal Steppe - Mixed Forest and Redwood Forest", "Colorado Plateau Semi-Desert",
      "Southwest Plateau and Plains Dry Steppe and Shrub", "Chihuahuan Semi-Desert", "American Semidesert and Desert",
      "Great Plains/Palouse Dry Steppe", "Great Plains Steppe", "Intermountain Semi-Desert and Desert",
      "Intermountain Semi-Desert", "Everglades", "Adirondack-New England Mixed forest - Coniferous Forest - Alpine Meadow",
      "Central Appalachian Broadleaf Forest - Coniferous Forest - Meadow", "Ozark Broadleaf Forest Meadow", "Ouachita Mixed Forest",
      "Cascade Mixed Forest", "Sierran Steppe - Mixed Forest - Coniferous Forest - Alpine Meadow", 
      "California Coastal Range Coniferous Forest - Open Woodland - Shrub - Meadow", 
      "Arizona-New Mexico Mountains Semi-Desert - Open Woodland - Coniferous Forest - Alpine Meadow", 
      "Southern Rocky Mountain Steppe - Open Woodland - Coniferous Forest - Alpine Meadow", 
      "Middle Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow", 
      "Northern Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow", "Black Hills Coniferous Forest", 
      "Nevada-Utah Mountains Semi-Desert - Coniferous Forest - Alpine Meadow"),  
  Sel.Mod = rep("NA", 36)
)
```

```{r}
nls.param.df <- data.frame(
   Code = c("211", "212", "221", "222", "223", "231", 
           "232", "234", "242", "251", "255", "261", 
           "262", "263", "313", "315", "321", "322", 
           "331", "332", "341", "342", "411", "M211", 
           "M221", "M223", "M231", "M242", "M261", "M262", "M313", 
           "M331", "M332", "M333", "M334", "M341"),
  Ecoregion = c(
      "Northeastern Mixed Forest", "Laurentian Mixed Forest", "Eastern Broadleaf Forest",
      "Midwest Broadleaf Forest", "Central Interior Broadleaf Forest", "Southeastern Mixed Forest",
      "Outer Coastal Plain Mixed Forest", "Lower Mississippi Riverine Forest", "Pacific Lowland Mixed Forest",
      "Prairie Parkland (Temperate)", "Prairie Parkland (Subtropical)", "California Coastal Chaparral Forest and Shrub",
      "California Dry Steppe", "California Coastal Steppe - Mixed Forest and Redwood Forest", "Colorado Plateau Semi-Desert",
      "Southwest Plateau and Plains Dry Steppe and Shrub", "Chihuahuan Semi-Desert", "American Semidesert and Desert",
      "Great Plains/Palouse Dry Steppe", "Great Plains Steppe", "Intermountain Semi-Desert and Desert",
      "Intermountain Semi-Desert", "Everglades", "Adirondack-New England Mixed forest - Coniferous Forest - Alpine Meadow",
      "Central Appalachian Broadleaf Forest - Coniferous Forest - Meadow", "Ozark Broadleaf Forest Meadow", "Ouachita Mixed Forest",
      "Cascade Mixed Forest", "Sierran Steppe - Mixed Forest - Coniferous Forest - Alpine Meadow", 
      "California Coastal Range Coniferous Forest - Open Woodland - Shrub - Meadow", 
      "Arizona-New Mexico Mountains Semi-Desert - Open Woodland - Coniferous Forest - Alpine Meadow", 
      "Southern Rocky Mountain Steppe - Open Woodland - Coniferous Forest - Alpine Meadow", 
      "Middle Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow", 
      "Northern Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow", "Black Hills Coniferous Forest", 
      "Nevada-Utah Mountains Semi-Desert - Coniferous Forest - Alpine Meadow"), 
  region = c("east", "east", "east", "east", "east", "east", 
             "east", "east", "pacific", "east", "pacific", "pacific",  
             "pacific", "pacific", "interior west", "interior west", "interior west", "interior west", 
             "interior west", "interior west", "interior west", "interior west", "east", "east", 
             "east", "east", "east", "pacific", "pacific",  "interior west", 
             "interior west", "interior west", "interior west", "interior west", "interior west", "interior west"),
             ## note: everglades treated as east, but not technically east -- separate region
  `n.obs` = c(length(P_211$pltID), length(P_212$pltID), length(P_221$pltID),
              length(P_222$pltID), length(P_223$pltID), length(P_231$pltID),
              length(P_232$pltID), length(P_234$pltID), length(P_242$pltID), 
              length(P_251$pltID),  length(P_255$pltID), length(P_261$pltID),
              length(P_262$pltID), length(P_263$pltID), length(P_313$pltID),
              length(P_315$pltID), length(P_321$pltID), length(P_322$pltID),
              length(P_331$pltID), length(P_332$pltID), length(P_341$pltID),
              length(P_342$pltID), length(P_411$pltID), length(P_M211$pltID),  
              length(P_M221$pltID), length(P_M223$pltID), length(P_M231$pltID),
              length(P_M242$pltID), length(P_M261$pltID), length(P_M262$pltID), 
              length(P_M313$pltID), length(P_M331$pltID), length(P_M332$pltID),
              length(P_M333$pltID), length(P_M334$pltID), length(P_M341$pltID)), 
  `n.plots` = c(length(unique(P_211$pltID)), length(unique(P_212$pltID)), length(unique(P_221$pltID)),
                length(unique(P_222$pltID)), length(unique(P_223$pltID)), length(unique(P_231$pltID)),
                length(unique(P_232$pltID)), length(unique(P_234$pltID)), length(unique(P_242$pltID)), 
                length(unique(P_251$pltID)), length(unique(P_255$pltID)), length(unique(P_261$pltID)),
                length(unique(P_262$pltID)), length(unique(P_263$pltID)), length(unique(P_313$pltID)),
                length(unique(P_315$pltID)), length(unique(P_321$pltID)), length(unique(P_322$pltID)),
                length(unique(P_331$pltID)), length(unique(P_332$pltID)), length(unique(P_341$pltID)),
                length(unique(P_342$pltID)), length(unique(P_411$pltID)), length(unique(P_M211$pltID)),  
                length(unique(P_M221$pltID)), length(unique(P_M223$pltID)), length(unique(P_M231$pltID)),
                length(unique(P_M242$pltID)), length(unique(P_M261$pltID)), length(unique(P_M262$pltID)),
                length(unique(P_M313$pltID)), length(unique(P_M331$pltID)), length(unique(P_M332$pltID)),
                length(unique(P_M333$pltID)), length(unique(P_M334$pltID)), length(unique(P_M341$pltID))),
   ge             = rep(-9999, 36), 
   `ge.2.5`       = rep(-9999, 36),
   `ge.97.5`      = rep(-9999, 36),
   phi            = rep(-9999, 36),
  `phi.2.5`       = rep(-9999, 36),
   `phi.97.5`     = rep(-9999, 36),
   A              = rep(-9999, 36),
   `A.2.5`        = rep(-9999, 36),
   `A.97.5`       = rep(-9999, 36),
   k              = rep(-9999, 36), 
   `k.2.5`        = rep(-9999, 36),
   `k.97.5`       = rep(-9999, 36)
  )
```

# 211 - Northeastern Mixed Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_211 <- round(quantile(P_211$STDAGE, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_211)))){
  cutvec_211 <- round(quantile(P_211$STDAGE, seq(0,1, length.out = 11)))
}

bin_mids_211 <- unname(round(cutvec_211[-length(cutvec_211)] + diff(cutvec_211)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
P_211$STDAGE_bin<-  cut(P_211$STDAGE, cutvec_211)
## then get bin means
P_211_bin_means <- tapply(P_211$BIO_MgHa, cut(P_211$STDAGE, cutvec_211), mean)

## make column weights.2
P_211$nls_weights.2 <- as.numeric(1/(P_211_bin_means[match(P_211$STDAGE_bin, names(P_211_bin_means))])^2)

}
```

## model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_211.1 <- nls(f_1, data = P_211, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = P_211$nls_weights.2), 
 )

## phi
try(
  nls_211.2 <- nls(f_2, data=P_211, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = P_211$nls_weights.2), 
 )


if(exists("nls_211.1") & exists("nls_211.2")){
  print(anova(nls_211.1, nls_211.2))
}
 
## AIC comparison
AIC1_211 <- data.frame(model = c(1,2), AIC = c(
            ifelse(exists("nls_211.1"), AIC(get("nls_211.1")), NA),
            ifelse(exists("nls_211.2"), AIC(get("nls_211.2")), NA)
            ))

print(AIC1_211) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_211[!is.na(AIC1_211$AIC) & AIC1_211$AIC == min(AIC1_211$AIC, na.rm = T),]$model

try(summary(get(paste("nls_211.",  Mod.Sel1, sep =""))) ) #model summary

}
```
### summary 
* simple model: `r ifelse(exists("nls_211.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_211.2"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_211.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_211.",  Mod.Sel1, sep ="")))["phi"], 1)
A.fit <- round(coef(get(paste("nls_211.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_211.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_211.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = P_211,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              },
          weights = P_211$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_211.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = P_211,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              }, 
          weights = P_211$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_211.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = P_211,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } , 
          weights = P_211$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_211.", Mod.Sel1, sep ="")) &
     exists(paste("nls_211.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_211.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_211.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_211.", Mod.Sel1, sep ="")),
             get(paste("nls_211.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_211.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_211.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_211.", Mod.Sel1, sep ="")) &
         exists(paste("nls_211.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_211.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_211.", Mod.Sel1, sep ="")),
               get(paste("nls_211.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_211.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_211.", Mod.Sel1, sep ="")) &
           exists(paste("nls_211.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_211.", Mod.Sel1, sep ="")),
                 get(paste("nls_211.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_211.", Mod.Sel1, sep ="")) &
              exists(paste("nls_211.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_211.", Mod.Sel1, sep ="")),
                    get(paste("nls_211.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_211.", Mod.Sel1, sep ="")) &
                exists(paste("nls_211.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_211.", Mod.Sel1, sep ="")),
                      get(paste("nls_211.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_211 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_211.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_211.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_211.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_211.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_211.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_211.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_211.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_211.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_211)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_211[!is.na(AIC2_211$AIC) & AIC2_211$AIC == min(AIC2_211$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P[Best_mods.P$Code == "211",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_211.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_211.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df[nls.param.df$Code == "211",]$ge <- coefs["ge"]
nls.param.df[nls.param.df$Code == "211",]$phi <- coefs["phi"]
nls.param.df[nls.param.df$Code == "211",]$A <- coefs["A"]
nls.param.df[nls.param.df$Code == "211",]$k <- coefs["k"]

nls.param.df[nls.param.df$Code == "211",]$ge.2.5 <- intervals_low["ge"]
nls.param.df[nls.param.df$Code == "211",]$phi.2.5 <- intervals_low["phi"]
nls.param.df[nls.param.df$Code == "211",]$A.2.5 <- intervals_low["A"]
nls.param.df[nls.param.df$Code == "211",]$k.2.5 <- intervals_low["k"]

nls.param.df[nls.param.df$Code == "211",]$ge.97.5 <- intervals_high["ge"]
nls.param.df[nls.param.df$Code == "211",]$phi.97.5 <- intervals_high["phi"]
nls.param.df[nls.param.df$Code == "211",]$A.97.5 <- intervals_high["A"]
nls.param.df[nls.param.df$Code == "211",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_211.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_211.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_211.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_211.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals
```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_211 <- nlsResiduals(
  get(paste("nls_211.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_211)

## test residuals
if(length(P_211$pltID) < 5001) {test.nlsResiduals(resid_211)}

}  else {print("cannot plot residuals")}
```

## predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

P_211_pred <- predict(get(paste("nls_211.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME" = rep(mean(P_211$MEASTIME, na.rm = T), max(P_211$STDAGE)),
                                   "STDAGE" = seq(1, max(P_211$STDAGE), by = 1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME" = rep(mean(P_211$MEASTIME, na.rm = T), max(P_211$STDAGE)),
                                   "STDAGE" = seq(1, max(P_211$STDAGE), by = 1),
                                   "DeltaPDSI" = rep(mean(P_211$DeltaPDSI, na.rm = T), max(P_211$STDAGE)))
                      } )

P_211_pred_df <- data.frame("STDAGE"=seq(1,max(P_211$STDAGE),by = 1),  
                            "fitted"=P_211_pred)

## plot
gg.211 <- ggplot() +
          geom_point(aes(x = STDAGE, y = BIO_MgHa), data = P_211, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE, y = BIO_MgHa), data = P_211, 
                            fun.data = function(x) {
                              res <- quantile(x, probs = c(0.25,0.5,0.75))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_211))), breaks = cutvec_211) +  
          
          #geom_ribbon(aes(x = STDAGE, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = P_211_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE, y = fitted), data = P_211_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("211 - Northeastern Mixed Forest") + 
          
          #ylim(0, max(P_211_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, cutvec_211[20]*1.05), expand = c(0,0))

gg.211

}  else {print("cannot plot data with prediction")}  
```


## plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_211 <- data.frame(
  bin = as.factor(levels(cut(P_211$STDAGE, cutvec_211))),
  data.mean = tapply(P_211$BIO_MgHa, cut(P_211$STDAGE, cutvec_211), 
                     mean, na.rm = T), 
  data.CI.high =  tapply(P_211$BIO_MgHa, cut(P_211$STDAGE, cutvec_211), 
                    high.CI), 
  data.CI.low = tapply(P_211$BIO_MgHa, cut(P_211$STDAGE, cutvec_211),
                    low.CI), 
  pred.mean = P_211_pred_df[P_211_pred_df$STDAGE %in% bin_mids_211,]$fitted) 
  # pred.CI.high = tapply(`211_CI_df`$fitted, cut(`211_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_211$STDAGE, g=20))),
  #                      high.CI), 
  # pred.CI.low = tapply(`211_CI_df`$fitted, cut(`211_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_211$STDAGE, g=20))),
  #                      low.CI))

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_211 <-  DM_compare_211 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_211$bin)[gtools::mixedorder(levels(DM_compare_211$bin))]))

## ggplot
gg.211.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_211) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_211))), 
                              labels = levels(DM_compare_211$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("211 - Northeastern Mixed Forest") +         
           theme_classic() + 
           # xlim(min(DM_compare_211$data.CI.low)-0.25, max(DM_compare_211$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_211$pred.CI.low)-0.25, max(DM_compare_211$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.211.B2

}   else {print("cannot plot observed vs. predicted")}
```

# 212 - Laurentian Mixed Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_212 <- round(quantile(P_212$STDAGE, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_212)))){
  cutvec_212 <- round(quantile(P_212$STDAGE, seq(0,1, length.out = 11)))
}

bin_mids_212 <- unname(round(cutvec_212[-length(cutvec_212)] + diff(cutvec_212)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
P_212$STDAGE_bin<-  cut(P_212$STDAGE, cutvec_212)
## then get bin means
P_212_bin_means <- tapply(P_212$BIO_MgHa, cut(P_212$STDAGE, cutvec_212), mean)

## make column weights.2
P_212$nls_weights.2 <- as.numeric(1/(P_212_bin_means[match(P_212$STDAGE_bin, names(P_212_bin_means))])^2)

}
```

## model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_212.1 <- nls(f_1, data = P_212, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = P_212$nls_weights.2), 
 )

## phi
try(
  nls_212.2 <- nls(f_2, data=P_212, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = P_212$nls_weights.2), 
 )


## test
if(exists("nls_212.1") & exists("nls_212.2")){
  print(anova(nls_212.1, nls_212.2))
}
 
## AIC comparison
AIC1_212 <- data.frame(model = c(1,2), AIC = c(
            ifelse(exists("nls_212.1"), AIC(get("nls_212.1")), NA),
            ifelse(exists("nls_212.2"), AIC(get("nls_212.2")), NA)
            ))

print(AIC1_212) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_212[!is.na(AIC1_212$AIC) & AIC1_212$AIC == min(AIC1_212$AIC, na.rm = T),]$model

try(summary(get(paste("nls_212.",  Mod.Sel1, sep =""))) )  #model summary

}
```
### summary 
* simple model: `r ifelse(exists("nls_212.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_212.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_212.3"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_212.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_212.",  Mod.Sel1, sep ="")))["phi"], 1)
A.fit <- round(coef(get(paste("nls_212.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_212.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_212.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = P_212,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              }, 
          weights = P_212$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_212.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = P_212,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              },
          weights = P_212$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_212.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = P_212,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } , 
          weights = P_212$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_212.", Mod.Sel1, sep ="")) &
     exists(paste("nls_212.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_212.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_212.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_212.", Mod.Sel1, sep ="")),
             get(paste("nls_212.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_212.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_212.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_212.", Mod.Sel1, sep ="")) &
         exists(paste("nls_212.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_212.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_212.", Mod.Sel1, sep ="")),
               get(paste("nls_212.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_212.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_212.", Mod.Sel1, sep ="")) &
           exists(paste("nls_212.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_212.", Mod.Sel1, sep ="")),
                 get(paste("nls_212.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_212.", Mod.Sel1, sep ="")) &
              exists(paste("nls_212.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_212.", Mod.Sel1, sep ="")),
                    get(paste("nls_212.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_212.", Mod.Sel1, sep ="")) &
                exists(paste("nls_212.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_212.", Mod.Sel1, sep ="")),
                      get(paste("nls_212.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_212 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_212.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_212.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_212.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_212.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_212.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_212.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_212.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_212.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_212)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_212[!is.na(AIC2_212$AIC) & AIC2_212$AIC == min(AIC2_212$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P[Best_mods.P$Code == "212",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_212.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_212.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df[nls.param.df$Code == "212",]$ge <- coefs["ge"]
nls.param.df[nls.param.df$Code == "212",]$phi <- coefs["phi"]
nls.param.df[nls.param.df$Code == "212",]$A <- coefs["A"]
nls.param.df[nls.param.df$Code == "212",]$k <- coefs["k"]

nls.param.df[nls.param.df$Code == "212",]$ge.2.5 <- intervals_low["ge"]
nls.param.df[nls.param.df$Code == "212",]$phi.2.5 <- intervals_low["phi"]
nls.param.df[nls.param.df$Code == "212",]$A.2.5 <- intervals_low["A"]
nls.param.df[nls.param.df$Code == "212",]$k.2.5 <- intervals_low["k"]

nls.param.df[nls.param.df$Code == "212",]$ge.97.5 <- intervals_high["ge"]
nls.param.df[nls.param.df$Code == "212",]$phi.97.5 <- intervals_high["phi"]
nls.param.df[nls.param.df$Code == "212",]$A.97.5 <- intervals_high["A"]
nls.param.df[nls.param.df$Code == "212",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_212.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_212.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_212.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_212.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals
```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {
  
## calculate residuals
resid_212 <- nlsResiduals(
  get(paste("nls_212.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_212)

## test residuals
if(length(P_212$pltID) < 5001) {test.nlsResiduals(resid_212)}

}  else {print("cannot plot residuals")}
```

## predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

P_212_pred <- predict(get(paste("nls_212.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME" = rep(mean(P_212$MEASTIME, na.rm = T), max(P_212$STDAGE)),
                                   "STDAGE" = seq(1, max(P_212$STDAGE), by = 1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME" = rep(mean(P_212$MEASTIME, na.rm = T), max(P_212$STDAGE)),
                                   "STDAGE" = seq(1, max(P_212$STDAGE), by = 1),
                                   "DeltaPDSI" = rep(mean(P_212$DeltaPDSI, na.rm = T), max(P_212$STDAGE)))
                      } )

P_212_pred_df <- data.frame("STDAGE"=seq(1,max(P_212$STDAGE),by = 1),  
                            "fitted"=P_212_pred)


## plot
gg.212 <- ggplot() +
          geom_point(aes(x = STDAGE, y = BIO_MgHa), data = P_212, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE, y = BIO_MgHa), data = P_212, 
                            fun.data = function(x) {
                              res <- quantile(x, probs = c(0.25,0.5,0.75))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_212))), breaks = cutvec_212) +  
          
          #geom_ribbon(aes(x = STDAGE, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = P_212_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE, y = fitted), data = P_212_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("212 - Laurentian Mixed Forest") + 
          
          #ylim(0, max(P_212_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, cutvec_212[20]*1.05), expand = c(0,0))

gg.212

}  else {print("cannot plot data with prediction")}
```


## plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_212 <- data.frame(
  bin = as.factor(levels(cut(P_212$STDAGE, cutvec_212))),
  data.mean = tapply(P_212$BIO_MgHa, cut(P_212$STDAGE, cutvec_212), 
                     mean, na.rm = T), 
  data.CI.high =  tapply(P_212$BIO_MgHa, cut(P_212$STDAGE, cutvec_212), 
                    high.CI), 
  data.CI.low = tapply(P_212$BIO_MgHa, cut(P_212$STDAGE, cutvec_212),
                    low.CI), 
  pred.mean = P_212_pred_df[P_212_pred_df$STDAGE %in% bin_mids_212,]$fitted) 
  # pred.CI.high = tapply(`212_CI_df`$fitted, cut(`212_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_212$STDAGE, g=20))),
  #                      high.CI), 
  # pred.CI.low = tapply(`212_CI_df`$fitted, cut(`212_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_212$STDAGE, g=20))),
  #                      low.CI))

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_212 <-  DM_compare_212 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_212$bin)[gtools::mixedorder(levels(DM_compare_212$bin))]))

## ggplot
gg.212.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_212) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_212))), 
                              labels = levels(DM_compare_212$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("212 - Laurentain Mixed Forest") +         
           theme_classic() + 
           # xlim(min(DM_compare_212$data.CI.low)-0.25, max(DM_compare_212$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_212$pred.CI.low)-0.25, max(DM_compare_212$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.212.B2

}   else {print("cannot plot observed vs. predicted")}
```

# 221 - Eastern Broadleaf Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_221 <- round(quantile(P_221$STDAGE, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_221)))){
  cutvec_221 <- round(quantile(P_221$STDAGE, seq(0,1, length.out = 11)))
}

bin_mids_221 <- unname(round(cutvec_221[-length(cutvec_221)] + diff(cutvec_221)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
P_221$STDAGE_bin<-  cut(P_221$STDAGE, cutvec_221)
## then get bin means
P_221_bin_means <- tapply(P_221$BIO_MgHa, cut(P_221$STDAGE, cutvec_221), mean)

## make column weights.2
P_221$nls_weights.2 <- as.numeric(1/(P_221_bin_means[match(P_221$STDAGE_bin, names(P_221_bin_means))])^2)

}
```

## model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_221.1 <- nls(f_1, data = P_221, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = P_221$nls_weights.2), 
 )

## phi
try(
  nls_221.2 <- nls(f_2, data=P_221, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = P_221$nls_weights.2), 
 )

## test
if(exists("nls_221.1") & exists("nls_221.2")){
  print(anova(nls_221.1, nls_221.2))
}
 
## AIC comparison
AIC1_221 <- data.frame(model = c(1,2), AIC = c(
            ifelse(exists("nls_221.1"), AIC(get("nls_221.1")), NA),
            ifelse(exists("nls_221.2"), AIC(get("nls_221.2")), NA)
            ))

print(AIC1_221) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_221[!is.na(AIC1_221$AIC) & AIC1_221$AIC == min(AIC1_221$AIC, na.rm = T),]$model

try(summary(get(paste("nls_221.",  Mod.Sel1, sep =""))) )  #model summary

}
```
### summary 
* simple model: `r ifelse(exists("nls_221.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_221.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_221.3"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_221.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_221.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_221.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_221.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_221.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_221.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = P_221,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = P_221$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_221.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = P_221,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = P_221$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_221.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = P_221,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = P_221$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_221.", Mod.Sel1, sep ="")) &
     exists(paste("nls_221.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_221.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_221.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_221.", Mod.Sel1, sep ="")),
             get(paste("nls_221.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_221.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_221.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_221.", Mod.Sel1, sep ="")) &
         exists(paste("nls_221.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_221.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_221.", Mod.Sel1, sep ="")),
               get(paste("nls_221.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_221.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_221.", Mod.Sel1, sep ="")) &
           exists(paste("nls_221.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_221.", Mod.Sel1, sep ="")),
                 get(paste("nls_221.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_221.", Mod.Sel1, sep ="")) &
              exists(paste("nls_221.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_221.", Mod.Sel1, sep ="")),
                    get(paste("nls_221.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_221.", Mod.Sel1, sep ="")) &
                exists(paste("nls_221.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_221.", Mod.Sel1, sep ="")),
                      get(paste("nls_221.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_221 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_221.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_221.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_221.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_221.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_221.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_221.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_221.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_221.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_221)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_221[!is.na(AIC2_221$AIC) & AIC2_221$AIC == min(AIC2_221$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P[Best_mods.P$Code == "221",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_221.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_221.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df[nls.param.df$Code == "221",]$ge <- coefs["ge"]
nls.param.df[nls.param.df$Code == "221",]$phi <- coefs["phi"]
nls.param.df[nls.param.df$Code == "221",]$alpha <- coefs["alpha"]
nls.param.df[nls.param.df$Code == "221",]$A <- coefs["A"]
nls.param.df[nls.param.df$Code == "221",]$k <- coefs["k"]

nls.param.df[nls.param.df$Code == "221",]$ge.2.5 <- intervals_low["ge"]
nls.param.df[nls.param.df$Code == "221",]$phi.2.5 <- intervals_low["phi"]
nls.param.df[nls.param.df$Code == "221",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df[nls.param.df$Code == "221",]$A.2.5 <- intervals_low["A"]
nls.param.df[nls.param.df$Code == "221",]$k.2.5 <- intervals_low["k"]

nls.param.df[nls.param.df$Code == "221",]$ge.97.5 <- intervals_high["ge"]
nls.param.df[nls.param.df$Code == "221",]$phi.97.5 <- intervals_high["phi"]
nls.param.df[nls.param.df$Code == "221",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df[nls.param.df$Code == "221",]$A.97.5 <- intervals_high["A"]
nls.param.df[nls.param.df$Code == "221",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_221.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_221.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_221.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_221.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals
```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_221 <- nlsResiduals(
  get(paste("nls_221.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_221)

## test residuals
if(length(P_221$pltID) < 5001) {test.nlsResiduals(resid_221)}

}   else {print("cannot plot residuals")}
```

## predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

P_221_pred <- predict(get(paste("nls_221.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME" = rep(mean(P_221$MEASTIME, na.rm = T), max(P_221$STDAGE)),
                                   "STDAGE" = seq(1, max(P_221$STDAGE), by = 1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME" = rep(mean(P_221$MEASTIME, na.rm = T), max(P_221$STDAGE)),
                                   "STDAGE" = seq(1, max(P_221$STDAGE), by = 1),
                                   "DeltaPDSI" = rep(mean(P_221$DeltaPDSI, na.rm = T), max(P_221$STDAGE)))
                      } )

P_221_pred_df <- data.frame("STDAGE"=seq(1,max(P_221$STDAGE),by = 1),  
                            "fitted"=P_221_pred)

## plot
gg.221 <- ggplot() +
          geom_point(aes(x = STDAGE, y = BIO_MgHa), data = P_221, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE, y = BIO_MgHa), data = P_221, 
                            fun.data = function(x) {
                              res <- quantile(x, probs = c(0.25,0.5,0.75))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_221))), breaks = cutvec_221) +  
          
          #geom_ribbon(aes(x = STDAGE, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = P_221_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE, y = fitted), data = P_221_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("221 - Eastern Broadleaf Forest") + 
          
          #ylim(0, max(P_221_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, cutvec_221[20]*1.05), expand = c(0,0))

gg.221

}   else {print("cannot plot data with prediction")}
```


## plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_221 <- data.frame(
  bin = as.factor(levels(cut(P_221$STDAGE, cutvec_221))),
  data.mean = tapply(P_221$BIO_MgHa, cut(P_221$STDAGE, cutvec_221), 
                     mean, na.rm = T), 
  data.CI.high =  tapply(P_221$BIO_MgHa, cut(P_221$STDAGE, cutvec_221), 
                    high.CI), 
  data.CI.low = tapply(P_221$BIO_MgHa, cut(P_221$STDAGE, cutvec_221),
                    low.CI), 
  pred.mean = P_221_pred_df[P_221_pred_df$STDAGE %in% bin_mids_221,]$fitted) 
  # pred.CI.high = tapply(`221_CI_df`$fitted, cut(`221_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_221$STDAGE, g=20))),
  #                      high.CI), 
  # pred.CI.low = tapply(`221_CI_df`$fitted, cut(`221_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_221$STDAGE, g=20))),
  #                      low.CI))

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_221 <-  DM_compare_221 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_221$bin)[gtools::mixedorder(levels(DM_compare_221$bin))]))

## ggplot
gg.221.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_221) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_221))), 
                              labels = levels(DM_compare_221$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("221 - Eastern Broadleaf Forest") +         
           theme_classic() + 
           # xlim(min(DM_compare_221$data.CI.low)-0.25, max(DM_compare_221$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_221$pred.CI.low)-0.25, max(DM_compare_221$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.221.B2

}   else {print("cannot plot observed vs. predicted")}
```

# 222 - Midwest Broadleaf Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_222 <- round(quantile(P_222$STDAGE, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_222)))){
  cutvec_222 <- round(quantile(P_222$STDAGE, seq(0,1, length.out = 11)))
}

bin_mids_222 <- unname(round(cutvec_222[-length(cutvec_222)] + diff(cutvec_222)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
P_222$STDAGE_bin<-  cut(P_222$STDAGE, cutvec_222)
## then get bin means
P_222_bin_means <- tapply(P_222$BIO_MgHa, cut(P_222$STDAGE,  cutvec_222), mean)

## make column weights.2
P_222$nls_weights.2 <- as.numeric(1/(P_222_bin_means[match(P_222$STDAGE_bin, names(P_222_bin_means))])^2)

}
```

## model selection 1

```{r}
# simple
try(
  nls_222.1 <- nls(f_1, data = P_222, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = P_222$nls_weights.2), 
 )

## phi
try(
  nls_222.2 <- nls(f_2, data=P_222, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = P_222$nls_weights.2), 
 )

## test
if(exists("nls_222.1") & exists("nls_222.2")){
  print(anova(nls_222.1, nls_222.2))
}
 
## AIC comparison
AIC1_222 <- data.frame(model = c(1,2), AIC = c(
            ifelse(exists("nls_222.1"), AIC(get("nls_222.1")), NA),
            ifelse(exists("nls_222.2"), AIC(get("nls_222.2")), NA)
            ))

print(AIC1_222) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_222[!is.na(AIC1_222$AIC) & AIC1_222$AIC == min(AIC1_222$AIC, na.rm = T),]$model

try(summary(get(paste("nls_222.",  Mod.Sel1, sep =""))) )  #model summary
```
### summary 
* simple model: `r ifelse(exists("nls_222.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_222.2"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_222.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_222.",  Mod.Sel1, sep ="")))["phi"], 1)
A.fit <- round(coef(get(paste("nls_222.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_222.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_222.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = P_222,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              }, 
          weights = P_222$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_222.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = P_222,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              },
          weights = P_222$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_222.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = P_222,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              }, 
          weights = P_222$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_222.", Mod.Sel1, sep ="")) &
     exists(paste("nls_222.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_222.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_222.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_222.", Mod.Sel1, sep ="")),
             get(paste("nls_222.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_222.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_222.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_222.", Mod.Sel1, sep ="")) &
         exists(paste("nls_222.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_222.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_222.", Mod.Sel1, sep ="")),
               get(paste("nls_222.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_222.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_222.", Mod.Sel1, sep ="")) &
           exists(paste("nls_222.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_222.", Mod.Sel1, sep ="")),
                 get(paste("nls_222.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_222.", Mod.Sel1, sep ="")) &
              exists(paste("nls_222.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_222.", Mod.Sel1, sep ="")),
                    get(paste("nls_222.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_222.", Mod.Sel1, sep ="")) &
                exists(paste("nls_222.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_222.", Mod.Sel1, sep ="")),
                      get(paste("nls_222.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_222 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_222.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_222.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_222.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_222.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_222.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_222.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_222.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_222.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_222)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_222[!is.na(AIC2_222$AIC) & AIC2_222$AIC == min(AIC2_222$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P[Best_mods.P$Code == "222",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_222.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_222.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df[nls.param.df$Code == "222",]$ge <- coefs["ge"]
nls.param.df[nls.param.df$Code == "222",]$phi <- coefs["phi"]
nls.param.df[nls.param.df$Code == "222",]$A <- coefs["A"]
nls.param.df[nls.param.df$Code == "222",]$k <- coefs["k"]

nls.param.df[nls.param.df$Code == "222",]$ge.2.5 <- intervals_low["ge"]
nls.param.df[nls.param.df$Code == "222",]$phi.2.5 <- intervals_low["phi"]
nls.param.df[nls.param.df$Code == "222",]$A.2.5 <- intervals_low["A"]
nls.param.df[nls.param.df$Code == "222",]$k.2.5 <- intervals_low["k"]

nls.param.df[nls.param.df$Code == "222",]$ge.97.5 <- intervals_high["ge"]
nls.param.df[nls.param.df$Code == "222",]$phi.97.5 <- intervals_high["phi"]
nls.param.df[nls.param.df$Code == "222",]$A.97.5 <- intervals_high["A"]
nls.param.df[nls.param.df$Code == "222",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_222.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_222.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_222.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_222.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals
```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {
  
## calculate residuals
resid_222 <- nlsResiduals(
  get(paste("nls_222.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_222)

## test residuals
if(length(P_222$pltID) < 5001) {test.nlsResiduals(resid_222)}

}  else {print("cannot plot residuals")}
```

## predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {
  
P_222_pred <- predict(get(paste("nls_222.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME" = rep(mean(P_222$MEASTIME, na.rm = T), max(P_222$STDAGE)),
                                   "STDAGE" = seq(1, max(P_222$STDAGE), by = 1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME" = rep(mean(P_222$MEASTIME, na.rm = T), max(P_222$STDAGE)),
                                   "STDAGE" = seq(1, max(P_222$STDAGE), by = 1),
                                   "DeltaPDSI" = rep(mean(P_222$DeltaPDSI, na.rm = T), max(P_222$STDAGE)))
                      } )

P_222_pred_df <- data.frame("STDAGE"=seq(1,max(P_222$STDAGE),by = 1),  
                            "fitted"=P_222_pred)

## plot
gg.222 <- ggplot() +
          geom_point(aes(x = STDAGE, y = BIO_MgHa), data = P_222, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE, y = BIO_MgHa), data = P_222, 
                            fun.data = function(x) {
                              res <- quantile(x, probs = c(0.25,0.5,0.75))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_222))), breaks = cutvec_222) +  
          
          #geom_ribbon(aes(x = STDAGE, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = P_222_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE, y = fitted), data = P_222_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("222 - Midwest Broadleaf Forest") + 
          
          #ylim(0, max(P_222_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, cutvec_222[20]*1.05), expand = c(0,0))

gg.222

}  else {print("cannot plot data with prediction")}
```


## plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_222 <- data.frame(
  bin = as.factor(levels(cut(P_222$STDAGE, cutvec_222))),
  data.mean = tapply(P_222$BIO_MgHa, cut(P_222$STDAGE, cutvec_222), 
                     mean, na.rm = T), 
  data.CI.high =  tapply(P_222$BIO_MgHa, cut(P_222$STDAGE, cutvec_222), 
                    high.CI), 
  data.CI.low = tapply(P_222$BIO_MgHa, cut(P_222$STDAGE, cutvec_222),
                    low.CI), 
  pred.mean = P_222_pred_df[P_222_pred_df$STDAGE %in% bin_mids_222,]$fitted) 
  # pred.CI.high = tapply(`222_CI_df`$fitted, cut(`222_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_222$STDAGE, g=20))),
  #                      high.CI), 
  # pred.CI.low = tapply(`222_CI_df`$fitted, cut(`222_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_222$STDAGE, g=20))),
  #                      low.CI))

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_222 <-  DM_compare_222 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_222$bin)[gtools::mixedorder(levels(DM_compare_222$bin))]))

## ggplot
gg.222.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_222) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_222))), 
                              labels = levels(DM_compare_222$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("222 - Midwest Broadleaf Forest") +         
           theme_classic() + 
           # xlim(min(DM_compare_222$data.CI.low)-0.25, max(DM_compare_222$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_222$pred.CI.low)-0.25, max(DM_compare_222$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.222.B2

}    else {print("cannot plot observed vs. predicted")}
```

# 223 - Central Interior Broadleaf Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_223 <- round(quantile(P_223$STDAGE, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_223)))){
  cutvec_223 <- round(quantile(P_223$STDAGE, seq(0,1, length.out = 11)))
}

bin_mids_223 <- unname(round(cutvec_223[-length(cutvec_223)] + diff(cutvec_223)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
P_223$STDAGE_bin<-  cut(P_223$STDAGE, cutvec_223)
## then get bin means
P_223_bin_means <- tapply(P_223$BIO_MgHa, cut(P_223$STDAGE,  cutvec_223), mean)

## make column weights.2
P_223$nls_weights.2 <- as.numeric(1/(P_223_bin_means[match(P_223$STDAGE_bin, names(P_223_bin_means))])^2)

}
```

## model selection 1

```{r}
# simple
try(
  nls_223.1 <- nls(f_1, data = P_223, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = P_223$nls_weights.2), 
 )

## phi
try(
  nls_223.2 <- nls(f_2, data=P_223, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = P_223$nls_weights.2), 
 )

## test
if(exists("nls_223.1") & exists("nls_223.2")){
  print(anova(nls_223.1, nls_223.2))
}
 
## AIC comparison
AIC1_223 <- data.frame(model = c(1,2), AIC = c(
            ifelse(exists("nls_223.1"), AIC(get("nls_223.1")), NA),
            ifelse(exists("nls_223.2"), AIC(get("nls_223.2")), NA)
            ))

print(AIC1_223) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_223[!is.na(AIC1_223$AIC) & AIC1_223$AIC == min(AIC1_223$AIC, na.rm = T),]$model

try(summary(get(paste("nls_223.",  Mod.Sel1, sep =""))) )  #model summary
```
### summary 
* simple model: `r ifelse(exists("nls_223.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_223.2"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_223.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_223.",  Mod.Sel1, sep ="")))["phi"], 1)
A.fit <- round(coef(get(paste("nls_223.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_223.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_223.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = P_223,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              }, 
          weights = P_223$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_223.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = P_223,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              },
          weights = P_223$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_223.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = P_223,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              }, 
          weights = P_223$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_223.", Mod.Sel1, sep ="")) &
     exists(paste("nls_223.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_223.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_223.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_223.", Mod.Sel1, sep ="")),
             get(paste("nls_223.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_223.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_223.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_223.", Mod.Sel1, sep ="")) &
         exists(paste("nls_223.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_223.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_223.", Mod.Sel1, sep ="")),
               get(paste("nls_223.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_223.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_223.", Mod.Sel1, sep ="")) &
           exists(paste("nls_223.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_223.", Mod.Sel1, sep ="")),
                 get(paste("nls_223.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_223.", Mod.Sel1, sep ="")) &
              exists(paste("nls_223.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_223.", Mod.Sel1, sep ="")),
                    get(paste("nls_223.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_223.", Mod.Sel1, sep ="")) &
                exists(paste("nls_223.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_223.", Mod.Sel1, sep ="")),
                      get(paste("nls_223.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_223 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_223.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_223.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_223.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_223.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_223.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_223.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_223.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_223.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_223)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_223[!is.na(AIC2_223$AIC) & AIC2_223$AIC == min(AIC2_223$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P[Best_mods.P$Code == "223",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_223.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_223.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df[nls.param.df$Code == "223",]$ge <- coefs["ge"]
nls.param.df[nls.param.df$Code == "223",]$phi <- coefs["phi"]
nls.param.df[nls.param.df$Code == "223",]$A <- coefs["A"]
nls.param.df[nls.param.df$Code == "223",]$k <- coefs["k"]

nls.param.df[nls.param.df$Code == "223",]$ge.2.5 <- intervals_low["ge"]
nls.param.df[nls.param.df$Code == "223",]$phi.2.5 <- intervals_low["phi"]
nls.param.df[nls.param.df$Code == "223",]$A.2.5 <- intervals_low["A"]
nls.param.df[nls.param.df$Code == "223",]$k.2.5 <- intervals_low["k"]

nls.param.df[nls.param.df$Code == "223",]$ge.97.5 <- intervals_high["ge"]
nls.param.df[nls.param.df$Code == "223",]$phi.97.5 <- intervals_high["phi"]
nls.param.df[nls.param.df$Code == "223",]$A.97.5 <- intervals_high["A"]
nls.param.df[nls.param.df$Code == "223",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_223.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_223.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_223.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_223.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals
```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_223 <- nlsResiduals(get(paste("nls_223.",  Mod.Sel2, sep ="")))

## plot residuals
plot(resid_223)

## test residuals
if(length(P_223$pltID) < 5001) {test.nlsResiduals(resid_223)}

}   else {print("cannot plot residuals")}
```

## predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

P_223_pred <- predict(get(paste("nls_223.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME" = rep(mean(P_223$MEASTIME, na.rm = T), max(P_223$STDAGE)),
                                   "STDAGE" = seq(1, max(P_223$STDAGE), by = 1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME" = rep(mean(P_223$MEASTIME, na.rm = T), max(P_223$STDAGE)),
                                   "STDAGE" = seq(1, max(P_223$STDAGE), by = 1),
                                   "DeltaPDSI" = rep(mean(P_223$DeltaPDSI, na.rm = T), max(P_223$STDAGE)))
                      } )

P_223_pred_df <- data.frame("STDAGE"=seq(1,max(P_223$STDAGE),by = 1),  
                            "fitted"=P_223_pred)

## plot
gg.223 <- ggplot() +
          geom_point(aes(x = STDAGE, y = BIO_MgHa), data = P_223, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE, y = BIO_MgHa), data = P_223, 
                            fun.data = function(x) {
                              res <- quantile(x, probs = c(0.25,0.5,0.75))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_223))), breaks = cutvec_223) +  
          
          #geom_ribbon(aes(x = STDAGE, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = P_223_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE, y = fitted), data = P_223_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("223 - Central Interior Broadleaf Forest") + 
          
          #ylim(0, max(P_223_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, cutvec_223[20]*1.05), expand = c(0,0))

gg.223

}  else {print("cannot plot data with prediction")}
```


## plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_223 <- data.frame(
  bin = as.factor(levels(cut(P_223$STDAGE, cutvec_223))),
  data.mean = tapply(P_223$BIO_MgHa, cut(P_223$STDAGE, cutvec_223), 
                     mean, na.rm = T), 
  data.CI.high =  tapply(P_223$BIO_MgHa, cut(P_223$STDAGE, cutvec_223), 
                    high.CI), 
  data.CI.low = tapply(P_223$BIO_MgHa, cut(P_223$STDAGE, cutvec_223),
                    low.CI), 
  pred.mean = P_223_pred_df[P_223_pred_df$STDAGE %in% bin_mids_223,]$fitted) 
  # pred.CI.high = tapply(`223_CI_df`$fitted, cut(`223_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_223$STDAGE, g=20))),
  #                      high.CI), 
  # pred.CI.low = tapply(`223_CI_df`$fitted, cut(`223_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_223$STDAGE, g=20))),
  #                      low.CI))

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_223 <-  DM_compare_223 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_223$bin)[gtools::mixedorder(levels(DM_compare_223$bin))]))

## ggplot
gg.223.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_223) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_223))), 
                              labels = levels(DM_compare_223$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("223 - Central Interior Broadleaf Forest") +         
           theme_classic() + 
           # xlim(min(DM_compare_223$data.CI.low)-0.25, max(DM_compare_223$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_223$pred.CI.low)-0.25, max(DM_compare_223$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.223.B2

}   else {print("cannot plot observed vs. predicted")}
```

# 231 - Southeastern Mixed Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_231 <- round(quantile(P_231$STDAGE, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_231)))){
  cutvec_231 <- round(quantile(P_231$STDAGE, seq(0,1, length.out = 11)))
}

bin_mids_231 <- unname(round(cutvec_231[-length(cutvec_231)] + diff(cutvec_231)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
P_231$STDAGE_bin<-  cut(P_231$STDAGE, cutvec_231)
## then get bin means
P_231_bin_means <- tapply(P_231$BIO_MgHa, cut(P_231$STDAGE,  cutvec_231), mean)

## make column weights.2
P_231$nls_weights.2 <- as.numeric(1/(P_231_bin_means[match(P_231$STDAGE_bin, names(P_231_bin_means))])^2)

}
```

## model selection 1

```{r}
# simple
try(
  nls_231.1 <- nls(f_1, data = P_231, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = P_231$nls_weights.2), 
 )

## phi
try(
  nls_231.2 <- nls(f_2, data=P_231, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = P_231$nls_weights.2), 
 )

## test
if(exists("nls_231.1") & exists("nls_231.2")){
  print(anova(nls_231.1, nls_231.2))
}
 
## AIC comparison
AIC1_231 <- data.frame(model = c(1,2), AIC = c(
            ifelse(exists("nls_231.1"), AIC(get("nls_231.1")), NA),
            ifelse(exists("nls_231.2"), AIC(get("nls_231.2")), NA)
            ))

print(AIC1_231) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_231[!is.na(AIC1_231$AIC) & AIC1_231$AIC == min(AIC1_231$AIC, na.rm = T),]$model

try(summary(get(paste("nls_231.",  Mod.Sel1, sep =""))) )  #model summary
```
### summary 
* simple model: `r ifelse(exists("nls_231.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_231.2"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_231.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_231.",  Mod.Sel1, sep ="")))["phi"], 1)
A.fit <- round(coef(get(paste("nls_231.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_231.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_231.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = P_231,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              }, 
          weights = P_231$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_231.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = P_231,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              },
          weights = P_231$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_231.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = P_231,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              }, 
          weights = P_231$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_231.", Mod.Sel1, sep ="")) &
     exists(paste("nls_231.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_231.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_231.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_231.", Mod.Sel1, sep ="")),
             get(paste("nls_231.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_231.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_231.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_231.", Mod.Sel1, sep ="")) &
         exists(paste("nls_231.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_231.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_231.", Mod.Sel1, sep ="")),
               get(paste("nls_231.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_231.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_231.", Mod.Sel1, sep ="")) &
           exists(paste("nls_231.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_231.", Mod.Sel1, sep ="")),
                 get(paste("nls_231.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_231.", Mod.Sel1, sep ="")) &
              exists(paste("nls_231.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_231.", Mod.Sel1, sep ="")),
                    get(paste("nls_231.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_231.", Mod.Sel1, sep ="")) &
                exists(paste("nls_231.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_231.", Mod.Sel1, sep ="")),
                      get(paste("nls_231.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_231 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_231.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_231.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_231.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_231.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_231.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_231.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_231.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_231.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_231)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_231[!is.na(AIC2_231$AIC) & AIC2_231$AIC == min(AIC2_231$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P[Best_mods.P$Code == "231",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_231.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_231.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df[nls.param.df$Code == "231",]$ge <- coefs["ge"]
nls.param.df[nls.param.df$Code == "231",]$phi <- coefs["phi"]
nls.param.df[nls.param.df$Code == "231",]$A <- coefs["A"]
nls.param.df[nls.param.df$Code == "231",]$k <- coefs["k"]

nls.param.df[nls.param.df$Code == "231",]$ge.2.5 <- intervals_low["ge"]
nls.param.df[nls.param.df$Code == "231",]$phi.2.5 <- intervals_low["phi"]
nls.param.df[nls.param.df$Code == "231",]$A.2.5 <- intervals_low["A"]
nls.param.df[nls.param.df$Code == "231",]$k.2.5 <- intervals_low["k"]

nls.param.df[nls.param.df$Code == "231",]$ge.97.5 <- intervals_high["ge"]
nls.param.df[nls.param.df$Code == "231",]$phi.97.5 <- intervals_high["phi"]
nls.param.df[nls.param.df$Code == "231",]$A.97.5 <- intervals_high["A"]
nls.param.df[nls.param.df$Code == "231",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_231.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_231.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_231.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_231.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals
```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_231 <- nlsResiduals(
  get(paste("nls_231.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_231)

## test residuals
if(length(P_231$pltID) < 5001) {test.nlsResiduals(resid_231)}

}   else {print("cannot plot residuals")}
```

## predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

P_231_pred <- predict(get(paste("nls_231.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME" = rep(mean(P_231$MEASTIME, na.rm = T), max(P_231$STDAGE)),
                                   "STDAGE" = seq(1, max(P_231$STDAGE), by = 1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME" = rep(mean(P_231$MEASTIME, na.rm = T), max(P_231$STDAGE)),
                                   "STDAGE" = seq(1, max(P_231$STDAGE), by = 1),
                                   "DeltaPDSI" = rep(mean(P_231$DeltaPDSI, na.rm = T), max(P_231$STDAGE)))
                      } )

P_231_pred_df <- data.frame("STDAGE"=seq(1,max(P_231$STDAGE),by = 1),  
                            "fitted"=P_231_pred)

## plot
gg.231 <- ggplot() +
          geom_point(aes(x = STDAGE, y = BIO_MgHa), data = P_231, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE, y = BIO_MgHa), data = P_231, 
                            fun.data = function(x) {
                              res <- quantile(x, probs = c(0.25,0.5,0.75))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_231))), breaks = cutvec_231) +  
          
          #geom_ribbon(aes(x = STDAGE, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = P_231_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE, y = fitted), data = P_231_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("231 -  Southeastern Mixed Forest") + 
          
          #ylim(0, max(P_231_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, cutvec_231[20]*1.05), expand = c(0,0))

gg.231

}  else {print("cannot plot data with prediction")}
```


## plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_231 <- data.frame(
  bin = as.factor(levels(cut(P_231$STDAGE, cutvec_231))),
  data.mean = tapply(P_231$BIO_MgHa, cut(P_231$STDAGE, cutvec_231), 
                     mean, na.rm = T), 
  data.CI.high =  tapply(P_231$BIO_MgHa, cut(P_231$STDAGE, cutvec_231), 
                    high.CI), 
  data.CI.low = tapply(P_231$BIO_MgHa, cut(P_231$STDAGE, cutvec_231),
                    low.CI), 
  pred.mean = P_231_pred_df[P_231_pred_df$STDAGE %in% bin_mids_231,]$fitted) 
  # pred.CI.high = tapply(`231_CI_df`$fitted, cut(`231_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_231$STDAGE, g=20))),
  #                      high.CI), 
  # pred.CI.low = tapply(`231_CI_df`$fitted, cut(`231_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_231$STDAGE, g=20))),
  #                      low.CI))

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_231 <-  DM_compare_231 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_231$bin)[gtools::mixedorder(levels(DM_compare_231$bin))]))

## ggplot
gg.231.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_231) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_231))), 
                              labels = levels(DM_compare_231$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("231 -  Southeastern Mixed Forest") +         
           theme_classic() + 
           # xlim(min(DM_compare_231$data.CI.low)-0.25, max(DM_compare_231$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_231$pred.CI.low)-0.25, max(DM_compare_231$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.231.B2

}   else {print("cannot plot observed vs. predicted")}
```

# 232 - Outer Coastal Plain Mixed Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_232 <- round(quantile(P_232$STDAGE, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_232)))){
  cutvec_232 <- round(quantile(P_232$STDAGE, seq(0,1, length.out = 11)))
}

bin_mids_232 <- unname(round(cutvec_232[-length(cutvec_232)] + diff(cutvec_232)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
P_232$STDAGE_bin<-  cut(P_232$STDAGE, cutvec_232)
## then get bin means
P_232_bin_means <- tapply(P_232$BIO_MgHa, cut(P_232$STDAGE, cutvec_232), mean)

## make column weights.2
P_232$nls_weights.2 <- as.numeric(1/(P_232_bin_means[match(P_232$STDAGE_bin, names(P_232_bin_means))])^2)

}
```

## model selection 1

```{r}
# simple
try(
  nls_232.1 <- nls(f_1, data = P_232, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = P_232$nls_weights.2), 
 )

## phi
try(
  nls_232.2 <- nls(f_2, data=P_232, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = P_232$nls_weights.2), 
 )

## test
if(exists("nls_232.1") & exists("nls_232.2")){
  print(anova(nls_232.1, nls_232.2))
}
 
## AIC comparison
AIC1_232 <- data.frame(model = c(1,2), AIC = c(
            ifelse(exists("nls_232.1"), AIC(get("nls_232.1")), NA),
            ifelse(exists("nls_232.2"), AIC(get("nls_232.2")), NA)
            ))

print(AIC1_232) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_232[!is.na(AIC1_232$AIC) & AIC1_232$AIC == min(AIC1_232$AIC, na.rm = T),]$model

try(summary(get(paste("nls_232.",  Mod.Sel1, sep =""))) )  #model summary
```
### summary 
* simple model: `r ifelse(exists("nls_232.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_232.2"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_232.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_232.",  Mod.Sel1, sep ="")))["phi"], 1)
A.fit <- round(coef(get(paste("nls_232.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_232.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_232.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = P_232,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              }, 
          weights = P_232$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_232.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = P_232,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              },
          weights = P_232$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_232.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = P_232,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              }, 
          weights = P_232$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_232.", Mod.Sel1, sep ="")) &
     exists(paste("nls_232.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_232.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_232.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_232.", Mod.Sel1, sep ="")),
             get(paste("nls_232.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_232.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_232.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_232.", Mod.Sel1, sep ="")) &
         exists(paste("nls_232.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_232.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_232.", Mod.Sel1, sep ="")),
               get(paste("nls_232.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_232.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_232.", Mod.Sel1, sep ="")) &
           exists(paste("nls_232.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_232.", Mod.Sel1, sep ="")),
                 get(paste("nls_232.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_232.", Mod.Sel1, sep ="")) &
              exists(paste("nls_232.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_232.", Mod.Sel1, sep ="")),
                    get(paste("nls_232.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_232.", Mod.Sel1, sep ="")) &
                exists(paste("nls_232.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_232.", Mod.Sel1, sep ="")),
                      get(paste("nls_232.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_232 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_232.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_232.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_232.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_232.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_232.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_232.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_232.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_232.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_232)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_232[!is.na(AIC2_232$AIC) & AIC2_232$AIC == min(AIC2_232$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P[Best_mods.P$Code == "232",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_232.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_232.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df[nls.param.df$Code == "232",]$ge <- coefs["ge"]
nls.param.df[nls.param.df$Code == "232",]$phi <- coefs["phi"]
nls.param.df[nls.param.df$Code == "232",]$A <- coefs["A"]
nls.param.df[nls.param.df$Code == "232",]$k <- coefs["k"]

nls.param.df[nls.param.df$Code == "232",]$ge.2.5 <- intervals_low["ge"]
nls.param.df[nls.param.df$Code == "232",]$phi.2.5 <- intervals_low["phi"]
nls.param.df[nls.param.df$Code == "232",]$A.2.5 <- intervals_low["A"]
nls.param.df[nls.param.df$Code == "232",]$k.2.5 <- intervals_low["k"]

nls.param.df[nls.param.df$Code == "232",]$ge.97.5 <- intervals_high["ge"]
nls.param.df[nls.param.df$Code == "232",]$phi.97.5 <- intervals_high["phi"]
nls.param.df[nls.param.df$Code == "232",]$A.97.5 <- intervals_high["A"]
nls.param.df[nls.param.df$Code == "232",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_232.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_232.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_232.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_232.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals
```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_232 <- nlsResiduals(
  get(paste("nls_232.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_232)

## test residuals
if(length(P_232$pltID) < 5001) {test.nlsResiduals(resid_232)}

}   else {print("cannot plot residuals")}
```

## predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

P_232_pred <- predict(get(paste("nls_232.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME" = rep(mean(P_232$MEASTIME, na.rm = T), max(P_232$STDAGE)),
                                   "STDAGE" = seq(1, max(P_232$STDAGE), by = 1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME" = rep(mean(P_232$MEASTIME, na.rm = T), max(P_232$STDAGE)),
                                   "STDAGE" = seq(1, max(P_232$STDAGE), by = 1),
                                   "DeltaPDSI" = rep(mean(P_232$DeltaPDSI, na.rm = T), max(P_232$STDAGE)))
                      } )

P_232_pred_df <- data.frame("STDAGE"=seq(1,max(P_232$STDAGE),by = 1),  
                            "fitted"=P_232_pred)

## plot
gg.232 <- ggplot() +
          geom_point(aes(x = STDAGE, y = BIO_MgHa), data = P_232, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE, y = BIO_MgHa), data = P_232, 
                            fun.data = function(x) {
                              res <- quantile(x, probs = c(0.25,0.5,0.75))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_232))), breaks = cutvec_232) +  
          
          #geom_ribbon(aes(x = STDAGE, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = P_232_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE, y = fitted), data = P_232_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("232 - Outer Coastal Plain Mixed Forest") + 
          
          #ylim(0, max(P_232_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, cutvec_232[20]*1.05), expand = c(0,0))

gg.232

}  else {print("cannot plot data with prediction")}
```


## plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_232 <- data.frame(
  bin = as.factor(levels(cut(P_232$STDAGE, cutvec_232))),
  data.mean = tapply(P_232$BIO_MgHa, cut(P_232$STDAGE, cutvec_232), 
                     mean, na.rm = T), 
  data.CI.high =  tapply(P_232$BIO_MgHa, cut(P_232$STDAGE, cutvec_232), 
                    high.CI), 
  data.CI.low = tapply(P_232$BIO_MgHa, cut(P_232$STDAGE, cutvec_232),
                    low.CI), 
  pred.mean = P_232_pred_df[P_232_pred_df$STDAGE %in% bin_mids_232,]$fitted) 
  # pred.CI.high = tapply(`232_CI_df`$fitted, cut(`232_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_232$STDAGE, g=20))),
  #                      high.CI), 
  # pred.CI.low = tapply(`232_CI_df`$fitted, cut(`232_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_232$STDAGE, g=20))),
  #                      low.CI))

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_232 <-  DM_compare_232 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_232$bin)[gtools::mixedorder(levels(DM_compare_232$bin))]))

## ggplot
gg.232.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_232) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_232))), 
                              labels = levels(DM_compare_232$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("232 - Outer Coastal Plain Mixed Forest") +         
           theme_classic() + 
           # xlim(min(DM_compare_232$data.CI.low)-0.25, max(DM_compare_232$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_232$pred.CI.low)-0.25, max(DM_compare_232$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.232.B2

}   else {print("cannot plot observed vs. predicted")}
```

# 234 - Lower Mississippi Riverine Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_234 <- round(quantile(P_234$STDAGE, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_234)))){
  cutvec_234 <- round(quantile(P_234$STDAGE, seq(0,1, length.out = 11)))
}

bin_mids_234 <- unname(round(cutvec_234[-length(cutvec_234)] + diff(cutvec_234)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
P_234$STDAGE_bin<-  cut(P_234$STDAGE, cutvec_234)
## then get bin means
P_234_bin_means <- tapply(P_234$BIO_MgHa, cut(P_234$STDAGE, cutvec_234), mean)

## make column weights.2
P_234$nls_weights.2 <- as.numeric(1/(P_234_bin_means[match(P_234$STDAGE_bin, names(P_234_bin_means))])^2)

}
```

## model selection 1

```{r}
# simple
try(
  nls_234.1 <- nls(f_1, data = P_234, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = P_234$nls_weights.2), 
 )

## phi
try(
  nls_234.2 <- nls(f_2, data=P_234, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = P_234$nls_weights.2), 
 )

## test
if(exists("nls_234.1") & exists("nls_234.2")){
  print(anova(nls_234.1, nls_234.2))
}
 
## AIC comparison
AIC1_234 <- data.frame(model = c(1,2), AIC = c(
            ifelse(exists("nls_234.1"), AIC(get("nls_234.1")), NA),
            ifelse(exists("nls_234.2"), AIC(get("nls_234.2")), NA)
            ))

print(AIC1_234) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_234[!is.na(AIC1_234$AIC) & AIC1_234$AIC == min(AIC1_234$AIC, na.rm = T),]$model

try(summary(get(paste("nls_234.",  Mod.Sel1, sep =""))) )  #model summary
```
### summary 
* simple model: `r ifelse(exists("nls_234.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_234.2"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_234.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_234.",  Mod.Sel1, sep ="")))["phi"], 1)
A.fit <- round(coef(get(paste("nls_234.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_234.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_234.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = P_234,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              }, 
          weights = P_234$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_234.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = P_234,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              },
          weights = P_234$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_234.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = P_234,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              }, 
          weights = P_234$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_234.", Mod.Sel1, sep ="")) &
     exists(paste("nls_234.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_234.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_234.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_234.", Mod.Sel1, sep ="")),
             get(paste("nls_234.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_234.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_234.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_234.", Mod.Sel1, sep ="")) &
         exists(paste("nls_234.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_234.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_234.", Mod.Sel1, sep ="")),
               get(paste("nls_234.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_234.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_234.", Mod.Sel1, sep ="")) &
           exists(paste("nls_234.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_234.", Mod.Sel1, sep ="")),
                 get(paste("nls_234.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_234.", Mod.Sel1, sep ="")) &
              exists(paste("nls_234.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_234.", Mod.Sel1, sep ="")),
                    get(paste("nls_234.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_234.", Mod.Sel1, sep ="")) &
                exists(paste("nls_234.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_234.", Mod.Sel1, sep ="")),
                      get(paste("nls_234.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_234 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_234.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_234.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_234.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_234.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_234.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_234.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_234.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_234.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_234)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_234[!is.na(AIC2_234$AIC) & AIC2_234$AIC == min(AIC2_234$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P[Best_mods.P$Code == "234",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_234.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_234.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df[nls.param.df$Code == "234",]$ge <- coefs["ge"]
nls.param.df[nls.param.df$Code == "234",]$phi <- coefs["phi"]
nls.param.df[nls.param.df$Code == "234",]$A <- coefs["A"]
nls.param.df[nls.param.df$Code == "234",]$k <- coefs["k"]

nls.param.df[nls.param.df$Code == "234",]$ge.2.5 <- intervals_low["ge"]
nls.param.df[nls.param.df$Code == "234",]$phi.2.5 <- intervals_low["phi"]
nls.param.df[nls.param.df$Code == "234",]$A.2.5 <- intervals_low["A"]
nls.param.df[nls.param.df$Code == "234",]$k.2.5 <- intervals_low["k"]

nls.param.df[nls.param.df$Code == "234",]$ge.97.5 <- intervals_high["ge"]
nls.param.df[nls.param.df$Code == "234",]$phi.97.5 <- intervals_high["phi"]
nls.param.df[nls.param.df$Code == "234",]$A.97.5 <- intervals_high["A"]
nls.param.df[nls.param.df$Code == "234",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_234.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_234.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_234.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_234.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals
```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_234 <- nlsResiduals(
  get(paste("nls_234.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_234)

## test residuals
if(length(P_234$pltID) < 5001) {test.nlsResiduals(resid_234)}

}   else {print("cannot plot residuals")}
```

## predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

P_234_pred <- predict(get(paste("nls_234.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME" = rep(mean(P_234$MEASTIME, na.rm = T), max(P_234$STDAGE)),
                                   "STDAGE" = seq(1, max(P_234$STDAGE), by = 1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME" = rep(mean(P_234$MEASTIME, na.rm = T), max(P_234$STDAGE)),
                                   "STDAGE" = seq(1, max(P_234$STDAGE), by = 1),
                                   "DeltaPDSI" = rep(mean(P_234$DeltaPDSI, na.rm = T), max(P_234$STDAGE)))
                      } )

P_234_pred_df <- data.frame("STDAGE"=seq(1,max(P_234$STDAGE),by = 1),  
                            "fitted"=P_234_pred)

## plot
gg.234 <- ggplot() +
          geom_point(aes(x = STDAGE, y = BIO_MgHa), data = P_234, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE, y = BIO_MgHa), data = P_234, 
                            fun.data = function(x) {
                              res <- quantile(x, probs = c(0.25,0.5,0.75))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_234))), breaks = cutvec_234) +  
          
          #geom_ribbon(aes(x = STDAGE, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = P_234_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE, y = fitted), data = P_234_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("234 - Lower Mississippi Riverine Forest") + 
          
          #ylim(0, max(P_234_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, cutvec_234[20]*1.05), expand = c(0,0))

gg.234

}  else {print("cannot plot data with prediction")}
```


## plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_234 <- data.frame(
  bin = as.factor(levels(cut(P_234$STDAGE, cutvec_234))),
  data.mean = tapply(P_234$BIO_MgHa, cut(P_234$STDAGE, cutvec_234), 
                     mean, na.rm = T), 
  data.CI.high =  tapply(P_234$BIO_MgHa, cut(P_234$STDAGE, cutvec_234), 
                    high.CI), 
  data.CI.low = tapply(P_234$BIO_MgHa, cut(P_234$STDAGE, cutvec_234),
                    low.CI), 
  pred.mean = P_234_pred_df[P_234_pred_df$STDAGE %in% bin_mids_234,]$fitted) 
  # pred.CI.high = tapply(`234_CI_df`$fitted, cut(`234_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_234$STDAGE, g=20))),
  #                      high.CI), 
  # pred.CI.low = tapply(`234_CI_df`$fitted, cut(`234_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_234$STDAGE, g=20))),
  #                      low.CI))

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_234 <-  DM_compare_234 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_234$bin)[gtools::mixedorder(levels(DM_compare_234$bin))]))

## ggplot
gg.234.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_234) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_234))), 
                              labels = levels(DM_compare_234$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("234 - Lower Mississippi Riverine Forest") +         
           theme_classic() + 
           # xlim(min(DM_compare_234$data.CI.low)-0.25, max(DM_compare_234$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_234$pred.CI.low)-0.25, max(DM_compare_234$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.234.B2

}   else {print("cannot plot observed vs. predicted")}
```

# 242 - Pacific Lowland Mixed Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_242 <- round(quantile(P_242$STDAGE, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_242)))){
  cutvec_242 <- round(quantile(P_242$STDAGE, seq(0,1, length.out = 11)))
}

bin_mids_242 <- unname(round(cutvec_242[-length(cutvec_242)] + diff(cutvec_242)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
P_242$STDAGE_bin<-  cut(P_242$STDAGE,cutvec_242)
## then get bin means
P_242_bin_means <- tapply(P_242$BIO_MgHa, cut(P_242$STDAGE,  cutvec_242), mean)

## make column weights.2
P_242$nls_weights.2 <- as.numeric(1/(P_242_bin_means[match(P_242$STDAGE_bin, names(P_242_bin_means))])^2)

}
```

## model selection 1

```{r}
# simple
try(
  nls_242.1 <- nls(f_1, data = P_242, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = P_242$nls_weights.2), 
 )

## phi
try(
  nls_242.2 <- nls(f_2, data=P_242, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = P_242$nls_weights.2), 
 )

## test
if(exists("nls_242.1") & exists("nls_242.2")){
  print(anova(nls_242.1, nls_242.2))
}
 
## AIC comparison
AIC1_242 <- data.frame(model = c(1,2), AIC = c(
            ifelse(exists("nls_242.1"), AIC(get("nls_242.1")), NA),
            ifelse(exists("nls_242.2"), AIC(get("nls_242.2")), NA)
            ))

print(AIC1_242) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_242[!is.na(AIC1_242$AIC) & AIC1_242$AIC == min(AIC1_242$AIC, na.rm = T),]$model

try(summary(get(paste("nls_242.",  Mod.Sel1, sep =""))) )  #model summary
```
### summary 
* simple model: `r ifelse(exists("nls_242.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_242.2"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_242.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_242.",  Mod.Sel1, sep ="")))["phi"], 1)
A.fit <- round(coef(get(paste("nls_242.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_242.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_242.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = P_242,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              }, 
          weights = P_242$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_242.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = P_242,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              },
          weights = P_242$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_242.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = P_242,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              }, 
          weights = P_242$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_242.", Mod.Sel1, sep ="")) &
     exists(paste("nls_242.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_242.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_242.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_242.", Mod.Sel1, sep ="")),
             get(paste("nls_242.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_242.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_242.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_242.", Mod.Sel1, sep ="")) &
         exists(paste("nls_242.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_242.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_242.", Mod.Sel1, sep ="")),
               get(paste("nls_242.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_242.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_242.", Mod.Sel1, sep ="")) &
           exists(paste("nls_242.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_242.", Mod.Sel1, sep ="")),
                 get(paste("nls_242.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_242.", Mod.Sel1, sep ="")) &
              exists(paste("nls_242.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_242.", Mod.Sel1, sep ="")),
                    get(paste("nls_242.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_242.", Mod.Sel1, sep ="")) &
                exists(paste("nls_242.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_242.", Mod.Sel1, sep ="")),
                      get(paste("nls_242.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_242 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_242.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_242.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_242.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_242.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_242.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_242.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_242.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_242.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_242)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_242[!is.na(AIC2_242$AIC) & AIC2_242$AIC == min(AIC2_242$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P[Best_mods.P$Code == "242",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_242.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_242.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df[nls.param.df$Code == "242",]$ge <- coefs["ge"]
nls.param.df[nls.param.df$Code == "242",]$phi <- coefs["phi"]
nls.param.df[nls.param.df$Code == "242",]$A <- coefs["A"]
nls.param.df[nls.param.df$Code == "242",]$k <- coefs["k"]

nls.param.df[nls.param.df$Code == "242",]$ge.2.5 <- intervals_low["ge"]
nls.param.df[nls.param.df$Code == "242",]$phi.2.5 <- intervals_low["phi"]
nls.param.df[nls.param.df$Code == "242",]$A.2.5 <- intervals_low["A"]
nls.param.df[nls.param.df$Code == "242",]$k.2.5 <- intervals_low["k"]

nls.param.df[nls.param.df$Code == "242",]$ge.97.5 <- intervals_high["ge"]
nls.param.df[nls.param.df$Code == "242",]$phi.97.5 <- intervals_high["phi"]
nls.param.df[nls.param.df$Code == "242",]$A.97.5 <- intervals_high["A"]
nls.param.df[nls.param.df$Code == "242",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_242.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_242.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_242.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_242.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals
```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_242 <- nlsResiduals(
  get(paste("nls_242.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_242)

## test residuals
if(length(P_242$pltID) < 5001) {test.nlsResiduals(resid_242)}

}   else {print("cannot plot residuals")}
```


## predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## predict model fit
P_242_pred <- predict(get(paste("nls_242.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME" = rep(mean(P_242$MEASTIME, na.rm = T), max(P_242$STDAGE)),
                                   "STDAGE" = seq(1, max(P_242$STDAGE), by = 1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME" = rep(mean(P_242$MEASTIME, na.rm = T), max(P_242$STDAGE)),
                                   "STDAGE" = seq(1, max(P_242$STDAGE), by = 1),
                                   "DeltaPDSI" = rep(mean(P_242$DeltaPDSI, na.rm = T), max(P_242$STDAGE)))
                      } )

P_242_pred_df <- data.frame("STDAGE"=seq(1, max(P_242$STDAGE), by = 1),
                            "fitted" =P_242_pred)

## plot
gg.242 <- ggplot() +
          geom_point(aes(x = STDAGE, y = BIO_MgHa), data = P_242, alpha = 0.5, shape ="+", col = "#60606080") +

          stat_summary_bin(aes(x = STDAGE, y = BIO_MgHa), data = P_242,
                            fun.data = function(x) {
                              res <- quantile(x, probs = c(0.25,0.5,0.75))
                              names(res) <- c("ymin","y","ymax")
                              res},
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_242))), breaks = cutvec_242) +

          #geom_ribbon(aes(x = STDAGE, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`),
                      #data = P_242_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +

          geom_line(aes(x = STDAGE, y = fitted), data = P_242_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) +


          theme_classic() +
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"),
               x = "Stand Age (yrs)") +  ggtitle("242 - Pacific Lowland Mixed Forest") +

          #ylim(0, max(P_242_pred_df$`Prop.97.5%` + 0.25)) +
          scale_x_continuous(limits = c(0, max(P_242$STDAGE)), expand = c(0,0))

gg.242

}  else {print("cannot plot data with prediction")}
```

## plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_242 <- data.frame(
  bin = as.factor(levels(cut(P_242$STDAGE, cutvec_242))),
  data.mean = tapply(P_242$BIO_MgHa, cut(P_242$STDAGE, cutvec_242),
                     mean, na.rm = T),
  data.CI.high =  tapply(P_242$BIO_MgHa, cut(P_242$STDAGE, cutvec_242),
                    high.CI),
  data.CI.low = tapply(P_242$BIO_MgHa, cut(P_242$STDAGE, cutvec_242),
                    low.CI),
  pred.mean = P_242_pred_df[P_242_pred_df$STDAGE %in% bin_mids_242,]$fitted)
  # pred.CI.high = tapply(`242_CI_df`$fitted, cut(`242_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_242$STDAGE, g=20))),
  #                      high.CI),
  # pred.CI.low = tapply(`242_CI_df`$fitted, cut(`242_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_242$STDAGE, g=20))),
  #                      low.CI))

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY
DM_compare_242 <-  DM_compare_242 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_242$bin)[gtools::mixedorder(levels(DM_compare_242$bin))]))

## ggplot
gg.242.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_242) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_242))),
                              labels = levels(DM_compare_242$bin),
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +
           labs(x = expression("observed biomass (Mg ha"^-1*")"),
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("242 - Pacific Lowland Mixed Forest") +
           theme_classic() +
           # xlim(min(DM_compare_242$data.CI.low)-0.25, max(DM_compare_242$data.CI.high)+0.25) +
           # ylim(min(DM_compare_242$pred.CI.low)-0.25, max(DM_compare_242$pred.CI.high)+0.25) +
           theme(legend.position = "top") + tune::coord_obs_pred()

gg.242.B2

}   else {print("cannot plot observed vs. predicted")}
```

# 251 - Prairie Parkland (Temperate)
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_251 <- round(quantile(P_251$STDAGE, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_251)))){
  cutvec_251 <- round(quantile(P_251$STDAGE, seq(0,1, length.out = 11)))
}

bin_mids_251 <- unname(round(cutvec_251[-length(cutvec_251)] + diff(cutvec_251)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
P_251$STDAGE_bin<-  cut(P_251$STDAGE, cutvec_251)
## then get bin means
P_251_bin_means <- tapply(P_251$BIO_MgHa, cut(P_251$STDAGE,  cutvec_251), mean)

## make column weights.2
P_251$nls_weights.2 <- as.numeric(1/(P_251_bin_means[match(P_251$STDAGE_bin, names(P_251_bin_means))])^2)

}
```

## model selection 1

```{r}
# simple
try(
  nls_251.1 <- nls(f_1, data = P_251, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = P_251$nls_weights.2), 
 )

## phi
try(
  nls_251.2 <- nls(f_2, data=P_251, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = P_251$nls_weights.2), 
 )

## test
if(exists("nls_251.1") & exists("nls_251.2")){
  print(anova(nls_251.1, nls_251.2))
}
 
## AIC comparison
AIC1_251 <- data.frame(model = c(1,2), AIC = c(
            ifelse(exists("nls_251.1"), AIC(get("nls_251.1")), NA),
            ifelse(exists("nls_251.2"), AIC(get("nls_251.2")), NA)
            ))

print(AIC1_251) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_251[!is.na(AIC1_251$AIC) & AIC1_251$AIC == min(AIC1_251$AIC, na.rm = T),]$model

try(summary(get(paste("nls_251.",  Mod.Sel1, sep =""))) )  #model summary
```
### summary 
* simple model: `r ifelse(exists("nls_251.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_251.2"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_251.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_251.",  Mod.Sel1, sep ="")))["phi"], 1)
A.fit <- round(coef(get(paste("nls_251.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_251.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_251.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = P_251,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              }, 
          weights = P_251$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_251.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = P_251,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              },
          weights = P_251$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_251.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = P_251,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              }, 
          weights = P_251$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_251.", Mod.Sel1, sep ="")) &
     exists(paste("nls_251.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_251.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_251.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_251.", Mod.Sel1, sep ="")),
             get(paste("nls_251.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_251.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_251.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_251.", Mod.Sel1, sep ="")) &
         exists(paste("nls_251.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_251.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_251.", Mod.Sel1, sep ="")),
               get(paste("nls_251.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_251.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_251.", Mod.Sel1, sep ="")) &
           exists(paste("nls_251.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_251.", Mod.Sel1, sep ="")),
                 get(paste("nls_251.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_251.", Mod.Sel1, sep ="")) &
              exists(paste("nls_251.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_251.", Mod.Sel1, sep ="")),
                    get(paste("nls_251.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_251.", Mod.Sel1, sep ="")) &
                exists(paste("nls_251.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_251.", Mod.Sel1, sep ="")),
                      get(paste("nls_251.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_251 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_251.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_251.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_251.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_251.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_251.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_251.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_251.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_251.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_251)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_251[!is.na(AIC2_251$AIC) & AIC2_251$AIC == min(AIC2_251$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P[Best_mods.P$Code == "251",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_251.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_251.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df[nls.param.df$Code == "251",]$ge <- coefs["ge"]
nls.param.df[nls.param.df$Code == "251",]$phi <- coefs["phi"]
nls.param.df[nls.param.df$Code == "251",]$A <- coefs["A"]
nls.param.df[nls.param.df$Code == "251",]$k <- coefs["k"]

nls.param.df[nls.param.df$Code == "251",]$ge.2.5 <- intervals_low["ge"]
nls.param.df[nls.param.df$Code == "251",]$phi.2.5 <- intervals_low["phi"]
nls.param.df[nls.param.df$Code == "251",]$A.2.5 <- intervals_low["A"]
nls.param.df[nls.param.df$Code == "251",]$k.2.5 <- intervals_low["k"]

nls.param.df[nls.param.df$Code == "251",]$ge.97.5 <- intervals_high["ge"]
nls.param.df[nls.param.df$Code == "251",]$phi.97.5 <- intervals_high["phi"]
nls.param.df[nls.param.df$Code == "251",]$A.97.5 <- intervals_high["A"]
nls.param.df[nls.param.df$Code == "251",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_251.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_251.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_251.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_251.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals
```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_251 <- nlsResiduals(
  get(paste("nls_251.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_251)

## test residuals
if(length(P_251$pltID) < 5001) {test.nlsResiduals(resid_251)}

}   else {print("cannot plot residuals")}
```

## predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

P_251_pred <- predict(get(paste("nls_251.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME" = rep(mean(P_251$MEASTIME, na.rm = T), max(P_251$STDAGE)),
                                   "STDAGE" = seq(1, max(P_251$STDAGE), by = 1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME" = rep(mean(P_251$MEASTIME, na.rm = T), max(P_251$STDAGE)),
                                   "STDAGE" = seq(1, max(P_251$STDAGE), by = 1),
                                   "DeltaPDSI" = rep(mean(P_251$DeltaPDSI, na.rm = T), max(P_251$STDAGE)))
                      } )

P_251_pred_df <- data.frame("STDAGE"=seq(1,max(P_251$STDAGE),by = 1),  
                            "fitted"=P_251_pred)

## plot
gg.251 <- ggplot() +
          geom_point(aes(x = STDAGE, y = BIO_MgHa), data = P_251, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE, y = BIO_MgHa), data = P_251, 
                            fun.data = function(x) {
                              res <- quantile(x, probs = c(0.25,0.5,0.75))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_251))), breaks = cutvec_251) +  
          
          #geom_ribbon(aes(x = STDAGE, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = P_251_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE, y = fitted), data = P_251_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("251 - Prairie Parkland (Temperate)") + 
          
          #ylim(0, max(P_251_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, cutvec_251[20]*1.05), expand = c(0,0))

gg.251

}  else {print("cannot plot data with prediction")}
```

## plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_251 <- data.frame(
  bin = as.factor(levels(cut(P_251$STDAGE, cutvec_251))),
  data.mean = tapply(P_251$BIO_MgHa, cut(P_251$STDAGE, cutvec_251), 
                     mean, na.rm = T), 
  data.CI.high =  tapply(P_251$BIO_MgHa, cut(P_251$STDAGE, cutvec_251), 
                    high.CI), 
  data.CI.low = tapply(P_251$BIO_MgHa, cut(P_251$STDAGE, cutvec_251),
                    low.CI), 
  pred.mean = P_251_pred_df[P_251_pred_df$STDAGE %in% bin_mids_251,]$fitted) 
  # pred.CI.high = tapply(`251_CI_df`$fitted, cut(`251_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_251$STDAGE, g=20))),
  #                      high.CI), 
  # pred.CI.low = tapply(`251_CI_df`$fitted, cut(`251_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_251$STDAGE, g=20))),
  #                      low.CI))

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_251 <-  DM_compare_251 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_251$bin)[gtools::mixedorder(levels(DM_compare_251$bin))]))

## ggplot
gg.251.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_251) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_251))), 
                              labels = levels(DM_compare_251$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("251 - Prairie Parkland (Temperate)") +         
           theme_classic() + 
           # xlim(min(DM_compare_251$data.CI.low)-0.25, max(DM_compare_251$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_251$pred.CI.low)-0.25, max(DM_compare_251$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.251.B2

}   else {print("cannot plot observed vs. predicted")}
```

# 255 - Prairie Parkland (Subtropical)
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_255 <- round(quantile(P_255$STDAGE, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_255)))){
  cutvec_255 <- round(quantile(P_255$STDAGE, seq(0,1, length.out = 11)))
}

bin_mids_255 <- unname(round(cutvec_255[-length(cutvec_255)] + diff(cutvec_255)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
P_255$STDAGE_bin<-  cut(P_255$STDAGE, cutvec_255)
## then get bin means
P_255_bin_means <- tapply(P_255$BIO_MgHa, cut(P_255$STDAGE,  cutvec_255), mean)

## make column weights.2
P_255$nls_weights.2 <- as.numeric(1/(P_255_bin_means[match(P_255$STDAGE_bin, names(P_255_bin_means))])^2)

}
```

## model selection 1

```{r}
# simple
try(
  nls_255.1 <- nls(f_1, data = P_255, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = P_255$nls_weights.2), 
 )

## phi
try(
  nls_255.2 <- nls(f_2, data=P_255, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = P_255$nls_weights.2), 
 )

## test
if(exists("nls_255.1") & exists("nls_255.2")){
  print(anova(nls_255.1, nls_255.2))
}
 
## AIC comparison
AIC1_255 <- data.frame(model = c(1,2), AIC = c(
            ifelse(exists("nls_255.1"), AIC(get("nls_255.1")), NA),
            ifelse(exists("nls_255.2"), AIC(get("nls_255.2")), NA)
            ))

print(AIC1_255) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_255[!is.na(AIC1_255$AIC) & AIC1_255$AIC == min(AIC1_255$AIC, na.rm = T),]$model

try(summary(get(paste("nls_255.",  Mod.Sel1, sep =""))) )  #model summary
```
### summary 
* simple model: `r ifelse(exists("nls_255.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_255.2"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_255.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_255.",  Mod.Sel1, sep ="")))["phi"], 1)
A.fit <- round(coef(get(paste("nls_255.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_255.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_255.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = P_255,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              }, 
          weights = P_255$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_255.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = P_255,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              },
          weights = P_255$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_255.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = P_255,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              }, 
          weights = P_255$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_255.", Mod.Sel1, sep ="")) &
     exists(paste("nls_255.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_255.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_255.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_255.", Mod.Sel1, sep ="")),
             get(paste("nls_255.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_255.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_255.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_255.", Mod.Sel1, sep ="")) &
         exists(paste("nls_255.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_255.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_255.", Mod.Sel1, sep ="")),
               get(paste("nls_255.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_255.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_255.", Mod.Sel1, sep ="")) &
           exists(paste("nls_255.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_255.", Mod.Sel1, sep ="")),
                 get(paste("nls_255.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_255.", Mod.Sel1, sep ="")) &
              exists(paste("nls_255.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_255.", Mod.Sel1, sep ="")),
                    get(paste("nls_255.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_255.", Mod.Sel1, sep ="")) &
                exists(paste("nls_255.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_255.", Mod.Sel1, sep ="")),
                      get(paste("nls_255.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_255 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_255.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_255.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_255.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_255.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_255.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_255.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_255.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_255.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_255)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_255[!is.na(AIC2_255$AIC) & AIC2_255$AIC == min(AIC2_255$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P[Best_mods.P$Code == "255",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_255.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_255.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df[nls.param.df$Code == "255",]$ge <- coefs["ge"]
nls.param.df[nls.param.df$Code == "255",]$phi <- coefs["phi"]
nls.param.df[nls.param.df$Code == "255",]$A <- coefs["A"]
nls.param.df[nls.param.df$Code == "255",]$k <- coefs["k"]

nls.param.df[nls.param.df$Code == "255",]$ge.2.5 <- intervals_low["ge"]
nls.param.df[nls.param.df$Code == "255",]$phi.2.5 <- intervals_low["phi"]
nls.param.df[nls.param.df$Code == "255",]$A.2.5 <- intervals_low["A"]
nls.param.df[nls.param.df$Code == "255",]$k.2.5 <- intervals_low["k"]

nls.param.df[nls.param.df$Code == "255",]$ge.97.5 <- intervals_high["ge"]
nls.param.df[nls.param.df$Code == "255",]$phi.97.5 <- intervals_high["phi"]
nls.param.df[nls.param.df$Code == "255",]$A.97.5 <- intervals_high["A"]
nls.param.df[nls.param.df$Code == "255",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_255.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_255.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_255.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_255.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals
```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_255 <- nlsResiduals(
  get(paste("nls_255.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_255)

## test residuals
if(length(P_255$pltID) < 5001) {test.nlsResiduals(resid_255)}

}   else {print("cannot plot residuals")}
```

## predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

P_255_pred <- predict(get(paste("nls_255.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME" = rep(mean(P_255$MEASTIME, na.rm = T), max(P_255$STDAGE)),
                                   "STDAGE" = seq(1, max(P_255$STDAGE), by = 1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME" = rep(mean(P_255$MEASTIME, na.rm = T), max(P_255$STDAGE)),
                                   "STDAGE" = seq(1, max(P_255$STDAGE), by = 1),
                                   "DeltaPDSI" = rep(mean(P_255$DeltaPDSI, na.rm = T), max(P_255$STDAGE)))
                      } )

P_255_pred_df <- data.frame("STDAGE"=seq(1,max(P_255$STDAGE),by = 1),  
                            "fitted"=P_255_pred)

## plot
gg.255 <- ggplot() +
          geom_point(aes(x = STDAGE, y = BIO_MgHa), data = P_255, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE, y = BIO_MgHa), data = P_255, 
                            fun.data = function(x) {
                              res <- quantile(x, probs = c(0.25,0.5,0.75))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_255))), breaks = cutvec_255) +  
          
          #geom_ribbon(aes(x = STDAGE, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = P_255_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE, y = fitted), data = P_255_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("255 -  Prairie Parkland (Subtropical)") + 
          
          #ylim(0, max(P_255_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, cutvec_255[20]*1.05), expand = c(0,0))

gg.255

}  else {print("cannot plot data with prediction")}
```


## plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_255 <- data.frame(
  bin = as.factor(levels(cut(P_255$STDAGE, cutvec_255))),
  data.mean = tapply(P_255$BIO_MgHa, cut(P_255$STDAGE, cutvec_255), 
                     mean, na.rm = T), 
  data.CI.high =  tapply(P_255$BIO_MgHa, cut(P_255$STDAGE, cutvec_255), 
                    high.CI), 
  data.CI.low = tapply(P_255$BIO_MgHa, cut(P_255$STDAGE, cutvec_255),
                    low.CI), 
  pred.mean = P_255_pred_df[P_255_pred_df$STDAGE %in% bin_mids_255,]$fitted) 
  # pred.CI.high = tapply(`255_CI_df`$fitted, cut(`255_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_255$STDAGE, g=20))),
  #                      high.CI), 
  # pred.CI.low = tapply(`255_CI_df`$fitted, cut(`255_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_255$STDAGE, g=20))),
  #                      low.CI))

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_255 <-  DM_compare_255 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_255$bin)[gtools::mixedorder(levels(DM_compare_255$bin))]))

## ggplot
gg.255.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_255) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_255))), 
                              labels = levels(DM_compare_255$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("255 -  Prairie Parkland (Subtropical)") +         
           theme_classic() + 
           # xlim(min(DM_compare_255$data.CI.low)-0.25, max(DM_compare_255$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_255$pred.CI.low)-0.25, max(DM_compare_255$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.255.B2

}   else {print("cannot plot observed vs. predicted")}
```

# 261 - California Coastal Chaparral Forest and Shrub
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_261 <- round(quantile(P_261$STDAGE, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_261)))){
  cutvec_261 <- round(quantile(P_261$STDAGE, seq(0,1, length.out = 11)))
}

bin_mids_261 <- unname(round(cutvec_261[-length(cutvec_261)] + diff(cutvec_261)/2))

#### add weights data column)

## first get the correct bin  - assign as column in data frame
P_261$STDAGE_bin<-  cut(P_261$STDAGE, cutvec_261)
## then get bin means
P_261_bin_means <- tapply(P_261$BIO_MgHa, cut(P_261$STDAGE,  cutvec_261), mean)

## make column weights.2
P_261$nls_weights.2 <- as.numeric(1/(P_261_bin_means[match(P_261$STDAGE_bin, names(P_261_bin_means))])^2)

}
```

## model selection 1

```{r}
# simple
try(
  nls_261.1 <- nls(f_1, data = P_261, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = P_261$nls_weights.2), 
 )

## phi
try(
  nls_261.2 <- nls(f_2, data=P_261, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = P_261$nls_weights.2), 
 )

## test
if(exists("nls_261.1") & exists("nls_261.2")){
  print(anova(nls_261.1, nls_261.2))
}
 
## AIC comparison
AIC1_261 <- data.frame(model = c(1,2), AIC = c(
            ifelse(exists("nls_261.1"), AIC(get("nls_261.1")), NA),
            ifelse(exists("nls_261.2"), AIC(get("nls_261.2")), NA)
            ))

print(AIC1_261) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_261[!is.na(AIC1_261$AIC) & AIC1_261$AIC == min(AIC1_261$AIC, na.rm = T),]$model

try(summary(get(paste("nls_261.",  Mod.Sel1, sep =""))) )  #model summary
```
### summary 
* simple model: `r ifelse(exists("nls_261.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_261.2"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_261.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_261.",  Mod.Sel1, sep ="")))["phi"], 1)
A.fit <- round(coef(get(paste("nls_261.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_261.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_261.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = P_261,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              }, 
          weights = P_261$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_261.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = P_261,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              },
          weights = P_261$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_261.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = P_261,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              }, 
          weights = P_261$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_261.", Mod.Sel1, sep ="")) &
     exists(paste("nls_261.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_261.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_261.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_261.", Mod.Sel1, sep ="")),
             get(paste("nls_261.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_261.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_261.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_261.", Mod.Sel1, sep ="")) &
         exists(paste("nls_261.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_261.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_261.", Mod.Sel1, sep ="")),
               get(paste("nls_261.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_261.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_261.", Mod.Sel1, sep ="")) &
           exists(paste("nls_261.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_261.", Mod.Sel1, sep ="")),
                 get(paste("nls_261.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_261.", Mod.Sel1, sep ="")) &
              exists(paste("nls_261.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_261.", Mod.Sel1, sep ="")),
                    get(paste("nls_261.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_261.", Mod.Sel1, sep ="")) &
                exists(paste("nls_261.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_261.", Mod.Sel1, sep ="")),
                      get(paste("nls_261.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_261 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_261.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_261.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_261.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_261.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_261.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_261.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_261.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_261.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_261)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_261[!is.na(AIC2_261$AIC) & AIC2_261$AIC == min(AIC2_261$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P[Best_mods.P$Code == "261",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_261.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_261.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df[nls.param.df$Code == "261",]$ge <- coefs["ge"]
nls.param.df[nls.param.df$Code == "261",]$phi <- coefs["phi"]
nls.param.df[nls.param.df$Code == "261",]$A <- coefs["A"]
nls.param.df[nls.param.df$Code == "261",]$k <- coefs["k"]

nls.param.df[nls.param.df$Code == "261",]$ge.2.5 <- intervals_low["ge"]
nls.param.df[nls.param.df$Code == "261",]$phi.2.5 <- intervals_low["phi"]
nls.param.df[nls.param.df$Code == "261",]$A.2.5 <- intervals_low["A"]
nls.param.df[nls.param.df$Code == "261",]$k.2.5 <- intervals_low["k"]

nls.param.df[nls.param.df$Code == "261",]$ge.97.5 <- intervals_high["ge"]
nls.param.df[nls.param.df$Code == "261",]$phi.97.5 <- intervals_high["phi"]
nls.param.df[nls.param.df$Code == "261",]$A.97.5 <- intervals_high["A"]
nls.param.df[nls.param.df$Code == "261",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_261.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_261.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_261.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_261.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

* unable to fit model (only 64 observations)

## plot residuals
```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_261 <- nlsResiduals(
  get(paste("nls_261.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_261)

## test residuals
if(length(P_261$pltID) < 5001) {test.nlsResiduals(resid_261)}

}  else {print("cannot plot residuals")}
```

## predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

P_261_pred <- predict(get(paste("nls_261.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME" = rep(mean(P_261$MEASTIME, na.rm = T), max(P_261$STDAGE)),
                                   "STDAGE" = seq(1, max(P_261$STDAGE), by = 1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME" = rep(mean(P_261$MEASTIME, na.rm = T), max(P_261$STDAGE)),
                                   "STDAGE" = seq(1, max(P_261$STDAGE), by = 1),
                                   "DeltaPDSI" = rep(mean(P_261$DeltaPDSI, na.rm = T), max(P_261$STDAGE)))
                      } )

P_261_pred_df <- data.frame("STDAGE"=seq(1,max(P_261$STDAGE),by = 1),  
                            "fitted"=P_261_pred)

## plot
gg.261 <- ggplot() +
          geom_point(aes(x = STDAGE, y = BIO_MgHa), data = P_261, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE, y = BIO_MgHa), data = P_261, 
                            fun.data = function(x) {
                              res <- quantile(x, probs = c(0.25,0.5,0.75))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_261)-1)), breaks = cutvec_261) +  
          
          #geom_ribbon(aes(x = STDAGE, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = P_261_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE, y = fitted), data = P_261_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("261 - California Coastal Chaparral Forest and Shrub") + 
          
          #ylim(0, max(P_261_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, cutvec_261[10]*1.05), expand = c(0,0))

gg.261

}  else {print("cannot plot data with prediction")}
```


## plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_261 <- data.frame(
  bin = as.factor(levels(cut(P_261$STDAGE, cutvec_261))),
  data.mean = tapply(P_261$BIO_MgHa, cut(P_261$STDAGE, cutvec_261), 
                     mean, na.rm = T), 
  data.CI.high =  tapply(P_261$BIO_MgHa, cut(P_261$STDAGE, cutvec_261), 
                    high.CI), 
  data.CI.low = tapply(P_261$BIO_MgHa, cut(P_261$STDAGE, cutvec_261),
                    low.CI), 
  pred.mean = P_261_pred_df[P_261_pred_df$STDAGE %in% bin_mids_261,]$fitted) 
  # pred.CI.high = tapply(`261_CI_df`$fitted, cut(`261_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_261$STDAGE, g=20))),
  #                      high.CI), 
  # pred.CI.low = tapply(`261_CI_df`$fitted, cut(`261_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_261$STDAGE, g=20))),
  #                      low.CI))

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_261 <-  DM_compare_261 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_261$bin)[gtools::mixedorder(levels(DM_compare_261$bin))]))

## ggplot
gg.261.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_261) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_261))), 
                              labels = levels(DM_compare_261$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("261 - California Coastal Chaparral Forest and Shrub") +         
           theme_classic() + 
           # xlim(min(DM_compare_261$data.CI.low)-0.25, max(DM_compare_261$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_261$pred.CI.low)-0.25, max(DM_compare_261$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.261.B2

}   else {print("cannot plot observed vs. predicted")}
```

# 262 - California Dry Steppe
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_262 <- round(quantile(P_262$STDAGE, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_262)))){
  cutvec_262 <- round(quantile(P_262$STDAGE, seq(0,1, length.out = 11)))
}

bin_mids_262 <- unname(round(cutvec_262[-length(cutvec_262)] + diff(cutvec_262)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
P_262$STDAGE_bin<-  cut(P_262$STDAGE, cutvec_262)
## then get bin means
P_262_bin_means <- tapply(P_262$BIO_MgHa, cut(P_262$STDAGE,  cutvec_262), mean)

## make column weights.2
P_262$nls_weights.2 <- as.numeric(1/(P_262_bin_means[match(P_262$STDAGE_bin, names(P_262_bin_means))])^2)

}
```

## model selection 1

```{r}
# simple
try(
  nls_262.1 <- nls(f_1, data = P_262, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = P_262$nls_weights.2), 
 )

## phi
try(
  nls_262.2 <- nls(f_2, data=P_262, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = P_262$nls_weights.2), 
 )

## test
if(exists("nls_262.1") & exists("nls_262.2")){
  print(anova(nls_262.1, nls_262.2))
}
 
## AIC comparison
AIC1_262 <- data.frame(model = c(1,2), AIC = c(
            ifelse(exists("nls_262.1"), AIC(get("nls_262.1")), NA),
            ifelse(exists("nls_262.2"), AIC(get("nls_262.2")), NA)
            ))

print(AIC1_262) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_262[!is.na(AIC1_262$AIC) & AIC1_262$AIC == min(AIC1_262$AIC, na.rm = T),]$model

try(summary(get(paste("nls_262.",  Mod.Sel1, sep =""))) )  #model summary
```
### summary 
* simple model: `r ifelse(exists("nls_262.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_262.2"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_262.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_262.",  Mod.Sel1, sep ="")))["phi"], 1)
A.fit <- round(coef(get(paste("nls_262.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_262.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_262.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = P_262,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              }, 
          weights = P_262$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_262.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = P_262,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              },
          weights = P_262$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_262.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = P_262,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              }, 
          weights = P_262$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_262.", Mod.Sel1, sep ="")) &
     exists(paste("nls_262.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_262.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_262.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_262.", Mod.Sel1, sep ="")),
             get(paste("nls_262.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_262.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_262.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_262.", Mod.Sel1, sep ="")) &
         exists(paste("nls_262.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_262.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_262.", Mod.Sel1, sep ="")),
               get(paste("nls_262.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_262.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_262.", Mod.Sel1, sep ="")) &
           exists(paste("nls_262.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_262.", Mod.Sel1, sep ="")),
                 get(paste("nls_262.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_262.", Mod.Sel1, sep ="")) &
              exists(paste("nls_262.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_262.", Mod.Sel1, sep ="")),
                    get(paste("nls_262.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_262.", Mod.Sel1, sep ="")) &
                exists(paste("nls_262.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_262.", Mod.Sel1, sep ="")),
                      get(paste("nls_262.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_262 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_262.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_262.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_262.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_262.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_262.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_262.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_262.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_262.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_262)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_262[!is.na(AIC2_262$AIC) & AIC2_262$AIC == min(AIC2_262$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P[Best_mods.P$Code == "262",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_262.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_262.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df[nls.param.df$Code == "262",]$ge <- coefs["ge"]
nls.param.df[nls.param.df$Code == "262",]$phi <- coefs["phi"]
nls.param.df[nls.param.df$Code == "262",]$A <- coefs["A"]
nls.param.df[nls.param.df$Code == "262",]$k <- coefs["k"]

nls.param.df[nls.param.df$Code == "262",]$ge.2.5 <- intervals_low["ge"]
nls.param.df[nls.param.df$Code == "262",]$phi.2.5 <- intervals_low["phi"]
nls.param.df[nls.param.df$Code == "262",]$A.2.5 <- intervals_low["A"]
nls.param.df[nls.param.df$Code == "262",]$k.2.5 <- intervals_low["k"]

nls.param.df[nls.param.df$Code == "262",]$ge.97.5 <- intervals_high["ge"]
nls.param.df[nls.param.df$Code == "262",]$phi.97.5 <- intervals_high["phi"]
nls.param.df[nls.param.df$Code == "262",]$A.97.5 <- intervals_high["A"]
nls.param.df[nls.param.df$Code == "262",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_262.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_262.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_262.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_262.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

* unable to fit model (0 observations)

## plot residuals
```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_262 <- nlsResiduals(
  get(paste("nls_262.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_262)

## test residuals
if(length(P_262$pltID) < 5001) {test.nlsResiduals(resid_262)}

}  else {print("cannot plot residuals")}
```

## predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

P_262_pred <- predict(get(paste("nls_262.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME" = rep(mean(P_262$MEASTIME, na.rm = T), max(P_262$STDAGE)),
                                   "STDAGE" = seq(1, max(P_262$STDAGE), by = 1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME" = rep(mean(P_262$MEASTIME, na.rm = T), max(P_262$STDAGE)),
                                   "STDAGE" = seq(1, max(P_262$STDAGE), by = 1),
                                   "DeltaPDSI" = rep(mean(P_262$DeltaPDSI, na.rm = T), max(P_262$STDAGE)))
                      } )

P_262_pred_df <- data.frame("STDAGE"=seq(1,max(P_262$STDAGE),by = 1),  
                            "fitted"=P_262_pred)

## plot
gg.262 <- ggplot() +
          geom_point(aes(x = STDAGE, y = BIO_MgHa), data = P_262, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE, y = BIO_MgHa), data = P_262, 
                            fun.data = function(x) {
                              res <- quantile(x, probs = c(0.25,0.5,0.75))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_262))), breaks = cutvec_262) +  
          
          #geom_ribbon(aes(x = STDAGE, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = P_262_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE, y = fitted), data = P_262_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("262 - California Dry Steppe") + 
          
          #ylim(0, max(P_262_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, cutvec_262[20]*1.05), expand = c(0,0))

gg.262

}  else {print("cannot plot data with prediction")}
```


## plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_262 <- data.frame(
  bin = as.factor(levels(cut(P_262$STDAGE, cutvec_262))),
  data.mean = tapply(P_262$BIO_MgHa, cut(P_262$STDAGE, cutvec_262), 
                     mean, na.rm = T), 
  data.CI.high =  tapply(P_262$BIO_MgHa, cut(P_262$STDAGE, cutvec_262), 
                    high.CI), 
  data.CI.low = tapply(P_262$BIO_MgHa, cut(P_262$STDAGE, cutvec_262),
                    low.CI), 
  pred.mean = P_262_pred_df[P_262_pred_df$STDAGE %in% bin_mids_262,]$fitted) 
  # pred.CI.high = tapply(`262_CI_df`$fitted, cut(`262_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_262$STDAGE, g=20))),
  #                      high.CI), 
  # pred.CI.low = tapply(`262_CI_df`$fitted, cut(`262_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_262$STDAGE, g=20))),
  #                      low.CI))

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_262 <-  DM_compare_262 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_262$bin)[gtools::mixedorder(levels(DM_compare_262$bin))]))

## ggplot
gg.262.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_262) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_262))), 
                              labels = levels(DM_compare_262$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("262 - California Dry Steppe") +         
           theme_classic() + 
           # xlim(min(DM_compare_262$data.CI.low)-0.25, max(DM_compare_262$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_262$pred.CI.low)-0.25, max(DM_compare_262$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.262.B2

}   else {print("cannot plot observed vs. predicted")}
```

# 263 - California Coastal Steppe - Mixed Forest and Redwood Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_263 <- round(quantile(P_263$STDAGE, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_263)))){
  cutvec_263 <- round(quantile(P_263$STDAGE, seq(0,1, length.out = 11)))
}

bin_mids_263 <- unname(round(cutvec_263[-length(cutvec_263)] + diff(cutvec_263)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
P_263$STDAGE_bin<-  cut(P_263$STDAGE, cutvec_263)
## then get bin means
P_263_bin_means <- tapply(P_263$BIO_MgHa, cut(P_263$STDAGE,  cutvec_263), mean)

## make column weights.2
P_263$nls_weights.2 <- as.numeric(1/(P_263_bin_means[match(P_263$STDAGE_bin, names(P_263_bin_means))])^2)

}
```

## model selection 1

```{r}
# simple
try(
  nls_263.1 <- nls(f_1, data = P_263, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = P_263$nls_weights.2), 
 )

## phi
try(
  nls_263.2 <- nls(f_2, data=P_263, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = P_263$nls_weights.2), 
 )

## test
if(exists("nls_263.1") & exists("nls_263.2")){
  print(anova(nls_263.1, nls_263.2))
}
 
## AIC comparison
AIC1_263 <- data.frame(model = c(1,2), AIC = c(
            ifelse(exists("nls_263.1"), AIC(get("nls_263.1")), NA),
            ifelse(exists("nls_263.2"), AIC(get("nls_263.2")), NA)
            ))

print(AIC1_263) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_263[!is.na(AIC1_263$AIC) & AIC1_263$AIC == min(AIC1_263$AIC, na.rm = T),]$model

try(summary(get(paste("nls_263.",  Mod.Sel1, sep =""))) )  #model summary
```
### summary 
* simple model: `r ifelse(exists("nls_263.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_263.2"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_263.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_263.",  Mod.Sel1, sep ="")))["phi"], 1)
A.fit <- round(coef(get(paste("nls_263.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_263.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_263.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = P_263,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              }, 
          weights = P_263$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_263.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = P_263,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              },
          weights = P_263$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_263.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = P_263,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              }, 
          weights = P_263$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_263.", Mod.Sel1, sep ="")) &
     exists(paste("nls_263.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_263.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_263.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_263.", Mod.Sel1, sep ="")),
             get(paste("nls_263.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_263.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_263.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_263.", Mod.Sel1, sep ="")) &
         exists(paste("nls_263.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_263.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_263.", Mod.Sel1, sep ="")),
               get(paste("nls_263.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_263.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_263.", Mod.Sel1, sep ="")) &
           exists(paste("nls_263.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_263.", Mod.Sel1, sep ="")),
                 get(paste("nls_263.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_263.", Mod.Sel1, sep ="")) &
              exists(paste("nls_263.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_263.", Mod.Sel1, sep ="")),
                    get(paste("nls_263.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_263.", Mod.Sel1, sep ="")) &
                exists(paste("nls_263.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_263.", Mod.Sel1, sep ="")),
                      get(paste("nls_263.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_263 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_263.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_263.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_263.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_263.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_263.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_263.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_263.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_263.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_263)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_263[!is.na(AIC2_263$AIC) & AIC2_263$AIC == min(AIC2_263$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P[Best_mods.P$Code == "263",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_263.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_263.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df[nls.param.df$Code == "263",]$ge <- coefs["ge"]
nls.param.df[nls.param.df$Code == "263",]$phi <- coefs["phi"]
nls.param.df[nls.param.df$Code == "263",]$A <- coefs["A"]
nls.param.df[nls.param.df$Code == "263",]$k <- coefs["k"]

nls.param.df[nls.param.df$Code == "263",]$ge.2.5 <- intervals_low["ge"]
nls.param.df[nls.param.df$Code == "263",]$phi.2.5 <- intervals_low["phi"]
nls.param.df[nls.param.df$Code == "263",]$A.2.5 <- intervals_low["A"]
nls.param.df[nls.param.df$Code == "263",]$k.2.5 <- intervals_low["k"]

nls.param.df[nls.param.df$Code == "263",]$ge.97.5 <- intervals_high["ge"]
nls.param.df[nls.param.df$Code == "263",]$phi.97.5 <- intervals_high["phi"]
nls.param.df[nls.param.df$Code == "263",]$A.97.5 <- intervals_high["A"]
nls.param.df[nls.param.df$Code == "263",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_263.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_263.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_263.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_263.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals
```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_263 <- nlsResiduals(
  get(paste("nls_263.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_263)

## test residuals
if(length(P_263$pltID) < 5001) {test.nlsResiduals(resid_263)}

}  else {print("cannot plot residuals")}
```

## predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

P_263_pred <- predict(get(paste("nls_263.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME" = rep(mean(P_263$MEASTIME, na.rm = T), max(P_263$STDAGE)),
                                   "STDAGE" = seq(1, max(P_263$STDAGE), by = 1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME" = rep(mean(P_263$MEASTIME, na.rm = T), max(P_263$STDAGE)),
                                   "STDAGE" = seq(1, max(P_263$STDAGE), by = 1),
                                   "DeltaPDSI" = rep(mean(P_263$DeltaPDSI, na.rm = T), max(P_263$STDAGE)))
                      } )

P_263_pred_df <- data.frame("STDAGE"=seq(1,max(P_263$STDAGE),by = 1),  
                            "fitted"=P_263_pred)

## plot
gg.263 <- ggplot() +
          geom_point(aes(x = STDAGE, y = BIO_MgHa), data = P_263, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE, y = BIO_MgHa), data = P_263, 
                            fun.data = function(x) {
                              res <- quantile(x, probs = c(0.25,0.5,0.75))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_263))), breaks = cutvec_263) +  
          
          #geom_ribbon(aes(x = STDAGE, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = P_263_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE, y = fitted), data = P_263_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("263 - California Coastal Steppe - Mixed Forest and Redwood Forest") + 
          
          #ylim(0, max(P_263_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, cutvec_263[20]*1.05), expand = c(0,0))

gg.263

}  else {print("cannot plot data with prediction")}
```

## plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_263 <- data.frame(
  bin = as.factor(levels(cut(P_263$STDAGE, cutvec_263))),
  data.mean = tapply(P_263$BIO_MgHa, cut(P_263$STDAGE, cutvec_263), 
                     mean, na.rm = T), 
  data.CI.high =  tapply(P_263$BIO_MgHa, cut(P_263$STDAGE, cutvec_263), 
                    high.CI), 
  data.CI.low = tapply(P_263$BIO_MgHa, cut(P_263$STDAGE, cutvec_263),
                    low.CI), 
  pred.mean = P_263_pred_df[P_263_pred_df$STDAGE %in% bin_mids_263,]$fitted) 
  # pred.CI.high = tapply(`263_CI_df`$fitted, cut(`263_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_263$STDAGE, g=20))),
  #                      high.CI), 
  # pred.CI.low = tapply(`263_CI_df`$fitted, cut(`263_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_263$STDAGE, g=20))),
  #                      low.CI))

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_263 <-  DM_compare_263 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_263$bin)[gtools::mixedorder(levels(DM_compare_263$bin))]))

## ggplot
gg.263.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_263) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_263))), 
                              labels = levels(DM_compare_263$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("263 - California Coastal Steppe - Mixed Forest and Redwood Forest") +         
           theme_classic() + 
           # xlim(min(DM_compare_263$data.CI.low)-0.25, max(DM_compare_263$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_263$pred.CI.low)-0.25, max(DM_compare_263$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.263.B2

}   else {print("cannot plot observed vs. predicted")}
```

# 313 - Colorado Plateau Semi-Desert
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_313 <- round(quantile(P_313$STDAGE, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_313)))){
  cutvec_313 <- round(quantile(P_313$STDAGE, seq(0,1, length.out = 11)))
}

bin_mids_313 <- unname(round(cutvec_313[-length(cutvec_313)] + diff(cutvec_313)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
P_313$STDAGE_bin<-  cut(P_313$STDAGE, cutvec_313)
## then get bin means
P_313_bin_means <- tapply(P_313$BIO_MgHa, cut(P_313$STDAGE,  cutvec_313), mean)

## make column weights.2
P_313$nls_weights.2 <- as.numeric(1/(P_313_bin_means[match(P_313$STDAGE_bin, names(P_313_bin_means))])^2)

}
```

## model selection 1

```{r}
# simple
try(
  nls_313.1 <- nls(f_1, data = P_313, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = P_313$nls_weights.2), 
 )

## phi
try(
  nls_313.2 <- nls(f_2, data=P_313, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = P_313$nls_weights.2), 
 )

## test
if(exists("nls_313.1") & exists("nls_313.2")){
  print(anova(nls_313.1, nls_313.2))
}
 
## AIC comparison
AIC1_313 <- data.frame(model = c(1,2), AIC = c(
            ifelse(exists("nls_313.1"), AIC(get("nls_313.1")), NA),
            ifelse(exists("nls_313.2"), AIC(get("nls_313.2")), NA)
            ))

print(AIC1_313) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_313[!is.na(AIC1_313$AIC) & AIC1_313$AIC == min(AIC1_313$AIC, na.rm = T),]$model

try(summary(get(paste("nls_313.",  Mod.Sel1, sep =""))) )  #model summary
```
### summary 
* simple model: `r ifelse(exists("nls_313.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_313.2"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_313.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_313.",  Mod.Sel1, sep ="")))["phi"], 1)
A.fit <- round(coef(get(paste("nls_313.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_313.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_313.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = P_313,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              }, 
          weights = P_313$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_313.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = P_313,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              },
          weights = P_313$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_313.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = P_313,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              }, 
          weights = P_313$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_313.", Mod.Sel1, sep ="")) &
     exists(paste("nls_313.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_313.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_313.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_313.", Mod.Sel1, sep ="")),
             get(paste("nls_313.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_313.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_313.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_313.", Mod.Sel1, sep ="")) &
         exists(paste("nls_313.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_313.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_313.", Mod.Sel1, sep ="")),
               get(paste("nls_313.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_313.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_313.", Mod.Sel1, sep ="")) &
           exists(paste("nls_313.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_313.", Mod.Sel1, sep ="")),
                 get(paste("nls_313.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_313.", Mod.Sel1, sep ="")) &
              exists(paste("nls_313.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_313.", Mod.Sel1, sep ="")),
                    get(paste("nls_313.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_313.", Mod.Sel1, sep ="")) &
                exists(paste("nls_313.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_313.", Mod.Sel1, sep ="")),
                      get(paste("nls_313.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_313 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_313.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_313.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_313.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_313.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_313.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_313.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_313.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_313.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_313)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_313[!is.na(AIC2_313$AIC) & AIC2_313$AIC == min(AIC2_313$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P[Best_mods.P$Code == "313",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_313.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_313.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df[nls.param.df$Code == "313",]$ge <- coefs["ge"]
nls.param.df[nls.param.df$Code == "313",]$phi <- coefs["phi"]
nls.param.df[nls.param.df$Code == "313",]$A <- coefs["A"]
nls.param.df[nls.param.df$Code == "313",]$k <- coefs["k"]

nls.param.df[nls.param.df$Code == "313",]$ge.2.5 <- intervals_low["ge"]
nls.param.df[nls.param.df$Code == "313",]$phi.2.5 <- intervals_low["phi"]
nls.param.df[nls.param.df$Code == "313",]$A.2.5 <- intervals_low["A"]
nls.param.df[nls.param.df$Code == "313",]$k.2.5 <- intervals_low["k"]

nls.param.df[nls.param.df$Code == "313",]$ge.97.5 <- intervals_high["ge"]
nls.param.df[nls.param.df$Code == "313",]$phi.97.5 <- intervals_high["phi"]
nls.param.df[nls.param.df$Code == "313",]$A.97.5 <- intervals_high["A"]
nls.param.df[nls.param.df$Code == "313",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_313.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_313.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_313.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_313.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals
```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_313 <- nlsResiduals(
  get(paste("nls_313.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_313)

## test residuals
if(length(P_313$pltID) < 5001) {test.nlsResiduals(resid_313)}

}  else {print("cannot plot residuals")}
```

## predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## predict model fit 
P_313_pred <- predict(get(paste("nls_313.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME" = rep(mean(P_313$MEASTIME, na.rm = T), max(P_313$STDAGE)),
                                   "STDAGE" = seq(1, max(P_313$STDAGE), by = 1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME" = rep(mean(P_313$MEASTIME, na.rm = T), max(P_313$STDAGE)),
                                   "STDAGE" = seq(1, max(P_313$STDAGE), by = 1),
                                   "DeltaPDSI" = rep(mean(P_313$DeltaPDSI, na.rm = T), max(P_313$STDAGE)))
                      } )

P_313_pred_df <- data.frame("STDAGE"=seq(1,max(P_313$STDAGE),by = 1),  
                            "fitted"=P_313_pred)

## plot
gg.313 <- ggplot() +
          geom_point(aes(x = STDAGE, y = BIO_MgHa), data = P_313, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE, y = BIO_MgHa), data = P_313, 
                            fun.data = function(x) {
                              res <- quantile(x, probs = c(0.25,0.5,0.75))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_313))), breaks = cutvec_313) +  
          
          #geom_ribbon(aes(x = STDAGE, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = P_313_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE, y = fitted), data = P_313_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("313 - Colorado Plateau Semi-Desert") + 
          
          #ylim(0, max(P_313_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, cutvec_313[20]*1.05), expand = c(0,0))


gg.313

}  else {print("cannot plot data with prediction")}
```


## plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_313 <- data.frame(
  bin = as.factor(levels(cut(P_313$STDAGE, cutvec_313))),
  data.mean = tapply(P_313$BIO_MgHa, cut(P_313$STDAGE, cutvec_313), 
                     mean, na.rm = T), 
  data.CI.high =  tapply(P_313$BIO_MgHa, cut(P_313$STDAGE, cutvec_313), 
                    high.CI), 
  data.CI.low = tapply(P_313$BIO_MgHa, cut(P_313$STDAGE, cutvec_313),
                    low.CI), 
  pred.mean = P_313_pred_df[P_313_pred_df$STDAGE %in% bin_mids_313,]$fitted) 
  # pred.CI.high = tapply(`313_CI_df`$fitted, cut(`313_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_313$STDAGE, g=20))),
  #                      high.CI), 
  # pred.CI.low = tapply(`313_CI_df`$fitted, cut(`313_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_313$STDAGE, g=20))),
  #                      low.CI))

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_313 <-  DM_compare_313 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_313$bin)[gtools::mixedorder(levels(DM_compare_313$bin))]))

## ggplot
gg.313.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_313) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_313))), 
                              labels = levels(DM_compare_313$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("313 -  Colorado Plateau Semi-Desert") +         
           theme_classic() + 
           # xlim(min(DM_compare_313$data.CI.low)-0.25, max(DM_compare_313$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_313$pred.CI.low)-0.25, max(DM_compare_313$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.313.B2

}   else {print("cannot plot observed vs. predicted")}
```

# 315 - Southwest Plateau and Plains Dry Steppe and Shrub
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_315 <- round(quantile(P_315$STDAGE, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_315)))){
  cutvec_315 <- round(quantile(P_315$STDAGE, seq(0,1, length.out = 11)))
}

bin_mids_315 <- unname(round(cutvec_315[-length(cutvec_315)] + diff(cutvec_315)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
P_315$STDAGE_bin<-  cut(P_315$STDAGE, cutvec_315)
## then get bin means
P_315_bin_means <- tapply(P_315$BIO_MgHa, cut(P_315$STDAGE, cutvec_315), mean)

## make column weights.2
P_315$nls_weights.2 <- as.numeric(1/(P_315_bin_means[match(P_315$STDAGE_bin, names(P_315_bin_means))])^2)

}
```

## model selection 1

```{r}
# simple
try(
  nls_315.1 <- nls(f_1, data = P_315, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = P_315$nls_weights.2), 
 )

## phi
try(
  nls_315.2 <- nls(f_2, data=P_315, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = P_315$nls_weights.2), 
 )

## test
if(exists("nls_315.1") & exists("nls_315.2")){
  print(anova(nls_315.1, nls_315.2))
}
 
## AIC comparison
AIC1_315 <- data.frame(model = c(1,2), AIC = c(
            ifelse(exists("nls_315.1"), AIC(get("nls_315.1")), NA),
            ifelse(exists("nls_315.2"), AIC(get("nls_315.2")), NA)
            ))

print(AIC1_315) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_315[!is.na(AIC1_315$AIC) & AIC1_315$AIC == min(AIC1_315$AIC, na.rm = T),]$model

try(summary(get(paste("nls_315.",  Mod.Sel1, sep =""))) )  #model summary
```
### summary 
* simple model: `r ifelse(exists("nls_315.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_315.2"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_315.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_315.",  Mod.Sel1, sep ="")))["phi"], 1)
A.fit <- round(coef(get(paste("nls_315.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_315.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_315.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = P_315,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              }, 
          weights = P_315$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_315.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = P_315,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              },
          weights = P_315$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_315.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = P_315,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              }, 
          weights = P_315$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_315.", Mod.Sel1, sep ="")) &
     exists(paste("nls_315.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_315.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_315.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_315.", Mod.Sel1, sep ="")),
             get(paste("nls_315.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_315.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_315.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_315.", Mod.Sel1, sep ="")) &
         exists(paste("nls_315.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_315.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_315.", Mod.Sel1, sep ="")),
               get(paste("nls_315.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_315.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_315.", Mod.Sel1, sep ="")) &
           exists(paste("nls_315.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_315.", Mod.Sel1, sep ="")),
                 get(paste("nls_315.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_315.", Mod.Sel1, sep ="")) &
              exists(paste("nls_315.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_315.", Mod.Sel1, sep ="")),
                    get(paste("nls_315.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_315.", Mod.Sel1, sep ="")) &
                exists(paste("nls_315.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_315.", Mod.Sel1, sep ="")),
                      get(paste("nls_315.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_315 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_315.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_315.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_315.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_315.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_315.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_315.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_315.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_315.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_315)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_315[!is.na(AIC2_315$AIC) & AIC2_315$AIC == min(AIC2_315$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P[Best_mods.P$Code == "315",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_315.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_315.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df[nls.param.df$Code == "315",]$ge <- coefs["ge"]
nls.param.df[nls.param.df$Code == "315",]$phi <- coefs["phi"]
nls.param.df[nls.param.df$Code == "315",]$A <- coefs["A"]
nls.param.df[nls.param.df$Code == "315",]$k <- coefs["k"]

nls.param.df[nls.param.df$Code == "315",]$ge.2.5 <- intervals_low["ge"]
nls.param.df[nls.param.df$Code == "315",]$phi.2.5 <- intervals_low["phi"]
nls.param.df[nls.param.df$Code == "315",]$A.2.5 <- intervals_low["A"]
nls.param.df[nls.param.df$Code == "315",]$k.2.5 <- intervals_low["k"]

nls.param.df[nls.param.df$Code == "315",]$ge.97.5 <- intervals_high["ge"]
nls.param.df[nls.param.df$Code == "315",]$phi.97.5 <- intervals_high["phi"]
nls.param.df[nls.param.df$Code == "315",]$A.97.5 <- intervals_high["A"]
nls.param.df[nls.param.df$Code == "315",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_315.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_315.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_315.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_315.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals
```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_315 <- nlsResiduals(
  get(paste("nls_315.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_315)

## test residuals
if(length(P_315$pltID) < 5001) {test.nlsResiduals(resid_315)}

}  else {print("cannot plot residuals")}
```

## predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

P_315_pred <- predict(get(paste("nls_315.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME" = rep(mean(P_315$MEASTIME, na.rm = T), max(P_315$STDAGE)),
                                   "STDAGE" = seq(1, max(P_315$STDAGE), by = 1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME" = rep(mean(P_315$MEASTIME, na.rm = T), max(P_315$STDAGE)),
                                   "STDAGE" = seq(1, max(P_315$STDAGE), by = 1),
                                   "DeltaPDSI" = rep(mean(P_315$DeltaPDSI, na.rm = T), max(P_315$STDAGE)))
                      } )

P_315_pred_df <- data.frame("STDAGE"=seq(1,max(P_315$STDAGE),by = 1),  
                            "fitted"=P_315_pred)

## plot
gg.315 <- ggplot() +
          geom_point(aes(x = STDAGE, y = BIO_MgHa), data = P_315, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE, y = BIO_MgHa), data = P_315, 
                            fun.data = function(x) {
                              res <- quantile(x, probs = c(0.25,0.5,0.75))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_315))), breaks = cutvec_315) +  
          
          #geom_ribbon(aes(x = STDAGE, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = P_315_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE, y = fitted), data = P_315_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("315 -  Southwest Plateau and Plains Dry Steppe and Shrub") + 
          
          #ylim(0, max(P_315_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, cutvec_315[20]*1.05), expand = c(0,0))

gg.315

}  else {print("cannot plot data with prediction")}
```


## plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_315 <- data.frame(
  bin = as.factor(levels(cut(P_315$STDAGE, cutvec_315))),
  data.mean = tapply(P_315$BIO_MgHa, cut(P_315$STDAGE, cutvec_315), 
                     mean, na.rm = T), 
  data.CI.high =  tapply(P_315$BIO_MgHa, cut(P_315$STDAGE, cutvec_315), 
                    high.CI), 
  data.CI.low = tapply(P_315$BIO_MgHa, cut(P_315$STDAGE, cutvec_315),
                    low.CI), 
  pred.mean = P_315_pred_df[P_315_pred_df$STDAGE %in% bin_mids_315,]$fitted) 
  # pred.CI.high = tapply(`315_CI_df`$fitted, cut(`315_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_315$STDAGE, g=20))),
  #                      high.CI), 
  # pred.CI.low = tapply(`315_CI_df`$fitted, cut(`315_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_315$STDAGE, g=20))),
  #                      low.CI))

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_315 <-  DM_compare_315 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_315$bin)[gtools::mixedorder(levels(DM_compare_315$bin))]))

## ggplot
gg.315.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_315) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_315))), 
                              labels = levels(DM_compare_315$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("315 -  Southwest Plateau and Plains Dry Steppe and Shrub") +         
           theme_classic() + 
           # xlim(min(DM_compare_315$data.CI.low)-0.25, max(DM_compare_315$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_315$pred.CI.low)-0.25, max(DM_compare_315$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.315.B2

}   else {print("cannot plot observed vs. predicted")}
```

# 321 - Chihuahuan Semi-Desert
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_321 <- round(quantile(P_321$STDAGE, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_321)))){
  cutvec_321 <- round(quantile(P_321$STDAGE, seq(0,1, length.out = 11)))
}

bin_mids_321 <- unname(round(cutvec_321[-length(cutvec_321)] + diff(cutvec_321)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
P_321$STDAGE_bin<-  cut(P_321$STDAGE, cutvec_321)
## then get bin means
P_321_bin_means <- tapply(P_321$BIO_MgHa, cut(P_321$STDAGE, cutvec_321), mean)

## make column weights.2
P_321$nls_weights.2 <- as.numeric(1/(P_321_bin_means[match(P_321$STDAGE_bin, names(P_321_bin_means))])^2)

}
```

## model selection 1

```{r}
# simple
try(
  nls_321.1 <- nls(f_1, data = P_321, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = P_321$nls_weights.2), 
 )

## phi
try(
  nls_321.2 <- nls(f_2, data=P_321, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = P_321$nls_weights.2), 
 )

## test
if(exists("nls_321.1") & exists("nls_321.2")){
  print(anova(nls_321.1, nls_321.2))
}
 
## AIC comparison
AIC1_321 <- data.frame(model = c(1,2), AIC = c(
            ifelse(exists("nls_321.1"), AIC(get("nls_321.1")), NA),
            ifelse(exists("nls_321.2"), AIC(get("nls_321.2")), NA)
            ))

print(AIC1_321) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_321[!is.na(AIC1_321$AIC) & AIC1_321$AIC == min(AIC1_321$AIC, na.rm = T),]$model

try(summary(get(paste("nls_321.",  Mod.Sel1, sep =""))) )  #model summary
```
### summary 
* simple model: `r ifelse(exists("nls_321.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_321.2"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_321.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_321.",  Mod.Sel1, sep ="")))["phi"], 1)
A.fit <- round(coef(get(paste("nls_321.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_321.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_321.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = P_321,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              }, 
          weights = P_321$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_321.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = P_321,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              },
          weights = P_321$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_321.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = P_321,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              }, 
          weights = P_321$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_321.", Mod.Sel1, sep ="")) &
     exists(paste("nls_321.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_321.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_321.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_321.", Mod.Sel1, sep ="")),
             get(paste("nls_321.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_321.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_321.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_321.", Mod.Sel1, sep ="")) &
         exists(paste("nls_321.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_321.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_321.", Mod.Sel1, sep ="")),
               get(paste("nls_321.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_321.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_321.", Mod.Sel1, sep ="")) &
           exists(paste("nls_321.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_321.", Mod.Sel1, sep ="")),
                 get(paste("nls_321.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_321.", Mod.Sel1, sep ="")) &
              exists(paste("nls_321.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_321.", Mod.Sel1, sep ="")),
                    get(paste("nls_321.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_321.", Mod.Sel1, sep ="")) &
                exists(paste("nls_321.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_321.", Mod.Sel1, sep ="")),
                      get(paste("nls_321.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_321 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_321.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_321.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_321.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_321.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_321.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_321.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_321.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_321.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_321)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_321[!is.na(AIC2_321$AIC) & AIC2_321$AIC == min(AIC2_321$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P[Best_mods.P$Code == "321",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_321.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_321.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df[nls.param.df$Code == "321",]$ge <- coefs["ge"]
nls.param.df[nls.param.df$Code == "321",]$phi <- coefs["phi"]
nls.param.df[nls.param.df$Code == "321",]$A <- coefs["A"]
nls.param.df[nls.param.df$Code == "321",]$k <- coefs["k"]

nls.param.df[nls.param.df$Code == "321",]$ge.2.5 <- intervals_low["ge"]
nls.param.df[nls.param.df$Code == "321",]$phi.2.5 <- intervals_low["phi"]
nls.param.df[nls.param.df$Code == "321",]$A.2.5 <- intervals_low["A"]
nls.param.df[nls.param.df$Code == "321",]$k.2.5 <- intervals_low["k"]

nls.param.df[nls.param.df$Code == "321",]$ge.97.5 <- intervals_high["ge"]
nls.param.df[nls.param.df$Code == "321",]$phi.97.5 <- intervals_high["phi"]
nls.param.df[nls.param.df$Code == "321",]$A.97.5 <- intervals_high["A"]
nls.param.df[nls.param.df$Code == "321",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_321.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_321.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_321.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_321.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals
```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_321 <- nlsResiduals(
  get(paste("nls_321.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_321)

## test residuals
if(length(P_321$pltID) < 5001) {test.nlsResiduals(resid_321)}

}  else {print("cannot plot residuals")}
```

## predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

P_321_pred <- predict(get(paste("nls_321.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME" = rep(mean(P_321$MEASTIME, na.rm = T), max(P_321$STDAGE)),
                                   "STDAGE" = seq(1, max(P_321$STDAGE), by = 1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME" = rep(mean(P_321$MEASTIME, na.rm = T), max(P_321$STDAGE)),
                                   "STDAGE" = seq(1, max(P_321$STDAGE), by = 1),
                                   "DeltaPDSI" = rep(mean(P_321$DeltaPDSI, na.rm = T), max(P_321$STDAGE)))
                      } )

P_321_pred_df <- data.frame("STDAGE"=seq(1,max(P_321$STDAGE),by = 1),  
                            "fitted"=P_321_pred)

## plot
gg.321 <- ggplot() +
          geom_point(aes(x = STDAGE, y = BIO_MgHa), data = P_321, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE, y = BIO_MgHa), data = P_321, 
                            fun.data = function(x) {
                              res <- quantile(x, probs = c(0.25,0.5,0.75))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_321)-3)), breaks = cutvec_321) +  
          
          #geom_ribbon(aes(x = STDAGE, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = P_321_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE, y = fitted), data = P_321_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("321 - Chihuahuan Semi-Desert") + 
          
          #ylim(0, max(P_321_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, cutvec_321[20]*1.05), expand = c(0,0))

gg.321

}  else {print("cannot plot data with prediction")}
```


## plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_321 <- data.frame(
  bin = as.factor(levels(cut(P_321$STDAGE, cutvec_321))),
  data.mean = tapply(P_321$BIO_MgHa, cut(P_321$STDAGE, cutvec_321), 
                     mean, na.rm = T), 
  data.CI.high =  tapply(P_321$BIO_MgHa, cut(P_321$STDAGE, cutvec_321), 
                    high.CI), 
  data.CI.low = tapply(P_321$BIO_MgHa, cut(P_321$STDAGE, cutvec_321),
                    low.CI), 
  pred.mean = P_321_pred_df[P_321_pred_df$STDAGE %in% bin_mids_321,]$fitted) 
  # pred.CI.high = tapply(`321_CI_df`$fitted, cut(`321_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_321$STDAGE, g=20))),
  #                      high.CI), 
  # pred.CI.low = tapply(`321_CI_df`$fitted, cut(`321_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_321$STDAGE, g=20))),
  #                      low.CI))

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_321 <-  DM_compare_321 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_321$bin)[gtools::mixedorder(levels(DM_compare_321$bin))]))

## ggplot
gg.321.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_321) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_321))), 
                              labels = levels(DM_compare_321$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("321 - Chihuahuan Semi-Desert") +         
           theme_classic() + 
           # xlim(min(DM_compare_321$data.CI.low)-0.25, max(DM_compare_321$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_321$pred.CI.low)-0.25, max(DM_compare_321$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.321.B2

}   else {print("cannot plot observed vs. predicted")}
```

# 322 - American Semidesert and Desert
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_322 <- round(quantile(P_322$STDAGE, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_322)))){
  cutvec_322 <- round(quantile(P_322$STDAGE, seq(0,1, length.out = 11)))
}

bin_mids_322 <- unname(round(cutvec_322[-length(cutvec_322)] + diff(cutvec_322)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
P_322$STDAGE_bin<-  cut(P_322$STDAGE, cutvec_322)
## then get bin means
P_322_bin_means <- tapply(P_322$BIO_MgHa, cut(P_322$STDAGE, cutvec_322), mean)

## make column weights.2
P_322$nls_weights.2 <- as.numeric(1/(P_322_bin_means[match(P_322$STDAGE_bin, names(P_322_bin_means))])^2)

}
```

## model selection 1

```{r}
# simple
try(
  nls_322.1 <- nls(f_1, data = P_322, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = P_322$nls_weights.2), 
 )

## phi
try(
  nls_322.2 <- nls(f_2, data=P_322, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = P_322$nls_weights.2), 
 )

## test
if(exists("nls_322.1") & exists("nls_322.2")){
  print(anova(nls_322.1, nls_322.2))
}
 
## AIC comparison
AIC1_322 <- data.frame(model = c(1,2), AIC = c(
            ifelse(exists("nls_322.1"), AIC(get("nls_322.1")), NA),
            ifelse(exists("nls_322.2"), AIC(get("nls_322.2")), NA)
            ))

print(AIC1_322) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_322[!is.na(AIC1_322$AIC) & AIC1_322$AIC == min(AIC1_322$AIC, na.rm = T),]$model

try(summary(get(paste("nls_322.",  Mod.Sel1, sep =""))) )  #model summary
```
### summary 
* simple model: `r ifelse(exists("nls_322.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_322.2"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_322.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_322.",  Mod.Sel1, sep ="")))["phi"], 1)
A.fit <- round(coef(get(paste("nls_322.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_322.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_322.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = P_322,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              }, 
          weights = P_322$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_322.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = P_322,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              },
          weights = P_322$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_322.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = P_322,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              }, 
          weights = P_322$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_322.", Mod.Sel1, sep ="")) &
     exists(paste("nls_322.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_322.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_322.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_322.", Mod.Sel1, sep ="")),
             get(paste("nls_322.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_322.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_322.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_322.", Mod.Sel1, sep ="")) &
         exists(paste("nls_322.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_322.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_322.", Mod.Sel1, sep ="")),
               get(paste("nls_322.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_322.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_322.", Mod.Sel1, sep ="")) &
           exists(paste("nls_322.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_322.", Mod.Sel1, sep ="")),
                 get(paste("nls_322.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_322.", Mod.Sel1, sep ="")) &
              exists(paste("nls_322.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_322.", Mod.Sel1, sep ="")),
                    get(paste("nls_322.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_322.", Mod.Sel1, sep ="")) &
                exists(paste("nls_322.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_322.", Mod.Sel1, sep ="")),
                      get(paste("nls_322.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_322 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_322.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_322.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_322.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_322.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_322.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_322.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_322.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_322.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_322)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_322[!is.na(AIC2_322$AIC) & AIC2_322$AIC == min(AIC2_322$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P[Best_mods.P$Code == "322",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_322.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_322.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df[nls.param.df$Code == "322",]$ge <- coefs["ge"]
nls.param.df[nls.param.df$Code == "322",]$phi <- coefs["phi"]
nls.param.df[nls.param.df$Code == "322",]$A <- coefs["A"]
nls.param.df[nls.param.df$Code == "322",]$k <- coefs["k"]

nls.param.df[nls.param.df$Code == "322",]$ge.2.5 <- intervals_low["ge"]
nls.param.df[nls.param.df$Code == "322",]$phi.2.5 <- intervals_low["phi"]
nls.param.df[nls.param.df$Code == "322",]$A.2.5 <- intervals_low["A"]
nls.param.df[nls.param.df$Code == "322",]$k.2.5 <- intervals_low["k"]

nls.param.df[nls.param.df$Code == "322",]$ge.97.5 <- intervals_high["ge"]
nls.param.df[nls.param.df$Code == "322",]$phi.97.5 <- intervals_high["phi"]
nls.param.df[nls.param.df$Code == "322",]$A.97.5 <- intervals_high["A"]
nls.param.df[nls.param.df$Code == "322",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_322.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_322.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_322.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_322.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals
```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_322 <- nlsResiduals(
  get(paste("nls_322.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_322)

## test residuals
if(length(P_322$pltID) < 5001) {test.nlsResiduals(resid_322)}

}  else {print("cannot plot residuals")}
```

## predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

P_322_pred <- predict(get(paste("nls_322.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME" = rep(mean(P_322$MEASTIME, na.rm = T), max(P_322$STDAGE)),
                                   "STDAGE" = seq(1, max(P_322$STDAGE), by = 1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME" = rep(mean(P_322$MEASTIME, na.rm = T), max(P_322$STDAGE)),
                                   "STDAGE" = seq(1, max(P_322$STDAGE), by = 1),
                                   "DeltaPDSI" = rep(mean(P_322$DeltaPDSI, na.rm = T), max(P_322$STDAGE)))
                      } )

P_322_pred_df <- data.frame("STDAGE"=seq(1,max(P_322$STDAGE),by = 1),  
                            "fitted"=P_322_pred)

## plot
gg.322 <- ggplot() +
          geom_point(aes(x = STDAGE, y = BIO_MgHa), data = P_322, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE, y = BIO_MgHa), data = P_322, 
                            fun.data = function(x) {
                              res <- quantile(x, probs = c(0.25,0.5,0.75))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_322))), breaks = cutvec_322) +  
          
          #geom_ribbon(aes(x = STDAGE, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = P_322_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE, y = fitted), data = P_322_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("322 - American Semidesert and Desert") + 
          
          #ylim(0, max(P_322_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, cutvec_322[20]*1.05), expand = c(0,0))

gg.322

}  else {print("cannot plot data with prediction")}
```


## plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_322 <- data.frame(
  bin = as.factor(levels(cut(P_322$STDAGE, cutvec_322))),
  data.mean = tapply(P_322$BIO_MgHa, cut(P_322$STDAGE, cutvec_322), 
                     mean, na.rm = T), 
  data.CI.high =  tapply(P_322$BIO_MgHa, cut(P_322$STDAGE, cutvec_322), 
                    high.CI), 
  data.CI.low = tapply(P_322$BIO_MgHa, cut(P_322$STDAGE, cutvec_322),
                    low.CI), 
  pred.mean = P_322_pred_df[P_322_pred_df$STDAGE %in% bin_mids_322,]$fitted) 
  # pred.CI.high = tapply(`322_CI_df`$fitted, cut(`322_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_322$STDAGE, g=20))),
  #                      high.CI), 
  # pred.CI.low = tapply(`322_CI_df`$fitted, cut(`322_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_322$STDAGE, g=20))),
  #                      low.CI))

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_322 <-  DM_compare_322 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_322$bin)[gtools::mixedorder(levels(DM_compare_322$bin))]))

## ggplot
gg.322.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_322) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_322))), 
                              labels = levels(DM_compare_322$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("322 - American Semidesert and Desert") +         
           theme_classic() + 
           # xlim(min(DM_compare_322$data.CI.low)-0.25, max(DM_compare_322$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_322$pred.CI.low)-0.25, max(DM_compare_322$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.322.B2

}    else {print("cannot plot observed vs. predicted")}
```

* Cannot fit model 
* not enough data (only 3 observations)

# 331 - Great Plains/Palouse Dry Steppe
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_331 <- round(quantile(P_331$STDAGE, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_331)))){
  cutvec_331 <- round(quantile(P_331$STDAGE, seq(0,1, length.out = 11)))
}

bin_mids_331 <- unname(round(cutvec_331[-length(cutvec_331)] + diff(cutvec_331)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
P_331$STDAGE_bin<-  cut(P_331$STDAGE, cutvec_331)
## then get bin means
P_331_bin_means <- tapply(P_331$BIO_MgHa, cut(P_331$STDAGE, cutvec_331), mean)

## make column weights.2
P_331$nls_weights.2 <- as.numeric(1/(P_331_bin_means[match(P_331$STDAGE_bin, names(P_331_bin_means))])^2)

}
```

## model selection 1

```{r}
# simple
try(
  nls_331.1 <- nls(f_1, data = P_331, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = P_331$nls_weights.2), 
 )

## phi
try(
  nls_331.2 <- nls(f_2, data=P_331, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = P_331$nls_weights.2), 
 )

## test
if(exists("nls_331.1") & exists("nls_331.2")){
  print(anova(nls_331.1, nls_331.2))
}
 
## AIC comparison
AIC1_331 <- data.frame(model = c(1,2), AIC = c(
            ifelse(exists("nls_331.1"), AIC(get("nls_331.1")), NA),
            ifelse(exists("nls_331.2"), AIC(get("nls_331.2")), NA)
            ))

print(AIC1_331) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_331[!is.na(AIC1_331$AIC) & AIC1_331$AIC == min(AIC1_331$AIC, na.rm = T),]$model

try(summary(get(paste("nls_331.",  Mod.Sel1, sep =""))) )  #model summary
```
### summary 
* simple model: `r ifelse(exists("nls_331.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_331.2"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_331.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_331.",  Mod.Sel1, sep ="")))["phi"], 1)
A.fit <- round(coef(get(paste("nls_331.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_331.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_331.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = P_331,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              }, 
          weights = P_331$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_331.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = P_331,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              },
          weights = P_331$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_331.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = P_331,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              }, 
          weights = P_331$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_331.", Mod.Sel1, sep ="")) &
     exists(paste("nls_331.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_331.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_331.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_331.", Mod.Sel1, sep ="")),
             get(paste("nls_331.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_331.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_331.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_331.", Mod.Sel1, sep ="")) &
         exists(paste("nls_331.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_331.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_331.", Mod.Sel1, sep ="")),
               get(paste("nls_331.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_331.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_331.", Mod.Sel1, sep ="")) &
           exists(paste("nls_331.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_331.", Mod.Sel1, sep ="")),
                 get(paste("nls_331.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_331.", Mod.Sel1, sep ="")) &
              exists(paste("nls_331.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_331.", Mod.Sel1, sep ="")),
                    get(paste("nls_331.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_331.", Mod.Sel1, sep ="")) &
                exists(paste("nls_331.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_331.", Mod.Sel1, sep ="")),
                      get(paste("nls_331.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_331 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_331.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_331.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_331.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_331.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_331.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_331.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_331.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_331.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_331)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_331[!is.na(AIC2_331$AIC) & AIC2_331$AIC == min(AIC2_331$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P[Best_mods.P$Code == "331",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_331.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_331.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df[nls.param.df$Code == "331",]$ge <- coefs["ge"]
nls.param.df[nls.param.df$Code == "331",]$phi <- coefs["phi"]
nls.param.df[nls.param.df$Code == "331",]$A <- coefs["A"]
nls.param.df[nls.param.df$Code == "331",]$k <- coefs["k"]

nls.param.df[nls.param.df$Code == "331",]$ge.2.5 <- intervals_low["ge"]
nls.param.df[nls.param.df$Code == "331",]$phi.2.5 <- intervals_low["phi"]
nls.param.df[nls.param.df$Code == "331",]$A.2.5 <- intervals_low["A"]
nls.param.df[nls.param.df$Code == "331",]$k.2.5 <- intervals_low["k"]

nls.param.df[nls.param.df$Code == "331",]$ge.97.5 <- intervals_high["ge"]
nls.param.df[nls.param.df$Code == "331",]$phi.97.5 <- intervals_high["phi"]
nls.param.df[nls.param.df$Code == "331",]$A.97.5 <- intervals_high["A"]
nls.param.df[nls.param.df$Code == "331",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_331.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_331.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_331.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_331.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals
```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_331 <- nlsResiduals(
  get(paste("nls_331.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_331)

## test residuals
if(length(P_331$pltID) < 5001) {test.nlsResiduals(resid_331)}

}  else {print("cannot plot residuals")}
```

## predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

P_331_pred <- predict(get(paste("nls_331.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME" = rep(mean(P_331$MEASTIME, na.rm = T), max(P_331$STDAGE)),
                                   "STDAGE" = seq(1, max(P_331$STDAGE), by = 1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME" = rep(mean(P_331$MEASTIME, na.rm = T), max(P_331$STDAGE)),
                                   "STDAGE" = seq(1, max(P_331$STDAGE), by = 1),
                                   "DeltaPDSI" = rep(mean(P_331$DeltaPDSI, na.rm = T), max(P_331$STDAGE)))
                      } )

P_331_pred_df <- data.frame("STDAGE"=seq(1,max(P_331$STDAGE),by = 1),  
                            "fitted"=P_331_pred)

## plot
gg.331 <- ggplot() +
          geom_point(aes(x = STDAGE, y = BIO_MgHa), data = P_331, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE, y = BIO_MgHa), data = P_331, 
                            fun.data = function(x) {
                              res <- quantile(x, probs = c(0.25,0.5,0.75))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_331))), breaks = cutvec_331) +  
          
          #geom_ribbon(aes(x = STDAGE, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = P_331_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE, y = fitted), data = P_331_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("331 - Great Plains/Palouse Dry Steppe") + 
          
          #ylim(0, max(P_331_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, cutvec_331[20]*1.05), expand = c(0,0))

gg.331

}  else {print("cannot plot data with prediction")}
```


## plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_331 <- data.frame(
  bin = as.factor(levels(cut(P_331$STDAGE, cutvec_331))),
  data.mean = tapply(P_331$BIO_MgHa, cut(P_331$STDAGE, cutvec_331), 
                     mean, na.rm = T), 
  data.CI.high =  tapply(P_331$BIO_MgHa, cut(P_331$STDAGE, cutvec_331), 
                    high.CI), 
  data.CI.low = tapply(P_331$BIO_MgHa, cut(P_331$STDAGE, cutvec_331),
                    low.CI), 
  pred.mean = P_331_pred_df[P_331_pred_df$STDAGE %in% bin_mids_331,]$fitted) 
  # pred.CI.high = tapply(`331_CI_df`$fitted, cut(`331_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_331$STDAGE, g=20))),
  #                      high.CI), 
  # pred.CI.low = tapply(`331_CI_df`$fitted, cut(`331_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_331$STDAGE, g=20))),
  #                      low.CI))

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_331 <-  DM_compare_331 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_331$bin)[gtools::mixedorder(levels(DM_compare_331$bin))]))

## ggplot
gg.331.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_331) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_331))), 
                              labels = levels(DM_compare_331$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("331 - Great Plains/Palouse Dry Steppe") +         
           theme_classic() + 
           # xlim(min(DM_compare_331$data.CI.low)-0.25, max(DM_compare_331$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_331$pred.CI.low)-0.25, max(DM_compare_331$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.331.B2

}    else {print("cannot plot observed vs. predicted")}
```
* Cannot fit model 

# 332 - Great Plains Steppe
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_332 <- round(quantile(P_332$STDAGE, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_332)))){
  cutvec_332 <- round(quantile(P_332$STDAGE, seq(0,1, length.out = 11)))
}

bin_mids_332 <- unname(round(cutvec_332[-length(cutvec_332)] + diff(cutvec_332)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
P_332$STDAGE_bin<-  cut(P_332$STDAGE, cutvec_332)
## then get bin means
P_332_bin_means <- tapply(P_332$BIO_MgHa, cut(P_332$STDAGE,  cutvec_332), mean)

## make column weights.2
P_332$nls_weights.2 <- as.numeric(1/(P_332_bin_means[match(P_332$STDAGE_bin, names(P_332_bin_means))])^2)

}
```

## model selection 1

```{r}
# simple
try(
  nls_332.1 <- nls(f_1, data = P_332, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = P_332$nls_weights.2), 
 )

## phi
try(
  nls_332.2 <- nls(f_2, data=P_332, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = P_332$nls_weights.2), 
 )

## test
if(exists("nls_332.1") & exists("nls_332.2")){
  print(anova(nls_332.1, nls_332.2))
}
 
## AIC comparison
AIC1_332 <- data.frame(model = c(1,2), AIC = c(
            ifelse(exists("nls_332.1"), AIC(get("nls_332.1")), NA),
            ifelse(exists("nls_332.2"), AIC(get("nls_332.2")), NA)
            ))

print(AIC1_332) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_332[!is.na(AIC1_332$AIC) & AIC1_332$AIC == min(AIC1_332$AIC, na.rm = T),]$model

try(summary(get(paste("nls_332.",  Mod.Sel1, sep =""))) )  #model summary
```
### summary 
* simple model: `r ifelse(exists("nls_332.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_332.2"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_332.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_332.",  Mod.Sel1, sep ="")))["phi"], 1)
A.fit <- round(coef(get(paste("nls_332.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_332.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_332.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = P_332,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              }, 
          weights = P_332$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_332.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = P_332,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              },
          weights = P_332$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_332.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = P_332,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              }, 
          weights = P_332$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_332.", Mod.Sel1, sep ="")) &
     exists(paste("nls_332.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_332.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_332.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_332.", Mod.Sel1, sep ="")),
             get(paste("nls_332.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_332.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_332.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_332.", Mod.Sel1, sep ="")) &
         exists(paste("nls_332.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_332.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_332.", Mod.Sel1, sep ="")),
               get(paste("nls_332.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_332.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_332.", Mod.Sel1, sep ="")) &
           exists(paste("nls_332.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_332.", Mod.Sel1, sep ="")),
                 get(paste("nls_332.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_332.", Mod.Sel1, sep ="")) &
              exists(paste("nls_332.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_332.", Mod.Sel1, sep ="")),
                    get(paste("nls_332.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_332.", Mod.Sel1, sep ="")) &
                exists(paste("nls_332.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_332.", Mod.Sel1, sep ="")),
                      get(paste("nls_332.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_332 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_332.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_332.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_332.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_332.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_332.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_332.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_332.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_332.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_332)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_332[!is.na(AIC2_332$AIC) & AIC2_332$AIC == min(AIC2_332$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P[Best_mods.P$Code == "332",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_332.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_332.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df[nls.param.df$Code == "332",]$ge <- coefs["ge"]
nls.param.df[nls.param.df$Code == "332",]$phi <- coefs["phi"]
nls.param.df[nls.param.df$Code == "332",]$A <- coefs["A"]
nls.param.df[nls.param.df$Code == "332",]$k <- coefs["k"]

nls.param.df[nls.param.df$Code == "332",]$ge.2.5 <- intervals_low["ge"]
nls.param.df[nls.param.df$Code == "332",]$phi.2.5 <- intervals_low["phi"]
nls.param.df[nls.param.df$Code == "332",]$A.2.5 <- intervals_low["A"]
nls.param.df[nls.param.df$Code == "332",]$k.2.5 <- intervals_low["k"]

nls.param.df[nls.param.df$Code == "332",]$ge.97.5 <- intervals_high["ge"]
nls.param.df[nls.param.df$Code == "332",]$phi.97.5 <- intervals_high["phi"]
nls.param.df[nls.param.df$Code == "332",]$A.97.5 <- intervals_high["A"]
nls.param.df[nls.param.df$Code == "332",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_332.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_332.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_332.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_332.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals
```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_332 <- nlsResiduals(
  get(paste("nls_332.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_332)

## test residuals
if(length(P_332$pltID) < 5001) {test.nlsResiduals(resid_332)}

}  else {print("cannot plot residuals")}
```


## predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

P_332_pred <- predict(get(paste("nls_332.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME" = rep(mean(P_332$MEASTIME, na.rm = T), max(P_332$STDAGE)),
                                   "STDAGE" = seq(1, max(P_332$STDAGE), by = 1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME" = rep(mean(P_332$MEASTIME, na.rm = T), max(P_332$STDAGE)),
                                   "STDAGE" = seq(1, max(P_332$STDAGE), by = 1),
                                   "DeltaPDSI" = rep(mean(P_332$DeltaPDSI, na.rm = T), max(P_332$STDAGE)))
                      } )

P_332_pred_df <- data.frame("STDAGE"=seq(1,max(P_332$STDAGE),by = 1),  
                            "fitted"=P_332_pred)

## plot
gg.332 <- ggplot() +
          geom_point(aes(x = STDAGE, y = BIO_MgHa), data = P_332, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE, y = BIO_MgHa), data = P_332, 
                            fun.data = function(x) {
                              res <- quantile(x, probs = c(0.25,0.5,0.75))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_332))), breaks = cutvec_332) +  
          
          #geom_ribbon(aes(x = STDAGE, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = P_332_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE, y = fitted), data = P_332_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("332 - Southwest Plateau and Plains Dry Steppe and Shrub") + 
          
          #ylim(0, max(P_332_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, cutvec_332[20]*1.05), expand = c(0,0))

gg.332

}  else {print("cannot plot data with prediction")}
```


## plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_332 <- data.frame(
  bin = as.factor(levels(cut(P_332$STDAGE, cutvec_332))),
  data.mean = tapply(P_332$BIO_MgHa, cut(P_332$STDAGE, cutvec_332), 
                     mean, na.rm = T), 
  data.CI.high =  tapply(P_332$BIO_MgHa, cut(P_332$STDAGE, cutvec_332), 
                    high.CI), 
  data.CI.low = tapply(P_332$BIO_MgHa, cut(P_332$STDAGE, cutvec_332),
                    low.CI), 
  pred.mean = P_332_pred_df[P_332_pred_df$STDAGE %in% bin_mids_332,]$fitted) 
  # pred.CI.high = tapply(`332_CI_df`$fitted, cut(`332_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_332$STDAGE, g=20))),
  #                      high.CI), 
  # pred.CI.low = tapply(`332_CI_df`$fitted, cut(`332_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_332$STDAGE, g=20))),
  #                      low.CI))

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_332 <-  DM_compare_332 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_332$bin)[gtools::mixedorder(levels(DM_compare_332$bin))]))

## ggplot
gg.332.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_332) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_332))), 
                              labels = levels(DM_compare_332$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("332 - Southwest Plateau and Plains Dry Steppe and Shrub") +         
           theme_classic() + 
           # xlim(min(DM_compare_332$data.CI.low)-0.25, max(DM_compare_332$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_332$pred.CI.low)-0.25, max(DM_compare_332$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.332.B2

}    else {print("cannot plot observed vs. predicted")}
```

# 341 - Nevada-Utah Mountains Semi-Desert - Coniferous Forest - Alpine Meadow
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_341 <- round(quantile(P_341$STDAGE, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_341)))){
  cutvec_341 <- round(quantile(P_341$STDAGE, seq(0,1, length.out = 11)))
}

bin_mids_341 <- unname(round(cutvec_341[-length(cutvec_341)] + diff(cutvec_341)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
P_341$STDAGE_bin<-  cut(P_341$STDAGE, cutvec_341)
## then get bin means
P_341_bin_means <- tapply(P_341$BIO_MgHa, cut(P_341$STDAGE,  cutvec_341), mean)

## make column weights.2
P_341$nls_weights.2 <- as.numeric(1/(P_341_bin_means[match(P_341$STDAGE_bin, names(P_341_bin_means))])^2)

}
```

## model selection 1

```{r}
# simple
try(
  nls_341.1 <- nls(f_1, data = P_341, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = P_341$nls_weights.2), 
 )

## phi
try(
  nls_341.2 <- nls(f_2, data=P_341, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = P_341$nls_weights.2), 
 )

## test
if(exists("nls_341.1") & exists("nls_341.2")){
  print(anova(nls_341.1, nls_341.2))
}
 
## AIC comparison
AIC1_341 <- data.frame(model = c(1,2), AIC = c(
            ifelse(exists("nls_341.1"), AIC(get("nls_341.1")), NA),
            ifelse(exists("nls_341.2"), AIC(get("nls_341.2")), NA)
            ))

print(AIC1_341) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_341[!is.na(AIC1_341$AIC) & AIC1_341$AIC == min(AIC1_341$AIC, na.rm = T),]$model

try(summary(get(paste("nls_341.",  Mod.Sel1, sep =""))) )  #model summary
```
### summary 
* simple model: `r ifelse(exists("nls_341.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_341.2"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_341.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_341.",  Mod.Sel1, sep ="")))["phi"], 1)
A.fit <- round(coef(get(paste("nls_341.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_341.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_341.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = P_341,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              }, 
          weights = P_341$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_341.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = P_341,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              },
          weights = P_341$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_341.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = P_341,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              }, 
          weights = P_341$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_341.", Mod.Sel1, sep ="")) &
     exists(paste("nls_341.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_341.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_341.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_341.", Mod.Sel1, sep ="")),
             get(paste("nls_341.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_341.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_341.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_341.", Mod.Sel1, sep ="")) &
         exists(paste("nls_341.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_341.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_341.", Mod.Sel1, sep ="")),
               get(paste("nls_341.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_341.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_341.", Mod.Sel1, sep ="")) &
           exists(paste("nls_341.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_341.", Mod.Sel1, sep ="")),
                 get(paste("nls_341.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_341.", Mod.Sel1, sep ="")) &
              exists(paste("nls_341.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_341.", Mod.Sel1, sep ="")),
                    get(paste("nls_341.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_341.", Mod.Sel1, sep ="")) &
                exists(paste("nls_341.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_341.", Mod.Sel1, sep ="")),
                      get(paste("nls_341.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_341 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_341.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_341.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_341.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_341.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_341.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_341.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_341.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_341.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_341)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_341[!is.na(AIC2_341$AIC) & AIC2_341$AIC == min(AIC2_341$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P[Best_mods.P$Code == "341",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_341.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_341.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df[nls.param.df$Code == "341",]$ge <- coefs["ge"]
nls.param.df[nls.param.df$Code == "341",]$phi <- coefs["phi"]
nls.param.df[nls.param.df$Code == "341",]$A <- coefs["A"]
nls.param.df[nls.param.df$Code == "341",]$k <- coefs["k"]

nls.param.df[nls.param.df$Code == "341",]$ge.2.5 <- intervals_low["ge"]
nls.param.df[nls.param.df$Code == "341",]$phi.2.5 <- intervals_low["phi"]
nls.param.df[nls.param.df$Code == "341",]$A.2.5 <- intervals_low["A"]
nls.param.df[nls.param.df$Code == "341",]$k.2.5 <- intervals_low["k"]

nls.param.df[nls.param.df$Code == "341",]$ge.97.5 <- intervals_high["ge"]
nls.param.df[nls.param.df$Code == "341",]$phi.97.5 <- intervals_high["phi"]
nls.param.df[nls.param.df$Code == "341",]$A.97.5 <- intervals_high["A"]
nls.param.df[nls.param.df$Code == "341",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_341.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_341.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_341.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_341.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals
```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) { 

## calculate residuals
resid_341 <- nlsResiduals(
  get(paste("nls_341.",  Mod.Sel2, sep =""))
  )

## plot residuals  
plot(resid_341)

## test residuals
if(length(P_341$pltID) < 5001) {test.nlsResiduals(resid_341)}

}  else {print("cannot plot residuals")}
```

## predict and plot 

```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & fit.models == T) { 

## predict model fit
P_341_pred  <- predict(get(paste("nls_341.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME" = rep(mean(P_341$MEASTIME, na.rm = T), max(P_341$STDAGE)),
                                   "STDAGE" = seq(1, max(P_341$STDAGE), by = 1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME" = rep(mean(P_341$MEASTIME, na.rm = T), max(P_341$STDAGE)),
                                   "STDAGE" = seq(1, max(P_341$STDAGE), by = 1),
                                   "DeltaPDSI" = rep(mean(P_341$DeltaPDSI, na.rm = T), max(P_341$STDAGE)))
                      } )

P_341_pred_df <- data.frame("STDAGE"=seq(1,max(P_341$STDAGE),by = 1),
                            "fitted"=P_341_pred)

## plot
gg.341 <- ggplot() +
          geom_point(aes(x = STDAGE, y = BIO_MgHa), data = P_341, alpha = 0.5, shape ="+", col = "#60606080") +

          stat_summary_bin(aes(x = STDAGE, y = BIO_MgHa), data = P_341,
                            fun.data = function(x) {
                              res <- quantile(x, probs = c(0.25,0.5,0.75))
                              names(res) <- c("ymin","y","ymax")
                              res},
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_341))), breaks = cutvec_341) +

          #geom_ribbon(aes(x = STDAGE, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`),
                      #data = P_341_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +

          geom_line(aes(x = STDAGE, y = fitted), data = P_341_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) +


          theme_classic() +
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"),
               x = "Stand Age (yrs)") +  ggtitle("341 - Nevada-Utah Mountains Semi-Desert - Coniferous Forest - Alpine Meadow") +

          #ylim(0, max(P_341_pred_df$`Prop.97.5%` + 0.25)) +
          scale_x_continuous(limits = c(0, max(P_341$STDAGE)), expand = c(0,0))

gg.341

}    else {print("cannot plot data with prediction")}
```

## plotting 2

```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & fit.models == T) {

## data wrangling:
DM_compare_341 <- data.frame(
  bin = as.factor(levels(cut(P_341$STDAGE, cutvec_341))),
  data.mean = tapply(P_341$BIO_MgHa, cut(P_341$STDAGE, cutvec_341),
                     mean, na.rm = T),
  data.CI.high =  tapply(P_341$BIO_MgHa, cut(P_341$STDAGE, cutvec_341),
                    high.CI),
  data.CI.low = tapply(P_341$BIO_MgHa, cut(P_341$STDAGE, cutvec_341),
                    low.CI),
  pred.mean = P_341_pred_df[P_341_pred_df$STDAGE %in% bin_mids_341,]$fitted)
  # pred.CI.high = tapply(`341_CI_df`$fitted, cut(`341_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_341$STDAGE, g=20))),  
  #                      high.CI),
  # pred.CI.low = tapply(`341_CI_df`$fitted, cut(`341_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_341$STDAGE, g=20))),
  #                      low.CI))

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY
DM_compare_341 <-  DM_compare_341 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_341$bin)[gtools::mixedorder(levels(DM_compare_341$bin))]))

## ggplot
gg.341.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_341) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_341))),
                              labels = levels(DM_compare_341$bin),
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +
           labs(x = expression("observed biomass (Mg ha"^-1*")"),
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("341 - Nevada-Utah Mountains Semi-Desert - Coniferous Forest - Alpine Meadow") +
           theme_classic() +
           # xlim(min(DM_compare_341$data.CI.low)-0.25, max(DM_compare_341$data.CI.high)+0.25) +
           # ylim(min(DM_compare_341$pred.CI.low)-0.25, max(DM_compare_341$pred.CI.high)+0.25) +
           theme(legend.position = "top") + tune::coord_obs_pred()

gg.341.B2

}   else {print("cannot plot observed vs. predicted")}
```

# 342 - Intermountain Semi-Desert
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_342 <- round(quantile(P_342$STDAGE, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_342)))){
  cutvec_342 <- round(quantile(P_342$STDAGE, seq(0,1, length.out = 11)))
}

bin_mids_342 <- unname(round(cutvec_342[-length(cutvec_342)] + diff(cutvec_342)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
P_342$STDAGE_bin<-  cut(P_342$STDAGE, cutvec_342)
## then get bin means
P_342_bin_means <- tapply(P_342$BIO_MgHa, cut(P_342$STDAGE,  cutvec_342), mean)

## make column weights.2
P_342$nls_weights.2 <- as.numeric(1/(P_342_bin_means[match(P_342$STDAGE_bin, names(P_342_bin_means))])^2)

}
```

## model selection 1

```{r}
# simple
try(
  nls_342.1 <- nls(f_1, data = P_342, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = P_342$nls_weights.2), 
 )

## phi
try(
  nls_342.2 <- nls(f_2, data=P_342, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = P_342$nls_weights.2), 
 )

## test
if(exists("nls_342.1") & exists("nls_342.2")){
  print(anova(nls_342.1, nls_342.2))
}
 
## AIC comparison
AIC1_342 <- data.frame(model = c(1,2), AIC = c(
            ifelse(exists("nls_342.1"), AIC(get("nls_342.1")), NA),
            ifelse(exists("nls_342.2"), AIC(get("nls_342.2")), NA)
            ))

print(AIC1_342) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_342[!is.na(AIC1_342$AIC) & AIC1_342$AIC == min(AIC1_342$AIC, na.rm = T),]$model

try(summary(get(paste("nls_342.",  Mod.Sel1, sep =""))) )  #model summary
```
### summary 
* simple model: `r ifelse(exists("nls_342.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_342.2"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_342.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_342.",  Mod.Sel1, sep ="")))["phi"], 1)
A.fit <- round(coef(get(paste("nls_342.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_342.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_342.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = P_342,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              }, 
          weights = P_342$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_342.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = P_342,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              },
          weights = P_342$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_342.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = P_342,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              }, 
          weights = P_342$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_342.", Mod.Sel1, sep ="")) &
     exists(paste("nls_342.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_342.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_342.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_342.", Mod.Sel1, sep ="")),
             get(paste("nls_342.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_342.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_342.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_342.", Mod.Sel1, sep ="")) &
         exists(paste("nls_342.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_342.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_342.", Mod.Sel1, sep ="")),
               get(paste("nls_342.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_342.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_342.", Mod.Sel1, sep ="")) &
           exists(paste("nls_342.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_342.", Mod.Sel1, sep ="")),
                 get(paste("nls_342.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_342.", Mod.Sel1, sep ="")) &
              exists(paste("nls_342.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_342.", Mod.Sel1, sep ="")),
                    get(paste("nls_342.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_342.", Mod.Sel1, sep ="")) &
                exists(paste("nls_342.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_342.", Mod.Sel1, sep ="")),
                      get(paste("nls_342.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_342 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_342.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_342.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_342.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_342.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_342.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_342.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_342.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_342.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_342)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_342[!is.na(AIC2_342$AIC) & AIC2_342$AIC == min(AIC2_342$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P[Best_mods.P$Code == "342",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_342.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_342.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df[nls.param.df$Code == "342",]$ge <- coefs["ge"]
nls.param.df[nls.param.df$Code == "342",]$phi <- coefs["phi"]
nls.param.df[nls.param.df$Code == "342",]$A <- coefs["A"]
nls.param.df[nls.param.df$Code == "342",]$k <- coefs["k"]

nls.param.df[nls.param.df$Code == "342",]$ge.2.5 <- intervals_low["ge"]
nls.param.df[nls.param.df$Code == "342",]$phi.2.5 <- intervals_low["phi"]
nls.param.df[nls.param.df$Code == "342",]$A.2.5 <- intervals_low["A"]
nls.param.df[nls.param.df$Code == "342",]$k.2.5 <- intervals_low["k"]

nls.param.df[nls.param.df$Code == "342",]$ge.97.5 <- intervals_high["ge"]
nls.param.df[nls.param.df$Code == "342",]$phi.97.5 <- intervals_high["phi"]
nls.param.df[nls.param.df$Code == "342",]$A.97.5 <- intervals_high["A"]
nls.param.df[nls.param.df$Code == "342",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_342.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_342.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_342.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_342.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals
```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_342 <- nlsResiduals(
  get(paste("nls_342.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_342)

## test residuals
if(length(P_342$pltID) < 5001) {test.nlsResiduals(resid_342)}

}   else {print("cannot plot residuals")}
```

## predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

P_342_pred <- predict(get(paste("nls_342.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME" = rep(mean(P_342$MEASTIME, na.rm = T), max(P_342$STDAGE)),
                                   "STDAGE" = seq(1, max(P_342$STDAGE), by = 1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME" = rep(mean(P_342$MEASTIME, na.rm = T), max(P_342$STDAGE)),
                                   "STDAGE" = seq(1, max(P_342$STDAGE), by = 1),
                                   "DeltaPDSI" = rep(mean(P_342$DeltaPDSI, na.rm = T), max(P_342$STDAGE)))
                      } )

P_342_pred_df <- data.frame("STDAGE"=seq(1,max(P_342$STDAGE),by = 1),  
                            "fitted"=P_342_pred)

## plot
gg.342 <- ggplot() +
          geom_point(aes(x = STDAGE, y = BIO_MgHa), data = P_342, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE, y = BIO_MgHa), data = P_342, 
                            fun.data = function(x) {
                              res <- quantile(x, probs = c(0.25,0.5,0.75))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_342)-1)), breaks = cutvec_342) +  
          
          #geom_ribbon(aes(x = STDAGE, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = P_342_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE, y = fitted), data = P_342_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("342 - Intermountain Semi-Desert") + 
          
          #ylim(0, max(P_342_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, cutvec_342[20]*1.05), expand = c(0,0))

gg.342

}  else {print("cannot plot data with prediction")}
```


## plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_342 <- data.frame(
  bin = as.factor(levels(cut(P_342$STDAGE, cutvec_342))),
  data.mean = tapply(P_342$BIO_MgHa, cut(P_342$STDAGE, cutvec_342), 
                     mean, na.rm = T), 
  data.CI.high =  tapply(P_342$BIO_MgHa, cut(P_342$STDAGE, cutvec_342), 
                    high.CI), 
  data.CI.low = tapply(P_342$BIO_MgHa, cut(P_342$STDAGE, cutvec_342),
                    low.CI), 
  pred.mean = P_342_pred_df[P_342_pred_df$STDAGE %in% bin_mids_342,]$fitted) 
  # pred.CI.high = tapply(`342_CI_df`$fitted, cut(`342_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_342$STDAGE, g=20))),
  #                      high.CI), 
  # pred.CI.low = tapply(`342_CI_df`$fitted, cut(`342_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_342$STDAGE, g=20))),
  #                      low.CI))

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_342 <-  DM_compare_342 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_342$bin)[gtools::mixedorder(levels(DM_compare_342$bin))]))

## ggplot
gg.342.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_342) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_342))), 
                              labels = levels(DM_compare_342$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("342 - Northeastern Mixed Forest") +         
           theme_classic() + 
           # xlim(min(DM_compare_342$data.CI.low)-0.25, max(DM_compare_342$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_342$pred.CI.low)-0.25, max(DM_compare_342$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.342.B2

}   else {print("cannot plot observed vs. predicted")}
```

# 411 - Everglades
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_411 <- round(quantile(P_411$STDAGE, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_411)))){
  cutvec_411 <- round(quantile(P_411$STDAGE, seq(0,1, length.out = 11)))
}

bin_mids_411 <- unname(round(cutvec_411[-length(cutvec_411)] + diff(cutvec_411)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
P_411$STDAGE_bin<-  cut(P_411$STDAGE, cutvec_411)
## then get bin means
P_411_bin_means <- tapply(P_411$BIO_MgHa, cut(P_411$STDAGE,  cutvec_411), mean)

## make column weights.2
P_411$nls_weights.2 <- as.numeric(1/(P_411_bin_means[match(P_411$STDAGE_bin, names(P_411_bin_means))])^2)

}
```

## model selection 1

```{r}
# simple
try(
  nls_411.1 <- nls(f_1, data = P_411, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = P_411$nls_weights.2), 
 )

## phi
try(
  nls_411.2 <- nls(f_2, data=P_411, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = P_411$nls_weights.2), 
 )

## test
if(exists("nls_411.1") & exists("nls_411.2")){
  print(anova(nls_411.1, nls_411.2))
}
 
## AIC comparison
AIC1_411 <- data.frame(model = c(1,2), AIC = c(
            ifelse(exists("nls_411.1"), AIC(get("nls_411.1")), NA),
            ifelse(exists("nls_411.2"), AIC(get("nls_411.2")), NA)
            ))

print(AIC1_411) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_411[!is.na(AIC1_411$AIC) & AIC1_411$AIC == min(AIC1_411$AIC, na.rm = T),]$model

try(summary(get(paste("nls_411.",  Mod.Sel1, sep =""))) )  #model summary
```
### summary 
* simple model: `r ifelse(exists("nls_411.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_411.2"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_411.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_411.",  Mod.Sel1, sep ="")))["phi"], 1)
A.fit <- round(coef(get(paste("nls_411.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_411.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_411.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = P_411,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              }, 
          weights = P_411$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_411.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = P_411,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              },
          weights = P_411$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_411.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = P_411,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              }, 
          weights = P_411$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_411.", Mod.Sel1, sep ="")) &
     exists(paste("nls_411.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_411.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_411.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_411.", Mod.Sel1, sep ="")),
             get(paste("nls_411.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_411.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_411.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_411.", Mod.Sel1, sep ="")) &
         exists(paste("nls_411.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_411.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_411.", Mod.Sel1, sep ="")),
               get(paste("nls_411.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_411.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_411.", Mod.Sel1, sep ="")) &
           exists(paste("nls_411.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_411.", Mod.Sel1, sep ="")),
                 get(paste("nls_411.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_411.", Mod.Sel1, sep ="")) &
              exists(paste("nls_411.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_411.", Mod.Sel1, sep ="")),
                    get(paste("nls_411.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_411.", Mod.Sel1, sep ="")) &
                exists(paste("nls_411.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_411.", Mod.Sel1, sep ="")),
                      get(paste("nls_411.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_411 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_411.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_411.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_411.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_411.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_411.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_411.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_411.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_411.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_411)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_411[!is.na(AIC2_411$AIC) & AIC2_411$AIC == min(AIC2_411$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P[Best_mods.P$Code == "411",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_411.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_411.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df[nls.param.df$Code == "411",]$ge <- coefs["ge"]
nls.param.df[nls.param.df$Code == "411",]$phi <- coefs["phi"]
nls.param.df[nls.param.df$Code == "411",]$A <- coefs["A"]
nls.param.df[nls.param.df$Code == "411",]$k <- coefs["k"]

nls.param.df[nls.param.df$Code == "411",]$ge.2.5 <- intervals_low["ge"]
nls.param.df[nls.param.df$Code == "411",]$phi.2.5 <- intervals_low["phi"]
nls.param.df[nls.param.df$Code == "411",]$A.2.5 <- intervals_low["A"]
nls.param.df[nls.param.df$Code == "411",]$k.2.5 <- intervals_low["k"]

nls.param.df[nls.param.df$Code == "411",]$ge.97.5 <- intervals_high["ge"]
nls.param.df[nls.param.df$Code == "411",]$phi.97.5 <- intervals_high["phi"]
nls.param.df[nls.param.df$Code == "411",]$A.97.5 <- intervals_high["A"]
nls.param.df[nls.param.df$Code == "411",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_411.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_411.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_411.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_411.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals
```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_411 <- nlsResiduals(
  get(paste("nls_411.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_411)

## test residuals
if(length(P_411$pltID) < 5001) {test.nlsResiduals(resid_411)}

}   else {print("cannot plot residuals")}
```

## predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## predict model fit
P_411_pred <- predict(get(paste("nls_411.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME" = rep(mean(P_411$MEASTIME, na.rm = T), max(P_411$STDAGE)),
                                   "STDAGE" = seq(1, max(P_411$STDAGE), by = 1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME" = rep(mean(P_411$MEASTIME, na.rm = T), max(P_411$STDAGE)),
                                   "STDAGE" = seq(1, max(P_411$STDAGE), by = 1),
                                   "DeltaPDSI" = rep(mean(P_411$DeltaPDSI, na.rm = T), max(P_411$STDAGE)))
                      } )

P_411_pred_df <- data.frame("STDAGE"=seq(1,max(P_411$STDAGE),by = 1),
                            "fitted" =P_411_pred)

## plot
gg.411 <- ggplot() +
          geom_point(aes(x = STDAGE, y = BIO_MgHa), data = P_411, alpha = 0.5, shape ="+", col = "#60606080") +

          stat_summary_bin(aes(x = STDAGE, y = BIO_MgHa), data = P_411,
                            fun.data = function(x) {
                              res <- quantile(x, probs = c(0.25,0.5,0.75))
                              names(res) <- c("ymin","y","ymax")
                              res},
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_411))), breaks = cutvec_411) +

          #geom_ribbon(aes(x = STDAGE, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`),
                      #data = P_411_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +

          geom_line(aes(x = STDAGE, y = fitted), data = P_411_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) +


          theme_classic() +
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"),
               x = "Stand Age (yrs)") +  ggtitle("411 - Intermountain Semi-Desert") +

          #ylim(0, max(P_411_pred_df$`Prop.97.5%` + 0.25)) +
          scale_x_continuous(limits = c(0, max(P_411$STDAGE)), expand = c(0,0))

gg.411

}  else {print("cannot plot data with prediction")}
```

## plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_411 <- data.frame(
  bin = as.factor(levels(cut(P_411$STDAGE, cutvec_411))),
  data.mean = tapply(P_411$BIO_MgHa, cut(P_411$STDAGE, cutvec_411),
                     mean, na.rm = T),
  data.CI.high =  tapply(P_411$BIO_MgHa, cut(P_411$STDAGE, cutvec_411),
                    high.CI),
  data.CI.low = tapply(P_411$BIO_MgHa, cut(P_411$STDAGE, cutvec_411),
                    low.CI),
  pred.mean = P_411_pred_df[P_411_pred_df$STDAGE %in% bin_mids_411,]$fitted)
  # pred.CI.high = tapply(`411_CI_df`$fitted, cut(`411_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_411$STDAGE, g=20))),
  #                      high.CI),
  # pred.CI.low = tapply(`411_CI_df`$fitted, cut(`411_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_411$STDAGE, g=20))),
  #                      low.CI))

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY
DM_compare_411 <-  DM_compare_411 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_411$bin)[gtools::mixedorder(levels(DM_compare_411$bin))]))

## ggplot
gg.411.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_411) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_411))),
                              labels = levels(DM_compare_411$bin),
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +
           labs(x = expression("observed biomass (Mg ha"^-1*")"),
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("411 -  Everglades") +
           theme_classic() +
           # xlim(min(DM_compare_411$data.CI.low)-0.25, max(DM_compare_411$data.CI.high)+0.25) +
           # ylim(min(DM_compare_411$pred.CI.low)-0.25, max(DM_compare_411$pred.CI.high)+0.25) +
           theme(legend.position = "top") + tune::coord_obs_pred()

gg.411.B2

}   else {print("cannot plot observed vs. predicted")}
```

# M211 - Adirondack-New England Mixed forest - Coniferous Forest - Alpine Meadow
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_M211 <- round(quantile(P_M211$STDAGE, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M211)))){
  cutvec_M211 <- round(quantile(P_M211$STDAGE, seq(0,1, length.out = 11)))
}

bin_mids_M211 <- unname(round(cutvec_M211[-length(cutvec_M211)] + diff(cutvec_M211)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
P_M211$STDAGE_bin<-  cut(P_M211$STDAGE, cutvec_M211)
## then get bin means
P_M211_bin_means <- tapply(P_M211$BIO_MgHa, cut(P_M211$STDAGE,  cutvec_M211), mean)

## make column weights.2
P_M211$nls_weights.2 <- as.numeric(1/(P_M211_bin_means[match(P_M211$STDAGE_bin, names(P_M211_bin_means))])^2)

}
```

## model selection 1

```{r}
# simple
try(
  nls_M211.1 <- nls(f_1, data = P_M211, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = P_M211$nls_weights.2), 
 )

## phi
try(
  nls_M211.2 <- nls(f_2, data=P_M211, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = P_M211$nls_weights.2), 
 )

## test
if(exists("nls_M211.1") & exists("nls_M211.2")){
  print(anova(nls_M211.1, nls_M211.2))
}
 
## AIC comparison
AIC1_M211 <- data.frame(model = c(1,2), AIC = c(
            ifelse(exists("nls_M211.1"), AIC(get("nls_M211.1")), NA),
            ifelse(exists("nls_M211.2"), AIC(get("nls_M211.2")), NA)
            ))

print(AIC1_M211) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M211[!is.na(AIC1_M211$AIC) & AIC1_M211$AIC == min(AIC1_M211$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M211.",  Mod.Sel1, sep =""))) )  #model summary
```
### summary 
* simple model: `r ifelse(exists("nls_M211.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M211.2"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M211.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M211.",  Mod.Sel1, sep ="")))["phi"], 1)
A.fit <- round(coef(get(paste("nls_M211.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M211.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M211.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = P_M211,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              }, 
          weights = P_M211$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M211.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = P_M211,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              },
          weights = P_M211$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_M211.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = P_M211,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              }, 
          weights = P_M211$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M211.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M211.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M211.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M211.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M211.", Mod.Sel1, sep ="")),
             get(paste("nls_M211.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M211.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M211.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M211.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M211.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M211.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M211.", Mod.Sel1, sep ="")),
               get(paste("nls_M211.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M211.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M211.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M211.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M211.", Mod.Sel1, sep ="")),
                 get(paste("nls_M211.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M211.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M211.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M211.", Mod.Sel1, sep ="")),
                    get(paste("nls_M211.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M211.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M211.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M211.", Mod.Sel1, sep ="")),
                      get(paste("nls_M211.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M211 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M211.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M211.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M211.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M211.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M211.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M211.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M211.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M211.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M211)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M211[!is.na(AIC2_M211$AIC) & AIC2_M211$AIC == min(AIC2_M211$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P[Best_mods.P$Code == "M211",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M211.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M211.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df[nls.param.df$Code == "M211",]$ge <- coefs["ge"]
nls.param.df[nls.param.df$Code == "M211",]$phi <- coefs["phi"]
nls.param.df[nls.param.df$Code == "M211",]$A <- coefs["A"]
nls.param.df[nls.param.df$Code == "M211",]$k <- coefs["k"]

nls.param.df[nls.param.df$Code == "M211",]$ge.2.5 <- intervals_low["ge"]
nls.param.df[nls.param.df$Code == "M211",]$phi.2.5 <- intervals_low["phi"]
nls.param.df[nls.param.df$Code == "M211",]$A.2.5 <- intervals_low["A"]
nls.param.df[nls.param.df$Code == "M211",]$k.2.5 <- intervals_low["k"]

nls.param.df[nls.param.df$Code == "M211",]$ge.97.5 <- intervals_high["ge"]
nls.param.df[nls.param.df$Code == "M211",]$phi.97.5 <- intervals_high["phi"]
nls.param.df[nls.param.df$Code == "M211",]$A.97.5 <- intervals_high["A"]
nls.param.df[nls.param.df$Code == "M211",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M211.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M211.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M211.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M211.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals
```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_M211 <- nlsResiduals(
  get(paste("nls_M211.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_M211)

## test residuals
if(length(P_M211$pltID) < 5001) {test.nlsResiduals(resid_M211)}

}   else {print("cannot plot residuals")}
```

## predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

P_M211_pred <- predict(get(paste("nls_M211.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME" = rep(mean(P_M211$MEASTIME, na.rm = T), max(P_M211$STDAGE)),
                                   "STDAGE" = seq(1, max(P_M211$STDAGE), by = 1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME" = rep(mean(P_M211$MEASTIME, na.rm = T), max(P_M211$STDAGE)),
                                   "STDAGE" = seq(1, max(P_M211$STDAGE), by = 1),
                                   "DeltaPDSI" = rep(mean(P_M211$DeltaPDSI, na.rm = T), max(P_M211$STDAGE)))
                      } )

P_M211_pred_df <- data.frame("STDAGE"=seq(1,max(P_M211$STDAGE),by = 1),  
                            "fitted"=P_M211_pred)

## plot
gg.M211 <- ggplot() +
          geom_point(aes(x = STDAGE, y = BIO_MgHa), data = P_M211, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE, y = BIO_MgHa), data = P_M211, 
                            fun.data = function(x) {
                              res <- quantile(x, probs = c(0.25,0.5,0.75))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M211))), breaks = cutvec_M211) +  
          
          #geom_ribbon(aes(x = STDAGE, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = P_M211_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE, y = fitted), data = P_M211_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("M211 -  Adirondack-New England Mixed forest - Coniferous Forest - Alpine Meadow") + 
          
          #ylim(0, max(P_M211_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, cutvec_M211[20]*1.05), expand = c(0,0))

gg.M211

}  else {print("cannot plot data with prediction")}
```


## plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_M211 <- data.frame(
  bin = as.factor(levels(cut(P_M211$STDAGE, cutvec_M211))),
  data.mean = tapply(P_M211$BIO_MgHa, cut(P_M211$STDAGE, cutvec_M211), 
                     mean, na.rm = T), 
  data.CI.high =  tapply(P_M211$BIO_MgHa, cut(P_M211$STDAGE, cutvec_M211), 
                    high.CI), 
  data.CI.low = tapply(P_M211$BIO_MgHa, cut(P_M211$STDAGE, cutvec_M211),
                    low.CI), 
  pred.mean = P_M211_pred_df[P_M211_pred_df$STDAGE %in% bin_mids_M211,]$fitted) 
  # pred.CI.high = tapply(`M211_CI_df`$fitted, cut(`M211_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_M211$STDAGE, g=20))),
  #                      high.CI), 
  # pred.CI.low = tapply(`M211_CI_df`$fitted, cut(`M211_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_M211$STDAGE, g=20))),
  #                      low.CI))

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M211 <-  DM_compare_M211 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M211$bin)[gtools::mixedorder(levels(DM_compare_M211$bin))]))

## ggplot
gg.M211.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M211) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M211))), 
                              labels = levels(DM_compare_M211$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("M211 - Adirondack-New England Mixed forest - Coniferous Forest - Alpine Meadow") +         
           theme_classic() + 
           # xlim(min(DM_compare_M211$data.CI.low)-0.25, max(DM_compare_M211$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_M211$pred.CI.low)-0.25, max(DM_compare_M211$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M211.B2

}   else {print("cannot plot observed vs. predicted")}
```

# M221 - Eastern Broadleaf Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_M221 <- round(quantile(P_M221$STDAGE, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M221)))){
  cutvec_M221 <- round(quantile(P_M221$STDAGE, seq(0,1, length.out = 11)))
}

bin_mids_M221 <- unname(round(cutvec_M221[-length(cutvec_M221)] + diff(cutvec_M221)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
P_M221$STDAGE_bin<-  cut(P_M221$STDAGE, cutvec_M221)
## then get bin means
P_M221_bin_means <- tapply(P_M221$BIO_MgHa, cut(P_M221$STDAGE,  cutvec_M221), mean)

## make column weights.2
P_M221$nls_weights.2 <- as.numeric(1/(P_M221_bin_means[match(P_M221$STDAGE_bin, names(P_M221_bin_means))])^2)

}
```

## model selection 1

```{r}
# simple
try(
  nls_M221.1 <- nls(f_1, data = P_M221, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = P_M221$nls_weights.2), 
 )

## phi
try(
  nls_M221.2 <- nls(f_2, data=P_M221, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = P_M221$nls_weights.2), 
 )

## test
if(exists("nls_M221.1") & exists("nls_M221.2")){
  print(anova(nls_M221.1, nls_M221.2))
}
 
## AIC comparison
AIC1_M221 <- data.frame(model = c(1,2), AIC = c(
            ifelse(exists("nls_M221.1"), AIC(get("nls_M221.1")), NA),
            ifelse(exists("nls_M221.2"), AIC(get("nls_M221.2")), NA)
            ))

print(AIC1_M221) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M221[!is.na(AIC1_M221$AIC) & AIC1_M221$AIC == min(AIC1_M221$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M221.",  Mod.Sel1, sep =""))) )  #model summary
```
### summary 
* simple model: `r ifelse(exists("nls_M221.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M221.2"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M221.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M221.",  Mod.Sel1, sep ="")))["phi"], 1)
A.fit <- round(coef(get(paste("nls_M221.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M221.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M221.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = P_M221,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              }, 
          weights = P_M221$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M221.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = P_M221,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              },
          weights = P_M221$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_M221.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = P_M221,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              }, 
          weights = P_M221$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M221.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M221.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M221.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M221.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M221.", Mod.Sel1, sep ="")),
             get(paste("nls_M221.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M221.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M221.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M221.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M221.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M221.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M221.", Mod.Sel1, sep ="")),
               get(paste("nls_M221.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M221.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M221.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M221.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M221.", Mod.Sel1, sep ="")),
                 get(paste("nls_M221.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M221.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M221.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M221.", Mod.Sel1, sep ="")),
                    get(paste("nls_M221.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M221.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M221.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M221.", Mod.Sel1, sep ="")),
                      get(paste("nls_M221.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M221 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M221.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M221.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M221.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M221.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M221.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M221.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M221.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M221.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M221)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M221[!is.na(AIC2_M221$AIC) & AIC2_M221$AIC == min(AIC2_M221$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P[Best_mods.P$Code == "M221",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M221.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M221.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df[nls.param.df$Code == "M221",]$ge <- coefs["ge"]
nls.param.df[nls.param.df$Code == "M221",]$phi <- coefs["phi"]
nls.param.df[nls.param.df$Code == "M221",]$A <- coefs["A"]
nls.param.df[nls.param.df$Code == "M221",]$k <- coefs["k"]

nls.param.df[nls.param.df$Code == "M221",]$ge.2.5 <- intervals_low["ge"]
nls.param.df[nls.param.df$Code == "M221",]$phi.2.5 <- intervals_low["phi"]
nls.param.df[nls.param.df$Code == "M221",]$A.2.5 <- intervals_low["A"]
nls.param.df[nls.param.df$Code == "M221",]$k.2.5 <- intervals_low["k"]

nls.param.df[nls.param.df$Code == "M221",]$ge.97.5 <- intervals_high["ge"]
nls.param.df[nls.param.df$Code == "M221",]$phi.97.5 <- intervals_high["phi"]
nls.param.df[nls.param.df$Code == "M221",]$A.97.5 <- intervals_high["A"]
nls.param.df[nls.param.df$Code == "M221",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M221.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M221.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M221.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M221.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals
```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_M221 <- nlsResiduals(
  get(paste("nls_M221.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_M221)

## test residuals
if(length(P_M221$pltID) < 5001) {test.nlsResiduals(resid_M221)}

}   else {print("cannot plot residuals")}
```

## predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

P_M221_pred <- predict(get(paste("nls_M221.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME" = rep(mean(P_M221$MEASTIME, na.rm = T), max(P_M221$STDAGE)),
                                   "STDAGE" = seq(1, max(P_M221$STDAGE), by = 1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME" = rep(mean(P_M221$MEASTIME, na.rm = T), max(P_M221$STDAGE)),
                                   "STDAGE" = seq(1, max(P_M221$STDAGE), by = 1),
                                   "DeltaPDSI" = rep(mean(P_M221$DeltaPDSI, na.rm = T), max(P_M221$STDAGE)))
                      } )

P_M221_pred_df <- data.frame("STDAGE"=seq(1,max(P_M221$STDAGE),by = 1),  
                            "fitted"=P_M221_pred)

## plot
gg.M221 <- ggplot() +
          geom_point(aes(x = STDAGE, y = BIO_MgHa), data = P_M221, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE, y = BIO_MgHa), data = P_M221, 
                            fun.data = function(x) {
                              res <- quantile(x, probs = c(0.25,0.5,0.75))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M221))), breaks = cutvec_M221) +  
          
          #geom_ribbon(aes(x = STDAGE, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = P_M221_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE, y = fitted), data = P_M221_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("M221 - Eastern Broadleaf Forest") + 
          
          #ylim(0, max(P_M221_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, cutvec_M221[20]*1.05), expand = c(0,0))

gg.M221

}  else {print("cannot plot data with prediction")}
```

## plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_M221 <- data.frame(
  bin = as.factor(levels(cut(P_M221$STDAGE, cutvec_M221))),
  data.mean = tapply(P_M221$BIO_MgHa, cut(P_M221$STDAGE, cutvec_M221), 
                     mean, na.rm = T), 
  data.CI.high =  tapply(P_M221$BIO_MgHa, cut(P_M221$STDAGE, cutvec_M221), 
                    high.CI), 
  data.CI.low = tapply(P_M221$BIO_MgHa, cut(P_M221$STDAGE, cutvec_M221),
                    low.CI), 
  pred.mean = P_M221_pred_df[P_M221_pred_df$STDAGE %in% bin_mids_M221,]$fitted) 
  # pred.CI.high = tapply(`M221_CI_df`$fitted, cut(`M221_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_M221$STDAGE, g=20))),
  #                      high.CI), 
  # pred.CI.low = tapply(`M221_CI_df`$fitted, cut(`M221_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_M221$STDAGE, g=20))),
  #                      low.CI))

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M221 <-  DM_compare_M221 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M221$bin)[gtools::mixedorder(levels(DM_compare_M221$bin))]))

## ggplot
gg.M221.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M221) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M221))), 
                              labels = levels(DM_compare_M221$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("M221 - Eastern Broadleaf Forest") +         
           theme_classic() + 
           # xlim(min(DM_compare_M221$data.CI.low)-0.25, max(DM_compare_M221$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_M221$pred.CI.low)-0.25, max(DM_compare_M221$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M221.B2

}   else {print("cannot plot observed vs. predicted")}
```

# M223 - Ozark Broadleaf Forest Meadow
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_M223 <- round(quantile(P_M223$STDAGE, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M223)))){
  cutvec_M223 <- round(quantile(P_M223$STDAGE, seq(0,1, length.out = 11)))
}

bin_mids_M223 <- unname(round(cutvec_M223[-length(cutvec_M223)] + diff(cutvec_M223)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
P_M223$STDAGE_bin<-  cut(P_M223$STDAGE, cutvec_M223)
## then get bin means
P_M223_bin_means <- tapply(P_M223$BIO_MgHa, cut(P_M223$STDAGE,  cutvec_M223), mean)

## make column weights.2
P_M223$nls_weights.2 <- as.numeric(1/(P_M223_bin_means[match(P_M223$STDAGE_bin, names(P_M223_bin_means))])^2)

}
```

## model selection 1

```{r}
# simple
try(
  nls_M223.1 <- nls(f_1, data = P_M223, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = P_M223$nls_weights.2), 
 )

## phi
try(
  nls_M223.2 <- nls(f_2, data=P_M223, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = P_M223$nls_weights.2), 
 )

## test
if(exists("nls_M223.1") & exists("nls_M223.2")){
  print(anova(nls_M223.1, nls_M223.2))
}
 
## AIC comparison
AIC1_M223 <- data.frame(model = c(1,2), AIC = c(
            ifelse(exists("nls_M223.1"), AIC(get("nls_M223.1")), NA),
            ifelse(exists("nls_M223.2"), AIC(get("nls_M223.2")), NA)
            ))

print(AIC1_M223) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M223[!is.na(AIC1_M223$AIC) & AIC1_M223$AIC == min(AIC1_M223$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M223.",  Mod.Sel1, sep =""))) )  #model summary
```
### summary 
* simple model: `r ifelse(exists("nls_M223.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M223.2"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M223.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M223.",  Mod.Sel1, sep ="")))["phi"], 1)
A.fit <- round(coef(get(paste("nls_M223.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M223.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M223.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = P_M223,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              }, 
          weights = P_M223$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M223.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = P_M223,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              },
          weights = P_M223$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_M223.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = P_M223,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              }, 
          weights = P_M223$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M223.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M223.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M223.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M223.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M223.", Mod.Sel1, sep ="")),
             get(paste("nls_M223.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M223.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M223.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M223.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M223.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M223.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M223.", Mod.Sel1, sep ="")),
               get(paste("nls_M223.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M223.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M223.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M223.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M223.", Mod.Sel1, sep ="")),
                 get(paste("nls_M223.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M223.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M223.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M223.", Mod.Sel1, sep ="")),
                    get(paste("nls_M223.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M223.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M223.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M223.", Mod.Sel1, sep ="")),
                      get(paste("nls_M223.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M223 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M223.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M223.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M223.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M223.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M223.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M223.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M223.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M223.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M223)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M223[!is.na(AIC2_M223$AIC) & AIC2_M223$AIC == min(AIC2_M223$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P[Best_mods.P$Code == "M223",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M223.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M223.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df[nls.param.df$Code == "M223",]$ge <- coefs["ge"]
nls.param.df[nls.param.df$Code == "M223",]$phi <- coefs["phi"]
nls.param.df[nls.param.df$Code == "M223",]$A <- coefs["A"]
nls.param.df[nls.param.df$Code == "M223",]$k <- coefs["k"]

nls.param.df[nls.param.df$Code == "M223",]$ge.2.5 <- intervals_low["ge"]
nls.param.df[nls.param.df$Code == "M223",]$phi.2.5 <- intervals_low["phi"]
nls.param.df[nls.param.df$Code == "M223",]$A.2.5 <- intervals_low["A"]
nls.param.df[nls.param.df$Code == "M223",]$k.2.5 <- intervals_low["k"]

nls.param.df[nls.param.df$Code == "M223",]$ge.97.5 <- intervals_high["ge"]
nls.param.df[nls.param.df$Code == "M223",]$phi.97.5 <- intervals_high["phi"]
nls.param.df[nls.param.df$Code == "M223",]$A.97.5 <- intervals_high["A"]
nls.param.df[nls.param.df$Code == "M223",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M223.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M223.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M223.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M223.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals
```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_M223 <- nlsResiduals(
  get(paste("nls_M223.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_M223)

## test residuals
if(length(P_M223$pltID) < 5001) {test.nlsResiduals(resid_M223)}

}   else {print("cannot plot residuals")}
```

## predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

P_M223_pred <- predict(get(paste("nls_M223.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME" = rep(mean(P_M223$MEASTIME, na.rm = T), max(P_M223$STDAGE)),
                                   "STDAGE" = seq(1, max(P_M223$STDAGE), by = 1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME" = rep(mean(P_M223$MEASTIME, na.rm = T), max(P_M223$STDAGE)),
                                   "STDAGE" = seq(1, max(P_M223$STDAGE), by = 1),
                                   "DeltaPDSI" = rep(mean(P_M223$DeltaPDSI, na.rm = T), max(P_M223$STDAGE)))
                      } )

P_M223_pred_df <- data.frame("STDAGE"=seq(1,max(P_M223$STDAGE),by = 1),  
                            "fitted"=P_M223_pred)

## plot
gg.M223 <- ggplot() +
          geom_point(aes(x = STDAGE, y = BIO_MgHa), data = P_M223, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE, y = BIO_MgHa), data = P_M223, 
                            fun.data = function(x) {
                              res <- quantile(x, probs = c(0.25,0.5,0.75))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M223))), breaks = cutvec_M223) +  
          
          #geom_ribbon(aes(x = STDAGE, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = P_M223_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE, y = fitted), data = P_M223_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("M223 - Ozark Broadleaf Forest Meadow") + 
          
          #ylim(0, max(P_M223_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, cutvec_M223[20]*1.05), expand = c(0,0))

gg.M223

}  else {print("cannot plot data with prediction")}
```


## plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_M223 <- data.frame(
  bin = as.factor(levels(cut(P_M223$STDAGE, cutvec_M223))),
  data.mean = tapply(P_M223$BIO_MgHa, cut(P_M223$STDAGE, cutvec_M223), 
                     mean, na.rm = T), 
  data.CI.high =  tapply(P_M223$BIO_MgHa, cut(P_M223$STDAGE, cutvec_M223), 
                    high.CI), 
  data.CI.low = tapply(P_M223$BIO_MgHa, cut(P_M223$STDAGE, cutvec_M223),
                    low.CI), 
  pred.mean = P_M223_pred_df[P_M223_pred_df$STDAGE %in% bin_mids_M223,]$fitted) 
  # pred.CI.high = tapply(`M223_CI_df`$fitted, cut(`M223_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_M223$STDAGE, g=20))),
  #                      high.CI), 
  # pred.CI.low = tapply(`M223_CI_df`$fitted, cut(`M223_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_M223$STDAGE, g=20))),
  #                      low.CI))

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M223 <-  DM_compare_M223 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M223$bin)[gtools::mixedorder(levels(DM_compare_M223$bin))]))

## ggplot
gg.M223.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M223) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M223))), 
                              labels = levels(DM_compare_M223$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("M223 - Ozark Broadleaf Forest Meadow") +         
           theme_classic() + 
           # xlim(min(DM_compare_M223$data.CI.low)-0.25, max(DM_compare_M223$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_M223$pred.CI.low)-0.25, max(DM_compare_M223$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M223.B2

}   else {print("cannot plot observed vs. predicted")}
```

# M231 - Ouachita Mixed Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_M231 <- round(quantile(P_M231$STDAGE, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M231)))){
  cutvec_M231 <- round(quantile(P_M231$STDAGE, seq(0,1, length.out = 11)))
}

bin_mids_M231 <- unname(round(cutvec_M231[-length(cutvec_M231)] + diff(cutvec_M231)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
P_M231$STDAGE_bin<-  cut(P_M231$STDAGE, cutvec_M231)
## then get bin means
P_M231_bin_means <- tapply(P_M231$BIO_MgHa, cut(P_M231$STDAGE, cutvec_M231), mean)

## make column weights.2
P_M231$nls_weights.2 <- as.numeric(1/(P_M231_bin_means[match(P_M231$STDAGE_bin, names(P_M231_bin_means))])^2)

}
```

## model selection 1

```{r}
# simple
try(
  nls_M231.1 <- nls(f_1, data = P_M231, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = P_M231$nls_weights.2), 
 )

## phi
try(
  nls_M231.2 <- nls(f_2, data=P_M231, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = P_M231$nls_weights.2), 
 )

## test
if(exists("nls_M231.1") & exists("nls_M231.2")){
  print(anova(nls_M231.1, nls_M231.2))
}
 
## AIC comparison
AIC1_M231 <- data.frame(model = c(1,2), AIC = c(
            ifelse(exists("nls_M231.1"), AIC(get("nls_M231.1")), NA),
            ifelse(exists("nls_M231.2"), AIC(get("nls_M231.2")), NA)
            ))

print(AIC1_M231) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M231[!is.na(AIC1_M231$AIC) & AIC1_M231$AIC == min(AIC1_M231$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M231.",  Mod.Sel1, sep =""))) )  #model summary
```
### summary 
* simple model: `r ifelse(exists("nls_M231.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M231.2"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M231.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M231.",  Mod.Sel1, sep ="")))["phi"], 1)
A.fit <- round(coef(get(paste("nls_M231.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M231.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M231.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = P_M231,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              }, 
          weights = P_M231$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M231.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = P_M231,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              },
          weights = P_M231$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_M231.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = P_M231,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              }, 
          weights = P_M231$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M231.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M231.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M231.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M231.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M231.", Mod.Sel1, sep ="")),
             get(paste("nls_M231.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M231.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M231.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M231.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M231.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M231.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M231.", Mod.Sel1, sep ="")),
               get(paste("nls_M231.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M231.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M231.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M231.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M231.", Mod.Sel1, sep ="")),
                 get(paste("nls_M231.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M231.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M231.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M231.", Mod.Sel1, sep ="")),
                    get(paste("nls_M231.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M231.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M231.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M231.", Mod.Sel1, sep ="")),
                      get(paste("nls_M231.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M231 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M231.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M231.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M231.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M231.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M231.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M231.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M231.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M231.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M231)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M231[!is.na(AIC2_M231$AIC) & AIC2_M231$AIC == min(AIC2_M231$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P[Best_mods.P$Code == "M231",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M231.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M231.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df[nls.param.df$Code == "M231",]$ge <- coefs["ge"]
nls.param.df[nls.param.df$Code == "M231",]$phi <- coefs["phi"]
nls.param.df[nls.param.df$Code == "M231",]$A <- coefs["A"]
nls.param.df[nls.param.df$Code == "M231",]$k <- coefs["k"]

nls.param.df[nls.param.df$Code == "M231",]$ge.2.5 <- intervals_low["ge"]
nls.param.df[nls.param.df$Code == "M231",]$phi.2.5 <- intervals_low["phi"]
nls.param.df[nls.param.df$Code == "M231",]$A.2.5 <- intervals_low["A"]
nls.param.df[nls.param.df$Code == "M231",]$k.2.5 <- intervals_low["k"]

nls.param.df[nls.param.df$Code == "M231",]$ge.97.5 <- intervals_high["ge"]
nls.param.df[nls.param.df$Code == "M231",]$phi.97.5 <- intervals_high["phi"]
nls.param.df[nls.param.df$Code == "M231",]$A.97.5 <- intervals_high["A"]
nls.param.df[nls.param.df$Code == "M231",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M231.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M231.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M231.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M231.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals
```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_M231 <- nlsResiduals(
  get(paste("nls_M231.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_M231)

## test residuals
if(length(P_M231$pltID) < 5001) {test.nlsResiduals(resid_M231)}

}  else {print("cannot plot residuals")}
```

## predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

P_M231_pred <- predict(get(paste("nls_M231.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME" = rep(mean(P_M231$MEASTIME, na.rm = T), max(P_M231$STDAGE)),
                                   "STDAGE" = seq(1, max(P_M231$STDAGE), by = 1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME" = rep(mean(P_M231$MEASTIME, na.rm = T), max(P_M231$STDAGE)),
                                   "STDAGE" = seq(1, max(P_M231$STDAGE), by = 1),
                                   "DeltaPDSI" = rep(mean(P_M231$DeltaPDSI, na.rm = T), max(P_M231$STDAGE)))
                      } )

P_M231_pred_df <- data.frame("STDAGE"=seq(1,max(P_M231$STDAGE),by = 1),  
                            "fitted"=P_M231_pred)

## plot
gg.M231 <- ggplot() +
          geom_point(aes(x = STDAGE, y = BIO_MgHa), data = P_M231, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE, y = BIO_MgHa), data = P_M231, 
                            fun.data = function(x) {
                              res <- quantile(x, probs = c(0.25,0.5,0.75))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M231))), breaks = cutvec_M231) +  
          
          #geom_ribbon(aes(x = STDAGE, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = P_M231_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE, y = fitted), data = P_M231_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("M231 - Ouachita Mixed Forest") + 
          
          #ylim(0, max(P_M231_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, cutvec_M231[20]*1.05), expand = c(0,0))

gg.M231

}  else {print("cannot plot data with prediction")}
```


## plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_M231 <- data.frame(
  bin = as.factor(levels(cut(P_M231$STDAGE, cutvec_M231))),
  data.mean = tapply(P_M231$BIO_MgHa, cut(P_M231$STDAGE, cutvec_M231), 
                     mean, na.rm = T), 
  data.CI.high =  tapply(P_M231$BIO_MgHa, cut(P_M231$STDAGE, cutvec_M231), 
                    high.CI), 
  data.CI.low = tapply(P_M231$BIO_MgHa, cut(P_M231$STDAGE, cutvec_M231),
                    low.CI), 
  pred.mean = P_M231_pred_df[P_M231_pred_df$STDAGE %in% bin_mids_M231,]$fitted) 
  # pred.CI.high = tapply(`M231_CI_df`$fitted, cut(`M231_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_M231$STDAGE, g=20))),
  #                      high.CI), 
  # pred.CI.low = tapply(`M231_CI_df`$fitted, cut(`M231_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_M231$STDAGE, g=20))),
  #                      low.CI))

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M231 <-  DM_compare_M231 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M231$bin)[gtools::mixedorder(levels(DM_compare_M231$bin))]))

## ggplot
gg.M231.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M231) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M231))), 
                              labels = levels(DM_compare_M231$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("M231 - Ouachita Mixed Forest") +         
           theme_classic() + 
           # xlim(min(DM_compare_M231$data.CI.low)-0.25, max(DM_compare_M231$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_M231$pred.CI.low)-0.25, max(DM_compare_M231$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M231.B2

}   else {print("cannot plot observed vs. predicted")}
```

# M242 - Cascade Mixed Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_M242 <- round(quantile(P_M242$STDAGE, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M242)))){
  cutvec_M242 <- round(quantile(P_M242$STDAGE, seq(0,1, length.out = 11)))
}

bin_mids_M242 <- unname(round(cutvec_M242[-length(cutvec_M242)] + diff(cutvec_M242)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
P_M242$STDAGE_bin<-  cut(P_M242$STDAGE, cutvec_M242)
## then get bin means
P_M242_bin_means <- tapply(P_M242$BIO_MgHa, cut(P_M242$STDAGE, cutvec_M242), mean)

## make column weights.2
P_M242$nls_weights.2 <- as.numeric(1/(P_M242_bin_means[match(P_M242$STDAGE_bin, names(P_M242_bin_means))])^2)

}
```

## model selection 1

```{r}
# simple
try(
  nls_M242.1 <- nls(f_1, data = P_M242, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = P_M242$nls_weights.2), 
 )

## phi
try(
  nls_M242.2 <- nls(f_2, data=P_M242, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = P_M242$nls_weights.2), 
 )

## test
if(exists("nls_M242.1") & exists("nls_M242.2")){
  print(anova(nls_M242.1, nls_M242.2))
}
 
## AIC comparison
AIC1_M242 <- data.frame(model = c(1,2), AIC = c(
            ifelse(exists("nls_M242.1"), AIC(get("nls_M242.1")), NA),
            ifelse(exists("nls_M242.2"), AIC(get("nls_M242.2")), NA)
            ))

print(AIC1_M242) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M242[!is.na(AIC1_M242$AIC) & AIC1_M242$AIC == min(AIC1_M242$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M242.",  Mod.Sel1, sep =""))) )  #model summary
```
### summary 
* simple model: `r ifelse(exists("nls_M242.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M242.2"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M242.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M242.",  Mod.Sel1, sep ="")))["phi"], 1)
A.fit <- round(coef(get(paste("nls_M242.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M242.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M242.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = P_M242,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              }, 
          weights = P_M242$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M242.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = P_M242,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              },
          weights = P_M242$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_M242.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = P_M242,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              }, 
          weights = P_M242$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M242.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M242.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M242.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M242.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M242.", Mod.Sel1, sep ="")),
             get(paste("nls_M242.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M242.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M242.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M242.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M242.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M242.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M242.", Mod.Sel1, sep ="")),
               get(paste("nls_M242.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M242.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M242.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M242.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M242.", Mod.Sel1, sep ="")),
                 get(paste("nls_M242.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M242.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M242.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M242.", Mod.Sel1, sep ="")),
                    get(paste("nls_M242.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M242.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M242.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M242.", Mod.Sel1, sep ="")),
                      get(paste("nls_M242.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M242 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M242.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M242.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M242.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M242.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M242.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M242.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M242.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M242.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M242)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M242[!is.na(AIC2_M242$AIC) & AIC2_M242$AIC == min(AIC2_M242$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P[Best_mods.P$Code == "M242",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M242.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M242.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df[nls.param.df$Code == "M242",]$ge <- coefs["ge"]
nls.param.df[nls.param.df$Code == "M242",]$phi <- coefs["phi"]
nls.param.df[nls.param.df$Code == "M242",]$A <- coefs["A"]
nls.param.df[nls.param.df$Code == "M242",]$k <- coefs["k"]

nls.param.df[nls.param.df$Code == "M242",]$ge.2.5 <- intervals_low["ge"]
nls.param.df[nls.param.df$Code == "M242",]$phi.2.5 <- intervals_low["phi"]
nls.param.df[nls.param.df$Code == "M242",]$A.2.5 <- intervals_low["A"]
nls.param.df[nls.param.df$Code == "M242",]$k.2.5 <- intervals_low["k"]

nls.param.df[nls.param.df$Code == "M242",]$ge.97.5 <- intervals_high["ge"]
nls.param.df[nls.param.df$Code == "M242",]$phi.97.5 <- intervals_high["phi"]
nls.param.df[nls.param.df$Code == "M242",]$A.97.5 <- intervals_high["A"]
nls.param.df[nls.param.df$Code == "M242",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M242.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M242.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M242.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M242.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals
```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_M242 <- nlsResiduals(
  get(paste("nls_M242.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_M242)

## test residuals
if(length(P_M242$pltID) < 5001) {test.nlsResiduals(resid_M242)}
 
}   else {print("cannot plot residuals")}
```

## predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

P_M242_pred <- predict(get(paste("nls_M242.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME" = rep(mean(P_M242$MEASTIME, na.rm = T), max(P_M242$STDAGE)),
                                   "STDAGE" = seq(1, max(P_M242$STDAGE), by = 1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME" = rep(mean(P_M242$MEASTIME, na.rm = T), max(P_M242$STDAGE)),
                                   "STDAGE" = seq(1, max(P_M242$STDAGE), by = 1),
                                   "DeltaPDSI" = rep(mean(P_M242$DeltaPDSI, na.rm = T), max(P_M242$STDAGE)))
                      } )

P_M242_pred_df <- data.frame("STDAGE"=seq(1,max(P_M242$STDAGE),by = 1),  
                            "fitted"=P_M242_pred)

## plot
gg.M242 <- ggplot() +
          geom_point(aes(x = STDAGE, y = BIO_MgHa), data = P_M242, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE, y = BIO_MgHa), data = P_M242, 
                            fun.data = function(x) {
                              res <- quantile(x, probs = c(0.25,0.5,0.75))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M242))), breaks = cutvec_M242) +  
          
          #geom_ribbon(aes(x = STDAGE, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = P_M242_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE, y = fitted), data = P_M242_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("M242 - Cascade Mixed Forest") + 
          
          #ylim(0, max(P_M242_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, cutvec_M242[20]*1.05), expand = c(0,0))

gg.M242

}  else {print("cannot plot data with prediction")}
```


## plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_M242 <- data.frame(
  bin = as.factor(levels(cut(P_M242$STDAGE, cutvec_M242))),
  data.mean = tapply(P_M242$BIO_MgHa, cut(P_M242$STDAGE, cutvec_M242), 
                     mean), 
  data.CI.high =  tapply(P_M242$BIO_MgHa, cut(P_M242$STDAGE, cutvec_M242), 
                    high.CI), 
  data.CI.low = tapply(P_M242$BIO_MgHa, cut(P_M242$STDAGE, cutvec_M242),
                    low.CI), 
  pred.mean = P_M242_pred_df[P_M242_pred_df$STDAGE %in% bin_mids_M242,]$fitted) 
  # pred.CI.high = tapply(`M242_CI_df`$fitted, cut(`M242_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_M242$STDAGE, g=20))),
  #                      high.CI), 
  # pred.CI.low = tapply(`M242_CI_df`$fitted, cut(`M242_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_M242$STDAGE, g=20))),
  #                      low.CI))

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M242 <-  DM_compare_M242 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M242$bin)[gtools::mixedorder(levels(DM_compare_M242$bin))]))

## ggplot
gg.M242.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M242) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M242))), 
                              labels = levels(DM_compare_M242$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("M242 - Cascade Mixed Forest") +         
           theme_classic() + 
           # xlim(min(DM_compare_M242$data.CI.low)-0.25, max(DM_compare_M242$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_M242$pred.CI.low)-0.25, max(DM_compare_M242$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M242.B2

}   else {print("cannot plot observed vs. predicted")}
```

# M261 - Sierran Steppe - Mixed Forest - Coniferous Forest - Alpine Meadow
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_M261 <- round(quantile(P_M261$STDAGE, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M261)))){
  cutvec_M261 <- round(quantile(P_M261$STDAGE, seq(0,1, length.out = 11)))
}

bin_mids_M261 <- unname(round(cutvec_M261[-length(cutvec_M261)] + diff(cutvec_M261)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
P_M261$STDAGE_bin<-  cut(P_M261$STDAGE, cutvec_M261)
## then get bin means
P_M261_bin_means <- tapply(P_M261$BIO_MgHa, cut(P_M261$STDAGE,  cutvec_M261), mean)

## make column weights.2
P_M261$nls_weights.2 <- as.numeric(1/(P_M261_bin_means[match(P_M261$STDAGE_bin, names(P_M261_bin_means))])^2)

}
```

## model selection 1

```{r}
# simple
try(
  nls_M261.1 <- nls(f_1, data = P_M261, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = P_M261$nls_weights.2), 
 )

## phi
try(
  nls_M261.2 <- nls(f_2, data=P_M261, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = P_M261$nls_weights.2), 
 )

## test
if(exists("nls_M261.1") & exists("nls_M261.2")){
  print(anova(nls_M261.1, nls_M261.2))
}
 
## AIC comparison
AIC1_M261 <- data.frame(model = c(1,2), AIC = c(
            ifelse(exists("nls_M261.1"), AIC(get("nls_M261.1")), NA),
            ifelse(exists("nls_M261.2"), AIC(get("nls_M261.2")), NA)
            ))

print(AIC1_M261) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M261[!is.na(AIC1_M261$AIC) & AIC1_M261$AIC == min(AIC1_M261$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M261.",  Mod.Sel1, sep =""))) )  #model summary
```
### summary 
* simple model: `r ifelse(exists("nls_M261.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M261.2"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M261.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M261.",  Mod.Sel1, sep ="")))["phi"], 1)
A.fit <- round(coef(get(paste("nls_M261.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M261.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M261.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = P_M261,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              }, 
          weights = P_M261$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M261.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = P_M261,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              },
          weights = P_M261$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_M261.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = P_M261,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              }, 
          weights = P_M261$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M261.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M261.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M261.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M261.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M261.", Mod.Sel1, sep ="")),
             get(paste("nls_M261.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M261.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M261.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M261.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M261.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M261.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M261.", Mod.Sel1, sep ="")),
               get(paste("nls_M261.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M261.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M261.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M261.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M261.", Mod.Sel1, sep ="")),
                 get(paste("nls_M261.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M261.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M261.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M261.", Mod.Sel1, sep ="")),
                    get(paste("nls_M261.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M261.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M261.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M261.", Mod.Sel1, sep ="")),
                      get(paste("nls_M261.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M261 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M261.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M261.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M261.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M261.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M261.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M261.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M261.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M261.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M261)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M261[!is.na(AIC2_M261$AIC) & AIC2_M261$AIC == min(AIC2_M261$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P[Best_mods.P$Code == "M261",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M261.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M261.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df[nls.param.df$Code == "M261",]$ge <- coefs["ge"]
nls.param.df[nls.param.df$Code == "M261",]$phi <- coefs["phi"]
nls.param.df[nls.param.df$Code == "M261",]$A <- coefs["A"]
nls.param.df[nls.param.df$Code == "M261",]$k <- coefs["k"]

nls.param.df[nls.param.df$Code == "M261",]$ge.2.5 <- intervals_low["ge"]
nls.param.df[nls.param.df$Code == "M261",]$phi.2.5 <- intervals_low["phi"]
nls.param.df[nls.param.df$Code == "M261",]$A.2.5 <- intervals_low["A"]
nls.param.df[nls.param.df$Code == "M261",]$k.2.5 <- intervals_low["k"]

nls.param.df[nls.param.df$Code == "M261",]$ge.97.5 <- intervals_high["ge"]
nls.param.df[nls.param.df$Code == "M261",]$phi.97.5 <- intervals_high["phi"]
nls.param.df[nls.param.df$Code == "M261",]$A.97.5 <- intervals_high["A"]
nls.param.df[nls.param.df$Code == "M261",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M261.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M261.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M261.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M261.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals
```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_M261 <- nlsResiduals(
  get(paste("nls_M261.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_M261)

## test residuals
if(length(P_M261$pltID) < 5001) {test.nlsResiduals(resid_M261)}

}   else {print("cannot plot residuals")}
```

## predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

P_M261_pred <- predict(get(paste("nls_M261.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME" = rep(mean(P_M261$MEASTIME, na.rm = T), max(P_M261$STDAGE)),
                                   "STDAGE" = seq(1, max(P_M261$STDAGE), by = 1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME" = rep(mean(P_M261$MEASTIME, na.rm = T), max(P_M261$STDAGE)),
                                   "STDAGE" = seq(1, max(P_M261$STDAGE), by = 1),
                                   "DeltaPDSI" = rep(mean(P_M261$DeltaPDSI, na.rm = T), max(P_M261$STDAGE)))
                      } )

P_M261_pred_df <- data.frame("STDAGE"=seq(1,max(P_M261$STDAGE),by = 1),  
                            "fitted"=P_M261_pred)

## plot
gg.M261 <- ggplot() +
          geom_point(aes(x = STDAGE, y = BIO_MgHa), data = P_M261, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE, y = BIO_MgHa), data = P_M261, 
                            fun.data = function(x) {
                              res <- quantile(x, probs = c(0.25,0.5,0.75))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M261))), breaks = cutvec_M261) +  
          
          #geom_ribbon(aes(x = STDAGE, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = P_M261_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE, y = fitted), data = P_M261_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("M261 - Sierran Steppe - Mixed Forest - Coniferous Forest - Alpine Meadow") + 
          
          #ylim(0, max(P_M261_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, cutvec_M261[20]*1.05), expand = c(0,0))

gg.M261

}  else {print("cannot plot data with prediction")}
```


## plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_M261 <- data.frame(
  bin = as.factor(levels(cut(P_M261$STDAGE, cutvec_M261))),
  data.mean = tapply(P_M261$BIO_MgHa, cut(P_M261$STDAGE, cutvec_M261), 
                     mean, na.rm = T), 
  data.CI.high =  tapply(P_M261$BIO_MgHa, cut(P_M261$STDAGE, cutvec_M261), 
                    high.CI), 
  data.CI.low = tapply(P_M261$BIO_MgHa, cut(P_M261$STDAGE, cutvec_M261),
                    low.CI), 
  pred.mean = P_M261_pred_df[P_M261_pred_df$STDAGE %in% bin_mids_M261,]$fitted) 
  # pred.CI.high = tapply(`M261_CI_df`$fitted, cut(`M261_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_M261$STDAGE, g=20))),
  #                      high.CI), 
  # pred.CI.low = tapply(`M261_CI_df`$fitted, cut(`M261_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_M261$STDAGE, g=20))),
  #                      low.CI))

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M261 <-  DM_compare_M261 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M261$bin)[gtools::mixedorder(levels(DM_compare_M261$bin))]))

## ggplot
gg.M261.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M261) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M261))), 
                              labels = levels(DM_compare_M261$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("M261 - Sierran Steppe - Mixed Forest - Coniferous Forest - Alpine Meadow") +         
           theme_classic() + 
           # xlim(min(DM_compare_M261$data.CI.low)-0.25, max(DM_compare_M261$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_M261$pred.CI.low)-0.25, max(DM_compare_M261$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M261.B2

}  else {print("cannot plot data with prediction")}
```

# M262 - California coastal range - coniferous forest - open woodland - shrub meadow
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_M262 <- round(quantile(P_M262$STDAGE, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M262)))){
  cutvec_M262 <- round(quantile(P_M262$STDAGE, seq(0,1, length.out = 11)))
}

bin_mids_M262 <- unname(round(cutvec_M262[-length(cutvec_M262)] + diff(cutvec_M262)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
P_M262$STDAGE_bin<-  cut(P_M262$STDAGE, cutvec_M262)
## then get bin means
P_M262_bin_means <- tapply(P_M262$BIO_MgHa, cut(P_M262$STDAGE,  cutvec_M262), mean)

## make column weights.2
P_M262$nls_weights.2 <- as.numeric(1/(P_M262_bin_means[match(P_M262$STDAGE_bin, names(P_M262_bin_means))])^2)

}
```
 
## model selection 1

```{r}
# simple
try(
  nls_M262.1 <- nls(f_1, data = P_M262, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = P_M262$nls_weights.2), 
 )

## phi
try(
  nls_M262.2 <- nls(f_2, data=P_M262, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = P_M262$nls_weights.2), 
 )

## test
if(exists("nls_M262.1") & exists("nls_M262.2")){
  print(anova(nls_M262.1, nls_M262.2))
}
 
## AIC comparison
AIC1_M262 <- data.frame(model = c(1,2), AIC = c(
            ifelse(exists("nls_M262.1"), AIC(get("nls_M262.1")), NA),
            ifelse(exists("nls_M262.2"), AIC(get("nls_M262.2")), NA)
            ))

print(AIC1_M262) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M262[!is.na(AIC1_M262$AIC) & AIC1_M262$AIC == min(AIC1_M262$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M262.",  Mod.Sel1, sep =""))) )  #model summary
```
### summary 
* simple model: `r ifelse(exists("nls_M262.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M262.2"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M262.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M262.",  Mod.Sel1, sep ="")))["phi"], 1)
A.fit <- round(coef(get(paste("nls_M262.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M262.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M262.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = P_M262,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              }, 
          weights = P_M262$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M262.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = P_M262,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              },
          weights = P_M262$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_M262.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = P_M262,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              }, 
          weights = P_M262$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M262.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M262.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M262.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M262.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M262.", Mod.Sel1, sep ="")),
             get(paste("nls_M262.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M262.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M262.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M262.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M262.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M262.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M262.", Mod.Sel1, sep ="")),
               get(paste("nls_M262.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M262.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M262.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M262.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M262.", Mod.Sel1, sep ="")),
                 get(paste("nls_M262.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M262.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M262.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M262.", Mod.Sel1, sep ="")),
                    get(paste("nls_M262.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M262.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M262.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M262.", Mod.Sel1, sep ="")),
                      get(paste("nls_M262.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M262 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M262.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M262.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M262.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M262.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M262.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M262.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M262.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M262.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M262)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M262[!is.na(AIC2_M262$AIC) & AIC2_M262$AIC == min(AIC2_M262$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P[Best_mods.P$Code == "M262",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M262.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M262.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df[nls.param.df$Code == "M262",]$ge <- coefs["ge"]
nls.param.df[nls.param.df$Code == "M262",]$phi <- coefs["phi"]
nls.param.df[nls.param.df$Code == "M262",]$A <- coefs["A"]
nls.param.df[nls.param.df$Code == "M262",]$k <- coefs["k"]

nls.param.df[nls.param.df$Code == "M262",]$ge.2.5 <- intervals_low["ge"]
nls.param.df[nls.param.df$Code == "M262",]$phi.2.5 <- intervals_low["phi"]
nls.param.df[nls.param.df$Code == "M262",]$A.2.5 <- intervals_low["A"]
nls.param.df[nls.param.df$Code == "M262",]$k.2.5 <- intervals_low["k"]

nls.param.df[nls.param.df$Code == "M262",]$ge.97.5 <- intervals_high["ge"]
nls.param.df[nls.param.df$Code == "M262",]$phi.97.5 <- intervals_high["phi"]
nls.param.df[nls.param.df$Code == "M262",]$A.97.5 <- intervals_high["A"]
nls.param.df[nls.param.df$Code == "M262",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M262.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M262.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M262.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M262.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals
```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_M262 <- nlsResiduals(
  get(paste("nls_M262.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_M262)

## test residuals
if(length(P_M262$pltID) < 5001) {test.nlsResiduals(resid_M262)}

}   else {print("cannot plot residuals")}
```

* model can fit - but K is negative  (only 19 observations) - model excluded

## predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

P_M262_pred <- predict(get(paste("nls_M262.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME" = rep(mean(P_M262$MEASTIME, na.rm = T), max(P_M262$STDAGE)),
                                   "STDAGE" = seq(1, max(P_M262$STDAGE), by = 1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME" = rep(mean(P_M262$MEASTIME, na.rm = T), max(P_M262$STDAGE)),
                                   "STDAGE" = seq(1, max(P_M262$STDAGE), by = 1),
                                   "DeltaPDSI" = rep(mean(P_M262$DeltaPDSI, na.rm = T), max(P_M262$STDAGE)))
                      } )

P_M262_pred_df <- data.frame("STDAGE"=seq(1,max(P_M262$STDAGE),by = 1),
                            "fitted"=P_M262_pred)

## plot
gg.M262 <- ggplot() +
          geom_point(aes(x = STDAGE, y = BIO_MgHa), data = P_M262, alpha = 0.5, shape ="+", col = "#60606080") +

          stat_summary_bin(aes(x = STDAGE, y = BIO_MgHa), data = P_M262,
                            fun.data = function(x) {
                              res <- quantile(x, probs = c(0.25,0.5,0.75))
                              names(res) <- c("ymin","y","ymax")
                              res},
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M262))), breaks = cutvec_M262) +

          #geom_ribbon(aes(x = STDAGE, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`),
                      #data = P_M262_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +

          geom_line(aes(x = STDAGE, y = fitted), data = P_M262_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) +


          theme_classic() +
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"),
               x = "Stand Age (yrs)") +  ggtitle("M262 - California coastal range - coniferous forest - open woodland - shrub meadow") +

          #ylim(0, max(P_M262_pred_df$`Prop.97.5%` + 0.25)) +
          scale_x_continuous(limits = c(0, cutvec_M262[20]*1.05), expand = c(0,0))

gg.M262

}  else {print("cannot plot data with prediction")}
```


## plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_M262 <- data.frame(
  bin = as.factor(levels(cut(P_M262$STDAGE, cutvec_M262))),
  data.mean = tapply(P_M262$BIO_MgHa, cut(P_M262$STDAGE, cutvec_M262),
                     mean, na.rm = T),
  data.CI.high =  tapply(P_M262$BIO_MgHa, cut(P_M262$STDAGE, cutvec_M262),
                    high.CI),
  data.CI.low = tapply(P_M262$BIO_MgHa, cut(P_M262$STDAGE, cutvec_M262),
                    low.CI),
  pred.mean = P_M262_pred_df[P_M262_pred_df$STDAGE %in% bin_mids_M262,]$fitted)
  # pred.CI.high = tapply(`M262_CI_df`$fitted, cut(`M262_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_M262$STDAGE, g=20))),
  #                      high.CI),
  # pred.CI.low = tapply(`M262_CI_df`$fitted, cut(`M262_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_M262$STDAGE, g=20))),
  #                      low.CI))

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY
DM_compare_M262 <-  DM_compare_M262 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M262$bin)[gtools::mixedorder(levels(DM_compare_M262$bin))]))

## ggplot
gg.M262.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M262) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M262))),
                              labels = levels(DM_compare_M262$bin),
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +
           labs(x = expression("observed biomass (Mg ha"^-1*")"),
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("M262 - California coastal range - coniferous forest - open woodland - shrub meadow") +
           theme_classic() +
           # xlim(min(DM_compare_M262$data.CI.low)-0.25, max(DM_compare_M262$data.CI.high)+0.25) +
           # ylim(min(DM_compare_M262$pred.CI.low)-0.25, max(DM_compare_M262$pred.CI.high)+0.25) +
           theme(legend.position = "top") + tune::coord_obs_pred()

gg.M262.B2

}
```

# M313 - Arizona-New Mexico Mountains Semi-Desert - Open Woodland - Coniferous Forest - Alpine Meadow
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_M313 <- round(quantile(P_M313$STDAGE, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M313)))){
  cutvec_M313 <- round(quantile(P_M313$STDAGE, seq(0,1, length.out = 11)))
}

bin_mids_M313 <- unname(round(cutvec_M313[-length(cutvec_M313)] + diff(cutvec_M313)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
P_M313$STDAGE_bin<-  cut(P_M313$STDAGE, cutvec_M313)
## then get bin means
P_M313_bin_means <- tapply(P_M313$BIO_MgHa, cut(P_M313$STDAGE,  cutvec_M313), mean)

## make column weights.2
P_M313$nls_weights.2 <- as.numeric(1/(P_M313_bin_means[match(P_M313$STDAGE_bin, names(P_M313_bin_means))])^2)

}
```

## model selection 1

```{r}
# simple
try(
  nls_M313.1 <- nls(f_1, data = P_M313, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = P_M313$nls_weights.2), 
 )

## phi
try(
  nls_M313.2 <- nls(f_2, data=P_M313, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = P_M313$nls_weights.2), 
 )

## test
if(exists("nls_M313.1") & exists("nls_M313.2")){
  print(anova(nls_M313.1, nls_M313.2))
}
 
## AIC comparison
AIC1_M313 <- data.frame(model = c(1,2), AIC = c(
            ifelse(exists("nls_M313.1"), AIC(get("nls_M313.1")), NA),
            ifelse(exists("nls_M313.2"), AIC(get("nls_M313.2")), NA)
            ))

print(AIC1_M313) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M313[!is.na(AIC1_M313$AIC) & AIC1_M313$AIC == min(AIC1_M313$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M313.",  Mod.Sel1, sep =""))) )  #model summary
```
### summary 
* simple model: `r ifelse(exists("nls_M313.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M313.2"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M313.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M313.",  Mod.Sel1, sep ="")))["phi"], 1)
A.fit <- round(coef(get(paste("nls_M313.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M313.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M313.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = P_M313,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              }, 
          weights = P_M313$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M313.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = P_M313,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              },
          weights = P_M313$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_M313.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = P_M313,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              }, 
          weights = P_M313$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M313.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M313.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M313.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M313.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M313.", Mod.Sel1, sep ="")),
             get(paste("nls_M313.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M313.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M313.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M313.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M313.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M313.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M313.", Mod.Sel1, sep ="")),
               get(paste("nls_M313.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M313.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M313.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M313.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M313.", Mod.Sel1, sep ="")),
                 get(paste("nls_M313.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M313.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M313.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M313.", Mod.Sel1, sep ="")),
                    get(paste("nls_M313.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M313.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M313.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M313.", Mod.Sel1, sep ="")),
                      get(paste("nls_M313.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M313 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M313.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M313.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M313.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M313.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M313.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M313.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M313.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M313.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M313)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M313[!is.na(AIC2_M313$AIC) & AIC2_M313$AIC == min(AIC2_M313$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P[Best_mods.P$Code == "M313",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M313.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M313.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df[nls.param.df$Code == "M313",]$ge <- coefs["ge"]
nls.param.df[nls.param.df$Code == "M313",]$phi <- coefs["phi"]
nls.param.df[nls.param.df$Code == "M313",]$A <- coefs["A"]
nls.param.df[nls.param.df$Code == "M313",]$k <- coefs["k"]

nls.param.df[nls.param.df$Code == "M313",]$ge.2.5 <- intervals_low["ge"]
nls.param.df[nls.param.df$Code == "M313",]$phi.2.5 <- intervals_low["phi"]
nls.param.df[nls.param.df$Code == "M313",]$A.2.5 <- intervals_low["A"]
nls.param.df[nls.param.df$Code == "M313",]$k.2.5 <- intervals_low["k"]

nls.param.df[nls.param.df$Code == "M313",]$ge.97.5 <- intervals_high["ge"]
nls.param.df[nls.param.df$Code == "M313",]$phi.97.5 <- intervals_high["phi"]
nls.param.df[nls.param.df$Code == "M313",]$A.97.5 <- intervals_high["A"]
nls.param.df[nls.param.df$Code == "M313",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M313.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M313.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M313.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M313.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals
```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {
  
## calculate residuals
resid_M313 <- nlsResiduals(
  get(paste("nls_M313.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_M313)

## test residuals
if(length(P_M313$pltID) < 5001) {test.nlsResiduals(resid_M313)}

}   else {print("cannot plot residuals")}
```


## predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

P_M313_pred <- predict(get(paste("nls_M313.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME" = rep(mean(P_M313$MEASTIME, na.rm = T), max(P_M313$STDAGE)),
                                   "STDAGE" = seq(1, max(P_M313$STDAGE), by = 1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME" = rep(mean(P_M313$MEASTIME, na.rm = T), max(P_M313$STDAGE)),
                                   "STDAGE" = seq(1, max(P_M313$STDAGE), by = 1),
                                   "DeltaPDSI" = rep(mean(P_M313$DeltaPDSI, na.rm = T), max(P_M313$STDAGE)))
                      } )

P_M313_pred_df <- data.frame("STDAGE"=seq(1,max(P_M313$STDAGE),by = 1),  
                            "fitted"=P_M313_pred)

## plot
gg.M313 <- ggplot() +
          geom_point(aes(x = STDAGE, y = BIO_MgHa), data = P_M313, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE, y = BIO_MgHa), data = P_M313, 
                            fun.data = function(x) {
                              res <- quantile(x, probs = c(0.25,0.5,0.75))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M313))), breaks = cutvec_M313) +  
          
          #geom_ribbon(aes(x = STDAGE, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = P_M313_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE, y = fitted), data = P_M313_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("M313 - Arizona-New Mexico Mountains Semi-Desert - Open Woodland - Coniferous Forest - Alpine Meadow") + 
          
          #ylim(0, max(P_M313_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, cutvec_M313[20]*1.05), expand = c(0,0))

gg.M313

}  else {print("cannot plot data with prediction")}
```


## plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_M313 <- data.frame(
  bin = as.factor(levels(cut(P_M313$STDAGE, cutvec_M313))),
  data.mean = tapply(P_M313$BIO_MgHa, cut(P_M313$STDAGE, cutvec_M313), 
                     mean, na.rm = T), 
  data.CI.high =  tapply(P_M313$BIO_MgHa, cut(P_M313$STDAGE, cutvec_M313), 
                    high.CI), 
  data.CI.low = tapply(P_M313$BIO_MgHa, cut(P_M313$STDAGE, cutvec_M313),
                    low.CI), 
  pred.mean = P_M313_pred_df[P_M313_pred_df$STDAGE %in% bin_mids_M313,]$fitted) 
  # pred.CI.high = tapply(`M313_CI_df`$fitted, cut(`M313_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_M313$STDAGE, g=20))),
  #                      high.CI), 
  # pred.CI.low = tapply(`M313_CI_df`$fitted, cut(`M313_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_M313$STDAGE, g=20))),
  #                      low.CI))

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M313 <-  DM_compare_M313 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M313$bin)[gtools::mixedorder(levels(DM_compare_M313$bin))]))

## ggplot
gg.M313.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M313) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M313))), 
                              labels = levels(DM_compare_M313$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("M313 - Arizona-New Mexico Mountains Semi-Desert - Open Woodland - Coniferous Forest - Alpine Meadow") +         
           theme_classic() + 
           # xlim(min(DM_compare_M313$data.CI.low)-0.25, max(DM_compare_M313$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_M313$pred.CI.low)-0.25, max(DM_compare_M313$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M313.B2

}
```

# M331 - Southern Rocky Mountain Steppe - Open Woodland - Coniferous Forest - Alpine Meadow
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_M331 <- round(quantile(P_M331$STDAGE, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M331)))){
  cutvec_M331 <- round(quantile(P_M331$STDAGE, seq(0,1, length.out = 11)))
}

bin_mids_M331 <- unname(round(cutvec_M331[-length(cutvec_M331)] + diff(cutvec_M331)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
P_M331$STDAGE_bin<-  cut(P_M331$STDAGE, cutvec_M313)
## then get bin means
P_M331_bin_means <- tapply(P_M331$BIO_MgHa, cut(P_M331$STDAGE,  cutvec_M313), mean)

## make column weights.2
P_M331$nls_weights.2 <- as.numeric(1/(P_M331_bin_means[match(P_M331$STDAGE_bin, names(P_M331_bin_means))])^2)

}
```

## model selection 1

```{r}
# simple
try(
  nls_M331.1 <- nls(f_1, data = P_M331, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = P_M331$nls_weights.2), 
 )

## phi
try(
  nls_M331.2 <- nls(f_2, data=P_M331, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = P_M331$nls_weights.2), 
 )

## test
if(exists("nls_M331.1") & exists("nls_M331.2")){
  print(anova(nls_M331.1, nls_M331.2))
}
 
## AIC comparison
AIC1_M331 <- data.frame(model = c(1,2), AIC = c(
            ifelse(exists("nls_M331.1"), AIC(get("nls_M331.1")), NA),
            ifelse(exists("nls_M331.2"), AIC(get("nls_M331.2")), NA)
            ))

print(AIC1_M331) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M331[!is.na(AIC1_M331$AIC) & AIC1_M331$AIC == min(AIC1_M331$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M331.",  Mod.Sel1, sep =""))) )  #model summary
```
### summary 
* simple model: `r ifelse(exists("nls_M331.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M331.2"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M331.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M331.",  Mod.Sel1, sep ="")))["phi"], 1)
A.fit <- round(coef(get(paste("nls_M331.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M331.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M331.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = P_M331,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              }, 
          weights = P_M331$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M331.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = P_M331,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              },
          weights = P_M331$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_M331.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = P_M331,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              }, 
          weights = P_M331$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M331.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M331.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M331.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M331.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M331.", Mod.Sel1, sep ="")),
             get(paste("nls_M331.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M331.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M331.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M331.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M331.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M331.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M331.", Mod.Sel1, sep ="")),
               get(paste("nls_M331.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M331.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M331.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M331.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M331.", Mod.Sel1, sep ="")),
                 get(paste("nls_M331.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M331.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M331.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M331.", Mod.Sel1, sep ="")),
                    get(paste("nls_M331.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M331.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M331.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M331.", Mod.Sel1, sep ="")),
                      get(paste("nls_M331.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M331 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M331.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M331.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M331.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M331.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M331.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M331.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M331.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M331.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M331)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M331[!is.na(AIC2_M331$AIC) & AIC2_M331$AIC == min(AIC2_M331$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P[Best_mods.P$Code == "M331",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M331.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M331.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df[nls.param.df$Code == "M331",]$ge <- coefs["ge"]
nls.param.df[nls.param.df$Code == "M331",]$phi <- coefs["phi"]
nls.param.df[nls.param.df$Code == "M331",]$A <- coefs["A"]
nls.param.df[nls.param.df$Code == "M331",]$k <- coefs["k"]

nls.param.df[nls.param.df$Code == "M331",]$ge.2.5 <- intervals_low["ge"]
nls.param.df[nls.param.df$Code == "M331",]$phi.2.5 <- intervals_low["phi"]
nls.param.df[nls.param.df$Code == "M331",]$A.2.5 <- intervals_low["A"]
nls.param.df[nls.param.df$Code == "M331",]$k.2.5 <- intervals_low["k"]

nls.param.df[nls.param.df$Code == "M331",]$ge.97.5 <- intervals_high["ge"]
nls.param.df[nls.param.df$Code == "M331",]$phi.97.5 <- intervals_high["phi"]
nls.param.df[nls.param.df$Code == "M331",]$A.97.5 <- intervals_high["A"]
nls.param.df[nls.param.df$Code == "M331",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M331.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M331.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M331.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M331.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals
```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {
  
## calculate residuals
resid_M331 <- nlsResiduals(
  get(paste("nls_M331.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_M331)

## test residuals
if(length(P_M331$pltID) < 5001) {test.nlsResiduals(resid_M331)}

}   else {print("cannot plot residuals")}
```

## predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

P_M331_pred <- predict(get(paste("nls_M331.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME" = rep(mean(P_M331$MEASTIME, na.rm = T), max(P_M331$STDAGE)),
                                   "STDAGE" = seq(1, max(P_M331$STDAGE), by = 1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME" = rep(mean(P_M331$MEASTIME, na.rm = T), max(P_M331$STDAGE)),
                                   "STDAGE" = seq(1, max(P_M331$STDAGE), by = 1),
                                   "DeltaPDSI" = rep(mean(P_M331$DeltaPDSI, na.rm = T), max(P_M331$STDAGE)))
                      } )


P_M331_pred_df <- data.frame("STDAGE"=seq(1,max(P_M331$STDAGE),by = 1),  
                            "fitted"=P_M331_pred)

## plot
gg.M331 <- ggplot() +
          geom_point(aes(x = STDAGE, y = BIO_MgHa), data = P_M331, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE, y = BIO_MgHa), data = P_M331, 
                            fun.data = function(x) {
                              res <- quantile(x, probs = c(0.25,0.5,0.75))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M331))), breaks = cutvec_M331) +  
          
          #geom_ribbon(aes(x = STDAGE, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = P_M331_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE, y = fitted), data = P_M331_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("M331 - Southern Rocky Mountain Steppe - Open Woodland - Coniferous Forest - Alpine Meadow") + 
          
          #ylim(0, max(P_M331_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, cutvec_M331[20]*1.05), expand = c(0,0))

gg.M331

}  else {print("cannot plot data with prediction")}
```


## plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_M331 <- data.frame(
  bin = as.factor(levels(cut(P_M331$STDAGE, cutvec_M331))),
  data.mean = tapply(P_M331$BIO_MgHa, cut(P_M331$STDAGE, cutvec_M331), 
                     mean, na.rm = T), 
  data.CI.high =  tapply(P_M331$BIO_MgHa, cut(P_M331$STDAGE, cutvec_M331), 
                    high.CI), 
  data.CI.low = tapply(P_M331$BIO_MgHa, cut(P_M331$STDAGE, cutvec_M331),
                    low.CI), 
  pred.mean = P_M331_pred_df[P_M331_pred_df$STDAGE %in% bin_mids_M331,]$fitted) 
  # pred.CI.high = tapply(`M331_CI_df`$fitted, cut(`M331_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_M331$STDAGE, g=20))),
  #                      high.CI), 
  # pred.CI.low = tapply(`M331_CI_df`$fitted, cut(`M331_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_M331$STDAGE, g=20))),
  #                      low.CI))

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M331 <-  DM_compare_M331 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M331$bin)[gtools::mixedorder(levels(DM_compare_M331$bin))]))

## ggplot
gg.M331.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M331) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M331))), 
                              labels = levels(DM_compare_M331$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("M331 - Southern Rocky Mountain Steppe - Open Woodland - Coniferous Forest - Alpine Meadow") +         
           theme_classic() + 
           # xlim(min(DM_compare_M331$data.CI.low)-0.25, max(DM_compare_M331$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_M331$pred.CI.low)-0.25, max(DM_compare_M331$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M331.B2

}
```

# M332 - Middle Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_M332 <- round(quantile(P_M332$STDAGE, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M332)))){
  cutvec_M332 <- round(quantile(P_M332$STDAGE, seq(0,1, length.out = 11)))
}

bin_mids_M332 <- unname(round(cutvec_M332[-length(cutvec_M332)] + diff(cutvec_M332)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
P_M332$STDAGE_bin<-  cut(P_M332$STDAGE, cutvec_M332)
## then get bin means
P_M332_bin_means <- tapply(P_M332$BIO_MgHa, cut(P_M332$STDAGE,  cutvec_M332), mean)

## make column weights.2
P_M332$nls_weights.2 <- as.numeric(1/(P_M332_bin_means[match(P_M332$STDAGE_bin, names(P_M332_bin_means))])^2)

}
```

## model selection 1

```{r}
# simple
try(
  nls_M332.1 <- nls(f_1, data = P_M332, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = P_M332$nls_weights.2), 
 )

## phi
try(
  nls_M332.2 <- nls(f_2, data=P_M332, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = P_M332$nls_weights.2), 
 )

## test
if(exists("nls_M332.1") & exists("nls_M332.2")){
  print(anova(nls_M332.1, nls_M332.2))
}
 
## AIC comparison
AIC1_M332 <- data.frame(model = c(1,2), AIC = c(
            ifelse(exists("nls_M332.1"), AIC(get("nls_M332.1")), NA),
            ifelse(exists("nls_M332.2"), AIC(get("nls_M332.2")), NA)
            ))

print(AIC1_M332) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M332[!is.na(AIC1_M332$AIC) & AIC1_M332$AIC == min(AIC1_M332$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M332.",  Mod.Sel1, sep =""))) )  #model summary
```
### summary 
* simple model: `r ifelse(exists("nls_M332.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M332.2"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M332.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M332.",  Mod.Sel1, sep ="")))["phi"], 1)
A.fit <- round(coef(get(paste("nls_M332.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M332.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M332.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = P_M332,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              }, 
          weights = P_M332$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M332.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = P_M332,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              },
          weights = P_M332$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_M332.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = P_M332,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              }, 
          weights = P_M332$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M332.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M332.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M332.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M332.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M332.", Mod.Sel1, sep ="")),
             get(paste("nls_M332.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M332.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M332.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M332.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M332.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M332.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M332.", Mod.Sel1, sep ="")),
               get(paste("nls_M332.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M332.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M332.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M332.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M332.", Mod.Sel1, sep ="")),
                 get(paste("nls_M332.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M332.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M332.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M332.", Mod.Sel1, sep ="")),
                    get(paste("nls_M332.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M332.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M332.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M332.", Mod.Sel1, sep ="")),
                      get(paste("nls_M332.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M332 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M332.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M332.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M332.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M332.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M332.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M332.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M332.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M332.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M332)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M332[!is.na(AIC2_M332$AIC) & AIC2_M332$AIC == min(AIC2_M332$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P[Best_mods.P$Code == "M332",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M332.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M332.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df[nls.param.df$Code == "M332",]$ge <- coefs["ge"]
nls.param.df[nls.param.df$Code == "M332",]$phi <- coefs["phi"]
nls.param.df[nls.param.df$Code == "M332",]$A <- coefs["A"]
nls.param.df[nls.param.df$Code == "M332",]$k <- coefs["k"]

nls.param.df[nls.param.df$Code == "M332",]$ge.2.5 <- intervals_low["ge"]
nls.param.df[nls.param.df$Code == "M332",]$phi.2.5 <- intervals_low["phi"]
nls.param.df[nls.param.df$Code == "M332",]$A.2.5 <- intervals_low["A"]
nls.param.df[nls.param.df$Code == "M332",]$k.2.5 <- intervals_low["k"]

nls.param.df[nls.param.df$Code == "M332",]$ge.97.5 <- intervals_high["ge"]
nls.param.df[nls.param.df$Code == "M332",]$phi.97.5 <- intervals_high["phi"]
nls.param.df[nls.param.df$Code == "M332",]$A.97.5 <- intervals_high["A"]
nls.param.df[nls.param.df$Code == "M332",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M332.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M332.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M332.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M332.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals
```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_M332 <- nlsResiduals(
  get(paste("nls_M332.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_M332)

## test residuals
if(length(P_M332$pltID) < 5001) {test.nlsResiduals(resid_M332)}

}   else {print("cannot plot residuals")}
```

## predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

P_M332_pred <- predict(get(paste("nls_M332.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME" = rep(mean(P_M332$MEASTIME, na.rm = T), max(P_M332$STDAGE)),
                                   "STDAGE" = seq(1, max(P_M332$STDAGE), by = 1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME" = rep(mean(P_M332$MEASTIME, na.rm = T), max(P_M332$STDAGE)),
                                   "STDAGE" = seq(1, max(P_M332$STDAGE), by = 1),
                                   "DeltaPDSI" = rep(mean(P_M332$DeltaPDSI, na.rm = T), max(P_M332$STDAGE)))
                      } )

P_M332_pred_df <- data.frame("STDAGE"=seq(1,max(P_M332$STDAGE),by = 1),  
                            "fitted"=P_M332_pred)

## plot
gg.M332 <- ggplot() +
          geom_point(aes(x = STDAGE, y = BIO_MgHa), data = P_M332, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE, y = BIO_MgHa), data = P_M332, 
                            fun.data = function(x) {
                              res <- quantile(x, probs = c(0.25,0.5,0.75))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M332))), breaks = cutvec_M332) +  
          
          #geom_ribbon(aes(x = STDAGE, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = P_M332_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE, y = fitted), data = P_M332_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("M332 - Middle Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow") + 
          
          #ylim(0, max(P_M332_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, cutvec_M332[20]*1.05), expand = c(0,0))

gg.M332

}  else {print("cannot plot data with prediction")}
```


## plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_M332 <- data.frame(
  bin = as.factor(levels(cut(P_M332$STDAGE, cutvec_M332))),
  data.mean = tapply(P_M332$BIO_MgHa, cut(P_M332$STDAGE, cutvec_M332), 
                     mean, na.rm = T), 
  data.CI.high =  tapply(P_M332$BIO_MgHa, cut(P_M332$STDAGE, cutvec_M332), 
                    high.CI), 
  data.CI.low = tapply(P_M332$BIO_MgHa, cut(P_M332$STDAGE, cutvec_M332),
                    low.CI), 
  pred.mean = P_M332_pred_df[P_M332_pred_df$STDAGE %in% bin_mids_M332,]$fitted) 
  # pred.CI.high = tapply(`M332_CI_df`$fitted, cut(`M332_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_M332$STDAGE, g=20))),
  #                      high.CI), 
  # pred.CI.low = tapply(`M332_CI_df`$fitted, cut(`M332_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_M332$STDAGE, g=20))),
  #                      low.CI))

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M332 <-  DM_compare_M332 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M332$bin)[gtools::mixedorder(levels(DM_compare_M332$bin))]))

## ggplot
gg.M332.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M332) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M332))), 
                              labels = levels(DM_compare_M332$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("M332 - Middle Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow") +         
           theme_classic() + 
           # xlim(min(DM_compare_M332$data.CI.low)-0.25, max(DM_compare_M332$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_M332$pred.CI.low)-0.25, max(DM_compare_M332$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M332.B2

}
```

# M333 - Northern Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_M333 <- round(quantile(P_M333$STDAGE, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M333)))){
  cutvec_M333 <- round(quantile(P_M333$STDAGE, seq(0,1, length.out = 11)))
}

bin_mids_M333 <- unname(round(cutvec_M333[-length(cutvec_M333)] + diff(cutvec_M333)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
P_M333$STDAGE_bin<-  cut(P_M333$STDAGE, cutvec_M333)
## then get bin means
P_M333_bin_means <- tapply(P_M333$BIO_MgHa, cut(P_M333$STDAGE, cutvec_M333), mean)

## make column weights.2
P_M333$nls_weights.2 <- as.numeric(1/(P_M333_bin_means[match(P_M333$STDAGE_bin, names(P_M333_bin_means))])^2)

}
```

## model selection 1

```{r}
# simple
try(
  nls_M333.1 <- nls(f_1, data = P_M333, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = P_M333$nls_weights.2), 
 )

## phi
try(
  nls_M333.2 <- nls(f_2, data=P_M333, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = P_M333$nls_weights.2), 
 )

## test
if(exists("nls_M333.1") & exists("nls_M333.2")){
  print(anova(nls_M333.1, nls_M333.2))
}
 
## AIC comparison
AIC1_M333 <- data.frame(model = c(1,2), AIC = c(
            ifelse(exists("nls_M333.1"), AIC(get("nls_M333.1")), NA),
            ifelse(exists("nls_M333.2"), AIC(get("nls_M333.2")), NA)
            ))

print(AIC1_M333) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M333[!is.na(AIC1_M333$AIC) & AIC1_M333$AIC == min(AIC1_M333$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M333.",  Mod.Sel1, sep =""))) )  #model summary
```
### summary 
* simple model: `r ifelse(exists("nls_M333.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M333.2"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M333.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M333.",  Mod.Sel1, sep ="")))["phi"], 1)
A.fit <- round(coef(get(paste("nls_M333.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M333.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M333.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = P_M333,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              }, 
          weights = P_M333$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M333.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = P_M333,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              },
          weights = P_M333$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_M333.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = P_M333,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              }, 
          weights = P_M333$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M333.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M333.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M333.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M333.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M333.", Mod.Sel1, sep ="")),
             get(paste("nls_M333.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M333.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M333.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M333.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M333.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M333.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M333.", Mod.Sel1, sep ="")),
               get(paste("nls_M333.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M333.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M333.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M333.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M333.", Mod.Sel1, sep ="")),
                 get(paste("nls_M333.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M333.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M333.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M333.", Mod.Sel1, sep ="")),
                    get(paste("nls_M333.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M333.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M333.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M333.", Mod.Sel1, sep ="")),
                      get(paste("nls_M333.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M333 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M333.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M333.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M333.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M333.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M333.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M333.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M333.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M333.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M333)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M333[!is.na(AIC2_M333$AIC) & AIC2_M333$AIC == min(AIC2_M333$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P[Best_mods.P$Code == "M333",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M333.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M333.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df[nls.param.df$Code == "M333",]$ge <- coefs["ge"]
nls.param.df[nls.param.df$Code == "M333",]$phi <- coefs["phi"]
nls.param.df[nls.param.df$Code == "M333",]$A <- coefs["A"]
nls.param.df[nls.param.df$Code == "M333",]$k <- coefs["k"]

nls.param.df[nls.param.df$Code == "M333",]$ge.2.5 <- intervals_low["ge"]
nls.param.df[nls.param.df$Code == "M333",]$phi.2.5 <- intervals_low["phi"]
nls.param.df[nls.param.df$Code == "M333",]$A.2.5 <- intervals_low["A"]
nls.param.df[nls.param.df$Code == "M333",]$k.2.5 <- intervals_low["k"]

nls.param.df[nls.param.df$Code == "M333",]$ge.97.5 <- intervals_high["ge"]
nls.param.df[nls.param.df$Code == "M333",]$phi.97.5 <- intervals_high["phi"]
nls.param.df[nls.param.df$Code == "M333",]$A.97.5 <- intervals_high["A"]
nls.param.df[nls.param.df$Code == "M333",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M333.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M333.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M333.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M333.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals
```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_M333 <- nlsResiduals(
  get(paste("nls_M333.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_M333)

## test residuals
if(length(P_M333$pltID) < 5001) {test.nlsResiduals(resid_M333)}

}   else {print("cannot plot residuals")}
```

## predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

P_M333_pred <- predict(get(paste("nls_M333.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME" = rep(mean(P_M333$MEASTIME, na.rm = T), max(P_M333$STDAGE)),
                                   "STDAGE" = seq(1, max(P_M333$STDAGE), by = 1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME" = rep(mean(P_M333$MEASTIME, na.rm = T), max(P_M333$STDAGE)),
                                   "STDAGE" = seq(1, max(P_M333$STDAGE), by = 1),
                                   "DeltaPDSI" = rep(mean(P_M333$DeltaPDSI, na.rm = T), max(P_M333$STDAGE)))
                      } )

P_M333_pred_df <- data.frame("STDAGE"=seq(1,max(P_M333$STDAGE),by = 1),  
                            "fitted"=P_M333_pred)

## plot
gg.M333 <- ggplot() +
          geom_point(aes(x = STDAGE, y = BIO_MgHa), data = P_M333, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE, y = BIO_MgHa), data = P_M333, 
                            fun.data = function(x) {
                              res <- quantile(x, probs = c(0.25,0.5,0.75))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M333))), breaks = cutvec_M333) +  
          
          #geom_ribbon(aes(x = STDAGE, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = P_M333_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE, y = fitted), data = P_M333_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("M333 - Northern Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow") + 
          
          #ylim(0, max(P_M333_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, cutvec_M333[20]*1.05), expand = c(0,0))

gg.M333

}  else {print("cannot plot data with prediction")}
```


## plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_M333 <- data.frame(
  bin = as.factor(levels(cut(P_M333$STDAGE, cutvec_M333))),
  data.mean = tapply(P_M333$BIO_MgHa, cut(P_M333$STDAGE, cutvec_M333), 
                     mean, na.rm = T), 
  data.CI.high =  tapply(P_M333$BIO_MgHa, cut(P_M333$STDAGE, cutvec_M333), 
                    high.CI), 
  data.CI.low = tapply(P_M333$BIO_MgHa, cut(P_M333$STDAGE, cutvec_M333),
                    low.CI), 
  pred.mean = P_M333_pred_df[P_M333_pred_df$STDAGE %in% bin_mids_M333,]$fitted) 
  # pred.CI.high = tapply(`M333_CI_df`$fitted, cut(`M333_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_M333$STDAGE, g=20))),
  #                      high.CI), 
  # pred.CI.low = tapply(`M333_CI_df`$fitted, cut(`M333_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_M333$STDAGE, g=20))),
  #                      low.CI))

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M333 <-  DM_compare_M333 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M333$bin)[gtools::mixedorder(levels(DM_compare_M333$bin))]))

## ggplot
gg.M333.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M333) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M333))), 
                              labels = levels(DM_compare_M333$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("M333 - Northern Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow") +         
           theme_classic() + 
           # xlim(min(DM_compare_M333$data.CI.low)-0.25, max(DM_compare_M333$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_M333$pred.CI.low)-0.25, max(DM_compare_M333$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M333.B2

}
```

# M334 - Black Hills Coniferous Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_M334 <- round(quantile(P_M334$STDAGE, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M334)))){
  cutvec_M334 <- round(quantile(P_M334$STDAGE, seq(0,1, length.out = 11)))
}

bin_mids_M334 <- unname(round(cutvec_M334[-length(cutvec_M334)] + diff(cutvec_M334)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
P_M334$STDAGE_bin<-  cut(P_M334$STDAGE, cutvec_M334)
## then get bin means
P_M334_bin_means <- tapply(P_M334$BIO_MgHa, cut(P_M334$STDAGE,  cutvec_M334), mean)

## make column weights.2
P_M334$nls_weights.2 <- as.numeric(1/(P_M334_bin_means[match(P_M334$STDAGE_bin, names(P_M334_bin_means))])^2)

}
```

## model selection 1

```{r}
# simple
try(
  nls_M334.1 <- nls(f_1, data = P_M334, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = P_M334$nls_weights.2), 
 )

## phi
try(
  nls_M334.2 <- nls(f_2, data=P_M334, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = P_M334$nls_weights.2), 
 )

## test
if(exists("nls_M334.1") & exists("nls_M334.2")){
  print(anova(nls_M334.1, nls_M334.2))
}
 
## AIC comparison
AIC1_M334 <- data.frame(model = c(1,2), AIC = c(
            ifelse(exists("nls_M334.1"), AIC(get("nls_M334.1")), NA),
            ifelse(exists("nls_M334.2"), AIC(get("nls_M334.2")), NA)
            ))

print(AIC1_M334) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M334[!is.na(AIC1_M334$AIC) & AIC1_M334$AIC == min(AIC1_M334$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M334.",  Mod.Sel1, sep =""))) )  #model summary
```
### summary 
* simple model: `r ifelse(exists("nls_M334.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M334.2"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M334.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M334.",  Mod.Sel1, sep ="")))["phi"], 1)
A.fit <- round(coef(get(paste("nls_M334.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M334.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M334.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = P_M334,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              }, 
          weights = P_M334$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M334.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = P_M334,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              },
          weights = P_M334$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_M334.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = P_M334,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              }, 
          weights = P_M334$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M334.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M334.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M334.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M334.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M334.", Mod.Sel1, sep ="")),
             get(paste("nls_M334.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M334.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M334.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M334.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M334.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M334.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M334.", Mod.Sel1, sep ="")),
               get(paste("nls_M334.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M334.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M334.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M334.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M334.", Mod.Sel1, sep ="")),
                 get(paste("nls_M334.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M334.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M334.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M334.", Mod.Sel1, sep ="")),
                    get(paste("nls_M334.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M334.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M334.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M334.", Mod.Sel1, sep ="")),
                      get(paste("nls_M334.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M334 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M334.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M334.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M334.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M334.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M334.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M334.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M334.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M334.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M334)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M334[!is.na(AIC2_M334$AIC) & AIC2_M334$AIC == min(AIC2_M334$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P[Best_mods.P$Code == "M334",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M334.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M334.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df[nls.param.df$Code == "M334",]$ge <- coefs["ge"]
nls.param.df[nls.param.df$Code == "M334",]$phi <- coefs["phi"]
nls.param.df[nls.param.df$Code == "M334",]$A <- coefs["A"]
nls.param.df[nls.param.df$Code == "M334",]$k <- coefs["k"]

nls.param.df[nls.param.df$Code == "M334",]$ge.2.5 <- intervals_low["ge"]
nls.param.df[nls.param.df$Code == "M334",]$phi.2.5 <- intervals_low["phi"]
nls.param.df[nls.param.df$Code == "M334",]$A.2.5 <- intervals_low["A"]
nls.param.df[nls.param.df$Code == "M334",]$k.2.5 <- intervals_low["k"]

nls.param.df[nls.param.df$Code == "M334",]$ge.97.5 <- intervals_high["ge"]
nls.param.df[nls.param.df$Code == "M334",]$phi.97.5 <- intervals_high["phi"]
nls.param.df[nls.param.df$Code == "M334",]$A.97.5 <- intervals_high["A"]
nls.param.df[nls.param.df$Code == "M334",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M334.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M334.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M334.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M334.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals
```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_M334 <- nlsResiduals(
  get(paste("nls_M334.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_M334)

## test residuals
if(length(P_M334$pltID) < 5001) {test.nlsResiduals(resid_M334)}

}   else {print("cannot plot residuals")}
```

## predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

P_M334_pred <- predict(get(paste("nls_M334.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME" = rep(mean(P_M334$MEASTIME, na.rm = T), max(P_M334$STDAGE)),
                                   "STDAGE" = seq(1, max(P_M334$STDAGE), by = 1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME" = rep(mean(P_M334$MEASTIME, na.rm = T), max(P_M334$STDAGE)),
                                   "STDAGE" = seq(1, max(P_M334$STDAGE), by = 1),
                                   "DeltaPDSI" = rep(mean(P_M334$DeltaPDSI, na.rm = T), max(P_M334$STDAGE)))
                      } )

P_M334_pred_df <- data.frame("STDAGE"=seq(1,max(P_M334$STDAGE),by = 1),  
                            "fitted"=P_M334_pred)

## plot
gg.M334 <- ggplot() +
          geom_point(aes(x = STDAGE, y = BIO_MgHa), data = P_M334, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE, y = BIO_MgHa), data = P_M334, 
                            fun.data = function(x) {
                              res <- quantile(x, probs = c(0.25,0.5,0.75))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M334))), breaks = cutvec_M334) +  
          
          #geom_ribbon(aes(x = STDAGE, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = P_M334_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE, y = fitted), data = P_M334_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("M334 - Black Hills Coniferous Forest") + 
          
          #ylim(0, max(P_M334_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, cutvec_M334[20]*1.05), expand = c(0,0))

gg.M334

}  else {print("cannot plot data with prediction")}
```


## plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_M334 <- data.frame(
  bin = as.factor(levels(cut(P_M334$STDAGE, cutvec_M334))),
  data.mean = tapply(P_M334$BIO_MgHa, cut(P_M334$STDAGE, cutvec_M334), 
                     mean, na.rm = T), 
  data.CI.high =  tapply(P_M334$BIO_MgHa, cut(P_M334$STDAGE, cutvec_M334), 
                    high.CI), 
  data.CI.low = tapply(P_M334$BIO_MgHa, cut(P_M334$STDAGE, cutvec_M334),
                    low.CI), 
  pred.mean = P_M334_pred_df[P_M334_pred_df$STDAGE %in% bin_mids_M334,]$fitted) 
  # pred.CI.high = tapply(`M334_CI_df`$fitted, cut(`M334_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_M334$STDAGE, g=20))),
  #                      high.CI), 
  # pred.CI.low = tapply(`M334_CI_df`$fitted, cut(`M334_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_M334$STDAGE, g=20))),
  #                      low.CI))

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M334 <-  DM_compare_M334 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M334$bin)[gtools::mixedorder(levels(DM_compare_M334$bin))]))

## ggplot
gg.M334.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M334) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M334))), 
                              labels = levels(DM_compare_M334$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("M334 - Black Hills Coniferous Forest") +         
           theme_classic() + 
           # xlim(min(DM_compare_M334$data.CI.low)-0.25, max(DM_compare_M334$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_M334$pred.CI.low)-0.25, max(DM_compare_M334$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M334.B2

}
```

# M341 - Nevada-Utah Mountains Semi-Desert - Coniferous Forest - Alpine Meadow
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_M341 <- round(quantile(P_M341$STDAGE, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M341)))){
  cutvec_M341 <- round(quantile(P_M341$STDAGE, seq(0,1, length.out = 11)))
}

bin_mids_M341 <- unname(round(cutvec_M341[-length(cutvec_M341)] + diff(cutvec_M341)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
P_M341$STDAGE_bin<-  cut(P_M341$STDAGE, cutvec_M341)
## then get bin means
P_M341_bin_means <- tapply(P_M341$BIO_MgHa, cut(P_M341$STDAGE,  cutvec_M341), mean)

## make column weights.2
P_M341$nls_weights.2 <- as.numeric(1/(P_M341_bin_means[match(P_M341$STDAGE_bin, names(P_M341_bin_means))])^2)

}
```

## model selection 1

```{r}
# simple
try(
  nls_M341.1 <- nls(f_1, data = P_M341, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = P_M341$nls_weights.2), 
 )

## phi
try(
  nls_M341.2 <- nls(f_2, data=P_M341, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = P_M341$nls_weights.2), 
 )

## test
if(exists("nls_M341.1") & exists("nls_M341.2")){
  print(anova(nls_M341.1, nls_M341.2))
}
 
## AIC comparison
AIC1_M341 <- data.frame(model = c(1,2), AIC = c(
            ifelse(exists("nls_M341.1"), AIC(get("nls_M341.1")), NA),
            ifelse(exists("nls_M341.2"), AIC(get("nls_M341.2")), NA)
            ))

print(AIC1_M341) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M341[!is.na(AIC1_M341$AIC) & AIC1_M341$AIC == min(AIC1_M341$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M341.",  Mod.Sel1, sep =""))) )  #model summary
```
### summary 
* simple model: `r ifelse(exists("nls_M341.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M341.2"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M341.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M341.",  Mod.Sel1, sep ="")))["phi"], 1)
A.fit <- round(coef(get(paste("nls_M341.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M341.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M341.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = P_M341,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              }, 
          weights = P_M341$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M341.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = P_M341,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              },
          weights = P_M341$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_M341.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = P_M341,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              }, 
          weights = P_M341$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M341.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M341.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M341.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M341.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M341.", Mod.Sel1, sep ="")),
             get(paste("nls_M341.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M341.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M341.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M341.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M341.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M341.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M341.", Mod.Sel1, sep ="")),
               get(paste("nls_M341.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M341.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M341.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M341.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M341.", Mod.Sel1, sep ="")),
                 get(paste("nls_M341.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M341.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M341.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M341.", Mod.Sel1, sep ="")),
                    get(paste("nls_M341.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M341.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M341.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M341.", Mod.Sel1, sep ="")),
                      get(paste("nls_M341.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M341 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M341.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M341.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M341.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M341.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M341.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M341.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M341.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M341.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M341)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M341[!is.na(AIC2_M341$AIC) & AIC2_M341$AIC == min(AIC2_M341$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P[Best_mods.P$Code == "M341",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M341.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M341.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df[nls.param.df$Code == "M341",]$ge <- coefs["ge"]
nls.param.df[nls.param.df$Code == "M341",]$phi <- coefs["phi"]
nls.param.df[nls.param.df$Code == "M341",]$A <- coefs["A"]
nls.param.df[nls.param.df$Code == "M341",]$k <- coefs["k"]

nls.param.df[nls.param.df$Code == "M341",]$ge.2.5 <- intervals_low["ge"]
nls.param.df[nls.param.df$Code == "M341",]$phi.2.5 <- intervals_low["phi"]
nls.param.df[nls.param.df$Code == "M341",]$A.2.5 <- intervals_low["A"]
nls.param.df[nls.param.df$Code == "M341",]$k.2.5 <- intervals_low["k"]

nls.param.df[nls.param.df$Code == "M341",]$ge.97.5 <- intervals_high["ge"]
nls.param.df[nls.param.df$Code == "M341",]$phi.97.5 <- intervals_high["phi"]
nls.param.df[nls.param.df$Code == "M341",]$A.97.5 <- intervals_high["A"]
nls.param.df[nls.param.df$Code == "M341",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M341.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M341.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M341.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M341.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals
```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_M341 <- nlsResiduals(
  get(paste("nls_M341.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_M341)

## test residuals
if(length(P_M341$pltID) < 5001) {test.nlsResiduals(resid_M341)}

}   else {print("cannot plot residuals")}
```

## predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

P_M341_pred <- predict(get(paste("nls_M341.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME" = rep(mean(P_M341$MEASTIME, na.rm = T), max(P_M341$STDAGE)),
                                   "STDAGE" = seq(1, max(P_M341$STDAGE), by = 1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME" = rep(mean(P_M341$MEASTIME, na.rm = T), max(P_M341$STDAGE)),
                                   "STDAGE" = seq(1, max(P_M341$STDAGE), by = 1),
                                   "DeltaPDSI" = rep(mean(P_M341$DeltaPDSI, na.rm = T), max(P_M341$STDAGE)))
                      } )

P_M341_pred_df <- data.frame("STDAGE"=seq(1,max(P_M341$STDAGE),by = 1),  
                            "fitted"=P_M341_pred)

## plot
gg.M341 <- ggplot() +
          geom_point(aes(x = STDAGE, y = BIO_MgHa), data = P_M341, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE, y = BIO_MgHa), data = P_M341, 
                            fun.data = function(x) {
                              res <- quantile(x, probs = c(0.25,0.5,0.75))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M341))), breaks = cutvec_M341) +  
          
          #geom_ribbon(aes(x = STDAGE, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = P_M341_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE, y = fitted), data = P_M341_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("M341 - Nevada-Utah Mountains Semi-Desert - Coniferous Forest - Alpine Meadow") + 
          
          #ylim(0, max(P_M341_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, cutvec_M341[20]*1.05), expand = c(0,0))

gg.M341

}  else {print("cannot plot data with prediction")}
```


## plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_M341 <- data.frame(
  bin = as.factor(levels(cut(P_M341$STDAGE, cutvec_M341))),
  data.mean = tapply(P_M341$BIO_MgHa, cut(P_M341$STDAGE, cutvec_M341), 
                     mean, na.rm = T), 
  data.CI.high =  tapply(P_M341$BIO_MgHa, cut(P_M341$STDAGE, cutvec_M341), 
                    high.CI), 
  data.CI.low = tapply(P_M341$BIO_MgHa, cut(P_M341$STDAGE, cutvec_M341),
                    low.CI), 
  pred.mean = P_M341_pred_df[P_M341_pred_df$STDAGE %in% bin_mids_M341,]$fitted) 
  # pred.CI.high = tapply(`M341_CI_df`$fitted, cut(`M341_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_M341$STDAGE, g=20))),
  #                      high.CI), 
  # pred.CI.low = tapply(`M341_CI_df`$fitted, cut(`M341_CI_df`$STDAGE, c(0,creditmodel::cut_equal(P_M341$STDAGE, g=20))),
  #                      low.CI))

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M341 <-  DM_compare_M341 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M341$bin)[gtools::mixedorder(levels(DM_compare_M341$bin))]))

## ggplot
gg.M341.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M341) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M341))), 
                              labels = levels(DM_compare_M341$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("M341 - Nevada-Utah Mountains Semi-Desert - Coniferous Forest - Alpine Meadow") +         
           theme_classic() + 
           # xlim(min(DM_compare_M341$data.CI.low)-0.25, max(DM_compare_M341$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_M341$pred.CI.low)-0.25, max(DM_compare_M341$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M341.B2

}
```

---

# Fitted parameters

## Best / selected models by ecoprovince 

```{r}
knitr::kable(Best_mods.P) %>% kableExtra::kable_material(c("striped", "hover"))        
```

## table by ecoprovince

```{r, echo = FALSE, cache= T, warning = FALSE}
## clean up the table -- remove the -9999
nls.param.df[nls.param.df == -9999] <- NA
  
  
knitr::kable(nls.param.df) %>% kableExtra::kable_material(c("striped", "hover"))                      
```

## plot ge

```{r, echo= FALSE, message = FALSE, warning = FALSE, out.width = "200%"}
## order data
nls.param.df$Ecoregion<- factor(nls.param.df$Ecoregion, levels = nls.param.df[order(nls.param.df$ge), "Ecoregion"])

library(ggplot2)

#### create color vector 
col_vec.ge <- rep(NA, length(nls.param.df$ge))

for (i in 1:length(nls.param.df$ge)) {
  if(is.na(nls.param.df$ge[i])){
     col_vec.ge[i] <-  "white"
  } else if(nls.param.df$ge.2.5[i]>0) {
       col_vec.ge[i] <- scales::muted("green") 
    } else if(nls.param.df$ge.97.5[i]<0){
          col_vec.ge[i] <- scales::muted("red") 
      } else {
              col_vec.ge[i] <- "gray50"
        }
}

## plot
gg.ge_ECOSUBCD <- ggplot(aes(x=Ecoregion, y=ge, shape = region), 
                        data = nls.param.df) + 
                 geom_hline(yintercept =0, lty = 2) +
                 geom_point(size = 2, col = col_vec.ge) + 
                 geom_errorbar(aes(ymax = ge.2.5, ymin = ge.97.5), 
                               col = col_vec.ge) + 
                 theme_classic() + coord_flip() + 
                 labs(y =expression(italic("ge")*"(%)"), x = "Ecoregion") + 
                 scale_shape_manual(values = c(16,15,17)) + 
                 theme(legend.position = "top") + ylim(c(-6,8))

#tiff(file = "nls_ge_byEcoregion_part1_9.2.2022.tiff", width = 25, height = 14, units = "cm", res = 600, compression = "lzw")
gg.ge_ECOSUBCD
#dev.off()
```

### map
```{r, message = F, warning = F}
############################################################
##################################### CODE FOR MAP PREP
############################################################

## libraries
library(tidyverse)
library(rgdal)
library(broom)
library(ggplot2)
library(ggpattern)
library(ggthemes)

############################################################
## read in the shape file 
spdf <- readOGR(dsn="C:/Users/hogan.jaaron/Dropbox/FIA_R/Mapping/S_USA.EcoMapProvinces/S_USA.EcoMapProvinces.shp")
# spdf <- readOGR(dsn="C:/Users/hogie/Dropbox/FIA_R/Mapping/S_USA.EcoMapProvinces/S_USA.EcoMapProvinces.shp")       # if working on p_50

### tidy up 
spdf_tidy <- tidy(spdf)

## left_join
spdf$id <- row.names(spdf)
spdf_tidy <- left_join(spdf_tidy, spdf@data)

## add in the growth Enhancemnet data
## including missing rows
ge_df <-  data.frame( ECOPROVCD = as.factor(c(nls.param.df$Code,"Water")), ge = as.numeric(c(nls.param.df[,"ge"], NA)))

### add row for fill classification - statistically significant ge / data deficient etc.
ge_df$classification <- rep(NA, length(ge_df$ge))
  
for (i in 1:length(ge_df$ge)) {
  if(ge_df$ECOPROVCD[i] == "Water") {
    ge_df$classification[i] <- "Water"
    }else if(is.na(ge_df$ge[i])){
      ge_df$classification[i] <-  "data deficient"
      } else if(nls.param.df$ge.2.5[i]>0) {
        ge_df$classification[i] <- "signif"  
        } else if(nls.param.df$ge.97.5[i]<0) {
          ge_df$classification[i] <- "signif" 
          } else {
            ge_df$classification[i] <- "non-significant"
            } 
}

ge_df$classification <- as.factor(ge_df$classification)

### left_join
spdf_tidy <- left_join(spdf_tidy, ge_df, by = c("MAP_UNIT_S" = "ECOPROVCD"), keep = F)

############ ---------------------------------------------------------------------------------------  ############
######################### MAPPING ###################

## https://timogrossenbacher.ch/2016/12/beautiful-thematic-maps-with-ggplot2-only/

## theme
theme_map <- function(...) {
  theme_minimal() +
    theme(
      text = element_text(family = "Ubuntu Regular", color = "#22211d"),
      axis.line = element_blank(),
      axis.text.x = element_blank(),
      axis.text.y = element_blank(),
      axis.ticks = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      # panel.grid.minor = element_line(color = "#ebebe5", size = 0.2),
      panel.grid.major = element_line(color = "#ebebe5", size = 0.2),
      panel.grid.minor = element_blank(),
      plot.background = element_rect(fill = "#f5f5f2", color = NA), 
      panel.background = element_rect(fill = "#f5f5f2", color = NA), 
      legend.background = element_rect(fill = "#f5f5f2", color = NA),
      panel.border = element_blank(),
      ...
    )
}

```


```{r, message = F, warning = F}

############ ---------------------------------------------------------------------------------------  ############
## map again, with fill for ge

mapper  <- ggplot(aes(x = long, y = lat, group = group, fill = ge), data = spdf_tidy) +
  geom_polygon(color = "black", size = 0.1)  +
  coord_equal() +   
  theme_map() + 
  theme(legend.position = "bottom") + 
  metR::scale_fill_divergent(
                       low = scales::muted("red"),
                       mid = "white",
                       high = scales::muted("green"),
                     name = "biomass enhancement (%/yr)",
                     # here we use guide_colourbar because it is still a continuous scale
                     guide = guide_colorbar(
                       direction = "horizontal",
                       barheight = unit(2, units = "mm"),
                       barwidth = unit(50, units = "mm"),
                       draw.ulim = F,
                       title.position = 'top',
                       # some shifting around
                       title.hjust = 0.5,
                       label.hjust = 0.5)) #+ 
  #geom_segment(data=lines, aes(x= x, y = y , xend = xend, yend = yend), 
               #inherit.aes = F, color = "black", alpha = 0.25)

mapper
```

### map #2

```{r, message=F, warning = F}
library(ggnewscale)

mapper2  <- ggplot(aes(x = long, y = lat, group = group), data = spdf_tidy) +
  geom_polygon(aes_string(fill = "ge"), data = spdf_tidy[spdf_tidy$classification == "signif",], color = "black", size = 0.1)  +
  metR::scale_fill_divergent(
                       low = scales::muted("red"),
                       mid = "white",
                       high = scales::muted("green"),
                       name = "biomass stock enhancement (%/yr)",
                       # here we use guide_colourbar because it is still a continuous scale
                       guide = guide_colorbar(
                       direction = "horizontal",
                       barheight = unit(2, units = "mm"),
                       barwidth = unit(50, units = "mm"),
                       draw.ulim = F,
                       title.position = 'top',
                       # some shifting around
                       title.hjust = 0.5,
                       label.hjust = 0.5)) +   
  new_scale_fill() + 
  geom_polygon(aes_string(fill="classification"), data = spdf_tidy[!spdf_tidy$classification == "signif",], color = "black", size = 0.1)  +
  scale_fill_manual(values = c("#404040", "#BABABA", "dark blue")) +
  coord_equal() + theme(legend.position = "bottom") +
  theme_map() 
 

#+ 
  #geom_segment(data=lines, aes(x= x, y = y , xend = xend, yend = yend), 
               #inherit.aes = F, color = "black", alpha = 0.25)

mapper2
```


## plot phi (effect of DeltaPDSI)

```{r, echo= FALSE, message = FALSE, warning = FALSE, out.width = "200%"}
## order data 
nls.param.df <- nls.param.df[order(nls.param.df$phi),]

nls.param.df$Ecoregion<- factor(nls.param.df$Ecoregion, levels = nls.param.df[order(nls.param.df$phi), "Ecoregion"])

library(ggplot2)

#### create color vector 
col_vec.phi <- rep(NA, length(nls.param.df$phi))

for (i in 1:length(nls.param.df$phi)) {
  if(is.na(nls.param.df$phi[i])){
     col_vec.phi[i] <-  "white"
  } else if(nls.param.df$phi.2.5[i]>0) {
       col_vec.phi[i] <- scales::muted("blue") 
    } else if(nls.param.df$phi.97.5[i]<0){
          col_vec.phi[i] <- scales::muted("orange")
      } else {
              col_vec.phi[i] <- "gray50"
        }
}

## plot
gg.phi_ECOSUBCD <- ggplot(aes(x=Ecoregion, y=phi, shape = region), 
                        data = nls.param.df) + 
                 geom_hline(yintercept =0, lty = 2) +
                 geom_point(size = 2, col = col_vec.phi) + 
                 geom_errorbar(aes(ymax = phi.2.5, ymin = phi.97.5), 
                               col = col_vec.phi) + 
                 theme_classic() + coord_flip() + 
                 labs(y = expression(italic("\u03D5")), x = "Ecoregion") + 
                 scale_shape_manual(values = c(16,15,17)) + 
                 theme(legend.position = "top") + ylim(c(-0.7,0.3))

#tiff(file = "nls_ge_byEcoregion_part1_9.2.2022.tiff", width = 25, height = 14, units = "cm", res = 600, compression = "lzw")
gg.phi_ECOSUBCD
#dev.off()
```

## plot A (asymptote of B)

```{r}
## order data
nls.param.df <- nls.param.df[order(nls.param.df$A),]

nls.param.df$Ecoregion<- factor(nls.param.df$Ecoregion, levels = nls.param.df[order(nls.param.df$A), "Ecoregion"])

library(ggplot2)

## plot
gg.A_ECOSUBCD <- ggplot(aes(x=Ecoregion, y=A, shape = region), 
                        data = nls.param.df) + 
                 #geom_hline(yintercept =0, lty = 2) +
                 geom_point(size = 2) + 
                 geom_errorbar(aes(ymax = A.2.5, ymin = A.97.5)) + 
                 theme_classic() + coord_flip() + 
                 labs(y = expression(italic("A")*" (Mg ha"^-1*")"), x = "Ecoregion") + 
                 scale_shape_manual(values = c(16,15,17)) + 
                 theme(legend.position = "top") + ylim(c(0,1500))

#tiff(file = "nls_ge_byEcoregion_part1_9.2.2022.tiff", width = 25, height = 14, units = "cm", res = 600, compression = "lzw")
gg.A_ECOSUBCD
#dev.off()
```

## plot k (stand age at half biomass asymptote)

```{r}
## order data
nls.param.df <- nls.param.df[order(nls.param.df$k),]

nls.param.df$Ecoregion<- factor(nls.param.df$Ecoregion, levels = nls.param.df[order(nls.param.df$k), "Ecoregion"])

library(ggplot2)

## plot
gg.k_ECOSUBCD <- ggplot(aes(x=Ecoregion, y=k, shape = region), 
                        data = nls.param.df) + 
                 geom_hline(yintercept =0, lty = 2) +
                 geom_point(size = 2) + 
                 geom_errorbar(aes(ymax = k.2.5, ymin = k.97.5)) + 
                 theme_classic() + coord_flip() + 
                 labs(y = expression(italic("k")*" (yrs)"), x = "Ecoregion") + 
                 scale_shape_manual(values = c(16,15,17)) + 
                 theme(legend.position = "top") + ylim(c(-100,1500))

#tiff(file = "nls_ge_byEcoregion_part1_9.2.2022.tiff", width = 25, height = 14, units = "cm", res = 600, compression = "lzw")
gg.k_ECOSUBCD
#dev.off()
```

# Caclulations - weighted averages 

## ge (stand biomass enhancement factor in % 2000-2021)
```{r}
## note numbers in comments after code are first set of results (reported for ESA 2022 initial abstract submission)

weighted.ge.df <-  data.frame(
  region = c("entire US", "pacific",  "east", "interior west"),
## all
  "weighted ge" = c(sum(nls.param.df$ge*nls.param.df$n.plots, na.rm = T) /sum(nls.param.df$n.plots, na.rm = T) #0.3650677
,
## pacific
sum(nls.param.df[nls.param.df$region == "pacific",]$ge * nls.param.df[nls.param.df$region == "pacific",]$n.plots, na.rm = T) / sum(nls.param.df[nls.param.df$region == "pacific",]$n.plots, na.rm = T) #0.7590908
,
## east 
sum(nls.param.df[nls.param.df$region == "east",]$ge * nls.param.df[nls.param.df$region == "east",]$n.plots, na.rm = T) / sum(nls.param.df[nls.param.df$region == "east",]$n.plots, na.rm = T) #0.2836302
,
## west
sum(nls.param.df[nls.param.df$region == "interior west",]$ge * nls.param.df[nls.param.df$region == "interior west",]$n.plots, na.rm = T) / sum(nls.param.df[nls.param.df$region == "interior west",]$n.plots, na.rm = T) # 0.3980526 
))

weighted.ge.df
```

## phi (effect of DeltaPDSI)
```{r}
## note numbers in comments after code are first set of results (reported for ESA 2022 intial abstract submission)

weighted.phi.df <-  data.frame(
  region = c("entire US", "pacific", "east", "interior west"),
## all
  "weighted phi" = c(sum(nls.param.df$phi*nls.param.df$n.plots, na.rm = T) /sum(nls.param.df$n.plots) #0.3650677
,
## pacific
sum(nls.param.df[nls.param.df$region == "pacific",]$phi * nls.param.df[nls.param.df$region == "pacific",]$n.plots, na.rm = T) / sum(nls.param.df[nls.param.df$region == "pacific",]$n.plots, na.rm = T) #0.7590908
,
## east 
sum(nls.param.df[nls.param.df$region == "east",]$phi * nls.param.df[nls.param.df$region == "east",]$n.plots, na.rm = T) / sum(nls.param.df[nls.param.df$region == "east",]$n.plots, na.rm = T) #0.2836302
,
## west
sum(nls.param.df[nls.param.df$region == "interior west",]$phi * nls.param.df[nls.param.df$region == "interior west",]$n.plots, na.rm = T) / sum(nls.param.df[nls.param.df$region == "interior west",]$n.plots, na.rm = T))) # 0.3980526 ))

weighted.phi.df
```


## A (asymptote of forest biomass in Mg/ha)
```{r}
weighted.A.df <-  data.frame(
  region = c("entire US", "pacific",  "east", "interior west"),
  ## all
 "weighted A" = c(sum(nls.param.df$A*nls.param.df$n.plots, na.rm =T) /sum(nls.param.df$n.plots, na.rm =T) 
,
## pacific
sum(nls.param.df[nls.param.df$region == "pacific",]$A * nls.param.df[nls.param.df$region == "pacific",]$n.plots, na.rm =T) / sum(nls.param.df[nls.param.df$region == "pacific",]$n.plots, na.rm =T) 
,
## east 
sum(nls.param.df[nls.param.df$region == "east",]$A * nls.param.df[nls.param.df$region == "east",]$n.plots, na.rm =T) / sum(nls.param.df[nls.param.df$region == "east",]$n.plots, na.rm =T)
,
## west
sum(nls.param.df[nls.param.df$region == "interior west",]$A * nls.param.df[nls.param.df$region == "west",]$n.plots, na.rm =T) / sum(nls.param.df[nls.param.df$region == "interior west",]$n.plots, na.rm =T)))


weighted.A.df
```


## K (stand age at half maturation in years)
```{r}
weighted.k.df <-  data.frame(
  region = c("entire US", "pacific", "east", "interior west"),
## all
 "weighted k" = c(sum(nls.param.df$k*nls.param.df$n.plots, na.rm =T) /sum(nls.param.df$n.plots, na.rm =T) 
,
## pacific
sum(nls.param.df[nls.param.df$region == "pacific",]$k * nls.param.df[nls.param.df$region == "pacific",]$n.plots, na.rm =T) / sum(nls.param.df[nls.param.df$region == "pacific",]$n.plots, na.rm =T) 
,
## east 
sum(nls.param.df[nls.param.df$region == "east",]$k * nls.param.df[nls.param.df$region == "east",]$n.plots, na.rm =T) / sum(nls.param.df[nls.param.df$region == "east",]$n.plots, na.rm =T)
,
## west
sum(nls.param.df[nls.param.df$region == "interior west",]$k * nls.param.df[nls.param.df$region == "interior west",]$n.plots, na.rm =T) / sum(nls.param.df[nls.param.df$region == "interior west",]$n.plots, na.rm =T)))

weighted.k.df
```






