---
title: "FIA NLS Models: Biomass vs. Stand Age, G-Reconciled -- Data Subsets"
author: "JAH"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_float: yes
    toc_collapsed: yes
    toc_depth: 4
    
---

```{r include=FALSE}
knitr::opts_chunk$set(tidy.opts=list(width.cutoff=60), tidy=TRUE, echo = FALSE, cache.lazy = T)
```

```{r, message = FALSE, warning=FALSE}
### libraries
library(dplyr)
library(ggplot2)
library(nlstools)

### CI functions -- (for later)
high.CI <-  function(x) {mean(x) + 1.96*plotrix::std.error(x)}
low.CI <-  function(x) {mean(x) - 1.96*plotrix::std.error(x)}
```

```{r}
#### set wd
setwd("C:/Users/hogan.jaaron/Dropbox/FIA_R/NLS_modeling/New_G_nov2022/PlotB_StdAge")
# setwd("C:/Users/hogie/Dropbox/FIA_R/NLS_modeling/plotB_StdAge")    # if working on P-50

### set seed for reproducibility
set.seed(77)
```

# Background

This analysis document compliments **FIA NLS Models: Biomass vs. Stand Age, G-Reconciled**.  All of the background information from that document applies to these analyses, which are extensions to them.  The difference between that document and this analysis is the use of different data subsets. 

Here, we fit the models using: 
1) a temporally-balanced dataset, where we take the first and most-recent plot record for all plots in the dataset, 
2) a temporally-balanced dataset (same as #1), but which excludes plot locations which have experienced harvest (at any point over the study interval 2000-2022)

Below the model fitting procedure is implemented by ecoprovince:

```{r}
### create nls formulae for modeling

### model 1
f_1 <- formula(B_plt_t2_MgHa ~ (1 + (MEASTIME_t2-1990)*ge/100) * A*STDAGE_t2 / (k+STDAGE_t2))
## model 2
f_2 <-  formula(B_plt_t2_MgHa ~ (1 + (MEASTIME_t2-1990)*ge/100) * (1 + phi*DeltaPDSI) * A*STDAGE_t2 / (k+STDAGE_t2))
## model 3
f_3 <- formula(B_plt_t2_MgHa ~ (1 + (MEASTIME_t2-1990)*ge/100) * (1 + phi*DeltaPDSI) * (1-alpha*B_L_prop) * A*STDAGE_t2 / (k+STDAGE_t2))

## model 1 variants
f_1a <- formula(B_plt_t2_MgHa ~ (1 + (MEASTIME_t2-1990)*ge/100) * (p*A+((1-p)*A*STDAGE_t2/(k+STDAGE_t2))))
f_1b <- formula(B_plt_t2_MgHa ~ (1 + (MEASTIME_t2-1990)*ge/100) * (A*STDAGE_t2^s/(k^s+STDAGE_t2^s)))
f_1c <- formula(B_plt_t2_MgHa ~ (1 + (MEASTIME_t2-1990)*ge/100) * (p*A+((1-p)*A*STDAGE_t2^s/(k^s+STDAGE_t2^s))))


## model 2 variants
f_2a <- formula(B_plt_t2_MgHa ~ (1 + (MEASTIME_t2-1990)*ge/100) * (1 + phi*DeltaPDSI) * (p*A+((1-p)*A*STDAGE_t2/(k+STDAGE_t2))))
f_2b <- formula(B_plt_t2_MgHa ~ (1 + (MEASTIME_t2-1990)*ge/100) * (1 + phi*DeltaPDSI) * (A*STDAGE_t2^s/(k^s+STDAGE_t2^s)))
f_2c <- formula(B_plt_t2_MgHa ~ (1 + (MEASTIME_t2-1990)*ge/100) * (1 + phi*DeltaPDSI) * (p*A+((1-p)*A*STDAGE_t2^s/(k^s+STDAGE_t2^s))))


## model 3 variants
f_3a <- formula(B_plt_t2_MgHa ~ (1 + (MEASTIME_t2-1990)*ge/100) * (1 + phi*DeltaPDSI) * (1-alpha*B_L_prop) * (p*A+((1-p)*A*STDAGE_t2/(k+STDAGE_t2))))
f_3b <- formula(B_plt_t2_MgHa ~ (1 + (MEASTIME_t2-1990)*ge/100) * (1 + phi*DeltaPDSI) * (1-alpha*B_L_prop) * (A*STDAGE_t2^s/(k^s+STDAGE_t2^s)))
f_3c <- formula(B_plt_t2_MgHa ~ (1 + (MEASTIME_t2-1990)*ge/100) * (1 + phi*DeltaPDSI) * (1-alpha*B_L_prop) * (p*A+((1-p)*A*STDAGE_t2^s/(k^s+STDAGE_t2^s))))

## Log-Normal models
## model 4
f_4 <- formula(B_plt_t2_MgHa ~ (1 + (MEASTIME_t2-1990)*ge/100) * (a+b*exp(-((log(STDAGE_t2/c))/d)^2)))
## model 5
f_5 <-  formula(B_plt_t2_MgHa ~ (1 + (MEASTIME_t2-1990)*ge/100) * (1 + phi*DeltaPDSI) * (a+b*exp(-((log(STDAGE_t2/c))/d)^2)))
## model 3
f_6 <- formula(B_plt_t2_MgHa ~ (1 + (MEASTIME_t2-1990)*ge/100) * (1 + phi*DeltaPDSI) * (1-alpha*B_L_prop) * (a+b*exp(-((log(STDAGE_t2/c))/d)^2)))

###########################################

##### define nls starting parameters 
## for Michaelis-Menten fits
A.start = 50
k.start = 20

####  for Log-Normal fits
a.start = 0   # a+b = peak plot B value
              # note: b.start defined for each ecoprovince separately -- as mean plot B for that ecoprovince
c.start = 25  # STDAGE at peak plot B
d.start = 1   # shape parameter

ge.start= 0.1
phi.start = 0 
alpha.start = 0.5
```

```{r}
# ## load G dataset
# load("C:/Users/hogan.jaaron/Dropbox/FIA_R/BiomassGrowth/Biomass_Growth_calculations_june2022/FIA_G_calc.Rdata")
# # load("C:/Users/hogie/Dropbox/FIA_R/BiomassGrowth/Biomass_Growth_calculations_june2022/FIA_G_calc.Rdata")    # if working on P-50
# 
# ## FILTER THE DATASTET -- Plot Selection Criteria
# ## apply filters to the FIA_G_calc data frame
# #
# # ### create p_Cond_surv --- the combined  plot condition and survey table dataframe for subsetting
# #
# # for FIA plot conditions
# load("C:/Users/hogan.jaaron/Dropbox/FIA_R/Plot_Conditions_rFIA/FIA_conditions_allPlots.Rdata")
# # load("C:/Users/hogie/Dropbox/FIA_R/Plot_Conditions_rFIA/FIA_conditions_allPlots.Rdata")   # if working on P-50
# FIA_conditions$STATE <- as.factor(FIA_conditions$STATE)
# FIA_conditions$PROP_BASIS <- as.factor(FIA_conditions$PROP_BASIS)
# FIA_conditions$MIXEDCONFCD <- as.factor(FIA_conditions$MIXEDCONFCD)
# FIA_conditions$DWM_FUELBED_TYPCD  <-  as.factor(FIA_conditions$DWM_FUELBED_TYPCD)
# 
# # for FIA plots (plot table)
# load("C:/Users/hogan.jaaron/Dropbox/FIA_R/Plot_Conditions_rFIA/FIA_plots_allPlots.Rdata")
# # load("C:/Users/hogie/Dropbox/FIA_R/Plot_Conditions_rFIA/FIA_plots_allPlots.Rdata")   # if working on P-50
# FIA_plots$STATE <- as.factor(FIA_plots$STATE)
# FIA_plots$ECOSUBCD <- as.factor(FIA_plots$ECOSUBCD)
# 
# ##### COMBINE PLOT and CODITION TABLES
# P_cond <- dplyr::left_join(FIA_conditions, FIA_plots, by = c("STATE", "PLOT", "INVYR", "PLT_CN" = "CN"))  #PLT_CN = CN  merges condition table to the plot table using PLT_CN (see FIA data user guide 8.0)
# 
# #### load survey tables
# load("C:/Users/hogan.jaaron/Dropbox/FIA_R/Plot_Conditions_rFIA/FIA_survey.Rdata")
# # load("C:/Users/hogie/Dropbox/FIA_R/Plot_Conditions_rFIA/FIA_survey.Rdata")     # if working on P-50
# ##### COMBINE P_cond and survey tables
# P_cond_surv <- dplyr::left_join(P_cond, FIA_survey[,c("CN", "P3_OZONE_IND", "ANN_INVENTORY")], by = c("SRV_CN" = "CN"))
# 
# ###### COMBINE G_calc -- for plot filtering at T2
# G <- dplyr::left_join(FIA_G_calc, P_cond_surv[,c("STATE", "PLT_CN", "STDAGE", "INVYR", "STDORGCD", "CONDPROP_UNADJ", "SITECLCD","STDSZCD", "COND_STATUS_CD", "P3_OZONE_IND", "ANN_INVENTORY")], by = c("STATE", "CN" = "PLT_CN", "INVYR")) %>% distinct()  # 377825 observations
# 
# ### rename STDAGE for STDAGE_t2
# colnames(G)[39] <- "STDAGE_t2"
# 
# ##########################
# #### APPLYING FILTERS ####
# 
# ## remove cases of NA's STDAGE columns
# G <- G[!is.na(G$STDAGE_t2) & !G$STDAGE_t2 == 9999,]
# ## Filter out plantations
# G <- G[G$STDORGCD == 0, ]
# ## Filter plots with a single condition using a 95% threshold for CONDPROP_UNADJ
# G <- G[G$CONDPROP_UNADJ >= 0.95, ]
# ### Filter out SITECLCD 7 (non productive stands - those with less than 20 ft3/ac/yr)
# G <- G[!G$SITECLCD == 7,]
# ### Filter out non-stocked plots (with STDSZCD == 5)
# G <- G[!G$STDSZCD == 5,]
# 
# ### new filters - MAY 2022
# ### Filter out the the non-accessible plots -- COND_STATUS_CD == 1 is accessible
# G <- G[G$COND_STATUS_CD == 1,]
# ### Filter by survey table --- annual inventories YES
# G <- G[G$ANN_INVENTORY == "Y",]
# ### Filter by survey table --- B3_OZONE NO
# G <- G[G$P3_OZONE_IND == "N",]
# 
# #### DONE APPLYING FILTERS ####
# ###############################
# 
# ## dealing with ECOPROVINCES:
# G$ECOPROVCD <- stringr::str_replace_all(gsub('.{2}$', '', G$ECOSUBCD), stringr::fixed(" "), "")
# 
# G[G$ECOPROVCD == "M332A",]$ECOPROVCD <- "M332"
# G[G$ECOPROVCD == "M332E",]$ECOPROVCD <- "M332"
# 
# G$ECOPROVCD <-  as.factor(G$ECOPROVCD)
# 
# ## calculate & add MEASTIME_avg
# G$MEASTIME_avg <- (G$MEASTIME_t1 + G$MEASTIME_t2) /2
# 
# ############################# For STDAGE T1
# 
# ### subset the condition table to include only the dominant condition for 
# FIA_single_conditions <- FIA_conditions %>% group_by(STATE, PLT_CN, INVYR) %>% filter(row_number() == which.max(CONDPROP_UNADJ))  %>% select(STATE, PLT_CN, INVYR, CONDPROP_UNADJ, STDAGE) %>% unique()
# 
# df_STDAGE_t1 <- as.data.frame(FIA_single_conditions[FIA_single_conditions$PLT_CN %in% G$PREV_PLT_CN ,c("STATE", "PLT_CN",  "INVYR", "STDAGE")])
#                           
# colnames(df_STDAGE_t1)[2] <- "PREV_PLT_CN"
# colnames(df_STDAGE_t1)[4] <- "STDAGE_t1"
# 
# ## left_join  to add to the G dataframe
# G <- left_join(G, df_STDAGE_t1[,c("STATE", "PREV_PLT_CN", "STDAGE_t1")], by = c("STATE", "PREV_PLT_CN"))
# 
# ## for is.na STDAGE_t1 assign STDAGE_t2 value    ## done for 405 records
# G[is.na(G$STDAGE_t1),]$STDAGE_t1 <- G[is.na(G$STDAGE_t1),]$STDAGE_t2
# 
# ## difference in STDAGE
# G$diff_STDAGE <- G$STDAGE_t2 - G$STDAGE_t1
# ############################################################  (END for STDAGE T1)
# 
# save(G, file = "C:/Users/hogan.jaaron/Dropbox/FIA_R/Starter_FIA_data_processing/G_dataset.Rdata")
# 
# rm(P_cond, FIA_G_calc, FIA_conditions, FIA_single_conditions, FIA_plots, FIA_survey, P_cond_surv, df_STDAGE_t1)  #removes other data frames

### Load G dataset
load("C:/Users/hogan.jaaron/Dropbox/FIA_R/Starter_FIA_data_processing/G_Nov2022.Rdata")
# load("C:/Users/hogie/Dropbox/FIA_R/Starter_FIA_data_processing/G_dataset.Rdata")   # if working on P-50

##-------------------------------------------------------------------------------------------------------------------###
###  CODE TO CALCULATE delta_PDSI

## Note: This code calculates delta_PDSI -- the difference in the Palmer Drought Severity Index from the baseline (1960-1989) 
## and the census interval -- uncomment to run -- it takes a little while (a few hours) to run, so the output is saved and read in below 

#####################################################
#####################################################

# library(terra)
# ## read in the the G data file (has spatial coordinates for plot locations)
# load("C:/Users/hogan.jaaron/Dropbox/FIA_R/Starter_FIA_data_processing/G_dataset.Rdata")
# 
# ### read in the data -
# pdsi1 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_1_PRISM.nc")
# names(pdsi1) <- as.character(1895:2022)
# 
# pdsi2 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_2_PRISM.nc")
# names(pdsi2) <- as.character(1895:2022)
# 
# pdsi3 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_3_PRISM.nc")
# names(pdsi3) <- as.character(1895:2022)
# 
# pdsi4 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_4_PRISM.nc")
# names(pdsi4) <- as.character(1895:2022)
# 
# pdsi5 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_5_PRISM.nc")
# names(pdsi5) <- as.character(1895:2022)
# 
# ###### first pass: limited analysis to growing season - June, July and August -
# pdsi6 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_6_PRISM.nc")
# names(pdsi6) <- as.character(1895:2022)
# 
# pdsi7 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_7_PRISM.nc")
# names(pdsi7) <- as.character(1895:2022)
# 
# pdsi8 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_8_PRISM.nc")
# names(pdsi8) <- as.character(1895:2022)
# 
# ## make null dataframe
# G_pdsi_data <-  data.frame(pltID = G$pltID,
#                          LAT = G$LAT,
#                          LON = G$LON,
#                          MEASTIME_t2 = G$MEASTIME_t2,
#                          pdsi_baseline = rep(-9999, length(G$pltID)),
#                          pdsi_growInt = rep(-9999, length(G$pltID)))
# 
# ## makes spatVector for spatial points of plot locations
# G_pts <- vect(cbind(G_pdsi_data$LON, G_pdsi_data$LAT), crs="+proj=longlat +datum=WGS84")
# 
# ##################################################### START FOR LOOP
# ### for loop to extract time-series data for each plot location
# for(i in 1:length(G_pdsi_data$pltID)){
# 
#   ### extract values
#   pdsi_vec.1 <- unlist(terra::extract(pdsi1, G_pts[i]))
# 
#   pdsi_vec.2 <- unlist(terra::extract(pdsi2, G_pts[i]))
# 
#   pdsi_vec.3 <- unlist(terra::extract(pdsi3, G_pts[i]))
# 
#   pdsi_vec.4 <- unlist(terra::extract(pdsi4, G_pts[i]))
# 
#   pdsi_vec.5 <- unlist(terra::extract(pdsi5, G_pts[i]))
# 
#   pdsi_vec.6 <- unlist(terra::extract(pdsi6, G_pts[i]))
# 
#   pdsi_vec.7 <- unlist(terra::extract(pdsi7, G_pts[i]))
# 
#   pdsi_vec.8 <- unlist(terra::extract(pdsi8, G_pts[i]))
# 
#   ### calculate the average baseline value 1960-1989 --- 30 year climate normal
#   G_pdsi_data$pdsi_baseline[i] <- mean(c(pdsi_vec.1[as.character(rep(1960:1989))],
#                                          pdsi_vec.2[as.character(rep(1960:1989))],
#                                          pdsi_vec.3[as.character(rep(1960:1989))],
#                                          pdsi_vec.4[as.character(rep(1960:1989))],
#                                          pdsi_vec.5[as.character(rep(1960:1989))],
#                                          pdsi_vec.6[as.character(rep(1960:1989))],
#                                          pdsi_vec.7[as.character(rep(1960:1989))],
#                                          pdsi_vec.8[as.character(rep(1960:1989))]),
#                                        na.rm = T)
# 
#   ### calculate the mean over the growth interval
#   G_pdsi_data$pdsi_growInt[i] <- mean(c(pdsi_vec.1[names(pdsi_vec.1) %in%
#                                                              seq(floor(G_pdsi_data$MEASTIME_t2[i] -10), floor(G_pdsi_data$MEASTIME_t2[i]))],
#                                         pdsi_vec.2[names(pdsi_vec.2) %in%
#                                                              seq(floor(G_pdsi_data$MEASTIME_t2[i] -10), floor(G_pdsi_data$MEASTIME_t2[i]))],
#                                         pdsi_vec.3[names(pdsi_vec.3) %in%
#                                                              seq(floor(G_pdsi_data$MEASTIME_t2[i] -10), floor(G_pdsi_data$MEASTIME_t2[i]))],
#                                         pdsi_vec.4[names(pdsi_vec.4) %in%
#                                                              seq(floor(G_pdsi_data$MEASTIME_t2[i] -10), floor(G_pdsi_data$MEASTIME_t2[i]))],
#                                         pdsi_vec.5[names(pdsi_vec.5) %in%
#                                                              seq(floor(G_pdsi_data$MEASTIME_t2[i] -10), floor(G_pdsi_data$MEASTIME_t2[i]))],
#                                         pdsi_vec.6[names(pdsi_vec.6) %in%
#                                                              seq(floor(G_pdsi_data$MEASTIME_t2[i] -10), floor(G_pdsi_data$MEASTIME_t2[i]))],
#                                         pdsi_vec.7[names(pdsi_vec.7) %in%
#                                                              seq(floor(G_pdsi_data$MEASTIME_t2[i] -10), floor(G_pdsi_data$MEASTIME_t2[i]))],
#                                         pdsi_vec.8[names(pdsi_vec.8) %in%
#                                                              seq(floor(G_pdsi_data$MEASTIME_t2[i] -10), floor(G_pdsi_data$MEASTIME_t2[i]))]),
#                                     na.rm = T)
# 
# } ## end for loop
# #####################################################
# 
# ## make column for difference
# G_pdsi_data$DeltaPDSI <-  G_pdsi_data$pdsi_growInt - G_pdsi_data$pdsi_baseline
# 
# ### deal with NaNs
# NaN_vec  <- as.numeric(row.names(G_pdsi_data[is.na(G_pdsi_data$DeltaPDSI),]))
# 
# ### for loop to extract time-series data for each plot location
# for(i in 1:length(NaN_vec)){
# 
#   ### extract values
#   pdsi_vec.1 <- unlist(terra::extract(pdsi1, G_pts[NaN_vec[i]], method = "bilinear"))
# 
#   pdsi_vec.2 <- unlist(terra::extract(pdsi2, G_pts[NaN_vec[i]], method = "bilinear"))
# 
#   pdsi_vec.3 <- unlist(terra::extract(pdsi3, G_pts[NaN_vec[i]], method = "bilinear"))
# 
#   pdsi_vec.4 <- unlist(terra::extract(pdsi4, G_pts[NaN_vec[i]], method = "bilinear"))
# 
#   pdsi_vec.5 <- unlist(terra::extract(pdsi5, G_pts[NaN_vec[i]], method = "bilinear"))
# 
#   pdsi_vec.6 <- unlist(terra::extract(pdsi6, G_pts[NaN_vec[i]], method = "bilinear"))
# 
#   pdsi_vec.7 <- unlist(terra::extract(pdsi7, G_pts[NaN_vec[i]], method = "bilinear"))
# 
#   pdsi_vec.8 <- unlist(terra::extract(pdsi8, G_pts[NaN_vec[i]], method = "bilinear"))
# 
#   ### calculate the average baseline value 1960-1989 --- 30 year climate normal
#   G_pdsi_data$pdsi_baseline[NaN_vec[i]] <- mean(c(pdsi_vec.1[as.character(rep(1960:1989))],
#                                                   pdsi_vec.2[as.character(rep(1960:1989))],
#                                                   pdsi_vec.3[as.character(rep(1960:1989))],
#                                                   pdsi_vec.4[as.character(rep(1960:1989))],
#                                                   pdsi_vec.5[as.character(rep(1960:1989))],
#                                                   pdsi_vec.6[as.character(rep(1960:1989))],
#                                                   pdsi_vec.7[as.character(rep(1960:1989))],
#                                                   pdsi_vec.8[as.character(rep(1960:1989))]),
#                                                 na.rm = T)
# 
#   ### calculate the mean over the growth interval
#   G_pdsi_data$pdsi_growInt[NaN_vec[i]] <- mean(c(pdsi_vec.1[names(pdsi_vec.1) %in%
#                                                              seq(floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]] -10), floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]]))],
#                                                 pdsi_vec.2[names(pdsi_vec.2) %in%
#                                                              seq(floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]] -10), floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]]))],
#                                                 pdsi_vec.3[names(pdsi_vec.3) %in%
#                                                              seq(floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]] -10), floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]]))],
#                                                 pdsi_vec.4[names(pdsi_vec.4) %in%
#                                                              seq(floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]] -10), floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]]))],
#                                                 pdsi_vec.5[names(pdsi_vec.5) %in%
#                                                              seq(floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]] -10), floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]]))],
#                                                  pdsi_vec.6[names(pdsi_vec.6) %in%
#                                                              seq(floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]] -10), floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]]))],
#                                                  pdsi_vec.7[names(pdsi_vec.7) %in%
#                                                              seq(floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]] -10), floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]]))],
#                                                  pdsi_vec.8[names(pdsi_vec.8) %in%
#                                                              seq(floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]] -10), floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]]))]),
#                                                na.rm = T)
# 
# } ## end for loop
# #####################################################
# 
# ## make column for difference
# G_pdsi_data$DeltaPDSI <-  G_pdsi_data$pdsi_growInt - G_pdsi_data$pdsi_baseline
# 
# ########################################
# ### save the result
# setwd("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI")
# save(G_pdsi_data, file = "G_pdsi_PlotBiomass_data.Rdata")

#####################################################
#####################################################
 
load("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/G_pdsi_data_NoIngrowth_JAN-AUG.Rdata")   ## simply load ths finished data product -- the above code takes some time to run...

### transfer DeltaPDSI column to G dataframe
G$DeltaPDSI <- G_pdsi_data$DeltaPDSI

###-------------------------------------------------------------------------------------------------------------------###

## APPLY CLEANERS 

## this code removes outliers that are greater than or less than a specified quantile threshold
## analyses were done with or without these cleaners, and results did not change 
## substantially quantatively or at all qualatitively. 
## 
## I apply the quantile threshold (XT) cleaners to the FIA biomass growth (G) dataset.  
## 4 cases are explored, investigating plots which fall outside of the quantile ranges (set to 0.005, and 0.0995) for:
## 
## * case A: where the QT difference in tree incremental G (TI) is > mass balance plot G (MB) (> 99.5% diff_G positive outliers)
## * case B: where the QT difference in tree incremental G (TI) is < mass balance plot G (MB) (> 0.5% diff_G negative outliers)
## * case C: where the QT difference in tree incremental G (TI) is > 0  (> 99.5% positive outliers)
## * case D: where the QT difference in tree incremental G (TI) is > 0  (< 0.5% negative outliers)

## step 1
## calculate diff G  - tree increment grwoth method minus mass balance method
G$diff_G_MgHaYr <- G$G_obs_TreeInc_MgHaYr - G$G_MassBal_MgHaYr

## set QT: quantile threshold
QT <- 0.005

# Cleaner case A: cases where TI > MB
## positive outliers for the difference in TreeInc to MassBal G
outliers_cleanerA <- G[G$diff_G_MgHaYr > quantile(G$diff_G_MgHaYr, probs = c(1-QT)),]

# Cleaner case B: cases where TI < MB
## negative outliers for  the difference in TreeInc to MassBal G
outliers_cleanerB <- G[G$diff_G_MgHaYr < quantile(G$diff_G_MgHaYr, probs = c(QT)),]

# Cleaner case C: TI > 0
G_cleanerC <- G[G$G_obs_TreeInc_MgHaYr > 0,]
## positive outliers
outliers_cleanerC <- G_cleanerC[G_cleanerC$G_obs_TreeInc_MgHaYr > quantile(G_cleanerC$G_obs_TreeInc_MgHaYr, probs = c(1-QT)),]

# Cleaner case D: TI < 0
G_cleanerD <- G[G$G_obs_TreeInc_MgHaYr < 0,]
## negative outliers
outliers_cleanerD <- G_cleanerD[G_cleanerD$G_obs_TreeInc_MgHaYr < quantile(G_cleanerD$G_obs_TreeInc_MgHaYr, probs = c(QT)),]

# # compare cases A and C
# ##  A in C
# outliers_cleanerA[,"pltID"] [outliers_cleanerA[,"pltID"] %in% outliers_cleanerC[,"pltID"]]
# ## C in A
# outliers_cleanerC[,"pltID"] [outliers_cleanerC[,"pltID"] %in% outliers_cleanerA[,"pltID"]]

# # compare cases B and D 
# ##  B in D
# outliers_cleanerB[,"pltID"] [outliers_cleanerB[,"pltID"] %in% outliers_cleanerD[,"pltID"]]
# ## D in B
# outliers_cleanerD[,"pltID"] [outliers_cleanerD[,"pltID"] %in% outliers_cleanerB[,"pltID"]]

## make list of cleaner pltIDs
cleaner_pltIDs <- c(outliers_cleanerA$pltID, outliers_cleanerB$pltID, outliers_cleanerC$pltID, outliers_cleanerD$pltID)
cleaner_pltIDs <- cleaner_pltIDs[order(cleaner_pltIDs)]

#### APPLY CLEANERS!
G <- G[!G$pltID %in% cleaner_pltIDs,]

###-------------------------------------------------------------------------------------------------------------------###

#### TEMPORALLY BALANCING: 

### grab the pltIDs with >= 2 observations
g1.pltIDs <-  names(table(G$pltID) [table(G$pltID) >1])

# Subset 
G_bal <- G[G$pltID %in% g1.pltIDs,] 

G_bal <- G_bal %>% group_by(pltID) %>% slice(c(1,n()))
```

```{r}
## 211 - Northeastern Mixed Forest
G_211 <- G_bal[G_bal$ECOPROVCD == "211",]
## 212 - Laurentian Mixed Forest
G_212 <- G_bal[G_bal$ECOPROVCD == "212",]
## 221 -  Eastern Broadleaf Forest
G_221 <- G_bal[G_bal$ECOPROVCD == "221",]
## 222 - Midwest Broadleaf Forest
G_222 <- G_bal[G_bal$ECOPROVCD == "222",]
## 223 - Central Interior Broadleaf Forest
G_223 <- G_bal[G_bal$ECOPROVCD == "223",]
## 231 - Southeastern Mixed Forest
G_231 <- G_bal[G_bal$ECOPROVCD == "231",]
## 232 - Outer Coastal Plain Mixed Forest
G_232 <- G_bal[G_bal$ECOPROVCD == "232",]
## 234 - Lower Mississippi Riverine Forest
G_234 <- G_bal[G_bal$ECOPROVCD == "234",]
## 242 - Pacific Lowland Mixed Forest
G_242 <- G_bal[G_bal$ECOPROVCD == "242",]
## 251 - Prairie Parkland (Temperate)
G_251 <- G_bal[G_bal$ECOPROVCD == "251",]
## 255 - Prairie Parkland (Subtropical)
G_255 <- G_bal[G_bal$ECOPROVCD == "255",]
## 263 - California Coastal Steppe - Mixed Forest and Redwood Forest
G_263 <- G_bal[G_bal$ECOPROVCD == "263",]
## 313 - Colorado Plateau Semi-Desert
G_313 <- G_bal[G_bal$ECOPROVCD == "313",]
## 331 - Great Plains/Palouse Dry Steppe
G_331 <- G_bal[G_bal$ECOPROVCD == "331",]
## 332 - Great Plains Steppe
G_332 <- G_bal[G_bal$ECOPROVCD == "332",]
## 342 - Intermountain Semi-Desert
G_342 <- G_bal[G_bal$ECOPROVCD == "342",]
## M211 - Adirondack-New England Mixed forest - Coniferous Forest - Alpine Meadow
G_M211 <- G_bal[G_bal$ECOPROVCD == "M211",]
## M221 - Central Appalachian Broadleaf Forest - Coniferous Forest - Meadow
G_M221 <- G_bal[G_bal$ECOPROVCD == "M221",]
## M223 - Ozark Broadleaf Forest Meadow
G_M223 <- G_bal[G_bal$ECOPROVCD == "M223",]
## M231 - Ouachita Mixed Forest
G_M231 <- G_bal[G_bal$ECOPROVCD == "M231",]
## M242 - Cascade Mixed Forest
G_M242 <- G_bal[G_bal$ECOPROVCD == "M242",]
## M261 - Sierran Steppe - Mixed Forest - Coniferous Forest - Alpine Meadow
G_M261 <- G_bal[G_bal$ECOPROVCD == "M261",]
## M262- California Coastal Range Coniferous Forest - Open Woodland - Shrub - Meadow
G_M262 <- G_bal[G_bal$ECOPROVCD == "M262",]
## M313 - Arizona-New Mexico Mountains Semi-Desert - Open Woodland - Coniferous Forest - Alpine Meadow
G_M313 <- G_bal[G_bal$ECOPROVCD == "M313",]
## M331 - Southern Rocky Mountain Steppe - Open Woodland - Coniferous Forest - Alpine Meadow
G_M331 <- G_bal[G_bal$ECOPROVCD == "M331",]
## M332 - Middle Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow
G_M332 <- G_bal[G_bal$ECOPROVCD == "M332",]
# M333 - Northern Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow
G_M333 <- G_bal[G_bal$ECOPROVCD == "M333",]
## M334 - Black Hills Coniferous Forest
G_M334 <- G_bal[G_bal$ECOPROVCD == "M334",]

##ECOPROVINCES NOT INCLUDED:
            ## 261 - California Coastal Chaparral Forest and Shrub
            G_261 <- G_bal[G_bal$ECOPROVCD == "261",]

            ## 262 - California Dry Steppe
            G_262 <- G_bal[G_bal$ECOPROVCD == "262",]

            ## 315 - Southwest Plateau and Plains Dry Steppe and Shrub
            G_315 <- G_bal[G_bal$ECOPROVCD == "315",]

            ## 321 - Chihuahuan Semi-Desert 
            G_321 <- G_bal[G_bal$ECOPROVCD == "321",]

            ## 322 - American Semidesert and Desert
            G_322 <- G_bal[G_bal$ECOPROVCD == "322",]
  
            ## 341 - Intermountain Semi-Desert and Desert
            G_341 <- G_bal[G_bal$ECOPROVCD == "341",]
            
            ## 411 - Everglades
            G_411 <- G_bal[G_bal$ECOPROVCD == "411",]
            
            ## M341 - Nevada-Utah Mountains semi-Desert - Coniferous Forest - Alpine Meadow
            G_M341 <- G_bal[G_bal$ECOPROVCD == "M341",]
```

```{r}
#### create BEST MODEL DATA FRAME -- to be filled in later 

Best_mods.P_bal <- data.frame(
  Code = c("211", "212", "221", "222", "223", "231", 
           "232", "234", "242", "251", "255", "261", 
           "262", "263", "313", "315", "321", "322", 
           "331", "332", "341", "342", "411", "M211", 
           "M221", "M223", "M231", "M242", "M261", "M262", "M313", 
           "M331", "M332", "M333", "M334", "M341"),
  Ecoregion = c(
      "Northeastern Mixed Forest", "Laurentian Mixed Forest", "Eastern Broadleaf Forest",
      "Midwest Broadleaf Forest", "Central Interior Broadleaf Forest", "Southeastern Mixed Forest",
      "Outer Coastal Plain Mixed Forest", "Lower Mississippi Riverine Forest", "Pacific Lowland Mixed Forest",
      "Prairie Parkland (Temperate)", "Prairie Parkland (Subtropical)", "California Coastal Chaparral Forest and Shrub",
      "California Dry Steppe", "California Coastal Steppe - Mixed Forest and Redwood Forest", "Colorado Plateau Semi-Desert",
      "Southwest Plateau and Plains Dry Steppe and Shrub", "Chihuahuan Semi-Desert", "American Semidesert and Desert",
      "Great Plains/Palouse Dry Steppe", "Great Plains Steppe", "Intermountain Semi-Desert and Desert",
      "Intermountain Semi-Desert", "Everglades", "Adirondack-New England Mixed forest - Coniferous Forest - Alpine Meadow",
      "Central Appalachian Broadleaf Forest - Coniferous Forest - Meadow", "Ozark Broadleaf Forest Meadow", "Ouachita Mixed Forest",
      "Cascade Mixed Forest", "Sierran Steppe - Mixed Forest - Coniferous Forest - Alpine Meadow", 
      "California Coastal Range Coniferous Forest - Open Woodland - Shrub - Meadow", 
      "Arizona-New Mexico Mountains Semi-Desert - Open Woodland - Coniferous Forest - Alpine Meadow", 
      "Southern Rocky Mountain Steppe - Open Woodland - Coniferous Forest - Alpine Meadow", 
      "Middle Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow", 
      "Northern Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow", "Black Hills Coniferous Forest", 
      "Nevada-Utah Mountains Semi-Desert - Coniferous Forest - Alpine Meadow"),  
  Sel.Mod.2 = rep("NA", 36),
  Sel.Mod.3 = rep("NA", 36),
  Best.Mod = rep("NA", 36)
)


Best_mods.P_nh <- data.frame(
  Code = c("211", "212", "221", "222", "223", "231", 
           "232", "234", "242", "251", "255", "261", 
           "262", "263", "313", "315", "321", "322", 
           "331", "332", "341", "342", "411", "M211", 
           "M221", "M223", "M231", "M242", "M261", "M262", "M313", 
           "M331", "M332", "M333", "M334", "M341"),
  Ecoregion = c(
      "Northeastern Mixed Forest", "Laurentian Mixed Forest", "Eastern Broadleaf Forest",
      "Midwest Broadleaf Forest", "Central Interior Broadleaf Forest", "Southeastern Mixed Forest",
      "Outer Coastal Plain Mixed Forest", "Lower Mississippi Riverine Forest", "Pacific Lowland Mixed Forest",
      "Prairie Parkland (Temperate)", "Prairie Parkland (Subtropical)", "California Coastal Chaparral Forest and Shrub",
      "California Dry Steppe", "California Coastal Steppe - Mixed Forest and Redwood Forest", "Colorado Plateau Semi-Desert",
      "Southwest Plateau and Plains Dry Steppe and Shrub", "Chihuahuan Semi-Desert", "American Semidesert and Desert",
      "Great Plains/Palouse Dry Steppe", "Great Plains Steppe", "Intermountain Semi-Desert and Desert",
      "Intermountain Semi-Desert", "Everglades", "Adirondack-New England Mixed forest - Coniferous Forest - Alpine Meadow",
      "Central Appalachian Broadleaf Forest - Coniferous Forest - Meadow", "Ozark Broadleaf Forest Meadow", "Ouachita Mixed Forest",
      "Cascade Mixed Forest", "Sierran Steppe - Mixed Forest - Coniferous Forest - Alpine Meadow", 
      "California Coastal Range Coniferous Forest - Open Woodland - Shrub - Meadow", 
      "Arizona-New Mexico Mountains Semi-Desert - Open Woodland - Coniferous Forest - Alpine Meadow", 
      "Southern Rocky Mountain Steppe - Open Woodland - Coniferous Forest - Alpine Meadow", 
      "Middle Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow", 
      "Northern Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow", "Black Hills Coniferous Forest", 
      "Nevada-Utah Mountains Semi-Desert - Coniferous Forest - Alpine Meadow"),  
  Sel.Mod.2 = rep("NA", 36),
  Sel.Mod.3 = rep("NA", 36),
  Best.Mod = rep("NA", 36)
)

```

```{r}
nls.param.df_bal <- data.frame(
   Code = c("211", "212", "221", "222", "223", "231", 
           "232", "234", "242", "251", "255", "261", 
           "262", "263", "313", "315", "321", "322", 
           "331", "332", "341", "342", "411", "M211", 
           "M221", "M223", "M231", "M242", "M261", "M262", "M313", 
           "M331", "M332", "M333", "M334", "M341"),
  Ecoregion = c(
      "Northeastern Mixed Forest", "Laurentian Mixed Forest", "Eastern Broadleaf Forest",
      "Midwest Broadleaf Forest", "Central Interior Broadleaf Forest", "Southeastern Mixed Forest",
      "Outer Coastal Plain Mixed Forest", "Lower Mississippi Riverine Forest", "Pacific Lowland Mixed Forest",
      "Prairie Parkland (Temperate)", "Prairie Parkland (Subtropical)", "California Coastal Chaparral Forest and Shrub",
      "California Dry Steppe", "California Coastal Steppe - Mixed Forest and Redwood Forest", "Colorado Plateau Semi-Desert",
      "Southwest Plateau and Plains Dry Steppe and Shrub", "Chihuahuan Semi-Desert", "American Semidesert and Desert",
      "Great Plains/Palouse Dry Steppe", "Great Plains Steppe", "Intermountain Semi-Desert and Desert",
      "Intermountain Semi-Desert", "Everglades", "Adirondack-New England Mixed forest - Coniferous Forest - Alpine Meadow",
      "Central Appalachian Broadleaf Forest - Coniferous Forest - Meadow", "Ozark Broadleaf Forest Meadow", "Ouachita Mixed Forest",
      "Cascade Mixed Forest", "Sierran Steppe - Mixed Forest - Coniferous Forest - Alpine Meadow", 
      "California Coastal Range Coniferous Forest - Open Woodland - Shrub - Meadow", 
      "Arizona-New Mexico Mountains Semi-Desert - Open Woodland - Coniferous Forest - Alpine Meadow", 
      "Southern Rocky Mountain Steppe - Open Woodland - Coniferous Forest - Alpine Meadow", 
      "Middle Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow", 
      "Northern Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow", "Black Hills Coniferous Forest", 
      "Nevada-Utah Mountains Semi-Desert - Coniferous Forest - Alpine Meadow"), 
  region = c("east", "east", "east", "east", "east", "east", 
             "east", "east", "pacific", "east", "east", "pacific",  
             "pacific", "pacific", "interior west", "interior west", "interior west", "interior west", 
             "interior west", "interior west", "interior west", "interior west", "east", "east", 
             "east", "east", "east", "pacific", "pacific",  "interior west", 
             "interior west", "interior west", "interior west", "interior west", "interior west", "interior west"),
             ## note: everglades treated as east, but not technically east -- separate region
  `n.obs` = c(length(G_211$pltID), length(G_212$pltID), length(G_221$pltID),
              length(G_222$pltID), length(G_223$pltID), length(G_231$pltID),
              length(G_232$pltID), length(G_234$pltID), length(G_242$pltID), 
              length(G_251$pltID),  length(G_255$pltID), length(G_261$pltID),
              length(G_262$pltID), length(G_263$pltID), length(G_313$pltID),
              length(G_315$pltID), length(G_321$pltID), length(G_322$pltID),
              length(G_331$pltID), length(G_332$pltID), length(G_341$pltID),
              length(G_342$pltID), length(G_411$pltID), length(G_M211$pltID),  
              length(G_M221$pltID), length(G_M223$pltID), length(G_M231$pltID),
              length(G_M242$pltID), length(G_M261$pltID), length(G_M262$pltID), 
              length(G_M313$pltID), length(G_M331$pltID), length(G_M332$pltID),
              length(G_M333$pltID), length(G_M334$pltID), length(G_M341$pltID)), 
  `n.plots` = c(length(unique(G_211$pltID)), length(unique(G_212$pltID)), length(unique(G_221$pltID)),
                length(unique(G_222$pltID)), length(unique(G_223$pltID)), length(unique(G_231$pltID)),
                length(unique(G_232$pltID)), length(unique(G_234$pltID)), length(unique(G_242$pltID)), 
                length(unique(G_251$pltID)), length(unique(G_255$pltID)), length(unique(G_261$pltID)),
                length(unique(G_262$pltID)), length(unique(G_263$pltID)), length(unique(G_313$pltID)),
                length(unique(G_315$pltID)), length(unique(G_321$pltID)), length(unique(G_322$pltID)),
                length(unique(G_331$pltID)), length(unique(G_332$pltID)), length(unique(G_341$pltID)),
                length(unique(G_342$pltID)), length(unique(G_411$pltID)), length(unique(G_M211$pltID)),  
                length(unique(G_M221$pltID)), length(unique(G_M223$pltID)), length(unique(G_M231$pltID)),
                length(unique(G_M242$pltID)), length(unique(G_M261$pltID)), length(unique(G_M262$pltID)),
                length(unique(G_M313$pltID)), length(unique(G_M331$pltID)), length(unique(G_M332$pltID)),
                length(unique(G_M333$pltID)), length(unique(G_M334$pltID)), length(unique(G_M341$pltID))),
   ge             = rep(-9999, 36), 
   ge.variance    = rep(-9999, 36), 
   `ge.2.5`       = rep(-9999, 36),
   `ge.97.5`      = rep(-9999, 36),
   phi            = rep(-9999, 36),
   phi.variance   = rep(-9999, 36),  
   `phi.2.5`      = rep(-9999, 36),
   `phi.97.5`     = rep(-9999, 36),
   alpha          = rep(-9999, 36),
   alpha.variance = rep(-9999, 36),
   `alpha.2.5`    = rep(-9999, 36),
   `alpha.97.5`   = rep(-9999, 36),
   A              = rep(-9999, 36),
   `A.2.5`        = rep(-9999, 36),
   `A.97.5`       = rep(-9999, 36),
   k              = rep(-9999, 36),
   `k.2.5`        = rep(-9999, 36),
   `k.97.5`       = rep(-9999, 36),
   a              = rep(-9999, 36),
   `a.2.5`        = rep(-9999, 36),
   `a.97.5`       = rep(-9999, 36),
   b              = rep(-9999, 36), 
   b.se           = rep(-9999, 36),
   `b.2.5`        = rep(-9999, 36),
   `b.97.5`       = rep(-9999, 36),
   c              = rep(-9999, 36),
   `c.2.5`        = rep(-9999, 36),
   `c.97.5`       = rep(-9999, 36),
   d              = rep(-9999, 36), 
   `d.2.5`        = rep(-9999, 36),
   `d.97.5`       = rep(-9999, 36)
  )

nls.param.df_nh <- data.frame(
   Code = c("211", "212", "221", "222", "223", "231", 
           "232", "234", "242", "251", "255", "261", 
           "262", "263", "313", "315", "321", "322", 
           "331", "332", "341", "342", "411", "M211", 
           "M221", "M223", "M231", "M242", "M261", "M262", "M313", 
           "M331", "M332", "M333", "M334", "M341"),
  Ecoregion = c(
      "Northeastern Mixed Forest", "Laurentian Mixed Forest", "Eastern Broadleaf Forest",
      "Midwest Broadleaf Forest", "Central Interior Broadleaf Forest", "Southeastern Mixed Forest",
      "Outer Coastal Plain Mixed Forest", "Lower Mississippi Riverine Forest", "Pacific Lowland Mixed Forest",
      "Prairie Parkland (Temperate)", "Prairie Parkland (Subtropical)", "California Coastal Chaparral Forest and Shrub",
      "California Dry Steppe", "California Coastal Steppe - Mixed Forest and Redwood Forest", "Colorado Plateau Semi-Desert",
      "Southwest Plateau and Plains Dry Steppe and Shrub", "Chihuahuan Semi-Desert", "American Semidesert and Desert",
      "Great Plains/Palouse Dry Steppe", "Great Plains Steppe", "Intermountain Semi-Desert and Desert",
      "Intermountain Semi-Desert", "Everglades", "Adirondack-New England Mixed forest - Coniferous Forest - Alpine Meadow",
      "Central Appalachian Broadleaf Forest - Coniferous Forest - Meadow", "Ozark Broadleaf Forest Meadow", "Ouachita Mixed Forest",
      "Cascade Mixed Forest", "Sierran Steppe - Mixed Forest - Coniferous Forest - Alpine Meadow", 
      "California Coastal Range Coniferous Forest - Open Woodland - Shrub - Meadow", 
      "Arizona-New Mexico Mountains Semi-Desert - Open Woodland - Coniferous Forest - Alpine Meadow", 
      "Southern Rocky Mountain Steppe - Open Woodland - Coniferous Forest - Alpine Meadow", 
      "Middle Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow", 
      "Northern Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow", "Black Hills Coniferous Forest", 
      "Nevada-Utah Mountains Semi-Desert - Coniferous Forest - Alpine Meadow"), 
  region = c("east", "east", "east", "east", "east", "east", 
             "east", "east", "pacific", "east", "east", "pacific",  
             "pacific", "pacific", "interior west", "interior west", "interior west", "interior west", 
             "interior west", "interior west", "interior west", "interior west", "east", "east", 
             "east", "east", "east", "pacific", "pacific",  "interior west", 
             "interior west", "interior west", "interior west", "interior west", "interior west", "interior west"),
             ## note: everglades treated as east, but not technically east -- separate region
  `n.obs` = c(length(G_211$pltID), length(G_212$pltID), length(G_221$pltID),
              length(G_222$pltID), length(G_223$pltID), length(G_231$pltID),
              length(G_232$pltID), length(G_234$pltID), length(G_242$pltID), 
              length(G_251$pltID),  length(G_255$pltID), length(G_261$pltID),
              length(G_262$pltID), length(G_263$pltID), length(G_313$pltID),
              length(G_315$pltID), length(G_321$pltID), length(G_322$pltID),
              length(G_331$pltID), length(G_332$pltID), length(G_341$pltID),
              length(G_342$pltID), length(G_411$pltID), length(G_M211$pltID),  
              length(G_M221$pltID), length(G_M223$pltID), length(G_M231$pltID),
              length(G_M242$pltID), length(G_M261$pltID), length(G_M262$pltID), 
              length(G_M313$pltID), length(G_M331$pltID), length(G_M332$pltID),
              length(G_M333$pltID), length(G_M334$pltID), length(G_M341$pltID)), 
  `n.plots` = c(length(unique(G_211$pltID)), length(unique(G_212$pltID)), length(unique(G_221$pltID)),
                length(unique(G_222$pltID)), length(unique(G_223$pltID)), length(unique(G_231$pltID)),
                length(unique(G_232$pltID)), length(unique(G_234$pltID)), length(unique(G_242$pltID)), 
                length(unique(G_251$pltID)), length(unique(G_255$pltID)), length(unique(G_261$pltID)),
                length(unique(G_262$pltID)), length(unique(G_263$pltID)), length(unique(G_313$pltID)),
                length(unique(G_315$pltID)), length(unique(G_321$pltID)), length(unique(G_322$pltID)),
                length(unique(G_331$pltID)), length(unique(G_332$pltID)), length(unique(G_341$pltID)),
                length(unique(G_342$pltID)), length(unique(G_411$pltID)), length(unique(G_M211$pltID)),  
                length(unique(G_M221$pltID)), length(unique(G_M223$pltID)), length(unique(G_M231$pltID)),
                length(unique(G_M242$pltID)), length(unique(G_M261$pltID)), length(unique(G_M262$pltID)),
                length(unique(G_M313$pltID)), length(unique(G_M331$pltID)), length(unique(G_M332$pltID)),
                length(unique(G_M333$pltID)), length(unique(G_M334$pltID)), length(unique(G_M341$pltID))),
   ge             = rep(-9999, 36), 
   ge.variance    = rep(-9999, 36), 
   `ge.2.5`       = rep(-9999, 36),
   `ge.97.5`      = rep(-9999, 36),
   phi            = rep(-9999, 36),
   phi.variance   = rep(-9999, 36),  
   `phi.2.5`      = rep(-9999, 36),
   `phi.97.5`     = rep(-9999, 36),
   alpha          = rep(-9999, 36),
   alpha.variance = rep(-9999, 36),
   `alpha.2.5`    = rep(-9999, 36),
   `alpha.97.5`   = rep(-9999, 36),
   A              = rep(-9999, 36),
   `A.2.5`        = rep(-9999, 36),
   `A.97.5`       = rep(-9999, 36),
   k              = rep(-9999, 36),
   `k.2.5`        = rep(-9999, 36),
   `k.97.5`       = rep(-9999, 36),
   a              = rep(-9999, 36),
   `a.2.5`        = rep(-9999, 36),
   `a.97.5`       = rep(-9999, 36),
   b              = rep(-9999, 36), 
   b.se           = rep(-9999, 36),
   `b.2.5`        = rep(-9999, 36),
   `b.97.5`       = rep(-9999, 36),
   c              = rep(-9999, 36),
   `c.2.5`        = rep(-9999, 36),
   `c.97.5`       = rep(-9999, 36),
   d              = rep(-9999, 36), 
   `d.2.5`        = rep(-9999, 36),
   `d.97.5`       = rep(-9999, 36)
  )

```

# Analysis 1: Temporally-balanced analysis

## 211 - Northeastern Mixed Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_211 <- round(quantile(G_211$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_211)))){
  cutvec_211 <- round(quantile(G_211$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_211 <- unname(round(cutvec_211[-length(cutvec_211)] + diff(cutvec_211)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_211$STDAGE_t2_bin<-  cut(G_211$STDAGE_t2, cutvec_211)
## then get bin means
G_211_bin_means <- tapply(G_211$B_plt_t2_MgHa, cut(G_211$STDAGE_t2,  cutvec_211), mean)

## make column weights.2
G_211$nls_weights.2 <- as.numeric(1/(G_211_bin_means[match(G_211$STDAGE_t2_bin, names(G_211_bin_means))])^2)

}

```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_211.1 <- nls(f_1, data = G_211, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_211$nls_weights.2), 
 )

## phi
try(
  nls_211.2 <- nls(f_2, data=G_211, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_211$nls_weights.2), 
 )

# phi/alpha
try(
  nls_211.3 <- nls(f_3 , data = G_211, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_211$nls_weights.2), 
 )

## test
if(exists("nls_211.1") & exists("nls_211.2") & exists("nls_211.3")){
  print(anova(nls_211.1, nls_211.2, nls_211.3))
} else if(exists("nls_211.2") & exists("nls_211.3")){
  print(anova(nls_211.2, nls_211.3))
} else if(exists("nls_211.1") & exists("nls_211.2")){
  print(anova(nls_211.1, nls_211.2))
}
 
## AIC comparison
AIC1_211 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_211.1"), AIC(get("nls_211.1")), NA),
            ifelse(exists("nls_211.2"), AIC(get("nls_211.2")), NA),
            ifelse(exists("nls_211.3"), AIC(get("nls_211.3")), NA)
            ))

print(AIC1_211) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_211[!is.na(AIC1_211$AIC) & AIC1_211$AIC == min(AIC1_211$AIC, na.rm = T),]$model

try(summary(get(paste("nls_211.",  Mod.Sel1, sep =""))) ) #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_211.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_211.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_211.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_211.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_211.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_211.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_211.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_211.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_211.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_211,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_211$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_211.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_211,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_211$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_211.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_211,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_211$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_211.", Mod.Sel1, sep ="")) &
     exists(paste("nls_211.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_211.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_211.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_211.", Mod.Sel1, sep ="")),
             get(paste("nls_211.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_211.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_211.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_211.", Mod.Sel1, sep ="")) &
         exists(paste("nls_211.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_211.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_211.", Mod.Sel1, sep ="")),
               get(paste("nls_211.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_211.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_211.", Mod.Sel1, sep ="")) &
           exists(paste("nls_211.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_211.", Mod.Sel1, sep ="")),
                 get(paste("nls_211.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_211.", Mod.Sel1, sep ="")) &
              exists(paste("nls_211.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_211.", Mod.Sel1, sep ="")),
                    get(paste("nls_211.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_211.", Mod.Sel1, sep ="")) &
                exists(paste("nls_211.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_211.", Mod.Sel1, sep ="")),
                      get(paste("nls_211.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_211 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_211.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_211.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_211.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_211.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_211.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_211.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_211.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_211.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_211)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_211[!is.na(AIC2_211$AIC) & AIC2_211$AIC == min(AIC2_211$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "211",]$Sel.Mod.2 <- Mod.Sel2
 
## write coefficients to table 
coefs <- coef(get(paste("nls_211.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_211.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "211",]$ge.variance <- vcov(get(paste("nls_211.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "211",]$phi.variance <- vcov(get(paste("nls_211.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "211",]$alpha.variance <- vcov(get(paste("nls_211.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "211",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "211",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "211",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "211",]$A <- coefs["A"]
nls.param.df_bal[nls.param.df_bal$Code == "211",]$k <- coefs["k"]

nls.param.df_bal[nls.param.df_bal$Code == "211",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "211",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "211",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "211",]$A.2.5 <- intervals_low["A"]
nls.param.df_bal[nls.param.df_bal$Code == "211",]$k.2.5 <- intervals_low["k"]

nls.param.df_bal[nls.param.df_bal$Code == "211",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "211",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "211",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "211",]$A.97.5 <- intervals_high["A"]
nls.param.df_bal[nls.param.df_bal$Code == "211",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_211.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_211.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_211.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_211.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_211$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_211.4 <- nls(f_4, data = G_211, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_211$nls_weights.2), 
 )

## phi
try(
  nls_211.5 <- nls(f_5, data=G_211, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_211$nls_weights.2), 
 )

# phi/alpha
try(
  nls_211.6 <- nls(f_6, data = G_211, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_211$nls_weights.2), 
 )

## test
if(exists("nls_211.4") & exists("nls_211.5") & exists("nls_211.6")){
  print(anova(nls_211.4, nls_211.5, nls_211.6))
} else if(exists("nls_211.4") & exists("nls_211.6")){
  print(anova(nls_211.4, nls_211.6))
} else if(exists("nls_211.5") & exists("nls_211.6")){
  print(anova(nls_211.5, nls_211.6))
} else if(exists("nls_211.4") & exists("nls_211.5")){
  print(anova(nls_211.4, nls_211.5))
}

## AIC comparison
AIC3_211 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_211[AIC2_211$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_211.4"), AIC(get("nls_211.4")), NA),
            ifelse(exists("nls_211.5"), AIC(get("nls_211.5")), NA),
            ifelse(exists("nls_211.6"), AIC(get("nls_211.6")), NA)
            ))

print(AIC3_211) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_211[!is.na(AIC3_211$AIC) & AIC3_211$AIC == min(AIC3_211$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "211",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_bal[Best_mods.P_bal$Code == "211",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_211.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_211.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "211",]$ge.variance <- vcov(get(paste("nls_211.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "211",]$phi.variance <- vcov(get(paste("nls_211.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "211",]$alpha.variance <- vcov(get(paste("nls_211.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "211",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "211",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "211",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "211",]$a <- coefs["a"]
nls.param.df_bal[nls.param.df_bal$Code == "211",]$b <- coefs["b"]
nls.param.df_bal[nls.param.df_bal$Code == "211",]$c <- coefs["c"]
nls.param.df_bal[nls.param.df_bal$Code == "211",]$d <- coefs["d"]

nls.param.df_bal[nls.param.df_bal$Code == "211",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "211",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "211",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "211",]$a.2.5 <- intervals_low["a"]
nls.param.df_bal[nls.param.df_bal$Code == "211",]$b.2.5 <- intervals_low["b"]
nls.param.df_bal[nls.param.df_bal$Code == "211",]$c.2.5 <- intervals_low["c"]
nls.param.df_bal[nls.param.df_bal$Code == "211",]$d.2.5 <- intervals_low["d"]

nls.param.df_bal[nls.param.df_bal$Code == "211",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "211",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "211",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "211",]$a.97.5 <- intervals_high["a"]
nls.param.df_bal[nls.param.df_bal$Code == "211",]$b.97.5 <- intervals_high["b"]
nls.param.df_bal[nls.param.df_bal$Code == "211",]$c.97.5 <- intervals_high["c"]
nls.param.df_bal[nls.param.df_bal$Code == "211",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_211.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_211.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_211.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_211.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_211 <- nlsResiduals(
  get(paste("nls_211.",  Mod.Sel3, sep =""))
  )

### plot residuals
plot(resid_211)

## test residuals
if(length(G_211$pltID) < 5001) {test.nlsResiduals(resid_211)}

}  else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 | length(Mod.Sel3) & fit.models == T) {

G_211_pred <- predict(get(paste("nls_211.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_211$MEASTIME_t2, na.rm = T), max(G_211$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_211$STDAGE_t2), by = 1))
                      } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_211$MEASTIME_t2, na.rm = T), max(G_211$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_211$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_211$DeltaPDSI, na.rm = T), max(G_211$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_211$MEASTIME_t2, na.rm = T), max(G_211$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_211$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_211$B_L_prop, na.rm = T), max(G_211$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_211$DeltaPDSI, na.rm = T), max(G_211$STDAGE_t2)))
                      } )

G_211_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_211$STDAGE_t2),by = 1),  
                            "fitted"=G_211_pred)

## plot
gg.211 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_211, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_211, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_211))), breaks = cutvec_211) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_211_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_211_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("211 - Northeastern Mixed Forest") + 
          
          #ylim(0, max(G_211_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_211,1)*1.05), expand = c(0,0))

gg.211

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_211 <- data.frame(
  bin = as.factor(levels(cut(G_211$STDAGE_t2, cutvec_211))),
  data.mean = tapply(G_211$B_plt_t2_MgHa, cut(G_211$STDAGE_t2, cutvec_211), 
                     mean), 
  data.CI.high =  tapply(G_211$B_plt_t2_MgHa, cut(G_211$STDAGE_t2, cutvec_211), 
                    high.CI), 
  data.CI.low = tapply(G_211$B_plt_t2_MgHa, cut(G_211$STDAGE_t2, cutvec_211),
                    low.CI), 
  pred.mean = G_211_pred_df[G_211_pred_df$STDAGE_t2 %in% bin_mids_211,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_211 <-  DM_compare_211 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_211$bin)[gtools::mixedorder(levels(DM_compare_211$bin))]))

## ggplot
gg.211.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_211) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_211))), 
                              labels = levels(DM_compare_211$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("211 - Northeastern Mixed Forest",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +  
           theme_classic() + 
           # xlim(min(DM_compare_211$data.CI.low)-0.25, max(DM_compare_211$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_211$pred.CI.low)-0.25, max(DM_compare_211$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.211.B2

}   else {print("cannot plot observed vs. predicted")}
```

## 212 - Laurentian Mixed Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_212 <- round(quantile(G_212$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_212)))){
  cutvec_212 <- round(quantile(G_212$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_212 <- unname(round(cutvec_212[-length(cutvec_212)] + diff(cutvec_212)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_212$STDAGE_t2_bin<-  cut(G_212$STDAGE_t2, cutvec_212)
## then get bin means
G_212_bin_means <- tapply(G_212$B_plt_t2_MgHa, cut(G_212$STDAGE_t2, cutvec_212), mean)

## make column weights.2
G_212$nls_weights.2 <- as.numeric(1/(G_212_bin_means[match(G_212$STDAGE_t2_bin, names(G_212_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_212.1 <- nls(f_1, data = G_212, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_212$nls_weights.2), 
 )

## phi
try(
  nls_212.2 <- nls(f_2, data=G_212, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_212$nls_weights.2), 
 )

# phi/alpha
try(
  nls_212.3 <- nls(f_3 , data = G_212, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_212$nls_weights.2), 
 )

## test
if(exists("nls_212.1") & exists("nls_212.2") & exists("nls_212.3")){
  print(anova(nls_212.1, nls_212.2, nls_212.3))
} else if(exists("nls_212.2") & exists("nls_212.3")){
  print(anova(nls_212.2, nls_212.3))
} else if(exists("nls_212.1") & exists("nls_212.2")){
  print(anova(nls_212.1, nls_212.2))
}
 
## AIC comparison
AIC1_212 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_212.1"), AIC(get("nls_212.1")), NA),
            ifelse(exists("nls_212.2"), AIC(get("nls_212.2")), NA),
            ifelse(exists("nls_212.3"), AIC(get("nls_212.3")), NA)
            ))

print(AIC1_212) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_212[!is.na(AIC1_212$AIC) & AIC1_212$AIC == min(AIC1_212$AIC, na.rm = T),]$model

try(summary(get(paste("nls_212.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_212.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_212.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_212.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_212.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_212.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_212.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_212.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_212.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_212.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_212,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_212$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_212.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_212,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_212$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_212.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_212,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_212$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_212.", Mod.Sel1, sep ="")) &
     exists(paste("nls_212.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_212.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_212.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_212.", Mod.Sel1, sep ="")),
             get(paste("nls_212.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_212.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_212.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_212.", Mod.Sel1, sep ="")) &
         exists(paste("nls_212.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_212.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_212.", Mod.Sel1, sep ="")),
               get(paste("nls_212.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_212.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_212.", Mod.Sel1, sep ="")) &
           exists(paste("nls_212.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_212.", Mod.Sel1, sep ="")),
                 get(paste("nls_212.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_212.", Mod.Sel1, sep ="")) &
              exists(paste("nls_212.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_212.", Mod.Sel1, sep ="")),
                    get(paste("nls_212.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_212.", Mod.Sel1, sep ="")) &
                exists(paste("nls_212.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_212.", Mod.Sel1, sep ="")),
                      get(paste("nls_212.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_212 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_212.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_212.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_212.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_212.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_212.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_212.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_212.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_212.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_212)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_212[!is.na(AIC2_212$AIC) & AIC2_212$AIC == min(AIC2_212$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "212",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_212.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_212.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "212",]$ge.variance <- vcov(get(paste("nls_212.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "212",]$phi.variance <- vcov(get(paste("nls_212.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "212",]$alpha.variance <- vcov(get(paste("nls_212.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "212",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "212",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "212",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "212",]$A <- coefs["A"]
nls.param.df_bal[nls.param.df_bal$Code == "212",]$k <- coefs["k"]

nls.param.df_bal[nls.param.df_bal$Code == "212",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "212",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "212",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "212",]$A.2.5 <- intervals_low["A"]
nls.param.df_bal[nls.param.df_bal$Code == "212",]$k.2.5 <- intervals_low["k"]

nls.param.df_bal[nls.param.df_bal$Code == "212",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "212",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "212",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "212",]$A.97.5 <- intervals_high["A"]
nls.param.df_bal[nls.param.df_bal$Code == "212",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_212.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_212.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_212.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_212.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_212$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_212.4 <- nls(f_4, data = G_212, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_212$nls_weights.2), 
 )

## phi
try(
  nls_212.5 <- nls(f_5, data=G_212, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_212$nls_weights.2), 
 )

# phi/alpha
try(
  nls_212.6 <- nls(f_6, data = G_212, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_212$nls_weights.2), 
 )

## test
if(exists("nls_212.4") & exists("nls_212.5") & exists("nls_212.6")){
  print(anova(nls_212.4, nls_212.5, nls_212.6))
} else if(exists("nls_212.4") & exists("nls_212.6")){
  print(anova(nls_212.4, nls_212.6))
} else if(exists("nls_212.5") & exists("nls_212.6")){
  print(anova(nls_212.5, nls_212.6))
} else if(exists("nls_212.4") & exists("nls_212.5")){
  print(anova(nls_212.4, nls_212.5))
}

## AIC comparison
AIC3_212 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_212[AIC2_212$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_212.4"), AIC(get("nls_212.4")), NA),
            ifelse(exists("nls_212.5"), AIC(get("nls_212.5")), NA),
            ifelse(exists("nls_212.6"), AIC(get("nls_212.6")), NA)
            ))

print(AIC3_212) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_212[!is.na(AIC3_212$AIC) & AIC3_212$AIC == min(AIC3_212$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "212",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_bal[Best_mods.P_bal$Code == "212",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_212.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_212.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "212",]$ge.variance <- vcov(get(paste("nls_212.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "212",]$phi.variance <- vcov(get(paste("nls_212.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "212",]$alpha.variance <- vcov(get(paste("nls_212.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "212",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "212",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "212",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "212",]$a <- coefs["a"]
nls.param.df_bal[nls.param.df_bal$Code == "212",]$b <- coefs["b"]
nls.param.df_bal[nls.param.df_bal$Code == "212",]$c <- coefs["c"]
nls.param.df_bal[nls.param.df_bal$Code == "212",]$d <- coefs["d"]

nls.param.df_bal[nls.param.df_bal$Code == "212",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "212",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "212",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "212",]$a.2.5 <- intervals_low["a"]
nls.param.df_bal[nls.param.df_bal$Code == "212",]$b.2.5 <- intervals_low["b"]
nls.param.df_bal[nls.param.df_bal$Code == "212",]$c.2.5 <- intervals_low["c"]
nls.param.df_bal[nls.param.df_bal$Code == "212",]$d.2.5 <- intervals_low["d"]

nls.param.df_bal[nls.param.df_bal$Code == "212",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "212",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "212",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "212",]$a.97.5 <- intervals_high["a"]
nls.param.df_bal[nls.param.df_bal$Code == "212",]$b.97.5 <- intervals_high["b"]
nls.param.df_bal[nls.param.df_bal$Code == "212",]$c.97.5 <- intervals_high["c"]
nls.param.df_bal[nls.param.df_bal$Code == "212",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_212.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_212.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_212.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_212.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {
  
## calculate residuals
resid_212 <- nlsResiduals(
  get(paste("nls_212.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_212)

## test residuals
if(length(G_212$pltID) < 5001) {test.nlsResiduals(resid_212)}

}  else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_212_pred <- predict(get(paste("nls_212.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_212$MEASTIME_t2, na.rm = T), max(G_212$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_212$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_212$MEASTIME_t2, na.rm = T), max(G_212$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_212$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_212$DeltaPDSI, na.rm = T), max(G_212$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_212$MEASTIME_t2, na.rm = T), max(G_212$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_212$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_212$B_L_prop, na.rm = T), max(G_212$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_212$DeltaPDSI, na.rm = T), max(G_212$STDAGE_t2)))
                      } )

G_212_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_212$STDAGE_t2),by = 1),  
                            "fitted"=G_212_pred)


## plot
gg.212 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_212, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_212, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_212))), breaks = cutvec_212) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_212_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_212_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("212 - Laurentian Mixed Forest") + 
          
          #ylim(0, max(G_212_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_212,1)*1.05), expand = c(0,0))

gg.212

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_212 <- data.frame(
  bin = as.factor(levels(cut(G_212$STDAGE_t2, cutvec_212))),
  data.mean = tapply(G_212$B_plt_t2_MgHa, cut(G_212$STDAGE_t2, cutvec_212), 
                     mean), 
  data.CI.high =  tapply(G_212$B_plt_t2_MgHa, cut(G_212$STDAGE_t2, cutvec_212), 
                    high.CI), 
  data.CI.low = tapply(G_212$B_plt_t2_MgHa, cut(G_212$STDAGE_t2, cutvec_212),
                    low.CI), 
  pred.mean = G_212_pred_df[G_212_pred_df$STDAGE_t2 %in% bin_mids_212,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_212 <-  DM_compare_212 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_212$bin)[gtools::mixedorder(levels(DM_compare_212$bin))]))

## ggplot
gg.212.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_212) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_212))), 
                              labels = levels(DM_compare_212$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("212 - Laurentain Mixed Forest",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +
           theme_classic() + 
           # xlim(min(DM_compare_212$data.CI.low)-0.25, max(DM_compare_212$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_212$pred.CI.low)-0.25, max(DM_compare_212$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.212.B2

}   else {print("cannot plot observed vs. predicted")}
```

## 221 - Eastern Broadleaf Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_221 <- round(quantile(G_221$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_221)))){
  cutvec_221 <- round(quantile(G_221$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_221 <- unname(round(cutvec_221[-length(cutvec_221)] + diff(cutvec_221)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_221$STDAGE_t2_bin<-  cut(G_221$STDAGE_t2, cutvec_221)
## then get bin means
G_221_bin_means <- tapply(G_221$B_plt_t2_MgHa, cut(G_221$STDAGE_t2, cutvec_221), mean)

## make column weights.2
G_221$nls_weights.2 <- as.numeric(1/(G_221_bin_means[match(G_221$STDAGE_t2_bin, names(G_221_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_221.1 <- nls(f_1, data = G_221, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_221$nls_weights.2), 
 )

## phi
try(
  nls_221.2 <- nls(f_2, data=G_221, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_221$nls_weights.2), 
 )

# phi/alpha
try(
  nls_221.3 <- nls(f_3 , data = G_221, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_221$nls_weights.2), 
 )

## test
if(exists("nls_221.1") & exists("nls_221.2") & exists("nls_221.3")){
  print(anova(nls_221.1, nls_221.2, nls_221.3))
} else if(exists("nls_221.2") & exists("nls_221.3")){
  print(anova(nls_221.2, nls_221.3))
} else if(exists("nls_221.1") & exists("nls_221.2")){
  print(anova(nls_221.1, nls_221.2))
}
 
## AIC comparison
AIC1_221 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_221.1"), AIC(get("nls_221.1")), NA),
            ifelse(exists("nls_221.2"), AIC(get("nls_221.2")), NA),
            ifelse(exists("nls_221.3"), AIC(get("nls_221.3")), NA)
            ))

print(AIC1_221) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_221[!is.na(AIC1_221$AIC) & AIC1_221$AIC == min(AIC1_221$AIC, na.rm = T),]$model

try(summary(get(paste("nls_221.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_221.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_221.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_221.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_221.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_221.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_221.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_221.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_221.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_221.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_221,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_221$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_221.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_221,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_221$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_221.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_221,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_221$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_221.", Mod.Sel1, sep ="")) &
     exists(paste("nls_221.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_221.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_221.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_221.", Mod.Sel1, sep ="")),
             get(paste("nls_221.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_221.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_221.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_221.", Mod.Sel1, sep ="")) &
         exists(paste("nls_221.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_221.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_221.", Mod.Sel1, sep ="")),
               get(paste("nls_221.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_221.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_221.", Mod.Sel1, sep ="")) &
           exists(paste("nls_221.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_221.", Mod.Sel1, sep ="")),
                 get(paste("nls_221.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_221.", Mod.Sel1, sep ="")) &
              exists(paste("nls_221.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_221.", Mod.Sel1, sep ="")),
                    get(paste("nls_221.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_221.", Mod.Sel1, sep ="")) &
                exists(paste("nls_221.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_221.", Mod.Sel1, sep ="")),
                      get(paste("nls_221.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_221 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_221.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_221.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_221.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_221.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_221.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_221.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_221.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_221.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_221)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_221[!is.na(AIC2_221$AIC) & AIC2_221$AIC == min(AIC2_221$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "221",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_221.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_221.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "221",]$ge.variance <- vcov(get(paste("nls_221.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "221",]$phi.variance <- vcov(get(paste("nls_221.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "221",]$alpha.variance <- vcov(get(paste("nls_221.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "221",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "221",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "221",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "221",]$A <- coefs["A"]
nls.param.df_bal[nls.param.df_bal$Code == "221",]$k <- coefs["k"]

nls.param.df_bal[nls.param.df_bal$Code == "221",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "221",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "221",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "221",]$A.2.5 <- intervals_low["A"]
nls.param.df_bal[nls.param.df_bal$Code == "221",]$k.2.5 <- intervals_low["k"]

nls.param.df_bal[nls.param.df_bal$Code == "221",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "221",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "221",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "221",]$A.97.5 <- intervals_high["A"]
nls.param.df_bal[nls.param.df_bal$Code == "221",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_221.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_221.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_221.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_221.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_221$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_221.4 <- nls(f_4, data = G_221, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_221$nls_weights.2), 
 )

## phi
try(
  nls_221.5 <- nls(f_5, data=G_221, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_221$nls_weights.2), 
 )

# phi/alpha
try(
  nls_221.6 <- nls(f_6, data = G_221, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_221$nls_weights.2), 
 )

## test
if(exists("nls_221.4") & exists("nls_221.5") & exists("nls_221.6")){
  print(anova(nls_221.4, nls_221.5, nls_221.6))
} else if(exists("nls_221.4") & exists("nls_221.6")){
  print(anova(nls_221.4, nls_221.6))
} else if(exists("nls_221.5") & exists("nls_221.6")){
  print(anova(nls_221.5, nls_221.6))
} else if(exists("nls_221.4") & exists("nls_221.5")){
  print(anova(nls_221.4, nls_221.5))
}

## AIC comparison
AIC3_221 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_221[AIC2_221$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_221.4"), AIC(get("nls_221.4")), NA),
            ifelse(exists("nls_221.5"), AIC(get("nls_221.5")), NA),
            ifelse(exists("nls_221.6"), AIC(get("nls_221.6")), NA)
            ))

print(AIC3_221) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_221[!is.na(AIC3_221$AIC) & AIC3_221$AIC == min(AIC3_221$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "221",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_bal[Best_mods.P_bal$Code == "221",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_221.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_221.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "221",]$ge.variance <- vcov(get(paste("nls_221.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "221",]$phi.variance <- vcov(get(paste("nls_221.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "221",]$alpha.variance <- vcov(get(paste("nls_221.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "221",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "221",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "221",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "221",]$a <- coefs["a"]
nls.param.df_bal[nls.param.df_bal$Code == "221",]$b <- coefs["b"]
nls.param.df_bal[nls.param.df_bal$Code == "221",]$c <- coefs["c"]
nls.param.df_bal[nls.param.df_bal$Code == "221",]$d <- coefs["d"]

nls.param.df_bal[nls.param.df_bal$Code == "221",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "221",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "221",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "221",]$a.2.5 <- intervals_low["a"]
nls.param.df_bal[nls.param.df_bal$Code == "221",]$b.2.5 <- intervals_low["b"]
nls.param.df_bal[nls.param.df_bal$Code == "221",]$c.2.5 <- intervals_low["c"]
nls.param.df_bal[nls.param.df_bal$Code == "221",]$d.2.5 <- intervals_low["d"]

nls.param.df_bal[nls.param.df_bal$Code == "221",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "221",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "221",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "221",]$a.97.5 <- intervals_high["a"]
nls.param.df_bal[nls.param.df_bal$Code == "221",]$b.97.5 <- intervals_high["b"]
nls.param.df_bal[nls.param.df_bal$Code == "221",]$c.97.5 <- intervals_high["c"]
nls.param.df_bal[nls.param.df_bal$Code == "221",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_221.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_221.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_221.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_221.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_221 <- nlsResiduals(
  get(paste("nls_221.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_221)

## test residuals
if(length(G_221$pltID) < 5001) {test.nlsResiduals(resid_221)}

}   else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_221_pred <- predict(get(paste("nls_221.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_221$MEASTIME_t2, na.rm = T), max(G_221$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_221$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_221$MEASTIME_t2, na.rm = T), max(G_221$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_221$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_221$DeltaPDSI, na.rm = T), max(G_221$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_221$MEASTIME_t2, na.rm = T), max(G_221$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_221$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_221$B_L_prop, na.rm = T), max(G_221$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_221$DeltaPDSI, na.rm = T), max(G_221$STDAGE_t2)))
                      } )

G_221_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_221$STDAGE_t2),by = 1),  
                            "fitted"=G_221_pred)

## plot
gg.221 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_221, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_221, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_221))), breaks = cutvec_221) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_221_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_221_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("221 - Eastern Broadleaf Forest") + 
          
          #ylim(0, max(G_221_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_221,1)*1.05), expand = c(0,0))

gg.221

}   else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_221 <- data.frame(
  bin = as.factor(levels(cut(G_221$STDAGE_t2, cutvec_221))),
  data.mean = tapply(G_221$B_plt_t2_MgHa, cut(G_221$STDAGE_t2, cutvec_221), 
                     mean), 
  data.CI.high =  tapply(G_221$B_plt_t2_MgHa, cut(G_221$STDAGE_t2, cutvec_221), 
                    high.CI), 
  data.CI.low = tapply(G_221$B_plt_t2_MgHa, cut(G_221$STDAGE_t2, cutvec_221),
                    low.CI), 
  pred.mean = G_221_pred_df[G_221_pred_df$STDAGE_t2 %in% bin_mids_221,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_221 <-  DM_compare_221 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_221$bin)[gtools::mixedorder(levels(DM_compare_221$bin))]))

## ggplot
gg.221.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_221) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_221))), 
                              labels = levels(DM_compare_221$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("221 - Eastern Broadleaf Forest",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +        
           theme_classic() + 
           # xlim(min(DM_compare_221$data.CI.low)-0.25, max(DM_compare_221$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_221$pred.CI.low)-0.25, max(DM_compare_221$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.221.B2

}   else {print("cannot plot observed vs. predicted")}
```

## 222 - Midwest Broadleaf Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_222 <- round(quantile(G_222$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_222)))){
  cutvec_222 <- round(quantile(G_222$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_222 <- unname(round(cutvec_222[-length(cutvec_222)] + diff(cutvec_222)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_222$STDAGE_t2_bin<-  cut(G_222$STDAGE_t2, cutvec_222)
## then get bin means
G_222_bin_means <- tapply(G_222$B_plt_t2_MgHa, cut(G_222$STDAGE_t2,  cutvec_222), mean)

## make column weights.2
G_222$nls_weights.2 <- as.numeric(1/(G_222_bin_means[match(G_222$STDAGE_t2_bin, names(G_222_bin_means))])^2)

}
```

### model selection 1

```{r}
# simple
try(
  nls_222.1 <- nls(f_1, data = G_222, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_222$nls_weights.2), 
 )

## phi
try(
  nls_222.2 <- nls(f_2, data=G_222, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_222$nls_weights.2), 
 )

# phi/alpha
try(
  nls_222.3 <- nls(f_3 , data = G_222, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_222$nls_weights.2), 
 )

## test
if(exists("nls_222.1") & exists("nls_222.2") & exists("nls_222.3")){
  print(anova(nls_222.1, nls_222.2, nls_222.3))
} else if(exists("nls_222.2") & exists("nls_222.3")){
  print(anova(nls_222.2, nls_222.3))
} else if(exists("nls_222.1") & exists("nls_222.2")){
  print(anova(nls_222.1, nls_222.2))
}
 
## AIC comparison
AIC1_222 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_222.1"), AIC(get("nls_222.1")), NA),
            ifelse(exists("nls_222.2"), AIC(get("nls_222.2")), NA),
            ifelse(exists("nls_222.3"), AIC(get("nls_222.3")), NA)
            ))

print(AIC1_222) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_222[!is.na(AIC1_222$AIC) & AIC1_222$AIC == min(AIC1_222$AIC, na.rm = T),]$model

try(summary(get(paste("nls_222.",  Mod.Sel1, sep =""))) )  #model summary
```
#### summary 
* simple model: `r ifelse(exists("nls_222.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_222.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_222.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_222.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_222.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_222.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_222.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_222.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_222.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_222,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_222$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_222.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_222,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_222$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_222.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_222,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_222$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_222.", Mod.Sel1, sep ="")) &
     exists(paste("nls_222.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_222.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_222.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_222.", Mod.Sel1, sep ="")),
             get(paste("nls_222.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_222.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_222.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_222.", Mod.Sel1, sep ="")) &
         exists(paste("nls_222.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_222.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_222.", Mod.Sel1, sep ="")),
               get(paste("nls_222.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_222.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_222.", Mod.Sel1, sep ="")) &
           exists(paste("nls_222.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_222.", Mod.Sel1, sep ="")),
                 get(paste("nls_222.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_222.", Mod.Sel1, sep ="")) &
              exists(paste("nls_222.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_222.", Mod.Sel1, sep ="")),
                    get(paste("nls_222.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_222.", Mod.Sel1, sep ="")) &
                exists(paste("nls_222.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_222.", Mod.Sel1, sep ="")),
                      get(paste("nls_222.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_222 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_222.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_222.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_222.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_222.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_222.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_222.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_222.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_222.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_222)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_222[!is.na(AIC2_222$AIC) & AIC2_222$AIC == min(AIC2_222$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "222",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_222.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_222.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "222",]$ge.variance <- vcov(get(paste("nls_222.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "222",]$phi.variance <- vcov(get(paste("nls_222.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "222",]$alpha.variance <- vcov(get(paste("nls_222.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "222",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "222",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "222",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "222",]$A <- coefs["A"]
nls.param.df_bal[nls.param.df_bal$Code == "222",]$k <- coefs["k"]

nls.param.df_bal[nls.param.df_bal$Code == "222",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "222",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "222",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "222",]$A.2.5 <- intervals_low["A"]
nls.param.df_bal[nls.param.df_bal$Code == "222",]$k.2.5 <- intervals_low["k"]

nls.param.df_bal[nls.param.df_bal$Code == "222",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "222",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "222",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "222",]$A.97.5 <- intervals_high["A"]
nls.param.df_bal[nls.param.df_bal$Code == "222",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_222.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_222.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_222.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_222.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_222$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_222.4 <- nls(f_4, data = G_222, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_222$nls_weights.2), 
 )

## phi
try(
  nls_222.5 <- nls(f_5, data=G_222, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_222$nls_weights.2), 
 )

# phi/alpha
try(
  nls_222.6 <- nls(f_6, data = G_222, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_222$nls_weights.2), 
 )

## test
if(exists("nls_222.4") & exists("nls_222.5") & exists("nls_222.6")){
  print(anova(nls_222.4, nls_222.5, nls_222.6))
} else if(exists("nls_222.4") & exists("nls_222.6")){
  print(anova(nls_222.4, nls_222.6))
} else if(exists("nls_222.5") & exists("nls_222.6")){
  print(anova(nls_222.5, nls_222.6))
} else if(exists("nls_222.4") & exists("nls_222.5")){
  print(anova(nls_222.4, nls_222.5))
}

## AIC comparison
AIC3_222 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_222[AIC2_222$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_222.4"), AIC(get("nls_222.4")), NA),
            ifelse(exists("nls_222.5"), AIC(get("nls_222.5")), NA),
            ifelse(exists("nls_222.6"), AIC(get("nls_222.6")), NA)
            ))

print(AIC3_222) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_222[!is.na(AIC3_222$AIC) & AIC3_222$AIC == min(AIC3_222$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "222",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_bal[Best_mods.P_bal$Code == "222",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_222.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_222.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "222",]$ge.variance <- vcov(get(paste("nls_222.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "222",]$phi.variance <- vcov(get(paste("nls_222.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "222",]$alpha.variance <- vcov(get(paste("nls_222.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "222",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "222",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "222",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "222",]$a <- coefs["a"]
nls.param.df_bal[nls.param.df_bal$Code == "222",]$b <- coefs["b"]
nls.param.df_bal[nls.param.df_bal$Code == "222",]$c <- coefs["c"]
nls.param.df_bal[nls.param.df_bal$Code == "222",]$d <- coefs["d"]

nls.param.df_bal[nls.param.df_bal$Code == "222",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "222",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "222",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "222",]$a.2.5 <- intervals_low["a"]
nls.param.df_bal[nls.param.df_bal$Code == "222",]$b.2.5 <- intervals_low["b"]
nls.param.df_bal[nls.param.df_bal$Code == "222",]$c.2.5 <- intervals_low["c"]
nls.param.df_bal[nls.param.df_bal$Code == "222",]$d.2.5 <- intervals_low["d"]

nls.param.df_bal[nls.param.df_bal$Code == "222",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "222",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "222",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "222",]$a.97.5 <- intervals_high["a"]
nls.param.df_bal[nls.param.df_bal$Code == "222",]$b.97.5 <- intervals_high["b"]
nls.param.df_bal[nls.param.df_bal$Code == "222",]$c.97.5 <- intervals_high["c"]
nls.param.df_bal[nls.param.df_bal$Code == "222",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_222.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_222.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_222.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_222.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {
  
## calculate residuals
resid_222 <- nlsResiduals(
  get(paste("nls_222.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_222)

## test residuals
if(length(G_222$pltID) < 5001) {test.nlsResiduals(resid_222)}

}  else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {
  
G_222_pred <- predict(get(paste("nls_222.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_222$MEASTIME_t2, na.rm = T), max(G_222$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_222$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_222$MEASTIME_t2, na.rm = T), max(G_222$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_222$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_222$DeltaPDSI, na.rm = T), max(G_222$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_222$MEASTIME_t2, na.rm = T), max(G_222$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_222$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_222$B_L_prop, na.rm = T), max(G_222$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_222$DeltaPDSI, na.rm = T), max(G_222$STDAGE_t2)))
                      } )

G_222_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_222$STDAGE_t2),by = 1),  
                            "fitted"=G_222_pred)

## plot
gg.222 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_222, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_222, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_222))), breaks = cutvec_222) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_222_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_222_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("222 - Midwest Broadleaf Forest") + 
          
          #ylim(0, max(G_222_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_222,1)*1.05), expand = c(0,0))

gg.222

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_222 <- data.frame(
  bin = as.factor(levels(cut(G_222$STDAGE_t2, cutvec_222))),
  data.mean = tapply(G_222$B_plt_t2_MgHa, cut(G_222$STDAGE_t2, cutvec_222), 
                     mean), 
  data.CI.high =  tapply(G_222$B_plt_t2_MgHa, cut(G_222$STDAGE_t2, cutvec_222), 
                    high.CI), 
  data.CI.low = tapply(G_222$B_plt_t2_MgHa, cut(G_222$STDAGE_t2, cutvec_222),
                    low.CI), 
  pred.mean = G_222_pred_df[G_222_pred_df$STDAGE_t2 %in% bin_mids_222,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_222 <-  DM_compare_222 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_222$bin)[gtools::mixedorder(levels(DM_compare_222$bin))]))

## ggplot
gg.222.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_222) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_222))), 
                              labels = levels(DM_compare_222$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("222 - Midwest Broadleaf Forest",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +        
           theme_classic() + 
           # xlim(min(DM_compare_222$data.CI.low)-0.25, max(DM_compare_222$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_222$pred.CI.low)-0.25, max(DM_compare_222$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.222.B2

}    else {print("cannot plot observed vs. predicted")}
```

## 223 - Central Interior Broadleaf Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_223 <- round(quantile(G_223$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_223)))){
  cutvec_223 <- round(quantile(G_223$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_223 <- unname(round(cutvec_223[-length(cutvec_223)] + diff(cutvec_223)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_223$STDAGE_t2_bin<-  cut(G_223$STDAGE_t2, cutvec_223)
## then get bin means
G_223_bin_means <- tapply(G_223$B_plt_t2_MgHa, cut(G_223$STDAGE_t2,  cutvec_223), mean)

## make column weights.2
G_223$nls_weights.2 <- as.numeric(1/(G_223_bin_means[match(G_223$STDAGE_t2_bin, names(G_223_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_223.1 <- nls(f_1, data = G_223, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_223$nls_weights.2), 
 )

## phi
try(
  nls_223.2 <- nls(f_2, data=G_223, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_223$nls_weights.2), 
 )

# phi/alpha
try(
  nls_223.3 <- nls(f_3 , data = G_223, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_223$nls_weights.2), 
 )

## test
if(exists("nls_223.1") & exists("nls_223.2") & exists("nls_223.3")){
  print(anova(nls_223.1, nls_223.2, nls_223.3))
} else if(exists("nls_223.2") & exists("nls_223.3")){
  print(anova(nls_223.2, nls_223.3))
} else if(exists("nls_223.1") & exists("nls_223.2")){
  print(anova(nls_223.1, nls_223.2))
}
 
## AIC comparison
AIC1_223 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_223.1"), AIC(get("nls_223.1")), NA),
            ifelse(exists("nls_223.2"), AIC(get("nls_223.2")), NA),
            ifelse(exists("nls_223.3"), AIC(get("nls_223.3")), NA)
            ))

print(AIC1_223) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_223[!is.na(AIC1_223$AIC) & AIC1_223$AIC == min(AIC1_223$AIC, na.rm = T),]$model

try(summary(get(paste("nls_223.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_223.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_223.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_223.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_223.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_223.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_223.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_223.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_223.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_223.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_223,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_223$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_223.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_223,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_223$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_223.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_223,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_223$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_223.", Mod.Sel1, sep ="")) &
     exists(paste("nls_223.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_223.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_223.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_223.", Mod.Sel1, sep ="")),
             get(paste("nls_223.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_223.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_223.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_223.", Mod.Sel1, sep ="")) &
         exists(paste("nls_223.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_223.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_223.", Mod.Sel1, sep ="")),
               get(paste("nls_223.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_223.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_223.", Mod.Sel1, sep ="")) &
           exists(paste("nls_223.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_223.", Mod.Sel1, sep ="")),
                 get(paste("nls_223.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_223.", Mod.Sel1, sep ="")) &
              exists(paste("nls_223.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_223.", Mod.Sel1, sep ="")),
                    get(paste("nls_223.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_223.", Mod.Sel1, sep ="")) &
                exists(paste("nls_223.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_223.", Mod.Sel1, sep ="")),
                      get(paste("nls_223.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_223 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_223.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_223.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_223.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_223.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_223.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_223.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_223.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_223.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_223)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_223[!is.na(AIC2_223$AIC) & AIC2_223$AIC == min(AIC2_223$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "223",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_223.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_223.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "223",]$ge.variance <- vcov(get(paste("nls_223.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "223",]$phi.variance <- vcov(get(paste("nls_223.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "223",]$alpha.variance <- vcov(get(paste("nls_223.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "223",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "223",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "223",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "223",]$A <- coefs["A"]
nls.param.df_bal[nls.param.df_bal$Code == "223",]$k <- coefs["k"]

nls.param.df_bal[nls.param.df_bal$Code == "223",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "223",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "223",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "223",]$A.2.5 <- intervals_low["A"]
nls.param.df_bal[nls.param.df_bal$Code == "223",]$k.2.5 <- intervals_low["k"]

nls.param.df_bal[nls.param.df_bal$Code == "223",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "223",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "223",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "223",]$A.97.5 <- intervals_high["A"]
nls.param.df_bal[nls.param.df_bal$Code == "223",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_223.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_223.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_223.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_223.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_223$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_223.4 <- nls(f_4, data = G_223, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_223$nls_weights.2), 
 )

## phi
try(
  nls_223.5 <- nls(f_5, data=G_223, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_223$nls_weights.2), 
 )

# phi/alpha
try(
  nls_223.6 <- nls(f_6, data = G_223, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_223$nls_weights.2), 
 )

## test
if(exists("nls_223.4") & exists("nls_223.5") & exists("nls_223.6")){
  print(anova(nls_223.4, nls_223.5, nls_223.6))
} else if(exists("nls_223.4") & exists("nls_223.6")){
  print(anova(nls_223.4, nls_223.6))
} else if(exists("nls_223.5") & exists("nls_223.6")){
  print(anova(nls_223.5, nls_223.6))
} else if(exists("nls_223.4") & exists("nls_223.5")){
  print(anova(nls_223.4, nls_223.5))
}

## AIC comparison
AIC3_223 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_223[AIC2_223$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_223.4"), AIC(get("nls_223.4")), NA),
            ifelse(exists("nls_223.5"), AIC(get("nls_223.5")), NA),
            ifelse(exists("nls_223.6"), AIC(get("nls_223.6")), NA)
            ))

print(AIC3_223) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_223[!is.na(AIC3_223$AIC) & AIC3_223$AIC == min(AIC3_223$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "223",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_bal[Best_mods.P_bal$Code == "223",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_223.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_223.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "223",]$ge.variance <- vcov(get(paste("nls_223.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "223",]$phi.variance <- vcov(get(paste("nls_223.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "223",]$alpha.variance <- vcov(get(paste("nls_223.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "223",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "223",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "223",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "223",]$a <- coefs["a"]
nls.param.df_bal[nls.param.df_bal$Code == "223",]$b <- coefs["b"]
nls.param.df_bal[nls.param.df_bal$Code == "223",]$c <- coefs["c"]
nls.param.df_bal[nls.param.df_bal$Code == "223",]$d <- coefs["d"]

nls.param.df_bal[nls.param.df_bal$Code == "223",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "223",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "223",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "223",]$a.2.5 <- intervals_low["a"]
nls.param.df_bal[nls.param.df_bal$Code == "223",]$b.2.5 <- intervals_low["b"]
nls.param.df_bal[nls.param.df_bal$Code == "223",]$c.2.5 <- intervals_low["c"]
nls.param.df_bal[nls.param.df_bal$Code == "223",]$d.2.5 <- intervals_low["d"]

nls.param.df_bal[nls.param.df_bal$Code == "223",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "223",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "223",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "223",]$a.97.5 <- intervals_high["a"]
nls.param.df_bal[nls.param.df_bal$Code == "223",]$b.97.5 <- intervals_high["b"]
nls.param.df_bal[nls.param.df_bal$Code == "223",]$c.97.5 <- intervals_high["c"]
nls.param.df_bal[nls.param.df_bal$Code == "223",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_223.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_223.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_223.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_223.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_223 <- nlsResiduals(get(paste("nls_223.",  Mod.Sel2, sep ="")))

### plot residuals
plot(resid_223)

## test residuals
if(length(G_223$pltID) < 5001) {test.nlsResiduals(resid_223)}

}   else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_223_pred <- predict(get(paste("nls_223.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_223$MEASTIME_t2, na.rm = T), max(G_223$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_223$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_223$MEASTIME_t2, na.rm = T), max(G_223$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_223$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_223$DeltaPDSI, na.rm = T), max(G_223$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_223$MEASTIME_t2, na.rm = T), max(G_223$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_223$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_223$B_L_prop, na.rm = T), max(G_223$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_223$DeltaPDSI, na.rm = T), max(G_223$STDAGE_t2)))
                      } )

G_223_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_223$STDAGE_t2),by = 1),  
                            "fitted"=G_223_pred)

## plot
gg.223 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_223, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_223, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_223))), breaks = cutvec_223) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_223_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_223_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("223 - Central Interior Broadleaf Forest") + 
          
          #ylim(0, max(G_223_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_223,1)*1.05), expand = c(0,0))

gg.223

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_223 <- data.frame(
  bin = as.factor(levels(cut(G_223$STDAGE_t2, cutvec_223))),
  data.mean = tapply(G_223$B_plt_t2_MgHa, cut(G_223$STDAGE_t2, cutvec_223), 
                     mean), 
  data.CI.high =  tapply(G_223$B_plt_t2_MgHa, cut(G_223$STDAGE_t2, cutvec_223), 
                    high.CI), 
  data.CI.low = tapply(G_223$B_plt_t2_MgHa, cut(G_223$STDAGE_t2, cutvec_223),
                    low.CI), 
  pred.mean = G_223_pred_df[G_223_pred_df$STDAGE_t2 %in% bin_mids_223,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_223 <-  DM_compare_223 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_223$bin)[gtools::mixedorder(levels(DM_compare_223$bin))]))

## ggplot
gg.223.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_223) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_223))), 
                              labels = levels(DM_compare_223$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("223 - Central Interior Broadleaf Forest",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +        
           theme_classic() + 
           # xlim(min(DM_compare_223$data.CI.low)-0.25, max(DM_compare_223$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_223$pred.CI.low)-0.25, max(DM_compare_223$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.223.B2

}   else {print("cannot plot observed vs. predicted")}
```

## 231 - Southeastern Mixed Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_231 <- round(quantile(G_231$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_231)))){
  cutvec_231 <- round(quantile(G_231$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_231 <- unname(round(cutvec_231[-length(cutvec_231)] + diff(cutvec_231)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_231$STDAGE_t2_bin<-  cut(G_231$STDAGE_t2, cutvec_231)
## then get bin means
G_231_bin_means <- tapply(G_231$B_plt_t2_MgHa, cut(G_231$STDAGE_t2,  cutvec_231), mean)

## make column weights.2
G_231$nls_weights.2 <- as.numeric(1/(G_231_bin_means[match(G_231$STDAGE_t2_bin, names(G_231_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_231.1 <- nls(f_1, data = G_231, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_231$nls_weights.2), 
 )

## phi
try(
  nls_231.2 <- nls(f_2, data=G_231, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_231$nls_weights.2), 
 )

# phi/alpha
try(
  nls_231.3 <- nls(f_3 , data = G_231, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_231$nls_weights.2), 
 )

## test
if(exists("nls_231.1") & exists("nls_231.2") & exists("nls_231.3")){
  print(anova(nls_231.1, nls_231.2, nls_231.3))
} else if(exists("nls_231.2") & exists("nls_231.3")){
  print(anova(nls_231.2, nls_231.3))
} else if(exists("nls_231.1") & exists("nls_231.2")){
  print(anova(nls_231.1, nls_231.2))
}
 
## AIC comparison
AIC1_231 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_231.1"), AIC(get("nls_231.1")), NA),
            ifelse(exists("nls_231.2"), AIC(get("nls_231.2")), NA),
            ifelse(exists("nls_231.3"), AIC(get("nls_231.3")), NA)
            ))

print(AIC1_231) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_231[!is.na(AIC1_231$AIC) & AIC1_231$AIC == min(AIC1_231$AIC, na.rm = T),]$model

try(summary(get(paste("nls_231.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_231.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_231.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_231.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_231.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_231.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_231.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_231.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_231.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_231.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_231,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_231$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_231.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_231,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_231$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_231.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_231,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_231$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_231.", Mod.Sel1, sep ="")) &
     exists(paste("nls_231.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_231.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_231.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_231.", Mod.Sel1, sep ="")),
             get(paste("nls_231.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_231.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_231.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_231.", Mod.Sel1, sep ="")) &
         exists(paste("nls_231.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_231.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_231.", Mod.Sel1, sep ="")),
               get(paste("nls_231.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_231.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_231.", Mod.Sel1, sep ="")) &
           exists(paste("nls_231.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_231.", Mod.Sel1, sep ="")),
                 get(paste("nls_231.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_231.", Mod.Sel1, sep ="")) &
              exists(paste("nls_231.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_231.", Mod.Sel1, sep ="")),
                    get(paste("nls_231.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_231.", Mod.Sel1, sep ="")) &
                exists(paste("nls_231.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_231.", Mod.Sel1, sep ="")),
                      get(paste("nls_231.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_231 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_231.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_231.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_231.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_231.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_231.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_231.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_231.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_231.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_231)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_231[!is.na(AIC2_231$AIC) & AIC2_231$AIC == min(AIC2_231$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "231",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_231.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_231.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "231",]$ge.variance <- vcov(get(paste("nls_231.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "231",]$phi.variance <- vcov(get(paste("nls_231.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "231",]$alpha.variance <- vcov(get(paste("nls_231.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "231",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "231",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "231",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "231",]$A <- coefs["A"]
nls.param.df_bal[nls.param.df_bal$Code == "231",]$k <- coefs["k"]

nls.param.df_bal[nls.param.df_bal$Code == "231",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "231",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "231",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "231",]$A.2.5 <- intervals_low["A"]
nls.param.df_bal[nls.param.df_bal$Code == "231",]$k.2.5 <- intervals_low["k"]

nls.param.df_bal[nls.param.df_bal$Code == "231",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "231",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "231",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "231",]$A.97.5 <- intervals_high["A"]
nls.param.df_bal[nls.param.df_bal$Code == "231",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_231.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_231.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_231.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_231.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_231$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_231.4 <- nls(f_4, data = G_231, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_231$nls_weights.2), 
 )

## phi
try(
  nls_231.5 <- nls(f_5, data=G_231, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_231$nls_weights.2), 
 )

# phi/alpha
try(
  nls_231.6 <- nls(f_6, data = G_231, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_231$nls_weights.2), 
 )

## test
if(exists("nls_231.4") & exists("nls_231.5") & exists("nls_231.6")){
  print(anova(nls_231.4, nls_231.5, nls_231.6))
} else if(exists("nls_231.4") & exists("nls_231.6")){
  print(anova(nls_231.4, nls_231.6))
} else if(exists("nls_231.5") & exists("nls_231.6")){
  print(anova(nls_231.5, nls_231.6))
} else if(exists("nls_231.4") & exists("nls_231.5")){
  print(anova(nls_231.4, nls_231.5))
}

## AIC comparison
AIC3_231 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_231[AIC2_231$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_231.4"), AIC(get("nls_231.4")), NA),
            ifelse(exists("nls_231.5"), AIC(get("nls_231.5")), NA),
            ifelse(exists("nls_231.6"), AIC(get("nls_231.6")), NA)
            ))

print(AIC3_231) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_231[!is.na(AIC3_231$AIC) & AIC3_231$AIC == min(AIC3_231$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "231",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_bal[Best_mods.P_bal$Code == "231",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_231.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_231.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "231",]$ge.variance <- vcov(get(paste("nls_231.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "231",]$phi.variance <- vcov(get(paste("nls_231.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "231",]$alpha.variance <- vcov(get(paste("nls_231.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "231",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "231",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "231",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "231",]$a <- coefs["a"]
nls.param.df_bal[nls.param.df_bal$Code == "231",]$b <- coefs["b"]
nls.param.df_bal[nls.param.df_bal$Code == "231",]$c <- coefs["c"]
nls.param.df_bal[nls.param.df_bal$Code == "231",]$d <- coefs["d"]

nls.param.df_bal[nls.param.df_bal$Code == "231",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "231",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "231",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "231",]$a.2.5 <- intervals_low["a"]
nls.param.df_bal[nls.param.df_bal$Code == "231",]$b.2.5 <- intervals_low["b"]
nls.param.df_bal[nls.param.df_bal$Code == "231",]$c.2.5 <- intervals_low["c"]
nls.param.df_bal[nls.param.df_bal$Code == "231",]$d.2.5 <- intervals_low["d"]

nls.param.df_bal[nls.param.df_bal$Code == "231",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "231",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "231",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "231",]$a.97.5 <- intervals_high["a"]
nls.param.df_bal[nls.param.df_bal$Code == "231",]$b.97.5 <- intervals_high["b"]
nls.param.df_bal[nls.param.df_bal$Code == "231",]$c.97.5 <- intervals_high["c"]
nls.param.df_bal[nls.param.df_bal$Code == "231",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_231.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_231.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_231.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_231.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_231 <- nlsResiduals(
  get(paste("nls_231.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_231)

## test residuals
if(length(G_231$pltID) < 5001) {test.nlsResiduals(resid_231)}

}   else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_231_pred <- predict(get(paste("nls_231.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_231$MEASTIME_t2, na.rm = T), max(G_231$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_231$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_231$MEASTIME_t2, na.rm = T), max(G_231$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_231$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_231$DeltaPDSI, na.rm = T), max(G_231$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_231$MEASTIME_t2, na.rm = T), max(G_231$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_231$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_231$B_L_prop, na.rm = T), max(G_231$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_231$DeltaPDSI, na.rm = T), max(G_231$STDAGE_t2)))
                      } )

G_231_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_231$STDAGE_t2),by = 1),  
                            "fitted"=G_231_pred)

## plot
gg.231 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_231, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_231, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_231))), breaks = cutvec_231) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_231_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_231_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("231 -  Southeastern Mixed Forest") + 
          
          #ylim(0, max(G_231_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_231,1)*1.05), expand = c(0,0))

gg.231

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_231 <- data.frame(
  bin = as.factor(levels(cut(G_231$STDAGE_t2, cutvec_231))),
  data.mean = tapply(G_231$B_plt_t2_MgHa, cut(G_231$STDAGE_t2, cutvec_231), 
                     mean), 
  data.CI.high =  tapply(G_231$B_plt_t2_MgHa, cut(G_231$STDAGE_t2, cutvec_231), 
                    high.CI), 
  data.CI.low = tapply(G_231$B_plt_t2_MgHa, cut(G_231$STDAGE_t2, cutvec_231),
                    low.CI), 
  pred.mean = G_231_pred_df[G_231_pred_df$STDAGE_t2 %in% bin_mids_231,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_231 <-  DM_compare_231 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_231$bin)[gtools::mixedorder(levels(DM_compare_231$bin))]))

## ggplot
gg.231.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_231) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_231))), 
                              labels = levels(DM_compare_231$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("231 -  Southeastern Mixed Forest",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +         
           theme_classic() + 
           # xlim(min(DM_compare_231$data.CI.low)-0.25, max(DM_compare_231$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_231$pred.CI.low)-0.25, max(DM_compare_231$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.231.B2

}   else {print("cannot plot observed vs. predicted")}
```

## 232 - Outer Coastal Plain Mixed Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_232 <- round(quantile(G_232$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_232)))){
  cutvec_232 <- round(quantile(G_232$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_232 <- unname(round(cutvec_232[-length(cutvec_232)] + diff(cutvec_232)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_232$STDAGE_t2_bin<-  cut(G_232$STDAGE_t2, cutvec_232)
## then get bin means
G_232_bin_means <- tapply(G_232$B_plt_t2_MgHa, cut(G_232$STDAGE_t2, cutvec_232), mean)

## make column weights.2
G_232$nls_weights.2 <- as.numeric(1/(G_232_bin_means[match(G_232$STDAGE_t2_bin, names(G_232_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_232.1 <- nls(f_1, data = G_232, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_232$nls_weights.2), 
 )

## phi
try(
  nls_232.2 <- nls(f_2, data=G_232, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_232$nls_weights.2), 
 )

# phi/alpha
try(
  nls_232.3 <- nls(f_3 , data = G_232, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_232$nls_weights.2), 
 )

## test
if(exists("nls_232.1") & exists("nls_232.2") & exists("nls_232.3")){
  print(anova(nls_232.1, nls_232.2, nls_232.3))
} else if(exists("nls_232.2") & exists("nls_232.3")){
  print(anova(nls_232.2, nls_232.3))
} else if(exists("nls_232.1") & exists("nls_232.2")){
  print(anova(nls_232.1, nls_232.2))
}
 
## AIC comparison
AIC1_232 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_232.1"), AIC(get("nls_232.1")), NA),
            ifelse(exists("nls_232.2"), AIC(get("nls_232.2")), NA),
            ifelse(exists("nls_232.3"), AIC(get("nls_232.3")), NA)
            ))

print(AIC1_232) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_232[!is.na(AIC1_232$AIC) & AIC1_232$AIC == min(AIC1_232$AIC, na.rm = T),]$model

try(summary(get(paste("nls_232.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_232.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_232.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_232.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_232.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_232.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_232.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_232.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_232.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_232.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_232,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_232$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_232.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_232,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_232$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_232.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_232,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_232$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_232.", Mod.Sel1, sep ="")) &
     exists(paste("nls_232.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_232.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_232.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_232.", Mod.Sel1, sep ="")),
             get(paste("nls_232.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_232.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_232.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_232.", Mod.Sel1, sep ="")) &
         exists(paste("nls_232.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_232.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_232.", Mod.Sel1, sep ="")),
               get(paste("nls_232.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_232.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_232.", Mod.Sel1, sep ="")) &
           exists(paste("nls_232.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_232.", Mod.Sel1, sep ="")),
                 get(paste("nls_232.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_232.", Mod.Sel1, sep ="")) &
              exists(paste("nls_232.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_232.", Mod.Sel1, sep ="")),
                    get(paste("nls_232.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_232.", Mod.Sel1, sep ="")) &
                exists(paste("nls_232.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_232.", Mod.Sel1, sep ="")),
                      get(paste("nls_232.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_232 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_232.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_232.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_232.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_232.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_232.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_232.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_232.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_232.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_232)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_232[!is.na(AIC2_232$AIC) & AIC2_232$AIC == min(AIC2_232$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "232",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_232.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_232.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "232",]$ge.variance <- vcov(get(paste("nls_232.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "232",]$phi.variance <- vcov(get(paste("nls_232.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "232",]$alpha.variance <- vcov(get(paste("nls_232.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "232",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "232",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "232",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "232",]$A <- coefs["A"]
nls.param.df_bal[nls.param.df_bal$Code == "232",]$k <- coefs["k"]

nls.param.df_bal[nls.param.df_bal$Code == "232",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "232",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "232",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "232",]$A.2.5 <- intervals_low["A"]
nls.param.df_bal[nls.param.df_bal$Code == "232",]$k.2.5 <- intervals_low["k"]

nls.param.df_bal[nls.param.df_bal$Code == "232",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "232",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "232",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "232",]$A.97.5 <- intervals_high["A"]
nls.param.df_bal[nls.param.df_bal$Code == "232",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_232.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_232.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_232.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_232.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_232$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_232.4 <- nls(f_4, data = G_232, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_232$nls_weights.2), 
 )

## phi
try(
  nls_232.5 <- nls(f_5, data=G_232, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_232$nls_weights.2), 
 )

# phi/alpha
try(
  nls_232.6 <- nls(f_6, data = G_232, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_232$nls_weights.2), 
 )

## test
if(exists("nls_232.4") & exists("nls_232.5") & exists("nls_232.6")){
  print(anova(nls_232.4, nls_232.5, nls_232.6))
} else if(exists("nls_232.4") & exists("nls_232.6")){
  print(anova(nls_232.4, nls_232.6))
} else if(exists("nls_232.5") & exists("nls_232.6")){
  print(anova(nls_232.5, nls_232.6))
} else if(exists("nls_232.4") & exists("nls_232.5")){
  print(anova(nls_232.4, nls_232.5))
}

## AIC comparison
AIC3_232 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_232[AIC2_232$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_232.4"), AIC(get("nls_232.4")), NA),
            ifelse(exists("nls_232.5"), AIC(get("nls_232.5")), NA),
            ifelse(exists("nls_232.6"), AIC(get("nls_232.6")), NA)
            ))

print(AIC3_232) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_232[!is.na(AIC3_232$AIC) & AIC3_232$AIC == min(AIC3_232$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "232",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_bal[Best_mods.P_bal$Code == "232",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_232.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_232.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "232",]$ge.variance <- vcov(get(paste("nls_232.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "232",]$phi.variance <- vcov(get(paste("nls_232.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "232",]$alpha.variance <- vcov(get(paste("nls_232.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "232",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "232",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "232",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "232",]$a <- coefs["a"]
nls.param.df_bal[nls.param.df_bal$Code == "232",]$b <- coefs["b"]
nls.param.df_bal[nls.param.df_bal$Code == "232",]$c <- coefs["c"]
nls.param.df_bal[nls.param.df_bal$Code == "232",]$d <- coefs["d"]

nls.param.df_bal[nls.param.df_bal$Code == "232",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "232",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "232",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "232",]$a.2.5 <- intervals_low["a"]
nls.param.df_bal[nls.param.df_bal$Code == "232",]$b.2.5 <- intervals_low["b"]
nls.param.df_bal[nls.param.df_bal$Code == "232",]$c.2.5 <- intervals_low["c"]
nls.param.df_bal[nls.param.df_bal$Code == "232",]$d.2.5 <- intervals_low["d"]

nls.param.df_bal[nls.param.df_bal$Code == "232",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "232",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "232",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "232",]$a.97.5 <- intervals_high["a"]
nls.param.df_bal[nls.param.df_bal$Code == "232",]$b.97.5 <- intervals_high["b"]
nls.param.df_bal[nls.param.df_bal$Code == "232",]$c.97.5 <- intervals_high["c"]
nls.param.df_bal[nls.param.df_bal$Code == "232",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_232.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_232.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_232.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_232.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_232 <- nlsResiduals(
  get(paste("nls_232.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_232)

## test residuals
if(length(G_232$pltID) < 5001) {test.nlsResiduals(resid_232)}

}   else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_232_pred <- predict(get(paste("nls_232.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_232$MEASTIME_t2, na.rm = T), max(G_232$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_232$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_232$MEASTIME_t2, na.rm = T), max(G_232$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_232$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_232$DeltaPDSI, na.rm = T), max(G_232$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_232$MEASTIME_t2, na.rm = T), max(G_232$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_232$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_232$B_L_prop, na.rm = T), max(G_232$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_232$DeltaPDSI, na.rm = T), max(G_232$STDAGE_t2)))
                      } )

G_232_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_232$STDAGE_t2),by = 1),  
                            "fitted"=G_232_pred)

## plot
gg.232 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_232, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_232, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_232))), breaks = cutvec_232) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_232_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_232_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("232 - Outer Coastal Plain Mixed Forest") + 
          
          #ylim(0, max(G_232_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_232,1)*1.05), expand = c(0,0))

gg.232

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_232 <- data.frame(
  bin = as.factor(levels(cut(G_232$STDAGE_t2, cutvec_232))),
  data.mean = tapply(G_232$B_plt_t2_MgHa, cut(G_232$STDAGE_t2, cutvec_232), 
                     mean), 
  data.CI.high =  tapply(G_232$B_plt_t2_MgHa, cut(G_232$STDAGE_t2, cutvec_232), 
                    high.CI), 
  data.CI.low = tapply(G_232$B_plt_t2_MgHa, cut(G_232$STDAGE_t2, cutvec_232),
                    low.CI), 
  pred.mean = G_232_pred_df[G_232_pred_df$STDAGE_t2 %in% bin_mids_232,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_232 <-  DM_compare_232 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_232$bin)[gtools::mixedorder(levels(DM_compare_232$bin))]))

## ggplot
gg.232.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_232) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_232))), 
                              labels = levels(DM_compare_232$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("232 - Outer Coastal Plain Mixed Forest",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +        
           theme_classic() + 
           # xlim(min(DM_compare_232$data.CI.low)-0.25, max(DM_compare_232$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_232$pred.CI.low)-0.25, max(DM_compare_232$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.232.B2

}   else {print("cannot plot observed vs. predicted")}
```

## 234 - Lower Mississippi Riverine Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_234 <- round(quantile(G_234$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_234)))){
  cutvec_234 <- round(quantile(G_234$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_234 <- unname(round(cutvec_234[-length(cutvec_234)] + diff(cutvec_234)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_234$STDAGE_t2_bin<-  cut(G_234$STDAGE_t2, cutvec_234)
## then get bin means
G_234_bin_means <- tapply(G_234$B_plt_t2_MgHa, cut(G_234$STDAGE_t2, cutvec_234), mean)

## make column weights.2
G_234$nls_weights.2 <- as.numeric(1/(G_234_bin_means[match(G_234$STDAGE_t2_bin, names(G_234_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_234.1 <- nls(f_1, data = G_234, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_234$nls_weights.2), 
 )

## phi
try(
  nls_234.2 <- nls(f_2, data=G_234, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_234$nls_weights.2), 
 )

# phi/alpha
try(
  nls_234.3 <- nls(f_3 , data = G_234, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_234$nls_weights.2), 
 )

## test
if(exists("nls_234.1") & exists("nls_234.2") & exists("nls_234.3")){
  print(anova(nls_234.1, nls_234.2, nls_234.3))
} else if(exists("nls_234.2") & exists("nls_234.3")){
  print(anova(nls_234.2, nls_234.3))
} else if(exists("nls_234.1") & exists("nls_234.2")){
  print(anova(nls_234.1, nls_234.2))
}
 
## AIC comparison
AIC1_234 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_234.1"), AIC(get("nls_234.1")), NA),
            ifelse(exists("nls_234.2"), AIC(get("nls_234.2")), NA),
            ifelse(exists("nls_234.3"), AIC(get("nls_234.3")), NA)
            ))

print(AIC1_234) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_234[!is.na(AIC1_234$AIC) & AIC1_234$AIC == min(AIC1_234$AIC, na.rm = T),]$model

try(summary(get(paste("nls_234.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_234.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_234.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_234.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_234.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_234.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_234.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_234.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_234.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_234.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_234,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_234$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_234.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_234,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_234$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_234.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_234,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_234$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_234.", Mod.Sel1, sep ="")) &
     exists(paste("nls_234.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_234.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_234.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_234.", Mod.Sel1, sep ="")),
             get(paste("nls_234.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_234.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_234.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_234.", Mod.Sel1, sep ="")) &
         exists(paste("nls_234.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_234.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_234.", Mod.Sel1, sep ="")),
               get(paste("nls_234.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_234.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_234.", Mod.Sel1, sep ="")) &
           exists(paste("nls_234.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_234.", Mod.Sel1, sep ="")),
                 get(paste("nls_234.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_234.", Mod.Sel1, sep ="")) &
              exists(paste("nls_234.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_234.", Mod.Sel1, sep ="")),
                    get(paste("nls_234.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_234.", Mod.Sel1, sep ="")) &
                exists(paste("nls_234.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_234.", Mod.Sel1, sep ="")),
                      get(paste("nls_234.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_234 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_234.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_234.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_234.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_234.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_234.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_234.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_234.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_234.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_234)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_234[!is.na(AIC2_234$AIC) & AIC2_234$AIC == min(AIC2_234$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "234",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_234.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_234.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "234",]$ge.variance <- vcov(get(paste("nls_234.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "234",]$phi.variance <- vcov(get(paste("nls_234.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "234",]$alpha.variance <- vcov(get(paste("nls_234.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "234",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "234",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "234",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "234",]$A <- coefs["A"]
nls.param.df_bal[nls.param.df_bal$Code == "234",]$k <- coefs["k"]

nls.param.df_bal[nls.param.df_bal$Code == "234",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "234",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "234",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "234",]$A.2.5 <- intervals_low["A"]
nls.param.df_bal[nls.param.df_bal$Code == "234",]$k.2.5 <- intervals_low["k"]

nls.param.df_bal[nls.param.df_bal$Code == "234",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "234",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "234",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "234",]$A.97.5 <- intervals_high["A"]
nls.param.df_bal[nls.param.df_bal$Code == "234",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_234.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_234.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_234.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_234.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_234$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_234.4 <- nls(f_4, data = G_234, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_234$nls_weights.2), 
 )

## phi
try(
  nls_234.5 <- nls(f_5, data=G_234, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_234$nls_weights.2), 
 )

# phi/alpha
try(
  nls_234.6 <- nls(f_6, data = G_234, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_234$nls_weights.2), 
 )

## test
if(exists("nls_234.4") & exists("nls_234.5") & exists("nls_234.6")){
  print(anova(nls_234.4, nls_234.5, nls_234.6))
} else if(exists("nls_234.4") & exists("nls_234.6")){
  print(anova(nls_234.4, nls_234.6))
} else if(exists("nls_234.5") & exists("nls_234.6")){
  print(anova(nls_234.5, nls_234.6))
} else if(exists("nls_234.4") & exists("nls_234.5")){
  print(anova(nls_234.4, nls_234.5))
}

## AIC comparison
AIC3_234 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_234[AIC2_234$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_234.4"), AIC(get("nls_234.4")), NA),
            ifelse(exists("nls_234.5"), AIC(get("nls_234.5")), NA),
            ifelse(exists("nls_234.6"), AIC(get("nls_234.6")), NA)
            ))

print(AIC3_234) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_234[!is.na(AIC3_234$AIC) & AIC3_234$AIC == min(AIC3_234$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "234",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_bal[Best_mods.P_bal$Code == "234",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_234.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_234.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "234",]$ge.variance <- vcov(get(paste("nls_234.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "234",]$phi.variance <- vcov(get(paste("nls_234.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "234",]$alpha.variance <- vcov(get(paste("nls_234.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "234",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "234",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "234",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "234",]$a <- coefs["a"]
nls.param.df_bal[nls.param.df_bal$Code == "234",]$b <- coefs["b"]
nls.param.df_bal[nls.param.df_bal$Code == "234",]$c <- coefs["c"]
nls.param.df_bal[nls.param.df_bal$Code == "234",]$d <- coefs["d"]

nls.param.df_bal[nls.param.df_bal$Code == "234",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "234",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "234",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "234",]$a.2.5 <- intervals_low["a"]
nls.param.df_bal[nls.param.df_bal$Code == "234",]$b.2.5 <- intervals_low["b"]
nls.param.df_bal[nls.param.df_bal$Code == "234",]$c.2.5 <- intervals_low["c"]
nls.param.df_bal[nls.param.df_bal$Code == "234",]$d.2.5 <- intervals_low["d"]

nls.param.df_bal[nls.param.df_bal$Code == "234",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "234",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "234",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "234",]$a.97.5 <- intervals_high["a"]
nls.param.df_bal[nls.param.df_bal$Code == "234",]$b.97.5 <- intervals_high["b"]
nls.param.df_bal[nls.param.df_bal$Code == "234",]$c.97.5 <- intervals_high["c"]
nls.param.df_bal[nls.param.df_bal$Code == "234",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_234.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_234.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_234.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_234.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_234 <- nlsResiduals(
  get(paste("nls_234.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_234)

## test residuals
if(length(G_234$pltID) < 5001) {test.nlsResiduals(resid_234)}

}   else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_234_pred <- predict(get(paste("nls_234.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_234$MEASTIME_t2, na.rm = T), max(G_234$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_234$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_234$MEASTIME_t2, na.rm = T), max(G_234$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_234$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_234$DeltaPDSI, na.rm = T), max(G_234$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_234$MEASTIME_t2, na.rm = T), max(G_234$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_234$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_234$B_L_prop, na.rm = T), max(G_234$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_234$DeltaPDSI, na.rm = T), max(G_234$STDAGE_t2)))
                      } )

G_234_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_234$STDAGE_t2),by = 1),  
                            "fitted"=G_234_pred)

## plot
gg.234 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_234, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_234, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_234))), breaks = cutvec_234) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_234_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_234_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("234 - Lower Mississippi Riverine Forest") + 
          
          #ylim(0, max(G_234_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_234,1)*1.05), expand = c(0,0))

gg.234

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_234 <- data.frame(
  bin = as.factor(levels(cut(G_234$STDAGE_t2, cutvec_234))),
  data.mean = tapply(G_234$B_plt_t2_MgHa, cut(G_234$STDAGE_t2, cutvec_234), 
                     mean), 
  data.CI.high =  tapply(G_234$B_plt_t2_MgHa, cut(G_234$STDAGE_t2, cutvec_234), 
                    high.CI), 
  data.CI.low = tapply(G_234$B_plt_t2_MgHa, cut(G_234$STDAGE_t2, cutvec_234),
                    low.CI), 
  pred.mean = G_234_pred_df[G_234_pred_df$STDAGE_t2 %in% bin_mids_234,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_234 <-  DM_compare_234 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_234$bin)[gtools::mixedorder(levels(DM_compare_234$bin))]))

## ggplot
gg.234.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_234) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_234))), 
                              labels = levels(DM_compare_234$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("234 - Lower Mississippi Riverine Forest",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +        
           theme_classic() + 
           # xlim(min(DM_compare_234$data.CI.low)-0.25, max(DM_compare_234$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_234$pred.CI.low)-0.25, max(DM_compare_234$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.234.B2

}   else {print("cannot plot observed vs. predicted")}
```

## 242 - Pacific Lowland Mixed Forest
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_242 <- round(quantile(G_242$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_242)))){
  cutvec_242 <- round(quantile(G_242$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_242 <- unname(round(cutvec_242[-length(cutvec_242)] + diff(cutvec_242)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_242$STDAGE_t2_bin<-  cut(G_242$STDAGE_t2,cutvec_242)
## then get bin means
G_242_bin_means <- tapply(G_242$B_plt_t2_MgHa, cut(G_242$STDAGE_t2,  cutvec_242), mean)

## make column weights.2
G_242$nls_weights.2 <- as.numeric(1/(G_242_bin_means[match(G_242$STDAGE_t2_bin, names(G_242_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_242.1 <- nls(f_1, data = G_242, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_242$nls_weights.2), 
 )

## phi
try(
  nls_242.2 <- nls(f_2, data=G_242, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_242$nls_weights.2), 
 )

# phi/alpha
try(
  nls_242.3 <- nls(f_3 , data = G_242, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_242$nls_weights.2), 
 )

## test
if(exists("nls_242.1") & exists("nls_242.2") & exists("nls_242.3")){
  print(anova(nls_242.1, nls_242.2, nls_242.3))
} else if(exists("nls_242.2") & exists("nls_242.3")){
  print(anova(nls_242.2, nls_242.3))
} else if(exists("nls_242.1") & exists("nls_242.2")){
  print(anova(nls_242.1, nls_242.2))
}
 
## AIC comparison
AIC1_242 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_242.1"), AIC(get("nls_242.1")), NA),
            ifelse(exists("nls_242.2"), AIC(get("nls_242.2")), NA),
            ifelse(exists("nls_242.3"), AIC(get("nls_242.3")), NA)
            ))

print(AIC1_242) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_242[!is.na(AIC1_242$AIC) & is.na(AIC1_242$AIC) & AIC1_242$AIC == min(AIC1_242$AIC, na.rm = T),]$model

try(summary(get(paste("nls_242.",  Mod.Sel1, sep =""))))  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_242.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_242.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_242.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_242.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_242.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_242.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_242.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_242.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_242.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_242,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_242$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_242.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_242,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_242$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_242.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_242,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_242$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_242.", Mod.Sel1, sep ="")) &
     exists(paste("nls_242.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_242.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_242.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_242.", Mod.Sel1, sep ="")),
             get(paste("nls_242.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_242.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_242.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_242.", Mod.Sel1, sep ="")) &
         exists(paste("nls_242.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_242.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_242.", Mod.Sel1, sep ="")),
               get(paste("nls_242.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_242.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_242.", Mod.Sel1, sep ="")) &
           exists(paste("nls_242.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_242.", Mod.Sel1, sep ="")),
                 get(paste("nls_242.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_242.", Mod.Sel1, sep ="")) &
              exists(paste("nls_242.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_242.", Mod.Sel1, sep ="")),
                    get(paste("nls_242.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_242.", Mod.Sel1, sep ="")) &
                exists(paste("nls_242.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_242.", Mod.Sel1, sep ="")),
                      get(paste("nls_242.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_242 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_242.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_242.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_242.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_242.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_242.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_242.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_242.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_242.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_242)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_242[!is.na(AIC2_242$AIC) & AIC2_242$AIC == min(AIC2_242$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "242",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_242.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_242.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "242",]$ge.variance <- vcov(get(paste("nls_242.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "242",]$phi.variance <- vcov(get(paste("nls_242.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "242",]$alpha.variance <- vcov(get(paste("nls_242.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "242",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "242",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "242",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "242",]$A <- coefs["A"]
nls.param.df_bal[nls.param.df_bal$Code == "242",]$k <- coefs["k"]

nls.param.df_bal[nls.param.df_bal$Code == "242",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "242",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "242",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "242",]$A.2.5 <- intervals_low["A"]
nls.param.df_bal[nls.param.df_bal$Code == "242",]$k.2.5 <- intervals_low["k"]

nls.param.df_bal[nls.param.df_bal$Code == "242",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "242",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "242",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "242",]$A.97.5 <- intervals_high["A"]
nls.param.df_bal[nls.param.df_bal$Code == "242",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_242.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_242.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_242.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_242.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_242$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_242.4 <- nls(f_4, data = G_242, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_242$nls_weights.2), 
 )

## phi
try(
  nls_242.5 <- nls(f_5, data=G_242, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_242$nls_weights.2), 
 )

# phi/alpha
try(
  nls_242.6 <- nls(f_6, data = G_242, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_242$nls_weights.2), 
 )

## test
if(exists("nls_242.4") & exists("nls_242.5") & exists("nls_242.6")){
  print(anova(nls_242.4, nls_242.5, nls_242.6))
} else if(exists("nls_242.4") & exists("nls_242.6")){
  print(anova(nls_242.4, nls_242.6))
} else if(exists("nls_242.5") & exists("nls_242.6")){
  print(anova(nls_242.5, nls_242.6))
} else if(exists("nls_242.4") & exists("nls_242.5")){
  print(anova(nls_242.4, nls_242.5))
}

## AIC comparison
AIC3_242 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_242[AIC2_242$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_242.4"), AIC(get("nls_242.4")), NA),
            ifelse(exists("nls_242.5"), AIC(get("nls_242.5")), NA),
            ifelse(exists("nls_242.6"), AIC(get("nls_242.6")), NA)
            ))

print(AIC3_242) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_242[!is.na(AIC3_242$AIC) & AIC3_242$AIC == min(AIC3_242$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "242",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_bal[Best_mods.P_bal$Code == "242",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_242.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_242.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "242",]$ge.variance <- vcov(get(paste("nls_242.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "242",]$phi.variance <- vcov(get(paste("nls_242.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "242",]$alpha.variance <- vcov(get(paste("nls_242.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "242",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "242",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "242",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "242",]$a <- coefs["a"]
nls.param.df_bal[nls.param.df_bal$Code == "242",]$b <- coefs["b"]
nls.param.df_bal[nls.param.df_bal$Code == "242",]$c <- coefs["c"]
nls.param.df_bal[nls.param.df_bal$Code == "242",]$d <- coefs["d"]

nls.param.df_bal[nls.param.df_bal$Code == "242",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "242",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "242",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "242",]$a.2.5 <- intervals_low["a"]
nls.param.df_bal[nls.param.df_bal$Code == "242",]$b.2.5 <- intervals_low["b"]
nls.param.df_bal[nls.param.df_bal$Code == "242",]$c.2.5 <- intervals_low["c"]
nls.param.df_bal[nls.param.df_bal$Code == "242",]$d.2.5 <- intervals_low["d"]

nls.param.df_bal[nls.param.df_bal$Code == "242",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "242",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "242",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "242",]$a.97.5 <- intervals_high["a"]
nls.param.df_bal[nls.param.df_bal$Code == "242",]$b.97.5 <- intervals_high["b"]
nls.param.df_bal[nls.param.df_bal$Code == "242",]$c.97.5 <- intervals_high["c"]
nls.param.df_bal[nls.param.df_bal$Code == "242",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_242.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_242.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_242.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_242.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_242 <- nlsResiduals(
  get(paste("nls_242.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_242)

## test residuals
if(length(G_242$pltID) < 5001) {test.nlsResiduals(resid_242)}

}   else {print("cannot plot residuals")}
```


### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## predict model fit
G_242_pred <- predict(get(paste("nls_242.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_242$MEASTIME_t2, na.rm = T), max(G_242$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_242$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_242$MEASTIME_t2, na.rm = T), max(G_242$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_242$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_242$DeltaPDSI, na.rm = T), max(G_242$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_242$MEASTIME_t2, na.rm = T), max(G_242$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_242$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_242$B_L_prop, na.rm = T), max(G_242$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_242$DeltaPDSI, na.rm = T), max(G_242$STDAGE_t2)))
                      } )

G_242_pred_df <- data.frame("STDAGE_t2"=seq(0,250,by = 1),
                            "fitted" =G_242_pred)

## plot
gg.242 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_242, alpha = 0.5, shape ="+", col = "#60606080") +

          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_242,
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res},
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_242))), breaks = cutvec_242) +

          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`),
                      #data = G_242_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +

          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_242_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) +


          theme_classic() +
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"),
               x = "Stand Age (yrs)") +  ggtitle("242 - Pacific Lowland Mixed Forest") +

          #ylim(0, max(G_242_pred_df$`Prop.97.5%` + 0.25)) +
          scale_x_continuous(limits = c(0, max(G_242$STDAGE_t2)), expand = c(0,0))

gg.242

}  else {print("cannot plot data with prediction")}
```

### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_242 <- data.frame(
  bin = as.factor(levels(cut(G_242$STDAGE_t2, cutvec_242))),
  data.mean = tapply(G_242$B_plt_t2_MgHa, cut(G_242$STDAGE_t2, cutvec_242),
                     mean),
  data.CI.high =  tapply(G_242$B_plt_t2_MgHa, cut(G_242$STDAGE_t2, cutvec_242),
                    high.CI),
  data.CI.low = tapply(G_242$B_plt_t2_MgHa, cut(G_242$STDAGE_t2, cutvec_242),
                    low.CI),
  pred.mean = G_242_pred_df[G_242_pred_df$STDAGE_t2 %in% bin_mids_242,]$fitted)

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY
DM_compare_242 <-  DM_compare_242 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_242$bin)[gtools::mixedorder(levels(DM_compare_242$bin))]))

## ggplot
gg.242.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_242) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_242))),
                              labels = levels(DM_compare_242$bin),
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +
           labs(x = expression("observed biomass (Mg ha"^-1*")"),
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("242 - Pacific Lowland Mixed Forest",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +
           theme_classic() +
           # xlim(min(DM_compare_242$data.CI.low)-0.25, max(DM_compare_242$data.CI.high)+0.25) +
           # ylim(min(DM_compare_242$pred.CI.low)-0.25, max(DM_compare_242$pred.CI.high)+0.25) +
           theme(legend.position = "top") + tune::coord_obs_pred()

gg.242.B2

}   else {print("cannot plot observed vs. predicted")}
```

## 251 - Prairie Parkland (Temperate)
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_251 <- round(quantile(G_251$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_251)))){
  cutvec_251 <- round(quantile(G_251$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_251 <- unname(round(cutvec_251[-length(cutvec_251)] + diff(cutvec_251)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_251$STDAGE_t2_bin<-  cut(G_251$STDAGE_t2, cutvec_251)
## then get bin means
G_251_bin_means <- tapply(G_251$B_plt_t2_MgHa, cut(G_251$STDAGE_t2,  cutvec_251), mean)

## make column weights.2
G_251$nls_weights.2 <- as.numeric(1/(G_251_bin_means[match(G_251$STDAGE_t2_bin, names(G_251_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_251.1 <- nls(f_1, data = G_251, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_251$nls_weights.2), 
 )

## phi
try(
  nls_251.2 <- nls(f_2, data=G_251, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_251$nls_weights.2), 
 )

# phi/alpha
try(
  nls_251.3 <- nls(f_3 , data = G_251, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_251$nls_weights.2), 
 )

## test
if(exists("nls_251.1") & exists("nls_251.2") & exists("nls_251.3")){
  print(anova(nls_251.1, nls_251.2, nls_251.3))
} else if(exists("nls_251.2") & exists("nls_251.3")){
  print(anova(nls_251.2, nls_251.3))
} else if(exists("nls_251.1") & exists("nls_251.2")){
  print(anova(nls_251.1, nls_251.2))
}
 
## AIC comparison
AIC1_251 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_251.1"), AIC(get("nls_251.1")), NA),
            ifelse(exists("nls_251.2"), AIC(get("nls_251.2")), NA),
            ifelse(exists("nls_251.3"), AIC(get("nls_251.3")), NA)
            ))

print(AIC1_251) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_251[!is.na(AIC1_251$AIC) & AIC1_251$AIC == min(AIC1_251$AIC, na.rm = T),]$model

try(summary(get(paste("nls_251.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_251.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_251.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_251.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_251.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_251.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_251.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_251.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_251.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_251.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_251,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_251$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_251.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_251,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_251$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_251.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_251,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_251$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_251.", Mod.Sel1, sep ="")) &
     exists(paste("nls_251.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_251.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_251.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_251.", Mod.Sel1, sep ="")),
             get(paste("nls_251.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_251.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_251.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_251.", Mod.Sel1, sep ="")) &
         exists(paste("nls_251.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_251.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_251.", Mod.Sel1, sep ="")),
               get(paste("nls_251.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_251.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_251.", Mod.Sel1, sep ="")) &
           exists(paste("nls_251.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_251.", Mod.Sel1, sep ="")),
                 get(paste("nls_251.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_251.", Mod.Sel1, sep ="")) &
              exists(paste("nls_251.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_251.", Mod.Sel1, sep ="")),
                    get(paste("nls_251.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_251.", Mod.Sel1, sep ="")) &
                exists(paste("nls_251.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_251.", Mod.Sel1, sep ="")),
                      get(paste("nls_251.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_251 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_251.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_251.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_251.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_251.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_251.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_251.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_251.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_251.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_251)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_251[!is.na(AIC2_251$AIC) & AIC2_251$AIC == min(AIC2_251$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "251",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_251.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_251.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "251",]$ge.variance <- vcov(get(paste("nls_251.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "251",]$phi.variance <- vcov(get(paste("nls_251.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "251",]$alpha.variance <- vcov(get(paste("nls_251.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "251",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "251",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "251",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "251",]$A <- coefs["A"]
nls.param.df_bal[nls.param.df_bal$Code == "251",]$k <- coefs["k"]

nls.param.df_bal[nls.param.df_bal$Code == "251",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "251",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "251",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "251",]$A.2.5 <- intervals_low["A"]
nls.param.df_bal[nls.param.df_bal$Code == "251",]$k.2.5 <- intervals_low["k"]

nls.param.df_bal[nls.param.df_bal$Code == "251",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "251",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "251",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "251",]$A.97.5 <- intervals_high["A"]
nls.param.df_bal[nls.param.df_bal$Code == "251",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_251.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_251.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_251.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_251.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_251$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_251.4 <- nls(f_4, data = G_251, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_251$nls_weights.2), 
 )

## phi
try(
  nls_251.5 <- nls(f_5, data=G_251, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_251$nls_weights.2), 
 )

# phi/alpha
try(
  nls_251.6 <- nls(f_6, data = G_251, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_251$nls_weights.2), 
 )

## test
if(exists("nls_251.4") & exists("nls_251.5") & exists("nls_251.6")){
  print(anova(nls_251.4, nls_251.5, nls_251.6))
} else if(exists("nls_251.4") & exists("nls_251.6")){
  print(anova(nls_251.4, nls_251.6))
} else if(exists("nls_251.5") & exists("nls_251.6")){
  print(anova(nls_251.5, nls_251.6))
} else if(exists("nls_251.4") & exists("nls_251.5")){
  print(anova(nls_251.4, nls_251.5))
}

## AIC comparison
AIC3_251 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_251[AIC2_251$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_251.4"), AIC(get("nls_251.4")), NA),
            ifelse(exists("nls_251.5"), AIC(get("nls_251.5")), NA),
            ifelse(exists("nls_251.6"), AIC(get("nls_251.6")), NA)
            ))

print(AIC3_251) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_251[!is.na(AIC3_251$AIC) & AIC3_251$AIC == min(AIC3_251$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "251",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_bal[Best_mods.P_bal$Code == "251",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_251.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_251.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "251",]$ge.variance <- vcov(get(paste("nls_251.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "251",]$phi.variance <- vcov(get(paste("nls_251.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "251",]$alpha.variance <- vcov(get(paste("nls_251.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "251",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "251",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "251",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "251",]$a <- coefs["a"]
nls.param.df_bal[nls.param.df_bal$Code == "251",]$b <- coefs["b"]
nls.param.df_bal[nls.param.df_bal$Code == "251",]$c <- coefs["c"]
nls.param.df_bal[nls.param.df_bal$Code == "251",]$d <- coefs["d"]

nls.param.df_bal[nls.param.df_bal$Code == "251",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "251",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "251",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "251",]$a.2.5 <- intervals_low["a"]
nls.param.df_bal[nls.param.df_bal$Code == "251",]$b.2.5 <- intervals_low["b"]
nls.param.df_bal[nls.param.df_bal$Code == "251",]$c.2.5 <- intervals_low["c"]
nls.param.df_bal[nls.param.df_bal$Code == "251",]$d.2.5 <- intervals_low["d"]

nls.param.df_bal[nls.param.df_bal$Code == "251",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "251",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "251",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "251",]$a.97.5 <- intervals_high["a"]
nls.param.df_bal[nls.param.df_bal$Code == "251",]$b.97.5 <- intervals_high["b"]
nls.param.df_bal[nls.param.df_bal$Code == "251",]$c.97.5 <- intervals_high["c"]
nls.param.df_bal[nls.param.df_bal$Code == "251",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_251.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_251.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_251.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_251.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_251 <- nlsResiduals(
  get(paste("nls_251.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_251)

## test residuals
if(length(G_251$pltID) < 5001) {test.nlsResiduals(resid_251)}

}   else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_251_pred <- predict(get(paste("nls_251.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_251$MEASTIME_t2, na.rm = T), max(G_251$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_251$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_251$MEASTIME_t2, na.rm = T), max(G_251$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_251$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_251$DeltaPDSI, na.rm = T), max(G_251$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_251$MEASTIME_t2, na.rm = T), max(G_251$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_251$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_251$B_L_prop, na.rm = T), max(G_251$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_251$DeltaPDSI, na.rm = T), max(G_251$STDAGE_t2)))
                      } )

G_251_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_251$STDAGE_t2),by = 1),  
                            "fitted"=G_251_pred)

## plot
gg.251 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_251, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_251, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_251))), breaks = cutvec_251) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_251_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_251_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("251 - Prairie Parkland (Temperate)") + 
          
          #ylim(0, max(G_251_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_251,1)*1.05), expand = c(0,0))

gg.251

}  else {print("cannot plot data with prediction")}
```

### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_251 <- data.frame(
  bin = as.factor(levels(cut(G_251$STDAGE_t2, cutvec_251))),
  data.mean = tapply(G_251$B_plt_t2_MgHa, cut(G_251$STDAGE_t2, cutvec_251), 
                     mean), 
  data.CI.high =  tapply(G_251$B_plt_t2_MgHa, cut(G_251$STDAGE_t2, cutvec_251), 
                    high.CI), 
  data.CI.low = tapply(G_251$B_plt_t2_MgHa, cut(G_251$STDAGE_t2, cutvec_251),
                    low.CI), 
  pred.mean = G_251_pred_df[G_251_pred_df$STDAGE_t2 %in% bin_mids_251,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_251 <-  DM_compare_251 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_251$bin)[gtools::mixedorder(levels(DM_compare_251$bin))]))

## ggplot
gg.251.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_251) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_251))), 
                              labels = levels(DM_compare_251$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("251 - Prairie Parkland (Temperate)",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +         
           theme_classic() + 
           # xlim(min(DM_compare_251$data.CI.low)-0.25, max(DM_compare_251$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_251$pred.CI.low)-0.25, max(DM_compare_251$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.251.B2

}   else {print("cannot plot observed vs. predicted")}
```

## 255 - Prairie Parkland (Subtropical)
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_255 <- round(quantile(G_255$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_255)))){
  cutvec_255 <- round(quantile(G_255$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_255 <- unname(round(cutvec_255[-length(cutvec_255)] + diff(cutvec_255)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_255$STDAGE_t2_bin<-  cut(G_255$STDAGE_t2, cutvec_255)
## then get bin means
G_255_bin_means <- tapply(G_255$B_plt_t2_MgHa, cut(G_255$STDAGE_t2,  cutvec_255), mean)

## make column weights.2
G_255$nls_weights.2 <- as.numeric(1/(G_255_bin_means[match(G_255$STDAGE_t2_bin, names(G_255_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {
  
# simple
try(
  nls_255.1 <- nls(f_1, data = G_255, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_255$nls_weights.2), 
 )

## phi
try(
  nls_255.2 <- nls(f_2, data=G_255, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_255$nls_weights.2), 
 )

# phi/alpha
try(
  nls_255.3 <- nls(f_3 , data = G_255, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_255$nls_weights.2), 
 )

## test
if(exists("nls_255.1") & exists("nls_255.2") & exists("nls_255.3")){
  print(anova(nls_255.1, nls_255.2, nls_255.3))
} else if(exists("nls_255.2") & exists("nls_255.3")){
  print(anova(nls_255.2, nls_255.3))
} else if(exists("nls_255.1") & exists("nls_255.2")){
  print(anova(nls_255.1, nls_255.2))
}
 
## AIC comparison
AIC1_255 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_255.1"), AIC(get("nls_255.1")), NA),
            ifelse(exists("nls_255.2"), AIC(get("nls_255.2")), NA),
            ifelse(exists("nls_255.3"), AIC(get("nls_255.3")), NA)
            ))

print(AIC1_255) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_255[!is.na(AIC1_255$AIC) & AIC1_255$AIC == min(AIC1_255$AIC, na.rm = T),]$model

try(summary(get(paste("nls_255.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_255.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_255.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_255.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_255.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_255.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_255.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_255.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_255.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_255.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_255,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_255$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_255.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_255,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 

          weights = G_255$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_255.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_255,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_255$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_255.", Mod.Sel1, sep ="")) &
     exists(paste("nls_255.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_255.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_255.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_255.", Mod.Sel1, sep ="")),
             get(paste("nls_255.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_255.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_255.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_255.", Mod.Sel1, sep ="")) &
         exists(paste("nls_255.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_255.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_255.", Mod.Sel1, sep ="")),
               get(paste("nls_255.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_255.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_255.", Mod.Sel1, sep ="")) &
           exists(paste("nls_255.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_255.", Mod.Sel1, sep ="")),
                 get(paste("nls_255.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_255.", Mod.Sel1, sep ="")) &
              exists(paste("nls_255.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_255.", Mod.Sel1, sep ="")),
                    get(paste("nls_255.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_255.", Mod.Sel1, sep ="")) &
                exists(paste("nls_255.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_255.", Mod.Sel1, sep ="")),
                      get(paste("nls_255.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_255 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_255.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_255.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_255.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_255.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_255.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_255.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_255.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_255.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_255)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_255[!is.na(AIC2_255$AIC) & AIC2_255$AIC == min(AIC2_255$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "255",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_255.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_255.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "255",]$ge.variance <- vcov(get(paste("nls_255.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "255",]$phi.variance <- vcov(get(paste("nls_255.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "255",]$alpha.variance <- vcov(get(paste("nls_255.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "255",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "255",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "255",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "255",]$A <- coefs["A"]
nls.param.df_bal[nls.param.df_bal$Code == "255",]$k <- coefs["k"]

nls.param.df_bal[nls.param.df_bal$Code == "255",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "255",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "255",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "255",]$A.2.5 <- intervals_low["A"]
nls.param.df_bal[nls.param.df_bal$Code == "255",]$k.2.5 <- intervals_low["k"]

nls.param.df_bal[nls.param.df_bal$Code == "255",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "255",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "255",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "255",]$A.97.5 <- intervals_high["A"]
nls.param.df_bal[nls.param.df_bal$Code == "255",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_255.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_255.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_255.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_255.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_255$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_255.4 <- nls(f_4, data = G_255, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_255$nls_weights.2), 
 )

## phi
try(
  nls_255.5 <- nls(f_5, data=G_255, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_255$nls_weights.2), 
 )

# phi/alpha
try(
  nls_255.6 <- nls(f_6, data = G_255, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_255$nls_weights.2), 
 )

## test
if(exists("nls_255.4") & exists("nls_255.5") & exists("nls_255.6")){
  print(anova(nls_255.4, nls_255.5, nls_255.6))
} else if(exists("nls_255.4") & exists("nls_255.6")){
  print(anova(nls_255.4, nls_255.6))
} else if(exists("nls_255.5") & exists("nls_255.6")){
  print(anova(nls_255.5, nls_255.6))
} else if(exists("nls_255.4") & exists("nls_255.5")){
  print(anova(nls_255.4, nls_255.5))
}

## AIC comparison
AIC3_255 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_255[AIC2_255$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_255.4"), AIC(get("nls_255.4")), NA),
            ifelse(exists("nls_255.5"), AIC(get("nls_255.5")), NA),
            ifelse(exists("nls_255.6"), AIC(get("nls_255.6")), NA)
            ))

print(AIC3_255) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_255[!is.na(AIC3_255$AIC) & AIC3_255$AIC == min(AIC3_255$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "255",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_bal[Best_mods.P_bal$Code == "255",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_255.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_255.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "255",]$ge.variance <- vcov(get(paste("nls_255.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "255",]$phi.variance <- vcov(get(paste("nls_255.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "255",]$alpha.variance <- vcov(get(paste("nls_255.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "255",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "255",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "255",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "255",]$a <- coefs["a"]
nls.param.df_bal[nls.param.df_bal$Code == "255",]$b <- coefs["b"]
nls.param.df_bal[nls.param.df_bal$Code == "255",]$c <- coefs["c"]
nls.param.df_bal[nls.param.df_bal$Code == "255",]$d <- coefs["d"]

nls.param.df_bal[nls.param.df_bal$Code == "255",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "255",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "255",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "255",]$a.2.5 <- intervals_low["a"]
nls.param.df_bal[nls.param.df_bal$Code == "255",]$b.2.5 <- intervals_low["b"]
nls.param.df_bal[nls.param.df_bal$Code == "255",]$c.2.5 <- intervals_low["c"]
nls.param.df_bal[nls.param.df_bal$Code == "255",]$d.2.5 <- intervals_low["d"]

nls.param.df_bal[nls.param.df_bal$Code == "255",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "255",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "255",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "255",]$a.97.5 <- intervals_high["a"]
nls.param.df_bal[nls.param.df_bal$Code == "255",]$b.97.5 <- intervals_high["b"]
nls.param.df_bal[nls.param.df_bal$Code == "255",]$c.97.5 <- intervals_high["c"]
nls.param.df_bal[nls.param.df_bal$Code == "255",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_255.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_255.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_255.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_255.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_255 <- nlsResiduals(
  get(paste("nls_255.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_255)

## test residuals
if(length(G_255$pltID) < 5001) {test.nlsResiduals(resid_255)}

}   else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_255_pred <- predict(get(paste("nls_255.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_255$MEASTIME_t2, na.rm = T), max(G_255$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_255$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_255$MEASTIME_t2, na.rm = T), max(G_255$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_255$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_255$DeltaPDSI, na.rm = T), max(G_255$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_255$MEASTIME_t2, na.rm = T), max(G_255$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_255$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_255$B_L_prop, na.rm = T), max(G_255$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_255$DeltaPDSI, na.rm = T), max(G_255$STDAGE_t2)))
                      } )

G_255_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_255$STDAGE_t2),by = 1),  
                            "fitted"=G_255_pred)

## plot
gg.255 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_255, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_255, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_255))), breaks = cutvec_255) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_255_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_255_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("255 -  Prairie Parkland (Subtropical)") + 
          
          #ylim(0, max(G_255_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_255,1)*1.05), expand = c(0,0))

gg.255

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_255 <- data.frame(
  bin = as.factor(levels(cut(G_255$STDAGE_t2, cutvec_255))),
  data.mean = tapply(G_255$B_plt_t2_MgHa, cut(G_255$STDAGE_t2, cutvec_255), 
                     mean), 
  data.CI.high =  tapply(G_255$B_plt_t2_MgHa, cut(G_255$STDAGE_t2, cutvec_255), 
                    high.CI), 
  data.CI.low = tapply(G_255$B_plt_t2_MgHa, cut(G_255$STDAGE_t2, cutvec_255),
                    low.CI), 
  pred.mean = G_255_pred_df[G_255_pred_df$STDAGE_t2 %in% bin_mids_255,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_255 <-  DM_compare_255 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_255$bin)[gtools::mixedorder(levels(DM_compare_255$bin))]))

## ggplot
gg.255.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_255) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_255))), 
                              labels = levels(DM_compare_255$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("255 -  Prairie Parkland (Subtropical)",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +         
           theme_classic() + 
           # xlim(min(DM_compare_255$data.CI.low)-0.25, max(DM_compare_255$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_255$pred.CI.low)-0.25, max(DM_compare_255$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.255.B2

}   else {print("cannot plot observed vs. predicted")}
```

## 261 - California Coastal Chaparral Forest and Shrub
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_261 <- round(quantile(G_261$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_261)))){
  cutvec_261 <- round(quantile(G_261$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_261 <- unname(round(cutvec_261[-length(cutvec_261)] + diff(cutvec_261)/2))

#### add weights data column)

## first get the correct bin  - assign as column in data frame
G_261$STDAGE_t2_bin<-  cut(G_261$STDAGE_t2, cutvec_261)
## then get bin means
G_261_bin_means <- tapply(G_261$B_plt_t2_MgHa, cut(G_261$STDAGE_t2,  cutvec_261), mean)

## make column weights.2
G_261$nls_weights.2 <- as.numeric(1/(G_261_bin_means[match(G_261$STDAGE_t2_bin, names(G_261_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_261.1 <- nls(f_1, data = G_261, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_261$nls_weights.2), 
 )

## phi
try(
  nls_261.2 <- nls(f_2, data=G_261, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_261$nls_weights.2), 
 )

# phi/alpha
try(
  nls_261.3 <- nls(f_3 , data = G_261, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_261$nls_weights.2), 
 )

## test
if(exists("nls_261.1") & exists("nls_261.2") & exists("nls_261.3")){
  print(anova(nls_261.1, nls_261.2, nls_261.3))
} else if(exists("nls_261.2") & exists("nls_261.3")){
  print(anova(nls_261.2, nls_261.3))
} else if(exists("nls_261.1") & exists("nls_261.2")){
  print(anova(nls_261.1, nls_261.2))
}
 
## AIC comparison
AIC1_261 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_261.1"), AIC(get("nls_261.1")), NA),
            ifelse(exists("nls_261.2"), AIC(get("nls_261.2")), NA),
            ifelse(exists("nls_261.3"), AIC(get("nls_261.3")), NA)
            ))

print(AIC1_261) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_261[!is.na(AIC1_261$AIC) &AIC1_261$AIC == min(AIC1_261$AIC, na.rm = T),]$model

try(summary(get(paste("nls_261.",  Mod.Sel1, sep =""))) )   #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_261.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_261.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_261.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_261.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_261.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_261.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_261.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_261.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_261.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_261,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_261$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_261.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_261,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_261$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_261.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_261,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_261$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_261.", Mod.Sel1, sep ="")) &
     exists(paste("nls_261.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_261.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_261.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_261.", Mod.Sel1, sep ="")),
             get(paste("nls_261.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_261.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_261.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_261.", Mod.Sel1, sep ="")) &
         exists(paste("nls_261.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_261.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_261.", Mod.Sel1, sep ="")),
               get(paste("nls_261.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_261.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_261.", Mod.Sel1, sep ="")) &
           exists(paste("nls_261.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_261.", Mod.Sel1, sep ="")),
                 get(paste("nls_261.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_261.", Mod.Sel1, sep ="")) &
              exists(paste("nls_261.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_261.", Mod.Sel1, sep ="")),
                    get(paste("nls_261.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_261.", Mod.Sel1, sep ="")) &
                exists(paste("nls_261.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_261.", Mod.Sel1, sep ="")),
                      get(paste("nls_261.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_261 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_261.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_261.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_261.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_261.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_261.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_261.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_261.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_261.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_261)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_261[!is.na(AIC2_261$AIC) & AIC2_261$AIC == min(AIC2_261$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "261",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_261.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_261.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "261",]$ge.variance <- vcov(get(paste("nls_261.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "261",]$phi.variance <- vcov(get(paste("nls_261.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "261",]$alpha.variance <- vcov(get(paste("nls_261.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "261",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "261",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "261",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "261",]$A <- coefs["A"]
nls.param.df_bal[nls.param.df_bal$Code == "261",]$k <- coefs["k"]

nls.param.df_bal[nls.param.df_bal$Code == "261",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "261",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "261",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "261",]$A.2.5 <- intervals_low["A"]
nls.param.df_bal[nls.param.df_bal$Code == "261",]$k.2.5 <- intervals_low["k"]

nls.param.df_bal[nls.param.df_bal$Code == "261",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "261",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "261",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "261",]$A.97.5 <- intervals_high["A"]
nls.param.df_bal[nls.param.df_bal$Code == "261",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_261.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_261.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_261.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_261.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

* unable to fit model (only 64 observations)

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_261$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_261.4 <- nls(f_4, data = G_261, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_261$nls_weights.2), 
 )

## phi
try(
  nls_261.5 <- nls(f_5, data=G_261, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_261$nls_weights.2), 
 )

# phi/alpha
try(
  nls_261.6 <- nls(f_6, data = G_261, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_261$nls_weights.2), 
 )

## test
if(exists("nls_261.4") & exists("nls_261.5") & exists("nls_261.6")){
  print(anova(nls_261.4, nls_261.5, nls_261.6))
} else if(exists("nls_261.4") & exists("nls_261.6")){
  print(anova(nls_261.4, nls_261.6))
} else if(exists("nls_261.5") & exists("nls_261.6")){
  print(anova(nls_261.5, nls_261.6))
} else if(exists("nls_261.4") & exists("nls_261.5")){
  print(anova(nls_261.4, nls_261.5))
}

## AIC comparison
AIC3_261 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_261[AIC2_261$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_261.4"), AIC(get("nls_261.4")), NA),
            ifelse(exists("nls_261.5"), AIC(get("nls_261.5")), NA),
            ifelse(exists("nls_261.6"), AIC(get("nls_261.6")), NA)
            ))

print(AIC3_261) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_261[!is.na(AIC3_261$AIC) & AIC3_261$AIC == min(AIC3_261$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "261",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_bal[Best_mods.P_bal$Code == "261",]$Best.Mod <- Mod.Sel3


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "261",]$ge.variance <- vcov(get(paste("nls_261.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "261",]$phi.variance <- vcov(get(paste("nls_261.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "261",]$alpha.variance <- vcov(get(paste("nls_261.",  Mod.Sel3, sep ="")))["alpha","alpha"]


## write coefficients to table 
coefs <- coef(get(paste("nls_261.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_261.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df_bal[nls.param.df_bal$Code == "261",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "261",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "261",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "261",]$a <- coefs["a"]
nls.param.df_bal[nls.param.df_bal$Code == "261",]$b <- coefs["b"]
nls.param.df_bal[nls.param.df_bal$Code == "261",]$c <- coefs["c"]
nls.param.df_bal[nls.param.df_bal$Code == "261",]$d <- coefs["d"]

nls.param.df_bal[nls.param.df_bal$Code == "261",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "261",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "261",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "261",]$a.2.5 <- intervals_low["a"]
nls.param.df_bal[nls.param.df_bal$Code == "261",]$b.2.5 <- intervals_low["b"]
nls.param.df_bal[nls.param.df_bal$Code == "261",]$c.2.5 <- intervals_low["c"]
nls.param.df_bal[nls.param.df_bal$Code == "261",]$d.2.5 <- intervals_low["d"]

nls.param.df_bal[nls.param.df_bal$Code == "261",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "261",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "261",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "261",]$a.97.5 <- intervals_high["a"]
nls.param.df_bal[nls.param.df_bal$Code == "261",]$b.97.5 <- intervals_high["b"]
nls.param.df_bal[nls.param.df_bal$Code == "261",]$c.97.5 <- intervals_high["c"]
nls.param.df_bal[nls.param.df_bal$Code == "261",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_261.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_261.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_261.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_261.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_261 <- nlsResiduals(
  get(paste("nls_261.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_261)

## test residuals
if(length(G_261$pltID) < 5001) {test.nlsResiduals(resid_261)}

}  else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_261_pred <- predict(get(paste("nls_261.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_261$MEASTIME_t2, na.rm = T), max(G_261$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_261$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_261$MEASTIME_t2, na.rm = T), max(G_261$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_261$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_261$DeltaPDSI, na.rm = T), max(G_261$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_261$MEASTIME_t2, na.rm = T), max(G_261$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_261$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_261$B_L_prop, na.rm = T), max(G_261$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_261$DeltaPDSI, na.rm = T), max(G_261$STDAGE_t2)))
                      } )

G_261_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_261$STDAGE_t2),by = 1),  
                            "fitted"=G_261_pred)

## plot
gg.261 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_261, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_261, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length(bin_mids_261))), breaks = cutvec_261) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_261_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_261_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("261 - California Coastal Chaparral Forest and Shrub") + 
          
          #ylim(0, max(G_261_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_261*1.05)), expand = c(0,0))

gg.261

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_261 <- data.frame(
  bin = as.factor(levels(cut(G_261$STDAGE_t2, cutvec_261))),
  data.mean = tapply(G_261$B_plt_t2_MgHa, cut(G_261$STDAGE_t2, cutvec_261), 
                     mean), 
  data.CI.high =  tapply(G_261$B_plt_t2_MgHa, cut(G_261$STDAGE_t2, cutvec_261), 
                    high.CI), 
  data.CI.low = tapply(G_261$B_plt_t2_MgHa, cut(G_261$STDAGE_t2, cutvec_261),
                    low.CI), 
  pred.mean = G_261_pred_df[G_261_pred_df$STDAGE_t2 %in% bin_mids_261,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_261 <-  DM_compare_261 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_261$bin)[gtools::mixedorder(levels(DM_compare_261$bin))]))

## ggplot
gg.261.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_261) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_261))), 
                              labels = levels(DM_compare_261$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("261 - California Coastal Chaparral Forest and Shrub",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +         
           theme_classic() + 
           # xlim(min(DM_compare_261$data.CI.low)-0.25, max(DM_compare_261$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_261$pred.CI.low)-0.25, max(DM_compare_261$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.261.B2

}   else {print("cannot plot observed vs. predicted")}
```

## 262 - California Dry Steppe
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_262 <- round(quantile(G_262$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_262)))){
  cutvec_262 <- round(quantile(G_262$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_262 <- unname(round(cutvec_262[-length(cutvec_262)] + diff(cutvec_262)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_262$STDAGE_t2_bin<-  cut(G_262$STDAGE_t2, cutvec_262)
## then get bin means
G_262_bin_means <- tapply(G_262$B_plt_t2_MgHa, cut(G_262$STDAGE_t2,  cutvec_262), mean)

## make column weights.2
G_262$nls_weights.2 <- as.numeric(1/(G_262_bin_means[match(G_262$STDAGE_t2_bin, names(G_262_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_262.1 <- nls(f_1, data = G_262, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_262$nls_weights.2), 
 )

## phi
try(
  nls_262.2 <- nls(f_2, data=G_262, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_262$nls_weights.2), 
 )

# phi/alpha
try(
  nls_262.3 <- nls(f_3 , data = G_262, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_262$nls_weights.2), 
 )

## test
if(exists("nls_262.1") & exists("nls_262.2") & exists("nls_262.3")){
  print(anova(nls_262.1, nls_262.2, nls_262.3))
} else if(exists("nls_262.2") & exists("nls_262.3")){
  print(anova(nls_262.2, nls_262.3))
} else if(exists("nls_262.1") & exists("nls_262.2")){
  print(anova(nls_262.1, nls_262.2))
}
 
## AIC comparison
AIC1_262 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_262.1"), AIC(get("nls_262.1")), NA),
            ifelse(exists("nls_262.2"), AIC(get("nls_262.2")), NA),
            ifelse(exists("nls_262.3"), AIC(get("nls_262.3")), NA)
            ))

print(AIC1_262) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_262[!is.na(AIC1_262$AIC) & AIC1_262$AIC == min(AIC1_262$AIC, na.rm = T),]$model

try(summary(get(paste("nls_262.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_262.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_262.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_262.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_262.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_262.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_262.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_262.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_262.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_262.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_262,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_262$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_262.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_262,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_262$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_262.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_262,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_262$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_262.", Mod.Sel1, sep ="")) &
     exists(paste("nls_262.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_262.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_262.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_262.", Mod.Sel1, sep ="")),
             get(paste("nls_262.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_262.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_262.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_262.", Mod.Sel1, sep ="")) &
         exists(paste("nls_262.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_262.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_262.", Mod.Sel1, sep ="")),
               get(paste("nls_262.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_262.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_262.", Mod.Sel1, sep ="")) &
           exists(paste("nls_262.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_262.", Mod.Sel1, sep ="")),
                 get(paste("nls_262.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_262.", Mod.Sel1, sep ="")) &
              exists(paste("nls_262.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_262.", Mod.Sel1, sep ="")),
                    get(paste("nls_262.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_262.", Mod.Sel1, sep ="")) &
                exists(paste("nls_262.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_262.", Mod.Sel1, sep ="")),
                      get(paste("nls_262.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_262 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_262.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_262.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_262.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_262.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_262.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_262.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_262.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_262.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_262)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_262[!is.na(AIC2_262$AIC) & AIC2_262$AIC == min(AIC2_262$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "262",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_262.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_262.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "262",]$ge.variance <- vcov(get(paste("nls_262.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "262",]$phi.variance <- vcov(get(paste("nls_262.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "262",]$alpha.variance <- vcov(get(paste("nls_262.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "262",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "262",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "262",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "262",]$A <- coefs["A"]
nls.param.df_bal[nls.param.df_bal$Code == "262",]$k <- coefs["k"]

nls.param.df_bal[nls.param.df_bal$Code == "262",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "262",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "262",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "262",]$A.2.5 <- intervals_low["A"]
nls.param.df_bal[nls.param.df_bal$Code == "262",]$k.2.5 <- intervals_low["k"]

nls.param.df_bal[nls.param.df_bal$Code == "262",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "262",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "262",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "262",]$A.97.5 <- intervals_high["A"]
nls.param.df_bal[nls.param.df_bal$Code == "262",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_262.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_262.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_262.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_262.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

* unable to fit model (0 observations)

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_262$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_262.4 <- nls(f_4, data = G_262, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_262$nls_weights.2), 
 )

## phi
try(
  nls_262.5 <- nls(f_5, data=G_262, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_262$nls_weights.2), 
 )

# phi/alpha
try(
  nls_262.6 <- nls(f_6, data = G_262, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_262$nls_weights.2), 
 )

## test
if(exists("nls_262.4") & exists("nls_262.5") & exists("nls_262.6")){
  print(anova(nls_262.4, nls_262.5, nls_262.6))
} else if(exists("nls_262.4") & exists("nls_262.6")){
  print(anova(nls_262.4, nls_262.6))
} else if(exists("nls_262.5") & exists("nls_262.6")){
  print(anova(nls_262.5, nls_262.6))
} else if(exists("nls_262.4") & exists("nls_262.5")){
  print(anova(nls_262.4, nls_262.5))
}

## AIC comparison
AIC3_262 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_262[AIC2_262$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_262.4"), AIC(get("nls_262.4")), NA),
            ifelse(exists("nls_262.5"), AIC(get("nls_262.5")), NA),
            ifelse(exists("nls_262.6"), AIC(get("nls_262.6")), NA)
            ))

print(AIC3_262) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_262[!is.na(AIC3_262$AIC) & AIC3_262$AIC == min(AIC3_262$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "262",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_bal[Best_mods.P_bal$Code == "262",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_262.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_262.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "262",]$ge.variance <- vcov(get(paste("nls_262.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "262",]$phi.variance <- vcov(get(paste("nls_262.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "262",]$alpha.variance <- vcov(get(paste("nls_262.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "262",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "262",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "262",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "262",]$a <- coefs["a"]
nls.param.df_bal[nls.param.df_bal$Code == "262",]$b <- coefs["b"]
nls.param.df_bal[nls.param.df_bal$Code == "262",]$c <- coefs["c"]
nls.param.df_bal[nls.param.df_bal$Code == "262",]$d <- coefs["d"]

nls.param.df_bal[nls.param.df_bal$Code == "262",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "262",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "262",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "262",]$a.2.5 <- intervals_low["a"]
nls.param.df_bal[nls.param.df_bal$Code == "262",]$b.2.5 <- intervals_low["b"]
nls.param.df_bal[nls.param.df_bal$Code == "262",]$c.2.5 <- intervals_low["c"]
nls.param.df_bal[nls.param.df_bal$Code == "262",]$d.2.5 <- intervals_low["d"]

nls.param.df_bal[nls.param.df_bal$Code == "262",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "262",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "262",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "262",]$a.97.5 <- intervals_high["a"]
nls.param.df_bal[nls.param.df_bal$Code == "262",]$b.97.5 <- intervals_high["b"]
nls.param.df_bal[nls.param.df_bal$Code == "262",]$c.97.5 <- intervals_high["c"]
nls.param.df_bal[nls.param.df_bal$Code == "262",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_262.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_262.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_262.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_262.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_262 <- nlsResiduals(
  get(paste("nls_262.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_262)

## test residuals
if(length(G_262$pltID) < 5001) {test.nlsResiduals(resid_262)}

}  else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_262_pred <- predict(get(paste("nls_262.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_262$MEASTIME_t2, na.rm = T), max(G_262$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_262$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_262$MEASTIME_t2, na.rm = T), max(G_262$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_262$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_262$DeltaPDSI, na.rm = T), max(G_262$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_262$MEASTIME_t2, na.rm = T), max(G_262$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_262$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_262$B_L_prop, na.rm = T), max(G_262$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_262$DeltaPDSI, na.rm = T), max(G_262$STDAGE_t2)))
                      } )

G_262_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_262$STDAGE_t2),by = 1),  
                            "fitted"=G_262_pred)

## plot
gg.262 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_262, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_262, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_262))), breaks = cutvec_262) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_262_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_262_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("262 - California Dry Steppe") + 
          
          #ylim(0, max(G_262_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_262,1)*1.05), expand = c(0,0))

gg.262

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_262 <- data.frame(
  bin = as.factor(levels(cut(G_262$STDAGE_t2, cutvec_262))),
  data.mean = tapply(G_262$B_plt_t2_MgHa, cut(G_262$STDAGE_t2, cutvec_262), 
                     mean), 
  data.CI.high =  tapply(G_262$B_plt_t2_MgHa, cut(G_262$STDAGE_t2, cutvec_262), 
                    high.CI), 
  data.CI.low = tapply(G_262$B_plt_t2_MgHa, cut(G_262$STDAGE_t2, cutvec_262),
                    low.CI), 
  pred.mean = G_262_pred_df[G_262_pred_df$STDAGE_t2 %in% bin_mids_262,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_262 <-  DM_compare_262 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_262$bin)[gtools::mixedorder(levels(DM_compare_262$bin))]))

## ggplot
gg.262.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_262) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_262))), 
                              labels = levels(DM_compare_262$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("262 - California Dry Steppe",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +        
           theme_classic() + 
           # xlim(min(DM_compare_262$data.CI.low)-0.25, max(DM_compare_262$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_262$pred.CI.low)-0.25, max(DM_compare_262$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.262.B2

}   else {print("cannot plot observed vs. predicted")}
```

## 263 - California Coastal Steppe - Mixed Forest and Redwood Forest
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_263 <- round(quantile(G_263$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_263)))){
  cutvec_263 <- round(quantile(G_263$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_263 <- unname(round(cutvec_263[-length(cutvec_263)] + diff(cutvec_263)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_263$STDAGE_t2_bin<-  cut(G_263$STDAGE_t2, cutvec_263)
## then get bin means
G_263_bin_means <- tapply(G_263$B_plt_t2_MgHa, cut(G_263$STDAGE_t2,  cutvec_263), mean)

## make column weights.2
G_263$nls_weights.2 <- as.numeric(1/(G_263_bin_means[match(G_263$STDAGE_t2_bin, names(G_263_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_263.1 <- nls(f_1, data = G_263, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_263$nls_weights.2), 
 )

## phi
try(
  nls_263.2 <- nls(f_2, data=G_263, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_263$nls_weights.2), 
 )

# phi/alpha
try(
  nls_263.3 <- nls(f_3 , data = G_263, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_263$nls_weights.2), 
 )

## test
if(exists("nls_263.1") & exists("nls_263.2") & exists("nls_263.3")){
  print(anova(nls_263.1, nls_263.2, nls_263.3))
} else if(exists("nls_263.2") & exists("nls_263.3")){
  print(anova(nls_263.2, nls_263.3))
} else if(exists("nls_263.1") & exists("nls_263.2")){
  print(anova(nls_263.1, nls_263.2))
}
 
## AIC comparison
AIC1_263 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_263.1"), AIC(get("nls_263.1")), NA),
            ifelse(exists("nls_263.2"), AIC(get("nls_263.2")), NA),
            ifelse(exists("nls_263.3"), AIC(get("nls_263.3")), NA)
            ))

print(AIC1_263) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_263[!is.na(AIC1_263$AIC) & AIC1_263$AIC == min(AIC1_263$AIC, na.rm = T),]$model

try(summary(get(paste("nls_263.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_263.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_263.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_263.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_263.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_263.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_263.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_263.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_263.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_263.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_263,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_263$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_263.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_263,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_263$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_263.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_263,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_263$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_263.", Mod.Sel1, sep ="")) &
     exists(paste("nls_263.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_263.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_263.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_263.", Mod.Sel1, sep ="")),
             get(paste("nls_263.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_263.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_263.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_263.", Mod.Sel1, sep ="")) &
         exists(paste("nls_263.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_263.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_263.", Mod.Sel1, sep ="")),
               get(paste("nls_263.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_263.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_263.", Mod.Sel1, sep ="")) &
           exists(paste("nls_263.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_263.", Mod.Sel1, sep ="")),
                 get(paste("nls_263.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_263.", Mod.Sel1, sep ="")) &
              exists(paste("nls_263.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_263.", Mod.Sel1, sep ="")),
                    get(paste("nls_263.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_263.", Mod.Sel1, sep ="")) &
                exists(paste("nls_263.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_263.", Mod.Sel1, sep ="")),
                      get(paste("nls_263.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_263 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_263.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_263.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_263.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_263.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_263.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_263.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_263.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_263.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_263)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_263[!is.na(AIC2_263$AIC) & AIC2_263$AIC == min(AIC2_263$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "263",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_263.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_263.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "263",]$ge.variance <- vcov(get(paste("nls_263.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "263",]$phi.variance <- vcov(get(paste("nls_263.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "263",]$alpha.variance <- vcov(get(paste("nls_263.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "263",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "263",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "263",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "263",]$A <- coefs["A"]
nls.param.df_bal[nls.param.df_bal$Code == "263",]$k <- coefs["k"]

nls.param.df_bal[nls.param.df_bal$Code == "263",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "263",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "263",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "263",]$A.2.5 <- intervals_low["A"]
nls.param.df_bal[nls.param.df_bal$Code == "263",]$k.2.5 <- intervals_low["k"]

nls.param.df_bal[nls.param.df_bal$Code == "263",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "263",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "263",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "263",]$A.97.5 <- intervals_high["A"]
nls.param.df_bal[nls.param.df_bal$Code == "263",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_263.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_263.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_263.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_263.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_263$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_263.4 <- nls(f_4, data = G_263, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_263$nls_weights.2), 
 )

## phi
try(
  nls_263.5 <- nls(f_5, data=G_263, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_263$nls_weights.2), 
 )

# phi/alpha
try(
  nls_263.6 <- nls(f_6, data = G_263, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_263$nls_weights.2), 
 )

## test
if(exists("nls_263.4") & exists("nls_263.5") & exists("nls_263.6")){
  print(anova(nls_263.4, nls_263.5, nls_263.6))
} else if(exists("nls_263.4") & exists("nls_263.6")){
  print(anova(nls_263.4, nls_263.6))
} else if(exists("nls_263.5") & exists("nls_263.6")){
  print(anova(nls_263.5, nls_263.6))
} else if(exists("nls_263.4") & exists("nls_263.5")){
  print(anova(nls_263.4, nls_263.5))
}

## AIC comparison
AIC3_263 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_263[AIC2_263$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_263.4"), AIC(get("nls_263.4")), NA),
            ifelse(exists("nls_263.5"), AIC(get("nls_263.5")), NA),
            ifelse(exists("nls_263.6"), AIC(get("nls_263.6")), NA)
            ))

print(AIC3_263) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_263[!is.na(AIC3_263$AIC) & AIC3_263$AIC == min(AIC3_263$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "263",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_bal[Best_mods.P_bal$Code == "263",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_263.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_263.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "263",]$ge.variance <- vcov(get(paste("nls_263.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "263",]$phi.variance <- vcov(get(paste("nls_263.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "263",]$alpha.variance <- vcov(get(paste("nls_263.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "263",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "263",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "263",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "263",]$a <- coefs["a"]
nls.param.df_bal[nls.param.df_bal$Code == "263",]$b <- coefs["b"]
nls.param.df_bal[nls.param.df_bal$Code == "263",]$c <- coefs["c"]
nls.param.df_bal[nls.param.df_bal$Code == "263",]$d <- coefs["d"]

nls.param.df_bal[nls.param.df_bal$Code == "263",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "263",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "263",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "263",]$a.2.5 <- intervals_low["a"]
nls.param.df_bal[nls.param.df_bal$Code == "263",]$b.2.5 <- intervals_low["b"]
nls.param.df_bal[nls.param.df_bal$Code == "263",]$c.2.5 <- intervals_low["c"]
nls.param.df_bal[nls.param.df_bal$Code == "263",]$d.2.5 <- intervals_low["d"]

nls.param.df_bal[nls.param.df_bal$Code == "263",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "263",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "263",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "263",]$a.97.5 <- intervals_high["a"]
nls.param.df_bal[nls.param.df_bal$Code == "263",]$b.97.5 <- intervals_high["b"]
nls.param.df_bal[nls.param.df_bal$Code == "263",]$c.97.5 <- intervals_high["c"]
nls.param.df_bal[nls.param.df_bal$Code == "263",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_263.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_263.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_263.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_263.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_263 <- nlsResiduals(
  get(paste("nls_263.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_263)

## test residuals
if(length(G_263$pltID) < 5001) {test.nlsResiduals(resid_263)}

}  else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_263_pred <- predict(get(paste("nls_263.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_263$MEASTIME_t2, na.rm = T), max(G_263$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_263$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_263$MEASTIME_t2, na.rm = T), max(G_263$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_263$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_263$DeltaPDSI, na.rm = T), max(G_263$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_263$MEASTIME_t2, na.rm = T), max(G_263$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_263$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_263$B_L_prop, na.rm = T), max(G_263$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_263$DeltaPDSI, na.rm = T), max(G_263$STDAGE_t2)))
                      } )

G_263_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_263$STDAGE_t2),by = 1),  
                            "fitted"=G_263_pred)

## plot
gg.263 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_263, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_263, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1, length.out = length(bin_mids_263))), breaks = cutvec_263) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_263_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_263_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("263 - California Coastal Steppe - Mixed Forest and Redwood Forest") + 
          
          #ylim(0, max(G_263_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_263,1)*1.05), expand = c(0,0))

gg.263

}  else {print("cannot plot data with prediction")}
```

### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_263 <- data.frame(
  bin = as.factor(levels(cut(G_263$STDAGE_t2, cutvec_263))),
  data.mean = tapply(G_263$B_plt_t2_MgHa, cut(G_263$STDAGE_t2, cutvec_263), 
                     mean), 
  data.CI.high =  tapply(G_263$B_plt_t2_MgHa, cut(G_263$STDAGE_t2, cutvec_263), 
                    high.CI), 
  data.CI.low = tapply(G_263$B_plt_t2_MgHa, cut(G_263$STDAGE_t2, cutvec_263),
                    low.CI), 
  pred.mean = G_263_pred_df[G_263_pred_df$STDAGE_t2 %in% bin_mids_263,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_263 <-  DM_compare_263 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_263$bin)[gtools::mixedorder(levels(DM_compare_263$bin))]))

## ggplot
gg.263.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_263) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_263))), 
                              labels = levels(DM_compare_263$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("263 - California Coastal Steppe - Mixed Forest and Redwood Forest",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +        
           theme_classic() + 
           # xlim(min(DM_compare_263$data.CI.low)-0.25, max(DM_compare_263$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_263$pred.CI.low)-0.25, max(DM_compare_263$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.263.B2

}   else {print("cannot plot observed vs. predicted")}
```

## 313 - Colorado Plateau Semi-Desert
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_313 <- round(quantile(G_313$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_313)))){
  cutvec_313 <- round(quantile(G_313$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_313 <- unname(round(cutvec_313[-length(cutvec_313)] + diff(cutvec_313)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_313$STDAGE_t2_bin<-  cut(G_313$STDAGE_t2, cutvec_313)
## then get bin means
G_313_bin_means <- tapply(G_313$B_plt_t2_MgHa, cut(G_313$STDAGE_t2,  cutvec_313), mean)

## make column weights.2
G_313$nls_weights.2 <- as.numeric(1/(G_313_bin_means[match(G_313$STDAGE_t2_bin, names(G_313_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_313.1 <- nls(f_1, data = G_313, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_313$nls_weights.2), 
 )

## phi
try(
  nls_313.2 <- nls(f_2, data=G_313, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_313$nls_weights.2), 
 )

# phi/alpha
try(
  nls_313.3 <- nls(f_3 , data = G_313, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_313$nls_weights.2), 
 )

## test
if(exists("nls_313.1") & exists("nls_313.2") & exists("nls_313.3")){
  print(anova(nls_313.1, nls_313.2, nls_313.3))
} else if(exists("nls_313.2") & exists("nls_313.3")){
  print(anova(nls_313.2, nls_313.3))
} else if(exists("nls_313.1") & exists("nls_313.2")){
  print(anova(nls_313.1, nls_313.2))
}
 
## AIC comparison
AIC1_313 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_313.1"), AIC(get("nls_313.1")), NA),
            ifelse(exists("nls_313.2"), AIC(get("nls_313.2")), NA),
            ifelse(exists("nls_313.3"), AIC(get("nls_313.3")), NA)
            ))

print(AIC1_313) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_313[!is.na(AIC1_313$AIC) & AIC1_313$AIC == min(AIC1_313$AIC, na.rm = T),]$model

try(summary(get(paste("nls_313.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_313.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_313.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_313.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_313.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_313.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_313.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_313.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_313.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_313.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_313,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_313$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_313.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_313,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_313$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_313.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_313,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_313$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_313.", Mod.Sel1, sep ="")) &
     exists(paste("nls_313.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_313.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_313.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_313.", Mod.Sel1, sep ="")),
             get(paste("nls_313.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_313.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_313.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_313.", Mod.Sel1, sep ="")) &
         exists(paste("nls_313.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_313.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_313.", Mod.Sel1, sep ="")),
               get(paste("nls_313.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_313.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_313.", Mod.Sel1, sep ="")) &
           exists(paste("nls_313.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_313.", Mod.Sel1, sep ="")),
                 get(paste("nls_313.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_313.", Mod.Sel1, sep ="")) &
              exists(paste("nls_313.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_313.", Mod.Sel1, sep ="")),
                    get(paste("nls_313.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_313.", Mod.Sel1, sep ="")) &
                exists(paste("nls_313.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_313.", Mod.Sel1, sep ="")),
                      get(paste("nls_313.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_313 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_313.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_313.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_313.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_313.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_313.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_313.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_313.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_313.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_313)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_313[!is.na(AIC2_313$AIC) & AIC2_313$AIC == min(AIC2_313$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "313",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_313.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_313.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "313",]$ge.variance <- vcov(get(paste("nls_313.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "313",]$phi.variance <- vcov(get(paste("nls_313.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "313",]$alpha.variance <- vcov(get(paste("nls_313.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "313",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "313",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "313",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "313",]$A <- coefs["A"]
nls.param.df_bal[nls.param.df_bal$Code == "313",]$k <- coefs["k"]

nls.param.df_bal[nls.param.df_bal$Code == "313",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "313",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "313",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "313",]$A.2.5 <- intervals_low["A"]
nls.param.df_bal[nls.param.df_bal$Code == "313",]$k.2.5 <- intervals_low["k"]

nls.param.df_bal[nls.param.df_bal$Code == "313",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "313",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "313",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "313",]$A.97.5 <- intervals_high["A"]
nls.param.df_bal[nls.param.df_bal$Code == "313",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_313.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_313.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_313.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_313.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_313$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_313.4 <- nls(f_4, data = G_313, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_313$nls_weights.2), 
 )

## phi
try(
  nls_313.5 <- nls(f_5, data=G_313, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_313$nls_weights.2), 
 )

# phi/alpha
try(
  nls_313.6 <- nls(f_6, data = G_313, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_313$nls_weights.2), 
 )

## test
if(exists("nls_313.4") & exists("nls_313.5") & exists("nls_313.6")){
  print(anova(nls_313.4, nls_313.5, nls_313.6))
} else if(exists("nls_313.4") & exists("nls_313.6")){
  print(anova(nls_313.4, nls_313.6))
} else if(exists("nls_313.5") & exists("nls_313.6")){
  print(anova(nls_313.5, nls_313.6))
} else if(exists("nls_313.4") & exists("nls_313.5")){
  print(anova(nls_313.4, nls_313.5))
}

## AIC comparison
AIC3_313 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_313[AIC2_313$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_313.4"), AIC(get("nls_313.4")), NA),
            ifelse(exists("nls_313.5"), AIC(get("nls_313.5")), NA),
            ifelse(exists("nls_313.6"), AIC(get("nls_313.6")), NA)
            ))

print(AIC3_313) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_313[!is.na(AIC3_313$AIC) & AIC3_313$AIC == min(AIC3_313$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "313",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_bal[Best_mods.P_bal$Code == "313",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_313.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_313.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "313",]$ge.variance <- vcov(get(paste("nls_313.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "313",]$phi.variance <- vcov(get(paste("nls_313.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "313",]$alpha.variance <- vcov(get(paste("nls_313.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "313",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "313",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "313",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "313",]$a <- coefs["a"]
nls.param.df_bal[nls.param.df_bal$Code == "313",]$b <- coefs["b"]
nls.param.df_bal[nls.param.df_bal$Code == "313",]$c <- coefs["c"]
nls.param.df_bal[nls.param.df_bal$Code == "313",]$d <- coefs["d"]

nls.param.df_bal[nls.param.df_bal$Code == "313",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "313",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "313",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "313",]$a.2.5 <- intervals_low["a"]
nls.param.df_bal[nls.param.df_bal$Code == "313",]$b.2.5 <- intervals_low["b"]
nls.param.df_bal[nls.param.df_bal$Code == "313",]$c.2.5 <- intervals_low["c"]
nls.param.df_bal[nls.param.df_bal$Code == "313",]$d.2.5 <- intervals_low["d"]

nls.param.df_bal[nls.param.df_bal$Code == "313",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "313",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "313",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "313",]$a.97.5 <- intervals_high["a"]
nls.param.df_bal[nls.param.df_bal$Code == "313",]$b.97.5 <- intervals_high["b"]
nls.param.df_bal[nls.param.df_bal$Code == "313",]$c.97.5 <- intervals_high["c"]
nls.param.df_bal[nls.param.df_bal$Code == "313",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_313.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_313.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_313.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_313.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_313 <- nlsResiduals(
  get(paste("nls_313.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_313)

## test residuals
if(length(G_313$pltID) < 5001) {test.nlsResiduals(resid_313)}

}  else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## predict model fit 
G_313_pred <- predict(get(paste("nls_313.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_313$MEASTIME_t2, na.rm = T), max(G_313$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_313$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_313$MEASTIME_t2, na.rm = T), max(G_313$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_313$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_313$DeltaPDSI, na.rm = T), max(G_313$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_313$MEASTIME_t2, na.rm = T), max(G_313$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_313$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_313$B_L_prop, na.rm = T), max(G_313$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_313$DeltaPDSI, na.rm = T), max(G_313$STDAGE_t2)))
                      } )

G_313_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_313$STDAGE_t2),by = 1),  
                            "fitted"=G_313_pred)

## plot
gg.313 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_313, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_313, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_313))), breaks = cutvec_313) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_313_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_313_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("313 - Colorado Plateau Semi-Desert") + 
          
          #ylim(0, max(G_313_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_313,1)*1.05), expand = c(0,0))


gg.313

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_313 <- data.frame(
  bin = as.factor(levels(cut(G_313$STDAGE_t2, cutvec_313))),
  data.mean = tapply(G_313$B_plt_t2_MgHa, cut(G_313$STDAGE_t2, cutvec_313), 
                     mean), 
  data.CI.high =  tapply(G_313$B_plt_t2_MgHa, cut(G_313$STDAGE_t2, cutvec_313), 
                    high.CI), 
  data.CI.low = tapply(G_313$B_plt_t2_MgHa, cut(G_313$STDAGE_t2, cutvec_313),
                    low.CI), 
  pred.mean = G_313_pred_df[G_313_pred_df$STDAGE_t2 %in% bin_mids_313,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_313 <-  DM_compare_313 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_313$bin)[gtools::mixedorder(levels(DM_compare_313$bin))]))

## ggplot
gg.313.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_313) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_313))), 
                              labels = levels(DM_compare_313$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("313 -  Colorado Plateau Semi-Desert",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +         
           theme_classic() + 
           # xlim(min(DM_compare_313$data.CI.low)-0.25, max(DM_compare_313$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_313$pred.CI.low)-0.25, max(DM_compare_313$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.313.B2

}   else {print("cannot plot observed vs. predicted")}
```

## 315 - Southwest Plateau and Plains Dry Steppe and Shrub
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_315 <- round(quantile(G_315$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_315)))){
  cutvec_315 <- round(quantile(G_315$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_315 <- unname(round(cutvec_315[-length(cutvec_315)] + diff(cutvec_315)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_315$STDAGE_t2_bin<-  cut(G_315$STDAGE_t2, cutvec_315)
## then get bin means
G_315_bin_means <- tapply(G_315$B_plt_t2_MgHa, cut(G_315$STDAGE_t2, cutvec_315), mean)

## make column weights.2
G_315$nls_weights.2 <- as.numeric(1/(G_315_bin_means[match(G_315$STDAGE_t2_bin, names(G_315_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_315.1 <- nls(f_1, data = G_315, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_315$nls_weights.2), 
 )

## phi
try(
  nls_315.2 <- nls(f_2, data=G_315, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_315$nls_weights.2), 
 )

# phi/alpha
try(
  nls_315.3 <- nls(f_3 , data = G_315, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_315$nls_weights.2), 
 )

## test
if(exists("nls_315.1") & exists("nls_315.2") & exists("nls_315.3")){
  print(anova(nls_315.1, nls_315.2, nls_315.3))
} else if(exists("nls_315.2") & exists("nls_315.3")){
  print(anova(nls_315.2, nls_315.3))
} else if(exists("nls_315.1") & exists("nls_315.2")){
  print(anova(nls_315.1, nls_315.2))
}
 
## AIC comparison
AIC1_315 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_315.1"), AIC(get("nls_315.1")), NA),
            ifelse(exists("nls_315.2"), AIC(get("nls_315.2")), NA),
            ifelse(exists("nls_315.3"), AIC(get("nls_315.3")), NA)
            ))

print(AIC1_315) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_315[!is.na(AIC1_315$AIC) & AIC1_315$AIC == min(AIC1_315$AIC, na.rm = T),]$model

try(summary(get(paste("nls_315.",  Mod.Sel1, sep =""))) ) #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_315.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_315.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_315.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_315.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_315.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_315.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_315.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_315.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_315.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_315,
         start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_315$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_315.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_315,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_315$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_315.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_315,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_315$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_315.", Mod.Sel1, sep ="")) &
     exists(paste("nls_315.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_315.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_315.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_315.", Mod.Sel1, sep ="")),
             get(paste("nls_315.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_315.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_315.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_315.", Mod.Sel1, sep ="")) &
         exists(paste("nls_315.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_315.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_315.", Mod.Sel1, sep ="")),
               get(paste("nls_315.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_315.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_315.", Mod.Sel1, sep ="")) &
           exists(paste("nls_315.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_315.", Mod.Sel1, sep ="")),
                 get(paste("nls_315.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_315.", Mod.Sel1, sep ="")) &
              exists(paste("nls_315.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_315.", Mod.Sel1, sep ="")),
                    get(paste("nls_315.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_315.", Mod.Sel1, sep ="")) &
                exists(paste("nls_315.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_315.", Mod.Sel1, sep ="")),
                      get(paste("nls_315.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_315 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_315.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_315.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_315.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_315.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_315.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_315.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_315.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_315.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_315)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_315[!is.na(AIC2_315$AIC) & AIC2_315$AIC == min(AIC2_315$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "315",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_315.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_315.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "315",]$ge.variance <- vcov(get(paste("nls_315.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "315",]$phi.variance <- vcov(get(paste("nls_315.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "315",]$alpha.variance <- vcov(get(paste("nls_315.",  Mod.Sel2, sep ="")))["alpha","alpha"]

nls.param.df_bal[nls.param.df_bal$Code == "315",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "315",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "315",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "315",]$A <- coefs["A"]
nls.param.df_bal[nls.param.df_bal$Code == "315",]$k <- coefs["k"]

nls.param.df_bal[nls.param.df_bal$Code == "315",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "315",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "315",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "315",]$A.2.5 <- intervals_low["A"]
nls.param.df_bal[nls.param.df_bal$Code == "315",]$k.2.5 <- intervals_low["k"]

nls.param.df_bal[nls.param.df_bal$Code == "315",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "315",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "315",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "315",]$A.97.5 <- intervals_high["A"]
nls.param.df_bal[nls.param.df_bal$Code == "315",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_315.",  Mod.Sel2, sep =""))) ) 

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_315.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_315.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_315.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_315$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_315.4 <- nls(f_4, data = G_315, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_315$nls_weights.2), 
 )

## phi
try(
  nls_315.5 <- nls(f_5, data=G_315, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_315$nls_weights.2), 
 )

# phi/alpha
try(
  nls_315.6 <- nls(f_6, data = G_315, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_315$nls_weights.2), 
 )

## test
if(exists("nls_315.4") & exists("nls_315.5") & exists("nls_315.6")){
  print(anova(nls_315.4, nls_315.5, nls_315.6))
} else if(exists("nls_315.4") & exists("nls_315.6")){
  print(anova(nls_315.4, nls_315.6))
} else if(exists("nls_315.5") & exists("nls_315.6")){
  print(anova(nls_315.5, nls_315.6))
} else if(exists("nls_315.4") & exists("nls_315.5")){
  print(anova(nls_315.4, nls_315.5))
}

## AIC comparison
AIC3_315 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_315[AIC2_315$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_315.4"), AIC(get("nls_315.4")), NA),
            ifelse(exists("nls_315.5"), AIC(get("nls_315.5")), NA),
            ifelse(exists("nls_315.6"), AIC(get("nls_315.6")), NA)
            ))

print(AIC3_315) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_315[!is.na(AIC3_315$AIC) & AIC3_315$AIC == min(AIC3_315$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "315",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_bal[Best_mods.P_bal$Code == "315",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_315.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_315.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "315",]$ge.variance <- vcov(get(paste("nls_315.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "315",]$phi.variance <- vcov(get(paste("nls_315.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "315",]$alpha.variance <- vcov(get(paste("nls_315.",  Mod.Sel3, sep ="")))["alpha","alpha"]

nls.param.df_bal[nls.param.df_bal$Code == "315",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "315",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "315",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "315",]$a <- coefs["a"]
nls.param.df_bal[nls.param.df_bal$Code == "315",]$b <- coefs["b"]
nls.param.df_bal[nls.param.df_bal$Code == "315",]$c <- coefs["c"]
nls.param.df_bal[nls.param.df_bal$Code == "315",]$d <- coefs["d"]

nls.param.df_bal[nls.param.df_bal$Code == "315",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "315",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "315",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "315",]$a.2.5 <- intervals_low["a"]
nls.param.df_bal[nls.param.df_bal$Code == "315",]$b.2.5 <- intervals_low["b"]
nls.param.df_bal[nls.param.df_bal$Code == "315",]$c.2.5 <- intervals_low["c"]
nls.param.df_bal[nls.param.df_bal$Code == "315",]$d.2.5 <- intervals_low["d"]

nls.param.df_bal[nls.param.df_bal$Code == "315",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "315",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "315",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "315",]$a.97.5 <- intervals_high["a"]
nls.param.df_bal[nls.param.df_bal$Code == "315",]$b.97.5 <- intervals_high["b"]
nls.param.df_bal[nls.param.df_bal$Code == "315",]$c.97.5 <- intervals_high["c"]
nls.param.df_bal[nls.param.df_bal$Code == "315",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_315.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_315.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_315.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_315.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_315 <- nlsResiduals(
  get(paste("nls_315.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_315)

## test residuals
if(length(G_315$pltID) < 5001) {test.nlsResiduals(resid_315)}

}  else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_315_pred <- predict(get(paste("nls_315.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_315$MEASTIME_t2, na.rm = T), max(G_315$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_315$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_315$MEASTIME_t2, na.rm = T), max(G_315$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_315$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_315$DeltaPDSI, na.rm = T), max(G_315$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_315$MEASTIME_t2, na.rm = T), max(G_315$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_315$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_315$B_L_prop, na.rm = T), max(G_315$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_315$DeltaPDSI, na.rm = T), max(G_315$STDAGE_t2)))
                      } )

G_315_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_315$STDAGE_t2),by = 1),  
                            "fitted"=G_315_pred)

## plot
gg.315 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_315, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_315, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_315))), breaks = cutvec_315) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_315_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_315_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("315 -  Southwest Plateau and Plains Dry Steppe and Shrub") + 
          
          #ylim(0, max(G_315_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_315,1)*1.05), expand = c(0,0))

gg.315

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_315 <- data.frame(
  bin = as.factor(levels(cut(G_315$STDAGE_t2, cutvec_315))),
  data.mean = tapply(G_315$B_plt_t2_MgHa, cut(G_315$STDAGE_t2, cutvec_315), 
                     mean), 
  data.CI.high =  tapply(G_315$B_plt_t2_MgHa, cut(G_315$STDAGE_t2, cutvec_315), 
                    high.CI), 
  data.CI.low = tapply(G_315$B_plt_t2_MgHa, cut(G_315$STDAGE_t2, cutvec_315),
                    low.CI), 
  pred.mean = G_315_pred_df[G_315_pred_df$STDAGE_t2 %in% bin_mids_315,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_315 <-  DM_compare_315 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_315$bin)[gtools::mixedorder(levels(DM_compare_315$bin))]))

## ggplot
gg.315.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_315) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_315))), 
                              labels = levels(DM_compare_315$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("315 -  Southwest Plateau and Plains Dry Steppe and Shrub",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +       
           theme_classic() + 
           # xlim(min(DM_compare_315$data.CI.low)-0.25, max(DM_compare_315$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_315$pred.CI.low)-0.25, max(DM_compare_315$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.315.B2

}   else {print("cannot plot observed vs. predicted")}
```

## 321 - Chihuahuan Semi-Desert
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_321 <- round(quantile(G_321$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_321)))){
  cutvec_321 <- round(quantile(G_321$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_321 <- unname(round(cutvec_321[-length(cutvec_321)] + diff(cutvec_321)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_321$STDAGE_t2_bin<-  cut(G_321$STDAGE_t2, cutvec_321)
## then get bin means
G_321_bin_means <- tapply(G_321$B_plt_t2_MgHa, cut(G_321$STDAGE_t2, cutvec_321), mean)

## make column weights.2
G_321$nls_weights.2 <- as.numeric(1/(G_321_bin_means[match(G_321$STDAGE_t2_bin, names(G_321_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_321.1 <- nls(f_1, data = G_321, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_321$nls_weights.2), 
 )

## phi
try(
  nls_321.2 <- nls(f_2, data=G_321, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_321$nls_weights.2), 
 )

# phi/alpha
try(
  nls_321.3 <- nls(f_3 , data = G_321, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_321$nls_weights.2), 
 )

## test
if(exists("nls_321.1") & exists("nls_321.2") & exists("nls_321.3")){
  print(anova(nls_321.1, nls_321.2, nls_321.3))
} else if(exists("nls_321.2") & exists("nls_321.3")){
  print(anova(nls_321.2, nls_321.3))
} else if(exists("nls_321.1") & exists("nls_321.2")){
  print(anova(nls_321.1, nls_321.2))
}
 
## AIC comparison
AIC1_321 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_321.1"), AIC(get("nls_321.1")), NA),
            ifelse(exists("nls_321.2"), AIC(get("nls_321.2")), NA),
            ifelse(exists("nls_321.3"), AIC(get("nls_321.3")), NA)
            ))

print(AIC1_321) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_321[!is.na(AIC1_321$AIC) & AIC1_321$AIC == min(AIC1_321$AIC, na.rm = T),]$model

try(summary(get(paste("nls_321.",  Mod.Sel1, sep =""))) ) #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_321.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_321.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_321.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_321.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_321.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_321.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_321.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_321.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_321.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_321,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_321$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_321.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_321,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_321$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_321.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_321,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_321$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_321.", Mod.Sel1, sep ="")) &
     exists(paste("nls_321.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_321.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_321.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_321.", Mod.Sel1, sep ="")),
             get(paste("nls_321.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_321.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_321.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_321.", Mod.Sel1, sep ="")) &
         exists(paste("nls_321.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_321.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_321.", Mod.Sel1, sep ="")),
               get(paste("nls_321.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_321.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_321.", Mod.Sel1, sep ="")) &
           exists(paste("nls_321.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_321.", Mod.Sel1, sep ="")),
                 get(paste("nls_321.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_321.", Mod.Sel1, sep ="")) &
              exists(paste("nls_321.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_321.", Mod.Sel1, sep ="")),
                    get(paste("nls_321.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_321.", Mod.Sel1, sep ="")) &
                exists(paste("nls_321.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_321.", Mod.Sel1, sep ="")),
                      get(paste("nls_321.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_321 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_321.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_321.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_321.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_321.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_321.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_321.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_321.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_321.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_321)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_321[!is.na(AIC2_321$AIC) & AIC2_321$AIC == min(AIC2_321$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "321",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_321.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_321.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "315",]$ge.variance <- vcov(get(paste("nls_315.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "315",]$phi.variance <- vcov(get(paste("nls_315.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "315",]$alpha.variance <- vcov(get(paste("nls_315.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "321",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "321",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "321",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "321",]$A <- coefs["A"]
nls.param.df_bal[nls.param.df_bal$Code == "321",]$k <- coefs["k"]

nls.param.df_bal[nls.param.df_bal$Code == "321",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "321",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "321",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "321",]$A.2.5 <- intervals_low["A"]
nls.param.df_bal[nls.param.df_bal$Code == "321",]$k.2.5 <- intervals_low["k"]

nls.param.df_bal[nls.param.df_bal$Code == "321",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "321",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "321",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "321",]$A.97.5 <- intervals_high["A"]
nls.param.df_bal[nls.param.df_bal$Code == "321",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_321.",  Mod.Sel2, sep =""))) ) 

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_321.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_321.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_321.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_321$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_321.4 <- nls(f_4, data = G_321, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_321$nls_weights.2), 
 )

## phi
try(
  nls_321.5 <- nls(f_5, data=G_321, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_321$nls_weights.2), 
 )

# phi/alpha
try(
  nls_321.6 <- nls(f_6, data = G_321, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_321$nls_weights.2), 
 )

## test
if(exists("nls_321.4") & exists("nls_321.5") & exists("nls_321.6")){
  print(anova(nls_321.4, nls_321.5, nls_321.6))
} else if(exists("nls_321.4") & exists("nls_321.6")){
  print(anova(nls_321.4, nls_321.6))
} else if(exists("nls_321.5") & exists("nls_321.6")){
  print(anova(nls_321.5, nls_321.6))
} else if(exists("nls_321.4") & exists("nls_321.5")){
  print(anova(nls_321.4, nls_321.5))
}

## AIC comparison
AIC3_321 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_321[AIC2_321$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_321.4"), AIC(get("nls_321.4")), NA),
            ifelse(exists("nls_321.5"), AIC(get("nls_321.5")), NA),
            ifelse(exists("nls_321.6"), AIC(get("nls_321.6")), NA)
            ))

print(AIC3_321) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_321[!is.na(AIC3_321$AIC) & AIC3_321$AIC == min(AIC3_321$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "321",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_bal[Best_mods.P_bal$Code == "321",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_321.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_321.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "321",]$ge.variance <- vcov(get(paste("nls_321.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "321",]$phi.variance <- vcov(get(paste("nls_321.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "321",]$alpha.variance <- vcov(get(paste("nls_321.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "321",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "321",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "321",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "321",]$a <- coefs["a"]
nls.param.df_bal[nls.param.df_bal$Code == "321",]$b <- coefs["b"]
nls.param.df_bal[nls.param.df_bal$Code == "321",]$c <- coefs["c"]
nls.param.df_bal[nls.param.df_bal$Code == "321",]$d <- coefs["d"]

nls.param.df_bal[nls.param.df_bal$Code == "321",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "321",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "321",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "321",]$a.2.5 <- intervals_low["a"]
nls.param.df_bal[nls.param.df_bal$Code == "321",]$b.2.5 <- intervals_low["b"]
nls.param.df_bal[nls.param.df_bal$Code == "321",]$c.2.5 <- intervals_low["c"]
nls.param.df_bal[nls.param.df_bal$Code == "321",]$d.2.5 <- intervals_low["d"]

nls.param.df_bal[nls.param.df_bal$Code == "321",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "321",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "321",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "321",]$a.97.5 <- intervals_high["a"]
nls.param.df_bal[nls.param.df_bal$Code == "321",]$b.97.5 <- intervals_high["b"]
nls.param.df_bal[nls.param.df_bal$Code == "321",]$c.97.5 <- intervals_high["c"]
nls.param.df_bal[nls.param.df_bal$Code == "321",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_321.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_321.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_321.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_321.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_321 <- nlsResiduals(
  get(paste("nls_321.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_321)

## test residuals
if(length(G_321$pltID) < 5001) {test.nlsResiduals(resid_321)}

}  else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_321_pred <- predict(get(paste("nls_321.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_321$MEASTIME_t2, na.rm = T), max(G_321$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_321$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_321$MEASTIME_t2, na.rm = T), max(G_321$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_321$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_321$DeltaPDSI, na.rm = T), max(G_321$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_321$MEASTIME_t2, na.rm = T), max(G_321$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_321$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_321$B_L_prop, na.rm = T), max(G_321$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_321$DeltaPDSI, na.rm = T), max(G_321$STDAGE_t2)))
                      } )

G_321_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_321$STDAGE_t2),by = 1),  
                            "fitted"=G_321_pred)

## plot
gg.321 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_321, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_321, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_321))), breaks = cutvec_321) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_321_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_321_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("321 - Chihuahuan Semi-Desert") + 
          
          #ylim(0, max(G_321_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_321,1)*1.05), expand = c(0,0))

gg.321

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_321 <- data.frame(
  bin = as.factor(levels(cut(G_321$STDAGE_t2, cutvec_321))),
  data.mean = tapply(G_321$B_plt_t2_MgHa, cut(G_321$STDAGE_t2, cutvec_321), 
                     mean), 
  data.CI.high =  tapply(G_321$B_plt_t2_MgHa, cut(G_321$STDAGE_t2, cutvec_321), 
                    high.CI), 
  data.CI.low = tapply(G_321$B_plt_t2_MgHa, cut(G_321$STDAGE_t2, cutvec_321),
                    low.CI), 
  pred.mean = G_321_pred_df[G_321_pred_df$STDAGE_t2 %in% bin_mids_321,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_321 <-  DM_compare_321 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_321$bin)[gtools::mixedorder(levels(DM_compare_321$bin))]))

## ggplot
gg.321.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_321) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_321))), 
                              labels = levels(DM_compare_321$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("321 - Chihuahuan Semi-Desert",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +         
           theme_classic() + 
           # xlim(min(DM_compare_321$data.CI.low)-0.25, max(DM_compare_321$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_321$pred.CI.low)-0.25, max(DM_compare_321$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.321.B2

}   else {print("cannot plot observed vs. predicted")}
```

## 322 - American Semidesert and Desert
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_322 <- round(quantile(G_322$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_322)))){
  cutvec_322 <- round(quantile(G_322$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_322 <- unname(round(cutvec_322[-length(cutvec_322)] + diff(cutvec_322)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_322$STDAGE_t2_bin<-  cut(G_322$STDAGE_t2, cutvec_322)
## then get bin means
G_322_bin_means <- tapply(G_322$B_plt_t2_MgHa, cut(G_322$STDAGE_t2, cutvec_322), mean)

## make column weights.2
G_322$nls_weights.2 <- as.numeric(1/(G_322_bin_means[match(G_322$STDAGE_t2_bin, names(G_322_bin_means))])^2)

}
```

### model selection 1

```{r}
# simple
try(
  nls_322.1 <- nls(f_1, data = G_322, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_322$nls_weights.2), 
 )

## phi
try(
  nls_322.2 <- nls(f_2, data=G_322, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_322$nls_weights.2), 
 )

# phi/alpha
try(
  nls_322.3 <- nls(f_3 , data = G_322, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_322$nls_weights.2), 
 )

## test
if(exists("nls_322.1") & exists("nls_322.2") & exists("nls_322.3")){
  print(anova(nls_322.1, nls_322.2, nls_322.3))
} else if(exists("nls_322.2") & exists("nls_322.3")){
  print(anova(nls_322.2, nls_322.3))
} else if(exists("nls_322.1") & exists("nls_322.2")){
  print(anova(nls_322.1, nls_322.2))
}
 
## AIC comparison
AIC1_322 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_322.1"), AIC(get("nls_322.1")), NA),
            ifelse(exists("nls_322.2"), AIC(get("nls_322.2")), NA),
            ifelse(exists("nls_322.3"), AIC(get("nls_322.3")), NA)
            ))

print(AIC1_322) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_322[!is.na(AIC1_322$AIC) & AIC1_322$AIC == min(AIC1_322$AIC, na.rm = T),]$model

try(summary(get(paste("nls_322.",  Mod.Sel1, sep =""))) ) #model summary
```
#### summary 
* simple model: `r ifelse(exists("nls_322.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_322.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_322.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_322.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_322.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_322.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_322.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_322.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_322.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_322,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_322$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_322.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_322,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_322$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_322.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_322,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_322$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_322.", Mod.Sel1, sep ="")) &
     exists(paste("nls_322.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_322.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_322.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_322.", Mod.Sel1, sep ="")),
             get(paste("nls_322.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_322.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_322.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_322.", Mod.Sel1, sep ="")) &
         exists(paste("nls_322.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_322.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_322.", Mod.Sel1, sep ="")),
               get(paste("nls_322.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_322.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_322.", Mod.Sel1, sep ="")) &
           exists(paste("nls_322.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_322.", Mod.Sel1, sep ="")),
                 get(paste("nls_322.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_322.", Mod.Sel1, sep ="")) &
              exists(paste("nls_322.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_322.", Mod.Sel1, sep ="")),
                    get(paste("nls_322.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_322.", Mod.Sel1, sep ="")) &
                exists(paste("nls_322.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_322.", Mod.Sel1, sep ="")),
                      get(paste("nls_322.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_322 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_322.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_322.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_322.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_322.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_322.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_322.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_322.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_322.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_322)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_322[!is.na(AIC2_322$AIC) & AIC2_322$AIC == min(AIC2_322$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "322",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_322.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_322.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "322",]$ge.variance <- vcov(get(paste("nls_322.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "322",]$phi.variance <- vcov(get(paste("nls_322.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "322",]$alpha.variance <- vcov(get(paste("nls_322.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "322",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "322",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "322",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "322",]$A <- coefs["A"]
nls.param.df_bal[nls.param.df_bal$Code == "322",]$k <- coefs["k"]

nls.param.df_bal[nls.param.df_bal$Code == "322",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "322",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "322",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "322",]$A.2.5 <- intervals_low["A"]
nls.param.df_bal[nls.param.df_bal$Code == "322",]$k.2.5 <- intervals_low["k"]

nls.param.df_bal[nls.param.df_bal$Code == "322",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "322",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "322",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "322",]$A.97.5 <- intervals_high["A"]
nls.param.df_bal[nls.param.df_bal$Code == "322",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_322.",  Mod.Sel2, sep =""))) ) 

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_322.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_322.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_322.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_322$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_322.4 <- nls(f_4, data = G_322, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_322$nls_weights.2), 
 )

## phi
try(
  nls_322.5 <- nls(f_5, data=G_322, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_322$nls_weights.2), 
 )

# phi/alpha
try(
  nls_322.6 <- nls(f_6, data = G_322, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_322$nls_weights.2), 
 )

## test
if(exists("nls_322.4") & exists("nls_322.5") & exists("nls_322.6")){
  print(anova(nls_322.4, nls_322.5, nls_322.6))
} else if(exists("nls_322.4") & exists("nls_322.6")){
  print(anova(nls_322.4, nls_322.6))
} else if(exists("nls_322.5") & exists("nls_322.6")){
  print(anova(nls_322.5, nls_322.6))
} else if(exists("nls_322.4") & exists("nls_322.5")){
  print(anova(nls_322.4, nls_322.5))
}

## AIC comparison
AIC3_322 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_322[AIC2_322$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_322.4"), AIC(get("nls_322.4")), NA),
            ifelse(exists("nls_322.5"), AIC(get("nls_322.5")), NA),
            ifelse(exists("nls_322.6"), AIC(get("nls_322.6")), NA)
            ))

print(AIC3_322) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_322[!is.na(AIC3_322$AIC) & AIC3_322$AIC == min(AIC3_322$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "322",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_bal[Best_mods.P_bal$Code == "322",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_322.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_322.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "322",]$ge.variance <- vcov(get(paste("nls_322.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "322",]$phi.variance <- vcov(get(paste("nls_322.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "322",]$alpha.variance <- vcov(get(paste("nls_322.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "322",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "322",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "322",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "322",]$a <- coefs["a"]
nls.param.df_bal[nls.param.df_bal$Code == "322",]$b <- coefs["b"]
nls.param.df_bal[nls.param.df_bal$Code == "322",]$c <- coefs["c"]
nls.param.df_bal[nls.param.df_bal$Code == "322",]$d <- coefs["d"]

nls.param.df_bal[nls.param.df_bal$Code == "322",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "322",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "322",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "322",]$a.2.5 <- intervals_low["a"]
nls.param.df_bal[nls.param.df_bal$Code == "322",]$b.2.5 <- intervals_low["b"]
nls.param.df_bal[nls.param.df_bal$Code == "322",]$c.2.5 <- intervals_low["c"]
nls.param.df_bal[nls.param.df_bal$Code == "322",]$d.2.5 <- intervals_low["d"]

nls.param.df_bal[nls.param.df_bal$Code == "322",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "322",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "322",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "322",]$a.97.5 <- intervals_high["a"]
nls.param.df_bal[nls.param.df_bal$Code == "322",]$b.97.5 <- intervals_high["b"]
nls.param.df_bal[nls.param.df_bal$Code == "322",]$c.97.5 <- intervals_high["c"]
nls.param.df_bal[nls.param.df_bal$Code == "322",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_322.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_322.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_321.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_321.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_322 <- nlsResiduals(
  get(paste("nls_322.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_322)

## test residuals
if(length(G_322$pltID) < 5001) {test.nlsResiduals(resid_322)}

}  else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_322_pred <- predict(get(paste("nls_322.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_322$MEASTIME_t2, na.rm = T), max(G_322$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_322$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_322$MEASTIME_t2, na.rm = T), max(G_322$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_322$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_322$DeltaPDSI, na.rm = T), max(G_322$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_322$MEASTIME_t2, na.rm = T), max(G_322$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_322$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_322$B_L_prop, na.rm = T), max(G_322$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_322$DeltaPDSI, na.rm = T), max(G_322$STDAGE_t2)))
                      } )

G_322_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_322$STDAGE_t2),by = 1),  
                            "fitted"=G_322_pred)

## plot
gg.322 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_322, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_322, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_332))), breaks = cutvec_322) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_322_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_322_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("322 - American Semidesert and Desert") + 
          
          #ylim(0, max(G_322_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_322,1)*1.05), expand = c(0,0))

gg.322

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_322 <- data.frame(
  bin = as.factor(levels(cut(G_322$STDAGE_t2, cutvec_322))),
  data.mean = tapply(G_322$B_plt_t2_MgHa, cut(G_322$STDAGE_t2, cutvec_322), 
                     mean), 
  data.CI.high =  tapply(G_322$B_plt_t2_MgHa, cut(G_322$STDAGE_t2, cutvec_322), 
                    high.CI), 
  data.CI.low = tapply(G_322$B_plt_t2_MgHa, cut(G_322$STDAGE_t2, cutvec_322),
                    low.CI), 
  pred.mean = G_322_pred_df[G_322_pred_df$STDAGE_t2 %in% bin_mids_322,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_322 <-  DM_compare_322 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_322$bin)[gtools::mixedorder(levels(DM_compare_322$bin))]))

## ggplot
gg.322.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_322) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_322))), 
                              labels = levels(DM_compare_322$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("322 - American Semidesert and Desert",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +         
           theme_classic() + 
           # xlim(min(DM_compare_322$data.CI.low)-0.25, max(DM_compare_322$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_322$pred.CI.low)-0.25, max(DM_compare_322$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.322.B2

}    else {print("cannot plot observed vs. predicted")}
```

* Cannot fit model 
* not enough data (only 3 observations)

## 331 - Great Plains/Palouse Dry Steppe
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_331 <- round(quantile(G_331$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_331)))){
  cutvec_331 <- round(quantile(G_331$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_331 <- unname(round(cutvec_331[-length(cutvec_331)] + diff(cutvec_331)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_331$STDAGE_t2_bin<-  cut(G_331$STDAGE_t2, cutvec_331)
## then get bin means
G_331_bin_means <- tapply(G_331$B_plt_t2_MgHa, cut(G_331$STDAGE_t2, cutvec_331), mean)

## make column weights.2
G_331$nls_weights.2 <- as.numeric(1/(G_331_bin_means[match(G_331$STDAGE_t2_bin, names(G_331_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_331.1 <- nls(f_1, data = G_331, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_331$nls_weights.2), 
 )

## phi
try(
  nls_331.2 <- nls(f_2, data=G_331, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_331$nls_weights.2), 
 )

# phi/alpha
try(
  nls_331.3 <- nls(f_3 , data = G_331, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_331$nls_weights.2), 
 )

## test
if(exists("nls_331.1") & exists("nls_331.2") & exists("nls_331.3")){
  print(anova(nls_331.1, nls_331.2, nls_331.3))
} else if(exists("nls_331.2") & exists("nls_331.3")){
  print(anova(nls_331.2, nls_331.3))
} else if(exists("nls_331.1") & exists("nls_331.2")){
  print(anova(nls_331.1, nls_331.2))
}
 
## AIC comparison
AIC1_331 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_331.1"), AIC(get("nls_331.1")), NA),
            ifelse(exists("nls_331.2"), AIC(get("nls_331.2")), NA),
            ifelse(exists("nls_331.3"), AIC(get("nls_331.3")), NA)
            ))

print(AIC1_331) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_331[!is.na(AIC1_331$AIC) & AIC1_331$AIC == min(AIC1_331$AIC, na.rm = T),]$model

try(summary(get(paste("nls_331.",  Mod.Sel1, sep =""))) ) #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_331.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_331.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_331.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
#ge.fit <- round(coef(get(paste("nls_331.",  Mod.Sel1, sep ="")))["ge"], 1)
ge.fit <-  -0.2
phi.fit <- round(coef(get(paste("nls_331.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_331.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_331.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_331.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_331.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_331,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 

          weights = G_331$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_331.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_331,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_331$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_331.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_331,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_331$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_331.", Mod.Sel1, sep ="")) &
     exists(paste("nls_331.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_331.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_331.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_331.", Mod.Sel1, sep ="")),
             get(paste("nls_331.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_331.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_331.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_331.", Mod.Sel1, sep ="")) &
         exists(paste("nls_331.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_331.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_331.", Mod.Sel1, sep ="")),
               get(paste("nls_331.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_331.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_331.", Mod.Sel1, sep ="")) &
           exists(paste("nls_331.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_331.", Mod.Sel1, sep ="")),
                 get(paste("nls_331.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_331.", Mod.Sel1, sep ="")) &
              exists(paste("nls_331.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_331.", Mod.Sel1, sep ="")),
                    get(paste("nls_331.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_331.", Mod.Sel1, sep ="")) &
                exists(paste("nls_331.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_331.", Mod.Sel1, sep ="")),
                      get(paste("nls_331.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_331 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_331.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_331.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_331.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_331.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_331.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_331.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_331.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_331.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_331)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_331[!is.na(AIC2_331$AIC) & AIC2_331$AIC == min(AIC2_331$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "331",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_331.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_331.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "331",]$ge.variance <- vcov(get(paste("nls_331.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "331",]$phi.variance <- vcov(get(paste("nls_331.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "331",]$alpha.variance <- vcov(get(paste("nls_331.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "331",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "331",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "331",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "331",]$A <- coefs["A"]
nls.param.df_bal[nls.param.df_bal$Code == "331",]$k <- coefs["k"]

nls.param.df_bal[nls.param.df_bal$Code == "331",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "331",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "331",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "331",]$A.2.5 <- intervals_low["A"]
nls.param.df_bal[nls.param.df_bal$Code == "331",]$k.2.5 <- intervals_low["k"]

nls.param.df_bal[nls.param.df_bal$Code == "331",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "331",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "331",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "331",]$A.97.5 <- intervals_high["A"]
nls.param.df_bal[nls.param.df_bal$Code == "331",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_331.",  Mod.Sel2, sep =""))) ) 

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_331.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_331.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_331.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_331$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_331.4 <- nls(f_4, data = G_331, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_331$nls_weights.2), 
 )

## phi
try(
  nls_331.5 <- nls(f_5, data=G_331, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_331$nls_weights.2), 
 )

# phi/alpha
try(
  nls_331.6 <- nls(f_6, data = G_331, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_331$nls_weights.2), 
 )

## test
if(exists("nls_331.4") & exists("nls_331.5") & exists("nls_331.6")){
  print(anova(nls_331.4, nls_331.5, nls_331.6))
} else if(exists("nls_331.4") & exists("nls_331.6")){
  print(anova(nls_331.4, nls_331.6))
} else if(exists("nls_331.5") & exists("nls_331.6")){
  print(anova(nls_331.5, nls_331.6))
} else if(exists("nls_331.4") & exists("nls_331.5")){
  print(anova(nls_331.4, nls_331.5))
}

## AIC comparison
AIC3_331 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_331[AIC2_331$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_331.4"), AIC(get("nls_331.4")), NA),
            ifelse(exists("nls_331.5"), AIC(get("nls_331.5")), NA),
            ifelse(exists("nls_331.6"), AIC(get("nls_331.6")), NA)
            ))

print(AIC3_331) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_331[!is.na(AIC3_331$AIC) & AIC3_331$AIC == min(AIC3_331$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "331",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_bal[Best_mods.P_bal$Code == "331",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_331.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_331.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "331",]$ge.variance <- vcov(get(paste("nls_331.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "331",]$phi.variance <- vcov(get(paste("nls_331.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "331",]$alpha.variance <- vcov(get(paste("nls_331.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "331",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "331",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "331",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "331",]$a <- coefs["a"]
nls.param.df_bal[nls.param.df_bal$Code == "331",]$b <- coefs["b"]
nls.param.df_bal[nls.param.df_bal$Code == "331",]$c <- coefs["c"]
nls.param.df_bal[nls.param.df_bal$Code == "331",]$d <- coefs["d"]

nls.param.df_bal[nls.param.df_bal$Code == "331",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "331",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "331",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "331",]$a.2.5 <- intervals_low["a"]
nls.param.df_bal[nls.param.df_bal$Code == "331",]$b.2.5 <- intervals_low["b"]
nls.param.df_bal[nls.param.df_bal$Code == "331",]$c.2.5 <- intervals_low["c"]
nls.param.df_bal[nls.param.df_bal$Code == "331",]$d.2.5 <- intervals_low["d"]

nls.param.df_bal[nls.param.df_bal$Code == "331",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "331",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "331",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "331",]$a.97.5 <- intervals_high["a"]
nls.param.df_bal[nls.param.df_bal$Code == "331",]$b.97.5 <- intervals_high["b"]
nls.param.df_bal[nls.param.df_bal$Code == "331",]$c.97.5 <- intervals_high["c"]
nls.param.df_bal[nls.param.df_bal$Code == "331",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_331.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_331.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_331.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_331.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_331 <- nlsResiduals(
  get(paste("nls_331.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_331)

## test residuals
if(length(G_331$pltID) < 5001) {test.nlsResiduals(resid_331)}

}  else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_331_pred <- predict(get(paste("nls_331.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_331$MEASTIME_t2, na.rm = T), max(G_331$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_331$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_331$MEASTIME_t2, na.rm = T), max(G_331$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_331$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_331$DeltaPDSI, na.rm = T), max(G_331$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_331$MEASTIME_t2, na.rm = T), max(G_331$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_331$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_331$B_L_prop, na.rm = T), max(G_331$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_331$DeltaPDSI, na.rm = T), max(G_331$STDAGE_t2)))
                      } )

G_331_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_331$STDAGE_t2),by = 1),  
                            "fitted"=G_331_pred)

## plot
gg.331 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_331, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_331, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_331))), breaks = cutvec_331) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_331_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_331_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("331 - Great Plains/Palouse Dry Steppe") + 
          
          #ylim(0, max(G_331_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_331,1)*1.05), expand = c(0,0))

gg.331

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_331 <- data.frame(
  bin = as.factor(levels(cut(G_331$STDAGE_t2, cutvec_331))),
  data.mean = tapply(G_331$B_plt_t2_MgHa, cut(G_331$STDAGE_t2, cutvec_331), 
                     mean), 
  data.CI.high =  tapply(G_331$B_plt_t2_MgHa, cut(G_331$STDAGE_t2, cutvec_331), 
                    high.CI), 
  data.CI.low = tapply(G_331$B_plt_t2_MgHa, cut(G_331$STDAGE_t2, cutvec_331),
                    low.CI), 
  pred.mean = G_331_pred_df[G_331_pred_df$STDAGE_t2 %in% bin_mids_331,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_331 <-  DM_compare_331 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_331$bin)[gtools::mixedorder(levels(DM_compare_331$bin))]))

## ggplot
gg.331.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_331) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_331))), 
                              labels = levels(DM_compare_331$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("331 - Great Plains/Palouse Dry Steppe",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +         
           theme_classic() + 
           # xlim(min(DM_compare_331$data.CI.low)-0.25, max(DM_compare_331$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_331$pred.CI.low)-0.25, max(DM_compare_331$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.331.B2

}    else {print("cannot plot observed vs. predicted")}
```
* Cannot fit model 

## 332 - Great Plains Steppe
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_332 <- round(quantile(G_332$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_332)))){
  cutvec_332 <- round(quantile(G_332$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_332 <- unname(round(cutvec_332[-length(cutvec_332)] + diff(cutvec_332)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_332$STDAGE_t2_bin<-  cut(G_332$STDAGE_t2, cutvec_332)
## then get bin means
G_332_bin_means <- tapply(G_332$B_plt_t2_MgHa, cut(G_332$STDAGE_t2,  cutvec_332), mean)

## make column weights.2
G_332$nls_weights.2 <- as.numeric(1/(G_332_bin_means[match(G_332$STDAGE_t2_bin, names(G_332_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_332.1 <- nls(f_1, data = G_332, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_332$nls_weights.2), 
 )

## phi
try(
  nls_332.2 <- nls(f_2, data=G_332, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_332$nls_weights.2), 
 )

# phi/alpha
try(
  nls_332.3 <- nls(f_3 , data = G_332, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_332$nls_weights.2), 
 )

## test
if(exists("nls_332.1") & exists("nls_332.2") & exists("nls_332.3")){
  print(anova(nls_332.1, nls_332.2, nls_332.3))
} else if(exists("nls_332.2") & exists("nls_332.3")){
  print(anova(nls_332.2, nls_332.3))
} else if(exists("nls_332.1") & exists("nls_332.2")){
  print(anova(nls_332.1, nls_332.2))
}
 
## AIC comparison
AIC1_332 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_332.1"), AIC(get("nls_332.1")), NA),
            ifelse(exists("nls_332.2"), AIC(get("nls_332.2")), NA),
            ifelse(exists("nls_332.3"), AIC(get("nls_332.3")), NA)
            ))

print(AIC1_332) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_332[!is.na(AIC1_332$AIC) & AIC1_332$AIC == min(AIC1_332$AIC, na.rm = T),]$model

try(summary(get(paste("nls_332.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_332.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_332.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_332.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_332.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_332.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_332.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_332.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_332.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_332.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_332,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_332$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_332.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_332,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_332$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_332.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_332,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_332$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_332.", Mod.Sel1, sep ="")) &
     exists(paste("nls_332.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_332.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_332.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_332.", Mod.Sel1, sep ="")),
             get(paste("nls_332.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_332.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_332.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_332.", Mod.Sel1, sep ="")) &
         exists(paste("nls_332.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_332.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_332.", Mod.Sel1, sep ="")),
               get(paste("nls_332.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_332.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_332.", Mod.Sel1, sep ="")) &
           exists(paste("nls_332.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_332.", Mod.Sel1, sep ="")),
                 get(paste("nls_332.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_332.", Mod.Sel1, sep ="")) &
              exists(paste("nls_332.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_332.", Mod.Sel1, sep ="")),
                    get(paste("nls_332.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_332.", Mod.Sel1, sep ="")) &
                exists(paste("nls_332.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_332.", Mod.Sel1, sep ="")),
                      get(paste("nls_332.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_332 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_332.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_332.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_332.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_332.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_332.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_332.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_332.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_332.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_332)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_332[!is.na(AIC2_332$AIC) & AIC2_332$AIC == min(AIC2_332$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "332",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_332.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_332.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "332",]$ge.variance <- vcov(get(paste("nls_332.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "332",]$phi.variance <- vcov(get(paste("nls_332.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "332",]$alpha.variance <- vcov(get(paste("nls_332.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "332",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "332",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "332",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "332",]$A <- coefs["A"]
nls.param.df_bal[nls.param.df_bal$Code == "332",]$k <- coefs["k"]

nls.param.df_bal[nls.param.df_bal$Code == "332",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "332",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "332",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "332",]$A.2.5 <- intervals_low["A"]
nls.param.df_bal[nls.param.df_bal$Code == "332",]$k.2.5 <- intervals_low["k"]

nls.param.df_bal[nls.param.df_bal$Code == "332",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "332",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "332",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "332",]$A.97.5 <- intervals_high["A"]
nls.param.df_bal[nls.param.df_bal$Code == "332",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_332.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_332.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_332.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_332.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_332$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_332.4 <- nls(f_4, data = G_332, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_332$nls_weights.2), 
 )

## phi
try(
  nls_332.5 <- nls(f_5, data=G_332, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_332$nls_weights.2), 
 )

# phi/alpha
try(
  nls_332.6 <- nls(f_6, data = G_332, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_332$nls_weights.2), 
 )

## test
if(exists("nls_332.4") & exists("nls_332.5") & exists("nls_332.6")){
  print(anova(nls_332.4, nls_332.5, nls_332.6))
} else if(exists("nls_332.4") & exists("nls_332.6")){
  print(anova(nls_332.4, nls_332.6))
} else if(exists("nls_332.5") & exists("nls_332.6")){
  print(anova(nls_332.5, nls_332.6))
} else if(exists("nls_332.4") & exists("nls_332.5")){
  print(anova(nls_332.4, nls_332.5))
}

## AIC comparison
AIC3_332 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_332[AIC2_332$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_332.4"), AIC(get("nls_332.4")), NA),
            ifelse(exists("nls_332.5"), AIC(get("nls_332.5")), NA),
            ifelse(exists("nls_332.6"), AIC(get("nls_332.6")), NA)
            ))

print(AIC3_332) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_332[!is.na(AIC3_332$AIC) & AIC3_332$AIC == min(AIC3_332$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "332",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_bal[Best_mods.P_bal$Code == "332",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_332.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_332.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "332",]$ge.variance <- vcov(get(paste("nls_332.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "332",]$phi.variance <- vcov(get(paste("nls_332.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "332",]$alpha.variance <- vcov(get(paste("nls_332.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "332",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "332",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "332",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "332",]$a <- coefs["a"]
nls.param.df_bal[nls.param.df_bal$Code == "332",]$b <- coefs["b"]
nls.param.df_bal[nls.param.df_bal$Code == "332",]$c <- coefs["c"]
nls.param.df_bal[nls.param.df_bal$Code == "332",]$d <- coefs["d"]

nls.param.df_bal[nls.param.df_bal$Code == "332",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "332",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "332",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "332",]$a.2.5 <- intervals_low["a"]
nls.param.df_bal[nls.param.df_bal$Code == "332",]$b.2.5 <- intervals_low["b"]
nls.param.df_bal[nls.param.df_bal$Code == "332",]$c.2.5 <- intervals_low["c"]
nls.param.df_bal[nls.param.df_bal$Code == "332",]$d.2.5 <- intervals_low["d"]

nls.param.df_bal[nls.param.df_bal$Code == "332",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "332",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "332",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "332",]$a.97.5 <- intervals_high["a"]
nls.param.df_bal[nls.param.df_bal$Code == "332",]$b.97.5 <- intervals_high["b"]
nls.param.df_bal[nls.param.df_bal$Code == "332",]$c.97.5 <- intervals_high["c"]
nls.param.df_bal[nls.param.df_bal$Code == "332",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_332.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_332.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_332.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_332.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_332 <- nlsResiduals(
  get(paste("nls_332.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_332)

## test residuals
if(length(G_332$pltID) < 5001) {test.nlsResiduals(resid_332)}

}  else {print("cannot plot residuals")}
```


### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_332_pred <- predict(get(paste("nls_332.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_332$MEASTIME_t2, na.rm = T), max(G_332$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_332$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_332$MEASTIME_t2, na.rm = T), max(G_332$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_332$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_332$DeltaPDSI, na.rm = T), max(G_332$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_332$MEASTIME_t2, na.rm = T), max(G_332$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_332$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_332$B_L_prop, na.rm = T), max(G_332$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_332$DeltaPDSI, na.rm = T), max(G_332$STDAGE_t2)))
                      } )

G_332_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_332$STDAGE_t2),by = 1),  
                            "fitted"=G_332_pred)

## plot
gg.332 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_332, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_332, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_332))), breaks = cutvec_332) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_332_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_332_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("332 - Southwest Plateau and Plains Dry Steppe and Shrub") + 
          
          #ylim(0, max(G_332_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_332,1)*1.05), expand = c(0,0))

gg.332

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_332 <- data.frame(
  bin = as.factor(levels(cut(G_332$STDAGE_t2, cutvec_332))),
  data.mean = tapply(G_332$B_plt_t2_MgHa, cut(G_332$STDAGE_t2, cutvec_332), 
                     mean), 
  data.CI.high =  tapply(G_332$B_plt_t2_MgHa, cut(G_332$STDAGE_t2, cutvec_332), 
                    high.CI), 
  data.CI.low = tapply(G_332$B_plt_t2_MgHa, cut(G_332$STDAGE_t2, cutvec_332),
                    low.CI), 
  pred.mean = G_332_pred_df[G_332_pred_df$STDAGE_t2 %in% bin_mids_332,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_332 <-  DM_compare_332 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_332$bin)[gtools::mixedorder(levels(DM_compare_332$bin))]))

## ggplot
gg.332.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_332) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_332))), 
                              labels = levels(DM_compare_332$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("332 - Southwest Plateau and Plains Dry Steppe and Shrub",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +        
           theme_classic() + 
           # xlim(min(DM_compare_332$data.CI.low)-0.25, max(DM_compare_332$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_332$pred.CI.low)-0.25, max(DM_compare_332$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.332.B2

}    else {print("cannot plot observed vs. predicted")}
```

## 341 - Nevada-Utah Mountains Semi-Desert - Coniferous Forest - Alpine Meadow
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_341 <- round(quantile(G_341$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_341)))){
  cutvec_341 <- round(quantile(G_341$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_341 <- unname(round(cutvec_341[-length(cutvec_341)] + diff(cutvec_341)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_341$STDAGE_t2_bin<-  cut(G_341$STDAGE_t2, cutvec_341)
## then get bin means
G_341_bin_means <- tapply(G_341$B_plt_t2_MgHa, cut(G_341$STDAGE_t2,  cutvec_341), mean)

## make column weights.2
G_341$nls_weights.2 <- as.numeric(1/(G_341_bin_means[match(G_341$STDAGE_t2_bin, names(G_341_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_341.1 <- nls(f_1, data = G_341, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_341$nls_weights.2), 
 )

## phi
try(
  nls_341.2 <- nls(f_2, data=G_341, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_341$nls_weights.2), 
 )

# phi/alpha
try(
  nls_341.3 <- nls(f_3 , data = G_341, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_341$nls_weights.2), 
 )

## test
if(exists("nls_341.1") & exists("nls_341.2") & exists("nls_341.3")){
  print(anova(nls_341.1, nls_341.2, nls_341.3))
} else if(exists("nls_341.2") & exists("nls_341.3")){
  print(anova(nls_341.2, nls_341.3))
} else if(exists("nls_341.1") & exists("nls_341.2")){
  print(anova(nls_341.1, nls_341.2))
}
 
## AIC comparison
AIC1_341 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_341.1"), AIC(get("nls_341.1")), NA),
            ifelse(exists("nls_341.2"), AIC(get("nls_341.2")), NA),
            ifelse(exists("nls_341.3"), AIC(get("nls_341.3")), NA)
            ))

print(AIC1_341) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_341[!is.na(AIC1_341$AIC) & AIC1_341$AIC == min(AIC1_341$AIC, na.rm = T),]$model

try(summary(get(paste("nls_341.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_341.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_341.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_341.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_341.",  Mod.Sel1, sep ="")))["ge"], 1)
#phi.fit <- round(coef(get(paste("nls_341.",  Mod.Sel1, sep ="")))["phi"], 1)
#alpha.fit <- round(coef(get(paste("nls_341.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_341.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_341.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_341.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_341,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_341$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_341.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_341,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_341$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_341.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_341,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_341$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_341.", Mod.Sel1, sep ="")) &
     exists(paste("nls_341.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_341.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_341.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_341.", Mod.Sel1, sep ="")),
             get(paste("nls_341.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_341.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_341.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_341.", Mod.Sel1, sep ="")) &
         exists(paste("nls_341.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_341.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_341.", Mod.Sel1, sep ="")),
               get(paste("nls_341.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_341.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_341.", Mod.Sel1, sep ="")) &
           exists(paste("nls_341.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_341.", Mod.Sel1, sep ="")),
                 get(paste("nls_341.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_341.", Mod.Sel1, sep ="")) &
              exists(paste("nls_341.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_341.", Mod.Sel1, sep ="")),
                    get(paste("nls_341.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_341.", Mod.Sel1, sep ="")) &
                exists(paste("nls_341.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_341.", Mod.Sel1, sep ="")),
                      get(paste("nls_341.", Mod.Sel1, "b", sep =""))
                      ))
              }              
                
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_341 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_341.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_341.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_341.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_341.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_341.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_341.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_341.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_341.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_341)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_341[!is.na(AIC2_341$AIC) & AIC2_341$AIC == min(AIC2_341$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "341",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_341.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_341.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "341",]$ge.variance <- vcov(get(paste("nls_341.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "341",]$phi.variance <- vcov(get(paste("nls_341.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "341",]$alpha.variance <- vcov(get(paste("nls_341.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "341",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "341",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "341",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "341",]$A <- coefs["A"]
nls.param.df_bal[nls.param.df_bal$Code == "341",]$k <- coefs["k"]

nls.param.df_bal[nls.param.df_bal$Code == "341",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "341",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "341",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "341",]$A.2.5 <- intervals_low["A"]
nls.param.df_bal[nls.param.df_bal$Code == "341",]$k.2.5 <- intervals_low["k"]

nls.param.df_bal[nls.param.df_bal$Code == "341",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "341",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "341",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "341",]$A.97.5 <- intervals_high["A"]
nls.param.df_bal[nls.param.df_bal$Code == "341",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_341.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_341.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_341.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_341.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_341$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_341.4 <- nls(f_4, data = G_341, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_341$nls_weights.2), 
 )

## phi
try(
  nls_341.5 <- nls(f_5, data=G_341, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_341$nls_weights.2), 
 )

# phi/alpha
try(
  nls_341.6 <- nls(f_6, data = G_341, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_341$nls_weights.2), 
 )

## test
if(exists("nls_341.4") & exists("nls_341.5") & exists("nls_341.6")){
  print(anova(nls_341.4, nls_341.5, nls_341.6))
} else if(exists("nls_341.4") & exists("nls_341.6")){
  print(anova(nls_341.4, nls_341.6))
} else if(exists("nls_341.5") & exists("nls_341.6")){
  print(anova(nls_341.5, nls_341.6))
} else if(exists("nls_341.4") & exists("nls_341.5")){
  print(anova(nls_341.4, nls_341.5))
}

## AIC comparison
AIC3_341 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_341[AIC2_341$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_341.4"), AIC(get("nls_341.4")), NA),
            ifelse(exists("nls_341.5"), AIC(get("nls_341.5")), NA),
            ifelse(exists("nls_341.6"), AIC(get("nls_341.6")), NA)
            ))

print(AIC3_341) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_341[!is.na(AIC3_341$AIC) & AIC3_341$AIC == min(AIC3_341$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "341",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_bal[Best_mods.P_bal$Code == "341",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_341.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_341.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "341",]$ge.variance <- vcov(get(paste("nls_341.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "341",]$phi.variance <- vcov(get(paste("nls_341.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "341",]$alpha.variance <- vcov(get(paste("nls_341.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "341",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "341",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "341",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "341",]$a <- coefs["a"]
nls.param.df_bal[nls.param.df_bal$Code == "341",]$b <- coefs["b"]
nls.param.df_bal[nls.param.df_bal$Code == "341",]$c <- coefs["c"]
nls.param.df_bal[nls.param.df_bal$Code == "341",]$d <- coefs["d"]

nls.param.df_bal[nls.param.df_bal$Code == "341",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "341",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "341",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "341",]$a.2.5 <- intervals_low["a"]
nls.param.df_bal[nls.param.df_bal$Code == "341",]$b.2.5 <- intervals_low["b"]
nls.param.df_bal[nls.param.df_bal$Code == "341",]$c.2.5 <- intervals_low["c"]
nls.param.df_bal[nls.param.df_bal$Code == "341",]$d.2.5 <- intervals_low["d"]

nls.param.df_bal[nls.param.df_bal$Code == "341",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "341",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "341",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "341",]$a.97.5 <- intervals_high["a"]
nls.param.df_bal[nls.param.df_bal$Code == "341",]$b.97.5 <- intervals_high["b"]
nls.param.df_bal[nls.param.df_bal$Code == "341",]$c.97.5 <- intervals_high["c"]
nls.param.df_bal[nls.param.df_bal$Code == "341",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_341.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_341.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_341.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_341.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_341 <- nlsResiduals(
  get(paste("nls_341.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_341)

## test residuals
if(length(G_341$pltID) < 5001) {test.nlsResiduals(resid_341)}

}  else {print("cannot plot residuals")}
```

* model not fitted because only 62 observations

### predict and plot 

```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & fit.models == T) {

## predict model fit
G_341_pred <- predict(get(paste("nls_341.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_341$MEASTIME_t2, na.rm = T), max(G_341$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_341$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_341$MEASTIME_t2, na.rm = T), max(G_341$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_341$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_341$DeltaPDSI, na.rm = T), max(G_341$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_341$MEASTIME_t2, na.rm = T), max(G_341$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_341$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_341$B_L_prop, na.rm = T), max(G_341$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_341$DeltaPDSI, na.rm = T), max(G_341$STDAGE_t2)))
                      } )

G_341_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_341$STDAGE_t2),by = 1),
                            "fitted"=G_341_pred)

## plot
gg.341 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_341, alpha = 0.5, shape ="+", col = "#60606080") +

          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_341,
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res},
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_341))), breaks = cutvec_341) +

          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`),
                      #data = G_341_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +

          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_341_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) +


          theme_classic() +
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"),
               x = "Stand Age (yrs)") +  ggtitle("341 - Nevada-Utah Mountains Semi-Desert - Coniferous Forest - Alpine Meadow") +

          #ylim(0, max(G_341_pred_df$`Prop.97.5%` + 0.25)) +
          scale_x_continuous(limits = c(0, max(G_341$STDAGE_t2)), expand = c(0,0))

gg.341

}    else {print("cannot plot data with prediction")}
```

### plotting 2

```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & fit.models == T) {

## data wrangling:
DM_compare_341 <- data.frame(
  bin = as.factor(levels(cut(G_341$STDAGE_t2, cutvec_341))),
  data.mean = tapply(G_341$B_plt_t2_MgHa, cut(G_341$STDAGE_t2, cutvec_341),
                     mean),
  data.CI.high =  tapply(G_341$B_plt_t2_MgHa, cut(G_341$STDAGE_t2, cutvec_341),
                    high.CI),
  data.CI.low = tapply(G_341$B_plt_t2_MgHa, cut(G_341$STDAGE_t2, cutvec_341),
                    low.CI),
  pred.mean = G_341_pred_df[G_341_pred_df$STDAGE_t2 %in% bin_mids_341,]$fitted)

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY
DM_compare_341 <-  DM_compare_341 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_341$bin)[gtools::mixedorder(levels(DM_compare_341$bin))]))

## ggplot
gg.341.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_341) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_341))),
                              labels = levels(DM_compare_341$bin),
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +
           labs(x = expression("observed biomass (Mg ha"^-1*")"),
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("341 - Nevada-Utah Mountains Semi-Desert - Coniferous Forest - Alpine Meadow",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +
           theme_classic() +
           # xlim(min(DM_compare_341$data.CI.low)-0.25, max(DM_compare_341$data.CI.high)+0.25) +
           # ylim(min(DM_compare_341$pred.CI.low)-0.25, max(DM_compare_341$pred.CI.high)+0.25) +
           theme(legend.position = "top") + tune::coord_obs_pred()

gg.341.B2

}   else {print("cannot plot observed vs. predicted")}
```

## 342 - Intermountain Semi-Desert
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_342 <- round(quantile(G_342$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_342)))){
  cutvec_342 <- round(quantile(G_342$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_342 <- unname(round(cutvec_342[-length(cutvec_342)] + diff(cutvec_342)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_342$STDAGE_t2_bin<-  cut(G_342$STDAGE_t2, cutvec_342)
## then get bin means
G_342_bin_means <- tapply(G_342$B_plt_t2_MgHa, cut(G_342$STDAGE_t2,  cutvec_342), mean)

## make column weights.2
G_342$nls_weights.2 <- as.numeric(1/(G_342_bin_means[match(G_342$STDAGE_t2_bin, names(G_342_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_342.1 <- nls(f_1, data = G_342, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_342$nls_weights.2), 
 )

## phi
try(
  nls_342.2 <- nls(f_2, data=G_342, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_342$nls_weights.2), 
 )

# phi/alpha
try(
  nls_342.3 <- nls(f_3 , data = G_342, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_342$nls_weights.2), 
 )

## test
if(exists("nls_342.1") & exists("nls_342.2") & exists("nls_342.3")){
  print(anova(nls_342.1, nls_342.2, nls_342.3))
} else if(exists("nls_342.2") & exists("nls_342.3")){
  print(anova(nls_342.2, nls_342.3))
} else if(exists("nls_342.1") & exists("nls_342.2")){
  print(anova(nls_342.1, nls_342.2))
}
 
## AIC comparison
AIC1_342 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_342.1"), AIC(get("nls_342.1")), NA),
            ifelse(exists("nls_342.2"), AIC(get("nls_342.2")), NA),
            ifelse(exists("nls_342.3"), AIC(get("nls_342.3")), NA)
            ))

print(AIC1_342) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_342[!is.na(AIC1_342$AIC) &AIC1_342$AIC == min(AIC1_342$AIC, na.rm = T),]$model

try(summary(get(paste("nls_342.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_342.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_342.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_342.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_342.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_342.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_342.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_342.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_342.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_342.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_342,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_342$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_342.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_342,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_342$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_342.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_342,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_342$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_342.", Mod.Sel1, sep ="")) &
     exists(paste("nls_342.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_342.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_342.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_342.", Mod.Sel1, sep ="")),
             get(paste("nls_342.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_342.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_342.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_342.", Mod.Sel1, sep ="")) &
         exists(paste("nls_342.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_342.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_342.", Mod.Sel1, sep ="")),
               get(paste("nls_342.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_342.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_342.", Mod.Sel1, sep ="")) &
           exists(paste("nls_342.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_342.", Mod.Sel1, sep ="")),
                 get(paste("nls_342.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_342.", Mod.Sel1, sep ="")) &
              exists(paste("nls_342.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_342.", Mod.Sel1, sep ="")),
                    get(paste("nls_342.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_342.", Mod.Sel1, sep ="")) &
                exists(paste("nls_342.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_342.", Mod.Sel1, sep ="")),
                      get(paste("nls_342.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_342 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_342.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_342.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_342.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_342.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_342.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_342.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_342.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_342.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_342)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_342[!is.na(AIC2_342$AIC) & AIC2_342$AIC == min(AIC2_342$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "342",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_342.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_342.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "342",]$ge.variance <- vcov(get(paste("nls_342.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "342",]$phi.variance <- vcov(get(paste("nls_342.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "342",]$alpha.variance <- vcov(get(paste("nls_342.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "342",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "342",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "342",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "342",]$A <- coefs["A"]
nls.param.df_bal[nls.param.df_bal$Code == "342",]$k <- coefs["k"]

nls.param.df_bal[nls.param.df_bal$Code == "342",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "342",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "342",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "342",]$A.2.5 <- intervals_low["A"]
nls.param.df_bal[nls.param.df_bal$Code == "342",]$k.2.5 <- intervals_low["k"]

nls.param.df_bal[nls.param.df_bal$Code == "342",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "342",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "342",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "342",]$A.97.5 <- intervals_high["A"]
nls.param.df_bal[nls.param.df_bal$Code == "342",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_342.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_342.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_342.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_342.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_342$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_342.4 <- nls(f_4, data = G_342, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_342$nls_weights.2), 
 )

## phi
try(
  nls_342.5 <- nls(f_5, data=G_342, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_342$nls_weights.2), 
 )

# phi/alpha
try(
  nls_342.6 <- nls(f_6, data = G_342, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_342$nls_weights.2), 
 )

## test
if(exists("nls_342.4") & exists("nls_342.5") & exists("nls_342.6")){
  print(anova(nls_342.4, nls_342.5, nls_342.6))
} else if(exists("nls_342.4") & exists("nls_342.6")){
  print(anova(nls_342.4, nls_342.6))
} else if(exists("nls_342.5") & exists("nls_342.6")){
  print(anova(nls_342.5, nls_342.6))
} else if(exists("nls_342.4") & exists("nls_342.5")){
  print(anova(nls_342.4, nls_342.5))
}

## AIC comparison
AIC3_342 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_342[AIC2_342$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_342.4"), AIC(get("nls_342.4")), NA),
            ifelse(exists("nls_342.5"), AIC(get("nls_342.5")), NA),
            ifelse(exists("nls_342.6"), AIC(get("nls_342.6")), NA)
            ))

print(AIC3_342) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_342[!is.na(AIC3_342$AIC) & AIC3_342$AIC == min(AIC3_342$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "342",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_bal[Best_mods.P_bal$Code == "342",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_342.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_342.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "342",]$ge.variance <- vcov(get(paste("nls_342.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "342",]$phi.variance <- vcov(get(paste("nls_342.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "342",]$alpha.variance <- vcov(get(paste("nls_342.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "342",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "342",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "342",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "342",]$a <- coefs["a"]
nls.param.df_bal[nls.param.df_bal$Code == "342",]$b <- coefs["b"]
nls.param.df_bal[nls.param.df_bal$Code == "342",]$c <- coefs["c"]
nls.param.df_bal[nls.param.df_bal$Code == "342",]$d <- coefs["d"]

nls.param.df_bal[nls.param.df_bal$Code == "342",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "342",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "342",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "342",]$a.2.5 <- intervals_low["a"]
nls.param.df_bal[nls.param.df_bal$Code == "342",]$b.2.5 <- intervals_low["b"]
nls.param.df_bal[nls.param.df_bal$Code == "342",]$c.2.5 <- intervals_low["c"]
nls.param.df_bal[nls.param.df_bal$Code == "342",]$d.2.5 <- intervals_low["d"]

nls.param.df_bal[nls.param.df_bal$Code == "342",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "342",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "342",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "342",]$a.97.5 <- intervals_high["a"]
nls.param.df_bal[nls.param.df_bal$Code == "342",]$b.97.5 <- intervals_high["b"]
nls.param.df_bal[nls.param.df_bal$Code == "342",]$c.97.5 <- intervals_high["c"]
nls.param.df_bal[nls.param.df_bal$Code == "342",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_342.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_342.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_342.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_342.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_342 <- nlsResiduals(
  get(paste("nls_342.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_342)

## test residuals
if(length(G_342$pltID) < 5001) {test.nlsResiduals(resid_342)}

}   else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_342_pred <- predict(get(paste("nls_342.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_342$MEASTIME_t2, na.rm = T), max(G_342$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_342$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_342$MEASTIME_t2, na.rm = T), max(G_342$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_342$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_342$DeltaPDSI, na.rm = T), max(G_342$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_342$MEASTIME_t2, na.rm = T), max(G_342$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_342$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_342$B_L_prop, na.rm = T), max(G_342$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_342$DeltaPDSI, na.rm = T), max(G_342$STDAGE_t2)))
                      } )

G_342_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_342$STDAGE_t2),by = 1),  
                            "fitted"=G_342_pred)

## plot
gg.342 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_342, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_342, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_342)-1)), breaks = cutvec_342) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_342_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_342_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("342 - Intermountain Semi-Desert") + 
          
          #ylim(0, max(G_342_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_342,1)*1.05), expand = c(0,0))

gg.342

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_342 <- data.frame(
  bin = as.factor(levels(cut(G_342$STDAGE_t2, cutvec_342))),
  data.mean = tapply(G_342$B_plt_t2_MgHa, cut(G_342$STDAGE_t2, cutvec_342), 
                     mean), 
  data.CI.high =  tapply(G_342$B_plt_t2_MgHa, cut(G_342$STDAGE_t2, cutvec_342), 
                    high.CI), 
  data.CI.low = tapply(G_342$B_plt_t2_MgHa, cut(G_342$STDAGE_t2, cutvec_342),
                    low.CI), 
  pred.mean = G_342_pred_df[G_342_pred_df$STDAGE_t2 %in% bin_mids_342,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_342 <-  DM_compare_342 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_342$bin)[gtools::mixedorder(levels(DM_compare_342$bin))]))

## ggplot
gg.342.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_342) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_342))), 
                              labels = levels(DM_compare_342$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("342 - Northeastern Mixed Forest",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +        
           theme_classic() + 
           # xlim(min(DM_compare_342$data.CI.low)-0.25, max(DM_compare_342$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_342$pred.CI.low)-0.25, max(DM_compare_342$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.342.B2

}   else {print("cannot plot observed vs. predicted")}
```

## 411 - Everglades
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_411 <- round(quantile(G_411$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_411)))){
  cutvec_411 <- round(quantile(G_411$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_411 <- unname(round(cutvec_411[-length(cutvec_411)] + diff(cutvec_411)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_411$STDAGE_t2_bin<-  cut(G_411$STDAGE_t2, cutvec_411)
## then get bin means
G_411_bin_means <- tapply(G_411$B_plt_t2_MgHa, cut(G_411$STDAGE_t2,  cutvec_411), mean)

## make column weights.2
G_411$nls_weights.2 <- as.numeric(1/(G_411_bin_means[match(G_411$STDAGE_t2_bin, names(G_411_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_411.1 <- nls(f_1, data = G_411, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_411$nls_weights.2), 
 )

## phi
try(
  nls_411.2 <- nls(f_2, data=G_411, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_411$nls_weights.2), 
 )

# phi/alpha
try(
  nls_411.3 <- nls(f_3 , data = G_411, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_411$nls_weights.2), 
 )

## test
if(exists("nls_411.1") & exists("nls_411.2") & exists("nls_411.3")){
  print(anova(nls_411.1, nls_411.2, nls_411.3))
} else if(exists("nls_411.2") & exists("nls_411.3")){
  print(anova(nls_411.2, nls_411.3))
} else if(exists("nls_411.1") & exists("nls_411.2")){
  print(anova(nls_411.1, nls_411.2))
}
 
## AIC comparison
AIC1_411 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_411.1"), AIC(get("nls_411.1")), NA),
            ifelse(exists("nls_411.2"), AIC(get("nls_411.2")), NA),
            ifelse(exists("nls_411.3"), AIC(get("nls_411.3")), NA)
            ))

print(AIC1_411) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_411[!is.na(AIC1_411$AIC) & AIC1_411$AIC == min(AIC1_411$AIC, na.rm = T),]$model

try(summary(get(paste("nls_411.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_411.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_411.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_411.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_411.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_411.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_411.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_411.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_411.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_411.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_411,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 

          weights = G_411$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_411.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_411,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_411$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_411.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_411,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_411$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_411.", Mod.Sel1, sep ="")) &
     exists(paste("nls_411.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_411.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_411.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_411.", Mod.Sel1, sep ="")),
             get(paste("nls_411.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_411.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_411.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_411.", Mod.Sel1, sep ="")) &
         exists(paste("nls_411.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_411.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_411.", Mod.Sel1, sep ="")),
               get(paste("nls_411.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_411.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_411.", Mod.Sel1, sep ="")) &
           exists(paste("nls_411.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_411.", Mod.Sel1, sep ="")),
                 get(paste("nls_411.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_411.", Mod.Sel1, sep ="")) &
              exists(paste("nls_411.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_411.", Mod.Sel1, sep ="")),
                    get(paste("nls_411.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_411.", Mod.Sel1, sep ="")) &
                exists(paste("nls_411.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_411.", Mod.Sel1, sep ="")),
                      get(paste("nls_411.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_411 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_411.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_411.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_411.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_411.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_411.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_411.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_411.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_411.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_411)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_411[!is.na(AIC2_411$AIC) & AIC2_411$AIC == min(AIC2_411$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "411",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_411.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_411.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "411",]$ge.variance <- vcov(get(paste("nls_411.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "411",]$phi.variance <- vcov(get(paste("nls_411.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "411",]$alpha.variance <- vcov(get(paste("nls_411.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "411",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "411",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "411",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "411",]$A <- coefs["A"]
nls.param.df_bal[nls.param.df_bal$Code == "411",]$k <- coefs["k"]

nls.param.df_bal[nls.param.df_bal$Code == "411",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "411",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "411",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "411",]$A.2.5 <- intervals_low["A"]
nls.param.df_bal[nls.param.df_bal$Code == "411",]$k.2.5 <- intervals_low["k"]

nls.param.df_bal[nls.param.df_bal$Code == "411",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "411",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "411",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "411",]$A.97.5 <- intervals_high["A"]
nls.param.df_bal[nls.param.df_bal$Code == "411",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_411.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_411.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_411.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_411.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_411$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_411.4 <- nls(f_4, data = G_411, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_411$nls_weights.2), 
 )

## phi
try(
  nls_411.5 <- nls(f_5, data=G_411, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_411$nls_weights.2), 
 )

# phi/alpha
try(
  nls_411.6 <- nls(f_6, data = G_411, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_411$nls_weights.2), 
 )

## test
if(exists("nls_411.4") & exists("nls_411.5") & exists("nls_411.6")){
  print(anova(nls_411.4, nls_411.5, nls_411.6))
} else if(exists("nls_411.4") & exists("nls_411.6")){
  print(anova(nls_411.4, nls_411.6))
} else if(exists("nls_411.5") & exists("nls_411.6")){
  print(anova(nls_411.5, nls_411.6))
} else if(exists("nls_411.4") & exists("nls_411.5")){
  print(anova(nls_411.4, nls_411.5))
}

## AIC comparison
AIC3_411 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_411[AIC2_411$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_411.4"), AIC(get("nls_411.4")), NA),
            ifelse(exists("nls_411.5"), AIC(get("nls_411.5")), NA),
            ifelse(exists("nls_411.6"), AIC(get("nls_411.6")), NA)
            ))

print(AIC3_411) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_411[!is.na(AIC3_411$AIC) & AIC3_411$AIC == min(AIC3_411$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "411",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_bal[Best_mods.P_bal$Code == "411",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_411.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_411.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "411",]$ge.variance <- vcov(get(paste("nls_411.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "411",]$phi.variance <- vcov(get(paste("nls_411.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "411",]$alpha.variance <- vcov(get(paste("nls_411.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "411",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "411",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "411",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "411",]$a <- coefs["a"]
nls.param.df_bal[nls.param.df_bal$Code == "411",]$b <- coefs["b"]
nls.param.df_bal[nls.param.df_bal$Code == "411",]$c <- coefs["c"]
nls.param.df_bal[nls.param.df_bal$Code == "411",]$d <- coefs["d"]

nls.param.df_bal[nls.param.df_bal$Code == "411",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "411",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "411",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "411",]$a.2.5 <- intervals_low["a"]
nls.param.df_bal[nls.param.df_bal$Code == "411",]$b.2.5 <- intervals_low["b"]
nls.param.df_bal[nls.param.df_bal$Code == "411",]$c.2.5 <- intervals_low["c"]
nls.param.df_bal[nls.param.df_bal$Code == "411",]$d.2.5 <- intervals_low["d"]

nls.param.df_bal[nls.param.df_bal$Code == "411",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "411",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "411",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "411",]$a.97.5 <- intervals_high["a"]
nls.param.df_bal[nls.param.df_bal$Code == "411",]$b.97.5 <- intervals_high["b"]
nls.param.df_bal[nls.param.df_bal$Code == "411",]$c.97.5 <- intervals_high["c"]
nls.param.df_bal[nls.param.df_bal$Code == "411",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_411.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_411.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_411.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_411.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_411 <- nlsResiduals(
  get(paste("nls_411.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_411)

## test residuals
if(length(G_411$pltID) < 5001) {test.nlsResiduals(resid_411)}

}   else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## predict model fit
G_411_pred <- predict(get(paste("nls_411.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_411$MEASTIME_t2, na.rm = T), max(G_411$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_411$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_411$MEASTIME_t2, na.rm = T), max(G_411$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_411$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_411$DeltaPDSI, na.rm = T), max(G_411$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_411$MEASTIME_t2, na.rm = T), max(G_411$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_411$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_411$B_L_prop, na.rm = T), max(G_411$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_411$DeltaPDSI, na.rm = T), max(G_411$STDAGE_t2)))
                      } )

G_411_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_411$STDAGE_t2),by = 1),
                            "fitted" =G_411_pred)

## plot
gg.411 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_411, alpha = 0.5, shape ="+", col = "#60606080") +

          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_411,
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res},
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_411))), breaks = cutvec_411) +

          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`),
                      #data = G_411_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +

          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_411_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) +


          theme_classic() +
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"),
               x = "Stand Age (yrs)") +  ggtitle("411 - Intermountain Semi-Desert") +

          #ylim(0, max(G_411_pred_df$`Prop.97.5%` + 0.25)) +
          scale_x_continuous(limits = c(0, max(G_411$STDAGE_t2)), expand = c(0,0))

gg.411

}  else {print("cannot plot data with prediction")}
```

### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_411 <- data.frame(
  bin = as.factor(levels(cut(G_411$STDAGE_t2, cutvec_411))),
  data.mean = tapply(G_411$B_plt_t2_MgHa, cut(G_411$STDAGE_t2, cutvec_411),
                     mean),
  data.CI.high =  tapply(G_411$B_plt_t2_MgHa, cut(G_411$STDAGE_t2, cutvec_411),
                    high.CI),
  data.CI.low = tapply(G_411$B_plt_t2_MgHa, cut(G_411$STDAGE_t2, cutvec_411),
                    low.CI),
  pred.mean = G_411_pred_df[G_411_pred_df$STDAGE_t2 %in% bin_mids_411,]$fitted)

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY
DM_compare_411 <-  DM_compare_411 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_411$bin)[gtools::mixedorder(levels(DM_compare_411$bin))]))

## ggplot
gg.411.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_411) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_411))),
                              labels = levels(DM_compare_411$bin),
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +
           labs(x = expression("observed biomass (Mg ha"^-1*")"),
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("411 -  Everglades",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +
           theme_classic() +
           # xlim(min(DM_compare_411$data.CI.low)-0.25, max(DM_compare_411$data.CI.high)+0.25) +
           # ylim(min(DM_compare_411$pred.CI.low)-0.25, max(DM_compare_411$pred.CI.high)+0.25) +
           theme(legend.position = "top") + tune::coord_obs_pred()

gg.411.B2

}   else {print("cannot plot observed vs. predicted")}
```

## M211 - Adirondack-New England Mixed forest - Coniferous Forest - Alpine Meadow
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_M211 <- round(quantile(G_M211$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M211)))){
  cutvec_M211 <- round(quantile(G_M211$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_M211 <- unname(round(cutvec_M211[-length(cutvec_M211)] + diff(cutvec_M211)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_M211$STDAGE_t2_bin<-  cut(G_M211$STDAGE_t2, cutvec_M211)
## then get bin means
G_M211_bin_means <- tapply(G_M211$B_plt_t2_MgHa, cut(G_M211$STDAGE_t2,  cutvec_M211), mean)

## make column weights.2
G_M211$nls_weights.2 <- as.numeric(1/(G_M211_bin_means[match(G_M211$STDAGE_t2_bin, names(G_M211_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_M211.1 <- nls(f_1, data = G_M211, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_M211$nls_weights.2), 
 )

## phi
try(
  nls_M211.2 <- nls(f_2, data=G_M211, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_M211$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M211.3 <- nls(f_3 , data = G_M211, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_M211$nls_weights.2), 
 )

## test
if(exists("nls_M211.1") & exists("nls_M211.2") & exists("nls_M211.3")){
  print(anova(nls_M211.1, nls_M211.2, nls_M211.3))
} else if(exists("nls_M211.2") & exists("nls_M211.3")){
  print(anova(nls_M211.2, nls_M211.3))
} else if(exists("nls_M211.1") & exists("nls_M211.2")){
  print(anova(nls_M211.1, nls_M211.2))
}
 
## AIC comparison
AIC1_M211 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_M211.1"), AIC(get("nls_M211.1")), NA),
            ifelse(exists("nls_M211.2"), AIC(get("nls_M211.2")), NA),
            ifelse(exists("nls_M211.3"), AIC(get("nls_M211.3")), NA)
            ))

print(AIC1_M211) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M211[!is.na(AIC1_M211$AIC) & AIC1_M211$AIC == min(AIC1_M211$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M211.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_M211.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M211.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_M211.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M211.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M211.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_M211.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_M211.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M211.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M211.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_M211,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_M211$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M211.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_M211,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_M211$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_M211.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_M211,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_M211$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M211.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M211.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M211.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M211.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M211.", Mod.Sel1, sep ="")),
             get(paste("nls_M211.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M211.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M211.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M211.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M211.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M211.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M211.", Mod.Sel1, sep ="")),
               get(paste("nls_M211.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M211.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M211.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M211.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M211.", Mod.Sel1, sep ="")),
                 get(paste("nls_M211.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M211.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M211.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M211.", Mod.Sel1, sep ="")),
                    get(paste("nls_M211.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M211.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M211.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M211.", Mod.Sel1, sep ="")),
                      get(paste("nls_M211.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M211 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M211.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M211.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M211.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M211.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M211.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M211.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M211.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M211.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M211)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M211[!is.na(AIC2_M211$AIC) & AIC2_M211$AIC == min(AIC2_M211$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "M211",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M211.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M211.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "M211",]$ge.variance <- vcov(get(paste("nls_M211.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "M211",]$phi.variance <- vcov(get(paste("nls_M211.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "M211",]$alpha.variance <- vcov(get(paste("nls_M211.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "M211",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M211",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M211",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M211",]$A <- coefs["A"]
nls.param.df_bal[nls.param.df_bal$Code == "M211",]$k <- coefs["k"]

nls.param.df_bal[nls.param.df_bal$Code == "M211",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M211",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M211",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M211",]$A.2.5 <- intervals_low["A"]
nls.param.df_bal[nls.param.df_bal$Code == "M211",]$k.2.5 <- intervals_low["k"]

nls.param.df_bal[nls.param.df_bal$Code == "M211",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M211",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M211",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M211",]$A.97.5 <- intervals_high["A"]
nls.param.df_bal[nls.param.df_bal$Code == "M211",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M211.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M211.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M211.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M211.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_M211$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_M211.4 <- nls(f_4, data = G_M211, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M211$nls_weights.2), 
 )

## phi
try(
  nls_M211.5 <- nls(f_5, data=G_M211, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M211$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M211.6 <- nls(f_6, data = G_M211, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M211$nls_weights.2), 
 )

## test
if(exists("nls_M211.4") & exists("nls_M211.5") & exists("nls_M211.6")){
  print(anova(nls_M211.4, nls_M211.5, nls_M211.6))
} else if(exists("nls_M211.4") & exists("nls_M211.6")){
  print(anova(nls_M211.4, nls_M211.6))
} else if(exists("nls_M211.5") & exists("nls_M211.6")){
  print(anova(nls_M211.5, nls_M211.6))
} else if(exists("nls_M211.4") & exists("nls_M211.5")){
  print(anova(nls_M211.4, nls_M211.5))
}

## AIC comparison
AIC3_M211 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_M211[AIC2_M211$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_M211.4"), AIC(get("nls_M211.4")), NA),
            ifelse(exists("nls_M211.5"), AIC(get("nls_M211.5")), NA),
            ifelse(exists("nls_M211.6"), AIC(get("nls_M211.6")), NA)
            ))

print(AIC3_M211) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_M211[!is.na(AIC3_M211$AIC) & AIC3_M211$AIC == min(AIC3_M211$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "M211",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_bal[Best_mods.P_bal$Code == "M211",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_M211.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M211.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "M211",]$ge.variance <- vcov(get(paste("nls_M211.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "M211",]$phi.variance <- vcov(get(paste("nls_M211.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "M211",]$alpha.variance <- vcov(get(paste("nls_M211.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "M211",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M211",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M211",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M211",]$a <- coefs["a"]
nls.param.df_bal[nls.param.df_bal$Code == "M211",]$b <- coefs["b"]
nls.param.df_bal[nls.param.df_bal$Code == "M211",]$c <- coefs["c"]
nls.param.df_bal[nls.param.df_bal$Code == "M211",]$d <- coefs["d"]

nls.param.df_bal[nls.param.df_bal$Code == "M211",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M211",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M211",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M211",]$a.2.5 <- intervals_low["a"]
nls.param.df_bal[nls.param.df_bal$Code == "M211",]$b.2.5 <- intervals_low["b"]
nls.param.df_bal[nls.param.df_bal$Code == "M211",]$c.2.5 <- intervals_low["c"]
nls.param.df_bal[nls.param.df_bal$Code == "M211",]$d.2.5 <- intervals_low["d"]

nls.param.df_bal[nls.param.df_bal$Code == "M211",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M211",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M211",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M211",]$a.97.5 <- intervals_high["a"]
nls.param.df_bal[nls.param.df_bal$Code == "M211",]$b.97.5 <- intervals_high["b"]
nls.param.df_bal[nls.param.df_bal$Code == "M211",]$c.97.5 <- intervals_high["c"]
nls.param.df_bal[nls.param.df_bal$Code == "M211",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_M211.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_M211.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_M211.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_M211.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_M211 <- nlsResiduals(
  get(paste("nls_M211.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_M211)

## test residuals
if(length(G_M211$pltID) < 5001) {test.nlsResiduals(resid_M211)}

}   else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_M211_pred <- predict(get(paste("nls_M211.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M211$MEASTIME_t2, na.rm = T), max(G_M211$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M211$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M211$MEASTIME_t2, na.rm = T), max(G_M211$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M211$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_M211$DeltaPDSI, na.rm = T), max(G_M211$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M211$MEASTIME_t2, na.rm = T), max(G_M211$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M211$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_M211$B_L_prop, na.rm = T), max(G_M211$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_M211$DeltaPDSI, na.rm = T), max(G_M211$STDAGE_t2)))
                      } )

G_M211_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_M211$STDAGE_t2),by = 1),  
                            "fitted"=G_M211_pred)

## plot
gg.M211 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M211, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M211, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M211))), breaks = cutvec_M211) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_M211_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_M211_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("M211 -  Adirondack-New England Mixed forest - Coniferous Forest - Alpine Meadow") + 
          
          #ylim(0, max(G_M211_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_M211,1)*1.05), expand = c(0,0))

gg.M211

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_M211 <- data.frame(
  bin = as.factor(levels(cut(G_M211$STDAGE_t2, cutvec_M211))),
  data.mean = tapply(G_M211$B_plt_t2_MgHa, cut(G_M211$STDAGE_t2, cutvec_M211), 
                     mean), 
  data.CI.high =  tapply(G_M211$B_plt_t2_MgHa, cut(G_M211$STDAGE_t2, cutvec_M211), 
                    high.CI), 
  data.CI.low = tapply(G_M211$B_plt_t2_MgHa, cut(G_M211$STDAGE_t2, cutvec_M211),
                    low.CI), 
  pred.mean = G_M211_pred_df[G_M211_pred_df$STDAGE_t2 %in% bin_mids_M211,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M211 <-  DM_compare_M211 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M211$bin)[gtools::mixedorder(levels(DM_compare_M211$bin))]))

## ggplot
gg.M211.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M211) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M211))), 
                              labels = levels(DM_compare_M211$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("M211 - Adirondack-New England Mixed forest - Coniferous Forest - Alpine Meadow",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +       
           theme_classic() + 
           # xlim(min(DM_compare_M211$data.CI.low)-0.25, max(DM_compare_M211$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_M211$pred.CI.low)-0.25, max(DM_compare_M211$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M211.B2

}   else {print("cannot plot observed vs. predicted")}
```

## M221 - Eastern Broadleaf Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_M221 <- round(quantile(G_M221$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M221)))){
  cutvec_M221 <- round(quantile(G_M221$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_M221 <- unname(round(cutvec_M221[-length(cutvec_M221)] + diff(cutvec_M221)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_M221$STDAGE_t2_bin<-  cut(G_M221$STDAGE_t2, cutvec_M221)
## then get bin means
G_M221_bin_means <- tapply(G_M221$B_plt_t2_MgHa, cut(G_M221$STDAGE_t2,  cutvec_M221), mean)

## make column weights.2
G_M221$nls_weights.2 <- as.numeric(1/(G_M221_bin_means[match(G_M221$STDAGE_t2_bin, names(G_M221_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_M221.1 <- nls(f_1, data = G_M221, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_M221$nls_weights.2), 
 )

## phi
try(
  nls_M221.2 <- nls(f_2, data=G_M221, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_M221$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M221.3 <- nls(f_3 , data = G_M221, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_M221$nls_weights.2), 
 )

## test
if(exists("nls_M221.1") & exists("nls_M221.2") & exists("nls_M221.3")){
  print(anova(nls_M221.1, nls_M221.2, nls_M221.3))
} else if(exists("nls_M221.2") & exists("nls_M221.3")){
  print(anova(nls_M221.2, nls_M221.3))
} else if(exists("nls_M221.1") & exists("nls_M221.2")){
  print(anova(nls_M221.1, nls_M221.2))
}
 
## AIC comparison
AIC1_M221 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_M221.1"), AIC(get("nls_M221.1")), NA),
            ifelse(exists("nls_M221.2"), AIC(get("nls_M221.2")), NA),
            ifelse(exists("nls_M221.3"), AIC(get("nls_M221.3")), NA)
            ))

print(AIC1_M221) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M221[!is.na(AIC1_M221$AIC) &AIC1_M221$AIC == min(AIC1_M221$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M221.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_M221.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M221.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_M221.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M221.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M221.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_M221.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_M221.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M221.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M221.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_M221,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_M221$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M221.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_M221,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_M221$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_M221.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_M221,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_M221$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M221.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M221.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M221.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M221.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M221.", Mod.Sel1, sep ="")),
             get(paste("nls_M221.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M221.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M221.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M221.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M221.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M221.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M221.", Mod.Sel1, sep ="")),
               get(paste("nls_M221.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M221.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M221.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M221.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M221.", Mod.Sel1, sep ="")),
                 get(paste("nls_M221.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M221.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M221.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M221.", Mod.Sel1, sep ="")),
                    get(paste("nls_M221.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M221.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M221.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M221.", Mod.Sel1, sep ="")),
                      get(paste("nls_M221.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M221 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M221.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M221.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M221.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M221.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M221.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M221.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M221.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M221.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M221)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M221[!is.na(AIC2_M221$AIC) & AIC2_M221$AIC == min(AIC2_M221$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "M221",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M221.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M221.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "M221",]$ge.variance <- vcov(get(paste("nls_M221.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "M221",]$phi.variance <- vcov(get(paste("nls_M221.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "M221",]$alpha.variance <- vcov(get(paste("nls_M221.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "M221",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M221",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M221",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M221",]$A <- coefs["A"]
nls.param.df_bal[nls.param.df_bal$Code == "M221",]$k <- coefs["k"]

nls.param.df_bal[nls.param.df_bal$Code == "M221",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M221",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M221",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M221",]$A.2.5 <- intervals_low["A"]
nls.param.df_bal[nls.param.df_bal$Code == "M221",]$k.2.5 <- intervals_low["k"]

nls.param.df_bal[nls.param.df_bal$Code == "M221",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M221",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M221",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M221",]$A.97.5 <- intervals_high["A"]
nls.param.df_bal[nls.param.df_bal$Code == "M221",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M221.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M221.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M221.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M221.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_M221$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_M221.4 <- nls(f_4, data = G_M221, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M221$nls_weights.2), 
 )

## phi
try(
  nls_M221.5 <- nls(f_5, data=G_M221, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M221$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M221.6 <- nls(f_6, data = G_M221, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M221$nls_weights.2), 
 )

## test
if(exists("nls_M221.4") & exists("nls_M221.5") & exists("nls_M221.6")){
  print(anova(nls_M221.4, nls_M221.5, nls_M221.6))
} else if(exists("nls_M221.4") & exists("nls_M221.6")){
  print(anova(nls_M221.4, nls_M221.6))
} else if(exists("nls_M221.5") & exists("nls_M221.6")){
  print(anova(nls_M221.5, nls_M221.6))
} else if(exists("nls_M221.4") & exists("nls_M221.5")){
  print(anova(nls_M221.4, nls_M221.5))
}

## AIC comparison
AIC3_M221 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_M221[AIC2_M221$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_M221.4"), AIC(get("nls_M221.4")), NA),
            ifelse(exists("nls_M221.5"), AIC(get("nls_M221.5")), NA),
            ifelse(exists("nls_M221.6"), AIC(get("nls_M221.6")), NA)
            ))

print(AIC3_M221) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_M221[!is.na(AIC3_M221$AIC) & AIC3_M221$AIC == min(AIC3_M221$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "M221",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_bal[Best_mods.P_bal$Code == "M221",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_M221.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M221.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "M221",]$ge.variance <- vcov(get(paste("nls_M221.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "M221",]$phi.variance <- vcov(get(paste("nls_M221.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "M221",]$alpha.variance <- vcov(get(paste("nls_M221.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "M221",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M221",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M221",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M221",]$a <- coefs["a"]
nls.param.df_bal[nls.param.df_bal$Code == "M221",]$b <- coefs["b"]
nls.param.df_bal[nls.param.df_bal$Code == "M221",]$c <- coefs["c"]
nls.param.df_bal[nls.param.df_bal$Code == "M221",]$d <- coefs["d"]

nls.param.df_bal[nls.param.df_bal$Code == "M221",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M221",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M221",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M221",]$a.2.5 <- intervals_low["a"]
nls.param.df_bal[nls.param.df_bal$Code == "M221",]$b.2.5 <- intervals_low["b"]
nls.param.df_bal[nls.param.df_bal$Code == "M221",]$c.2.5 <- intervals_low["c"]
nls.param.df_bal[nls.param.df_bal$Code == "M221",]$d.2.5 <- intervals_low["d"]

nls.param.df_bal[nls.param.df_bal$Code == "M221",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M221",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M221",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M221",]$a.97.5 <- intervals_high["a"]
nls.param.df_bal[nls.param.df_bal$Code == "M221",]$b.97.5 <- intervals_high["b"]
nls.param.df_bal[nls.param.df_bal$Code == "M221",]$c.97.5 <- intervals_high["c"]
nls.param.df_bal[nls.param.df_bal$Code == "M221",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_M221.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_M221.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_M221.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_M221.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_M221 <- nlsResiduals(
  get(paste("nls_M221.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_M221)

## test residuals
if(length(G_M221$pltID) < 5001) {test.nlsResiduals(resid_M221)}

}   else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_M221_pred <- predict(get(paste("nls_M221.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M221$MEASTIME_t2, na.rm = T), max(G_M221$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M221$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M221$MEASTIME_t2, na.rm = T), max(G_M221$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M221$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_M221$DeltaPDSI, na.rm = T), max(G_M221$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M221$MEASTIME_t2, na.rm = T), max(G_M221$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M221$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_M221$B_L_prop, na.rm = T), max(G_M221$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_M221$DeltaPDSI, na.rm = T), max(G_M221$STDAGE_t2)))
                      } )

G_M221_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_M221$STDAGE_t2),by = 1),  
                            "fitted"=G_M221_pred)

## plot
gg.M221 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M221, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M221, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M221))), breaks = cutvec_M221) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_M221_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_M221_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("M221 - Eastern Broadleaf Forest") + 
          
          #ylim(0, max(G_M221_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_M221,1)*1.05), expand = c(0,0))

gg.M221

}  else {print("cannot plot data with prediction")}
```

### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_M221 <- data.frame(
  bin = as.factor(levels(cut(G_M221$STDAGE_t2, cutvec_M221))),
  data.mean = tapply(G_M221$B_plt_t2_MgHa, cut(G_M221$STDAGE_t2, cutvec_M221), 
                     mean), 
  data.CI.high =  tapply(G_M221$B_plt_t2_MgHa, cut(G_M221$STDAGE_t2, cutvec_M221), 
                    high.CI), 
  data.CI.low = tapply(G_M221$B_plt_t2_MgHa, cut(G_M221$STDAGE_t2, cutvec_M221),
                    low.CI), 
  pred.mean = G_M221_pred_df[G_M221_pred_df$STDAGE_t2 %in% bin_mids_M221,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M221 <-  DM_compare_M221 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M221$bin)[gtools::mixedorder(levels(DM_compare_M221$bin))]))

## ggplot
gg.M221.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M221) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M221))), 
                              labels = levels(DM_compare_M221$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("M221 - Eastern Broadleaf Forest",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +        
           theme_classic() + 
           # xlim(min(DM_compare_M221$data.CI.low)-0.25, max(DM_compare_M221$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_M221$pred.CI.low)-0.25, max(DM_compare_M221$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M221.B2

}   else {print("cannot plot observed vs. predicted")}
```

## M223 - Ozark Broadleaf Forest Meadow
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_M223 <- round(quantile(G_M223$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M223)))){
  cutvec_M223 <- round(quantile(G_M223$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_M223 <- unname(round(cutvec_M223[-length(cutvec_M223)] + diff(cutvec_M223)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_M223$STDAGE_t2_bin<-  cut(G_M223$STDAGE_t2, cutvec_M223)
## then get bin means
G_M223_bin_means <- tapply(G_M223$B_plt_t2_MgHa, cut(G_M223$STDAGE_t2,  cutvec_M223), mean)

## make column weights.2
G_M223$nls_weights.2 <- as.numeric(1/(G_M223_bin_means[match(G_M223$STDAGE_t2_bin, names(G_M223_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_M223.1 <- nls(f_1, data = G_M223, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_M223$nls_weights.2), 
 )

## phi
try(
  nls_M223.2 <- nls(f_2, data=G_M223, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_M223$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M223.3 <- nls(f_3 , data = G_M223, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_M223$nls_weights.2), 
 )

## test
if(exists("nls_M223.1") & exists("nls_M223.2") & exists("nls_M223.3")){
  print(anova(nls_M223.1, nls_M223.2, nls_M223.3))
} else if(exists("nls_M223.2") & exists("nls_M223.3")){
  print(anova(nls_M223.2, nls_M223.3))
} else if(exists("nls_M223.1") & exists("nls_M223.2")){
  print(anova(nls_M223.1, nls_M223.2))
}
 
## AIC comparison
AIC1_M223 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_M223.1"), AIC(get("nls_M223.1")), NA),
            ifelse(exists("nls_M223.2"), AIC(get("nls_M223.2")), NA),
            ifelse(exists("nls_M223.3"), AIC(get("nls_M223.3")), NA)
            ))

print(AIC1_M223) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M223[!is.na(AIC1_M223$AIC) & AIC1_M223$AIC == min(AIC1_M223$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M223.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_M223.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M223.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_M223.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M223.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M223.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_M223.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_M223.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M223.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M223.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_M223,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_M223$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M223.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_M223,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_M223$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_M223.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_M223,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_M223$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M223.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M223.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M223.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M223.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M223.", Mod.Sel1, sep ="")),
             get(paste("nls_M223.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M223.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M223.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M223.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M223.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M223.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M223.", Mod.Sel1, sep ="")),
               get(paste("nls_M223.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M223.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M223.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M223.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M223.", Mod.Sel1, sep ="")),
                 get(paste("nls_M223.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M223.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M223.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M223.", Mod.Sel1, sep ="")),
                    get(paste("nls_M223.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M223.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M223.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M223.", Mod.Sel1, sep ="")),
                      get(paste("nls_M223.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M223 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M223.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M223.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M223.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M223.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M223.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M223.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M223.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M223.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M223)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M223[!is.na(AIC2_M223$AIC) & AIC2_M223$AIC == min(AIC2_M223$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "M223",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M223.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M223.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "M223",]$ge.variance <- vcov(get(paste("nls_M223.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "M223",]$phi.variance <- vcov(get(paste("nls_M223.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "M223",]$alpha.variance <- vcov(get(paste("nls_M223.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "M223",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M223",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M223",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M223",]$A <- coefs["A"]
nls.param.df_bal[nls.param.df_bal$Code == "M223",]$k <- coefs["k"]

nls.param.df_bal[nls.param.df_bal$Code == "M223",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M223",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M223",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M223",]$A.2.5 <- intervals_low["A"]
nls.param.df_bal[nls.param.df_bal$Code == "M223",]$k.2.5 <- intervals_low["k"]

nls.param.df_bal[nls.param.df_bal$Code == "M223",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M223",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M223",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M223",]$A.97.5 <- intervals_high["A"]
nls.param.df_bal[nls.param.df_bal$Code == "M223",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M223.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M223.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M223.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M223.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_M223$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_M223.4 <- nls(f_4, data = G_M223, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M223$nls_weights.2), 
 )

## phi
try(
  nls_M223.5 <- nls(f_5, data=G_M223, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M223$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M223.6 <- nls(f_6, data = G_M223, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M223$nls_weights.2), 
 )

## test
if(exists("nls_M223.4") & exists("nls_M223.5") & exists("nls_M223.6")){
  print(anova(nls_M223.4, nls_M223.5, nls_M223.6))
} else if(exists("nls_M223.4") & exists("nls_M223.6")){
  print(anova(nls_M223.4, nls_M223.6))
} else if(exists("nls_M223.5") & exists("nls_M223.6")){
  print(anova(nls_M223.5, nls_M223.6))
} else if(exists("nls_M223.4") & exists("nls_M223.5")){
  print(anova(nls_M223.4, nls_M223.5))
}

## AIC comparison
AIC3_M223 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_M223[AIC2_M223$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_M223.4"), AIC(get("nls_M223.4")), NA),
            ifelse(exists("nls_M223.5"), AIC(get("nls_M223.5")), NA),
            ifelse(exists("nls_M223.6"), AIC(get("nls_M223.6")), NA)
            ))

print(AIC3_M223) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_M223[!is.na(AIC3_M223$AIC) & AIC3_M223$AIC == min(AIC3_M223$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "M223",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_bal[Best_mods.P_bal$Code == "M223",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_M223.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M223.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "M223",]$ge.variance <- vcov(get(paste("nls_M223.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "M223",]$phi.variance <- vcov(get(paste("nls_M223.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "M223",]$alpha.variance <- vcov(get(paste("nls_M223.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "M223",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M223",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M223",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M223",]$a <- coefs["a"]
nls.param.df_bal[nls.param.df_bal$Code == "M223",]$b <- coefs["b"]
nls.param.df_bal[nls.param.df_bal$Code == "M223",]$c <- coefs["c"]
nls.param.df_bal[nls.param.df_bal$Code == "M223",]$d <- coefs["d"]

nls.param.df_bal[nls.param.df_bal$Code == "M223",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M223",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M223",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M223",]$a.2.5 <- intervals_low["a"]
nls.param.df_bal[nls.param.df_bal$Code == "M223",]$b.2.5 <- intervals_low["b"]
nls.param.df_bal[nls.param.df_bal$Code == "M223",]$c.2.5 <- intervals_low["c"]
nls.param.df_bal[nls.param.df_bal$Code == "M223",]$d.2.5 <- intervals_low["d"]

nls.param.df_bal[nls.param.df_bal$Code == "M223",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M223",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M223",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M223",]$a.97.5 <- intervals_high["a"]
nls.param.df_bal[nls.param.df_bal$Code == "M223",]$b.97.5 <- intervals_high["b"]
nls.param.df_bal[nls.param.df_bal$Code == "M223",]$c.97.5 <- intervals_high["c"]
nls.param.df_bal[nls.param.df_bal$Code == "M223",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_M223.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_M223.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_M223.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_M223.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_M223 <- nlsResiduals(
  get(paste("nls_M223.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_M223)

## test residuals
if(length(G_M223$pltID) < 5001) {test.nlsResiduals(resid_M223)}

}   else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_M223_pred <- predict(get(paste("nls_M223.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M223$MEASTIME_t2, na.rm = T), max(G_M223$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M223$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M223$MEASTIME_t2, na.rm = T), max(G_M223$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M223$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_M223$DeltaPDSI, na.rm = T), max(G_M223$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M223$MEASTIME_t2, na.rm = T), max(G_M223$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M223$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_M223$B_L_prop, na.rm = T), max(G_M223$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_M223$DeltaPDSI, na.rm = T), max(G_M223$STDAGE_t2)))
                      } )

G_M223_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_M223$STDAGE_t2),by = 1),  
                            "fitted"=G_M223_pred)

## plot
gg.M223 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M223, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M223, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M223))), breaks = cutvec_M223) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_M223_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_M223_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("M223 - Ozark Broadleaf Forest Meadow") + 
          
          #ylim(0, max(G_M223_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_M223,1)*1.05), expand = c(0,0))

gg.M223

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_M223 <- data.frame(
  bin = as.factor(levels(cut(G_M223$STDAGE_t2, cutvec_M223))),
  data.mean = tapply(G_M223$B_plt_t2_MgHa, cut(G_M223$STDAGE_t2, cutvec_M223), 
                     mean), 
  data.CI.high =  tapply(G_M223$B_plt_t2_MgHa, cut(G_M223$STDAGE_t2, cutvec_M223), 
                    high.CI), 
  data.CI.low = tapply(G_M223$B_plt_t2_MgHa, cut(G_M223$STDAGE_t2, cutvec_M223),
                    low.CI), 
  pred.mean = G_M223_pred_df[G_M223_pred_df$STDAGE_t2 %in% bin_mids_M223,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M223 <-  DM_compare_M223 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M223$bin)[gtools::mixedorder(levels(DM_compare_M223$bin))]))

## ggplot
gg.M223.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M223) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M223))), 
                              labels = levels(DM_compare_M223$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("M223 - Ozark Broadleaf Forest Meadow",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +       
           theme_classic() + 
           # xlim(min(DM_compare_M223$data.CI.low)-0.25, max(DM_compare_M223$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_M223$pred.CI.low)-0.25, max(DM_compare_M223$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M223.B2

}   else {print("cannot plot observed vs. predicted")}
```

## M231 - Ouachita Mixed Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_M231 <- round(quantile(G_M231$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M231)))){
  cutvec_M231 <- round(quantile(G_M231$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_M231 <- unname(round(cutvec_M231[-length(cutvec_M231)] + diff(cutvec_M231)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_M231$STDAGE_t2_bin<-  cut(G_M231$STDAGE_t2, cutvec_M231)
## then get bin means
G_M231_bin_means <- tapply(G_M231$B_plt_t2_MgHa, cut(G_M231$STDAGE_t2, cutvec_M231), mean)

## make column weights.2
G_M231$nls_weights.2 <- as.numeric(1/(G_M231_bin_means[match(G_M231$STDAGE_t2_bin, names(G_M231_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_M231.1 <- nls(f_1, data = G_M231, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_M231$nls_weights.2), 
 )

## phi
try(
  nls_M231.2 <- nls(f_2, data=G_M231, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_M231$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M231.3 <- nls(f_3 , data = G_M231, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_M231$nls_weights.2), 
 )

## test
if(exists("nls_M231.1") & exists("nls_M231.2") & exists("nls_M231.3")){
  print(anova(nls_M231.1, nls_M231.2, nls_M231.3))
} else if(exists("nls_M231.2") & exists("nls_M231.3")){
  print(anova(nls_M231.2, nls_M231.3))
} else if(exists("nls_M231.1") & exists("nls_M231.2")){
  print(anova(nls_M231.1, nls_M231.2))
}
 
## AIC comparison
AIC1_M231 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_M231.1"), AIC(get("nls_M231.1")), NA),
            ifelse(exists("nls_M231.2"), AIC(get("nls_M231.2")), NA),
            ifelse(exists("nls_M231.3"), AIC(get("nls_M231.3")), NA)
            ))

print(AIC1_M231) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M231[!is.na(AIC1_M231$AIC) & AIC1_M231$AIC == min(AIC1_M231$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M231.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_M231.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M231.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_M231.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M231.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M231.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_M231.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_M231.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M231.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M231.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_M231,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_M231$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M231.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_M231,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_M231$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_M231.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_M231,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_M231$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M231.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M231.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M231.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M231.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M231.", Mod.Sel1, sep ="")),
             get(paste("nls_M231.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M231.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M231.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M231.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M231.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M231.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M231.", Mod.Sel1, sep ="")),
               get(paste("nls_M231.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M231.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M231.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M231.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M231.", Mod.Sel1, sep ="")),
                 get(paste("nls_M231.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M231.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M231.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M231.", Mod.Sel1, sep ="")),
                    get(paste("nls_M231.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M231.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M231.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M231.", Mod.Sel1, sep ="")),
                      get(paste("nls_M231.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M231 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M231.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M231.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M231.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M231.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M231.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M231.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M231.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M231.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M231)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M231[!is.na(AIC2_M231$AIC) & AIC2_M231$AIC == min(AIC2_M231$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "M231",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M231.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M231.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "M231",]$ge.variance <- vcov(get(paste("nls_M231.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "M231",]$phi.variance <- vcov(get(paste("nls_M231.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "M231",]$alpha.variance <- vcov(get(paste("nls_M231.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "M231",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M231",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M231",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M231",]$A <- coefs["A"]
nls.param.df_bal[nls.param.df_bal$Code == "M231",]$k <- coefs["k"]

nls.param.df_bal[nls.param.df_bal$Code == "M231",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M231",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M231",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M231",]$A.2.5 <- intervals_low["A"]
nls.param.df_bal[nls.param.df_bal$Code == "M231",]$k.2.5 <- intervals_low["k"]

nls.param.df_bal[nls.param.df_bal$Code == "M231",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M231",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M231",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M231",]$A.97.5 <- intervals_high["A"]
nls.param.df_bal[nls.param.df_bal$Code == "M231",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M231.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M231.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M231.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M231.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_M231$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_M231.4 <- nls(f_4, data = G_M231, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M231$nls_weights.2), 
 )

## phi
try(
  nls_M231.5 <- nls(f_5, data=G_M231, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M231$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M231.6 <- nls(f_6, data = G_M231, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M231$nls_weights.2), 
 )

## test
if(exists("nls_M231.4") & exists("nls_M231.5") & exists("nls_M231.6")){
  print(anova(nls_M231.4, nls_M231.5, nls_M231.6))
} else if(exists("nls_M231.4") & exists("nls_M231.6")){
  print(anova(nls_M231.4, nls_M231.6))
} else if(exists("nls_M231.5") & exists("nls_M231.6")){
  print(anova(nls_M231.5, nls_M231.6))
} else if(exists("nls_M231.4") & exists("nls_M231.5")){
  print(anova(nls_M231.4, nls_M231.5))
}

## AIC comparison
AIC3_M231 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_M231[AIC2_M231$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_M231.4"), AIC(get("nls_M231.4")), NA),
            ifelse(exists("nls_M231.5"), AIC(get("nls_M231.5")), NA),
            ifelse(exists("nls_M231.6"), AIC(get("nls_M231.6")), NA)
            ))

print(AIC3_M231) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_M231[!is.na(AIC3_M231$AIC) & AIC3_M231$AIC == min(AIC3_M231$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "M231",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_bal[Best_mods.P_bal$Code == "M231",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_M231.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M231.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "M231",]$ge.variance <- vcov(get(paste("nls_M231.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "M231",]$phi.variance <- vcov(get(paste("nls_M231.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "M231",]$alpha.variance <- vcov(get(paste("nls_M231.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "M231",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M231",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M231",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M231",]$a <- coefs["a"]
nls.param.df_bal[nls.param.df_bal$Code == "M231",]$b <- coefs["b"]
nls.param.df_bal[nls.param.df_bal$Code == "M231",]$c <- coefs["c"]
nls.param.df_bal[nls.param.df_bal$Code == "M231",]$d <- coefs["d"]

nls.param.df_bal[nls.param.df_bal$Code == "M231",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M231",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M231",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M231",]$a.2.5 <- intervals_low["a"]
nls.param.df_bal[nls.param.df_bal$Code == "M231",]$b.2.5 <- intervals_low["b"]
nls.param.df_bal[nls.param.df_bal$Code == "M231",]$c.2.5 <- intervals_low["c"]
nls.param.df_bal[nls.param.df_bal$Code == "M231",]$d.2.5 <- intervals_low["d"]

nls.param.df_bal[nls.param.df_bal$Code == "M231",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M231",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M231",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M231",]$a.97.5 <- intervals_high["a"]
nls.param.df_bal[nls.param.df_bal$Code == "M231",]$b.97.5 <- intervals_high["b"]
nls.param.df_bal[nls.param.df_bal$Code == "M231",]$c.97.5 <- intervals_high["c"]
nls.param.df_bal[nls.param.df_bal$Code == "M231",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_M231.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_M231.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_M231.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_M231.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_M231 <- nlsResiduals(
  get(paste("nls_M231.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_M231)

## test residuals
if(length(G_M231$pltID) < 5001) {test.nlsResiduals(resid_M231)}

}  else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_M231_pred <- predict(get(paste("nls_M231.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M231$MEASTIME_t2, na.rm = T), max(G_M231$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M231$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M231$MEASTIME_t2, na.rm = T), max(G_M231$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M231$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_M231$DeltaPDSI, na.rm = T), max(G_M231$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M231$MEASTIME_t2, na.rm = T), max(G_M231$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M231$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_M231$B_L_prop, na.rm = T), max(G_M231$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_M231$DeltaPDSI, na.rm = T), max(G_M231$STDAGE_t2)))
                      } )

G_M231_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_M231$STDAGE_t2),by = 1),  
                            "fitted"=G_M231_pred)

## plot
gg.M231 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M231, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M231, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M231))), breaks = cutvec_M231) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_M231_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_M231_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("M231 - Ouachita Mixed Forest") + 
          
          #ylim(0, max(G_M231_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_M231,1)*1.05), expand = c(0,0))

gg.M231

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_M231 <- data.frame(
  bin = as.factor(levels(cut(G_M231$STDAGE_t2, cutvec_M231))),
  data.mean = tapply(G_M231$B_plt_t2_MgHa, cut(G_M231$STDAGE_t2, cutvec_M231), 
                     mean), 
  data.CI.high =  tapply(G_M231$B_plt_t2_MgHa, cut(G_M231$STDAGE_t2, cutvec_M231), 
                    high.CI), 
  data.CI.low = tapply(G_M231$B_plt_t2_MgHa, cut(G_M231$STDAGE_t2, cutvec_M231),
                    low.CI), 
  pred.mean = G_M231_pred_df[G_M231_pred_df$STDAGE_t2 %in% bin_mids_M231,]$fitted) 
 
### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M231 <-  DM_compare_M231 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M231$bin)[gtools::mixedorder(levels(DM_compare_M231$bin))]))

## ggplot
gg.M231.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M231) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M231))), 
                              labels = levels(DM_compare_M231$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("M231 - Ouachita Mixed Forest",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +        
           theme_classic() + 
           # xlim(min(DM_compare_M231$data.CI.low)-0.25, max(DM_compare_M231$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_M231$pred.CI.low)-0.25, max(DM_compare_M231$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M231.B2

}   else {print("cannot plot observed vs. predicted")}
```

## M242 - Cascade Mixed Forest
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_M242 <- round(quantile(G_M242$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M242)))){
  cutvec_M242 <- round(quantile(G_M242$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_M242 <- unname(round(cutvec_M242[-length(cutvec_M242)] + diff(cutvec_M242)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_M242$STDAGE_t2_bin<-  cut(G_M242$STDAGE_t2, cutvec_M242)
## then get bin means
G_M242_bin_means <- tapply(G_M242$B_plt_t2_MgHa, cut(G_M242$STDAGE_t2, cutvec_M242), mean)

## make column weights.2
G_M242$nls_weights.2 <- as.numeric(1/(G_M242_bin_means[match(G_M242$STDAGE_t2_bin, names(G_M242_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_M242.1 <- nls(f_1, data = G_M242, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_M242$nls_weights.2), 
 )

## phi
try(
  nls_M242.2 <- nls(f_2, data=G_M242, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_M242$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M242.3 <- nls(f_3 , data = G_M242, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_M242$nls_weights.2), 
 )

## test
if(exists("nls_M242.1") & exists("nls_M242.2") & exists("nls_M242.3")){
  print(anova(nls_M242.1, nls_M242.2, nls_M242.3))
} else if(exists("nls_M242.2") & exists("nls_M242.3")){
  print(anova(nls_M242.2, nls_M242.3))
} else if(exists("nls_M242.1") & exists("nls_M242.2")){
  print(anova(nls_M242.1, nls_M242.2))
}
 
## AIC comparison
AIC1_M242 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_M242.1"), AIC(get("nls_M242.1")), NA),
            ifelse(exists("nls_M242.2"), AIC(get("nls_M242.2")), NA),
            ifelse(exists("nls_M242.3"), AIC(get("nls_M242.3")), NA)
            ))

print(AIC1_M242) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M242[!is.na(AIC1_M242$AIC) & AIC1_M242$AIC == min(AIC1_M242$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M242.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_M242.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M242.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_M242.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M242.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M242.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_M242.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_M242.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M242.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M242.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_M242,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_M242$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M242.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_M242,
         start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_M242$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_M242.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_M242,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
				
          weights = G_M242$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M242.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M242.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M242.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M242.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M242.", Mod.Sel1, sep ="")),
             get(paste("nls_M242.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M242.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M242.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M242.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M242.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M242.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M242.", Mod.Sel1, sep ="")),
               get(paste("nls_M242.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M242.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M242.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M242.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M242.", Mod.Sel1, sep ="")),
                 get(paste("nls_M242.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M242.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M242.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M242.", Mod.Sel1, sep ="")),
                    get(paste("nls_M242.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M242.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M242.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M242.", Mod.Sel1, sep ="")),
                      get(paste("nls_M242.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M242 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M242.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M242.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M242.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M242.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M242.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M242.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M242.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M242.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M242)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M242[!is.na(AIC2_M242$AIC) & AIC2_M242$AIC == min(AIC2_M242$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "M242",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M242.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M242.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "M242",]$ge.variance <- vcov(get(paste("nls_M242.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "M242",]$phi.variance <- vcov(get(paste("nls_M242.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "M242",]$alpha.variance <- vcov(get(paste("nls_M242.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "M242",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M242",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M242",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M242",]$A <- coefs["A"]
nls.param.df_bal[nls.param.df_bal$Code == "M242",]$k <- coefs["k"]

nls.param.df_bal[nls.param.df_bal$Code == "M242",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M242",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M242",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M242",]$A.2.5 <- intervals_low["A"]
nls.param.df_bal[nls.param.df_bal$Code == "M242",]$k.2.5 <- intervals_low["k"]

nls.param.df_bal[nls.param.df_bal$Code == "M242",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M242",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M242",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M242",]$A.97.5 <- intervals_high["A"]
nls.param.df_bal[nls.param.df_bal$Code == "M242",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M242.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M242.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M242.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M242.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_M242$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_M242.4 <- nls(f_4, data = G_M242, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M242$nls_weights.2), 
 )

## phi
try(
  nls_M242.5 <- nls(f_5, data=G_M242, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M242$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M242.6 <- nls(f_6, data = G_M242, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M242$nls_weights.2), 
 )

## test
if(exists("nls_M242.4") & exists("nls_M242.5") & exists("nls_M242.6")){
  print(anova(nls_M242.4, nls_M242.5, nls_M242.6))
} else if(exists("nls_M242.4") & exists("nls_M242.6")){
  print(anova(nls_M242.4, nls_M242.6))
} else if(exists("nls_M242.5") & exists("nls_M242.6")){
  print(anova(nls_M242.5, nls_M242.6))
} else if(exists("nls_M242.4") & exists("nls_M242.5")){
  print(anova(nls_M242.4, nls_M242.5))
}

## AIC comparison
AIC3_M242 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_M242[AIC2_M242$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_M242.4"), AIC(get("nls_M242.4")), NA),
            ifelse(exists("nls_M242.5"), AIC(get("nls_M242.5")), NA),
            ifelse(exists("nls_M242.6"), AIC(get("nls_M242.6")), NA)
            ))

print(AIC3_M242) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_M242[!is.na(AIC3_M242$AIC) & AIC3_M242$AIC == min(AIC3_M242$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "M242",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_bal[Best_mods.P_bal$Code == "M242",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_M242.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M242.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "M242",]$ge.variance <- vcov(get(paste("nls_M242.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "M242",]$phi.variance <- vcov(get(paste("nls_M242.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "M242",]$alpha.variance <- vcov(get(paste("nls_M242.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "M242",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M242",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M242",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M242",]$a <- coefs["a"]
nls.param.df_bal[nls.param.df_bal$Code == "M242",]$b <- coefs["b"]
nls.param.df_bal[nls.param.df_bal$Code == "M242",]$c <- coefs["c"]
nls.param.df_bal[nls.param.df_bal$Code == "M242",]$d <- coefs["d"]

nls.param.df_bal[nls.param.df_bal$Code == "M242",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M242",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M242",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M242",]$a.2.5 <- intervals_low["a"]
nls.param.df_bal[nls.param.df_bal$Code == "M242",]$b.2.5 <- intervals_low["b"]
nls.param.df_bal[nls.param.df_bal$Code == "M242",]$c.2.5 <- intervals_low["c"]
nls.param.df_bal[nls.param.df_bal$Code == "M242",]$d.2.5 <- intervals_low["d"]

nls.param.df_bal[nls.param.df_bal$Code == "M242",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M242",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M242",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M242",]$a.97.5 <- intervals_high["a"]
nls.param.df_bal[nls.param.df_bal$Code == "M242",]$b.97.5 <- intervals_high["b"]
nls.param.df_bal[nls.param.df_bal$Code == "M242",]$c.97.5 <- intervals_high["c"]
nls.param.df_bal[nls.param.df_bal$Code == "M242",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_M242.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_M242.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_M242.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_M242.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_M242 <- nlsResiduals(
  get(paste("nls_M242.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_M242)

## test residuals
if(length(G_M242$pltID) < 5001) {test.nlsResiduals(resid_M242)}
 
}   else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_M242_pred <- predict(get(paste("nls_M242.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M242$MEASTIME_t2, na.rm = T), max(G_M242$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M242$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M242$MEASTIME_t2, na.rm = T), max(G_M242$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M242$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_M242$DeltaPDSI, na.rm = T), max(G_M242$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M242$MEASTIME_t2, na.rm = T), max(G_M242$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M242$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_M242$B_L_prop, na.rm = T), max(G_M242$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_M242$DeltaPDSI, na.rm = T), max(G_M242$STDAGE_t2)))
                      } )

G_M242_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_M242$STDAGE_t2),by = 1),  
                            "fitted"=G_M242_pred)

## plot
gg.M242 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M242, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M242, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M242))), breaks = cutvec_M242) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_M242_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_M242_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("M242 - Cascade Mixed Forest") + 
          
          #ylim(0, max(G_M242_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_M242,1)*1.05), expand = c(0,0))

gg.M242

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_M242 <- data.frame(
  bin = as.factor(levels(cut(G_M242$STDAGE_t2, cutvec_M242))),
  data.mean = tapply(G_M242$B_plt_t2_MgHa, cut(G_M242$STDAGE_t2, cutvec_M242), 
                     mean), 
  data.CI.high =  tapply(G_M242$B_plt_t2_MgHa, cut(G_M242$STDAGE_t2, cutvec_M242), 
                    high.CI), 
  data.CI.low = tapply(G_M242$B_plt_t2_MgHa, cut(G_M242$STDAGE_t2, cutvec_M242),
                    low.CI), 
  pred.mean = G_M242_pred_df[G_M242_pred_df$STDAGE_t2 %in% bin_mids_M242,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M242 <-  DM_compare_M242 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M242$bin)[gtools::mixedorder(levels(DM_compare_M242$bin))]))

## ggplot
gg.M242.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M242) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M242))), 
                              labels = levels(DM_compare_M242$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("M242 - Cascade Mixed Forest",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +        
           theme_classic() + 
           # xlim(min(DM_compare_M242$data.CI.low)-0.25, max(DM_compare_M242$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_M242$pred.CI.low)-0.25, max(DM_compare_M242$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M242.B2

}   else {print("cannot plot observed vs. predicted")}
```

## M261 - Sierran Steppe - Mixed Forest - Coniferous Forest - Alpine Meadow
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_M261 <- round(quantile(G_M261$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M261)))){
  cutvec_M261 <- round(quantile(G_M261$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_M261 <- unname(round(cutvec_M261[-length(cutvec_M261)] + diff(cutvec_M261)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_M261$STDAGE_t2_bin<-  cut(G_M261$STDAGE_t2, cutvec_M261)
## then get bin means
G_M261_bin_means <- tapply(G_M261$B_plt_t2_MgHa, cut(G_M261$STDAGE_t2,  cutvec_M261), mean)

## make column weights.2
G_M261$nls_weights.2 <- as.numeric(1/(G_M261_bin_means[match(G_M261$STDAGE_t2_bin, names(G_M261_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_M261.1 <- nls(f_1, data = G_M261, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_M261$nls_weights.2), 
 )

## phi
try(
  nls_M261.2 <- nls(f_2, data=G_M261, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_M261$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M261.3 <- nls(f_3 , data = G_M261, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_M261$nls_weights.2), 
 )

## test
if(exists("nls_M261.1") & exists("nls_M261.2") & exists("nls_M261.3")){
  print(anova(nls_M261.1, nls_M261.2, nls_M261.3))
} else if(exists("nls_M261.2") & exists("nls_M261.3")){
  print(anova(nls_M261.2, nls_M261.3))
} else if(exists("nls_M261.1") & exists("nls_M261.2")){
  print(anova(nls_M261.1, nls_M261.2))
}
 
## AIC comparison
AIC1_M261 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_M261.1"), AIC(get("nls_M261.1")), NA),
            ifelse(exists("nls_M261.2"), AIC(get("nls_M261.2")), NA),
            ifelse(exists("nls_M261.3"), AIC(get("nls_M261.3")), NA)
            ))

print(AIC1_M261) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M261[!is.na(AIC1_M261$AIC) & AIC1_M261$AIC == min(AIC1_M261$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M261.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_M261.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M261.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_M261.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M261.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M261.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_M261.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_M261.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M261.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M261.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_M261,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_M261$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M261.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_M261,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_M261$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_M261.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_M261,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_M261$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M261.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M261.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M261.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M261.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M261.", Mod.Sel1, sep ="")),
             get(paste("nls_M261.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M261.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M261.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M261.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M261.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M261.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M261.", Mod.Sel1, sep ="")),
               get(paste("nls_M261.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M261.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M261.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M261.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M261.", Mod.Sel1, sep ="")),
                 get(paste("nls_M261.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M261.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M261.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M261.", Mod.Sel1, sep ="")),
                    get(paste("nls_M261.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M261.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M261.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M261.", Mod.Sel1, sep ="")),
                      get(paste("nls_M261.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M261 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M261.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M261.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M261.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M261.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M261.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M261.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M261.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M261.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M261)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M261[!is.na(AIC2_M261$AIC) & AIC2_M261$AIC == min(AIC2_M261$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "M261",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M261.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M261.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "M261",]$ge.variance <- vcov(get(paste("nls_M261.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "M261",]$phi.variance <- vcov(get(paste("nls_M261.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "M261",]$alpha.variance <- vcov(get(paste("nls_M261.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "M261",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M261",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M261",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M261",]$A <- coefs["A"]
nls.param.df_bal[nls.param.df_bal$Code == "M261",]$k <- coefs["k"]

nls.param.df_bal[nls.param.df_bal$Code == "M261",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M261",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M261",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M261",]$A.2.5 <- intervals_low["A"]
nls.param.df_bal[nls.param.df_bal$Code == "M261",]$k.2.5 <- intervals_low["k"]

nls.param.df_bal[nls.param.df_bal$Code == "M261",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M261",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M261",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M261",]$A.97.5 <- intervals_high["A"]
nls.param.df_bal[nls.param.df_bal$Code == "M261",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M261.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M261.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M261.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M261.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_M261$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_M261.4 <- nls(f_4, data = G_M261, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M261$nls_weights.2), 
 )

## phi
try(
  nls_M261.5 <- nls(f_5, data=G_M261, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M261$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M261.6 <- nls(f_6, data = G_M261, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M261$nls_weights.2), 
 )

## test
if(exists("nls_M261.4") & exists("nls_M261.5") & exists("nls_M261.6")){
  print(anova(nls_M261.4, nls_M261.5, nls_M261.6))
} else if(exists("nls_M261.4") & exists("nls_M261.6")){
  print(anova(nls_M261.4, nls_M261.6))
} else if(exists("nls_M261.5") & exists("nls_M261.6")){
  print(anova(nls_M261.5, nls_M261.6))
} else if(exists("nls_M261.4") & exists("nls_M261.5")){
  print(anova(nls_M261.4, nls_M261.5))
}

## AIC comparison
AIC3_M261 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_M261[AIC2_M261$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_M261.4"), AIC(get("nls_M261.4")), NA),
            ifelse(exists("nls_M261.5"), AIC(get("nls_M261.5")), NA),
            ifelse(exists("nls_M261.6"), AIC(get("nls_M261.6")), NA)
            ))

print(AIC3_M261) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_M261[!is.na(AIC3_M261$AIC) & AIC3_M261$AIC == min(AIC3_M261$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "M261",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_bal[Best_mods.P_bal$Code == "M261",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_M261.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M261.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "M261",]$ge.variance <- vcov(get(paste("nls_M261.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "M261",]$phi.variance <- vcov(get(paste("nls_M261.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "M261",]$alpha.variance <- vcov(get(paste("nls_M261.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "M261",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M261",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M261",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M261",]$a <- coefs["a"]
nls.param.df_bal[nls.param.df_bal$Code == "M261",]$b <- coefs["b"]
nls.param.df_bal[nls.param.df_bal$Code == "M261",]$c <- coefs["c"]
nls.param.df_bal[nls.param.df_bal$Code == "M261",]$d <- coefs["d"]

nls.param.df_bal[nls.param.df_bal$Code == "M261",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M261",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M261",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M261",]$a.2.5 <- intervals_low["a"]
nls.param.df_bal[nls.param.df_bal$Code == "M261",]$b.2.5 <- intervals_low["b"]
nls.param.df_bal[nls.param.df_bal$Code == "M261",]$c.2.5 <- intervals_low["c"]
nls.param.df_bal[nls.param.df_bal$Code == "M261",]$d.2.5 <- intervals_low["d"]

nls.param.df_bal[nls.param.df_bal$Code == "M261",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M261",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M261",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M261",]$a.97.5 <- intervals_high["a"]
nls.param.df_bal[nls.param.df_bal$Code == "M261",]$b.97.5 <- intervals_high["b"]
nls.param.df_bal[nls.param.df_bal$Code == "M261",]$c.97.5 <- intervals_high["c"]
nls.param.df_bal[nls.param.df_bal$Code == "M261",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_M261.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_M261.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_M261.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_M261.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_M261 <- nlsResiduals(
  get(paste("nls_M261.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_M261)

## test residuals
if(length(G_M261$pltID) < 5001) {test.nlsResiduals(resid_M261)}

}   else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_M261_pred <- predict(get(paste("nls_M261.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M261$MEASTIME_t2, na.rm = T), max(G_M261$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M261$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M261$MEASTIME_t2, na.rm = T), max(G_M261$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M261$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_M261$DeltaPDSI, na.rm = T), max(G_M261$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M261$MEASTIME_t2, na.rm = T), max(G_M261$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M261$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_M261$B_L_prop, na.rm = T), max(G_M261$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_M261$DeltaPDSI, na.rm = T), max(G_M261$STDAGE_t2)))
                      } )

G_M261_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_M261$STDAGE_t2),by = 1),  
                            "fitted"=G_M261_pred)

## plot
gg.M261 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M261, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M261, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M261))), breaks = cutvec_M261) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_M261_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_M261_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("M261 - Sierran Steppe - Mixed Forest - Coniferous Forest - Alpine Meadow") + 
          
          #ylim(0, max(G_M261_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_M261,1)*1.05), expand = c(0,0))

gg.M261

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_M261 <- data.frame(
  bin = as.factor(levels(cut(G_M261$STDAGE_t2, cutvec_M261))),
  data.mean = tapply(G_M261$B_plt_t2_MgHa, cut(G_M261$STDAGE_t2, cutvec_M261), 
                     mean), 
  data.CI.high =  tapply(G_M261$B_plt_t2_MgHa, cut(G_M261$STDAGE_t2, cutvec_M261), 
                    high.CI), 
  data.CI.low = tapply(G_M261$B_plt_t2_MgHa, cut(G_M261$STDAGE_t2, cutvec_M261),
                    low.CI), 
  pred.mean = G_M261_pred_df[G_M261_pred_df$STDAGE_t2 %in% bin_mids_M261,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M261 <-  DM_compare_M261 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M261$bin)[gtools::mixedorder(levels(DM_compare_M261$bin))]))

## ggplot
gg.M261.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M261) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M261))), 
                              labels = levels(DM_compare_M261$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("M261 - Sierran Steppe - Mixed Forest - Coniferous Forest - Alpine Meadow",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +       
           theme_classic() + 
           # xlim(min(DM_compare_M261$data.CI.low)-0.25, max(DM_compare_M261$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_M261$pred.CI.low)-0.25, max(DM_compare_M261$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M261.B2 


}  else {print("cannot plot data with prediction")}
```

## M262 - California coastal range - coniferous forest - open woodland - shrub meadow
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_M262 <- round(quantile(G_M262$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M262)))){
  cutvec_M262 <- round(quantile(G_M262$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_M262 <- unname(round(cutvec_M262[-length(cutvec_M262)] + diff(cutvec_M262)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_M262$STDAGE_t2_bin<-  cut(G_M262$STDAGE_t2, cutvec_M262)
## then get bin means
G_M262_bin_means <- tapply(G_M262$B_plt_t2_MgHa, cut(G_M262$STDAGE_t2,  cutvec_M262), mean)

## make column weights.2
G_M262$nls_weights.2 <- as.numeric(1/(G_M262_bin_means[match(G_M262$STDAGE_t2_bin, names(G_M262_bin_means))])^2)

}
```
 
## Model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_M262.1 <- nls(f_1, data = G_M262, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_M262$nls_weights.2), 
 )

## phi
try(
  nls_M262.2 <- nls(f_2, data=G_M262, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_M262$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M262.3 <- nls(f_3 , data = G_M262, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_M262$nls_weights.2), 
 )

## test
if(exists("nls_M262.1") & exists("nls_M262.2") & exists("nls_M262.3")){
  print(anova(nls_M262.1, nls_M262.2, nls_M262.3))
} else if(exists("nls_M262.2") & exists("nls_M262.3")){
  print(anova(nls_M262.2, nls_M262.3))
} else if(exists("nls_M262.1") & exists("nls_M262.2")){
  print(anova(nls_M262.1, nls_M262.2))
}
 
## AIC comparison
AIC1_M262 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_M262.1"), AIC(get("nls_M262.1")), NA),
            ifelse(exists("nls_M262.2"), AIC(get("nls_M262.2")), NA),
            ifelse(exists("nls_M262.3"), AIC(get("nls_M262.3")), NA)
            ))

print(AIC1_M262) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M262[!is.na(AIC1_M262$AIC) & AIC1_M262$AIC == min(AIC1_M262$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M262.",  Mod.Sel1, sep =""))) )  #model summary

}
```

#### summary 
* simple model: `r ifelse(exists("nls_M262.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M262.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_M262.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M262.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M262.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_M262.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_M262.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M262.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M262.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_M262,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_M262$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M262.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_M262,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_M262$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_M262.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_M262,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_M262$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M262.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M262.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M262.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M262.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M262.", Mod.Sel1, sep ="")),
             get(paste("nls_M262.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M262.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M262.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M262.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M262.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M262.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M262.", Mod.Sel1, sep ="")),
               get(paste("nls_M262.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M262.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M262.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M262.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M262.", Mod.Sel1, sep ="")),
                 get(paste("nls_M262.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M262.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M262.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M262.", Mod.Sel1, sep ="")),
                    get(paste("nls_M262.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M262.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M262.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M262.", Mod.Sel1, sep ="")),
                      get(paste("nls_M262.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M262 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M262.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M262.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M262.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M262.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M262.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M262.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M262.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M262.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M262)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M262[!is.na(AIC2_M262$AIC) & AIC2_M262$AIC == min(AIC2_M262$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "M262",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M262.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M262.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "M262",]$ge.variance <- vcov(get(paste("nls_M262.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "M262",]$phi.variance <- vcov(get(paste("nls_M262.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "M262",]$alpha.variance <- vcov(get(paste("nls_M262.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "M262",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M262",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M262",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M262",]$A <- coefs["A"]
nls.param.df_bal[nls.param.df_bal$Code == "M262",]$k <- coefs["k"]

nls.param.df_bal[nls.param.df_bal$Code == "M262",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M262",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M262",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M262",]$A.2.5 <- intervals_low["A"]
nls.param.df_bal[nls.param.df_bal$Code == "M262",]$k.2.5 <- intervals_low["k"]

nls.param.df_bal[nls.param.df_bal$Code == "M262",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M262",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M262",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M262",]$A.97.5 <- intervals_high["A"]
nls.param.df_bal[nls.param.df_bal$Code == "M262",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M262.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M262.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M262.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M262.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_M262$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_M262.4 <- nls(f_4, data = G_M262, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M262$nls_weights.2), 
 )

## phi
try(
  nls_M262.5 <- nls(f_5, data=G_M262, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M262$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M262.6 <- nls(f_6, data = G_M262, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M262$nls_weights.2), 
 )

## test
if(exists("nls_M262.4") & exists("nls_M262.5") & exists("nls_M262.6")){
  print(anova(nls_M262.4, nls_M262.5, nls_M262.6))
} else if(exists("nls_M262.4") & exists("nls_M262.6")){
  print(anova(nls_M262.4, nls_M262.6))
} else if(exists("nls_M262.5") & exists("nls_M262.6")){
  print(anova(nls_M262.5, nls_M262.6))
} else if(exists("nls_M262.4") & exists("nls_M262.5")){
  print(anova(nls_M262.4, nls_M262.5))
}

## AIC comparison
AIC3_M262 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_M262[AIC2_M262$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_M262.4"), AIC(get("nls_M262.4")), NA),
            ifelse(exists("nls_M262.5"), AIC(get("nls_M262.5")), NA),
            ifelse(exists("nls_M262.6"), AIC(get("nls_M262.6")), NA)
            ))

print(AIC3_M262) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_M262[!is.na(AIC3_M262$AIC) & AIC3_M262$AIC == min(AIC3_M262$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "M262",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_bal[Best_mods.P_bal$Code == "M262",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_M262.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M262.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "M262",]$ge.variance <- vcov(get(paste("nls_M262.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "M262",]$phi.variance <- vcov(get(paste("nls_M262.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "M262",]$alpha.variance <- vcov(get(paste("nls_M262.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "M262",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M262",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M262",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M262",]$a <- coefs["a"]
nls.param.df_bal[nls.param.df_bal$Code == "M262",]$b <- coefs["b"]
nls.param.df_bal[nls.param.df_bal$Code == "M262",]$c <- coefs["c"]
nls.param.df_bal[nls.param.df_bal$Code == "M262",]$d <- coefs["d"]

nls.param.df_bal[nls.param.df_bal$Code == "M262",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M262",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M262",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M262",]$a.2.5 <- intervals_low["a"]
nls.param.df_bal[nls.param.df_bal$Code == "M262",]$b.2.5 <- intervals_low["b"]
nls.param.df_bal[nls.param.df_bal$Code == "M262",]$c.2.5 <- intervals_low["c"]
nls.param.df_bal[nls.param.df_bal$Code == "M262",]$d.2.5 <- intervals_low["d"]

nls.param.df_bal[nls.param.df_bal$Code == "M262",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M262",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M262",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M262",]$a.97.5 <- intervals_high["a"]
nls.param.df_bal[nls.param.df_bal$Code == "M262",]$b.97.5 <- intervals_high["b"]
nls.param.df_bal[nls.param.df_bal$Code == "M262",]$c.97.5 <- intervals_high["c"]
nls.param.df_bal[nls.param.df_bal$Code == "M262",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_M262.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_M262.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_M262.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_M262.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_M262 <- nlsResiduals(
  get(paste("nls_M262.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_M262)

## test residuals
if(length(G_M262$pltID) < 5001) {test.nlsResiduals(resid_M262)}

}   else {print("cannot plot residuals")}
```

* model can fit - but K is negative  (only 19 observations) - model excluded

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_M262_pred <- predict(get(paste("nls_M262.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M262$MEASTIME_t2, na.rm = T), max(G_M262$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M262$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M262$MEASTIME_t2, na.rm = T), max(G_M262$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M262$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_M262$DeltaPDSI, na.rm = T), max(G_M262$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M262$MEASTIME_t2, na.rm = T), max(G_M262$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M262$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_M262$B_L_prop, na.rm = T), max(G_M262$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_M262$DeltaPDSI, na.rm = T), max(G_M262$STDAGE_t2)))
                      } )

G_M262_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_M262$STDAGE_t2),by = 1),
                            "fitted"=G_M262_pred)

## plot
gg.M262 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M262, alpha = 0.5, shape ="+", col = "#60606080") +

          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M262,
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res},
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M262))), breaks = cutvec_M262) +

          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`),
                      #data = G_M262_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +

          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_M262_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) +


          theme_classic() +
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"),
               x = "Stand Age (yrs)") +  ggtitle("M262 - California coastal range - coniferous forest - open woodland - shrub meadow") +

          #ylim(0, max(G_M262_pred_df$`Prop.97.5%` + 0.25)) +
          scale_x_continuous(limits = c(0, tail(cutvec_M262,1)*1.05), expand = c(0,0))

gg.M262

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_M262 <- data.frame(
  bin = as.factor(levels(cut(G_M262$STDAGE_t2, cutvec_M262))),
  data.mean = tapply(G_M262$B_plt_t2_MgHa, cut(G_M262$STDAGE_t2, cutvec_M262),
                     mean),
  data.CI.high =  tapply(G_M262$B_plt_t2_MgHa, cut(G_M262$STDAGE_t2, cutvec_M262),
                    high.CI),
  data.CI.low = tapply(G_M262$B_plt_t2_MgHa, cut(G_M262$STDAGE_t2, cutvec_M262),
                    low.CI),
  pred.mean = G_M262_pred_df[G_M262_pred_df$STDAGE_t2 %in% bin_mids_M262,]$fitted)

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY
DM_compare_M262 <-  DM_compare_M262 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M262$bin)[gtools::mixedorder(levels(DM_compare_M262$bin))]))

## ggplot
gg.M262.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M262) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M262))),
                              labels = levels(DM_compare_M262$bin),
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +
           labs(x = expression("observed biomass (Mg ha"^-1*")"),
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("M262 - California coastal range - coniferous forest - open woodland - shrub meadow",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +
           theme_classic() +
           # xlim(min(DM_compare_M262$data.CI.low)-0.25, max(DM_compare_M262$data.CI.high)+0.25) +
           # ylim(min(DM_compare_M262$pred.CI.low)-0.25, max(DM_compare_M262$pred.CI.high)+0.25) +
           theme(legend.position = "top") + tune::coord_obs_pred()

gg.M262.B2

}
```

## M313 - Arizona-New Mexico Mountains Semi-Desert - Open Woodland - Coniferous Forest - Alpine Meadow
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_M313 <- round(quantile(G_M313$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M313)))){
  cutvec_M313 <- round(quantile(G_M313$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_M313 <- unname(round(cutvec_M313[-length(cutvec_M313)] + diff(cutvec_M313)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_M313$STDAGE_t2_bin<-  cut(G_M313$STDAGE_t2, cutvec_M313)
## then get bin means
G_M313_bin_means <- tapply(G_M313$B_plt_t2_MgHa, cut(G_M313$STDAGE_t2,  cutvec_M313), mean)

## make column weights.2
G_M313$nls_weights.2 <- as.numeric(1/(G_M313_bin_means[match(G_M313$STDAGE_t2_bin, names(G_M313_bin_means))])^2)

}
```

### model selection 1
```{r}
if(fit.models == T) {

# simple
try(
  nls_M313.1 <- nls(f_1, data = G_M313, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_M313$nls_weights.2), 
 )

## phi
try(
  nls_M313.2 <- nls(f_2, data=G_M313, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_M313$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M313.3 <- nls(f_3 , data = G_M313, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_M313$nls_weights.2), 
 )

## test
if(exists("nls_M313.1") & exists("nls_M313.2") & exists("nls_M313.3")){
  print(anova(nls_M313.1, nls_M313.2, nls_M313.3))
} else if(exists("nls_M313.2") & exists("nls_M313.3")){
  print(anova(nls_M313.2, nls_M313.3))
} else if(exists("nls_M313.1") & exists("nls_M313.2")){
  print(anova(nls_M313.1, nls_M313.2))
}
 
## AIC comparison
AIC1_M313 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_M313.1"), AIC(get("nls_M313.1")), NA),
            ifelse(exists("nls_M313.2"), AIC(get("nls_M313.2")), NA),
            ifelse(exists("nls_M313.3"), AIC(get("nls_M313.3")), NA)
            ))

print(AIC1_M313) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M313[!is.na(AIC1_M313$AIC) & AIC1_M313$AIC == min(AIC1_M313$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M313.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_M313.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M313.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_M313.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M313.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M313.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_M313.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_M313.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M313.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M313.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_M313,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_M313$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M313.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_M313,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_M313$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_M313.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_M313,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_M313$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M313.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M313.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M313.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M313.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M313.", Mod.Sel1, sep ="")),
             get(paste("nls_M313.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M313.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M313.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M313.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M313.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M313.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M313.", Mod.Sel1, sep ="")),
               get(paste("nls_M313.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M313.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M313.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M313.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M313.", Mod.Sel1, sep ="")),
                 get(paste("nls_M313.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M313.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M313.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M313.", Mod.Sel1, sep ="")),
                    get(paste("nls_M313.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M313.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M313.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M313.", Mod.Sel1, sep ="")),
                      get(paste("nls_M313.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M313 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M313.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M313.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M313.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M313.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M313.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M313.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M313.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M313.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M313)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M313[!is.na(AIC2_M313$AIC) & AIC2_M313$AIC == min(AIC2_M313$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "M313",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M313.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M313.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "M313",]$ge.variance <- vcov(get(paste("nls_M313.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "M313",]$phi.variance <- vcov(get(paste("nls_M313.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "M313",]$alpha.variance <- vcov(get(paste("nls_M313.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "M313",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M313",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M313",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M313",]$A <- coefs["A"]
nls.param.df_bal[nls.param.df_bal$Code == "M313",]$k <- coefs["k"]

nls.param.df_bal[nls.param.df_bal$Code == "M313",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M313",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M313",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M313",]$A.2.5 <- intervals_low["A"]
nls.param.df_bal[nls.param.df_bal$Code == "M313",]$k.2.5 <- intervals_low["k"]

nls.param.df_bal[nls.param.df_bal$Code == "M313",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M313",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M313",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M313",]$A.97.5 <- intervals_high["A"]
nls.param.df_bal[nls.param.df_bal$Code == "M313",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M313.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M313.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M313.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M313.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_M313$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_M313.4 <- nls(f_4, data = G_M313, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M313$nls_weights.2), 
 )

## phi
try(
  nls_M313.5 <- nls(f_5, data=G_M313, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M313$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M313.6 <- nls(f_6, data = G_M313, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M313$nls_weights.2), 
 )

## test
if(exists("nls_M313.4") & exists("nls_M313.5") & exists("nls_M313.6")){
  print(anova(nls_M313.4, nls_M313.5, nls_M313.6))
} else if(exists("nls_M313.4") & exists("nls_M313.6")){
  print(anova(nls_M313.4, nls_M313.6))
} else if(exists("nls_M313.5") & exists("nls_M313.6")){
  print(anova(nls_M313.5, nls_M313.6))
} else if(exists("nls_M313.4") & exists("nls_M313.5")){
  print(anova(nls_M313.4, nls_M313.5))
}

## AIC comparison
AIC3_M313 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_M313[AIC2_M313$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_M313.4"), AIC(get("nls_M313.4")), NA),
            ifelse(exists("nls_M313.5"), AIC(get("nls_M313.5")), NA),
            ifelse(exists("nls_M313.6"), AIC(get("nls_M313.6")), NA)
            ))

print(AIC3_M313) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_M313[!is.na(AIC3_M313$AIC) & AIC3_M313$AIC == min(AIC3_M313$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "M313",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_bal[Best_mods.P_bal$Code == "M313",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_M313.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M313.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "M313",]$ge.variance <- vcov(get(paste("nls_M313.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "M313",]$phi.variance <- vcov(get(paste("nls_M313.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "M313",]$alpha.variance <- vcov(get(paste("nls_M313.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "M313",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M313",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M313",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M313",]$a <- coefs["a"]
nls.param.df_bal[nls.param.df_bal$Code == "M313",]$b <- coefs["b"]
nls.param.df_bal[nls.param.df_bal$Code == "M313",]$c <- coefs["c"]
nls.param.df_bal[nls.param.df_bal$Code == "M313",]$d <- coefs["d"]

nls.param.df_bal[nls.param.df_bal$Code == "M313",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M313",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M313",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M313",]$a.2.5 <- intervals_low["a"]
nls.param.df_bal[nls.param.df_bal$Code == "M313",]$b.2.5 <- intervals_low["b"]
nls.param.df_bal[nls.param.df_bal$Code == "M313",]$c.2.5 <- intervals_low["c"]
nls.param.df_bal[nls.param.df_bal$Code == "M313",]$d.2.5 <- intervals_low["d"]

nls.param.df_bal[nls.param.df_bal$Code == "M313",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M313",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M313",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M313",]$a.97.5 <- intervals_high["a"]
nls.param.df_bal[nls.param.df_bal$Code == "M313",]$b.97.5 <- intervals_high["b"]
nls.param.df_bal[nls.param.df_bal$Code == "M313",]$c.97.5 <- intervals_high["c"]
nls.param.df_bal[nls.param.df_bal$Code == "M313",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_M313.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_M313.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_M313.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_M313.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {
  
## calculate residuals
resid_M313 <- nlsResiduals(
  get(paste("nls_M313.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_M313)

## test residuals
if(length(G_M313$pltID) < 5001) {test.nlsResiduals(resid_M313)}

}   else {print("cannot plot residuals")}
```


### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_M313_pred <- predict(get(paste("nls_M313.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M313$MEASTIME_t2, na.rm = T), max(G_M313$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M313$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M313$MEASTIME_t2, na.rm = T), max(G_M313$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M313$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_M313$DeltaPDSI, na.rm = T), max(G_M313$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M313$MEASTIME_t2, na.rm = T), max(G_M313$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M313$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_M313$B_L_prop, na.rm = T), max(G_M313$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_M313$DeltaPDSI, na.rm = T), max(G_M313$STDAGE_t2)))
                      } )

G_M313_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_M313$STDAGE_t2),by = 1),  
                            "fitted"=G_M313_pred)

## plot
gg.M313 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M313, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M313, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M313))), breaks = cutvec_M313) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_M313_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_M313_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("M313 - Arizona-New Mexico Mountains Semi-Desert - Open Woodland - Coniferous Forest - Alpine Meadow") + 
          
          #ylim(0, max(G_M313_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_M313,1)*1.05), expand = c(0,0))

gg.M313

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_M313 <- data.frame(
  bin = as.factor(levels(cut(G_M313$STDAGE_t2, cutvec_M313))),
  data.mean = tapply(G_M313$B_plt_t2_MgHa, cut(G_M313$STDAGE_t2, cutvec_M313), 
                     mean), 
  data.CI.high =  tapply(G_M313$B_plt_t2_MgHa, cut(G_M313$STDAGE_t2, cutvec_M313), 
                    high.CI), 
  data.CI.low = tapply(G_M313$B_plt_t2_MgHa, cut(G_M313$STDAGE_t2, cutvec_M313),
                    low.CI), 
  pred.mean = G_M313_pred_df[G_M313_pred_df$STDAGE_t2 %in% bin_mids_M313,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M313 <-  DM_compare_M313 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M313$bin)[gtools::mixedorder(levels(DM_compare_M313$bin))]))

## ggplot
gg.M313.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M313) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M313))), 
                              labels = levels(DM_compare_M313$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("M313 - Arizona-New Mexico Mountains Semi-Desert - Open Woodland - Coniferous Forest - Alpine Meadow",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +         
           theme_classic() + 
           # xlim(min(DM_compare_M313$data.CI.low)-0.25, max(DM_compare_M313$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_M313$pred.CI.low)-0.25, max(DM_compare_M313$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M313.B2

}
```

## M331 - Southern Rocky Mountain Steppe - Open Woodland - Coniferous Forest - Alpine Meadow
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_M331 <- round(quantile(G_M331$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M331)))){
  cutvec_M331 <- round(quantile(G_M331$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_M331 <- unname(round(cutvec_M331[-length(cutvec_M331)] + diff(cutvec_M331)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_M331$STDAGE_t2_bin<-  cut(G_M331$STDAGE_t2, cutvec_M313)
## then get bin means
G_M331_bin_means <- tapply(G_M331$B_plt_t2_MgHa, cut(G_M331$STDAGE_t2,  cutvec_M313), mean)

## make column weights.2
G_M331$nls_weights.2 <- as.numeric(1/(G_M331_bin_means[match(G_M331$STDAGE_t2_bin, names(G_M331_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_M331.1 <- nls(f_1, data = G_M331, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_M331$nls_weights.2), 
 )

## phi
try(
  nls_M331.2 <- nls(f_2, data=G_M331, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_M331$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M331.3 <- nls(f_3 , data = G_M331, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_M331$nls_weights.2), 
 )

## test
if(exists("nls_M331.1") & exists("nls_M331.2") & exists("nls_M331.3")){
  print(anova(nls_M331.1, nls_M331.2, nls_M331.3))
} else if(exists("nls_M331.2") & exists("nls_M331.3")){
  print(anova(nls_M331.2, nls_M331.3))
} else if(exists("nls_M331.1") & exists("nls_M331.2")){
  print(anova(nls_M331.1, nls_M331.2))
}
 
## AIC comparison
AIC1_M331 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_M331.1"), AIC(get("nls_M331.1")), NA),
            ifelse(exists("nls_M331.2"), AIC(get("nls_M331.2")), NA),
            ifelse(exists("nls_M331.3"), AIC(get("nls_M331.3")), NA)
            ))

print(AIC1_M331) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M331[!is.na(AIC1_M331$AIC) &AIC1_M331$AIC == min(AIC1_M331$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M331.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_M331.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M331.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_M331.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M331.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M331.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_M331.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_M331.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M331.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M331.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_M331,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_M331$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M331.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_M331,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_M331$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_M331.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_M331,
          sstart = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_M331$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M331.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M331.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M331.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M331.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M331.", Mod.Sel1, sep ="")),
             get(paste("nls_M331.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M331.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M331.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M331.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M331.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M331.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M331.", Mod.Sel1, sep ="")),
               get(paste("nls_M331.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M331.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M331.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M331.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M331.", Mod.Sel1, sep ="")),
                 get(paste("nls_M331.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M331.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M331.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M331.", Mod.Sel1, sep ="")),
                    get(paste("nls_M331.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M331.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M331.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M331.", Mod.Sel1, sep ="")),
                      get(paste("nls_M331.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M331 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M331.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M331.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M331.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M331.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M331.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M331.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M331.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M331.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M331)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M331[!is.na(AIC2_M331$AIC) & AIC2_M331$AIC == min(AIC2_M331$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "M331",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M331.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M331.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "M313",]$ge.variance <- vcov(get(paste("nls_M331.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "M331",]$phi.variance <- vcov(get(paste("nls_M331.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "M331",]$alpha.variance <- vcov(get(paste("nls_M331.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "M331",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M331",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M331",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M331",]$A <- coefs["A"]
nls.param.df_bal[nls.param.df_bal$Code == "M331",]$k <- coefs["k"]

nls.param.df_bal[nls.param.df_bal$Code == "M331",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M331",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M331",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M331",]$A.2.5 <- intervals_low["A"]
nls.param.df_bal[nls.param.df_bal$Code == "M331",]$k.2.5 <- intervals_low["k"]

nls.param.df_bal[nls.param.df_bal$Code == "M331",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M331",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M331",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M331",]$A.97.5 <- intervals_high["A"]
nls.param.df_bal[nls.param.df_bal$Code == "M331",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M331.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M331.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M331.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M331.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_M331$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_M331.4 <- nls(f_4, data = G_M331, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M331$nls_weights.2), 
 )

## phi
try(
  nls_M331.5 <- nls(f_5, data=G_M331, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M331$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M331.6 <- nls(f_6, data = G_M331, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M331$nls_weights.2), 
 )

## test
if(exists("nls_M331.4") & exists("nls_M331.5") & exists("nls_M331.6")){
  print(anova(nls_M331.4, nls_M331.5, nls_M331.6))
} else if(exists("nls_M331.4") & exists("nls_M331.6")){
  print(anova(nls_M331.4, nls_M331.6))
} else if(exists("nls_M331.5") & exists("nls_M331.6")){
  print(anova(nls_M331.5, nls_M331.6))
} else if(exists("nls_M331.4") & exists("nls_M331.5")){
  print(anova(nls_M331.4, nls_M331.5))
}

## AIC comparison
AIC3_M331 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_M331[AIC2_M331$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_M331.4"), AIC(get("nls_M331.4")), NA),
            ifelse(exists("nls_M331.5"), AIC(get("nls_M331.5")), NA),
            ifelse(exists("nls_M331.6"), AIC(get("nls_M331.6")), NA)
            ))

print(AIC3_M331) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_M331[!is.na(AIC3_M331$AIC) & AIC3_M331$AIC == min(AIC3_M331$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "M331",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_bal[Best_mods.P_bal$Code == "M331",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_M331.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M331.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "M331",]$ge.variance <- vcov(get(paste("nls_M331.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "M331",]$phi.variance <- vcov(get(paste("nls_M331.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "M331",]$alpha.variance <- vcov(get(paste("nls_M331.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "M331",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M331",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M331",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M331",]$a <- coefs["a"]
nls.param.df_bal[nls.param.df_bal$Code == "M331",]$b <- coefs["b"]
nls.param.df_bal[nls.param.df_bal$Code == "M331",]$c <- coefs["c"]
nls.param.df_bal[nls.param.df_bal$Code == "M331",]$d <- coefs["d"]

nls.param.df_bal[nls.param.df_bal$Code == "M331",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M331",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M331",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M331",]$a.2.5 <- intervals_low["a"]
nls.param.df_bal[nls.param.df_bal$Code == "M331",]$b.2.5 <- intervals_low["b"]
nls.param.df_bal[nls.param.df_bal$Code == "M331",]$c.2.5 <- intervals_low["c"]
nls.param.df_bal[nls.param.df_bal$Code == "M331",]$d.2.5 <- intervals_low["d"]

nls.param.df_bal[nls.param.df_bal$Code == "M331",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M331",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M331",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M331",]$a.97.5 <- intervals_high["a"]
nls.param.df_bal[nls.param.df_bal$Code == "M331",]$b.97.5 <- intervals_high["b"]
nls.param.df_bal[nls.param.df_bal$Code == "M331",]$c.97.5 <- intervals_high["c"]
nls.param.df_bal[nls.param.df_bal$Code == "M331",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_M331.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_M331.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_M331.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_M331.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {
  
## calculate residuals
resid_M331 <- nlsResiduals(
  get(paste("nls_M331.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_M331)

## test residuals
if(length(G_M331$pltID) < 5001) {test.nlsResiduals(resid_M331)}

}   else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_M331_pred <- predict(get(paste("nls_M331.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M331$MEASTIME_t2, na.rm = T), max(G_M331$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M331$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M331$MEASTIME_t2, na.rm = T), max(G_M331$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M331$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_M331$DeltaPDSI, na.rm = T), max(G_M331$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M331$MEASTIME_t2, na.rm = T), max(G_M331$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M331$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_M331$B_L_prop, na.rm = T), max(G_M331$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_M331$DeltaPDSI, na.rm = T), max(G_M331$STDAGE_t2)))
                      } )


G_M331_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_M331$STDAGE_t2),by = 1),  
                            "fitted"=G_M331_pred)

## plot
gg.M331 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M331, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M331, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M331))), breaks = cutvec_M331) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_M331_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_M331_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("M331 - Southern Rocky Mountain Steppe - Open Woodland - Coniferous Forest - Alpine Meadow") + 
          
          #ylim(0, max(G_M331_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_M331,1)*1.05), expand = c(0,0))

gg.M331

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_M331 <- data.frame(
  bin = as.factor(levels(cut(G_M331$STDAGE_t2, cutvec_M331))),
  data.mean = tapply(G_M331$B_plt_t2_MgHa, cut(G_M331$STDAGE_t2, cutvec_M331), 
                     mean), 
  data.CI.high =  tapply(G_M331$B_plt_t2_MgHa, cut(G_M331$STDAGE_t2, cutvec_M331), 
                    high.CI), 
  data.CI.low = tapply(G_M331$B_plt_t2_MgHa, cut(G_M331$STDAGE_t2, cutvec_M331),
                    low.CI), 
  pred.mean = G_M331_pred_df[G_M331_pred_df$STDAGE_t2 %in% bin_mids_M331,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M331 <-  DM_compare_M331 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M331$bin)[gtools::mixedorder(levels(DM_compare_M331$bin))]))

## ggplot
gg.M331.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M331) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M331))), 
                              labels = levels(DM_compare_M331$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("M331 - Southern Rocky Mountain Steppe - Open Woodland - Coniferous Forest - Alpine Meadow",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +     
           theme_classic() + 
           # xlim(min(DM_compare_M331$data.CI.low)-0.25, max(DM_compare_M331$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_M331$pred.CI.low)-0.25, max(DM_compare_M331$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M331.B2

}
```

## M332 - Middle Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_M332 <- round(quantile(G_M332$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M332)))){
  cutvec_M332 <- round(quantile(G_M332$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_M332 <- unname(round(cutvec_M332[-length(cutvec_M332)] + diff(cutvec_M332)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_M332$STDAGE_t2_bin<-  cut(G_M332$STDAGE_t2, cutvec_M332)
## then get bin means
G_M332_bin_means <- tapply(G_M332$B_plt_t2_MgHa, cut(G_M332$STDAGE_t2,  cutvec_M332), mean)

## make column weights.2
G_M332$nls_weights.2 <- as.numeric(1/(G_M332_bin_means[match(G_M332$STDAGE_t2_bin, names(G_M332_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_M332.1 <- nls(f_1, data = G_M332, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_M332$nls_weights.2), 
 )

## phi
try(
  nls_M332.2 <- nls(f_2, data=G_M332, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_M332$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M332.3 <- nls(f_3 , data = G_M332, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_M332$nls_weights.2), 
 )

## test
if(exists("nls_M332.1") & exists("nls_M332.2") & exists("nls_M332.3")){
  print(anova(nls_M332.1, nls_M332.2, nls_M332.3))
} else if(exists("nls_M332.2") & exists("nls_M332.3")){
  print(anova(nls_M332.2, nls_M332.3))
} else if(exists("nls_M332.1") & exists("nls_M332.2")){
  print(anova(nls_M332.1, nls_M332.2))
}
 
## AIC comparison
AIC1_M332 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_M332.1"), AIC(get("nls_M332.1")), NA),
            ifelse(exists("nls_M332.2"), AIC(get("nls_M332.2")), NA),
            ifelse(exists("nls_M332.3"), AIC(get("nls_M332.3")), NA)
            ))

print(AIC1_M332) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M332[!is.na(AIC1_M332$AIC) &AIC1_M332$AIC == min(AIC1_M332$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M332.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_M332.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M332.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_M332.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M332.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M332.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_M332.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_M332.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M332.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M332.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_M332,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_M332$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M332.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_M332,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_M332$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_M332.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_M332,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_M332$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M332.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M332.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M332.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M332.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M332.", Mod.Sel1, sep ="")),
             get(paste("nls_M332.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M332.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M332.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M332.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M332.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M332.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M332.", Mod.Sel1, sep ="")),
               get(paste("nls_M332.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M332.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M332.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M332.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M332.", Mod.Sel1, sep ="")),
                 get(paste("nls_M332.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M332.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M332.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M332.", Mod.Sel1, sep ="")),
                    get(paste("nls_M332.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M332.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M332.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M332.", Mod.Sel1, sep ="")),
                      get(paste("nls_M332.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M332 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M332.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M332.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M332.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M332.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M332.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M332.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M332.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M332.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M332)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M332[!is.na(AIC2_M332$AIC) & AIC2_M332$AIC == min(AIC2_M332$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "M332",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M332.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M332.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "M332",]$ge.variance <- vcov(get(paste("nls_M332.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "M332",]$phi.variance <- vcov(get(paste("nls_M332.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "M332",]$alpha.variance <- vcov(get(paste("nls_M332.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "M332",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M332",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M332",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M332",]$A <- coefs["A"]
nls.param.df_bal[nls.param.df_bal$Code == "M332",]$k <- coefs["k"]

nls.param.df_bal[nls.param.df_bal$Code == "M332",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M332",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M332",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M332",]$A.2.5 <- intervals_low["A"]
nls.param.df_bal[nls.param.df_bal$Code == "M332",]$k.2.5 <- intervals_low["k"]

nls.param.df_bal[nls.param.df_bal$Code == "M332",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M332",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M332",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M332",]$A.97.5 <- intervals_high["A"]
nls.param.df_bal[nls.param.df_bal$Code == "M332",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M332.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M332.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M332.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M332.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_M332$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_M332.4 <- nls(f_4, data = G_M332, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M332$nls_weights.2), 
 )

## phi
try(
  nls_M332.5 <- nls(f_5, data=G_M332, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M332$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M332.6 <- nls(f_6, data = G_M332, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M332$nls_weights.2), 
 )

## test
if(exists("nls_M332.4") & exists("nls_M332.5") & exists("nls_M332.6")){
  print(anova(nls_M332.4, nls_M332.5, nls_M332.6))
} else if(exists("nls_M332.4") & exists("nls_M332.6")){
  print(anova(nls_M332.4, nls_M332.6))
} else if(exists("nls_M332.5") & exists("nls_M332.6")){
  print(anova(nls_M332.5, nls_M332.6))
} else if(exists("nls_M332.4") & exists("nls_M332.5")){
  print(anova(nls_M332.4, nls_M332.5))
}

## AIC comparison
AIC3_M332 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_M332[AIC2_M332$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_M332.4"), AIC(get("nls_M332.4")), NA),
            ifelse(exists("nls_M332.5"), AIC(get("nls_M332.5")), NA),
            ifelse(exists("nls_M332.6"), AIC(get("nls_M332.6")), NA)
            ))

print(AIC3_M332) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_M332[!is.na(AIC3_M332$AIC) & AIC3_M332$AIC == min(AIC3_M332$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "M332",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_bal[Best_mods.P_bal$Code == "M332",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_M332.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M332.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "M332",]$ge.variance <- vcov(get(paste("nls_M332.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "M332",]$phi.variance <- vcov(get(paste("nls_M332.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "M332",]$alpha.variance <- vcov(get(paste("nls_M332.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "M332",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M332",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M332",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M332",]$a <- coefs["a"]
nls.param.df_bal[nls.param.df_bal$Code == "M332",]$b <- coefs["b"]
nls.param.df_bal[nls.param.df_bal$Code == "M332",]$c <- coefs["c"]
nls.param.df_bal[nls.param.df_bal$Code == "M332",]$d <- coefs["d"]

nls.param.df_bal[nls.param.df_bal$Code == "M332",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M332",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M332",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M332",]$a.2.5 <- intervals_low["a"]
nls.param.df_bal[nls.param.df_bal$Code == "M332",]$b.2.5 <- intervals_low["b"]
nls.param.df_bal[nls.param.df_bal$Code == "M332",]$c.2.5 <- intervals_low["c"]
nls.param.df_bal[nls.param.df_bal$Code == "M332",]$d.2.5 <- intervals_low["d"]

nls.param.df_bal[nls.param.df_bal$Code == "M332",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M332",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M332",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M332",]$a.97.5 <- intervals_high["a"]
nls.param.df_bal[nls.param.df_bal$Code == "M332",]$b.97.5 <- intervals_high["b"]
nls.param.df_bal[nls.param.df_bal$Code == "M332",]$c.97.5 <- intervals_high["c"]
nls.param.df_bal[nls.param.df_bal$Code == "M332",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_M332.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_M332.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_M332.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_M332.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_M332 <- nlsResiduals(
  get(paste("nls_M332.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_M332)

## test residuals
if(length(G_M332$pltID) < 5001) {test.nlsResiduals(resid_M332)}

}   else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_M332_pred <- predict(get(paste("nls_M332.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M332$MEASTIME_t2, na.rm = T), max(G_M332$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M332$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M332$MEASTIME_t2, na.rm = T), max(G_M332$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M332$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_M332$DeltaPDSI, na.rm = T), max(G_M332$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M332$MEASTIME_t2, na.rm = T), max(G_M332$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M332$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_M332$B_L_prop, na.rm = T), max(G_M332$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_M332$DeltaPDSI, na.rm = T), max(G_M332$STDAGE_t2)))
                      } )

G_M332_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_M332$STDAGE_t2),by = 1),  
                            "fitted"=G_M332_pred)

## plot
gg.M332 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M332, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M332, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M332))), breaks = cutvec_M332) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_M332_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_M332_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("M332 - Middle Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow") + 
          
          #ylim(0, max(G_M332_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_M332,1)*1.05), expand = c(0,0))

gg.M332

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_M332 <- data.frame(
  bin = as.factor(levels(cut(G_M332$STDAGE_t2, cutvec_M332))),
  data.mean = tapply(G_M332$B_plt_t2_MgHa, cut(G_M332$STDAGE_t2, cutvec_M332), 
                     mean), 
  data.CI.high =  tapply(G_M332$B_plt_t2_MgHa, cut(G_M332$STDAGE_t2, cutvec_M332), 
                    high.CI), 
  data.CI.low = tapply(G_M332$B_plt_t2_MgHa, cut(G_M332$STDAGE_t2, cutvec_M332),
                    low.CI), 
  pred.mean = G_M332_pred_df[G_M332_pred_df$STDAGE_t2 %in% bin_mids_M332,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M332 <-  DM_compare_M332 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M332$bin)[gtools::mixedorder(levels(DM_compare_M332$bin))]))

## ggplot
gg.M332.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M332) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M332))), 
                              labels = levels(DM_compare_M332$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("M332 - Middle Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +       
           theme_classic() + 
           # xlim(min(DM_compare_M332$data.CI.low)-0.25, max(DM_compare_M332$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_M332$pred.CI.low)-0.25, max(DM_compare_M332$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M332.B2

}
```

## M333 - Northern Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_M333 <- round(quantile(G_M333$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M333)))){
  cutvec_M333 <- round(quantile(G_M333$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_M333 <- unname(round(cutvec_M333[-length(cutvec_M333)] + diff(cutvec_M333)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_M333$STDAGE_t2_bin<-  cut(G_M333$STDAGE_t2, cutvec_M333)
## then get bin means
G_M333_bin_means <- tapply(G_M333$B_plt_t2_MgHa, cut(G_M333$STDAGE_t2, cutvec_M333), mean)

## make column weights.2
G_M333$nls_weights.2 <- as.numeric(1/(G_M333_bin_means[match(G_M333$STDAGE_t2_bin, names(G_M333_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_M333.1 <- nls(f_1, data = G_M333, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_M333$nls_weights.2), 
 )

## phi
try(
  nls_M333.2 <- nls(f_2, data=G_M333, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_M333$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M333.3 <- nls(f_3 , data = G_M333, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_M333$nls_weights.2), 
 )

## test
if(exists("nls_M333.1") & exists("nls_M333.2") & exists("nls_M333.3")){
  print(anova(nls_M333.1, nls_M333.2, nls_M333.3))
} else if(exists("nls_M333.2") & exists("nls_M333.3")){
  print(anova(nls_M333.2, nls_M333.3))
} else if(exists("nls_M333.1") & exists("nls_M333.2")){
  print(anova(nls_M333.1, nls_M333.2))
}
 
## AIC comparison
AIC1_M333 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_M333.1"), AIC(get("nls_M333.1")), NA),
            ifelse(exists("nls_M333.2"), AIC(get("nls_M333.2")), NA),
            ifelse(exists("nls_M333.3"), AIC(get("nls_M333.3")), NA)
            ))

print(AIC1_M333) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M333[!is.na(AIC1_M333$AIC) &AIC1_M333$AIC == min(AIC1_M333$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M333.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_M333.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M333.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_M333.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M333.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M333.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_M333.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_M333.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M333.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M333.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_M333,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_M333$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M333.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_M333,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_M333$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_M333.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_M333,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_M333$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M333.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M333.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M333.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M333.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M333.", Mod.Sel1, sep ="")),
             get(paste("nls_M333.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M333.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M333.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M333.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M333.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M333.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M333.", Mod.Sel1, sep ="")),
               get(paste("nls_M333.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M333.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M333.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M333.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M333.", Mod.Sel1, sep ="")),
                 get(paste("nls_M333.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M333.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M333.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M333.", Mod.Sel1, sep ="")),
                    get(paste("nls_M333.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M333.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M333.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M333.", Mod.Sel1, sep ="")),
                      get(paste("nls_M333.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M333 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M333.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M333.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M333.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M333.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M333.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M333.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M333.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M333.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M333)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M333[!is.na(AIC2_M333$AIC) & AIC2_M333$AIC == min(AIC2_M333$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "M333",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M333.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M333.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "M333",]$ge.variance <- vcov(get(paste("nls_M333.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "M333",]$phi.variance <- vcov(get(paste("nls_M333.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "M333",]$alpha.variance <- vcov(get(paste("nls_M333.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "M333",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M333",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M333",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M333",]$A <- coefs["A"]
nls.param.df_bal[nls.param.df_bal$Code == "M333",]$k <- coefs["k"]

nls.param.df_bal[nls.param.df_bal$Code == "M333",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M333",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M333",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M333",]$A.2.5 <- intervals_low["A"]
nls.param.df_bal[nls.param.df_bal$Code == "M333",]$k.2.5 <- intervals_low["k"]

nls.param.df_bal[nls.param.df_bal$Code == "M333",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M333",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M333",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M333",]$A.97.5 <- intervals_high["A"]
nls.param.df_bal[nls.param.df_bal$Code == "M333",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M333.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M333.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M333.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M333.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_M333$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_M333.4 <- nls(f_4, data = G_M333, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M333$nls_weights.2), 
 )

## phi
try(
  nls_M333.5 <- nls(f_5, data=G_M333, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M333$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M333.6 <- nls(f_6, data = G_M333, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M333$nls_weights.2), 
 )

## test
if(exists("nls_M333.4") & exists("nls_M333.5") & exists("nls_M333.6")){
  print(anova(nls_M333.4, nls_M333.5, nls_M333.6))
} else if(exists("nls_M333.4") & exists("nls_M333.6")){
  print(anova(nls_M333.4, nls_M333.6))
} else if(exists("nls_M333.5") & exists("nls_M333.6")){
  print(anova(nls_M333.5, nls_M333.6))
} else if(exists("nls_M333.4") & exists("nls_M333.5")){
  print(anova(nls_M333.4, nls_M333.5))
}

## AIC comparison
AIC3_M333 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_M333[AIC2_M333$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_M333.4"), AIC(get("nls_M333.4")), NA),
            ifelse(exists("nls_M333.5"), AIC(get("nls_M333.5")), NA),
            ifelse(exists("nls_M333.6"), AIC(get("nls_M333.6")), NA)
            ))

print(AIC3_M333) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_M333[!is.na(AIC3_M333$AIC) & AIC3_M333$AIC == min(AIC3_M333$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "M333",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_bal[Best_mods.P_bal$Code == "M333",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_M333.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M333.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "M333",]$ge.variance <- vcov(get(paste("nls_M333.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "M333",]$phi.variance <- vcov(get(paste("nls_M333.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "M333",]$alpha.variance <- vcov(get(paste("nls_M333.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "M333",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M333",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M333",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M333",]$a <- coefs["a"]
nls.param.df_bal[nls.param.df_bal$Code == "M333",]$b <- coefs["b"]
nls.param.df_bal[nls.param.df_bal$Code == "M333",]$c <- coefs["c"]
nls.param.df_bal[nls.param.df_bal$Code == "M333",]$d <- coefs["d"]

nls.param.df_bal[nls.param.df_bal$Code == "M333",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M333",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M333",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M333",]$a.2.5 <- intervals_low["a"]
nls.param.df_bal[nls.param.df_bal$Code == "M333",]$b.2.5 <- intervals_low["b"]
nls.param.df_bal[nls.param.df_bal$Code == "M333",]$c.2.5 <- intervals_low["c"]
nls.param.df_bal[nls.param.df_bal$Code == "M333",]$d.2.5 <- intervals_low["d"]

nls.param.df_bal[nls.param.df_bal$Code == "M333",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M333",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M333",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M333",]$a.97.5 <- intervals_high["a"]
nls.param.df_bal[nls.param.df_bal$Code == "M333",]$b.97.5 <- intervals_high["b"]
nls.param.df_bal[nls.param.df_bal$Code == "M333",]$c.97.5 <- intervals_high["c"]
nls.param.df_bal[nls.param.df_bal$Code == "M333",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_M333.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_M333.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_M333.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_M333.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_M333 <- nlsResiduals(
  get(paste("nls_M333.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_M333)

## test residuals
if(length(G_M333$pltID) < 5001) {test.nlsResiduals(resid_M333)}

}   else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_M333_pred <- predict(get(paste("nls_M333.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M333$MEASTIME_t2, na.rm = T), max(G_M333$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M333$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M333$MEASTIME_t2, na.rm = T), max(G_M333$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M333$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_M333$DeltaPDSI, na.rm = T), max(G_M333$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M333$MEASTIME_t2, na.rm = T), max(G_M333$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M333$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_M333$B_L_prop, na.rm = T), max(G_M333$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_M333$DeltaPDSI, na.rm = T), max(G_M333$STDAGE_t2)))
                      } )

G_M333_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_M333$STDAGE_t2),by = 1),  
                            "fitted"=G_M333_pred)

## plot
gg.M333 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M333, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M333, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M333))), breaks = cutvec_M333) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_M333_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_M333_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("M333 - Northern Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow") + 
          
          #ylim(0, max(G_M333_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_M333,1)*1.05), expand = c(0,0))

gg.M333

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_M333 <- data.frame(
  bin = as.factor(levels(cut(G_M333$STDAGE_t2, cutvec_M333))),
  data.mean = tapply(G_M333$B_plt_t2_MgHa, cut(G_M333$STDAGE_t2, cutvec_M333), 
                     mean), 
  data.CI.high =  tapply(G_M333$B_plt_t2_MgHa, cut(G_M333$STDAGE_t2, cutvec_M333), 
                    high.CI), 
  data.CI.low = tapply(G_M333$B_plt_t2_MgHa, cut(G_M333$STDAGE_t2, cutvec_M333),
                    low.CI), 
  pred.mean = G_M333_pred_df[G_M333_pred_df$STDAGE_t2 %in% bin_mids_M333,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M333 <-  DM_compare_M333 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M333$bin)[gtools::mixedorder(levels(DM_compare_M333$bin))]))

## ggplot
gg.M333.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M333) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M333))), 
                              labels = levels(DM_compare_M333$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("M333 - Northern Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +       
           theme_classic() + 
           # xlim(min(DM_compare_M333$data.CI.low)-0.25, max(DM_compare_M333$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_M333$pred.CI.low)-0.25, max(DM_compare_M333$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M333.B2

}
```

## M334 - Black Hills Coniferous Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_M334 <- round(quantile(G_M334$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M334)))){
  cutvec_M334 <- round(quantile(G_M334$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_M334 <- unname(round(cutvec_M334[-length(cutvec_M334)] + diff(cutvec_M334)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_M334$STDAGE_t2_bin<-  cut(G_M334$STDAGE_t2, cutvec_M334)
## then get bin means
G_M334_bin_means <- tapply(G_M334$B_plt_t2_MgHa, cut(G_M334$STDAGE_t2,  cutvec_M334), mean)

## make column weights.2
G_M334$nls_weights.2 <- as.numeric(1/(G_M334_bin_means[match(G_M334$STDAGE_t2_bin, names(G_M334_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_M334.1 <- nls(f_1, data = G_M334, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_M334$nls_weights.2), 
 )

## phi
try(
  nls_M334.2 <- nls(f_2, data=G_M334, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_M334$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M334.3 <- nls(f_3 , data = G_M334, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_M334$nls_weights.2), 
 )

## test
if(exists("nls_M334.1") & exists("nls_M334.2") & exists("nls_M334.3")){
  print(anova(nls_M334.1, nls_M334.2, nls_M334.3))
} else if(exists("nls_M334.2") & exists("nls_M334.3")){
  print(anova(nls_M334.2, nls_M334.3))
} else if(exists("nls_M334.1") & exists("nls_M334.2")){
  print(anova(nls_M334.1, nls_M334.2))
}
 
## AIC comparison
AIC1_M334 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_M334.1"), AIC(get("nls_M334.1")), NA),
            ifelse(exists("nls_M334.2"), AIC(get("nls_M334.2")), NA),
            ifelse(exists("nls_M334.3"), AIC(get("nls_M334.3")), NA)
            ))

print(AIC1_M334) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M334[!is.na(AIC1_M334$AIC) & AIC1_M334$AIC == min(AIC1_M334$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M334.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_M334.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M334.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_M334.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M334.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M334.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_M334.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_M334.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M334.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M334.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_M334,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_M334$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M334.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_M334,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_M334$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_M334.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_M334,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_M334$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M334.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M334.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M334.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M334.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M334.", Mod.Sel1, sep ="")),
             get(paste("nls_M334.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M334.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M334.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M334.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M334.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M334.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M334.", Mod.Sel1, sep ="")),
               get(paste("nls_M334.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M334.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M334.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M334.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M334.", Mod.Sel1, sep ="")),
                 get(paste("nls_M334.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M334.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M334.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M334.", Mod.Sel1, sep ="")),
                    get(paste("nls_M334.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M334.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M334.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M334.", Mod.Sel1, sep ="")),
                      get(paste("nls_M334.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M334 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M334.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M334.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M334.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M334.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M334.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M334.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M334.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M334.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M334)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M334[!is.na(AIC2_M334$AIC) & AIC2_M334$AIC == min(AIC2_M334$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "M334",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M334.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M334.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "M334",]$ge.variance <- vcov(get(paste("nls_M334.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "M334",]$phi.variance <- vcov(get(paste("nls_M334.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "M334",]$alpha.variance <- vcov(get(paste("nls_M334.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "M334",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M334",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M334",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M334",]$A <- coefs["A"]
nls.param.df_bal[nls.param.df_bal$Code == "M334",]$k <- coefs["k"]

nls.param.df_bal[nls.param.df_bal$Code == "M334",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M334",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M334",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M334",]$A.2.5 <- intervals_low["A"]
nls.param.df_bal[nls.param.df_bal$Code == "M334",]$k.2.5 <- intervals_low["k"]

nls.param.df_bal[nls.param.df_bal$Code == "M334",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M334",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M334",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M334",]$A.97.5 <- intervals_high["A"]
nls.param.df_bal[nls.param.df_bal$Code == "M334",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M334.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M334.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M334.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M334.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_M334$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_M334.4 <- nls(f_4, data = G_M334, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M334$nls_weights.2), 
 )

## phi
try(
  nls_M334.5 <- nls(f_5, data=G_M334, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M334$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M334.6 <- nls(f_6, data = G_M334, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M334$nls_weights.2), 
 )

## test
if(exists("nls_M334.4") & exists("nls_M334.5") & exists("nls_M334.6")){
  print(anova(nls_M334.4, nls_M334.5, nls_M334.6))
} else if(exists("nls_M334.4") & exists("nls_M334.6")){
  print(anova(nls_M334.4, nls_M334.6))
} else if(exists("nls_M334.5") & exists("nls_M334.6")){
  print(anova(nls_M334.5, nls_M334.6))
} else if(exists("nls_M334.4") & exists("nls_M334.5")){
  print(anova(nls_M334.4, nls_M334.5))
}

## AIC comparison
AIC3_M334 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_M334[AIC2_M334$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_M334.4"), AIC(get("nls_M334.4")), NA),
            ifelse(exists("nls_M334.5"), AIC(get("nls_M334.5")), NA),
            ifelse(exists("nls_M334.6"), AIC(get("nls_M334.6")), NA)
            ))

print(AIC3_M334) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_M334[!is.na(AIC3_M334$AIC) & AIC3_M334$AIC == min(AIC3_M334$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "M334",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_bal[Best_mods.P_bal$Code == "M334",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_M334.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M334.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "M334",]$ge.variance <- vcov(get(paste("nls_M334.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "M334",]$phi.variance <- vcov(get(paste("nls_M334.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "M334",]$alpha.variance <- vcov(get(paste("nls_M334.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "M334",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M334",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M334",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M334",]$a <- coefs["a"]
nls.param.df_bal[nls.param.df_bal$Code == "M334",]$b <- coefs["b"]
nls.param.df_bal[nls.param.df_bal$Code == "M334",]$c <- coefs["c"]
nls.param.df_bal[nls.param.df_bal$Code == "M334",]$d <- coefs["d"]

nls.param.df_bal[nls.param.df_bal$Code == "M334",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M334",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M334",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M334",]$a.2.5 <- intervals_low["a"]
nls.param.df_bal[nls.param.df_bal$Code == "M334",]$b.2.5 <- intervals_low["b"]
nls.param.df_bal[nls.param.df_bal$Code == "M334",]$c.2.5 <- intervals_low["c"]
nls.param.df_bal[nls.param.df_bal$Code == "M334",]$d.2.5 <- intervals_low["d"]

nls.param.df_bal[nls.param.df_bal$Code == "M334",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M334",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M334",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M334",]$a.97.5 <- intervals_high["a"]
nls.param.df_bal[nls.param.df_bal$Code == "M334",]$b.97.5 <- intervals_high["b"]
nls.param.df_bal[nls.param.df_bal$Code == "M334",]$c.97.5 <- intervals_high["c"]
nls.param.df_bal[nls.param.df_bal$Code == "M334",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_M334.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_M334.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_M334.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_M334.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_M334 <- nlsResiduals(
  get(paste("nls_M334.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_M334)

## test residuals
if(length(G_M334$pltID) < 5001) {test.nlsResiduals(resid_M334)}

}   else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_M334_pred <- predict(get(paste("nls_M334.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M334$MEASTIME_t2, na.rm = T), max(G_M334$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M334$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M334$MEASTIME_t2, na.rm = T), max(G_M334$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M334$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_M334$DeltaPDSI, na.rm = T), max(G_M334$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M334$MEASTIME_t2, na.rm = T), max(G_M334$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M334$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_M334$B_L_prop, na.rm = T), max(G_M334$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_M334$DeltaPDSI, na.rm = T), max(G_M334$STDAGE_t2)))
                      } )

G_M334_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_M334$STDAGE_t2),by = 1),  
                            "fitted"=G_M334_pred)

## plot
gg.M334 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M334, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M334, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M334))), breaks = cutvec_M334) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_M334_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_M334_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("M334 - Black Hills Coniferous Forest") + 
          
          #ylim(0, max(G_M334_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_M334,1)*1.05), expand = c(0,0))

gg.M334

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_M334 <- data.frame(
  bin = as.factor(levels(cut(G_M334$STDAGE_t2, cutvec_M334))),
  data.mean = tapply(G_M334$B_plt_t2_MgHa, cut(G_M334$STDAGE_t2, cutvec_M334), 
                     mean), 
  data.CI.high =  tapply(G_M334$B_plt_t2_MgHa, cut(G_M334$STDAGE_t2, cutvec_M334), 
                    high.CI), 
  data.CI.low = tapply(G_M334$B_plt_t2_MgHa, cut(G_M334$STDAGE_t2, cutvec_M334),
                    low.CI), 
  pred.mean = G_M334_pred_df[G_M334_pred_df$STDAGE_t2 %in% bin_mids_M334,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M334 <-  DM_compare_M334 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M334$bin)[gtools::mixedorder(levels(DM_compare_M334$bin))]))

## ggplot
gg.M334.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M334) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M334))), 
                              labels = levels(DM_compare_M334$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("M334 - Black Hills Coniferous Forest",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +        
           theme_classic() + 
           # xlim(min(DM_compare_M334$data.CI.low)-0.25, max(DM_compare_M334$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_M334$pred.CI.low)-0.25, max(DM_compare_M334$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M334.B2

}
```

## M341 - Nevada-Utah Mountains Semi-Desert - Coniferous Forest - Alpine Meadow
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_M341 <- round(quantile(G_M341$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M341)))){
  cutvec_M341 <- round(quantile(G_M341$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_M341 <- unname(round(cutvec_M341[-length(cutvec_M341)] + diff(cutvec_M341)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_M341$STDAGE_t2_bin<-  cut(G_M341$STDAGE_t2, cutvec_M341)
## then get bin means
G_M341_bin_means <- tapply(G_M341$B_plt_t2_MgHa, cut(G_M341$STDAGE_t2,  cutvec_M341), mean)

## make column weights.2
G_M341$nls_weights.2 <- as.numeric(1/(G_M341_bin_means[match(G_M341$STDAGE_t2_bin, names(G_M341_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_M341.1 <- nls(f_1, data = G_M341, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_M341$nls_weights.2), 
 )

## phi
try(
  nls_M341.2 <- nls(f_2, data=G_M341, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_M341$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M341.3 <- nls(f_3 , data = G_M341, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_M341$nls_weights.2), 
 )

## test
if(exists("nls_M341.1") & exists("nls_M341.2") & exists("nls_M341.3")){
  print(anova(nls_M341.1, nls_M341.2, nls_M341.3))
} else if(exists("nls_M341.2") & exists("nls_M341.3")){
  print(anova(nls_M341.2, nls_M341.3))
} else if(exists("nls_M341.1") & exists("nls_M341.2")){
  print(anova(nls_M341.1, nls_M341.2))
}
 
## AIC comparison
AIC1_M341 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_M341.1"), AIC(get("nls_M341.1")), NA),
            ifelse(exists("nls_M341.2"), AIC(get("nls_M341.2")), NA),
            ifelse(exists("nls_M341.3"), AIC(get("nls_M341.3")), NA)
            ))

print(AIC1_M341) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M341[!is.na(AIC1_M341$AIC) & AIC1_M341$AIC == min(AIC1_M341$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M341.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_M341.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M341.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_M341.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M341.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M341.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_M341.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_M341.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M341.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M341.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_M341,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_M341$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M341.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_M341,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_M341$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_M341.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_M341,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_M341$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M341.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M341.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M341.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M341.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M341.", Mod.Sel1, sep ="")),
             get(paste("nls_M341.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M341.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M341.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M341.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M341.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M341.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M341.", Mod.Sel1, sep ="")),
               get(paste("nls_M341.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M341.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M341.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M341.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M341.", Mod.Sel1, sep ="")),
                 get(paste("nls_M341.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M341.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M341.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M341.", Mod.Sel1, sep ="")),
                    get(paste("nls_M341.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M341.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M341.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M341.", Mod.Sel1, sep ="")),
                      get(paste("nls_M341.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M341 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M341.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M341.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M341.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M341.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M341.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M341.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M341.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M341.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M341)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M341[!is.na(AIC2_M341$AIC) & AIC2_M341$AIC == min(AIC2_M341$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "M341",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M341.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M341.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "M341",]$ge.variance <- vcov(get(paste("nls_M341.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "M341",]$phi.variance <- vcov(get(paste("nls_M341.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "M341",]$alpha.variance <- vcov(get(paste("nls_M341.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "M341",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M341",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M341",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M341",]$A <- coefs["A"]
nls.param.df_bal[nls.param.df_bal$Code == "M341",]$k <- coefs["k"]

nls.param.df_bal[nls.param.df_bal$Code == "M341",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M341",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M341",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M341",]$A.2.5 <- intervals_low["A"]
nls.param.df_bal[nls.param.df_bal$Code == "M341",]$k.2.5 <- intervals_low["k"]

nls.param.df_bal[nls.param.df_bal$Code == "M341",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M341",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M341",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M341",]$A.97.5 <- intervals_high["A"]
nls.param.df_bal[nls.param.df_bal$Code == "M341",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M341.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M341.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M341.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M341.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_M341$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_M341.4 <- nls(f_4, data = G_M341, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M341$nls_weights.2), 
 )

## phi
try(
  nls_M341.5 <- nls(f_5, data=G_M341, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M341$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M341.6 <- nls(f_6, data = G_M341, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M341$nls_weights.2), 
 )

## test
if(exists("nls_M341.4") & exists("nls_M341.5") & exists("nls_M341.6")){
  print(anova(nls_M341.4, nls_M341.5, nls_M341.6))
} else if(exists("nls_M341.4") & exists("nls_M341.6")){
  print(anova(nls_M341.4, nls_M341.6))
} else if(exists("nls_M341.5") & exists("nls_M341.6")){
  print(anova(nls_M341.5, nls_M341.6))
} else if(exists("nls_M341.4") & exists("nls_M341.5")){
  print(anova(nls_M341.4, nls_M341.5))
}

## AIC comparison
AIC3_M341 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_M341[AIC2_M341$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_M341.4"), AIC(get("nls_M341.4")), NA),
            ifelse(exists("nls_M341.5"), AIC(get("nls_M341.5")), NA),
            ifelse(exists("nls_M341.6"), AIC(get("nls_M341.6")), NA)
            ))

print(AIC3_M341) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_M341[!is.na(AIC3_M341$AIC) & AIC3_M341$AIC == min(AIC3_M341$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_bal[Best_mods.P_bal$Code == "M341",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_bal[Best_mods.P_bal$Code == "M341",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_M341.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M341.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_bal[nls.param.df_bal$Code == "M341",]$ge.variance <- vcov(get(paste("nls_M341.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_bal[nls.param.df_bal$Code == "M341",]$phi.variance <- vcov(get(paste("nls_M341.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_bal[nls.param.df_bal$Code == "M341",]$alpha.variance <- vcov(get(paste("nls_M341.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_bal[nls.param.df_bal$Code == "M341",]$ge <- coefs["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M341",]$phi <- coefs["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M341",]$alpha <- coefs["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M341",]$a <- coefs["a"]
nls.param.df_bal[nls.param.df_bal$Code == "M341",]$b <- coefs["b"]
nls.param.df_bal[nls.param.df_bal$Code == "M341",]$c <- coefs["c"]
nls.param.df_bal[nls.param.df_bal$Code == "M341",]$d <- coefs["d"]

nls.param.df_bal[nls.param.df_bal$Code == "M341",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M341",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M341",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M341",]$a.2.5 <- intervals_low["a"]
nls.param.df_bal[nls.param.df_bal$Code == "M341",]$b.2.5 <- intervals_low["b"]
nls.param.df_bal[nls.param.df_bal$Code == "M341",]$c.2.5 <- intervals_low["c"]
nls.param.df_bal[nls.param.df_bal$Code == "M341",]$d.2.5 <- intervals_low["d"]

nls.param.df_bal[nls.param.df_bal$Code == "M341",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_bal[nls.param.df_bal$Code == "M341",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_bal[nls.param.df_bal$Code == "M341",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_bal[nls.param.df_bal$Code == "M341",]$a.97.5 <- intervals_high["a"]
nls.param.df_bal[nls.param.df_bal$Code == "M341",]$b.97.5 <- intervals_high["b"]
nls.param.df_bal[nls.param.df_bal$Code == "M341",]$c.97.5 <- intervals_high["c"]
nls.param.df_bal[nls.param.df_bal$Code == "M341",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_M341.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_M341.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_M341.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_M341.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_M341 <- nlsResiduals(
  get(paste("nls_M341.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_M341)

## test residuals
if(length(G_M341$pltID) < 5001) {test.nlsResiduals(resid_M341)}

}   else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_M341_pred <- predict(get(paste("nls_M341.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M341$MEASTIME_t2, na.rm = T), max(G_M341$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M341$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M341$MEASTIME_t2, na.rm = T), max(G_M341$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M341$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_M341$DeltaPDSI, na.rm = T), max(G_M341$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M341$MEASTIME_t2, na.rm = T), max(G_M341$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M341$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_M341$B_L_prop, na.rm = T), max(G_M341$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_M341$DeltaPDSI, na.rm = T), max(G_M341$STDAGE_t2)))
                      } )

G_M341_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_M341$STDAGE_t2),by = 1),  
                            "fitted"=G_M341_pred)

## plot
gg.M341 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M341, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M341, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M341))), breaks = cutvec_M341) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_M341_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_M341_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("M341 - Nevada-Utah Mountains Semi-Desert - Coniferous Forest - Alpine Meadow") + 
          
          #ylim(0, max(G_M341_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_M341,1)*1.05), expand = c(0,0))

gg.M341

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_M341 <- data.frame(
  bin = as.factor(levels(cut(G_M341$STDAGE_t2, cutvec_M341))),
  data.mean = tapply(G_M341$B_plt_t2_MgHa, cut(G_M341$STDAGE_t2, cutvec_M341), 
                     mean), 
  data.CI.high =  tapply(G_M341$B_plt_t2_MgHa, cut(G_M341$STDAGE_t2, cutvec_M341), 
                    high.CI), 
  data.CI.low = tapply(G_M341$B_plt_t2_MgHa, cut(G_M341$STDAGE_t2, cutvec_M341),
                    low.CI), 
  pred.mean = G_M341_pred_df[G_M341_pred_df$STDAGE_t2 %in% bin_mids_M341,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M341 <-  DM_compare_M341 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M341$bin)[gtools::mixedorder(levels(DM_compare_M341$bin))]))

## ggplot
gg.M341.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M341) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M341))), 
                              labels = levels(DM_compare_M341$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("M341 - Nevada-Utah Mountains Semi-Desert - Coniferous Forest - Alpine Meadow",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +        
           theme_classic() + 
           # xlim(min(DM_compare_M341$data.CI.low)-0.25, max(DM_compare_M341$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_M341$pred.CI.low)-0.25, max(DM_compare_M341$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M341.B2

}
```

---

## Fitted parameters

### Best / selected models by ecoprovince 

```{r}
## clean up the Best_mods.P_bal dataframe
Best_mods.P_bal$Code <- as.factor(Best_mods.P_bal$Code)
Best_mods.P_bal$Ecoregion <- as.factor(Best_mods.P_bal$Ecoregion)

Best_mods.P_bal$Sel.Mod.2 <- as.factor(Best_mods.P_bal$Sel.Mod.2)
Best_mods.P_bal$Sel.Mod.3 <- as.factor(Best_mods.P_bal$Sel.Mod.3)
Best_mods.P_bal$Best.Mod <- as.factor(Best_mods.P_bal$Best.Mod)


knitr::kable(Best_mods.P_bal) %>% kableExtra::kable_material(c("striped", "hover"))        
```

### table by ecoprovince

```{r, echo = FALSE, cache= T, warning = FALSE}
## clean up the table -- remove the -9999
nls.param.df_bal[nls.param.df_bal == -9999] <- NA

knitr::kable(nls.param.df_bal) %>% kableExtra::kable_material(c("striped", "hover"))                      
```

### plot ge

```{r, echo= FALSE, message = FALSE, warning = FALSE, out.width = "200%"}
## order data
nls.param.df_bal$Ecoregion<- factor(nls.param.df_bal$Ecoregion, levels = nls.param.df_bal[rev(order(nls.param.df_bal$ge)), "Ecoregion"])

library(ggplot2)

#### create color vector 
col_vec.ge <- rep(NA, length(nls.param.df_bal$ge))

for (i in 1:length(nls.param.df_bal$ge)) {
  if(is.na(nls.param.df_bal$ge[i])){
     col_vec.ge[i] <-  "white"
  } else if(nls.param.df_bal$ge.2.5[i]>0) {
       col_vec.ge[i] <- scales::muted("green")  
    } else if(nls.param.df_bal$ge.97.5[i]<0){
          col_vec.ge[i] <- scales::muted("red") 
      } else {
              col_vec.ge[i] <- "gray50"
        }
}

## plot
gg.ge_ECOSUBCD <- ggplot(aes(x=Ecoregion, y=ge, shape = region), 
                        data = nls.param.df_bal) + 
                 geom_hline(yintercept =0, lty = 2) +
                 geom_point(size = 2, col = col_vec.ge) + 
                 geom_errorbar(aes(ymax = ge.2.5, ymin = ge.97.5), 
                               col = col_vec.ge) + 
                 theme_classic() + #coord_flip() + 
                 labs(y =expression(italic(ge)*" (% "*year^-1*")"), x = "Ecoregion") + 
                 scale_shape_manual(values = c(16,15,17)) + 
                 theme(legend.position = "top", 
                       axis.text.x = element_text(size = 5, angle = 45, hjust = 1, vjust = 1)) +
                 ylim(c(-6,8)) 

# tiff(file = "GE_nls3_plotB_StdAge_ReconciledG.tiff", width = 15, height = 12, units = "cm", res = 600, compression = "lzw")
gg.ge_ECOSUBCD
# dev.off()
```

#### map
```{r, message = F, warning = F}
############################################################
##################################### CODE FOR MAP PREP
############################################################

## libraries
library(tidyverse)
library(rgdal)
library(broom)
library(ggplot2)
library(ggpattern)
library(ggthemes)

############################################################
## read in the shape file 
spdf <- readOGR(dsn="C:/Users/hogan.jaaron/Dropbox/FIA_R/Mapping/S_USA.EcoMapProvinces/S_USA.EcoMapProvinces.shp")  
# spdf <- readOGR(dsn="C:/Users/hogie/Dropbox/FIA_R/Mapping/S_USA.EcoMapProvinces/S_USA.EcoMapProvinces.shp")       # if working on P-50

## change projection 
spdf <- spTransform(spdf, CRS("+init=epsg:5070"))

### tidy up 
spdf_tidy <- tidy(spdf)

## left_join
spdf$id <- row.names(spdf)
spdf_tidy <- left_join(spdf_tidy, spdf@data)

## add in the growth Enhancemnet data
## including missing rows
ge_df <-  data.frame( ECOPROVCD = as.factor(c(nls.param.df_bal$Code,"Water")), ge = as.numeric(c(nls.param.df_bal[,"ge"], NA)))

### add row for fill classification - statistically significant ge / data deficient etc.
ge_df$classification <- rep(NA, length(ge_df$ge))
  
for (i in 1:length(ge_df$ge)) {
  if(ge_df$ECOPROVCD[i] == "Water") {
    ge_df$classification[i] <- "Water"
    }else if(is.na(ge_df$ge[i])){
      ge_df$classification[i] <-  "data deficient"
      } else if(nls.param.df_bal$ge.2.5[i]>0) {
        ge_df$classification[i] <- "signif"  
        } else if(nls.param.df_bal$ge.97.5[i]<0) {
          ge_df$classification[i] <- "signif" 
          } else {
            ge_df$classification[i] <- "non-significant"
            } 
}

ge_df$classification <- as.factor(ge_df$classification)

### left_join
spdf_tidy <- left_join(spdf_tidy, ge_df, by = c("MAP_UNIT_S" = "ECOPROVCD"), keep = F)

############ ---------------------------------------------------------------------------------------  ############
######################### MAPPING ###################

## https://timogrossenbacher.ch/2016/12/beautiful-thematic-maps-with-ggplot2-only/

## theme
theme_map <- function(...) {
  theme_minimal() +
    theme(
      text = element_text(family = "Ubuntu Regular", color = "#22211d"),
      axis.line = element_blank(),
      axis.text.x = element_blank(),
      axis.text.y = element_blank(),
      axis.ticks = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      # panel.grid.minor = element_line(color = "#ebebe5", size = 0.2),
      panel.grid.major = element_line(color = "#ebebe5", size = 0.2),
      panel.grid.minor = element_blank(),
      plot.background = element_rect(fill = "#f5f5f2", color = NA), 
      panel.background = element_rect(fill = "#f5f5f2", color = NA), 
      legend.background = element_rect(fill = "#f5f5f2", color = NA),
      panel.border = element_blank(),
      ...
    )
}

```

```{r, message=F, warning = F}
library(ggnewscale)

mapper2  <- ggplot(aes(x = long, y = lat, group = group), data = spdf_tidy) +
  geom_polygon(aes_string(fill = "ge"), data = spdf_tidy[spdf_tidy$classification == "signif",], color = "black", size = 0.1)  +
  metR::scale_fill_divergent(
                       low = scales::muted("red"),
                       mid = "white",
                       high = scales::muted("green"),
                       name = "biomass stock enhancement (%/yr)",
                       # here we use guide_colourbar because it is still a continuous scale
                       guide = guide_colorbar(
                       direction = "horizontal",
                       barheight = unit(2, units = "mm"),
                       barwidth = unit(50, units = "mm"),
                       draw.ulim = F,
                       title.position = 'top',
                       # some shifting around
                       title.hjust = 0.5,
                       label.hjust = 0.5)) +   
  new_scale_fill() + 
  geom_polygon(aes_string(fill="classification"), data = spdf_tidy[!spdf_tidy$classification == "signif",], color = "black", size = 0.1)  +
  scale_fill_manual(values = c("#404040", "#BABABA", "dark blue")) +
  coord_equal() + theme(legend.position = "bottom") +
  theme_map() 
 

#+
  #geom_segment(data=lines, aes(x= x, y = y , xend = xend, yend = yend), 
               #inherit.aes = F, color = "black", alpha = 0.25)

# tiff(filename = "GE_mapper_biomass_age_11.7.22.tiff", width = 15, height = 8, units = "cm", res= 600, compression = "lzw")
mapper2

# dev.off()
```


### plot phi (effect of DeltaPDSI)

```{r, echo= FALSE, message = FALSE, warning = FALSE, out.width = "200%"}
## order data 
nls.param.df_bal <- nls.param.df_bal[order(nls.param.df_bal$phi),]

nls.param.df_bal$Ecoregion<- factor(nls.param.df_bal$Ecoregion, levels = nls.param.df_bal[order(nls.param.df_bal$phi), "Ecoregion"])

library(ggplot2)

#### create color vector 
col_vec.phi <- rep(NA, length(nls.param.df_bal$phi))

for (i in 1:length(nls.param.df_bal$phi)) {
  if(is.na(nls.param.df_bal$phi[i])){
     col_vec.phi[i] <-  "white"
  } else if(nls.param.df_bal$phi.2.5[i]>0) {
       col_vec.phi[i] <- scales::muted("blue") 
    } else if(nls.param.df_bal$phi.97.5[i]<0){
          col_vec.phi[i] <- scales::muted("orange")
      } else {
              col_vec.phi[i] <- "gray50"
        }
}

## plot
gg.phi_ECOSUBCD <- ggplot(aes(x=Ecoregion, y=phi, shape = region), 
                        data = nls.param.df_bal) + 
                 geom_hline(yintercept =0, lty = 2) +
                 geom_point(size = 2, col = col_vec.phi) + 
                 geom_errorbar(aes(ymax = phi.2.5, ymin = phi.97.5), 
                               col = col_vec.phi) + 
                 theme_classic() + #coord_flip() + 
                 labs(y = expression(italic("\u03D5")), x = "Ecoregion") + 
                 scale_shape_manual(values = c(16,15,17)) + 
                 theme(legend.position = "top",
                       axis.text.x = element_text(size = 5, angle = 45, hjust = 1, vjust = 1,)) +
                 ylim(c(-0.4,0.3))

#tiff(file = "nls_ge_byEcoregion_part1_9.2.2022.tiff", width = 25, height = 14, units = "cm", res = 600, compression = "lzw")
gg.phi_ECOSUBCD
#dev.off()
```

### plot alpha (biomass compensation effect)

```{r, echo= FALSE, message = FALSE, warning = FALSE, out.width = "200%"}
## order data
nls.param.df_bal <- nls.param.df_bal[order(nls.param.df_bal$alpha),]

nls.param.df_bal$Ecoregion<- factor(nls.param.df_bal$Ecoregion, levels = nls.param.df_bal[order(nls.param.df_bal$alpha), "Ecoregion"])

library(ggplot2)

## plot
gg.alpha_ECOSUBCD <- ggplot(aes(x=Ecoregion, y=alpha, shape = region), 
                        data = nls.param.df_bal) + 
                 geom_hline(yintercept = 0.5, lty = 2, col = "gray") +
                 geom_hline(yintercept = 1, lty = 2, col = "gray") +
                 geom_hline(yintercept = 0) +
                 #geom_hline(yintercept = -0.5, lty = 2, col = "gray") +
                 #geom_hline(yintercept = -1, lty = 2, col = "gray") +
                 geom_point(size = 2) + 
                 geom_errorbar(aes(ymax = alpha.2.5, ymin = alpha.97.5)) + 
                 theme_classic() + coord_flip() + 
                 labs(y =expression(italic("\u03B1")), x = "Ecoregion") + 
                 scale_shape_manual(values = c(16,15,17)) + 
                 theme(legend.position = "top") + ylim(c(-0.5,1.5))

#tiff(file = "nls_ge_byEcoregion_part1_9.2.2022.tiff", width = 25, height = 14, units = "cm", res = 600, compression = "lzw")
gg.alpha_ECOSUBCD
#dev.off()
```

### plot A (asymptote of B)

```{r}
## order data
nls.param.df_bal <- nls.param.df_bal[order(nls.param.df_bal$A),]

nls.param.df_bal$Ecoregion<- factor(nls.param.df_bal$Ecoregion, levels = nls.param.df_bal[order(nls.param.df_bal$A), "Ecoregion"])

library(ggplot2)

## plot
gg.A_ECOSUBCD <- ggplot(aes(x=Ecoregion, y=A, shape = region), 
                        data = nls.param.df_bal) + 
                 #geom_hline(yintercept =0, lty = 2) +
                 geom_point(size = 2) + 
                 geom_errorbar(aes(ymax = A.2.5, ymin = A.97.5)) + 
                 theme_classic() + coord_flip() + 
                 labs(y = expression(italic("A")*" (Mg ha"^-1*")"), x = "Ecoregion") + 
                 scale_shape_manual(values = c(16,15,17)) + 
                 theme(legend.position = "top") + ylim(c(0,1500))

#tiff(file = "nls_ge_byEcoregion_part1_9.2.2022.tiff", width = 25, height = 14, units = "cm", res = 600, compression = "lzw")
gg.A_ECOSUBCD
#dev.off()
```

### plot k (stand age at half biomass asymptote)

```{r}
## order data
nls.param.df_bal <- nls.param.df_bal[order(nls.param.df_bal$k),]

nls.param.df_bal$Ecoregion<- factor(nls.param.df_bal$Ecoregion, levels = nls.param.df_bal[order(nls.param.df_bal$k), "Ecoregion"])

library(ggplot2)

## plot
gg.k_ECOSUBCD <- ggplot(aes(x=Ecoregion, y=k, shape = region), 
                        data = nls.param.df_bal) + 
                 geom_hline(yintercept =0, lty = 2) +
                 geom_point(size = 2) + 
                 geom_errorbar(aes(ymax = k.2.5, ymin = k.97.5)) + 
                 theme_classic() + coord_flip() + 
                 labs(y = expression(italic("k")*" (yrs)"), x = "Ecoregion") + 
                 scale_shape_manual(values = c(16,15,17)) + 
                 theme(legend.position = "top") + ylim(c(-100,1500))

#tiff(file = "nls_ge_byEcoregion_part1_9.2.2022.tiff", width = 25, height = 14, units = "cm", res = 600, compression = "lzw")
gg.k_ECOSUBCD
#dev.off()
```

## Caclulations - weighted averages 

### ge (stand biomass enhancement factor in % 2000-2021)
```{r}
### set up for calculations 

## big N - the total number of plots all ecoprovs
N <- sum(nls.param.df_bal$`n.plots`)

## add weights 
nls.param.df_bal$weight.sq <- (nls.param.df_bal$n.plots / N)^2


weighted.ge.df <-  data.frame(
  region = c("entire US", "pacific",  "east", "interior west"),
## all
  "weighted ge" = c(sum(nls.param.df_bal$ge*nls.param.df_bal$n.plots, na.rm = T) / N,
                    
## pacific
sum(nls.param.df_bal[nls.param.df_bal$region == "pacific",]$ge * nls.param.df_bal[nls.param.df_bal$region == "pacific",]$n.plots, na.rm = T) / N,

## east 
sum(nls.param.df_bal[nls.param.df_bal$region == "east",]$ge * nls.param.df_bal[nls.param.df_bal$region == "east",]$n.plots, na.rm = T) / N,

## west
sum(nls.param.df_bal[nls.param.df_bal$region == "interior west",]$ge * nls.param.df_bal[nls.param.df_bal$region == "interior west",]$n.plots, na.rm = T) / N),

###############################
## weighted ge S.E. calculation
###############################

## all
  "weighted.ge.std_Error" = c(
    sqrt(sum(nls.param.df_bal$ge.variance * nls.param.df_bal$weight.sq, na.rm = T)),
    
## pacific
sqrt(sum(nls.param.df_bal[nls.param.df_bal$region == "pacific",]$ge.variance * nls.param.df_bal[nls.param.df_bal$region == "pacific",]$weight.sq, na.rm = T)),
                               
## east
sqrt(sum(nls.param.df_bal[nls.param.df_bal$region == "east",]$ge.variance * nls.param.df_bal[nls.param.df_bal$region == "east",]$weight.sq, na.rm = T)),

## west
sqrt(sum(nls.param.df_bal[nls.param.df_bal$region == "interior west",]$ge.variance * nls.param.df_bal[nls.param.df_bal$region == "interior west",]$weight.sq, na.rm = T)))

)

weighted.ge.df$`95 % CI, upper` <-  weighted.ge.df$weighted.ge + 1.96* weighted.ge.df$weighted.ge.std_Error

weighted.ge.df$`95 % CI, lower` <-  weighted.ge.df$weighted.ge - 1.96* weighted.ge.df$weighted.ge.std_Error


weighted.ge.df
```

### phi (effect of DeltaPDSI)
```{r}
weighted.phi.df <-  data.frame(
  region = c("entire US", "pacific", "east", "interior west"),
## all
  "weighted phi" = c(sum(nls.param.df_bal$phi*nls.param.df_bal$n.plots, na.rm = T) / N,
                    
## pacific
sum(nls.param.df_bal[nls.param.df_bal$region == "pacific",]$phi * nls.param.df_bal[nls.param.df_bal$region == "pacific",]$n.plots, na.rm = T) / N,

## east 
sum(nls.param.df_bal[nls.param.df_bal$region == "east",]$phi * nls.param.df_bal[nls.param.df_bal$region == "east",]$n.plots, na.rm = T) / N,

## west
sum(nls.param.df_bal[nls.param.df_bal$region == "interior west",]$phi * nls.param.df_bal[nls.param.df_bal$region == "interior west",]$n.plots, na.rm = T) / N),

###############################
## weighted ge S.E. calculation
###############################

## all
  "weighted.phi.std_Error" = c(
    sqrt(sum(nls.param.df_bal$phi.variance * nls.param.df_bal$weight.sq, na.rm = T)),
    
## pacific
sqrt(sum(nls.param.df_bal[nls.param.df_bal$region == "pacific",]$phi.variance * nls.param.df_bal[nls.param.df_bal$region == "pacific",]$weight.sq, na.rm = T)),
                               
## east
sqrt(sum(nls.param.df_bal[nls.param.df_bal$region == "east",]$phi.variance * nls.param.df_bal[nls.param.df_bal$region == "east",]$weight.sq, na.rm = T)),

## west
sqrt(sum(nls.param.df_bal[nls.param.df_bal$region == "interior west",]$phi.variance * nls.param.df_bal[nls.param.df_bal$region == "interior west",]$weight.sq, na.rm = T)))

)

weighted.phi.df$`95 % CI, upper` <-  weighted.phi.df$weighted.phi + 1.96* weighted.phi.df$weighted.phi.std_Error

weighted.phi.df$`95 % CI, lower` <-  weighted.phi.df$weighted.phi - 1.96* weighted.phi.df$weighted.phi.std_Error


weighted.phi.df
```

### alpha (biomass compensation effect)
```{r}
weighted.alpha.df <-  data.frame(
  region = c("entire US", "pacific", "east", "interior west"),
## all
  "weighted alpha" = c(sum(nls.param.df_bal$alpha * nls.param.df_bal$n.plots, na.rm = T) / N,
                    
## pacific
sum(nls.param.df_bal[nls.param.df_bal$region == "pacific",]$alpha * nls.param.df_bal[nls.param.df_bal$region == "pacific",]$n.plots, na.rm = T) / N,

## east 
sum(nls.param.df_bal[nls.param.df_bal$region == "east",]$alpha * nls.param.df_bal[nls.param.df_bal$region == "east",]$n.plots, na.rm = T) / N,

## west
sum(nls.param.df_bal[nls.param.df_bal$region == "interior west",]$alpha * nls.param.df_bal[nls.param.df_bal$region == "interior west",]$n.plots, na.rm = T) / N),

###############################
## weighted ge S.E. calculation
###############################

## all
  "weighted.alpha.std_Error" = c(
    sqrt(sum(nls.param.df_bal$alpha.variance * nls.param.df_bal$weight.sq, na.rm = T)),
    
## pacific
sqrt(sum(nls.param.df_bal[nls.param.df_bal$region == "pacific",]$alpha.variance * nls.param.df_bal[nls.param.df_bal$region == "pacific",]$weight.sq, na.rm = T)),
                               
## east
sqrt(sum(nls.param.df_bal[nls.param.df_bal$region == "east",]$alpha.variance * nls.param.df_bal[nls.param.df_bal$region == "east",]$weight.sq, na.rm = T)),

## west
sqrt(sum(nls.param.df_bal[nls.param.df_bal$region == "interior west",]$alpha.variance * nls.param.df_bal[nls.param.df_bal$region == "interior west",]$weight.sq, na.rm = T)))

)

weighted.alpha.df$`95 % CI, upper` <-  weighted.alpha.df$weighted.alpha + 1.96* weighted.alpha.df$weighted.alpha.std_Error

weighted.alpha.df$`95 % CI, lower` <-  weighted.alpha.df$weighted.alpha - 1.96* weighted.alpha.df$weighted.alpha.std_Error


weighted.alpha.df
```

### A (asymptote of forest biomass in Mg/ha)
```{r}
weighted.A.df <-  data.frame(
  region = c("entire US", "pacific",  "east", "interior west"),
  ## all
 "weighted A" = c(sum(nls.param.df_bal$A*nls.param.df_bal$n.plots, na.rm =T) /sum(nls.param.df_bal$n.plots, na.rm =T) 
,
## pacific
sum(nls.param.df_bal[nls.param.df_bal$region == "pacific",]$A * nls.param.df_bal[nls.param.df_bal$region == "pacific",]$n.plots, na.rm =T) / sum(nls.param.df_bal[nls.param.df_bal$region == "pacific",]$n.plots, na.rm =T) 
,
## east 
sum(nls.param.df_bal[nls.param.df_bal$region == "east",]$A * nls.param.df_bal[nls.param.df_bal$region == "east",]$n.plots, na.rm =T) / sum(nls.param.df_bal[nls.param.df_bal$region == "east",]$n.plots, na.rm =T)
,
## west
sum(nls.param.df_bal[nls.param.df_bal$region == "interior west",]$A * nls.param.df_bal[nls.param.df_bal$region == "west",]$n.plots, na.rm =T) / sum(nls.param.df_bal[nls.param.df_bal$region == "interior west",]$n.plots, na.rm =T)))


weighted.A.df
```


### K (stand age at half maturation in years)
```{r}
weighted.k.df <-  data.frame(
  region = c("entire US", "pacific", "east", "interior west"),
## all
 "weighted k" = c(sum(nls.param.df_bal$k*nls.param.df_bal$n.plots, na.rm =T) /sum(nls.param.df_bal$n.plots, na.rm =T) 
,
## pacific
sum(nls.param.df_bal[nls.param.df_bal$region == "pacific",]$k * nls.param.df_bal[nls.param.df_bal$region == "pacific",]$n.plots, na.rm =T) / sum(nls.param.df_bal[nls.param.df_bal$region == "pacific",]$n.plots, na.rm =T) 
,
## east 
sum(nls.param.df_bal[nls.param.df_bal$region == "east",]$k * nls.param.df_bal[nls.param.df_bal$region == "east",]$n.plots, na.rm =T) / sum(nls.param.df_bal[nls.param.df_bal$region == "east",]$n.plots, na.rm =T)
,
## west
sum(nls.param.df_bal[nls.param.df_bal$region == "interior west",]$k * nls.param.df_bal[nls.param.df_bal$region == "interior west",]$n.plots, na.rm =T) / sum(nls.param.df_bal[nls.param.df_bal$region == "interior west",]$n.plots, na.rm =T)))

weighted.k.df
```

---
```{r}
# # left join fitted values to data by STDAGE_t2
# G_211 <-  left_join(G_211,G_211_pred_df, by= c("STDAGE_t1"="STDAGE_t2"))
# colnames(G_211)[63] <- "B_plt_t1_pred" 
# 
# # left join fitted values to data by STDAGE_t2
# G_211 <-  left_join(G_211,G_211_pred_df)
# colnames(G_211)[64] <- "B_plt_t2_pred"  ## rename column 
# 
# # calculate delta-B due to delta STDAGE -- simple subtraction
# G_211$DeltaB_DeltaSTDAGE <- (G_211$B_plt_t2_pred - G_211$B_plt_t1_pred) / REMPER
```


## Model Bookeeping

### 1. Delta-B due to Delta-STDAGE

```{r}
#### 211

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "211",]$Best.Mod == "NA"){
    
    G_211$B_pred_age2 <- predict(get(paste("nls_211.",  Best_mods.P_bal[Best_mods.P_bal$Code == 211,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_211$MEASTIME_t1,
                                               "STDAGE_t2" = G_211$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_211$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_211$STDAGE_t2,
                                                 "DeltaPDSI" = G_211$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_211$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_211$STDAGE_t2,
                                                   "B_L_prop" = G_211$B_L_prop, 
                                                   "DeltaPDSI" = G_211$DeltaPDSI)
                                        } )
    
    G_211$B_pred_age1 <- predict(get(paste("nls_211.",  Best_mods.P_bal[Best_mods.P_bal$Code == 211,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_211$MEASTIME_t1,
                                               "STDAGE_t2" = G_211$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_211$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_211$STDAGE_t1,
                                                 "DeltaPDSI" = G_211$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_211$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_211$STDAGE_t1,
                                                   "B_L_prop" = G_211$B_L_prop, 
                                                   "DeltaPDSI" = G_211$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_211$DeltaB_age <- (G_211$B_pred_age2 - G_211$B_pred_age1) / G_211$REMPER
}
    
    
#### 212

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "212",]$Best.Mod == "NA"){
    
    G_212$B_pred_age2 <- predict(get(paste("nls_212.",  Best_mods.P_bal[Best_mods.P_bal$Code == 212,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_212$MEASTIME_t1,
                                               "STDAGE_t2" = G_212$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_212$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_212$STDAGE_t2,
                                                 "DeltaPDSI" = G_212$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_212$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_212$STDAGE_t2,
                                                   "B_L_prop" = G_212$B_L_prop, 
                                                   "DeltaPDSI" = G_212$DeltaPDSI)
                                        } )
    
    G_212$B_pred_age1 <- predict(get(paste("nls_212.",  Best_mods.P_bal[Best_mods.P_bal$Code == 212,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_212$MEASTIME_t1,
                                               "STDAGE_t2" = G_212$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_212$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_212$STDAGE_t1,
                                                 "DeltaPDSI" = G_212$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_212$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_212$STDAGE_t1,
                                                   "B_L_prop" = G_212$B_L_prop, 
                                                   "DeltaPDSI" = G_212$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_212$DeltaB_age <- (G_212$B_pred_age2 - G_212$B_pred_age1) / G_212$REMPER
}

#### 221

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "221",]$Best.Mod == "NA"){
    
    G_221$B_pred_age2 <- predict(get(paste("nls_221.",  Best_mods.P_bal[Best_mods.P_bal$Code == 221,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_221$MEASTIME_t1,
                                               "STDAGE_t2" = G_221$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_221$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_221$STDAGE_t2,
                                                 "DeltaPDSI" = G_221$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_221$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_221$STDAGE_t2,
                                                   "B_L_prop" = G_221$B_L_prop, 
                                                   "DeltaPDSI" = G_221$DeltaPDSI)
                                        } )
    
    G_221$B_pred_age1 <- predict(get(paste("nls_221.",  Best_mods.P_bal[Best_mods.P_bal$Code == 221,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_221$MEASTIME_t1,
                                               "STDAGE_t2" = G_221$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_221$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_221$STDAGE_t1,
                                                 "DeltaPDSI" = G_221$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_221$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_221$STDAGE_t1,
                                                   "B_L_prop" = G_221$B_L_prop, 
                                                   "DeltaPDSI" = G_221$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_221$DeltaB_age <- (G_221$B_pred_age2 - G_221$B_pred_age1) / G_221$REMPER
}

#### 222

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "222",]$Best.Mod == "NA"){
    
    G_222$B_pred_age2 <- predict(get(paste("nls_222.",  Best_mods.P_bal[Best_mods.P_bal$Code == 222,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_222$MEASTIME_t1,
                                               "STDAGE_t2" = G_222$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_222$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_222$STDAGE_t2,
                                                 "DeltaPDSI" = G_222$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_222$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_222$STDAGE_t2,
                                                   "B_L_prop" = G_222$B_L_prop, 
                                                   "DeltaPDSI" = G_222$DeltaPDSI)
                                        } )
    
    G_222$B_pred_age1 <- predict(get(paste("nls_222.",  Best_mods.P_bal[Best_mods.P_bal$Code == 222,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_222$MEASTIME_t1,
                                               "STDAGE_t2" = G_222$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_222$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_222$STDAGE_t1,
                                                 "DeltaPDSI" = G_222$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_222$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_222$STDAGE_t1,
                                                   "B_L_prop" = G_222$B_L_prop, 
                                                   "DeltaPDSI" = G_222$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_222$DeltaB_age <- (G_222$B_pred_age2 - G_222$B_pred_age1) / G_222$REMPER
}

#### 223

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "223",]$Best.Mod == "NA"){
    
    G_223$B_pred_age2 <- predict(get(paste("nls_223.",  Best_mods.P_bal[Best_mods.P_bal$Code == 223,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_223$MEASTIME_t1,
                                               "STDAGE_t2" = G_223$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_223$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_223$STDAGE_t2,
                                                 "DeltaPDSI" = G_223$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_223$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_223$STDAGE_t2,
                                                   "B_L_prop" = G_223$B_L_prop, 
                                                   "DeltaPDSI" = G_223$DeltaPDSI)
                                        } )
    
    G_223$B_pred_age1 <- predict(get(paste("nls_223.",  Best_mods.P_bal[Best_mods.P_bal$Code == 223,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_223$MEASTIME_t1,
                                               "STDAGE_t2" = G_223$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_223$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_223$STDAGE_t1,
                                                 "DeltaPDSI" = G_223$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_223$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_223$STDAGE_t1,
                                                   "B_L_prop" = G_223$B_L_prop, 
                                                   "DeltaPDSI" = G_223$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_223$DeltaB_age <- (G_223$B_pred_age2 - G_223$B_pred_age1) / G_223$REMPER
}

#### 231

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "231",]$Best.Mod == "NA"){
    
    G_231$B_pred_age2 <- predict(get(paste("nls_231.",  Best_mods.P_bal[Best_mods.P_bal$Code == 231,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_231$MEASTIME_t1,
                                               "STDAGE_t2" = G_231$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_231$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_231$STDAGE_t2,
                                                 "DeltaPDSI" = G_231$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_231$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_231$STDAGE_t2,
                                                   "B_L_prop" = G_231$B_L_prop, 
                                                   "DeltaPDSI" = G_231$DeltaPDSI)
                                        } )
    
    G_231$B_pred_age1 <- predict(get(paste("nls_231.",  Best_mods.P_bal[Best_mods.P_bal$Code == 231,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_231$MEASTIME_t1,
                                               "STDAGE_t2" = G_231$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_231$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_231$STDAGE_t1,
                                                 "DeltaPDSI" = G_231$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_231$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_231$STDAGE_t1,
                                                   "B_L_prop" = G_231$B_L_prop, 
                                                   "DeltaPDSI" = G_231$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_231$DeltaB_age <- (G_231$B_pred_age2 - G_231$B_pred_age1) / G_231$REMPER
}

#### 232

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "232",]$Best.Mod == "NA"){
    
    G_232$B_pred_age2 <- predict(get(paste("nls_232.",  Best_mods.P_bal[Best_mods.P_bal$Code == 232,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_232$MEASTIME_t1,
                                               "STDAGE_t2" = G_232$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_232$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_232$STDAGE_t2,
                                                 "DeltaPDSI" = G_232$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_232$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_232$STDAGE_t2,
                                                   "B_L_prop" = G_232$B_L_prop, 
                                                   "DeltaPDSI" = G_232$DeltaPDSI)
                                        } )
    
    G_232$B_pred_age1 <- predict(get(paste("nls_232.",  Best_mods.P_bal[Best_mods.P_bal$Code == 232,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_232$MEASTIME_t1,
                                               "STDAGE_t2" = G_232$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_232$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_232$STDAGE_t1,
                                                 "DeltaPDSI" = G_232$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_232$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_232$STDAGE_t1,
                                                   "B_L_prop" = G_232$B_L_prop, 
                                                   "DeltaPDSI" = G_232$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_232$DeltaB_age <- (G_232$B_pred_age2 - G_232$B_pred_age1) / G_232$REMPER
}

#### 234

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "234",]$Best.Mod == "NA"){
    
    G_234$B_pred_age2 <- predict(get(paste("nls_234.",  Best_mods.P_bal[Best_mods.P_bal$Code == 234,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_234$MEASTIME_t1,
                                               "STDAGE_t2" = G_234$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_234$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_234$STDAGE_t2,
                                                 "DeltaPDSI" = G_234$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_234$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_234$STDAGE_t2,
                                                   "B_L_prop" = G_234$B_L_prop, 
                                                   "DeltaPDSI" = G_234$DeltaPDSI)
                                        } )
    
    G_234$B_pred_age1 <- predict(get(paste("nls_234.",  Best_mods.P_bal[Best_mods.P_bal$Code == 234,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_234$MEASTIME_t1,
                                               "STDAGE_t2" = G_234$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_234$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_234$STDAGE_t1,
                                                 "DeltaPDSI" = G_234$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_234$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_234$STDAGE_t1,
                                                   "B_L_prop" = G_234$B_L_prop, 
                                                   "DeltaPDSI" = G_234$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_234$DeltaB_age <- (G_234$B_pred_age2 - G_234$B_pred_age1) / G_234$REMPER
}

#### 242

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "242",]$Best.Mod == "NA"){
    
    G_242$B_pred_age2 <- predict(get(paste("nls_242.",  Best_mods.P_bal[Best_mods.P_bal$Code == 242,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_242$MEASTIME_t1,
                                               "STDAGE_t2" = G_242$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_242$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_242$STDAGE_t2,
                                                 "DeltaPDSI" = G_242$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_242$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_242$STDAGE_t2,
                                                   "B_L_prop" = G_242$B_L_prop, 
                                                   "DeltaPDSI" = G_242$DeltaPDSI)
                                        } )
    
    G_242$B_pred_age1 <- predict(get(paste("nls_242.",  Best_mods.P_bal[Best_mods.P_bal$Code == 242,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_242$MEASTIME_t1,
                                               "STDAGE_t2" = G_242$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_242$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_242$STDAGE_t1,
                                                 "DeltaPDSI" = G_242$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_242$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_242$STDAGE_t1,
                                                   "B_L_prop" = G_242$B_L_prop, 
                                                   "DeltaPDSI" = G_242$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_242$DeltaB_age <- (G_242$B_pred_age2 - G_242$B_pred_age1) / G_242$REMPER
}

#### 251

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "251",]$Best.Mod == "NA"){
    
    G_251$B_pred_age2 <- predict(get(paste("nls_251.",  Best_mods.P_bal[Best_mods.P_bal$Code == 251,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_251$MEASTIME_t1,
                                               "STDAGE_t2" = G_251$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_251$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_251$STDAGE_t2,
                                                 "DeltaPDSI" = G_251$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_251$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_251$STDAGE_t2,
                                                   "B_L_prop" = G_251$B_L_prop, 
                                                   "DeltaPDSI" = G_251$DeltaPDSI)
                                        } )
    
    G_251$B_pred_age1 <- predict(get(paste("nls_251.",  Best_mods.P_bal[Best_mods.P_bal$Code == 251,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_251$MEASTIME_t1,
                                               "STDAGE_t2" = G_251$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_251$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_251$STDAGE_t1,
                                                 "DeltaPDSI" = G_251$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_251$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_251$STDAGE_t1,
                                                   "B_L_prop" = G_251$B_L_prop, 
                                                   "DeltaPDSI" = G_251$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_251$DeltaB_age <- (G_251$B_pred_age2 - G_251$B_pred_age1) / G_251$REMPER
}

#### 255

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "255",]$Best.Mod == "NA"){
    
    G_255$B_pred_age2 <- predict(get(paste("nls_255.",  Best_mods.P_bal[Best_mods.P_bal$Code == 255,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_255$MEASTIME_t1,
                                               "STDAGE_t2" = G_255$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_255$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_255$STDAGE_t2,
                                                 "DeltaPDSI" = G_255$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_255$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_255$STDAGE_t2,
                                                   "B_L_prop" = G_255$B_L_prop, 
                                                   "DeltaPDSI" = G_255$DeltaPDSI)
                                        } )
    
    G_255$B_pred_age1 <- predict(get(paste("nls_255.",  Best_mods.P_bal[Best_mods.P_bal$Code == 255,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_255$MEASTIME_t1,
                                               "STDAGE_t2" = G_255$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_255$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_255$STDAGE_t1,
                                                 "DeltaPDSI" = G_255$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_255$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_255$STDAGE_t1,
                                                   "B_L_prop" = G_255$B_L_prop, 
                                                   "DeltaPDSI" = G_255$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_255$DeltaB_age <- (G_255$B_pred_age2 - G_255$B_pred_age1) / G_255$REMPER
}

#### 261
if(!Best_mods.P_bal[Best_mods.P_bal$Code == "261",]$Best.Mod == "NA"){
    
    G_261$B_pred_age2 <- predict(get(paste("nls_261.",  Best_mods.P_bal[Best_mods.P_bal$Code == 261,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_261$MEASTIME_t1,
                                               "STDAGE_t2" = G_261$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_261$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_261$STDAGE_t2,
                                                 "DeltaPDSI" = G_261$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_261$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_261$STDAGE_t2,
                                                   "B_L_prop" = G_261$B_L_prop, 
                                                   "DeltaPDSI" = G_261$DeltaPDSI)
                                        } )
    
    G_261$B_pred_age1 <- predict(get(paste("nls_261.",  Best_mods.P_bal[Best_mods.P_bal$Code == 261,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_261$MEASTIME_t1,
                                               "STDAGE_t2" = G_261$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_261$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_261$STDAGE_t1,
                                                 "DeltaPDSI" = G_261$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_261$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_261$STDAGE_t1,
                                                   "B_L_prop" = G_261$B_L_prop, 
                                                   "DeltaPDSI" = G_261$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_261$DeltaB_age <- (G_261$B_pred_age2 - G_261$B_pred_age1) / G_261$REMPER
}

#### 262
if(!Best_mods.P_bal[Best_mods.P_bal$Code == "262",]$Best.Mod == "NA"){
    
    G_262$B_pred_age2 <- predict(get(paste("nls_262.",  Best_mods.P_bal[Best_mods.P_bal$Code == 262,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_262$MEASTIME_t1,
                                               "STDAGE_t2" = G_262$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_262$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_262$STDAGE_t2,
                                                 "DeltaPDSI" = G_262$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_262$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_262$STDAGE_t2,
                                                   "B_L_prop" = G_262$B_L_prop, 
                                                   "DeltaPDSI" = G_262$DeltaPDSI)
                                        } )
    
    G_262$B_pred_age1 <- predict(get(paste("nls_262.",  Best_mods.P_bal[Best_mods.P_bal$Code == 262,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_262$MEASTIME_t1,
                                               "STDAGE_t2" = G_262$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_262$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_262$STDAGE_t1,
                                                 "DeltaPDSI" = G_262$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_262$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_262$STDAGE_t1,
                                                   "B_L_prop" = G_262$B_L_prop, 
                                                   "DeltaPDSI" = G_262$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_262$DeltaB_age <- (G_262$B_pred_age2 - G_262$B_pred_age1) / G_262$REMPER
}

#### 263

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "263",]$Best.Mod == "NA"){
    
    G_263$B_pred_age2 <- predict(get(paste("nls_263.",  Best_mods.P_bal[Best_mods.P_bal$Code == 263,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_263$MEASTIME_t1,
                                               "STDAGE_t2" = G_263$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_263$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_263$STDAGE_t2,
                                                 "DeltaPDSI" = G_263$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_263$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_263$STDAGE_t2,
                                                   "B_L_prop" = G_263$B_L_prop, 
                                                   "DeltaPDSI" = G_263$DeltaPDSI)
                                        } )
    
    G_263$B_pred_age1 <- predict(get(paste("nls_263.",  Best_mods.P_bal[Best_mods.P_bal$Code == 263,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_263$MEASTIME_t1,
                                               "STDAGE_t2" = G_263$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_263$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_263$STDAGE_t1,
                                                 "DeltaPDSI" = G_263$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_263$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_263$STDAGE_t1,
                                                   "B_L_prop" = G_263$B_L_prop, 
                                                   "DeltaPDSI" = G_263$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_263$DeltaB_age <- (G_263$B_pred_age2 - G_263$B_pred_age1) / G_263$REMPER
}

#### 313

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "313",]$Best.Mod == "NA"){
    
    G_313$B_pred_age2 <- predict(get(paste("nls_313.",  Best_mods.P_bal[Best_mods.P_bal$Code == 313,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_313$MEASTIME_t1,
                                               "STDAGE_t2" = G_313$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_313$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_313$STDAGE_t2,
                                                 "DeltaPDSI" = G_313$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_313$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_313$STDAGE_t2,
                                                   "B_L_prop" = G_313$B_L_prop, 
                                                   "DeltaPDSI" = G_313$DeltaPDSI)
                                        } )
    
    G_313$B_pred_age1 <- predict(get(paste("nls_313.",  Best_mods.P_bal[Best_mods.P_bal$Code == 313,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_313$MEASTIME_t1,
                                               "STDAGE_t2" = G_313$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_313$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_313$STDAGE_t1,
                                                 "DeltaPDSI" = G_313$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_313$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_313$STDAGE_t1,
                                                   "B_L_prop" = G_313$B_L_prop, 
                                                   "DeltaPDSI" = G_313$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_313$DeltaB_age <- (G_313$B_pred_age2 - G_313$B_pred_age1) / G_313$REMPER
}

#### 315

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "315",]$Best.Mod == "NA"){
    
    G_315$B_pred_age2 <- predict(get(paste("nls_315.",  Best_mods.P_bal[Best_mods.P_bal$Code == 315,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_315$MEASTIME_t1,
                                               "STDAGE_t2" = G_315$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_315$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_315$STDAGE_t2,
                                                 "DeltaPDSI" = G_315$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_315$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_315$STDAGE_t2,
                                                   "B_L_prop" = G_315$B_L_prop, 
                                                   "DeltaPDSI" = G_315$DeltaPDSI)
                                        } )
    
    G_315$B_pred_age1 <- predict(get(paste("nls_315.",  Best_mods.P_bal[Best_mods.P_bal$Code == 315,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_315$MEASTIME_t1,
                                               "STDAGE_t2" = G_315$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_315$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_315$STDAGE_t1,
                                                 "DeltaPDSI" = G_315$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_315$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_315$STDAGE_t1,
                                                   "B_L_prop" = G_315$B_L_prop, 
                                                   "DeltaPDSI" = G_315$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_315$DeltaB_age <- (G_315$B_pred_age2 - G_315$B_pred_age1) / G_315$REMPER
}

#### 321

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "321",]$Best.Mod == "NA"){
    
    G_321$B_pred_age2 <- predict(get(paste("nls_321.",  Best_mods.P_bal[Best_mods.P_bal$Code == 321,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_321$MEASTIME_t1,
                                               "STDAGE_t2" = G_321$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_321$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_321$STDAGE_t2,
                                                 "DeltaPDSI" = G_321$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_321$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_321$STDAGE_t2,
                                                   "B_L_prop" = G_321$B_L_prop, 
                                                   "DeltaPDSI" = G_321$DeltaPDSI)
                                        } )
    
    G_321$B_pred_age1 <- predict(get(paste("nls_321.",  Best_mods.P_bal[Best_mods.P_bal$Code == 321,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_321$MEASTIME_t1,
                                               "STDAGE_t2" = G_321$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_321$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_321$STDAGE_t1,
                                                 "DeltaPDSI" = G_321$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_321$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_321$STDAGE_t1,
                                                   "B_L_prop" = G_321$B_L_prop, 
                                                   "DeltaPDSI" = G_321$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_321$DeltaB_age <- (G_321$B_pred_age2 - G_321$B_pred_age1) / G_321$REMPER
}

#### 322

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "322",]$Best.Mod == "NA"){
    
    G_322$B_pred_age2 <- predict(get(paste("nls_322.",  Best_mods.P_bal[Best_mods.P_bal$Code == 322,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_322$MEASTIME_t1,
                                               "STDAGE_t2" = G_322$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_322$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_322$STDAGE_t2,
                                                 "DeltaPDSI" = G_322$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_322$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_322$STDAGE_t2,
                                                   "B_L_prop" = G_322$B_L_prop, 
                                                   "DeltaPDSI" = G_322$DeltaPDSI)
                                        } )
    
    G_322$B_pred_age1 <- predict(get(paste("nls_322.",  Best_mods.P_bal[Best_mods.P_bal$Code == 322,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_322$MEASTIME_t1,
                                               "STDAGE_t2" = G_322$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_322$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_322$STDAGE_t1,
                                                 "DeltaPDSI" = G_322$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_322$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_322$STDAGE_t1,
                                                   "B_L_prop" = G_322$B_L_prop, 
                                                   "DeltaPDSI" = G_322$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_322$DeltaB_age <- (G_322$B_pred_age2 - G_322$B_pred_age1) / G_322$REMPER
}

#### 331

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "331",]$Best.Mod == "NA"){
    
    G_331$B_pred_age2 <- predict(get(paste("nls_331.",  Best_mods.P_bal[Best_mods.P_bal$Code == 331,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_331$MEASTIME_t1,
                                               "STDAGE_t2" = G_331$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_331$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_331$STDAGE_t2,
                                                 "DeltaPDSI" = G_331$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_331$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_331$STDAGE_t2,
                                                   "B_L_prop" = G_331$B_L_prop, 
                                                   "DeltaPDSI" = G_331$DeltaPDSI)
                                        } )
    
    G_331$B_pred_age1 <- predict(get(paste("nls_331.",  Best_mods.P_bal[Best_mods.P_bal$Code == 331,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_331$MEASTIME_t1,
                                               "STDAGE_t2" = G_331$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_331$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_331$STDAGE_t1,
                                                 "DeltaPDSI" = G_331$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_331$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_331$STDAGE_t1,
                                                   "B_L_prop" = G_331$B_L_prop, 
                                                   "DeltaPDSI" = G_331$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_331$DeltaB_age <- (G_331$B_pred_age2 - G_331$B_pred_age1) / G_331$REMPER
}

#### 332

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "332",]$Best.Mod == "NA"){
    
    G_332$B_pred_age2 <- predict(get(paste("nls_332.",  Best_mods.P_bal[Best_mods.P_bal$Code == 332,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_332$MEASTIME_t1,
                                               "STDAGE_t2" = G_332$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_332$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_332$STDAGE_t2,
                                                 "DeltaPDSI" = G_332$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_332$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_332$STDAGE_t2,
                                                   "B_L_prop" = G_332$B_L_prop, 
                                                   "DeltaPDSI" = G_332$DeltaPDSI)
                                        } )
    
    G_332$B_pred_age1 <- predict(get(paste("nls_332.",  Best_mods.P_bal[Best_mods.P_bal$Code == 332,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_332$MEASTIME_t1,
                                               "STDAGE_t2" = G_332$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_332$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_332$STDAGE_t1,
                                                 "DeltaPDSI" = G_332$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_332$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_332$STDAGE_t1,
                                                   "B_L_prop" = G_332$B_L_prop, 
                                                   "DeltaPDSI" = G_332$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_332$DeltaB_age <- (G_332$B_pred_age2 - G_332$B_pred_age1) / G_332$REMPER
}

#### 341

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "341",]$Best.Mod == "NA"){
    
    G_341$B_pred_age2 <- predict(get(paste("nls_341.",  Best_mods.P_bal[Best_mods.P_bal$Code == 341,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_341$MEASTIME_t1,
                                               "STDAGE_t2" = G_341$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_341$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_341$STDAGE_t2,
                                                 "DeltaPDSI" = G_341$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_341$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_341$STDAGE_t2,
                                                   "B_L_prop" = G_341$B_L_prop, 
                                                   "DeltaPDSI" = G_341$DeltaPDSI)
                                        } )
    
    G_341$B_pred_age1 <- predict(get(paste("nls_341.",  Best_mods.P_bal[Best_mods.P_bal$Code == 341,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_341$MEASTIME_t1,
                                               "STDAGE_t2" = G_341$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_341$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_341$STDAGE_t1,
                                                 "DeltaPDSI" = G_341$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_341$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_341$STDAGE_t1,
                                                   "B_L_prop" = G_341$B_L_prop, 
                                                   "DeltaPDSI" = G_341$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_341$DeltaB_age <- (G_341$B_pred_age2 - G_341$B_pred_age1) / G_341$REMPER
}

#### 342

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "342",]$Best.Mod == "NA"){
    
    G_342$B_pred_age2 <- predict(get(paste("nls_342.",  Best_mods.P_bal[Best_mods.P_bal$Code == 342,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_342$MEASTIME_t1,
                                               "STDAGE_t2" = G_342$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_342$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_342$STDAGE_t2,
                                                 "DeltaPDSI" = G_342$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_342$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_342$STDAGE_t2,
                                                   "B_L_prop" = G_342$B_L_prop, 
                                                   "DeltaPDSI" = G_342$DeltaPDSI)
                                        } )
    
    G_342$B_pred_age1 <- predict(get(paste("nls_342.",  Best_mods.P_bal[Best_mods.P_bal$Code == 342,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_342$MEASTIME_t1,
                                               "STDAGE_t2" = G_342$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_342$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_342$STDAGE_t1,
                                                 "DeltaPDSI" = G_342$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_342$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_342$STDAGE_t1,
                                                   "B_L_prop" = G_342$B_L_prop, 
                                                   "DeltaPDSI" = G_342$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_342$DeltaB_age <- (G_342$B_pred_age2 - G_342$B_pred_age1) / G_342$REMPER
}

#### 411

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "411",]$Best.Mod == "NA"){
    
    G_411$B_pred_age2 <- predict(get(paste("nls_411.",  Best_mods.P_bal[Best_mods.P_bal$Code == 411,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_411$MEASTIME_t1,
                                               "STDAGE_t2" = G_411$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_411$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_411$STDAGE_t2,
                                                 "DeltaPDSI" = G_411$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_411$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_411$STDAGE_t2,
                                                   "B_L_prop" = G_411$B_L_prop, 
                                                   "DeltaPDSI" = G_411$DeltaPDSI)
                                        } )
    
    G_411$B_pred_age1 <- predict(get(paste("nls_411.",  Best_mods.P_bal[Best_mods.P_bal$Code == 411,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_411$MEASTIME_t1,
                                               "STDAGE_t2" = G_411$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_411$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_411$STDAGE_t1,
                                                 "DeltaPDSI" = G_411$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_411$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_411$STDAGE_t1,
                                                   "B_L_prop" = G_411$B_L_prop, 
                                                   "DeltaPDSI" = G_411$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_411$DeltaB_age <- (G_411$B_pred_age2 - G_411$B_pred_age1) / G_411$REMPER
}

#### M211

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "M211",]$Best.Mod == "NA"){
    
    G_M211$B_pred_age2 <- predict(get(paste("nls_M211.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M211",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M211$MEASTIME_t1,
                                               "STDAGE_t2" = G_M211$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M211$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M211$STDAGE_t2,
                                                 "DeltaPDSI" = G_M211$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M211$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M211$STDAGE_t2,
                                                   "B_L_prop" = G_M211$B_L_prop, 
                                                   "DeltaPDSI" = G_M211$DeltaPDSI)
                                        } )
    
    G_M211$B_pred_age1 <- predict(get(paste("nls_M211.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M211",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M211$MEASTIME_t1,
                                               "STDAGE_t2" = G_M211$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M211$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M211$STDAGE_t1,
                                                 "DeltaPDSI" = G_M211$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M211$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M211$STDAGE_t1,
                                                   "B_L_prop" = G_M211$B_L_prop, 
                                                   "DeltaPDSI" = G_M211$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_M211$DeltaB_age <- (G_M211$B_pred_age2 - G_M211$B_pred_age1) / G_M211$REMPER
}

#### M223

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "M223",]$Best.Mod == "NA"){
    
    G_M223$B_pred_age2 <- predict(get(paste("nls_M223.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M223",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M223$MEASTIME_t1,
                                               "STDAGE_t2" = G_M223$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M223$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M223$STDAGE_t2,
                                                 "DeltaPDSI" = G_M223$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M223$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M223$STDAGE_t2,
                                                   "B_L_prop" = G_M223$B_L_prop, 
                                                   "DeltaPDSI" = G_M223$DeltaPDSI)
                                        } )
    
    G_M223$B_pred_age1 <- predict(get(paste("nls_M223.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M223",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M223$MEASTIME_t1,
                                               "STDAGE_t2" = G_M223$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M223$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M223$STDAGE_t1,
                                                 "DeltaPDSI" = G_M223$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M223$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M223$STDAGE_t1,
                                                   "B_L_prop" = G_M223$B_L_prop, 
                                                   "DeltaPDSI" = G_M223$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_M223$DeltaB_age <- (G_M223$B_pred_age2 - G_M223$B_pred_age1) / G_M223$REMPER
}

#### M231

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "M231",]$Best.Mod == "NA"){
    
    G_M231$B_pred_age2 <- predict(get(paste("nls_M231.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M231",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M231$MEASTIME_t1,
                                               "STDAGE_t2" = G_M231$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M231$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M231$STDAGE_t2,
                                                 "DeltaPDSI" = G_M231$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M231$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M231$STDAGE_t2,
                                                   "B_L_prop" = G_M231$B_L_prop, 
                                                   "DeltaPDSI" = G_M231$DeltaPDSI)
                                        } )
    
    G_M231$B_pred_age1 <- predict(get(paste("nls_M231.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M231",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M231$MEASTIME_t1,
                                               "STDAGE_t2" = G_M231$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M231$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M231$STDAGE_t1,
                                                 "DeltaPDSI" = G_M231$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M231$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M231$STDAGE_t1,
                                                   "B_L_prop" = G_M231$B_L_prop, 
                                                   "DeltaPDSI" = G_M231$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_M231$DeltaB_age <- (G_M231$B_pred_age2 - G_M231$B_pred_age1) / G_M231$REMPER
}

#### M242

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "M242",]$Best.Mod == "NA"){
    
    G_M242$B_pred_age2 <- predict(get(paste("nls_M242.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M242",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M242$MEASTIME_t1,
                                               "STDAGE_t2" = G_M242$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M242$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M242$STDAGE_t2,
                                                 "DeltaPDSI" = G_M242$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M242$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M242$STDAGE_t2,
                                                   "B_L_prop" = G_M242$B_L_prop, 
                                                   "DeltaPDSI" = G_M242$DeltaPDSI)
                                        } )
    
    G_M242$B_pred_age1 <- predict(get(paste("nls_M242.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M242",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M242$MEASTIME_t1,
                                               "STDAGE_t2" = G_M242$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M242$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M242$STDAGE_t1,
                                                 "DeltaPDSI" = G_M242$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M242$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M242$STDAGE_t1,
                                                   "B_L_prop" = G_M242$B_L_prop, 
                                                   "DeltaPDSI" = G_M242$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_M242$DeltaB_age <- (G_M242$B_pred_age2 - G_M242$B_pred_age1) / G_M242$REMPER
}

#### M261

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "M261",]$Best.Mod == "NA"){
    
    G_M261$B_pred_age2 <- predict(get(paste("nls_M261.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M261",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M261$MEASTIME_t1,
                                               "STDAGE_t2" = G_M261$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M261$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M261$STDAGE_t2,
                                                 "DeltaPDSI" = G_M261$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M261$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M261$STDAGE_t2,
                                                   "B_L_prop" = G_M261$B_L_prop, 
                                                   "DeltaPDSI" = G_M261$DeltaPDSI)
                                        } )
    
    G_M261$B_pred_age1 <- predict(get(paste("nls_M261.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M261",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M261$MEASTIME_t1,
                                               "STDAGE_t2" = G_M261$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M261$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M261$STDAGE_t1,
                                                 "DeltaPDSI" = G_M261$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M261$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M261$STDAGE_t1,
                                                   "B_L_prop" = G_M261$B_L_prop, 
                                                   "DeltaPDSI" = G_M261$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_M261$DeltaB_age <- (G_M261$B_pred_age2 - G_M261$B_pred_age1) / G_M261$REMPER
}

#### M262

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "M262",]$Best.Mod == "NA"){
    
    G_M262$B_pred_age2 <- predict(get(paste("nls_M262.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M262",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M262$MEASTIME_t1,
                                               "STDAGE_t2" = G_M262$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M262$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M262$STDAGE_t2,
                                                 "DeltaPDSI" = G_M262$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M262$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M262$STDAGE_t2,
                                                   "B_L_prop" = G_M262$B_L_prop, 
                                                   "DeltaPDSI" = G_M262$DeltaPDSI)
                                        } )
    
    G_M262$B_pred_age1 <- predict(get(paste("nls_M262.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M262",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M262$MEASTIME_t1,
                                               "STDAGE_t2" = G_M262$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M262$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M262$STDAGE_t1,
                                                 "DeltaPDSI" = G_M262$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M262$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M262$STDAGE_t1,
                                                   "B_L_prop" = G_M262$B_L_prop, 
                                                   "DeltaPDSI" = G_M262$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_M262$DeltaB_age <- (G_M262$B_pred_age2 - G_M262$B_pred_age1) / G_M262$REMPER
}

#### M313

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "M313",]$Best.Mod == "NA"){
    
    G_M313$B_pred_age2 <- predict(get(paste("nls_M313.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M313",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M313$MEASTIME_t1,
                                               "STDAGE_t2" = G_M313$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M313$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M313$STDAGE_t2,
                                                 "DeltaPDSI" = G_M313$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M313$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M313$STDAGE_t2,
                                                   "B_L_prop" = G_M313$B_L_prop, 
                                                   "DeltaPDSI" = G_M313$DeltaPDSI)
                                        } )
    
    G_M313$B_pred_age1 <- predict(get(paste("nls_M313.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M313",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M313$MEASTIME_t1,
                                               "STDAGE_t2" = G_M313$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M313$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M313$STDAGE_t1,
                                                 "DeltaPDSI" = G_M313$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M313$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M313$STDAGE_t1,
                                                   "B_L_prop" = G_M313$B_L_prop, 
                                                   "DeltaPDSI" = G_M313$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_M313$DeltaB_age <- (G_M313$B_pred_age2 - G_M313$B_pred_age1) / G_M313$REMPER
}

#### M331

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "M331",]$Best.Mod == "NA"){
    
    G_M331$B_pred_age2 <- predict(get(paste("nls_M331.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M331",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M331$MEASTIME_t1,
                                               "STDAGE_t2" = G_M331$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M331$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M331$STDAGE_t2,
                                                 "DeltaPDSI" = G_M331$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M331$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M331$STDAGE_t2,
                                                   "B_L_prop" = G_M331$B_L_prop, 
                                                   "DeltaPDSI" = G_M331$DeltaPDSI)
                                        } )
    
    G_M331$B_pred_age1 <- predict(get(paste("nls_M331.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M331",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M331$MEASTIME_t1,
                                               "STDAGE_t2" = G_M331$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M331$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M331$STDAGE_t1,
                                                 "DeltaPDSI" = G_M331$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M331$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M331$STDAGE_t1,
                                                   "B_L_prop" = G_M331$B_L_prop, 
                                                   "DeltaPDSI" = G_M331$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_M331$DeltaB_age <- (G_M331$B_pred_age2 - G_M331$B_pred_age1) / G_M331$REMPER
}

#### M332

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "M332",]$Best.Mod == "NA"){
    
    G_M332$B_pred_age2 <- predict(get(paste("nls_M332.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M332",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M332$MEASTIME_t1,
                                               "STDAGE_t2" = G_M332$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M332$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M332$STDAGE_t2,
                                                 "DeltaPDSI" = G_M332$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M332$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M332$STDAGE_t2,
                                                   "B_L_prop" = G_M332$B_L_prop, 
                                                   "DeltaPDSI" = G_M332$DeltaPDSI)
                                        } )
    
    G_M332$B_pred_age1 <- predict(get(paste("nls_M332.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M332",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M332$MEASTIME_t1,
                                               "STDAGE_t2" = G_M332$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M332$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M332$STDAGE_t1,
                                                 "DeltaPDSI" = G_M332$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M332$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M332$STDAGE_t1,
                                                   "B_L_prop" = G_M332$B_L_prop, 
                                                   "DeltaPDSI" = G_M332$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_M332$DeltaB_age <- (G_M332$B_pred_age2 - G_M332$B_pred_age1) / G_M332$REMPER
}

#### M333

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "M333",]$Best.Mod == "NA"){
    
    G_M333$B_pred_age2 <- predict(get(paste("nls_M333.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M333",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M333$MEASTIME_t1,
                                               "STDAGE_t2" = G_M333$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M333$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M333$STDAGE_t2,
                                                 "DeltaPDSI" = G_M333$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M333$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M333$STDAGE_t2,
                                                   "B_L_prop" = G_M333$B_L_prop, 
                                                   "DeltaPDSI" = G_M333$DeltaPDSI)
                                        } )
    
    G_M333$B_pred_age1 <- predict(get(paste("nls_M333.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M333",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M333$MEASTIME_t1,
                                               "STDAGE_t2" = G_M333$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M333$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M333$STDAGE_t1,
                                                 "DeltaPDSI" = G_M333$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M333$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M333$STDAGE_t1,
                                                   "B_L_prop" = G_M333$B_L_prop, 
                                                   "DeltaPDSI" = G_M333$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_M333$DeltaB_age <- (G_M333$B_pred_age2 - G_M333$B_pred_age1) / G_M333$REMPER
}

#### M334

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "M334",]$Best.Mod == "NA"){
    
    G_M334$B_pred_age2 <- predict(get(paste("nls_M334.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M334",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M334$MEASTIME_t1,
                                               "STDAGE_t2" = G_M334$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M334$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M334$STDAGE_t2,
                                                 "DeltaPDSI" = G_M334$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M334$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M334$STDAGE_t2,
                                                   "B_L_prop" = G_M334$B_L_prop, 
                                                   "DeltaPDSI" = G_M334$DeltaPDSI)
                                        } )
    
    G_M334$B_pred_age1 <- predict(get(paste("nls_M334.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M334",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M334$MEASTIME_t1,
                                               "STDAGE_t2" = G_M334$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M334$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M334$STDAGE_t1,
                                                 "DeltaPDSI" = G_M334$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M334$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M334$STDAGE_t1,
                                                   "B_L_prop" = G_M334$B_L_prop, 
                                                   "DeltaPDSI" = G_M334$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_M334$DeltaB_age <- (G_M334$B_pred_age2 - G_M334$B_pred_age1) / G_M334$REMPER
}

#### M341

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "M341",]$Best.Mod == "NA"){
    
    G_M341$B_pred_age2 <- predict(get(paste("nls_M341.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M341",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M341$MEASTIME_t1,
                                               "STDAGE_t2" = G_M341$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M341$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M341$STDAGE_t2,
                                                 "DeltaPDSI" = G_M341$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M341$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M341$STDAGE_t2,
                                                   "B_L_prop" = G_M341$B_L_prop, 
                                                   "DeltaPDSI" = G_M341$DeltaPDSI)
                                        } )
    
    G_M341$B_pred_age1 <- predict(get(paste("nls_M341.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M341",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M341$MEASTIME_t1,
                                               "STDAGE_t2" = G_M341$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M341$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M341$STDAGE_t1,
                                                 "DeltaPDSI" = G_M341$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M341$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M341$STDAGE_t1,
                                                   "B_L_prop" = G_M341$B_L_prop, 
                                                   "DeltaPDSI" = G_M341$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_M341$DeltaB_age <- (G_M341$B_pred_age2 - G_M341$B_pred_age1) / G_M341$REMPER
}

```


### 2. Delta-B due to Delta-Year (_ge_)

```{r}
#### 211

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "211",]$Best.Mod == "NA"){

    G_211$B_pred_year1 <- predict(get(paste("nls_211.",  Best_mods.P_bal[Best_mods.P_bal$Code == 211,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_211$MEASTIME_t1,
                                               "STDAGE_t2" = G_211$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_211$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_211$STDAGE_t1,
                                                 "DeltaPDSI" = G_211$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_211$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_211$STDAGE_t1,
                                                   "B_L_prop" = G_211$B_L_prop, 
                                                   "DeltaPDSI" = G_211$DeltaPDSI)
                                        } )
    
    G_211$B_pred_year2 <- predict(get(paste("nls_211.",  Best_mods.P_bal[Best_mods.P_bal$Code == 211,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_211$MEASTIME_t2,
                                               "STDAGE_t2" = G_211$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_211$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_211$STDAGE_t1,
                                                 "DeltaPDSI" = G_211$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_211$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_211$STDAGE_t1,
                                                   "B_L_prop" = G_211$B_L_prop, 
                                                   "DeltaPDSI" = G_211$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_211$DeltaB_year<- (G_211$B_pred_year2 - G_211$B_pred_year1) / G_211$REMPER
}

#### 212

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "212",]$Best.Mod == "NA"){

    G_212$B_pred_year1 <- predict(get(paste("nls_212.",  Best_mods.P_bal[Best_mods.P_bal$Code == 212,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_212$MEASTIME_t1,
                                               "STDAGE_t2" = G_212$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_212$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_212$STDAGE_t1,
                                                 "DeltaPDSI" = G_212$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_212$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_212$STDAGE_t1,
                                                   "B_L_prop" = G_212$B_L_prop, 
                                                   "DeltaPDSI" = G_212$DeltaPDSI)
                                        } )
    
    G_212$B_pred_year2 <- predict(get(paste("nls_212.",  Best_mods.P_bal[Best_mods.P_bal$Code == 212,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_212$MEASTIME_t2,
                                               "STDAGE_t2" = G_212$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_212$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_212$STDAGE_t1,
                                                 "DeltaPDSI" = G_212$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_212$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_212$STDAGE_t1,
                                                   "B_L_prop" = G_212$B_L_prop, 
                                                   "DeltaPDSI" = G_212$DeltaPDSI)

                                                                                } )

    # calculate delta-B due to year (ge) -- simple subtraction
    G_212$DeltaB_year<- (G_212$B_pred_year2 - G_212$B_pred_year1) / G_212$REMPER
}

#### 221

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "221",]$Best.Mod == "NA"){

    G_221$B_pred_year1 <- predict(get(paste("nls_221.",  Best_mods.P_bal[Best_mods.P_bal$Code == 221,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_221$MEASTIME_t1,
                                               "STDAGE_t2" = G_221$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_221$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_221$STDAGE_t1,
                                                 "DeltaPDSI" = G_221$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_221$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_221$STDAGE_t1,
                                                   "B_L_prop" = G_221$B_L_prop, 
                                                   "DeltaPDSI" = G_221$DeltaPDSI)
                                        } )
    
    G_221$B_pred_year2 <- predict(get(paste("nls_221.",  Best_mods.P_bal[Best_mods.P_bal$Code == 221,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_221$MEASTIME_t2,
                                               "STDAGE_t2" = G_221$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_221$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_221$STDAGE_t1,
                                                 "DeltaPDSI" = G_221$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_221$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_221$STDAGE_t1,
                                                   "B_L_prop" = G_221$B_L_prop, 
                                                   "DeltaPDSI" = G_221$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_221$DeltaB_year<- (G_221$B_pred_year2 - G_221$B_pred_year1) / G_221$REMPER
}

#### 222

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "222",]$Best.Mod == "NA"){

    G_222$B_pred_year1 <- predict(get(paste("nls_222.",  Best_mods.P_bal[Best_mods.P_bal$Code == 222,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_222$MEASTIME_t1,
                                               "STDAGE_t2" = G_222$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_222$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_222$STDAGE_t1,
                                                 "DeltaPDSI" = G_222$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_222$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_222$STDAGE_t1,
                                                   "B_L_prop" = G_222$B_L_prop, 
                                                   "DeltaPDSI" = G_222$DeltaPDSI)
                                        } )
    
    G_222$B_pred_year2 <- predict(get(paste("nls_222.",  Best_mods.P_bal[Best_mods.P_bal$Code == 222,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_222$MEASTIME_t2,
                                               "STDAGE_t2" = G_222$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_222$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_222$STDAGE_t1,
                                                 "DeltaPDSI" = G_222$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_222$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_222$STDAGE_t1,
                                                   "B_L_prop" = G_222$B_L_prop, 
                                                   "DeltaPDSI" = G_222$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_222$DeltaB_year<- (G_222$B_pred_year2 - G_222$B_pred_year1) / G_222$REMPER
}

#### 223

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "223",]$Best.Mod == "NA"){

    G_223$B_pred_year1 <- predict(get(paste("nls_223.",  Best_mods.P_bal[Best_mods.P_bal$Code == 223,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_223$MEASTIME_t1,
                                               "STDAGE_t2" = G_223$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_223$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_223$STDAGE_t1,
                                                 "DeltaPDSI" = G_223$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_223$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_223$STDAGE_t1,
                                                   "B_L_prop" = G_223$B_L_prop, 
                                                   "DeltaPDSI" = G_223$DeltaPDSI)
                                        } )
    
    G_223$B_pred_year2 <- predict(get(paste("nls_223.",  Best_mods.P_bal[Best_mods.P_bal$Code == 223,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_223$MEASTIME_t2,
                                               "STDAGE_t2" = G_223$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_223$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_223$STDAGE_t1,
                                                 "DeltaPDSI" = G_223$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_223$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_223$STDAGE_t1,
                                                   "B_L_prop" = G_223$B_L_prop, 
                                                   "DeltaPDSI" = G_223$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_223$DeltaB_year<- (G_223$B_pred_year2 - G_223$B_pred_year1) / G_223$REMPER
}

#### 231

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "231",]$Best.Mod == "NA"){

    G_231$B_pred_year1 <- predict(get(paste("nls_231.",  Best_mods.P_bal[Best_mods.P_bal$Code == 231,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_231$MEASTIME_t1,
                                               "STDAGE_t2" = G_231$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_231$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_231$STDAGE_t1,
                                                 "DeltaPDSI" = G_231$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_231$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_231$STDAGE_t1,
                                                   "B_L_prop" = G_231$B_L_prop, 
                                                   "DeltaPDSI" = G_231$DeltaPDSI)
                                        } )
    
    G_231$B_pred_year2 <- predict(get(paste("nls_231.",  Best_mods.P_bal[Best_mods.P_bal$Code == 231,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_231$MEASTIME_t2,
                                               "STDAGE_t2" = G_231$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_231$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_231$STDAGE_t1,
                                                 "DeltaPDSI" = G_231$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_231$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_231$STDAGE_t1,
                                                   "B_L_prop" = G_231$B_L_prop, 
                                                   "DeltaPDSI" = G_231$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_231$DeltaB_year<- (G_231$B_pred_year2 - G_231$B_pred_year1) / G_231$REMPER
}

#### 232

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "232",]$Best.Mod == "NA"){

    G_232$B_pred_year1 <- predict(get(paste("nls_232.",  Best_mods.P_bal[Best_mods.P_bal$Code == 232,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_232$MEASTIME_t1,
                                               "STDAGE_t2" = G_232$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_232$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_232$STDAGE_t1,
                                                 "DeltaPDSI" = G_232$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_232$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_232$STDAGE_t1,
                                                   "B_L_prop" = G_232$B_L_prop, 
                                                   "DeltaPDSI" = G_232$DeltaPDSI)
                                        } )
    
    G_232$B_pred_year2 <- predict(get(paste("nls_232.",  Best_mods.P_bal[Best_mods.P_bal$Code == 232,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_232$MEASTIME_t2,
                                               "STDAGE_t2" = G_232$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_232$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_232$STDAGE_t1,
                                                 "DeltaPDSI" = G_232$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_232$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_232$STDAGE_t1,
                                                   "B_L_prop" = G_232$B_L_prop, 
                                                   "DeltaPDSI" = G_232$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_232$DeltaB_year<- (G_232$B_pred_year2 - G_232$B_pred_year1) / G_232$REMPER
}

#### 234

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "234",]$Best.Mod == "NA"){

    G_234$B_pred_year1 <- predict(get(paste("nls_234.",  Best_mods.P_bal[Best_mods.P_bal$Code == 234,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_234$MEASTIME_t1,
                                               "STDAGE_t2" = G_234$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_234$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_234$STDAGE_t1,
                                                 "DeltaPDSI" = G_234$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_234$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_234$STDAGE_t1,
                                                   "B_L_prop" = G_234$B_L_prop, 
                                                   "DeltaPDSI" = G_234$DeltaPDSI)
                                        } )
    
    G_234$B_pred_year2 <- predict(get(paste("nls_234.",  Best_mods.P_bal[Best_mods.P_bal$Code == 234,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_234$MEASTIME_t2,
                                               "STDAGE_t2" = G_234$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_234$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_234$STDAGE_t1,
                                                 "DeltaPDSI" = G_234$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_234$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_234$STDAGE_t1,
                                                   "B_L_prop" = G_234$B_L_prop, 
                                                   "DeltaPDSI" = G_234$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_234$DeltaB_year<- (G_234$B_pred_year2 - G_234$B_pred_year1) / G_234$REMPER
}

#### 242

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "242",]$Best.Mod == "NA"){

    G_242$B_pred_year1 <- predict(get(paste("nls_242.",  Best_mods.P_bal[Best_mods.P_bal$Code == 242,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_242$MEASTIME_t1,
                                               "STDAGE_t2" = G_242$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_242$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_242$STDAGE_t1,
                                                 "DeltaPDSI" = G_242$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_242$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_242$STDAGE_t1,
                                                   "B_L_prop" = G_242$B_L_prop, 
                                                   "DeltaPDSI" = G_242$DeltaPDSI)
                                        } )
    
    G_242$B_pred_year2 <- predict(get(paste("nls_242.",  Best_mods.P_bal[Best_mods.P_bal$Code == 242,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_242$MEASTIME_t2,
                                               "STDAGE_t2" = G_242$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_242$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_242$STDAGE_t1,
                                                 "DeltaPDSI" = G_242$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_242$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_242$STDAGE_t1,
                                                   "B_L_prop" = G_242$B_L_prop, 
                                                   "DeltaPDSI" = G_242$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_242$DeltaB_year<- (G_242$B_pred_year2 - G_242$B_pred_year1) / G_242$REMPER
}

#### 251

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "251",]$Best.Mod == "NA"){

    G_251$B_pred_year1 <- predict(get(paste("nls_251.",  Best_mods.P_bal[Best_mods.P_bal$Code == 251,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_251$MEASTIME_t1,
                                               "STDAGE_t2" = G_251$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_251$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_251$STDAGE_t1,
                                                 "DeltaPDSI" = G_251$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_251$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_251$STDAGE_t1,
                                                   "B_L_prop" = G_251$B_L_prop, 
                                                   "DeltaPDSI" = G_251$DeltaPDSI)
                                        } )
    
    G_251$B_pred_year2 <- predict(get(paste("nls_251.",  Best_mods.P_bal[Best_mods.P_bal$Code == 251,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_251$MEASTIME_t2,
                                               "STDAGE_t2" = G_251$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_251$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_251$STDAGE_t1,
                                                 "DeltaPDSI" = G_251$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_251$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_251$STDAGE_t1,
                                                   "B_L_prop" = G_251$B_L_prop, 
                                                   "DeltaPDSI" = G_251$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_251$DeltaB_year<- (G_251$B_pred_year2 - G_251$B_pred_year1) / G_251$REMPER
}

#### 255

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "255",]$Best.Mod == "NA"){

    G_255$B_pred_year1 <- predict(get(paste("nls_255.",  Best_mods.P_bal[Best_mods.P_bal$Code == 255,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_255$MEASTIME_t1,
                                               "STDAGE_t2" = G_255$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_255$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_255$STDAGE_t1,
                                                 "DeltaPDSI" = G_255$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_255$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_255$STDAGE_t1,
                                                   "B_L_prop" = G_255$B_L_prop, 
                                                   "DeltaPDSI" = G_255$DeltaPDSI)
                                        } )
    
    G_255$B_pred_year2 <- predict(get(paste("nls_255.",  Best_mods.P_bal[Best_mods.P_bal$Code == 255,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_255$MEASTIME_t2,
                                               "STDAGE_t2" = G_255$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_255$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_255$STDAGE_t1,
                                                 "DeltaPDSI" = G_255$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_255$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_255$STDAGE_t1,
                                                   "B_L_prop" = G_255$B_L_prop, 
                                                   "DeltaPDSI" = G_255$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_255$DeltaB_year<- (G_255$B_pred_year2 - G_255$B_pred_year1) / G_255$REMPER
}

#### 261

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "261",]$Best.Mod == "NA"){

    G_261$B_pred_year1 <- predict(get(paste("nls_261.",  Best_mods.P_bal[Best_mods.P_bal$Code == 261,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_261$MEASTIME_t1,
                                               "STDAGE_t2" = G_261$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_261$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_261$STDAGE_t1,
                                                 "DeltaPDSI" = G_261$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_261$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_261$STDAGE_t1,
                                                   "B_L_prop" = G_261$B_L_prop, 
                                                   "DeltaPDSI" = G_261$DeltaPDSI)
                                        } )
    
    G_261$B_pred_year2 <- predict(get(paste("nls_261.",  Best_mods.P_bal[Best_mods.P_bal$Code == 261,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_261$MEASTIME_t2,
                                               "STDAGE_t2" = G_261$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_261$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_261$STDAGE_t1,
                                                 "DeltaPDSI" = G_261$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_261$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_261$STDAGE_t1,
                                                   "B_L_prop" = G_261$B_L_prop, 
                                                   "DeltaPDSI" = G_261$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_261$DeltaB_year<- (G_261$B_pred_year2 - G_261$B_pred_year1) / G_261$REMPER
}

#### 262

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "262",]$Best.Mod == "NA"){

    G_262$B_pred_year1 <- predict(get(paste("nls_262.",  Best_mods.P_bal[Best_mods.P_bal$Code == 262,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_262$MEASTIME_t1,
                                               "STDAGE_t2" = G_262$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_262$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_262$STDAGE_t1,
                                                 "DeltaPDSI" = G_262$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_262$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_262$STDAGE_t1,
                                                   "B_L_prop" = G_262$B_L_prop, 
                                                   "DeltaPDSI" = G_262$DeltaPDSI)
                                        } )
    
    G_262$B_pred_year2 <- predict(get(paste("nls_262.",  Best_mods.P_bal[Best_mods.P_bal$Code == 262,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_262$MEASTIME_t2,
                                               "STDAGE_t2" = G_262$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_262$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_262$STDAGE_t1,
                                                 "DeltaPDSI" = G_262$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_262$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_262$STDAGE_t1,
                                                   "B_L_prop" = G_262$B_L_prop, 
                                                   "DeltaPDSI" = G_262$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_262$DeltaB_year<- (G_262$B_pred_year2 - G_262$B_pred_year1) / G_262$REMPER
}

#### 263

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "263",]$Best.Mod == "NA"){

    G_263$B_pred_year1 <- predict(get(paste("nls_263.",  Best_mods.P_bal[Best_mods.P_bal$Code == 263,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_263$MEASTIME_t1,
                                               "STDAGE_t2" = G_263$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_263$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_263$STDAGE_t1,
                                                 "DeltaPDSI" = G_263$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_263$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_263$STDAGE_t1,
                                                   "B_L_prop" = G_263$B_L_prop, 
                                                   "DeltaPDSI" = G_263$DeltaPDSI)
                                        } )
    
    G_263$B_pred_year2 <- predict(get(paste("nls_263.",  Best_mods.P_bal[Best_mods.P_bal$Code == 263,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_263$MEASTIME_t2,
                                               "STDAGE_t2" = G_263$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_263$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_263$STDAGE_t1,
                                                 "DeltaPDSI" = G_263$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_263$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_263$STDAGE_t1,
                                                   "B_L_prop" = G_263$B_L_prop, 
                                                   "DeltaPDSI" = G_263$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_263$DeltaB_year<- (G_263$B_pred_year2 - G_263$B_pred_year1) / G_263$REMPER
}

#### 313

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "313",]$Best.Mod == "NA"){

    G_313$B_pred_year1 <- predict(get(paste("nls_313.",  Best_mods.P_bal[Best_mods.P_bal$Code == 313,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_313$MEASTIME_t1,
                                               "STDAGE_t2" = G_313$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_313$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_313$STDAGE_t1,
                                                 "DeltaPDSI" = G_313$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_313$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_313$STDAGE_t1,
                                                   "B_L_prop" = G_313$B_L_prop, 
                                                   "DeltaPDSI" = G_313$DeltaPDSI)
                                        } )
    
    G_313$B_pred_year2 <- predict(get(paste("nls_313.",  Best_mods.P_bal[Best_mods.P_bal$Code == 313,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_313$MEASTIME_t2,
                                               "STDAGE_t2" = G_313$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_313$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_313$STDAGE_t1,
                                                 "DeltaPDSI" = G_313$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_313$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_313$STDAGE_t1,
                                                   "B_L_prop" = G_313$B_L_prop, 
                                                   "DeltaPDSI" = G_313$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_313$DeltaB_year<- (G_313$B_pred_year2 - G_313$B_pred_year1) / G_313$REMPER
}

#### 315

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "315",]$Best.Mod == "NA"){

    G_315$B_pred_year1 <- predict(get(paste("nls_315.",  Best_mods.P_bal[Best_mods.P_bal$Code == 315,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_315$MEASTIME_t1,
                                               "STDAGE_t2" = G_315$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_315$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_315$STDAGE_t1,
                                                 "DeltaPDSI" = G_315$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_315$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_315$STDAGE_t1,
                                                   "B_L_prop" = G_315$B_L_prop, 
                                                   "DeltaPDSI" = G_315$DeltaPDSI)
                                        } )
    
    G_315$B_pred_year2 <- predict(get(paste("nls_315.",  Best_mods.P_bal[Best_mods.P_bal$Code == 315,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_315$MEASTIME_t2,
                                               "STDAGE_t2" = G_315$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_315$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_315$STDAGE_t1,
                                                 "DeltaPDSI" = G_315$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_315$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_315$STDAGE_t1,
                                                   "B_L_prop" = G_315$B_L_prop, 
                                                   "DeltaPDSI" = G_315$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_315$DeltaB_year<- (G_315$B_pred_year2 - G_315$B_pred_year1) / G_315$REMPER
}

#### 321

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "321",]$Best.Mod == "NA"){

    G_321$B_pred_year1 <- predict(get(paste("nls_321.",  Best_mods.P_bal[Best_mods.P_bal$Code == 321,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_321$MEASTIME_t1,
                                               "STDAGE_t2" = G_321$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_321$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_321$STDAGE_t1,
                                                 "DeltaPDSI" = G_321$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_321$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_321$STDAGE_t1,
                                                   "B_L_prop" = G_321$B_L_prop, 
                                                   "DeltaPDSI" = G_321$DeltaPDSI)
                                        } )
    
    G_321$B_pred_year2 <- predict(get(paste("nls_321.",  Best_mods.P_bal[Best_mods.P_bal$Code == 321,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_321$MEASTIME_t2,
                                               "STDAGE_t2" = G_321$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_321$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_321$STDAGE_t1,
                                                 "DeltaPDSI" = G_321$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_321$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_321$STDAGE_t1,
                                                   "B_L_prop" = G_321$B_L_prop, 
                                                   "DeltaPDSI" = G_321$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_321$DeltaB_year<- (G_321$B_pred_year2 - G_321$B_pred_year1) / G_321$REMPER
}

#### 322

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "322",]$Best.Mod == "NA"){

    G_322$B_pred_year1 <- predict(get(paste("nls_322.",  Best_mods.P_bal[Best_mods.P_bal$Code == 322,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_322$MEASTIME_t1,
                                               "STDAGE_t2" = G_322$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_322$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_322$STDAGE_t1,
                                                 "DeltaPDSI" = G_322$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_322$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_322$STDAGE_t1,
                                                   "B_L_prop" = G_322$B_L_prop, 
                                                   "DeltaPDSI" = G_322$DeltaPDSI)
                                        } )
    
    G_322$B_pred_year2 <- predict(get(paste("nls_322.",  Best_mods.P_bal[Best_mods.P_bal$Code == 322,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_322$MEASTIME_t2,
                                               "STDAGE_t2" = G_322$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_322$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_322$STDAGE_t1,
                                                 "DeltaPDSI" = G_322$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_322$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_322$STDAGE_t1,
                                                   "B_L_prop" = G_322$B_L_prop, 
                                                   "DeltaPDSI" = G_322$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_322$DeltaB_year<- (G_322$B_pred_year2 - G_322$B_pred_year1) / G_322$REMPER
}

#### 331

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "331",]$Best.Mod == "NA"){

    G_331$B_pred_year1 <- predict(get(paste("nls_331.",  Best_mods.P_bal[Best_mods.P_bal$Code == 331,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_331$MEASTIME_t1,
                                               "STDAGE_t2" = G_331$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_331$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_331$STDAGE_t1,
                                                 "DeltaPDSI" = G_331$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_331$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_331$STDAGE_t1,
                                                   "B_L_prop" = G_331$B_L_prop, 
                                                   "DeltaPDSI" = G_331$DeltaPDSI)
                                        } )
    
    G_331$B_pred_year2 <- predict(get(paste("nls_331.",  Best_mods.P_bal[Best_mods.P_bal$Code == 331,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_331$MEASTIME_t2,
                                               "STDAGE_t2" = G_331$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_331$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_331$STDAGE_t1,
                                                 "DeltaPDSI" = G_331$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_331$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_331$STDAGE_t1,
                                                   "B_L_prop" = G_331$B_L_prop, 
                                                   "DeltaPDSI" = G_331$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_331$DeltaB_year<- (G_331$B_pred_year2 - G_331$B_pred_year1) / G_331$REMPER
}

#### 332

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "332",]$Best.Mod == "NA"){

    G_332$B_pred_year1 <- predict(get(paste("nls_332.",  Best_mods.P_bal[Best_mods.P_bal$Code == 332,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_332$MEASTIME_t1,
                                               "STDAGE_t2" = G_332$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_332$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_332$STDAGE_t1,
                                                 "DeltaPDSI" = G_332$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_332$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_332$STDAGE_t1,
                                                   "B_L_prop" = G_332$B_L_prop, 
                                                   "DeltaPDSI" = G_332$DeltaPDSI)
                                        } )
    
    G_332$B_pred_year2 <- predict(get(paste("nls_332.",  Best_mods.P_bal[Best_mods.P_bal$Code == 332,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_332$MEASTIME_t2,
                                               "STDAGE_t2" = G_332$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_332$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_332$STDAGE_t1,
                                                 "DeltaPDSI" = G_332$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_332$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_332$STDAGE_t1,
                                                   "B_L_prop" = G_332$B_L_prop, 
                                                   "DeltaPDSI" = G_332$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_332$DeltaB_year<- (G_332$B_pred_year2 - G_332$B_pred_year1) / G_332$REMPER
}

#### 341

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "341",]$Best.Mod == "NA"){

    G_341$B_pred_year1 <- predict(get(paste("nls_341.",  Best_mods.P_bal[Best_mods.P_bal$Code == 341,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_341$MEASTIME_t1,
                                               "STDAGE_t2" = G_341$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_341$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_341$STDAGE_t1,
                                                 "DeltaPDSI" = G_341$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_341$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_341$STDAGE_t1,
                                                   "B_L_prop" = G_341$B_L_prop, 
                                                   "DeltaPDSI" = G_341$DeltaPDSI)
                                        } )
    
    G_341$B_pred_year2 <- predict(get(paste("nls_341.",  Best_mods.P_bal[Best_mods.P_bal$Code == 341,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_341$MEASTIME_t2,
                                               "STDAGE_t2" = G_341$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_341$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_341$STDAGE_t1,
                                                 "DeltaPDSI" = G_341$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_341$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_341$STDAGE_t1,
                                                   "B_L_prop" = G_341$B_L_prop, 
                                                   "DeltaPDSI" = G_341$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_341$DeltaB_year<- (G_341$B_pred_year2 - G_341$B_pred_year1) / G_341$REMPER
}

#### 342

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "342",]$Best.Mod == "NA"){

    G_342$B_pred_year1 <- predict(get(paste("nls_342.",  Best_mods.P_bal[Best_mods.P_bal$Code == 342,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_342$MEASTIME_t1,
                                               "STDAGE_t2" = G_342$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_342$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_342$STDAGE_t1,
                                                 "DeltaPDSI" = G_342$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_342$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_342$STDAGE_t1,
                                                   "B_L_prop" = G_342$B_L_prop, 
                                                   "DeltaPDSI" = G_342$DeltaPDSI)
                                        } )
    
    G_342$B_pred_year2 <- predict(get(paste("nls_342.",  Best_mods.P_bal[Best_mods.P_bal$Code == 342,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_342$MEASTIME_t2,
                                               "STDAGE_t2" = G_342$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_342$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_342$STDAGE_t1,
                                                 "DeltaPDSI" = G_342$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_342$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_342$STDAGE_t1,
                                                   "B_L_prop" = G_342$B_L_prop, 
                                                   "DeltaPDSI" = G_342$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_342$DeltaB_year<- (G_342$B_pred_year2 - G_342$B_pred_year1) / G_342$REMPER
}

#### 411

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "411",]$Best.Mod == "NA"){

    G_411$B_pred_year1 <- predict(get(paste("nls_411.",  Best_mods.P_bal[Best_mods.P_bal$Code == 411,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_411$MEASTIME_t1,
                                               "STDAGE_t2" = G_411$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_411$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_411$STDAGE_t1,
                                                 "DeltaPDSI" = G_411$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_411$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_411$STDAGE_t1,
                                                   "B_L_prop" = G_411$B_L_prop, 
                                                   "DeltaPDSI" = G_411$DeltaPDSI)
                                        } )
    
    G_411$B_pred_year2 <- predict(get(paste("nls_411.",  Best_mods.P_bal[Best_mods.P_bal$Code == 411,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_411$MEASTIME_t2,
                                               "STDAGE_t2" = G_411$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_411$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_411$STDAGE_t1,
                                                 "DeltaPDSI" = G_411$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_411$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_411$STDAGE_t1,
                                                   "B_L_prop" = G_411$B_L_prop, 
                                                   "DeltaPDSI" = G_411$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_411$DeltaB_year<- (G_411$B_pred_year2 - G_411$B_pred_year1) / G_411$REMPER
}

#### M211

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "M211",]$Best.Mod == "NA"){

    G_M211$B_pred_year1 <- predict(get(paste("nls_M211.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M211",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M211$MEASTIME_t1,
                                               "STDAGE_t2" = G_M211$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M211$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M211$STDAGE_t1,
                                                 "DeltaPDSI" = G_M211$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M211$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M211$STDAGE_t1,
                                                   "B_L_prop" = G_M211$B_L_prop, 
                                                   "DeltaPDSI" = G_M211$DeltaPDSI)
                                        } )
    
    G_M211$B_pred_year2 <- predict(get(paste("nls_M211.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M211",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M211$MEASTIME_t2,
                                               "STDAGE_t2" = G_M211$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M211$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_M211$STDAGE_t1,
                                                 "DeltaPDSI" = G_M211$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M211$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_M211$STDAGE_t1,
                                                   "B_L_prop" = G_M211$B_L_prop, 
                                                   "DeltaPDSI" = G_M211$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_M211$DeltaB_year<- (G_M211$B_pred_year2 - G_M211$B_pred_year1) / G_M211$REMPER
}

#### M223

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "M223",]$Best.Mod == "NA"){

    G_M223$B_pred_year1 <- predict(get(paste("nls_M223.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M223",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M223$MEASTIME_t1,
                                               "STDAGE_t2" = G_M223$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M223$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M223$STDAGE_t1,
                                                 "DeltaPDSI" = G_M223$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M223$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M223$STDAGE_t1,
                                                   "B_L_prop" = G_M223$B_L_prop, 
                                                   "DeltaPDSI" = G_M223$DeltaPDSI)
                                        } )
    
    G_M223$B_pred_year2 <- predict(get(paste("nls_M223.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M223",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M223$MEASTIME_t2,
                                               "STDAGE_t2" = G_M223$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M223$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_M223$STDAGE_t1,
                                                 "DeltaPDSI" = G_M223$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M223$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_M223$STDAGE_t1,
                                                   "B_L_prop" = G_M223$B_L_prop, 
                                                   "DeltaPDSI" = G_M223$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_M223$DeltaB_year<- (G_M223$B_pred_year2 - G_M223$B_pred_year1) / G_M223$REMPER
}

#### M231

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "M231",]$Best.Mod == "NA"){

    G_M231$B_pred_year1 <- predict(get(paste("nls_M231.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M231",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M231$MEASTIME_t1,
                                               "STDAGE_t2" = G_M231$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M231$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M231$STDAGE_t1,
                                                 "DeltaPDSI" = G_M231$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M231$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M231$STDAGE_t1,
                                                   "B_L_prop" = G_M231$B_L_prop, 
                                                   "DeltaPDSI" = G_M231$DeltaPDSI)
                                        } )
    
    G_M231$B_pred_year2 <- predict(get(paste("nls_M231.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M231",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M231$MEASTIME_t2,
                                               "STDAGE_t2" = G_M231$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M231$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_M231$STDAGE_t1,
                                                 "DeltaPDSI" = G_M231$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M231$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_M231$STDAGE_t1,
                                                   "B_L_prop" = G_M231$B_L_prop, 
                                                   "DeltaPDSI" = G_M231$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_M231$DeltaB_year<- (G_M231$B_pred_year2 - G_M231$B_pred_year1) / G_M231$REMPER
}

#### M242

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "M242",]$Best.Mod == "NA"){

    G_M242$B_pred_year1 <- predict(get(paste("nls_M242.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M242",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M242$MEASTIME_t1,
                                               "STDAGE_t2" = G_M242$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M242$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M242$STDAGE_t1,
                                                 "DeltaPDSI" = G_M242$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M242$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M242$STDAGE_t1,
                                                   "B_L_prop" = G_M242$B_L_prop, 
                                                   "DeltaPDSI" = G_M242$DeltaPDSI)
                                        } )
    
    G_M242$B_pred_year2 <- predict(get(paste("nls_M242.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M242",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M242$MEASTIME_t2,
                                               "STDAGE_t2" = G_M242$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M242$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_M242$STDAGE_t1,
                                                 "DeltaPDSI" = G_M242$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M242$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_M242$STDAGE_t1,
                                                   "B_L_prop" = G_M242$B_L_prop, 
                                                   "DeltaPDSI" = G_M242$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_M242$DeltaB_year<- (G_M242$B_pred_year2 - G_M242$B_pred_year1) / G_M242$REMPER
}

#### M261

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "M261",]$Best.Mod == "NA"){

    G_M261$B_pred_year1 <- predict(get(paste("nls_M261.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M261",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M261$MEASTIME_t1,
                                               "STDAGE_t2" = G_M261$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M261$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M261$STDAGE_t1,
                                                 "DeltaPDSI" = G_M261$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M261$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M261$STDAGE_t1,
                                                   "B_L_prop" = G_M261$B_L_prop, 
                                                   "DeltaPDSI" = G_M261$DeltaPDSI)
                                        } )
    
    G_M261$B_pred_year2 <- predict(get(paste("nls_M261.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M261",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M261$MEASTIME_t2,
                                               "STDAGE_t2" = G_M261$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M261$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_M261$STDAGE_t1,
                                                 "DeltaPDSI" = G_M261$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M261$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_M261$STDAGE_t1,
                                                   "B_L_prop" = G_M261$B_L_prop, 
                                                   "DeltaPDSI" = G_M261$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_M261$DeltaB_year<- (G_M261$B_pred_year2 - G_M261$B_pred_year1) / G_M261$REMPER
}

#### M262

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "M262",]$Best.Mod == "NA"){

    G_M262$B_pred_year1 <- predict(get(paste("nls_M262.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M262",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M262$MEASTIME_t1,
                                               "STDAGE_t2" = G_M262$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M262$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M262$STDAGE_t1,
                                                 "DeltaPDSI" = G_M262$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M262$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M262$STDAGE_t1,
                                                   "B_L_prop" = G_M262$B_L_prop, 
                                                   "DeltaPDSI" = G_M262$DeltaPDSI)
                                        } )
    
    G_M262$B_pred_year2 <- predict(get(paste("nls_M262.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M262",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M262$MEASTIME_t2,
                                               "STDAGE_t2" = G_M262$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M262$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_M262$STDAGE_t1,
                                                 "DeltaPDSI" = G_M262$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M262$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_M262$STDAGE_t1,
                                                   "B_L_prop" = G_M262$B_L_prop, 
                                                   "DeltaPDSI" = G_M262$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_M262$DeltaB_year<- (G_M262$B_pred_year2 - G_M262$B_pred_year1) / G_M262$REMPER
}

#### M313

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "M313",]$Best.Mod == "NA"){

    G_M313$B_pred_year1 <- predict(get(paste("nls_M313.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M313",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M313$MEASTIME_t1,
                                               "STDAGE_t2" = G_M313$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M313$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M313$STDAGE_t1,
                                                 "DeltaPDSI" = G_M313$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M313$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M313$STDAGE_t1,
                                                   "B_L_prop" = G_M313$B_L_prop, 
                                                   "DeltaPDSI" = G_M313$DeltaPDSI)
                                        } )
    
    G_M313$B_pred_year2 <- predict(get(paste("nls_M313.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M313",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M313$MEASTIME_t2,
                                               "STDAGE_t2" = G_M313$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M313$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_M313$STDAGE_t1,
                                                 "DeltaPDSI" = G_M313$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M313$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_M313$STDAGE_t1,
                                                   "B_L_prop" = G_M313$B_L_prop, 
                                                   "DeltaPDSI" = G_M313$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_M313$DeltaB_year<- (G_M313$B_pred_year2 - G_M313$B_pred_year1) / G_M313$REMPER
}

#### M331

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "M331",]$Best.Mod == "NA"){

    G_M331$B_pred_year1 <- predict(get(paste("nls_M331.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M331",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M331$MEASTIME_t1,
                                               "STDAGE_t2" = G_M331$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M331$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M331$STDAGE_t1,
                                                 "DeltaPDSI" = G_M331$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M331$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M331$STDAGE_t1,
                                                   "B_L_prop" = G_M331$B_L_prop, 
                                                   "DeltaPDSI" = G_M331$DeltaPDSI)
                                        } )
    
    G_M331$B_pred_year2 <- predict(get(paste("nls_M331.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M331",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M331$MEASTIME_t2,
                                               "STDAGE_t2" = G_M331$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M331$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_M331$STDAGE_t1,
                                                 "DeltaPDSI" = G_M331$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M331$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_M331$STDAGE_t1,
                                                   "B_L_prop" = G_M331$B_L_prop, 
                                                   "DeltaPDSI" = G_M331$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_M331$DeltaB_year<- (G_M331$B_pred_year2 - G_M331$B_pred_year1) / G_M331$REMPER
}

#### M332

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "M332",]$Best.Mod == "NA"){

    G_M332$B_pred_year1 <- predict(get(paste("nls_M332.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M332",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M332$MEASTIME_t1,
                                               "STDAGE_t2" = G_M332$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M332$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M332$STDAGE_t1,
                                                 "DeltaPDSI" = G_M332$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M332$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M332$STDAGE_t1,
                                                   "B_L_prop" = G_M332$B_L_prop, 
                                                   "DeltaPDSI" = G_M332$DeltaPDSI)
                                        } )
    
    G_M332$B_pred_year2 <- predict(get(paste("nls_M332.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M332",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M332$MEASTIME_t2,
                                               "STDAGE_t2" = G_M332$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M332$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_M332$STDAGE_t1,
                                                 "DeltaPDSI" = G_M332$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M332$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_M332$STDAGE_t1,
                                                   "B_L_prop" = G_M332$B_L_prop, 
                                                   "DeltaPDSI" = G_M332$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_M332$DeltaB_year<- (G_M332$B_pred_year2 - G_M332$B_pred_year1) / G_M332$REMPER
}

#### M333

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "M333",]$Best.Mod == "NA"){

    G_M333$B_pred_year1 <- predict(get(paste("nls_M333.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M333",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M333$MEASTIME_t1,
                                               "STDAGE_t2" = G_M333$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M333$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M333$STDAGE_t1,
                                                 "DeltaPDSI" = G_M333$DeltaPDSI, na.rm = T)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M333$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M333$STDAGE_t1,
                                                   "B_L_prop" = G_M333$B_L_prop, 
                                                   "DeltaPDSI" = G_M333$DeltaPDSI)
                                        } )
    
    G_M333$B_pred_year2 <- predict(get(paste("nls_M333.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M333",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M333$MEASTIME_t2,
                                               "STDAGE_t2" = G_M333$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M333$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_M333$STDAGE_t1,
                                                 "DeltaPDSI" = G_M333$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M333$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_M333$STDAGE_t1,
                                                   "B_L_prop" = G_M333$B_L_prop, 
                                                   "DeltaPDSI" = G_M333$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_M333$DeltaB_year<- (G_M333$B_pred_year2 - G_M333$B_pred_year1) / G_M333$REMPER
}

#### M334

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "M334",]$Best.Mod == "NA"){

    G_M334$B_pred_year1 <- predict(get(paste("nls_M334.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M334",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M334$MEASTIME_t1,
                                               "STDAGE_t2" = G_M334$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M334$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M334$STDAGE_t1,
                                                 "DeltaPDSI" = G_M334$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M334$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M334$STDAGE_t1,
                                                   "B_L_prop" = G_M334$B_L_prop, 
                                                   "DeltaPDSI" = G_M334$DeltaPDSI)
                                        } )
    
    G_M334$B_pred_year2 <- predict(get(paste("nls_M334.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M334",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M334$MEASTIME_t2,
                                               "STDAGE_t2" = G_M334$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M334$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_M334$STDAGE_t1,
                                                 "DeltaPDSI" = G_M334$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M334$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_M334$STDAGE_t1,
                                                   "B_L_prop" = G_M334$B_L_prop, 
                                                   "DeltaPDSI" = G_M334$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_M334$DeltaB_year<- (G_M334$B_pred_year2 - G_M334$B_pred_year1) / G_M334$REMPER
}

#### M341

if(!Best_mods.P_bal[Best_mods.P_bal$Code == "M341",]$Best.Mod == "NA"){

    G_M341$B_pred_year1 <- predict(get(paste("nls_M341.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M341",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M341$MEASTIME_t1,
                                               "STDAGE_t2" = G_M341$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M341$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M341$STDAGE_t1,
                                                 "DeltaPDSI" = G_M341$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M341$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M341$STDAGE_t1,
                                                   "B_L_prop" = G_M341$B_L_prop, 
                                                   "DeltaPDSI" = G_M341$DeltaPDSI)
                                        } )
    
    G_M341$B_pred_year2 <- predict(get(paste("nls_M341.",  Best_mods.P_bal[Best_mods.P_bal$Code == "M341",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M341$MEASTIME_t2,
                                               "STDAGE_t2" = G_M341$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M341$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_M341$STDAGE_t1,
                                                 "DeltaPDSI" = G_M341$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M341$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_M341$STDAGE_t1,
                                                   "B_L_prop" = G_M341$B_L_prop, 
                                                   "DeltaPDSI" = G_M341$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_M341$DeltaB_year<- (G_M341$B_pred_year2 - G_M341$B_pred_year1) / G_M341$REMPER
}

```




```{r}
### Data wrangling

BK_df <-  cbind(Region = c(rep("east", length(G_211$pltID)), 
                                rep("east", length(G_212$pltID)),
                                rep("east", length(G_221$pltID)),
                                rep("east", length(G_222$pltID)),
                                rep("east", length(G_223$pltID)),
                                rep("east", length(G_231$pltID)),
                                rep("east", length(G_232$pltID)),
                                rep("east", length(G_234$pltID)),
                                rep("east", length(G_251$pltID)),
                                rep("east", length(G_255$pltID)),
                                #rep("interior west", length(G_313$pltID)),
                                #rep("interior west", length(G_331$pltID)),
                                rep("interior west", length(G_332$pltID)),
                                rep("east", length(G_M211$pltID)),
                                rep("east", length(G_M223$pltID)),
                                #rep("pacific", length(G_M242$pltID)),
                                rep("pacific", length(G_M261$pltID)),
                                #rep("interior west", length(G_M313$pltID)),
                                #rep("interior west", length(G_M331$pltID)),
                                #rep("interior west", length(G_M332$pltID)),
                                #rep("interior west", length(G_M333$pltID)),
                                rep("interior west", length(G_M334$pltID))),
                                #rep("interior west", length(G_M341$pltID))),
                # Ecoprovince = c(rep("211 - Northeastern Mixed Forest", length(G_211$pltID)), 
                #                 rep("212 - Laurentian Mixed Forest", length(G_212$pltID)),
                #                 rep("221 - Eastern Broadleaf Forest", length(G_221$pltID)),
                #                 rep("222 - Midwest Broadleaf Forest", length(G_222$pltID)),
                #                 rep("223 - Central Interior Broadleaf Forest", length(G_223$pltID)),
                #                 rep("231 - Southeastern Mixed Forest", length(G_231$pltID)),
                #                 rep("232 - Outer Coastal Plain Mixed Forest", length(G_232$pltID)),
                #                 rep("234 - Lower Mississippi Riverine Forest", length(G_234$pltID)),
                #                 rep("251 - Temperate Prairie Parkland", length(G_251$pltID)),
                #                 rep("255 - Subtropical Prairie Parkland", length(G_255$pltID)),
                #                 rep("313 - Colorado Plateau Semi-Desert", length(G_313$pltID)),
                #                 rep("331 - Great Plains/Palouse Dry Steppe", length(G_331$pltID)),
                #                 rep("332 - Great Plains Steppe", length(G_332$pltID)),
                #                 rep("M211 - Adirondack-New England Mixed forest - Coniferous Forest - Alpine Meadow", length(G_M211$pltID)),
                #                 rep("M223 - Ozark Broadleaf Forest Meadow", length(G_M223$pltID)),
                #                 rep("M242 - Cascade Mixed Forest", length(G_M242$pltID)),
                #                 rep("M261 - Sierran Steppe - Mixed Forest - Coniferous Forest - Alpine Meadow", length(G_M261$pltID)),
                #                 rep("M313 - Arizona-New Mexico Mountains Semi-Desert - Open Woodland - Coniferous Forest - Alpine Meadow", length(G_M313$pltID)),
                #                 rep("M331 - Southern Rocky Mountain Steppe - Open Woodland - Coniferous Forest - Alpine Meadow", length(G_M331$pltID)),
                #                 rep("M332 - Middle Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow", length(G_M332$pltID)),
                #                 rep("M333 - Northern Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow", length(G_M333$pltID)),
                #                 rep("M334 - Black Hills Coniferous Forest", length(G_M334$pltID)),
                #                 rep("M341 - Nevada-Utah Mountains Semi-Desert - Coniferous Forest - Alpine Meadow", length(G_M341$pltID))),
                Ecoprovince = c(rep("211", length(G_211$pltID)), 
                                rep("212", length(G_212$pltID)),
                                rep("221", length(G_221$pltID)),
                                rep("222", length(G_222$pltID)),
                                rep("223", length(G_223$pltID)),
                                rep("231", length(G_231$pltID)),
                                rep("232", length(G_232$pltID)),
                                rep("234", length(G_234$pltID)),
                                rep("251", length(G_251$pltID)),
                                rep("255", length(G_255$pltID)),
                                #rep("313", length(G_313$pltID)),
                                #rep("331", length(G_331$pltID)),
                                rep("332", length(G_332$pltID)),
                                rep("M211", length(G_M211$pltID)),
                                rep("M223", length(G_M223$pltID)),
                                #rep("M242", length(G_M242$pltID)),
                                rep("M261", length(G_M261$pltID)),
                                #rep("M313", length(G_M313$pltID)),
                                #rep("M331", length(G_M331$pltID)),
                                #rep("M332", length(G_M332$pltID)),
                                #rep("M333", length(G_M333$pltID)),
                                rep("M334", length(G_M334$pltID))),
                                #rep("M341", length(G_M341$pltID))),
                rbind(G_211[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      G_212[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      G_221[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      G_222[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      G_223[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      G_231[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      G_232[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      G_234[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      G_251[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      G_255[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      #G_313[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      #G_331[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      G_332[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      G_M211[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      G_M223[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      #G_M242[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      G_M261[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      #G_M313[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      #G_M331[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      #G_M332[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      #G_M333[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      G_M334[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")]))
                      #G_M341[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")]))

## reshape data wide to long
BK_df_long <- reshape2::melt(BK_df, id.vars = c("Region", "Ecoprovince"), measure.vars = c("DeltaB_age", "DeltaB_year"))
```


```{r}
## summarySE function

# http://www.cookbook-r.com/Graphs/Plotting_means_and_error_bars_(ggplot2)/

## Gives count, mean, standard deviation, standard error of the mean, and confidence interval (default 95%).
##   data: a data frame.
##   measurevar: the name of a column that contains the variable to be summariezed
##   groupvars: a vector containing names of columns that contain grouping variables
##   na.rm: a boolean that indicates whether to ignore NA's
##   conf.interval: the percent range of the confidence interval (default is 95%)
summarySE <- function(data=NULL, measurevar, groupvars=NULL, na.rm=FALSE,
                      conf.interval=.95, .drop=TRUE) {
    
    # New version of length which can handle NA's: if na.rm==T, don't count them
    length2 <- function (x, na.rm=FALSE) {
        if (na.rm) sum(!is.na(x))
        else       length(x)
    }

    # This does the summary. For each group's data frame, return a vector with
    # N, mean, and sd
    datac <- plyr::ddply(data, groupvars, .drop=.drop,
      .fun = function(xx, col) {
        c(N    = length2(xx[[col]], na.rm=na.rm),
          mean = mean   (xx[[col]], na.rm=na.rm),
          sd   = sd     (xx[[col]], na.rm=na.rm)
        )
      },
      measurevar
    )

    # Rename the "mean" column    
    datac <- plyr::rename(datac, c("mean" = measurevar))

    datac$se <- datac$sd / sqrt(datac$N)  # Calculate standard error of the mean

    # Confidence interval multiplier for standard error
    # Calculate t-statistic for confidence interval: 
    # e.g., if conf.interval is .95, use .975 (above/below), and use df=N-1
    ciMult <- qt(conf.interval/2 + .5, datac$N-1)
    datac$ci <- datac$se * ciMult

    return(datac)
}

BK_df_age_avg <- summarySE(BK_df, measurevar = "DeltaB_age", groupvars = c("Region","Ecoprovince"), na.rm = T)
colnames(BK_df_age_avg)[4] <- "value" # rename the mean to "Value" to match other df

BK_df_age_avg <- BK_df_age_avg[order(BK_df_age_avg$value, decreasing = T),] ### order from greatest to least

BK_df_year_avg <- summarySE(BK_df, measurevar = "DeltaB_year", groupvars = c("Region","Ecoprovince"), na.rm = T)
colnames(BK_df_year_avg)[4] <- "value" # rename the mean to "Value" to match other df

BK_df_year_avg$Ecoprovince <- factor(BK_df_year_avg$Ecoprovince, levels=BK_df_age_avg$Ecoprovince)

## stack the dataframes
BK_df_avg <- rbind(BK_df_age_avg ,BK_df_year_avg )
BK_df_avg$variable <- c(rep("DeltaB_age", 15), rep("DeltaB_year", 15))

BK_df_avg$Ecoprovince <- factor(BK_df_avg$Ecoprovince, levels=BK_df_age_avg$Ecoprovince) ## reorder the levels of the df to match decraseing Delta_B_age order


##############
##################  NEED TO RE-ORDER BK_df_long  factor levels to get order correct for plotting
BK_df_long$Ecoprovince <- factor(BK_df_long$Ecoprovince, levels=BK_df_age_avg$Ecoprovince)
```


#### make a fig
```{r}
gg_BK1 <- ggplot(aes(x=Ecoprovince, y = value, group = variable), data = BK_df_long) +
          geom_hline(yintercept = 0, lty = 2) +
          
          geom_jitter(aes(x=Ecoprovince, y = value, fill = variable), data = BK_df_long,
                      position = position_jitterdodge(0.75), 
                      shape = ".", alpha = 0.05, col = "gray") +
         
          facet_grid(.~Region, scales= "free", space = "free_x", drop = TRUE) +
          
          geom_point(aes(x=Ecoprovince, y = value, col = variable), 
                    data = BK_df_avg, position = position_dodge(width = 0.75),  shape = 15) + 
          geom_errorbar(aes(x=Ecoprovince, y = value, ymax = value+ci, ymin = value-ci, col = variable), 
                    data = BK_df_avg, position = position_dodge(width = 0.75), width = 0.75) +
          scale_color_manual(values = c("#E69F00", "#009E73"),
                             labels = c(expression(Delta*B~age), expression(Delta*B~growth~enhancement)), name="") +
          guides(fill="none") +  ## removed second legend
          ylab(expression(Delta*B~"(Mg ha"^-1~yr^-1*")")) +
  
          theme_classic() +
          theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
                legend.position = "top", legend.margin=margin(c(0,0,0,0))) +
          coord_cartesian(ylim=c(-4, 4))
          
          
#tiff("FIA_Bookkeeper_v1b_12.1.2022.tiff", width = 19, height = 8, units = "cm", res = 600, compression ="lzw")        
gg_BK1
#dev.off()
```

### 3. stand age densities

```{r}
## step 1 take first & last record or each plot 

#### TEMPORALLY BALANCING: 

### grab the pltIDs with >= 2 observations
g1.pltIDs <-  names(table(G$pltID) [table(G$pltID) >1])

# Subset 
G_bal <- G[G$pltID %in% g1.pltIDs,] 

G_first <- G_bal %>% group_by(pltID) %>% slice(c(1))
G_last <- G_bal %>% group_by(pltID) %>% slice(c(n()))

## Do some data wrangling
G_first <- G_first[,c("ECOPROVCD", "STDAGE_t1")]  #subset the needed columns
colnames(G_first)[2] <- "STDAGE"
G_first$meas <- "first"

G_first_mtnWest <- G[G$ECOPROVCD %in% c("313", "M313", "M331", "M341"),c("ECOPROVCD", "STDAGE_t1")]
colnames(G_first_mtnWest)[2] <- "STDAGE"
G_first_mtnWest$meas <- "first"

G_last <- G_last[,c("ECOPROVCD", "STDAGE_t2")]  #subset the needed columns
colnames(G_last)[2] <- "STDAGE"
G_last$meas <- "most-recent"

G_last_mtnWest <- G[G$ECOPROVCD %in% c("313", "M313", "M331", "M341"),c("ECOPROVCD", "STDAGE_t2")]
colnames(G_last_mtnWest)[2] <- "STDAGE"
G_last_mtnWest$meas <- "most-recent"

## stack the two data.frames
G_age <- rbind(G_first,G_first_mtnWest, G_last, G_last_mtnWest)
G_age$meas <- as.factor(G_age$meas)
G_age$ECOPROVCD <- droplevels(G_age$ECOPROVCD)



## subset 
G_age <- G_age[G_age$ECOPROVCD %in% c("221","251", "222", "234", "223", "M223", "211", "M211", "231", "232", "212", "255", "313", "332", "M333", "M313", "331", "M332", "M334", "M341", "M331", "M242", "M261"),]

G_age$ECOPROVCD <- factor(G_age$ECOPROVCD, levels= c("221","251", "222", "234", "223", "M223", "211", "M211", "231", "232", "212", "255", "313", "332", "M333", "M313", "331", "M332", "M334", "M341", "M331", "M242", "M261"))
```

#### make a fig
```{r, fig.width = 4, fig.height = 16}
library(ggridges)


gg_age_dist <- ggplot(aes(y= as.character(ECOPROVCD), x=STDAGE), data = G_age) +
               geom_density_ridges(aes(fill = meas, point_color = meas, linetype = meas), scale = 0.6,
                                   quantile_lines = TRUE, quantiles = 2,
                                   jittered_points = TRUE, position =  "raincloud",
                                   #quantile_lines = TRUE, scale = 0.9, alpha = 0.7,    
                                   #vline_size = 1, vline_color = "red",
                                   alpha = 0.4,
                                   point_shape = ".",  
                                   point_alpha = 0.1) +
               theme_classic() + theme(legend.position = "top",
                                       legend.text = element_text(size = 10), 
                                       legend.key.size = unit(0.75, "lines")) +
               scale_fill_manual(values = c("#CC79A7", "#56B4E9")) +
               #scale_linetype_manual("Line", (values =c("solid","dotted"))) +
               coord_cartesian(xlim=c(0, 150)) + xlab("Stand Age (years)") + ylab("Ecoprovince") +
               theme(legend.title = element_blank(), legend.margin=margin(c(0,0,0,0))) + 
  
               scale_y_discrete(limits = rev(c("221","251", "222", "234", "223", "M223", "211", "M211", 
                                               "231", "232", "212", "255", "313", "332", "M333", "M313", 
                                               "331", "M332", "M334", "M341", "M331", "M242", "M261")))
               
# tiff("FIA_AgeDists_v1_12.1.2022.tiff", width = 6, height = 22, units = "cm", res = 600, compression ="lzw")        
gg_age_dist
# dev.off()
```

```{r}
### make a figure --  Change in Stand Age Distributions vs. Delta B due to AGE (age effects)

## data wrangling 
Age_effect_df <- merge(summarySE(BK_df, measurevar = "diff_STDAGE", groupvars = c("Region","Ecoprovince"), na.rm = T), summarySE(BK_df, measurevar = "DeltaB_age", groupvars = c("Region","Ecoprovince"), na.rm = T), by = c("Region", "Ecoprovince"))

## ggplot

gg.age_effect <- ggplot(aes(x= diff_STDAGE, y= DeltaB_age, shape = Region, col = Ecoprovince),
                        data = Age_effect_df) + 
                 #geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +   
                 geom_point() +
                 geom_errorbarh(aes(xmin = diff_STDAGE-se.x, xmax = diff_STDAGE+se.x)) +
                 geom_errorbar(aes(ymin = DeltaB_age-se.y, ymax = DeltaB_age+se.y)) +
                 theme_classic() + 
                 theme(legend.position = "top", strip.text.x = element_text(size = 6), aspect.ratio =1) + 
                 xlab(expression(~Delta*"Stand Age (yrs)")) + 
                 ylab(expression(~Delta*"B age (Mg ha"^1*" yr"^-1*")")) + guides(shape = guide_legend(ncol =1))


gg.age_effect
```


----


# Analysis 2: Temporally-balanced, No-harvest


```{r}
# ## load G dataset
# load("C:/Users/hogan.jaaron/Dropbox/FIA_R/BiomassGrowth/Biomass_Growth_calculations_june2022/FIA_G_calc.Rdata")
# # load("C:/Users/hogie/Dropbox/FIA_R/BiomassGrowth/Biomass_Growth_calculations_june2022/FIA_G_calc.Rdata")    # if working on P-50
# 
# ## FILTER THE DATASTET -- Plot Selection Criteria
# ## apply filters to the FIA_G_calc data frame
# #
# # ### create p_Cond_surv --- the combined  plot condition and survey table dataframe for subsetting
# #
# # for FIA plot conditions
# load("C:/Users/hogan.jaaron/Dropbox/FIA_R/Plot_Conditions_rFIA/FIA_conditions_allPlots.Rdata")
# # load("C:/Users/hogie/Dropbox/FIA_R/Plot_Conditions_rFIA/FIA_conditions_allPlots.Rdata")   # if working on P-50
# FIA_conditions$STATE <- as.factor(FIA_conditions$STATE)
# FIA_conditions$PROP_BASIS <- as.factor(FIA_conditions$PROP_BASIS)
# FIA_conditions$MIXEDCONFCD <- as.factor(FIA_conditions$MIXEDCONFCD)
# FIA_conditions$DWM_FUELBED_TYPCD  <-  as.factor(FIA_conditions$DWM_FUELBED_TYPCD)
# 
# # for FIA plots (plot table)
# load("C:/Users/hogan.jaaron/Dropbox/FIA_R/Plot_Conditions_rFIA/FIA_plots_allPlots.Rdata")
# # load("C:/Users/hogie/Dropbox/FIA_R/Plot_Conditions_rFIA/FIA_plots_allPlots.Rdata")   # if working on P-50
# FIA_plots$STATE <- as.factor(FIA_plots$STATE)
# FIA_plots$ECOSUBCD <- as.factor(FIA_plots$ECOSUBCD)
# 
# ##### COMBINE PLOT and CODITION TABLES
# P_cond <- dplyr::left_join(FIA_conditions, FIA_plots, by = c("STATE", "PLOT", "INVYR", "PLT_CN" = "CN"))  #PLT_CN = CN  merges condition table to the plot table using PLT_CN (see FIA data user guide 8.0)
# 
# #### load survey tables
# load("C:/Users/hogan.jaaron/Dropbox/FIA_R/Plot_Conditions_rFIA/FIA_survey.Rdata")
# # load("C:/Users/hogie/Dropbox/FIA_R/Plot_Conditions_rFIA/FIA_survey.Rdata")     # if working on P-50
# ##### COMBINE P_cond and survey tables
# P_cond_surv <- dplyr::left_join(P_cond, FIA_survey[,c("CN", "P3_OZONE_IND", "ANN_INVENTORY")], by = c("SRV_CN" = "CN"))
# 
# ###### COMBINE G_calc -- for plot filtering at T2
# G <- dplyr::left_join(FIA_G_calc, P_cond_surv[,c("STATE", "PLT_CN", "STDAGE", "INVYR", "STDORGCD", "CONDPROP_UNADJ", "SITECLCD","STDSZCD", "COND_STATUS_CD", "P3_OZONE_IND", "ANN_INVENTORY")], by = c("STATE", "CN" = "PLT_CN", "INVYR")) %>% distinct()  # 377825 observations
# 
# ### rename STDAGE for STDAGE_t2
# colnames(G)[39] <- "STDAGE_t2"
# 
# ##########################
# #### APPLYING FILTERS ####
# 
# ## remove cases of NA's STDAGE columns
# G <- G[!is.na(G$STDAGE_t2) & !G$STDAGE_t2 == 9999,]
# ## Filter out plantations
# G <- G[G$STDORGCD == 0, ]
# ## Filter plots with a single condition using a 95% threshold for CONDPROP_UNADJ
# G <- G[G$CONDPROP_UNADJ >= 0.95, ]
# ### Filter out SITECLCD 7 (non productive stands - those with less than 20 ft3/ac/yr)
# G <- G[!G$SITECLCD == 7,]
# ### Filter out non-stocked plots (with STDSZCD == 5)
# G <- G[!G$STDSZCD == 5,]
# 
# ### new filters - MAY 2022
# ### Filter out the the non-accessible plots -- COND_STATUS_CD == 1 is accessible
# G <- G[G$COND_STATUS_CD == 1,]
# ### Filter by survey table --- annual inventories YES
# G <- G[G$ANN_INVENTORY == "Y",]
# ### Filter by survey table --- B3_OZONE NO
# G <- G[G$P3_OZONE_IND == "N",]
# 
# #### DONE APPLYING FILTERS ####
# ###############################
# 
# ## dealing with ECOPROVINCES:
# G$ECOPROVCD <- stringr::str_replace_all(gsub('.{2}$', '', G$ECOSUBCD), stringr::fixed(" "), "")
# 
# G[G$ECOPROVCD == "M332A",]$ECOPROVCD <- "M332"
# G[G$ECOPROVCD == "M332E",]$ECOPROVCD <- "M332"
# 
# G$ECOPROVCD <-  as.factor(G$ECOPROVCD)
# 
# ## calculate & add MEASTIME_avg
# G$MEASTIME_avg <- (G$MEASTIME_t2 + G$MEASTIME_t2) /2
# 
# ############################# For STDAGE T1
# 
# ### subset the condition table to include only the dominant condition for 
# FIA_single_conditions <- FIA_conditions %>% group_by(STATE, PLT_CN, INVYR) %>% filter(row_number() == which.max(CONDPROP_UNADJ))  %>% select(STATE, PLT_CN, INVYR, CONDPROP_UNADJ, STDAGE) %>% unique()
# 
# df_STDAGE_t1 <- as.data.frame(FIA_single_conditions[FIA_single_conditions$PLT_CN %in% G$PREV_PLT_CN ,c("STATE", "PLT_CN",  "INVYR", "STDAGE")])
#                           
# colnames(df_STDAGE_t1)[2] <- "PREV_PLT_CN"
# colnames(df_STDAGE_t1)[4] <- "STDAGE_t1"
# 
# ## left_join  to add to the G dataframe
# G <- left_join(G, df_STDAGE_t1[,c("STATE", "PREV_PLT_CN", "STDAGE_t1")], by = c("STATE", "PREV_PLT_CN"))
# 
# ## for is.na STDAGE_t1 assign STDAGE_t2 value    ## done for 405 records
# G[is.na(G$STDAGE_t1),]$STDAGE_t1 <- G[is.na(G$STDAGE_t1),]$STDAGE_t2
# 
# ## difference in STDAGE
# G$diff_STDAGE <- G$STDAGE_t2 - G$STDAGE_t1
# ############################################################  (END for STDAGE T1)
# 
# save(G, file = "C:/Users/hogan.jaaron/Dropbox/FIA_R/Starter_FIA_data_processing/G_dataset.Rdata")
# 
# rm(P_cond, FIA_G_calc, FIA_conditions, FIA_single_conditions, FIA_plots, FIA_survey, P_cond_surv, df_STDAGE_t1)  #removes other data frames

### Load G dataset
load("C:/Users/hogan.jaaron/Dropbox/FIA_R/Starter_FIA_data_processing/G_Nov2022.Rdata")
##-------------------------------------------------------------------------------------------------------------------###
###  CODE TO CALCULATE delta_PDSI

## Note: This code calculates delta_PDSI -- the difference in the Palmer Drought Severity Index from the baseline (1960-1989) 
## and the census interval -- uncomment to run -- it takes a little while (a few hours) to run, so the output is saved and read in below 

#####################################################
#####################################################

# library(terra)
# ## read in the the G data file (has spatial coordinates for plot locations)
# load("C:/Users/hogan.jaaron/Dropbox/FIA_R/Starter_FIA_data_processing/G_dataset.Rdata")
# 
# ### read in the data -
# pdsi1 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_1_PRISM.nc")
# names(pdsi1) <- as.character(1895:2022)
# 
# pdsi2 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_2_PRISM.nc")
# names(pdsi2) <- as.character(1895:2022)
# 
# pdsi3 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_3_PRISM.nc")
# names(pdsi3) <- as.character(1895:2022)
# 
# pdsi4 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_4_PRISM.nc")
# names(pdsi4) <- as.character(1895:2022)
# 
# pdsi5 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_5_PRISM.nc")
# names(pdsi5) <- as.character(1895:2022)
# 
# ###### first pass: limited analysis to growing season - June, July and August -
# pdsi6 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_6_PRISM.nc")
# names(pdsi6) <- as.character(1895:2022)
# 
# pdsi7 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_7_PRISM.nc")
# names(pdsi7) <- as.character(1895:2022)
# 
# pdsi8 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_8_PRISM.nc")
# names(pdsi8) <- as.character(1895:2022)
# 
# ## make null dataframe
# G_pdsi_data <-  data.frame(pltID = G$pltID,
#                          LAT = G$LAT,
#                          LON = G$LON,
#                          MEASTIME_t2 = G$MEASTIME_t2,
#                          pdsi_baseline = rep(-9999, length(G$pltID)),
#                          pdsi_growInt = rep(-9999, length(G$pltID)))
# 
# ## makes spatVector for spatial points of plot locations
# G_pts <- vect(cbind(G_pdsi_data$LON, G_pdsi_data$LAT), crs="+proj=longlat +datum=WGS84")
# 
# ##################################################### START FOR LOOP
# ### for loop to extract time-series data for each plot location
# for(i in 1:length(G_pdsi_data$pltID)){
# 
#   ### extract values
#   pdsi_vec.1 <- unlist(terra::extract(pdsi1, G_pts[i]))
# 
#   pdsi_vec.2 <- unlist(terra::extract(pdsi2, G_pts[i]))
# 
#   pdsi_vec.3 <- unlist(terra::extract(pdsi3, G_pts[i]))
# 
#   pdsi_vec.4 <- unlist(terra::extract(pdsi4, G_pts[i]))
# 
#   pdsi_vec.5 <- unlist(terra::extract(pdsi5, G_pts[i]))
# 
#   pdsi_vec.6 <- unlist(terra::extract(pdsi6, G_pts[i]))
# 
#   pdsi_vec.7 <- unlist(terra::extract(pdsi7, G_pts[i]))
# 
#   pdsi_vec.8 <- unlist(terra::extract(pdsi8, G_pts[i]))
# 
#   ### calculate the average baseline value 1960-1989 --- 30 year climate normal
#   G_pdsi_data$pdsi_baseline[i] <- mean(c(pdsi_vec.1[as.character(rep(1960:1989))],
#                                          pdsi_vec.2[as.character(rep(1960:1989))],
#                                          pdsi_vec.3[as.character(rep(1960:1989))],
#                                          pdsi_vec.4[as.character(rep(1960:1989))],
#                                          pdsi_vec.5[as.character(rep(1960:1989))],
#                                          pdsi_vec.6[as.character(rep(1960:1989))],
#                                          pdsi_vec.7[as.character(rep(1960:1989))],
#                                          pdsi_vec.8[as.character(rep(1960:1989))]),
#                                        na.rm = T)
# 
#   ### calculate the mean over the growth interval
#   G_pdsi_data$pdsi_growInt[i] <- mean(c(pdsi_vec.1[names(pdsi_vec.1) %in%
#                                                              seq(floor(G_pdsi_data$MEASTIME_t2[i] -10), floor(G_pdsi_data$MEASTIME_t2[i]))],
#                                         pdsi_vec.2[names(pdsi_vec.2) %in%
#                                                              seq(floor(G_pdsi_data$MEASTIME_t2[i] -10), floor(G_pdsi_data$MEASTIME_t2[i]))],
#                                         pdsi_vec.3[names(pdsi_vec.3) %in%
#                                                              seq(floor(G_pdsi_data$MEASTIME_t2[i] -10), floor(G_pdsi_data$MEASTIME_t2[i]))],
#                                         pdsi_vec.4[names(pdsi_vec.4) %in%
#                                                              seq(floor(G_pdsi_data$MEASTIME_t2[i] -10), floor(G_pdsi_data$MEASTIME_t2[i]))],
#                                         pdsi_vec.5[names(pdsi_vec.5) %in%
#                                                              seq(floor(G_pdsi_data$MEASTIME_t2[i] -10), floor(G_pdsi_data$MEASTIME_t2[i]))],
#                                         pdsi_vec.6[names(pdsi_vec.6) %in%
#                                                              seq(floor(G_pdsi_data$MEASTIME_t2[i] -10), floor(G_pdsi_data$MEASTIME_t2[i]))],
#                                         pdsi_vec.7[names(pdsi_vec.7) %in%
#                                                              seq(floor(G_pdsi_data$MEASTIME_t2[i] -10), floor(G_pdsi_data$MEASTIME_t2[i]))],
#                                         pdsi_vec.8[names(pdsi_vec.8) %in%
#                                                              seq(floor(G_pdsi_data$MEASTIME_t2[i] -10), floor(G_pdsi_data$MEASTIME_t2[i]))]),
#                                     na.rm = T)
# 
# } ## end for loop
# #####################################################
# 
# ## make column for difference
# G_pdsi_data$DeltaPDSI <-  G_pdsi_data$pdsi_growInt - G_pdsi_data$pdsi_baseline
# 
# ### deal with NaNs
# NaN_vec  <- as.numeric(row.names(G_pdsi_data[is.na(G_pdsi_data$DeltaPDSI),]))
# 
# ### for loop to extract time-series data for each plot location
# for(i in 1:length(NaN_vec)){
# 
#   ### extract values
#   pdsi_vec.1 <- unlist(terra::extract(pdsi1, G_pts[NaN_vec[i]], method = "bilinear"))
# 
#   pdsi_vec.2 <- unlist(terra::extract(pdsi2, G_pts[NaN_vec[i]], method = "bilinear"))
# 
#   pdsi_vec.3 <- unlist(terra::extract(pdsi3, G_pts[NaN_vec[i]], method = "bilinear"))
# 
#   pdsi_vec.4 <- unlist(terra::extract(pdsi4, G_pts[NaN_vec[i]], method = "bilinear"))
# 
#   pdsi_vec.5 <- unlist(terra::extract(pdsi5, G_pts[NaN_vec[i]], method = "bilinear"))
# 
#   pdsi_vec.6 <- unlist(terra::extract(pdsi6, G_pts[NaN_vec[i]], method = "bilinear"))
# 
#   pdsi_vec.7 <- unlist(terra::extract(pdsi7, G_pts[NaN_vec[i]], method = "bilinear"))
# 
#   pdsi_vec.8 <- unlist(terra::extract(pdsi8, G_pts[NaN_vec[i]], method = "bilinear"))
# 
#   ### calculate the average baseline value 1960-1989 --- 30 year climate normal
#   G_pdsi_data$pdsi_baseline[NaN_vec[i]] <- mean(c(pdsi_vec.1[as.character(rep(1960:1989))],
#                                                   pdsi_vec.2[as.character(rep(1960:1989))],
#                                                   pdsi_vec.3[as.character(rep(1960:1989))],
#                                                   pdsi_vec.4[as.character(rep(1960:1989))],
#                                                   pdsi_vec.5[as.character(rep(1960:1989))],
#                                                   pdsi_vec.6[as.character(rep(1960:1989))],
#                                                   pdsi_vec.7[as.character(rep(1960:1989))],
#                                                   pdsi_vec.8[as.character(rep(1960:1989))]),
#                                                 na.rm = T)
# 
#   ### calculate the mean over the growth interval
#   G_pdsi_data$pdsi_growInt[NaN_vec[i]] <- mean(c(pdsi_vec.1[names(pdsi_vec.1) %in%
#                                                              seq(floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]] -10), floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]]))],
#                                                 pdsi_vec.2[names(pdsi_vec.2) %in%
#                                                              seq(floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]] -10), floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]]))],
#                                                 pdsi_vec.3[names(pdsi_vec.3) %in%
#                                                              seq(floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]] -10), floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]]))],
#                                                 pdsi_vec.4[names(pdsi_vec.4) %in%
#                                                              seq(floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]] -10), floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]]))],
#                                                 pdsi_vec.5[names(pdsi_vec.5) %in%
#                                                              seq(floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]] -10), floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]]))],
#                                                  pdsi_vec.6[names(pdsi_vec.6) %in%
#                                                              seq(floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]] -10), floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]]))],
#                                                  pdsi_vec.7[names(pdsi_vec.7) %in%
#                                                              seq(floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]] -10), floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]]))],
#                                                  pdsi_vec.8[names(pdsi_vec.8) %in%
#                                                              seq(floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]] -10), floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]]))]),
#                                                na.rm = T)
# 
# } ## end for loop
# #####################################################
# 
# ## make column for difference
# G_pdsi_data$DeltaPDSI <-  G_pdsi_data$pdsi_growInt - G_pdsi_data$pdsi_baseline
# 
# ########################################
# ### save the result
# setwd("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI")
# save(G_pdsi_data, file = "G_pdsi_PlotBiomass_data.Rdata")

#####################################################
#####################################################
 
load("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/G_pdsi_data_NoIngrowth_JAN-AUG.Rdata")   ## simply load ths finished data product -- the above code takes some time to run...

### transfer DeltaPDSI column to G dataframe
G$DeltaPDSI <- G_pdsi_data$DeltaPDSI

###-------------------------------------------------------------------------------------------------------------------###

## APPLY CLEANERS 

## this code removes outliers that are greater than or less than a specified quantile threshold
## analyses were done with or without these cleaners, and results did not change 
## substantially quantatively or at all qualatitively. 
## 
## I apply the quantile threshold (XT) cleaners to the FIA biomass growth (G) dataset.  
## 4 cases are explored, investigating plots which fall outside of the quantile ranges (set to 0.005, and 0.0995) for:
## 
## * case A: where the QT difference in tree incremental G (TI) is > mass balance plot G (MB) (> 99.5% diff_G positive outliers)
## * case B: where the QT difference in tree incremental G (TI) is < mass balance plot G (MB) (> 0.5% diff_G negative outliers)
## * case C: where the QT difference in tree incremental G (TI) is > 0  (> 99.5% positive outliers)
## * case D: where the QT difference in tree incremental G (TI) is > 0  (< 0.5% negative outliers)

## step 1
## calculate diff G  - tree increment grwoth method minus mass balance method
G$diff_G_MgHaYr <- G$G_obs_TreeInc_MgHaYr - G$G_MassBal_MgHaYr

## set QT: quantile threshold
QT <- 0.005

# Cleaner case A: cases where TI > MB
## positive outliers for the difference in TreeInc to MassBal G
outliers_cleanerA <- G[G$diff_G_MgHaYr > quantile(G$diff_G_MgHaYr, probs = c(1-QT)),]

# Cleaner case B: cases where TI < MB
## negative outliers for  the difference in TreeInc to MassBal G
outliers_cleanerB <- G[G$diff_G_MgHaYr < quantile(G$diff_G_MgHaYr, probs = c(QT)),]

# Cleaner case C: TI > 0
G_cleanerC <- G[G$G_obs_TreeInc_MgHaYr > 0,]
## positive outliers
outliers_cleanerC <- G_cleanerC[G_cleanerC$G_obs_TreeInc_MgHaYr > quantile(G_cleanerC$G_obs_TreeInc_MgHaYr, probs = c(1-QT)),]

# Cleaner case D: TI < 0
G_cleanerD <- G[G$G_obs_TreeInc_MgHaYr < 0,]
## negative outliers
outliers_cleanerD <- G_cleanerD[G_cleanerD$G_obs_TreeInc_MgHaYr < quantile(G_cleanerD$G_obs_TreeInc_MgHaYr, probs = c(QT)),]

# # compare cases A and C
# ##  A in C
# outliers_cleanerA[,"pltID"] [outliers_cleanerA[,"pltID"] %in% outliers_cleanerC[,"pltID"]]
# ## C in A
# outliers_cleanerC[,"pltID"] [outliers_cleanerC[,"pltID"] %in% outliers_cleanerA[,"pltID"]]

# # compare cases B and D 
# ##  B in D
# outliers_cleanerB[,"pltID"] [outliers_cleanerB[,"pltID"] %in% outliers_cleanerD[,"pltID"]]
# ## D in B
# outliers_cleanerD[,"pltID"] [outliers_cleanerD[,"pltID"] %in% outliers_cleanerB[,"pltID"]]

## make list of cleaner pltIDs
cleaner_pltIDs <- c(outliers_cleanerA$pltID, outliers_cleanerB$pltID, outliers_cleanerC$pltID, outliers_cleanerD$pltID)
cleaner_pltIDs <- cleaner_pltIDs[order(cleaner_pltIDs)]

#### APPLY CLEANERS!
G <- G[!G$pltID %in% cleaner_pltIDs,]

###-------------------------------------------------------------------------------------------------------------------###

#### TEMPORALLY BALANCING: 

### grab the pltIDs with >= 2 observations
g1.pltIDs <-  names(table(G$pltID) [table(G$pltID) >1])

# Subset 
G_bal <- G[G$pltID %in% g1.pltIDs,] 

G_bal <- G_bal %>% group_by(pltID) %>% slice(c(1,n()))

### remove plot locations with harvest 
G_bal <-  G_bal[!G_bal$pltID %in%  G_bal[G_bal$Harvest == T,]$pltID,]
```

```{r}

## 211 - Northeastern Mixed Forest
G_211 <- G_bal[G_bal$ECOPROVCD == "211",]
## 212 - Laurentian Mixed Forest
G_212 <- G_bal[G_bal$ECOPROVCD == "212",]
## 221 -  Eastern Broadleaf Forest
G_221 <- G_bal[G_bal$ECOPROVCD == "221",]
## 222 - Midwest Broadleaf Forest
G_222 <- G_bal[G_bal$ECOPROVCD == "222",]
## 223 - Central Interior Broadleaf Forest
G_223 <- G_bal[G_bal$ECOPROVCD == "223",]
## 231 - Southeastern Mixed Forest
G_231 <- G_bal[G_bal$ECOPROVCD == "231",]
## 232 - Outer Coastal Plain Mixed Forest
G_232 <- G_bal[G_bal$ECOPROVCD == "232",]
## 234 - Lower Mississippi Riverine Forest
G_234 <- G_bal[G_bal$ECOPROVCD == "234",]
## 242 - Pacific Lowland Mixed Forest
G_242 <- G_bal[G_bal$ECOPROVCD == "242",]
## 251 - Prairie Parkland (Temperate)
G_251 <- G_bal[G_bal$ECOPROVCD == "251",]
## 255 - Prairie Parkland (Subtropical)
G_255 <- G_bal[G_bal$ECOPROVCD == "255",]
## 263 - California Coastal Steppe - Mixed Forest and Redwood Forest
G_263 <- G_bal[G_bal$ECOPROVCD == "263",]
## 313 - Colorado Plateau Semi-Desert
G_313 <- G_bal[G_bal$ECOPROVCD == "313",]
## 331 - Great Plains/Palouse Dry Steppe
G_331 <- G_bal[G_bal$ECOPROVCD == "331",]
## 332 - Great Plains Steppe
G_332 <- G_bal[G_bal$ECOPROVCD == "332",]
## 342 - Intermountain Semi-Desert
G_342 <- G_bal[G_bal$ECOPROVCD == "342",]
## M211 - Adirondack-New England Mixed forest - Coniferous Forest - Alpine Meadow
G_M211 <- G_bal[G_bal$ECOPROVCD == "M211",]
## M221 - Central Appalachian Broadleaf Forest - Coniferous Forest - Meadow
G_M221 <- G_bal[G_bal$ECOPROVCD == "M221",]
## M223 - Ozark Broadleaf Forest Meadow
G_M223 <- G_bal[G_bal$ECOPROVCD == "M223",]
## M231 - Ouachita Mixed Forest
G_M231 <- G_bal[G_bal$ECOPROVCD == "M231",]
## M242 - Cascade Mixed Forest
G_M242 <- G_bal[G_bal$ECOPROVCD == "M242",]
## M261 - Sierran Steppe - Mixed Forest - Coniferous Forest - Alpine Meadow
G_M261 <- G_bal[G_bal$ECOPROVCD == "M261",]
## M262- California Coastal Range Coniferous Forest - Open Woodland - Shrub - Meadow
G_M262 <- G_bal[G_bal$ECOPROVCD == "M262",]
## M313 - Arizona-New Mexico Mountains Semi-Desert - Open Woodland - Coniferous Forest - Alpine Meadow
G_M313 <- G_bal[G_bal$ECOPROVCD == "M313",]
## M331 - Southern Rocky Mountain Steppe - Open Woodland - Coniferous Forest - Alpine Meadow
G_M331 <- G_bal[G_bal$ECOPROVCD == "M331",]
## M332 - Middle Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow
G_M332 <- G_bal[G_bal$ECOPROVCD == "M332",]
# M333 - Northern Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow
G_M333 <- G_bal[G_bal$ECOPROVCD == "M333",]
## M334 - Black Hills Coniferous Forest
G_M334 <- G_bal[G_bal$ECOPROVCD == "M334",]

##ECOPROVINCES NOT INCLUDED:
            ## 261 - California Coastal Chaparral Forest and Shrub
            G_261 <- G_bal[G_bal$ECOPROVCD == "261",]

            ## 262 - California Dry Steppe
            G_262 <- G_bal[G_bal$ECOPROVCD == "262",]

            ## 315 - Southwest Plateau and Plains Dry Steppe and Shrub
            G_315 <- G_bal[G_bal$ECOPROVCD == "315",]

            ## 321 - Chihuahuan Semi-Desert 
            G_321 <- G_bal[G_bal$ECOPROVCD == "321",]

            ## 322 - American Semidesert and Desert
            G_322 <- G_bal[G_bal$ECOPROVCD == "322",]
  
            ## 341 - Intermountain Semi-Desert and Desert
            G_341 <- G_bal[G_bal$ECOPROVCD == "341",]
            
            ## 411 - Everglades
            G_411 <- G_bal[G_bal$ECOPROVCD == "411",]
            
            ## M341 - Nevada-Utah Mountains semi-Desert - Coniferous Forest - Alpine Meadow
            G_M341 <- G_bal[G_bal$ECOPROVCD == "M341",]
```


## 211 - Northeastern Mixed Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_211 <- round(quantile(G_211$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_211)))){
  cutvec_211 <- round(quantile(G_211$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_211 <- unname(round(cutvec_211[-length(cutvec_211)] + diff(cutvec_211)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_211$STDAGE_t2_bin<-  cut(G_211$STDAGE_t2, cutvec_211)
## then get bin means
G_211_bin_means <- tapply(G_211$B_plt_t2_MgHa, cut(G_211$STDAGE_t2,  cutvec_211), mean)

## make column weights.2
G_211$nls_weights.2 <- as.numeric(1/(G_211_bin_means[match(G_211$STDAGE_t2_bin, names(G_211_bin_means))])^2)

}

```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_211.1 <- nls(f_1, data = G_211, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_211$nls_weights.2), 
 )

## phi
try(
  nls_211.2 <- nls(f_2, data=G_211, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_211$nls_weights.2), 
 )

# phi/alpha
try(
  nls_211.3 <- nls(f_3 , data = G_211, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_211$nls_weights.2), 
 )

## test
if(exists("nls_211.1") & exists("nls_211.2") & exists("nls_211.3")){
  print(anova(nls_211.1, nls_211.2, nls_211.3))
} else if(exists("nls_211.2") & exists("nls_211.3")){
  print(anova(nls_211.2, nls_211.3))
} else if(exists("nls_211.1") & exists("nls_211.2")){
  print(anova(nls_211.1, nls_211.2))
}
 
## AIC comparison
AIC1_211 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_211.1"), AIC(get("nls_211.1")), NA),
            ifelse(exists("nls_211.2"), AIC(get("nls_211.2")), NA),
            ifelse(exists("nls_211.3"), AIC(get("nls_211.3")), NA)
            ))

print(AIC1_211) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_211[!is.na(AIC1_211$AIC) & AIC1_211$AIC == min(AIC1_211$AIC, na.rm = T),]$model

try(summary(get(paste("nls_211.",  Mod.Sel1, sep =""))) ) #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_211.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_211.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_211.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_211.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_211.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_211.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_211.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_211.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_211.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_211,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_211$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_211.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_211,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_211$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_211.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_211,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_211$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_211.", Mod.Sel1, sep ="")) &
     exists(paste("nls_211.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_211.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_211.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_211.", Mod.Sel1, sep ="")),
             get(paste("nls_211.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_211.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_211.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_211.", Mod.Sel1, sep ="")) &
         exists(paste("nls_211.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_211.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_211.", Mod.Sel1, sep ="")),
               get(paste("nls_211.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_211.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_211.", Mod.Sel1, sep ="")) &
           exists(paste("nls_211.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_211.", Mod.Sel1, sep ="")),
                 get(paste("nls_211.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_211.", Mod.Sel1, sep ="")) &
              exists(paste("nls_211.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_211.", Mod.Sel1, sep ="")),
                    get(paste("nls_211.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_211.", Mod.Sel1, sep ="")) &
                exists(paste("nls_211.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_211.", Mod.Sel1, sep ="")),
                      get(paste("nls_211.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_211 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_211.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_211.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_211.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_211.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_211.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_211.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_211.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_211.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_211)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_211[!is.na(AIC2_211$AIC) & AIC2_211$AIC == min(AIC2_211$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "211",]$Sel.Mod.2 <- Mod.Sel2
 
## write coefficients to table 
coefs <- coef(get(paste("nls_211.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_211.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "211",]$ge.variance <- vcov(get(paste("nls_211.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "211",]$phi.variance <- vcov(get(paste("nls_211.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "211",]$alpha.variance <- vcov(get(paste("nls_211.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "211",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "211",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "211",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "211",]$A <- coefs["A"]
nls.param.df_nh[nls.param.df_nh$Code == "211",]$k <- coefs["k"]

nls.param.df_nh[nls.param.df_nh$Code == "211",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "211",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "211",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "211",]$A.2.5 <- intervals_low["A"]
nls.param.df_nh[nls.param.df_nh$Code == "211",]$k.2.5 <- intervals_low["k"]

nls.param.df_nh[nls.param.df_nh$Code == "211",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "211",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "211",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "211",]$A.97.5 <- intervals_high["A"]
nls.param.df_nh[nls.param.df_nh$Code == "211",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_211.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_211.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_211.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_211.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_211$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_211.4 <- nls(f_4, data = G_211, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_211$nls_weights.2), 
 )

## phi
try(
  nls_211.5 <- nls(f_5, data=G_211, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_211$nls_weights.2), 
 )

# phi/alpha
try(
  nls_211.6 <- nls(f_6, data = G_211, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_211$nls_weights.2), 
 )

## test
if(exists("nls_211.4") & exists("nls_211.5") & exists("nls_211.6")){
  print(anova(nls_211.4, nls_211.5, nls_211.6))
} else if(exists("nls_211.4") & exists("nls_211.6")){
  print(anova(nls_211.4, nls_211.6))
} else if(exists("nls_211.5") & exists("nls_211.6")){
  print(anova(nls_211.5, nls_211.6))
} else if(exists("nls_211.4") & exists("nls_211.5")){
  print(anova(nls_211.4, nls_211.5))
}

## AIC comparison
AIC3_211 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_211[AIC2_211$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_211.4"), AIC(get("nls_211.4")), NA),
            ifelse(exists("nls_211.5"), AIC(get("nls_211.5")), NA),
            ifelse(exists("nls_211.6"), AIC(get("nls_211.6")), NA)
            ))

print(AIC3_211) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_211[!is.na(AIC3_211$AIC) & AIC3_211$AIC == min(AIC3_211$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "211",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_nh[Best_mods.P_nh$Code == "211",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_211.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_211.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "211",]$ge.variance <- vcov(get(paste("nls_211.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "211",]$phi.variance <- vcov(get(paste("nls_211.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "211",]$alpha.variance <- vcov(get(paste("nls_211.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "211",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "211",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "211",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "211",]$a <- coefs["a"]
nls.param.df_nh[nls.param.df_nh$Code == "211",]$b <- coefs["b"]
nls.param.df_nh[nls.param.df_nh$Code == "211",]$c <- coefs["c"]
nls.param.df_nh[nls.param.df_nh$Code == "211",]$d <- coefs["d"]

nls.param.df_nh[nls.param.df_nh$Code == "211",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "211",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "211",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "211",]$a.2.5 <- intervals_low["a"]
nls.param.df_nh[nls.param.df_nh$Code == "211",]$b.2.5 <- intervals_low["b"]
nls.param.df_nh[nls.param.df_nh$Code == "211",]$c.2.5 <- intervals_low["c"]
nls.param.df_nh[nls.param.df_nh$Code == "211",]$d.2.5 <- intervals_low["d"]

nls.param.df_nh[nls.param.df_nh$Code == "211",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "211",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "211",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "211",]$a.97.5 <- intervals_high["a"]
nls.param.df_nh[nls.param.df_nh$Code == "211",]$b.97.5 <- intervals_high["b"]
nls.param.df_nh[nls.param.df_nh$Code == "211",]$c.97.5 <- intervals_high["c"]
nls.param.df_nh[nls.param.df_nh$Code == "211",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_211.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_211.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_211.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_211.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_211 <- nlsResiduals(
  get(paste("nls_211.",  Mod.Sel3, sep =""))
  )

### plot residuals
plot(resid_211)

## test residuals
if(length(G_211$pltID) < 5001) {test.nlsResiduals(resid_211)}

}  else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 | length(Mod.Sel3) & fit.models == T) {

G_211_pred <- predict(get(paste("nls_211.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_211$MEASTIME_t2, na.rm = T), max(G_211$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_211$STDAGE_t2), by = 1))
                      } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_211$MEASTIME_t2, na.rm = T), max(G_211$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_211$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_211$DeltaPDSI, na.rm = T), max(G_211$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_211$MEASTIME_t2, na.rm = T), max(G_211$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_211$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_211$B_L_prop, na.rm = T), max(G_211$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_211$DeltaPDSI, na.rm = T), max(G_211$STDAGE_t2)))
                      } )

G_211_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_211$STDAGE_t2),by = 1),  
                            "fitted"=G_211_pred)

## plot
gg.211 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_211, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_211, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_211))), breaks = cutvec_211) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_211_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_211_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("211 - Northeastern Mixed Forest") + 
          
          #ylim(0, max(G_211_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_211,1)*1.05), expand = c(0,0))

gg.211

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_211 <- data.frame(
  bin = as.factor(levels(cut(G_211$STDAGE_t2, cutvec_211))),
  data.mean = tapply(G_211$B_plt_t2_MgHa, cut(G_211$STDAGE_t2, cutvec_211), 
                     mean), 
  data.CI.high =  tapply(G_211$B_plt_t2_MgHa, cut(G_211$STDAGE_t2, cutvec_211), 
                    high.CI), 
  data.CI.low = tapply(G_211$B_plt_t2_MgHa, cut(G_211$STDAGE_t2, cutvec_211),
                    low.CI), 
  pred.mean = G_211_pred_df[G_211_pred_df$STDAGE_t2 %in% bin_mids_211,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_211 <-  DM_compare_211 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_211$bin)[gtools::mixedorder(levels(DM_compare_211$bin))]))

## ggplot
gg.211.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_211) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_211))), 
                              labels = levels(DM_compare_211$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("211 - Northeastern Mixed Forest",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +  
           theme_classic() + 
           # xlim(min(DM_compare_211$data.CI.low)-0.25, max(DM_compare_211$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_211$pred.CI.low)-0.25, max(DM_compare_211$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.211.B2

}   else {print("cannot plot observed vs. predicted")}
```

## 212 - Laurentian Mixed Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_212 <- round(quantile(G_212$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_212)))){
  cutvec_212 <- round(quantile(G_212$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_212 <- unname(round(cutvec_212[-length(cutvec_212)] + diff(cutvec_212)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_212$STDAGE_t2_bin<-  cut(G_212$STDAGE_t2, cutvec_212)
## then get bin means
G_212_bin_means <- tapply(G_212$B_plt_t2_MgHa, cut(G_212$STDAGE_t2, cutvec_212), mean)

## make column weights.2
G_212$nls_weights.2 <- as.numeric(1/(G_212_bin_means[match(G_212$STDAGE_t2_bin, names(G_212_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_212.1 <- nls(f_1, data = G_212, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_212$nls_weights.2), 
 )

## phi
try(
  nls_212.2 <- nls(f_2, data=G_212, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_212$nls_weights.2), 
 )

# phi/alpha
try(
  nls_212.3 <- nls(f_3 , data = G_212, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_212$nls_weights.2), 
 )

## test
if(exists("nls_212.1") & exists("nls_212.2") & exists("nls_212.3")){
  print(anova(nls_212.1, nls_212.2, nls_212.3))
} else if(exists("nls_212.2") & exists("nls_212.3")){
  print(anova(nls_212.2, nls_212.3))
} else if(exists("nls_212.1") & exists("nls_212.2")){
  print(anova(nls_212.1, nls_212.2))
}
 
## AIC comparison
AIC1_212 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_212.1"), AIC(get("nls_212.1")), NA),
            ifelse(exists("nls_212.2"), AIC(get("nls_212.2")), NA),
            ifelse(exists("nls_212.3"), AIC(get("nls_212.3")), NA)
            ))

print(AIC1_212) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_212[!is.na(AIC1_212$AIC) & AIC1_212$AIC == min(AIC1_212$AIC, na.rm = T),]$model

try(summary(get(paste("nls_212.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_212.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_212.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_212.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_212.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_212.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_212.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_212.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_212.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_212.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_212,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_212$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_212.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_212,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_212$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_212.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_212,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_212$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_212.", Mod.Sel1, sep ="")) &
     exists(paste("nls_212.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_212.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_212.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_212.", Mod.Sel1, sep ="")),
             get(paste("nls_212.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_212.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_212.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_212.", Mod.Sel1, sep ="")) &
         exists(paste("nls_212.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_212.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_212.", Mod.Sel1, sep ="")),
               get(paste("nls_212.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_212.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_212.", Mod.Sel1, sep ="")) &
           exists(paste("nls_212.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_212.", Mod.Sel1, sep ="")),
                 get(paste("nls_212.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_212.", Mod.Sel1, sep ="")) &
              exists(paste("nls_212.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_212.", Mod.Sel1, sep ="")),
                    get(paste("nls_212.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_212.", Mod.Sel1, sep ="")) &
                exists(paste("nls_212.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_212.", Mod.Sel1, sep ="")),
                      get(paste("nls_212.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_212 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_212.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_212.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_212.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_212.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_212.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_212.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_212.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_212.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_212)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_212[!is.na(AIC2_212$AIC) & AIC2_212$AIC == min(AIC2_212$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "212",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_212.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_212.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "212",]$ge.variance <- vcov(get(paste("nls_212.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "212",]$phi.variance <- vcov(get(paste("nls_212.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "212",]$alpha.variance <- vcov(get(paste("nls_212.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "212",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "212",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "212",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "212",]$A <- coefs["A"]
nls.param.df_nh[nls.param.df_nh$Code == "212",]$k <- coefs["k"]

nls.param.df_nh[nls.param.df_nh$Code == "212",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "212",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "212",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "212",]$A.2.5 <- intervals_low["A"]
nls.param.df_nh[nls.param.df_nh$Code == "212",]$k.2.5 <- intervals_low["k"]

nls.param.df_nh[nls.param.df_nh$Code == "212",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "212",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "212",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "212",]$A.97.5 <- intervals_high["A"]
nls.param.df_nh[nls.param.df_nh$Code == "212",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_212.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_212.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_212.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_212.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_212$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_212.4 <- nls(f_4, data = G_212, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_212$nls_weights.2), 
 )

## phi
try(
  nls_212.5 <- nls(f_5, data=G_212, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_212$nls_weights.2), 
 )

# phi/alpha
try(
  nls_212.6 <- nls(f_6, data = G_212, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_212$nls_weights.2), 
 )

## test
if(exists("nls_212.4") & exists("nls_212.5") & exists("nls_212.6")){
  print(anova(nls_212.4, nls_212.5, nls_212.6))
} else if(exists("nls_212.4") & exists("nls_212.6")){
  print(anova(nls_212.4, nls_212.6))
} else if(exists("nls_212.5") & exists("nls_212.6")){
  print(anova(nls_212.5, nls_212.6))
} else if(exists("nls_212.4") & exists("nls_212.5")){
  print(anova(nls_212.4, nls_212.5))
}

## AIC comparison
AIC3_212 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_212[AIC2_212$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_212.4"), AIC(get("nls_212.4")), NA),
            ifelse(exists("nls_212.5"), AIC(get("nls_212.5")), NA),
            ifelse(exists("nls_212.6"), AIC(get("nls_212.6")), NA)
            ))

print(AIC3_212) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_212[!is.na(AIC3_212$AIC) & AIC3_212$AIC == min(AIC3_212$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "212",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_nh[Best_mods.P_nh$Code == "212",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_212.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_212.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "212",]$ge.variance <- vcov(get(paste("nls_212.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "212",]$phi.variance <- vcov(get(paste("nls_212.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "212",]$alpha.variance <- vcov(get(paste("nls_212.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "212",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "212",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "212",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "212",]$a <- coefs["a"]
nls.param.df_nh[nls.param.df_nh$Code == "212",]$b <- coefs["b"]
nls.param.df_nh[nls.param.df_nh$Code == "212",]$c <- coefs["c"]
nls.param.df_nh[nls.param.df_nh$Code == "212",]$d <- coefs["d"]

nls.param.df_nh[nls.param.df_nh$Code == "212",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "212",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "212",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "212",]$a.2.5 <- intervals_low["a"]
nls.param.df_nh[nls.param.df_nh$Code == "212",]$b.2.5 <- intervals_low["b"]
nls.param.df_nh[nls.param.df_nh$Code == "212",]$c.2.5 <- intervals_low["c"]
nls.param.df_nh[nls.param.df_nh$Code == "212",]$d.2.5 <- intervals_low["d"]

nls.param.df_nh[nls.param.df_nh$Code == "212",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "212",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "212",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "212",]$a.97.5 <- intervals_high["a"]
nls.param.df_nh[nls.param.df_nh$Code == "212",]$b.97.5 <- intervals_high["b"]
nls.param.df_nh[nls.param.df_nh$Code == "212",]$c.97.5 <- intervals_high["c"]
nls.param.df_nh[nls.param.df_nh$Code == "212",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_212.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_212.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_212.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_212.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {
  
## calculate residuals
resid_212 <- nlsResiduals(
  get(paste("nls_212.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_212)

## test residuals
if(length(G_212$pltID) < 5001) {test.nlsResiduals(resid_212)}

}  else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_212_pred <- predict(get(paste("nls_212.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_212$MEASTIME_t2, na.rm = T), max(G_212$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_212$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_212$MEASTIME_t2, na.rm = T), max(G_212$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_212$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_212$DeltaPDSI, na.rm = T), max(G_212$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_212$MEASTIME_t2, na.rm = T), max(G_212$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_212$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_212$B_L_prop, na.rm = T), max(G_212$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_212$DeltaPDSI, na.rm = T), max(G_212$STDAGE_t2)))
                      } )

G_212_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_212$STDAGE_t2),by = 1),  
                            "fitted"=G_212_pred)


## plot
gg.212 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_212, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_212, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_212))), breaks = cutvec_212) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_212_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_212_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("212 - Laurentian Mixed Forest") + 
          
          #ylim(0, max(G_212_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_212,1)*1.05), expand = c(0,0))

gg.212

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_212 <- data.frame(
  bin = as.factor(levels(cut(G_212$STDAGE_t2, cutvec_212))),
  data.mean = tapply(G_212$B_plt_t2_MgHa, cut(G_212$STDAGE_t2, cutvec_212), 
                     mean), 
  data.CI.high =  tapply(G_212$B_plt_t2_MgHa, cut(G_212$STDAGE_t2, cutvec_212), 
                    high.CI), 
  data.CI.low = tapply(G_212$B_plt_t2_MgHa, cut(G_212$STDAGE_t2, cutvec_212),
                    low.CI), 
  pred.mean = G_212_pred_df[G_212_pred_df$STDAGE_t2 %in% bin_mids_212,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_212 <-  DM_compare_212 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_212$bin)[gtools::mixedorder(levels(DM_compare_212$bin))]))

## ggplot
gg.212.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_212) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_212))), 
                              labels = levels(DM_compare_212$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("212 - Laurentain Mixed Forest",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +
           theme_classic() + 
           # xlim(min(DM_compare_212$data.CI.low)-0.25, max(DM_compare_212$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_212$pred.CI.low)-0.25, max(DM_compare_212$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.212.B2

}   else {print("cannot plot observed vs. predicted")}
```

## 221 - Eastern Broadleaf Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_221 <- round(quantile(G_221$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_221)))){
  cutvec_221 <- round(quantile(G_221$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_221 <- unname(round(cutvec_221[-length(cutvec_221)] + diff(cutvec_221)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_221$STDAGE_t2_bin<-  cut(G_221$STDAGE_t2, cutvec_221)
## then get bin means
G_221_bin_means <- tapply(G_221$B_plt_t2_MgHa, cut(G_221$STDAGE_t2, cutvec_221), mean)

## make column weights.2
G_221$nls_weights.2 <- as.numeric(1/(G_221_bin_means[match(G_221$STDAGE_t2_bin, names(G_221_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_221.1 <- nls(f_1, data = G_221, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_221$nls_weights.2), 
 )

## phi
try(
  nls_221.2 <- nls(f_2, data=G_221, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_221$nls_weights.2), 
 )

# phi/alpha
try(
  nls_221.3 <- nls(f_3 , data = G_221, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_221$nls_weights.2), 
 )

## test
if(exists("nls_221.1") & exists("nls_221.2") & exists("nls_221.3")){
  print(anova(nls_221.1, nls_221.2, nls_221.3))
} else if(exists("nls_221.2") & exists("nls_221.3")){
  print(anova(nls_221.2, nls_221.3))
} else if(exists("nls_221.1") & exists("nls_221.2")){
  print(anova(nls_221.1, nls_221.2))
}
 
## AIC comparison
AIC1_221 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_221.1"), AIC(get("nls_221.1")), NA),
            ifelse(exists("nls_221.2"), AIC(get("nls_221.2")), NA),
            ifelse(exists("nls_221.3"), AIC(get("nls_221.3")), NA)
            ))

print(AIC1_221) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_221[!is.na(AIC1_221$AIC) & AIC1_221$AIC == min(AIC1_221$AIC, na.rm = T),]$model

try(summary(get(paste("nls_221.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_221.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_221.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_221.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_221.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_221.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_221.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_221.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_221.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_221.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_221,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_221$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_221.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_221,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_221$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_221.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_221,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_221$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_221.", Mod.Sel1, sep ="")) &
     exists(paste("nls_221.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_221.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_221.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_221.", Mod.Sel1, sep ="")),
             get(paste("nls_221.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_221.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_221.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_221.", Mod.Sel1, sep ="")) &
         exists(paste("nls_221.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_221.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_221.", Mod.Sel1, sep ="")),
               get(paste("nls_221.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_221.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_221.", Mod.Sel1, sep ="")) &
           exists(paste("nls_221.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_221.", Mod.Sel1, sep ="")),
                 get(paste("nls_221.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_221.", Mod.Sel1, sep ="")) &
              exists(paste("nls_221.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_221.", Mod.Sel1, sep ="")),
                    get(paste("nls_221.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_221.", Mod.Sel1, sep ="")) &
                exists(paste("nls_221.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_221.", Mod.Sel1, sep ="")),
                      get(paste("nls_221.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_221 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_221.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_221.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_221.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_221.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_221.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_221.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_221.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_221.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_221)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_221[!is.na(AIC2_221$AIC) & AIC2_221$AIC == min(AIC2_221$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "221",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_221.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_221.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "221",]$ge.variance <- vcov(get(paste("nls_221.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "221",]$phi.variance <- vcov(get(paste("nls_221.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "221",]$alpha.variance <- vcov(get(paste("nls_221.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "221",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "221",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "221",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "221",]$A <- coefs["A"]
nls.param.df_nh[nls.param.df_nh$Code == "221",]$k <- coefs["k"]

nls.param.df_nh[nls.param.df_nh$Code == "221",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "221",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "221",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "221",]$A.2.5 <- intervals_low["A"]
nls.param.df_nh[nls.param.df_nh$Code == "221",]$k.2.5 <- intervals_low["k"]

nls.param.df_nh[nls.param.df_nh$Code == "221",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "221",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "221",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "221",]$A.97.5 <- intervals_high["A"]
nls.param.df_nh[nls.param.df_nh$Code == "221",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_221.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_221.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_221.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_221.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_221$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_221.4 <- nls(f_4, data = G_221, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_221$nls_weights.2), 
 )

## phi
try(
  nls_221.5 <- nls(f_5, data=G_221, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_221$nls_weights.2), 
 )

# phi/alpha
try(
  nls_221.6 <- nls(f_6, data = G_221, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_221$nls_weights.2), 
 )

## test
if(exists("nls_221.4") & exists("nls_221.5") & exists("nls_221.6")){
  print(anova(nls_221.4, nls_221.5, nls_221.6))
} else if(exists("nls_221.4") & exists("nls_221.6")){
  print(anova(nls_221.4, nls_221.6))
} else if(exists("nls_221.5") & exists("nls_221.6")){
  print(anova(nls_221.5, nls_221.6))
} else if(exists("nls_221.4") & exists("nls_221.5")){
  print(anova(nls_221.4, nls_221.5))
}

## AIC comparison
AIC3_221 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_221[AIC2_221$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_221.4"), AIC(get("nls_221.4")), NA),
            ifelse(exists("nls_221.5"), AIC(get("nls_221.5")), NA),
            ifelse(exists("nls_221.6"), AIC(get("nls_221.6")), NA)
            ))

print(AIC3_221) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_221[!is.na(AIC3_221$AIC) & AIC3_221$AIC == min(AIC3_221$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "221",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_nh[Best_mods.P_nh$Code == "221",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_221.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_221.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "221",]$ge.variance <- vcov(get(paste("nls_221.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "221",]$phi.variance <- vcov(get(paste("nls_221.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "221",]$alpha.variance <- vcov(get(paste("nls_221.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "221",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "221",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "221",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "221",]$a <- coefs["a"]
nls.param.df_nh[nls.param.df_nh$Code == "221",]$b <- coefs["b"]
nls.param.df_nh[nls.param.df_nh$Code == "221",]$c <- coefs["c"]
nls.param.df_nh[nls.param.df_nh$Code == "221",]$d <- coefs["d"]

nls.param.df_nh[nls.param.df_nh$Code == "221",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "221",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "221",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "221",]$a.2.5 <- intervals_low["a"]
nls.param.df_nh[nls.param.df_nh$Code == "221",]$b.2.5 <- intervals_low["b"]
nls.param.df_nh[nls.param.df_nh$Code == "221",]$c.2.5 <- intervals_low["c"]
nls.param.df_nh[nls.param.df_nh$Code == "221",]$d.2.5 <- intervals_low["d"]

nls.param.df_nh[nls.param.df_nh$Code == "221",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "221",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "221",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "221",]$a.97.5 <- intervals_high["a"]
nls.param.df_nh[nls.param.df_nh$Code == "221",]$b.97.5 <- intervals_high["b"]
nls.param.df_nh[nls.param.df_nh$Code == "221",]$c.97.5 <- intervals_high["c"]
nls.param.df_nh[nls.param.df_nh$Code == "221",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_221.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_221.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_221.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_221.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_221 <- nlsResiduals(
  get(paste("nls_221.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_221)

## test residuals
if(length(G_221$pltID) < 5001) {test.nlsResiduals(resid_221)}

}   else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_221_pred <- predict(get(paste("nls_221.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_221$MEASTIME_t2, na.rm = T), max(G_221$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_221$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_221$MEASTIME_t2, na.rm = T), max(G_221$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_221$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_221$DeltaPDSI, na.rm = T), max(G_221$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_221$MEASTIME_t2, na.rm = T), max(G_221$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_221$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_221$B_L_prop, na.rm = T), max(G_221$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_221$DeltaPDSI, na.rm = T), max(G_221$STDAGE_t2)))
                      } )

G_221_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_221$STDAGE_t2),by = 1),  
                            "fitted"=G_221_pred)

## plot
gg.221 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_221, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_221, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_221))), breaks = cutvec_221) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_221_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_221_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("221 - Eastern Broadleaf Forest") + 
          
          #ylim(0, max(G_221_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_221,1)*1.05), expand = c(0,0))

gg.221

}   else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_221 <- data.frame(
  bin = as.factor(levels(cut(G_221$STDAGE_t2, cutvec_221))),
  data.mean = tapply(G_221$B_plt_t2_MgHa, cut(G_221$STDAGE_t2, cutvec_221), 
                     mean), 
  data.CI.high =  tapply(G_221$B_plt_t2_MgHa, cut(G_221$STDAGE_t2, cutvec_221), 
                    high.CI), 
  data.CI.low = tapply(G_221$B_plt_t2_MgHa, cut(G_221$STDAGE_t2, cutvec_221),
                    low.CI), 
  pred.mean = G_221_pred_df[G_221_pred_df$STDAGE_t2 %in% bin_mids_221,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_221 <-  DM_compare_221 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_221$bin)[gtools::mixedorder(levels(DM_compare_221$bin))]))

## ggplot
gg.221.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_221) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_221))), 
                              labels = levels(DM_compare_221$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("221 - Eastern Broadleaf Forest",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +        
           theme_classic() + 
           # xlim(min(DM_compare_221$data.CI.low)-0.25, max(DM_compare_221$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_221$pred.CI.low)-0.25, max(DM_compare_221$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.221.B2

}   else {print("cannot plot observed vs. predicted")}
```

## 222 - Midwest Broadleaf Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_222 <- round(quantile(G_222$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_222)))){
  cutvec_222 <- round(quantile(G_222$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_222 <- unname(round(cutvec_222[-length(cutvec_222)] + diff(cutvec_222)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_222$STDAGE_t2_bin<-  cut(G_222$STDAGE_t2, cutvec_222)
## then get bin means
G_222_bin_means <- tapply(G_222$B_plt_t2_MgHa, cut(G_222$STDAGE_t2,  cutvec_222), mean)

## make column weights.2
G_222$nls_weights.2 <- as.numeric(1/(G_222_bin_means[match(G_222$STDAGE_t2_bin, names(G_222_bin_means))])^2)

}
```

### model selection 1

```{r}
# simple
try(
  nls_222.1 <- nls(f_1, data = G_222, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_222$nls_weights.2), 
 )

## phi
try(
  nls_222.2 <- nls(f_2, data=G_222, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_222$nls_weights.2), 
 )

# phi/alpha
try(
  nls_222.3 <- nls(f_3 , data = G_222, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_222$nls_weights.2), 
 )

## test
if(exists("nls_222.1") & exists("nls_222.2") & exists("nls_222.3")){
  print(anova(nls_222.1, nls_222.2, nls_222.3))
} else if(exists("nls_222.2") & exists("nls_222.3")){
  print(anova(nls_222.2, nls_222.3))
} else if(exists("nls_222.1") & exists("nls_222.2")){
  print(anova(nls_222.1, nls_222.2))
}
 
## AIC comparison
AIC1_222 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_222.1"), AIC(get("nls_222.1")), NA),
            ifelse(exists("nls_222.2"), AIC(get("nls_222.2")), NA),
            ifelse(exists("nls_222.3"), AIC(get("nls_222.3")), NA)
            ))

print(AIC1_222) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_222[!is.na(AIC1_222$AIC) & AIC1_222$AIC == min(AIC1_222$AIC, na.rm = T),]$model

try(summary(get(paste("nls_222.",  Mod.Sel1, sep =""))) )  #model summary
```
#### summary 
* simple model: `r ifelse(exists("nls_222.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_222.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_222.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_222.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_222.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_222.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_222.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_222.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_222.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_222,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_222$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_222.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_222,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_222$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_222.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_222,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_222$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_222.", Mod.Sel1, sep ="")) &
     exists(paste("nls_222.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_222.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_222.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_222.", Mod.Sel1, sep ="")),
             get(paste("nls_222.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_222.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_222.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_222.", Mod.Sel1, sep ="")) &
         exists(paste("nls_222.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_222.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_222.", Mod.Sel1, sep ="")),
               get(paste("nls_222.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_222.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_222.", Mod.Sel1, sep ="")) &
           exists(paste("nls_222.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_222.", Mod.Sel1, sep ="")),
                 get(paste("nls_222.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_222.", Mod.Sel1, sep ="")) &
              exists(paste("nls_222.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_222.", Mod.Sel1, sep ="")),
                    get(paste("nls_222.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_222.", Mod.Sel1, sep ="")) &
                exists(paste("nls_222.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_222.", Mod.Sel1, sep ="")),
                      get(paste("nls_222.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_222 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_222.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_222.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_222.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_222.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_222.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_222.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_222.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_222.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_222)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_222[!is.na(AIC2_222$AIC) & AIC2_222$AIC == min(AIC2_222$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "222",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_222.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_222.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "222",]$ge.variance <- vcov(get(paste("nls_222.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "222",]$phi.variance <- vcov(get(paste("nls_222.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "222",]$alpha.variance <- vcov(get(paste("nls_222.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "222",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "222",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "222",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "222",]$A <- coefs["A"]
nls.param.df_nh[nls.param.df_nh$Code == "222",]$k <- coefs["k"]

nls.param.df_nh[nls.param.df_nh$Code == "222",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "222",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "222",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "222",]$A.2.5 <- intervals_low["A"]
nls.param.df_nh[nls.param.df_nh$Code == "222",]$k.2.5 <- intervals_low["k"]

nls.param.df_nh[nls.param.df_nh$Code == "222",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "222",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "222",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "222",]$A.97.5 <- intervals_high["A"]
nls.param.df_nh[nls.param.df_nh$Code == "222",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_222.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_222.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_222.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_222.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_222$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_222.4 <- nls(f_4, data = G_222, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_222$nls_weights.2), 
 )

## phi
try(
  nls_222.5 <- nls(f_5, data=G_222, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_222$nls_weights.2), 
 )

# phi/alpha
try(
  nls_222.6 <- nls(f_6, data = G_222, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_222$nls_weights.2), 
 )

## test
if(exists("nls_222.4") & exists("nls_222.5") & exists("nls_222.6")){
  print(anova(nls_222.4, nls_222.5, nls_222.6))
} else if(exists("nls_222.4") & exists("nls_222.6")){
  print(anova(nls_222.4, nls_222.6))
} else if(exists("nls_222.5") & exists("nls_222.6")){
  print(anova(nls_222.5, nls_222.6))
} else if(exists("nls_222.4") & exists("nls_222.5")){
  print(anova(nls_222.4, nls_222.5))
}

## AIC comparison
AIC3_222 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_222[AIC2_222$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_222.4"), AIC(get("nls_222.4")), NA),
            ifelse(exists("nls_222.5"), AIC(get("nls_222.5")), NA),
            ifelse(exists("nls_222.6"), AIC(get("nls_222.6")), NA)
            ))

print(AIC3_222) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_222[!is.na(AIC3_222$AIC) & AIC3_222$AIC == min(AIC3_222$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "222",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_nh[Best_mods.P_nh$Code == "222",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_222.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_222.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "222",]$ge.variance <- vcov(get(paste("nls_222.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "222",]$phi.variance <- vcov(get(paste("nls_222.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "222",]$alpha.variance <- vcov(get(paste("nls_222.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "222",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "222",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "222",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "222",]$a <- coefs["a"]
nls.param.df_nh[nls.param.df_nh$Code == "222",]$b <- coefs["b"]
nls.param.df_nh[nls.param.df_nh$Code == "222",]$c <- coefs["c"]
nls.param.df_nh[nls.param.df_nh$Code == "222",]$d <- coefs["d"]

nls.param.df_nh[nls.param.df_nh$Code == "222",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "222",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "222",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "222",]$a.2.5 <- intervals_low["a"]
nls.param.df_nh[nls.param.df_nh$Code == "222",]$b.2.5 <- intervals_low["b"]
nls.param.df_nh[nls.param.df_nh$Code == "222",]$c.2.5 <- intervals_low["c"]
nls.param.df_nh[nls.param.df_nh$Code == "222",]$d.2.5 <- intervals_low["d"]

nls.param.df_nh[nls.param.df_nh$Code == "222",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "222",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "222",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "222",]$a.97.5 <- intervals_high["a"]
nls.param.df_nh[nls.param.df_nh$Code == "222",]$b.97.5 <- intervals_high["b"]
nls.param.df_nh[nls.param.df_nh$Code == "222",]$c.97.5 <- intervals_high["c"]
nls.param.df_nh[nls.param.df_nh$Code == "222",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_222.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_222.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_222.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_222.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {
  
## calculate residuals
resid_222 <- nlsResiduals(
  get(paste("nls_222.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_222)

## test residuals
if(length(G_222$pltID) < 5001) {test.nlsResiduals(resid_222)}

}  else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {
  
G_222_pred <- predict(get(paste("nls_222.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_222$MEASTIME_t2, na.rm = T), max(G_222$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_222$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_222$MEASTIME_t2, na.rm = T), max(G_222$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_222$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_222$DeltaPDSI, na.rm = T), max(G_222$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_222$MEASTIME_t2, na.rm = T), max(G_222$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_222$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_222$B_L_prop, na.rm = T), max(G_222$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_222$DeltaPDSI, na.rm = T), max(G_222$STDAGE_t2)))
                      } )

G_222_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_222$STDAGE_t2),by = 1),  
                            "fitted"=G_222_pred)

## plot
gg.222 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_222, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_222, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_222))), breaks = cutvec_222) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_222_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_222_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("222 - Midwest Broadleaf Forest") + 
          
          #ylim(0, max(G_222_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_222,1)*1.05), expand = c(0,0))

gg.222

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_222 <- data.frame(
  bin = as.factor(levels(cut(G_222$STDAGE_t2, cutvec_222))),
  data.mean = tapply(G_222$B_plt_t2_MgHa, cut(G_222$STDAGE_t2, cutvec_222), 
                     mean), 
  data.CI.high =  tapply(G_222$B_plt_t2_MgHa, cut(G_222$STDAGE_t2, cutvec_222), 
                    high.CI), 
  data.CI.low = tapply(G_222$B_plt_t2_MgHa, cut(G_222$STDAGE_t2, cutvec_222),
                    low.CI), 
  pred.mean = G_222_pred_df[G_222_pred_df$STDAGE_t2 %in% bin_mids_222,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_222 <-  DM_compare_222 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_222$bin)[gtools::mixedorder(levels(DM_compare_222$bin))]))

## ggplot
gg.222.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_222) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_222))), 
                              labels = levels(DM_compare_222$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("222 - Midwest Broadleaf Forest",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +        
           theme_classic() + 
           # xlim(min(DM_compare_222$data.CI.low)-0.25, max(DM_compare_222$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_222$pred.CI.low)-0.25, max(DM_compare_222$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.222.B2

}    else {print("cannot plot observed vs. predicted")}
```

## 223 - Central Interior Broadleaf Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_223 <- round(quantile(G_223$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_223)))){
  cutvec_223 <- round(quantile(G_223$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_223 <- unname(round(cutvec_223[-length(cutvec_223)] + diff(cutvec_223)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_223$STDAGE_t2_bin<-  cut(G_223$STDAGE_t2, cutvec_223)
## then get bin means
G_223_bin_means <- tapply(G_223$B_plt_t2_MgHa, cut(G_223$STDAGE_t2,  cutvec_223), mean)

## make column weights.2
G_223$nls_weights.2 <- as.numeric(1/(G_223_bin_means[match(G_223$STDAGE_t2_bin, names(G_223_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_223.1 <- nls(f_1, data = G_223, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_223$nls_weights.2), 
 )

## phi
try(
  nls_223.2 <- nls(f_2, data=G_223, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_223$nls_weights.2), 
 )

# phi/alpha
try(
  nls_223.3 <- nls(f_3 , data = G_223, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_223$nls_weights.2), 
 )

## test
if(exists("nls_223.1") & exists("nls_223.2") & exists("nls_223.3")){
  print(anova(nls_223.1, nls_223.2, nls_223.3))
} else if(exists("nls_223.2") & exists("nls_223.3")){
  print(anova(nls_223.2, nls_223.3))
} else if(exists("nls_223.1") & exists("nls_223.2")){
  print(anova(nls_223.1, nls_223.2))
}
 
## AIC comparison
AIC1_223 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_223.1"), AIC(get("nls_223.1")), NA),
            ifelse(exists("nls_223.2"), AIC(get("nls_223.2")), NA),
            ifelse(exists("nls_223.3"), AIC(get("nls_223.3")), NA)
            ))

print(AIC1_223) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_223[!is.na(AIC1_223$AIC) & AIC1_223$AIC == min(AIC1_223$AIC, na.rm = T),]$model

try(summary(get(paste("nls_223.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_223.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_223.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_223.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_223.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_223.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_223.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_223.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_223.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_223.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_223,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_223$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_223.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_223,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_223$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_223.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_223,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_223$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_223.", Mod.Sel1, sep ="")) &
     exists(paste("nls_223.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_223.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_223.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_223.", Mod.Sel1, sep ="")),
             get(paste("nls_223.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_223.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_223.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_223.", Mod.Sel1, sep ="")) &
         exists(paste("nls_223.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_223.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_223.", Mod.Sel1, sep ="")),
               get(paste("nls_223.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_223.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_223.", Mod.Sel1, sep ="")) &
           exists(paste("nls_223.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_223.", Mod.Sel1, sep ="")),
                 get(paste("nls_223.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_223.", Mod.Sel1, sep ="")) &
              exists(paste("nls_223.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_223.", Mod.Sel1, sep ="")),
                    get(paste("nls_223.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_223.", Mod.Sel1, sep ="")) &
                exists(paste("nls_223.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_223.", Mod.Sel1, sep ="")),
                      get(paste("nls_223.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_223 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_223.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_223.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_223.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_223.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_223.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_223.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_223.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_223.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_223)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_223[!is.na(AIC2_223$AIC) & AIC2_223$AIC == min(AIC2_223$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "223",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_223.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_223.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "223",]$ge.variance <- vcov(get(paste("nls_223.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "223",]$phi.variance <- vcov(get(paste("nls_223.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "223",]$alpha.variance <- vcov(get(paste("nls_223.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "223",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "223",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "223",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "223",]$A <- coefs["A"]
nls.param.df_nh[nls.param.df_nh$Code == "223",]$k <- coefs["k"]

nls.param.df_nh[nls.param.df_nh$Code == "223",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "223",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "223",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "223",]$A.2.5 <- intervals_low["A"]
nls.param.df_nh[nls.param.df_nh$Code == "223",]$k.2.5 <- intervals_low["k"]

nls.param.df_nh[nls.param.df_nh$Code == "223",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "223",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "223",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "223",]$A.97.5 <- intervals_high["A"]
nls.param.df_nh[nls.param.df_nh$Code == "223",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_223.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_223.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_223.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_223.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_223$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_223.4 <- nls(f_4, data = G_223, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_223$nls_weights.2), 
 )

## phi
try(
  nls_223.5 <- nls(f_5, data=G_223, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_223$nls_weights.2), 
 )

# phi/alpha
try(
  nls_223.6 <- nls(f_6, data = G_223, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_223$nls_weights.2), 
 )

## test
if(exists("nls_223.4") & exists("nls_223.5") & exists("nls_223.6")){
  print(anova(nls_223.4, nls_223.5, nls_223.6))
} else if(exists("nls_223.4") & exists("nls_223.6")){
  print(anova(nls_223.4, nls_223.6))
} else if(exists("nls_223.5") & exists("nls_223.6")){
  print(anova(nls_223.5, nls_223.6))
} else if(exists("nls_223.4") & exists("nls_223.5")){
  print(anova(nls_223.4, nls_223.5))
}

## AIC comparison
AIC3_223 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_223[AIC2_223$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_223.4"), AIC(get("nls_223.4")), NA),
            ifelse(exists("nls_223.5"), AIC(get("nls_223.5")), NA),
            ifelse(exists("nls_223.6"), AIC(get("nls_223.6")), NA)
            ))

print(AIC3_223) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_223[!is.na(AIC3_223$AIC) & AIC3_223$AIC == min(AIC3_223$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "223",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_nh[Best_mods.P_nh$Code == "223",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_223.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_223.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "223",]$ge.variance <- vcov(get(paste("nls_223.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "223",]$phi.variance <- vcov(get(paste("nls_223.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "223",]$alpha.variance <- vcov(get(paste("nls_223.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "223",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "223",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "223",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "223",]$a <- coefs["a"]
nls.param.df_nh[nls.param.df_nh$Code == "223",]$b <- coefs["b"]
nls.param.df_nh[nls.param.df_nh$Code == "223",]$c <- coefs["c"]
nls.param.df_nh[nls.param.df_nh$Code == "223",]$d <- coefs["d"]

nls.param.df_nh[nls.param.df_nh$Code == "223",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "223",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "223",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "223",]$a.2.5 <- intervals_low["a"]
nls.param.df_nh[nls.param.df_nh$Code == "223",]$b.2.5 <- intervals_low["b"]
nls.param.df_nh[nls.param.df_nh$Code == "223",]$c.2.5 <- intervals_low["c"]
nls.param.df_nh[nls.param.df_nh$Code == "223",]$d.2.5 <- intervals_low["d"]

nls.param.df_nh[nls.param.df_nh$Code == "223",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "223",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "223",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "223",]$a.97.5 <- intervals_high["a"]
nls.param.df_nh[nls.param.df_nh$Code == "223",]$b.97.5 <- intervals_high["b"]
nls.param.df_nh[nls.param.df_nh$Code == "223",]$c.97.5 <- intervals_high["c"]
nls.param.df_nh[nls.param.df_nh$Code == "223",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_223.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_223.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_223.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_223.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_223 <- nlsResiduals(get(paste("nls_223.",  Mod.Sel2, sep ="")))

### plot residuals
plot(resid_223)

## test residuals
if(length(G_223$pltID) < 5001) {test.nlsResiduals(resid_223)}

}   else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_223_pred <- predict(get(paste("nls_223.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_223$MEASTIME_t2, na.rm = T), max(G_223$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_223$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_223$MEASTIME_t2, na.rm = T), max(G_223$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_223$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_223$DeltaPDSI, na.rm = T), max(G_223$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_223$MEASTIME_t2, na.rm = T), max(G_223$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_223$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_223$B_L_prop, na.rm = T), max(G_223$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_223$DeltaPDSI, na.rm = T), max(G_223$STDAGE_t2)))
                      } )

G_223_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_223$STDAGE_t2),by = 1),  
                            "fitted"=G_223_pred)

## plot
gg.223 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_223, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_223, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_223))), breaks = cutvec_223) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_223_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_223_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("223 - Central Interior Broadleaf Forest") + 
          
          #ylim(0, max(G_223_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_223,1)*1.05), expand = c(0,0))

gg.223

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_223 <- data.frame(
  bin = as.factor(levels(cut(G_223$STDAGE_t2, cutvec_223))),
  data.mean = tapply(G_223$B_plt_t2_MgHa, cut(G_223$STDAGE_t2, cutvec_223), 
                     mean), 
  data.CI.high =  tapply(G_223$B_plt_t2_MgHa, cut(G_223$STDAGE_t2, cutvec_223), 
                    high.CI), 
  data.CI.low = tapply(G_223$B_plt_t2_MgHa, cut(G_223$STDAGE_t2, cutvec_223),
                    low.CI), 
  pred.mean = G_223_pred_df[G_223_pred_df$STDAGE_t2 %in% bin_mids_223,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_223 <-  DM_compare_223 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_223$bin)[gtools::mixedorder(levels(DM_compare_223$bin))]))

## ggplot
gg.223.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_223) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_223))), 
                              labels = levels(DM_compare_223$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("223 - Central Interior Broadleaf Forest",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +        
           theme_classic() + 
           # xlim(min(DM_compare_223$data.CI.low)-0.25, max(DM_compare_223$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_223$pred.CI.low)-0.25, max(DM_compare_223$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.223.B2

}   else {print("cannot plot observed vs. predicted")}
```

## 231 - Southeastern Mixed Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_231 <- round(quantile(G_231$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_231)))){
  cutvec_231 <- round(quantile(G_231$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_231 <- unname(round(cutvec_231[-length(cutvec_231)] + diff(cutvec_231)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_231$STDAGE_t2_bin<-  cut(G_231$STDAGE_t2, cutvec_231)
## then get bin means
G_231_bin_means <- tapply(G_231$B_plt_t2_MgHa, cut(G_231$STDAGE_t2,  cutvec_231), mean)

## make column weights.2
G_231$nls_weights.2 <- as.numeric(1/(G_231_bin_means[match(G_231$STDAGE_t2_bin, names(G_231_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_231.1 <- nls(f_1, data = G_231, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_231$nls_weights.2), 
 )

## phi
try(
  nls_231.2 <- nls(f_2, data=G_231, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_231$nls_weights.2), 
 )

# phi/alpha
try(
  nls_231.3 <- nls(f_3 , data = G_231, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_231$nls_weights.2), 
 )

## test
if(exists("nls_231.1") & exists("nls_231.2") & exists("nls_231.3")){
  print(anova(nls_231.1, nls_231.2, nls_231.3))
} else if(exists("nls_231.2") & exists("nls_231.3")){
  print(anova(nls_231.2, nls_231.3))
} else if(exists("nls_231.1") & exists("nls_231.2")){
  print(anova(nls_231.1, nls_231.2))
}
 
## AIC comparison
AIC1_231 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_231.1"), AIC(get("nls_231.1")), NA),
            ifelse(exists("nls_231.2"), AIC(get("nls_231.2")), NA),
            ifelse(exists("nls_231.3"), AIC(get("nls_231.3")), NA)
            ))

print(AIC1_231) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_231[!is.na(AIC1_231$AIC) & AIC1_231$AIC == min(AIC1_231$AIC, na.rm = T),]$model

try(summary(get(paste("nls_231.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_231.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_231.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_231.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_231.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_231.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_231.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_231.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_231.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_231.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_231,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_231$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_231.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_231,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_231$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_231.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_231,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_231$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_231.", Mod.Sel1, sep ="")) &
     exists(paste("nls_231.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_231.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_231.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_231.", Mod.Sel1, sep ="")),
             get(paste("nls_231.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_231.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_231.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_231.", Mod.Sel1, sep ="")) &
         exists(paste("nls_231.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_231.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_231.", Mod.Sel1, sep ="")),
               get(paste("nls_231.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_231.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_231.", Mod.Sel1, sep ="")) &
           exists(paste("nls_231.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_231.", Mod.Sel1, sep ="")),
                 get(paste("nls_231.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_231.", Mod.Sel1, sep ="")) &
              exists(paste("nls_231.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_231.", Mod.Sel1, sep ="")),
                    get(paste("nls_231.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_231.", Mod.Sel1, sep ="")) &
                exists(paste("nls_231.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_231.", Mod.Sel1, sep ="")),
                      get(paste("nls_231.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_231 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_231.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_231.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_231.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_231.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_231.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_231.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_231.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_231.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_231)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_231[!is.na(AIC2_231$AIC) & AIC2_231$AIC == min(AIC2_231$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "231",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_231.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_231.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "231",]$ge.variance <- vcov(get(paste("nls_231.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "231",]$phi.variance <- vcov(get(paste("nls_231.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "231",]$alpha.variance <- vcov(get(paste("nls_231.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "231",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "231",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "231",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "231",]$A <- coefs["A"]
nls.param.df_nh[nls.param.df_nh$Code == "231",]$k <- coefs["k"]

nls.param.df_nh[nls.param.df_nh$Code == "231",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "231",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "231",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "231",]$A.2.5 <- intervals_low["A"]
nls.param.df_nh[nls.param.df_nh$Code == "231",]$k.2.5 <- intervals_low["k"]

nls.param.df_nh[nls.param.df_nh$Code == "231",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "231",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "231",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "231",]$A.97.5 <- intervals_high["A"]
nls.param.df_nh[nls.param.df_nh$Code == "231",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_231.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_231.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_231.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_231.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_231$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_231.4 <- nls(f_4, data = G_231, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_231$nls_weights.2), 
 )

## phi
try(
  nls_231.5 <- nls(f_5, data=G_231, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_231$nls_weights.2), 
 )

# phi/alpha
try(
  nls_231.6 <- nls(f_6, data = G_231, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_231$nls_weights.2), 
 )

## test
if(exists("nls_231.4") & exists("nls_231.5") & exists("nls_231.6")){
  print(anova(nls_231.4, nls_231.5, nls_231.6))
} else if(exists("nls_231.4") & exists("nls_231.6")){
  print(anova(nls_231.4, nls_231.6))
} else if(exists("nls_231.5") & exists("nls_231.6")){
  print(anova(nls_231.5, nls_231.6))
} else if(exists("nls_231.4") & exists("nls_231.5")){
  print(anova(nls_231.4, nls_231.5))
}

## AIC comparison
AIC3_231 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_231[AIC2_231$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_231.4"), AIC(get("nls_231.4")), NA),
            ifelse(exists("nls_231.5"), AIC(get("nls_231.5")), NA),
            ifelse(exists("nls_231.6"), AIC(get("nls_231.6")), NA)
            ))

print(AIC3_231) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_231[!is.na(AIC3_231$AIC) & AIC3_231$AIC == min(AIC3_231$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "231",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_nh[Best_mods.P_nh$Code == "231",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_231.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_231.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "231",]$ge.variance <- vcov(get(paste("nls_231.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "231",]$phi.variance <- vcov(get(paste("nls_231.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "231",]$alpha.variance <- vcov(get(paste("nls_231.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "231",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "231",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "231",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "231",]$a <- coefs["a"]
nls.param.df_nh[nls.param.df_nh$Code == "231",]$b <- coefs["b"]
nls.param.df_nh[nls.param.df_nh$Code == "231",]$c <- coefs["c"]
nls.param.df_nh[nls.param.df_nh$Code == "231",]$d <- coefs["d"]

nls.param.df_nh[nls.param.df_nh$Code == "231",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "231",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "231",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "231",]$a.2.5 <- intervals_low["a"]
nls.param.df_nh[nls.param.df_nh$Code == "231",]$b.2.5 <- intervals_low["b"]
nls.param.df_nh[nls.param.df_nh$Code == "231",]$c.2.5 <- intervals_low["c"]
nls.param.df_nh[nls.param.df_nh$Code == "231",]$d.2.5 <- intervals_low["d"]

nls.param.df_nh[nls.param.df_nh$Code == "231",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "231",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "231",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "231",]$a.97.5 <- intervals_high["a"]
nls.param.df_nh[nls.param.df_nh$Code == "231",]$b.97.5 <- intervals_high["b"]
nls.param.df_nh[nls.param.df_nh$Code == "231",]$c.97.5 <- intervals_high["c"]
nls.param.df_nh[nls.param.df_nh$Code == "231",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_231.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_231.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_231.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_231.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_231 <- nlsResiduals(
  get(paste("nls_231.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_231)

## test residuals
if(length(G_231$pltID) < 5001) {test.nlsResiduals(resid_231)}

}   else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_231_pred <- predict(get(paste("nls_231.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_231$MEASTIME_t2, na.rm = T), max(G_231$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_231$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_231$MEASTIME_t2, na.rm = T), max(G_231$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_231$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_231$DeltaPDSI, na.rm = T), max(G_231$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_231$MEASTIME_t2, na.rm = T), max(G_231$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_231$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_231$B_L_prop, na.rm = T), max(G_231$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_231$DeltaPDSI, na.rm = T), max(G_231$STDAGE_t2)))
                      } )

G_231_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_231$STDAGE_t2),by = 1),  
                            "fitted"=G_231_pred)

## plot
gg.231 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_231, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_231, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_231))), breaks = cutvec_231) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_231_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_231_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("231 -  Southeastern Mixed Forest") + 
          
          #ylim(0, max(G_231_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_231,1)*1.05), expand = c(0,0))

gg.231

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_231 <- data.frame(
  bin = as.factor(levels(cut(G_231$STDAGE_t2, cutvec_231))),
  data.mean = tapply(G_231$B_plt_t2_MgHa, cut(G_231$STDAGE_t2, cutvec_231), 
                     mean), 
  data.CI.high =  tapply(G_231$B_plt_t2_MgHa, cut(G_231$STDAGE_t2, cutvec_231), 
                    high.CI), 
  data.CI.low = tapply(G_231$B_plt_t2_MgHa, cut(G_231$STDAGE_t2, cutvec_231),
                    low.CI), 
  pred.mean = G_231_pred_df[G_231_pred_df$STDAGE_t2 %in% bin_mids_231,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_231 <-  DM_compare_231 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_231$bin)[gtools::mixedorder(levels(DM_compare_231$bin))]))

## ggplot
gg.231.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_231) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_231))), 
                              labels = levels(DM_compare_231$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("231 -  Southeastern Mixed Forest",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +         
           theme_classic() + 
           # xlim(min(DM_compare_231$data.CI.low)-0.25, max(DM_compare_231$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_231$pred.CI.low)-0.25, max(DM_compare_231$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.231.B2

}   else {print("cannot plot observed vs. predicted")}
```

## 232 - Outer Coastal Plain Mixed Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_232 <- round(quantile(G_232$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_232)))){
  cutvec_232 <- round(quantile(G_232$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_232 <- unname(round(cutvec_232[-length(cutvec_232)] + diff(cutvec_232)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_232$STDAGE_t2_bin<-  cut(G_232$STDAGE_t2, cutvec_232)
## then get bin means
G_232_bin_means <- tapply(G_232$B_plt_t2_MgHa, cut(G_232$STDAGE_t2, cutvec_232), mean)

## make column weights.2
G_232$nls_weights.2 <- as.numeric(1/(G_232_bin_means[match(G_232$STDAGE_t2_bin, names(G_232_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_232.1 <- nls(f_1, data = G_232, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_232$nls_weights.2), 
 )

## phi
try(
  nls_232.2 <- nls(f_2, data=G_232, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_232$nls_weights.2), 
 )

# phi/alpha
try(
  nls_232.3 <- nls(f_3 , data = G_232, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_232$nls_weights.2), 
 )

## test
if(exists("nls_232.1") & exists("nls_232.2") & exists("nls_232.3")){
  print(anova(nls_232.1, nls_232.2, nls_232.3))
} else if(exists("nls_232.2") & exists("nls_232.3")){
  print(anova(nls_232.2, nls_232.3))
} else if(exists("nls_232.1") & exists("nls_232.2")){
  print(anova(nls_232.1, nls_232.2))
}
 
## AIC comparison
AIC1_232 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_232.1"), AIC(get("nls_232.1")), NA),
            ifelse(exists("nls_232.2"), AIC(get("nls_232.2")), NA),
            ifelse(exists("nls_232.3"), AIC(get("nls_232.3")), NA)
            ))

print(AIC1_232) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_232[!is.na(AIC1_232$AIC) & AIC1_232$AIC == min(AIC1_232$AIC, na.rm = T),]$model

try(summary(get(paste("nls_232.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_232.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_232.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_232.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_232.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_232.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_232.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_232.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_232.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_232.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_232,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_232$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_232.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_232,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_232$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_232.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_232,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_232$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_232.", Mod.Sel1, sep ="")) &
     exists(paste("nls_232.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_232.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_232.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_232.", Mod.Sel1, sep ="")),
             get(paste("nls_232.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_232.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_232.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_232.", Mod.Sel1, sep ="")) &
         exists(paste("nls_232.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_232.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_232.", Mod.Sel1, sep ="")),
               get(paste("nls_232.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_232.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_232.", Mod.Sel1, sep ="")) &
           exists(paste("nls_232.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_232.", Mod.Sel1, sep ="")),
                 get(paste("nls_232.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_232.", Mod.Sel1, sep ="")) &
              exists(paste("nls_232.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_232.", Mod.Sel1, sep ="")),
                    get(paste("nls_232.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_232.", Mod.Sel1, sep ="")) &
                exists(paste("nls_232.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_232.", Mod.Sel1, sep ="")),
                      get(paste("nls_232.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_232 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_232.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_232.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_232.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_232.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_232.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_232.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_232.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_232.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_232)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_232[!is.na(AIC2_232$AIC) & AIC2_232$AIC == min(AIC2_232$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "232",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_232.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_232.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "232",]$ge.variance <- vcov(get(paste("nls_232.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "232",]$phi.variance <- vcov(get(paste("nls_232.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "232",]$alpha.variance <- vcov(get(paste("nls_232.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "232",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "232",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "232",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "232",]$A <- coefs["A"]
nls.param.df_nh[nls.param.df_nh$Code == "232",]$k <- coefs["k"]

nls.param.df_nh[nls.param.df_nh$Code == "232",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "232",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "232",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "232",]$A.2.5 <- intervals_low["A"]
nls.param.df_nh[nls.param.df_nh$Code == "232",]$k.2.5 <- intervals_low["k"]

nls.param.df_nh[nls.param.df_nh$Code == "232",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "232",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "232",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "232",]$A.97.5 <- intervals_high["A"]
nls.param.df_nh[nls.param.df_nh$Code == "232",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_232.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_232.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_232.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_232.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_232$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_232.4 <- nls(f_4, data = G_232, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_232$nls_weights.2), 
 )

## phi
try(
  nls_232.5 <- nls(f_5, data=G_232, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_232$nls_weights.2), 
 )

# phi/alpha
try(
  nls_232.6 <- nls(f_6, data = G_232, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_232$nls_weights.2), 
 )

## test
if(exists("nls_232.4") & exists("nls_232.5") & exists("nls_232.6")){
  print(anova(nls_232.4, nls_232.5, nls_232.6))
} else if(exists("nls_232.4") & exists("nls_232.6")){
  print(anova(nls_232.4, nls_232.6))
} else if(exists("nls_232.5") & exists("nls_232.6")){
  print(anova(nls_232.5, nls_232.6))
} else if(exists("nls_232.4") & exists("nls_232.5")){
  print(anova(nls_232.4, nls_232.5))
}

## AIC comparison
AIC3_232 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_232[AIC2_232$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_232.4"), AIC(get("nls_232.4")), NA),
            ifelse(exists("nls_232.5"), AIC(get("nls_232.5")), NA),
            ifelse(exists("nls_232.6"), AIC(get("nls_232.6")), NA)
            ))

print(AIC3_232) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_232[!is.na(AIC3_232$AIC) & AIC3_232$AIC == min(AIC3_232$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "232",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_nh[Best_mods.P_nh$Code == "232",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_232.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_232.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "232",]$ge.variance <- vcov(get(paste("nls_232.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "232",]$phi.variance <- vcov(get(paste("nls_232.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "232",]$alpha.variance <- vcov(get(paste("nls_232.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "232",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "232",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "232",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "232",]$a <- coefs["a"]
nls.param.df_nh[nls.param.df_nh$Code == "232",]$b <- coefs["b"]
nls.param.df_nh[nls.param.df_nh$Code == "232",]$c <- coefs["c"]
nls.param.df_nh[nls.param.df_nh$Code == "232",]$d <- coefs["d"]

nls.param.df_nh[nls.param.df_nh$Code == "232",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "232",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "232",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "232",]$a.2.5 <- intervals_low["a"]
nls.param.df_nh[nls.param.df_nh$Code == "232",]$b.2.5 <- intervals_low["b"]
nls.param.df_nh[nls.param.df_nh$Code == "232",]$c.2.5 <- intervals_low["c"]
nls.param.df_nh[nls.param.df_nh$Code == "232",]$d.2.5 <- intervals_low["d"]

nls.param.df_nh[nls.param.df_nh$Code == "232",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "232",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "232",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "232",]$a.97.5 <- intervals_high["a"]
nls.param.df_nh[nls.param.df_nh$Code == "232",]$b.97.5 <- intervals_high["b"]
nls.param.df_nh[nls.param.df_nh$Code == "232",]$c.97.5 <- intervals_high["c"]
nls.param.df_nh[nls.param.df_nh$Code == "232",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_232.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_232.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_232.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_232.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_232 <- nlsResiduals(
  get(paste("nls_232.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_232)

## test residuals
if(length(G_232$pltID) < 5001) {test.nlsResiduals(resid_232)}

}   else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_232_pred <- predict(get(paste("nls_232.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_232$MEASTIME_t2, na.rm = T), max(G_232$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_232$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_232$MEASTIME_t2, na.rm = T), max(G_232$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_232$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_232$DeltaPDSI, na.rm = T), max(G_232$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_232$MEASTIME_t2, na.rm = T), max(G_232$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_232$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_232$B_L_prop, na.rm = T), max(G_232$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_232$DeltaPDSI, na.rm = T), max(G_232$STDAGE_t2)))
                      } )

G_232_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_232$STDAGE_t2),by = 1),  
                            "fitted"=G_232_pred)

## plot
gg.232 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_232, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_232, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_232))), breaks = cutvec_232) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_232_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_232_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("232 - Outer Coastal Plain Mixed Forest") + 
          
          #ylim(0, max(G_232_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_232,1)*1.05), expand = c(0,0))

gg.232

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_232 <- data.frame(
  bin = as.factor(levels(cut(G_232$STDAGE_t2, cutvec_232))),
  data.mean = tapply(G_232$B_plt_t2_MgHa, cut(G_232$STDAGE_t2, cutvec_232), 
                     mean), 
  data.CI.high =  tapply(G_232$B_plt_t2_MgHa, cut(G_232$STDAGE_t2, cutvec_232), 
                    high.CI), 
  data.CI.low = tapply(G_232$B_plt_t2_MgHa, cut(G_232$STDAGE_t2, cutvec_232),
                    low.CI), 
  pred.mean = G_232_pred_df[G_232_pred_df$STDAGE_t2 %in% bin_mids_232,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_232 <-  DM_compare_232 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_232$bin)[gtools::mixedorder(levels(DM_compare_232$bin))]))

## ggplot
gg.232.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_232) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_232))), 
                              labels = levels(DM_compare_232$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("232 - Outer Coastal Plain Mixed Forest",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +        
           theme_classic() + 
           # xlim(min(DM_compare_232$data.CI.low)-0.25, max(DM_compare_232$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_232$pred.CI.low)-0.25, max(DM_compare_232$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.232.B2

}   else {print("cannot plot observed vs. predicted")}
```

## 234 - Lower Mississippi Riverine Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_234 <- round(quantile(G_234$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_234)))){
  cutvec_234 <- round(quantile(G_234$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_234 <- unname(round(cutvec_234[-length(cutvec_234)] + diff(cutvec_234)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_234$STDAGE_t2_bin<-  cut(G_234$STDAGE_t2, cutvec_234)
## then get bin means
G_234_bin_means <- tapply(G_234$B_plt_t2_MgHa, cut(G_234$STDAGE_t2, cutvec_234), mean)

## make column weights.2
G_234$nls_weights.2 <- as.numeric(1/(G_234_bin_means[match(G_234$STDAGE_t2_bin, names(G_234_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_234.1 <- nls(f_1, data = G_234, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_234$nls_weights.2), 
 )

## phi
try(
  nls_234.2 <- nls(f_2, data=G_234, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_234$nls_weights.2), 
 )

# phi/alpha
try(
  nls_234.3 <- nls(f_3 , data = G_234, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_234$nls_weights.2), 
 )

## test
if(exists("nls_234.1") & exists("nls_234.2") & exists("nls_234.3")){
  print(anova(nls_234.1, nls_234.2, nls_234.3))
} else if(exists("nls_234.2") & exists("nls_234.3")){
  print(anova(nls_234.2, nls_234.3))
} else if(exists("nls_234.1") & exists("nls_234.2")){
  print(anova(nls_234.1, nls_234.2))
}
 
## AIC comparison
AIC1_234 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_234.1"), AIC(get("nls_234.1")), NA),
            ifelse(exists("nls_234.2"), AIC(get("nls_234.2")), NA),
            ifelse(exists("nls_234.3"), AIC(get("nls_234.3")), NA)
            ))

print(AIC1_234) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_234[!is.na(AIC1_234$AIC) & AIC1_234$AIC == min(AIC1_234$AIC, na.rm = T),]$model

try(summary(get(paste("nls_234.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_234.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_234.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_234.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_234.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_234.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_234.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_234.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_234.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_234.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_234,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_234$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_234.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_234,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_234$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_234.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_234,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_234$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_234.", Mod.Sel1, sep ="")) &
     exists(paste("nls_234.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_234.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_234.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_234.", Mod.Sel1, sep ="")),
             get(paste("nls_234.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_234.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_234.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_234.", Mod.Sel1, sep ="")) &
         exists(paste("nls_234.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_234.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_234.", Mod.Sel1, sep ="")),
               get(paste("nls_234.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_234.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_234.", Mod.Sel1, sep ="")) &
           exists(paste("nls_234.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_234.", Mod.Sel1, sep ="")),
                 get(paste("nls_234.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_234.", Mod.Sel1, sep ="")) &
              exists(paste("nls_234.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_234.", Mod.Sel1, sep ="")),
                    get(paste("nls_234.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_234.", Mod.Sel1, sep ="")) &
                exists(paste("nls_234.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_234.", Mod.Sel1, sep ="")),
                      get(paste("nls_234.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_234 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_234.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_234.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_234.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_234.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_234.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_234.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_234.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_234.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_234)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_234[!is.na(AIC2_234$AIC) & AIC2_234$AIC == min(AIC2_234$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "234",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_234.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_234.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "234",]$ge.variance <- vcov(get(paste("nls_234.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "234",]$phi.variance <- vcov(get(paste("nls_234.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "234",]$alpha.variance <- vcov(get(paste("nls_234.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "234",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "234",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "234",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "234",]$A <- coefs["A"]
nls.param.df_nh[nls.param.df_nh$Code == "234",]$k <- coefs["k"]

nls.param.df_nh[nls.param.df_nh$Code == "234",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "234",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "234",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "234",]$A.2.5 <- intervals_low["A"]
nls.param.df_nh[nls.param.df_nh$Code == "234",]$k.2.5 <- intervals_low["k"]

nls.param.df_nh[nls.param.df_nh$Code == "234",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "234",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "234",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "234",]$A.97.5 <- intervals_high["A"]
nls.param.df_nh[nls.param.df_nh$Code == "234",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_234.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_234.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_234.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_234.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_234$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_234.4 <- nls(f_4, data = G_234, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_234$nls_weights.2), 
 )

## phi
try(
  nls_234.5 <- nls(f_5, data=G_234, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_234$nls_weights.2), 
 )

# phi/alpha
try(
  nls_234.6 <- nls(f_6, data = G_234, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_234$nls_weights.2), 
 )

## test
if(exists("nls_234.4") & exists("nls_234.5") & exists("nls_234.6")){
  print(anova(nls_234.4, nls_234.5, nls_234.6))
} else if(exists("nls_234.4") & exists("nls_234.6")){
  print(anova(nls_234.4, nls_234.6))
} else if(exists("nls_234.5") & exists("nls_234.6")){
  print(anova(nls_234.5, nls_234.6))
} else if(exists("nls_234.4") & exists("nls_234.5")){
  print(anova(nls_234.4, nls_234.5))
}

## AIC comparison
AIC3_234 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_234[AIC2_234$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_234.4"), AIC(get("nls_234.4")), NA),
            ifelse(exists("nls_234.5"), AIC(get("nls_234.5")), NA),
            ifelse(exists("nls_234.6"), AIC(get("nls_234.6")), NA)
            ))

print(AIC3_234) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_234[!is.na(AIC3_234$AIC) & AIC3_234$AIC == min(AIC3_234$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "234",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_nh[Best_mods.P_nh$Code == "234",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_234.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_234.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "234",]$ge.variance <- vcov(get(paste("nls_234.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "234",]$phi.variance <- vcov(get(paste("nls_234.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "234",]$alpha.variance <- vcov(get(paste("nls_234.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "234",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "234",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "234",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "234",]$a <- coefs["a"]
nls.param.df_nh[nls.param.df_nh$Code == "234",]$b <- coefs["b"]
nls.param.df_nh[nls.param.df_nh$Code == "234",]$c <- coefs["c"]
nls.param.df_nh[nls.param.df_nh$Code == "234",]$d <- coefs["d"]

nls.param.df_nh[nls.param.df_nh$Code == "234",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "234",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "234",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "234",]$a.2.5 <- intervals_low["a"]
nls.param.df_nh[nls.param.df_nh$Code == "234",]$b.2.5 <- intervals_low["b"]
nls.param.df_nh[nls.param.df_nh$Code == "234",]$c.2.5 <- intervals_low["c"]
nls.param.df_nh[nls.param.df_nh$Code == "234",]$d.2.5 <- intervals_low["d"]

nls.param.df_nh[nls.param.df_nh$Code == "234",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "234",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "234",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "234",]$a.97.5 <- intervals_high["a"]
nls.param.df_nh[nls.param.df_nh$Code == "234",]$b.97.5 <- intervals_high["b"]
nls.param.df_nh[nls.param.df_nh$Code == "234",]$c.97.5 <- intervals_high["c"]
nls.param.df_nh[nls.param.df_nh$Code == "234",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_234.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_234.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_234.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_234.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_234 <- nlsResiduals(
  get(paste("nls_234.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_234)

## test residuals
if(length(G_234$pltID) < 5001) {test.nlsResiduals(resid_234)}

}   else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_234_pred <- predict(get(paste("nls_234.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_234$MEASTIME_t2, na.rm = T), max(G_234$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_234$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_234$MEASTIME_t2, na.rm = T), max(G_234$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_234$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_234$DeltaPDSI, na.rm = T), max(G_234$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_234$MEASTIME_t2, na.rm = T), max(G_234$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_234$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_234$B_L_prop, na.rm = T), max(G_234$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_234$DeltaPDSI, na.rm = T), max(G_234$STDAGE_t2)))
                      } )

G_234_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_234$STDAGE_t2),by = 1),  
                            "fitted"=G_234_pred)

## plot
gg.234 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_234, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_234, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_234))), breaks = cutvec_234) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_234_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_234_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("234 - Lower Mississippi Riverine Forest") + 
          
          #ylim(0, max(G_234_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_234,1)*1.05), expand = c(0,0))

gg.234

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_234 <- data.frame(
  bin = as.factor(levels(cut(G_234$STDAGE_t2, cutvec_234))),
  data.mean = tapply(G_234$B_plt_t2_MgHa, cut(G_234$STDAGE_t2, cutvec_234), 
                     mean), 
  data.CI.high =  tapply(G_234$B_plt_t2_MgHa, cut(G_234$STDAGE_t2, cutvec_234), 
                    high.CI), 
  data.CI.low = tapply(G_234$B_plt_t2_MgHa, cut(G_234$STDAGE_t2, cutvec_234),
                    low.CI), 
  pred.mean = G_234_pred_df[G_234_pred_df$STDAGE_t2 %in% bin_mids_234,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_234 <-  DM_compare_234 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_234$bin)[gtools::mixedorder(levels(DM_compare_234$bin))]))

## ggplot
gg.234.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_234) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_234))), 
                              labels = levels(DM_compare_234$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("234 - Lower Mississippi Riverine Forest",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +        
           theme_classic() + 
           # xlim(min(DM_compare_234$data.CI.low)-0.25, max(DM_compare_234$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_234$pred.CI.low)-0.25, max(DM_compare_234$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.234.B2

}   else {print("cannot plot observed vs. predicted")}
```

## 242 - Pacific Lowland Mixed Forest
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_242 <- round(quantile(G_242$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_242)))){
  cutvec_242 <- round(quantile(G_242$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_242 <- unname(round(cutvec_242[-length(cutvec_242)] + diff(cutvec_242)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_242$STDAGE_t2_bin<-  cut(G_242$STDAGE_t2,cutvec_242)
## then get bin means
G_242_bin_means <- tapply(G_242$B_plt_t2_MgHa, cut(G_242$STDAGE_t2,  cutvec_242), mean)

## make column weights.2
G_242$nls_weights.2 <- as.numeric(1/(G_242_bin_means[match(G_242$STDAGE_t2_bin, names(G_242_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_242.1 <- nls(f_1, data = G_242, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_242$nls_weights.2), 
 )

## phi
try(
  nls_242.2 <- nls(f_2, data=G_242, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_242$nls_weights.2), 
 )

# phi/alpha
try(
  nls_242.3 <- nls(f_3 , data = G_242, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_242$nls_weights.2), 
 )

## test
if(exists("nls_242.1") & exists("nls_242.2") & exists("nls_242.3")){
  print(anova(nls_242.1, nls_242.2, nls_242.3))
} else if(exists("nls_242.2") & exists("nls_242.3")){
  print(anova(nls_242.2, nls_242.3))
} else if(exists("nls_242.1") & exists("nls_242.2")){
  print(anova(nls_242.1, nls_242.2))
}
 
## AIC comparison
AIC1_242 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_242.1"), AIC(get("nls_242.1")), NA),
            ifelse(exists("nls_242.2"), AIC(get("nls_242.2")), NA),
            ifelse(exists("nls_242.3"), AIC(get("nls_242.3")), NA)
            ))

print(AIC1_242) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_242[!is.na(AIC1_242$AIC) & is.na(AIC1_242$AIC) & AIC1_242$AIC == min(AIC1_242$AIC, na.rm = T),]$model

try(summary(get(paste("nls_242.",  Mod.Sel1, sep =""))))  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_242.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_242.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_242.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_242.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_242.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_242.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_242.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_242.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_242.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_242,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_242$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_242.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_242,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_242$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_242.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_242,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_242$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_242.", Mod.Sel1, sep ="")) &
     exists(paste("nls_242.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_242.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_242.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_242.", Mod.Sel1, sep ="")),
             get(paste("nls_242.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_242.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_242.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_242.", Mod.Sel1, sep ="")) &
         exists(paste("nls_242.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_242.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_242.", Mod.Sel1, sep ="")),
               get(paste("nls_242.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_242.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_242.", Mod.Sel1, sep ="")) &
           exists(paste("nls_242.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_242.", Mod.Sel1, sep ="")),
                 get(paste("nls_242.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_242.", Mod.Sel1, sep ="")) &
              exists(paste("nls_242.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_242.", Mod.Sel1, sep ="")),
                    get(paste("nls_242.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_242.", Mod.Sel1, sep ="")) &
                exists(paste("nls_242.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_242.", Mod.Sel1, sep ="")),
                      get(paste("nls_242.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_242 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_242.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_242.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_242.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_242.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_242.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_242.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_242.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_242.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_242)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_242[!is.na(AIC2_242$AIC) & AIC2_242$AIC == min(AIC2_242$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "242",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_242.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_242.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "242",]$ge.variance <- vcov(get(paste("nls_242.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "242",]$phi.variance <- vcov(get(paste("nls_242.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "242",]$alpha.variance <- vcov(get(paste("nls_242.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "242",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "242",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "242",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "242",]$A <- coefs["A"]
nls.param.df_nh[nls.param.df_nh$Code == "242",]$k <- coefs["k"]

nls.param.df_nh[nls.param.df_nh$Code == "242",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "242",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "242",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "242",]$A.2.5 <- intervals_low["A"]
nls.param.df_nh[nls.param.df_nh$Code == "242",]$k.2.5 <- intervals_low["k"]

nls.param.df_nh[nls.param.df_nh$Code == "242",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "242",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "242",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "242",]$A.97.5 <- intervals_high["A"]
nls.param.df_nh[nls.param.df_nh$Code == "242",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_242.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_242.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_242.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_242.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_242$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_242.4 <- nls(f_4, data = G_242, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_242$nls_weights.2), 
 )

## phi
try(
  nls_242.5 <- nls(f_5, data=G_242, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_242$nls_weights.2), 
 )

# phi/alpha
try(
  nls_242.6 <- nls(f_6, data = G_242, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_242$nls_weights.2), 
 )

## test
if(exists("nls_242.4") & exists("nls_242.5") & exists("nls_242.6")){
  print(anova(nls_242.4, nls_242.5, nls_242.6))
} else if(exists("nls_242.4") & exists("nls_242.6")){
  print(anova(nls_242.4, nls_242.6))
} else if(exists("nls_242.5") & exists("nls_242.6")){
  print(anova(nls_242.5, nls_242.6))
} else if(exists("nls_242.4") & exists("nls_242.5")){
  print(anova(nls_242.4, nls_242.5))
}

## AIC comparison
AIC3_242 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_242[AIC2_242$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_242.4"), AIC(get("nls_242.4")), NA),
            ifelse(exists("nls_242.5"), AIC(get("nls_242.5")), NA),
            ifelse(exists("nls_242.6"), AIC(get("nls_242.6")), NA)
            ))

print(AIC3_242) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_242[!is.na(AIC3_242$AIC) & AIC3_242$AIC == min(AIC3_242$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "242",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_nh[Best_mods.P_nh$Code == "242",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_242.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_242.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "242",]$ge.variance <- vcov(get(paste("nls_242.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "242",]$phi.variance <- vcov(get(paste("nls_242.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "242",]$alpha.variance <- vcov(get(paste("nls_242.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "242",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "242",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "242",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "242",]$a <- coefs["a"]
nls.param.df_nh[nls.param.df_nh$Code == "242",]$b <- coefs["b"]
nls.param.df_nh[nls.param.df_nh$Code == "242",]$c <- coefs["c"]
nls.param.df_nh[nls.param.df_nh$Code == "242",]$d <- coefs["d"]

nls.param.df_nh[nls.param.df_nh$Code == "242",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "242",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "242",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "242",]$a.2.5 <- intervals_low["a"]
nls.param.df_nh[nls.param.df_nh$Code == "242",]$b.2.5 <- intervals_low["b"]
nls.param.df_nh[nls.param.df_nh$Code == "242",]$c.2.5 <- intervals_low["c"]
nls.param.df_nh[nls.param.df_nh$Code == "242",]$d.2.5 <- intervals_low["d"]

nls.param.df_nh[nls.param.df_nh$Code == "242",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "242",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "242",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "242",]$a.97.5 <- intervals_high["a"]
nls.param.df_nh[nls.param.df_nh$Code == "242",]$b.97.5 <- intervals_high["b"]
nls.param.df_nh[nls.param.df_nh$Code == "242",]$c.97.5 <- intervals_high["c"]
nls.param.df_nh[nls.param.df_nh$Code == "242",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_242.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_242.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_242.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_242.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_242 <- nlsResiduals(
  get(paste("nls_242.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_242)

## test residuals
if(length(G_242$pltID) < 5001) {test.nlsResiduals(resid_242)}

}   else {print("cannot plot residuals")}
```


### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## predict model fit
G_242_pred <- predict(get(paste("nls_242.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_242$MEASTIME_t2, na.rm = T), max(G_242$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_242$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_242$MEASTIME_t2, na.rm = T), max(G_242$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_242$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_242$DeltaPDSI, na.rm = T), max(G_242$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_242$MEASTIME_t2, na.rm = T), max(G_242$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_242$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_242$B_L_prop, na.rm = T), max(G_242$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_242$DeltaPDSI, na.rm = T), max(G_242$STDAGE_t2)))
                      } )

G_242_pred_df <- data.frame("STDAGE_t2"=seq(0,250,by = 1),
                            "fitted" =G_242_pred)

## plot
gg.242 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_242, alpha = 0.5, shape ="+", col = "#60606080") +

          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_242,
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res},
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_242))), breaks = cutvec_242) +

          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`),
                      #data = G_242_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +

          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_242_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) +


          theme_classic() +
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"),
               x = "Stand Age (yrs)") +  ggtitle("242 - Pacific Lowland Mixed Forest") +

          #ylim(0, max(G_242_pred_df$`Prop.97.5%` + 0.25)) +
          scale_x_continuous(limits = c(0, max(G_242$STDAGE_t2)), expand = c(0,0))

gg.242

}  else {print("cannot plot data with prediction")}
```

### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_242 <- data.frame(
  bin = as.factor(levels(cut(G_242$STDAGE_t2, cutvec_242))),
  data.mean = tapply(G_242$B_plt_t2_MgHa, cut(G_242$STDAGE_t2, cutvec_242),
                     mean),
  data.CI.high =  tapply(G_242$B_plt_t2_MgHa, cut(G_242$STDAGE_t2, cutvec_242),
                    high.CI),
  data.CI.low = tapply(G_242$B_plt_t2_MgHa, cut(G_242$STDAGE_t2, cutvec_242),
                    low.CI),
  pred.mean = G_242_pred_df[G_242_pred_df$STDAGE_t2 %in% bin_mids_242,]$fitted)

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY
DM_compare_242 <-  DM_compare_242 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_242$bin)[gtools::mixedorder(levels(DM_compare_242$bin))]))

## ggplot
gg.242.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_242) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_242))),
                              labels = levels(DM_compare_242$bin),
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +
           labs(x = expression("observed biomass (Mg ha"^-1*")"),
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("242 - Pacific Lowland Mixed Forest",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +
           theme_classic() +
           # xlim(min(DM_compare_242$data.CI.low)-0.25, max(DM_compare_242$data.CI.high)+0.25) +
           # ylim(min(DM_compare_242$pred.CI.low)-0.25, max(DM_compare_242$pred.CI.high)+0.25) +
           theme(legend.position = "top") + tune::coord_obs_pred()

gg.242.B2

}   else {print("cannot plot observed vs. predicted")}
```

## 251 - Prairie Parkland (Temperate)
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_251 <- round(quantile(G_251$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_251)))){
  cutvec_251 <- round(quantile(G_251$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_251 <- unname(round(cutvec_251[-length(cutvec_251)] + diff(cutvec_251)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_251$STDAGE_t2_bin<-  cut(G_251$STDAGE_t2, cutvec_251)
## then get bin means
G_251_bin_means <- tapply(G_251$B_plt_t2_MgHa, cut(G_251$STDAGE_t2,  cutvec_251), mean)

## make column weights.2
G_251$nls_weights.2 <- as.numeric(1/(G_251_bin_means[match(G_251$STDAGE_t2_bin, names(G_251_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_251.1 <- nls(f_1, data = G_251, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_251$nls_weights.2), 
 )

## phi
try(
  nls_251.2 <- nls(f_2, data=G_251, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_251$nls_weights.2), 
 )

# phi/alpha
try(
  nls_251.3 <- nls(f_3 , data = G_251, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_251$nls_weights.2), 
 )

## test
if(exists("nls_251.1") & exists("nls_251.2") & exists("nls_251.3")){
  print(anova(nls_251.1, nls_251.2, nls_251.3))
} else if(exists("nls_251.2") & exists("nls_251.3")){
  print(anova(nls_251.2, nls_251.3))
} else if(exists("nls_251.1") & exists("nls_251.2")){
  print(anova(nls_251.1, nls_251.2))
}
 
## AIC comparison
AIC1_251 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_251.1"), AIC(get("nls_251.1")), NA),
            ifelse(exists("nls_251.2"), AIC(get("nls_251.2")), NA),
            ifelse(exists("nls_251.3"), AIC(get("nls_251.3")), NA)
            ))

print(AIC1_251) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_251[!is.na(AIC1_251$AIC) & AIC1_251$AIC == min(AIC1_251$AIC, na.rm = T),]$model

try(summary(get(paste("nls_251.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_251.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_251.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_251.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_251.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_251.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_251.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_251.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_251.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_251.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_251,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_251$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_251.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_251,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_251$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_251.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_251,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_251$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_251.", Mod.Sel1, sep ="")) &
     exists(paste("nls_251.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_251.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_251.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_251.", Mod.Sel1, sep ="")),
             get(paste("nls_251.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_251.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_251.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_251.", Mod.Sel1, sep ="")) &
         exists(paste("nls_251.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_251.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_251.", Mod.Sel1, sep ="")),
               get(paste("nls_251.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_251.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_251.", Mod.Sel1, sep ="")) &
           exists(paste("nls_251.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_251.", Mod.Sel1, sep ="")),
                 get(paste("nls_251.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_251.", Mod.Sel1, sep ="")) &
              exists(paste("nls_251.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_251.", Mod.Sel1, sep ="")),
                    get(paste("nls_251.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_251.", Mod.Sel1, sep ="")) &
                exists(paste("nls_251.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_251.", Mod.Sel1, sep ="")),
                      get(paste("nls_251.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_251 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_251.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_251.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_251.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_251.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_251.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_251.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_251.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_251.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_251)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_251[!is.na(AIC2_251$AIC) & AIC2_251$AIC == min(AIC2_251$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "251",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_251.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_251.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "251",]$ge.variance <- vcov(get(paste("nls_251.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "251",]$phi.variance <- vcov(get(paste("nls_251.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "251",]$alpha.variance <- vcov(get(paste("nls_251.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "251",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "251",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "251",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "251",]$A <- coefs["A"]
nls.param.df_nh[nls.param.df_nh$Code == "251",]$k <- coefs["k"]

nls.param.df_nh[nls.param.df_nh$Code == "251",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "251",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "251",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "251",]$A.2.5 <- intervals_low["A"]
nls.param.df_nh[nls.param.df_nh$Code == "251",]$k.2.5 <- intervals_low["k"]

nls.param.df_nh[nls.param.df_nh$Code == "251",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "251",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "251",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "251",]$A.97.5 <- intervals_high["A"]
nls.param.df_nh[nls.param.df_nh$Code == "251",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_251.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_251.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_251.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_251.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_251$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_251.4 <- nls(f_4, data = G_251, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_251$nls_weights.2), 
 )

## phi
try(
  nls_251.5 <- nls(f_5, data=G_251, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_251$nls_weights.2), 
 )

# phi/alpha
try(
  nls_251.6 <- nls(f_6, data = G_251, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_251$nls_weights.2), 
 )

## test
if(exists("nls_251.4") & exists("nls_251.5") & exists("nls_251.6")){
  print(anova(nls_251.4, nls_251.5, nls_251.6))
} else if(exists("nls_251.4") & exists("nls_251.6")){
  print(anova(nls_251.4, nls_251.6))
} else if(exists("nls_251.5") & exists("nls_251.6")){
  print(anova(nls_251.5, nls_251.6))
} else if(exists("nls_251.4") & exists("nls_251.5")){
  print(anova(nls_251.4, nls_251.5))
}

## AIC comparison
AIC3_251 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_251[AIC2_251$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_251.4"), AIC(get("nls_251.4")), NA),
            ifelse(exists("nls_251.5"), AIC(get("nls_251.5")), NA),
            ifelse(exists("nls_251.6"), AIC(get("nls_251.6")), NA)
            ))

print(AIC3_251) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_251[!is.na(AIC3_251$AIC) & AIC3_251$AIC == min(AIC3_251$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "251",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_nh[Best_mods.P_nh$Code == "251",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_251.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_251.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "251",]$ge.variance <- vcov(get(paste("nls_251.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "251",]$phi.variance <- vcov(get(paste("nls_251.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "251",]$alpha.variance <- vcov(get(paste("nls_251.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "251",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "251",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "251",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "251",]$a <- coefs["a"]
nls.param.df_nh[nls.param.df_nh$Code == "251",]$b <- coefs["b"]
nls.param.df_nh[nls.param.df_nh$Code == "251",]$c <- coefs["c"]
nls.param.df_nh[nls.param.df_nh$Code == "251",]$d <- coefs["d"]

nls.param.df_nh[nls.param.df_nh$Code == "251",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "251",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "251",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "251",]$a.2.5 <- intervals_low["a"]
nls.param.df_nh[nls.param.df_nh$Code == "251",]$b.2.5 <- intervals_low["b"]
nls.param.df_nh[nls.param.df_nh$Code == "251",]$c.2.5 <- intervals_low["c"]
nls.param.df_nh[nls.param.df_nh$Code == "251",]$d.2.5 <- intervals_low["d"]

nls.param.df_nh[nls.param.df_nh$Code == "251",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "251",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "251",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "251",]$a.97.5 <- intervals_high["a"]
nls.param.df_nh[nls.param.df_nh$Code == "251",]$b.97.5 <- intervals_high["b"]
nls.param.df_nh[nls.param.df_nh$Code == "251",]$c.97.5 <- intervals_high["c"]
nls.param.df_nh[nls.param.df_nh$Code == "251",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_251.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_251.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_251.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_251.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_251 <- nlsResiduals(
  get(paste("nls_251.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_251)

## test residuals
if(length(G_251$pltID) < 5001) {test.nlsResiduals(resid_251)}

}   else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_251_pred <- predict(get(paste("nls_251.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_251$MEASTIME_t2, na.rm = T), max(G_251$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_251$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_251$MEASTIME_t2, na.rm = T), max(G_251$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_251$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_251$DeltaPDSI, na.rm = T), max(G_251$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_251$MEASTIME_t2, na.rm = T), max(G_251$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_251$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_251$B_L_prop, na.rm = T), max(G_251$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_251$DeltaPDSI, na.rm = T), max(G_251$STDAGE_t2)))
                      } )

G_251_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_251$STDAGE_t2),by = 1),  
                            "fitted"=G_251_pred)

## plot
gg.251 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_251, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_251, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_251))), breaks = cutvec_251) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_251_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_251_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("251 - Prairie Parkland (Temperate)") + 
          
          #ylim(0, max(G_251_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_251,1)*1.05), expand = c(0,0))

gg.251

}  else {print("cannot plot data with prediction")}
```

### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_251 <- data.frame(
  bin = as.factor(levels(cut(G_251$STDAGE_t2, cutvec_251))),
  data.mean = tapply(G_251$B_plt_t2_MgHa, cut(G_251$STDAGE_t2, cutvec_251), 
                     mean), 
  data.CI.high =  tapply(G_251$B_plt_t2_MgHa, cut(G_251$STDAGE_t2, cutvec_251), 
                    high.CI), 
  data.CI.low = tapply(G_251$B_plt_t2_MgHa, cut(G_251$STDAGE_t2, cutvec_251),
                    low.CI), 
  pred.mean = G_251_pred_df[G_251_pred_df$STDAGE_t2 %in% bin_mids_251,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_251 <-  DM_compare_251 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_251$bin)[gtools::mixedorder(levels(DM_compare_251$bin))]))

## ggplot
gg.251.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_251) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_251))), 
                              labels = levels(DM_compare_251$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("251 - Prairie Parkland (Temperate)",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +         
           theme_classic() + 
           # xlim(min(DM_compare_251$data.CI.low)-0.25, max(DM_compare_251$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_251$pred.CI.low)-0.25, max(DM_compare_251$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.251.B2

}   else {print("cannot plot observed vs. predicted")}
```

## 255 - Prairie Parkland (Subtropical)
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_255 <- round(quantile(G_255$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_255)))){
  cutvec_255 <- round(quantile(G_255$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_255 <- unname(round(cutvec_255[-length(cutvec_255)] + diff(cutvec_255)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_255$STDAGE_t2_bin<-  cut(G_255$STDAGE_t2, cutvec_255)
## then get bin means
G_255_bin_means <- tapply(G_255$B_plt_t2_MgHa, cut(G_255$STDAGE_t2,  cutvec_255), mean)

## make column weights.2
G_255$nls_weights.2 <- as.numeric(1/(G_255_bin_means[match(G_255$STDAGE_t2_bin, names(G_255_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {
  
# simple
try(
  nls_255.1 <- nls(f_1, data = G_255, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_255$nls_weights.2), 
 )

## phi
try(
  nls_255.2 <- nls(f_2, data=G_255, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_255$nls_weights.2), 
 )

# phi/alpha
try(
  nls_255.3 <- nls(f_3 , data = G_255, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_255$nls_weights.2), 
 )

## test
if(exists("nls_255.1") & exists("nls_255.2") & exists("nls_255.3")){
  print(anova(nls_255.1, nls_255.2, nls_255.3))
} else if(exists("nls_255.2") & exists("nls_255.3")){
  print(anova(nls_255.2, nls_255.3))
} else if(exists("nls_255.1") & exists("nls_255.2")){
  print(anova(nls_255.1, nls_255.2))
}
 
## AIC comparison
AIC1_255 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_255.1"), AIC(get("nls_255.1")), NA),
            ifelse(exists("nls_255.2"), AIC(get("nls_255.2")), NA),
            ifelse(exists("nls_255.3"), AIC(get("nls_255.3")), NA)
            ))

print(AIC1_255) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_255[!is.na(AIC1_255$AIC) & AIC1_255$AIC == min(AIC1_255$AIC, na.rm = T),]$model

try(summary(get(paste("nls_255.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_255.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_255.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_255.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_255.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_255.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_255.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_255.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_255.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_255.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_255,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_255$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_255.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_255,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 

          weights = G_255$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_255.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_255,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_255$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_255.", Mod.Sel1, sep ="")) &
     exists(paste("nls_255.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_255.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_255.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_255.", Mod.Sel1, sep ="")),
             get(paste("nls_255.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_255.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_255.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_255.", Mod.Sel1, sep ="")) &
         exists(paste("nls_255.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_255.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_255.", Mod.Sel1, sep ="")),
               get(paste("nls_255.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_255.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_255.", Mod.Sel1, sep ="")) &
           exists(paste("nls_255.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_255.", Mod.Sel1, sep ="")),
                 get(paste("nls_255.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_255.", Mod.Sel1, sep ="")) &
              exists(paste("nls_255.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_255.", Mod.Sel1, sep ="")),
                    get(paste("nls_255.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_255.", Mod.Sel1, sep ="")) &
                exists(paste("nls_255.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_255.", Mod.Sel1, sep ="")),
                      get(paste("nls_255.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_255 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_255.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_255.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_255.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_255.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_255.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_255.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_255.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_255.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_255)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_255[!is.na(AIC2_255$AIC) & AIC2_255$AIC == min(AIC2_255$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "255",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_255.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_255.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "255",]$ge.variance <- vcov(get(paste("nls_255.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "255",]$phi.variance <- vcov(get(paste("nls_255.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "255",]$alpha.variance <- vcov(get(paste("nls_255.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "255",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "255",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "255",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "255",]$A <- coefs["A"]
nls.param.df_nh[nls.param.df_nh$Code == "255",]$k <- coefs["k"]

nls.param.df_nh[nls.param.df_nh$Code == "255",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "255",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "255",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "255",]$A.2.5 <- intervals_low["A"]
nls.param.df_nh[nls.param.df_nh$Code == "255",]$k.2.5 <- intervals_low["k"]

nls.param.df_nh[nls.param.df_nh$Code == "255",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "255",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "255",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "255",]$A.97.5 <- intervals_high["A"]
nls.param.df_nh[nls.param.df_nh$Code == "255",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_255.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_255.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_255.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_255.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_255$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_255.4 <- nls(f_4, data = G_255, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_255$nls_weights.2), 
 )

## phi
try(
  nls_255.5 <- nls(f_5, data=G_255, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_255$nls_weights.2), 
 )

# phi/alpha
try(
  nls_255.6 <- nls(f_6, data = G_255, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_255$nls_weights.2), 
 )

## test
if(exists("nls_255.4") & exists("nls_255.5") & exists("nls_255.6")){
  print(anova(nls_255.4, nls_255.5, nls_255.6))
} else if(exists("nls_255.4") & exists("nls_255.6")){
  print(anova(nls_255.4, nls_255.6))
} else if(exists("nls_255.5") & exists("nls_255.6")){
  print(anova(nls_255.5, nls_255.6))
} else if(exists("nls_255.4") & exists("nls_255.5")){
  print(anova(nls_255.4, nls_255.5))
}

## AIC comparison
AIC3_255 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_255[AIC2_255$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_255.4"), AIC(get("nls_255.4")), NA),
            ifelse(exists("nls_255.5"), AIC(get("nls_255.5")), NA),
            ifelse(exists("nls_255.6"), AIC(get("nls_255.6")), NA)
            ))

print(AIC3_255) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_255[!is.na(AIC3_255$AIC) & AIC3_255$AIC == min(AIC3_255$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "255",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_nh[Best_mods.P_nh$Code == "255",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_255.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_255.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "255",]$ge.variance <- vcov(get(paste("nls_255.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "255",]$phi.variance <- vcov(get(paste("nls_255.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "255",]$alpha.variance <- vcov(get(paste("nls_255.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "255",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "255",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "255",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "255",]$a <- coefs["a"]
nls.param.df_nh[nls.param.df_nh$Code == "255",]$b <- coefs["b"]
nls.param.df_nh[nls.param.df_nh$Code == "255",]$c <- coefs["c"]
nls.param.df_nh[nls.param.df_nh$Code == "255",]$d <- coefs["d"]

nls.param.df_nh[nls.param.df_nh$Code == "255",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "255",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "255",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "255",]$a.2.5 <- intervals_low["a"]
nls.param.df_nh[nls.param.df_nh$Code == "255",]$b.2.5 <- intervals_low["b"]
nls.param.df_nh[nls.param.df_nh$Code == "255",]$c.2.5 <- intervals_low["c"]
nls.param.df_nh[nls.param.df_nh$Code == "255",]$d.2.5 <- intervals_low["d"]

nls.param.df_nh[nls.param.df_nh$Code == "255",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "255",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "255",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "255",]$a.97.5 <- intervals_high["a"]
nls.param.df_nh[nls.param.df_nh$Code == "255",]$b.97.5 <- intervals_high["b"]
nls.param.df_nh[nls.param.df_nh$Code == "255",]$c.97.5 <- intervals_high["c"]
nls.param.df_nh[nls.param.df_nh$Code == "255",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_255.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_255.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_255.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_255.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_255 <- nlsResiduals(
  get(paste("nls_255.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_255)

## test residuals
if(length(G_255$pltID) < 5001) {test.nlsResiduals(resid_255)}

}   else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_255_pred <- predict(get(paste("nls_255.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_255$MEASTIME_t2, na.rm = T), max(G_255$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_255$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_255$MEASTIME_t2, na.rm = T), max(G_255$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_255$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_255$DeltaPDSI, na.rm = T), max(G_255$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_255$MEASTIME_t2, na.rm = T), max(G_255$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_255$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_255$B_L_prop, na.rm = T), max(G_255$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_255$DeltaPDSI, na.rm = T), max(G_255$STDAGE_t2)))
                      } )

G_255_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_255$STDAGE_t2),by = 1),  
                            "fitted"=G_255_pred)

## plot
gg.255 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_255, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_255, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_255))), breaks = cutvec_255) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_255_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_255_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("255 -  Prairie Parkland (Subtropical)") + 
          
          #ylim(0, max(G_255_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_255,1)*1.05), expand = c(0,0))

gg.255

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_255 <- data.frame(
  bin = as.factor(levels(cut(G_255$STDAGE_t2, cutvec_255))),
  data.mean = tapply(G_255$B_plt_t2_MgHa, cut(G_255$STDAGE_t2, cutvec_255), 
                     mean), 
  data.CI.high =  tapply(G_255$B_plt_t2_MgHa, cut(G_255$STDAGE_t2, cutvec_255), 
                    high.CI), 
  data.CI.low = tapply(G_255$B_plt_t2_MgHa, cut(G_255$STDAGE_t2, cutvec_255),
                    low.CI), 
  pred.mean = G_255_pred_df[G_255_pred_df$STDAGE_t2 %in% bin_mids_255,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_255 <-  DM_compare_255 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_255$bin)[gtools::mixedorder(levels(DM_compare_255$bin))]))

## ggplot
gg.255.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_255) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_255))), 
                              labels = levels(DM_compare_255$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("255 -  Prairie Parkland (Subtropical)",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +         
           theme_classic() + 
           # xlim(min(DM_compare_255$data.CI.low)-0.25, max(DM_compare_255$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_255$pred.CI.low)-0.25, max(DM_compare_255$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.255.B2

}   else {print("cannot plot observed vs. predicted")}
```

## 261 - California Coastal Chaparral Forest and Shrub
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_261 <- round(quantile(G_261$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_261)))){
  cutvec_261 <- round(quantile(G_261$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_261 <- unname(round(cutvec_261[-length(cutvec_261)] + diff(cutvec_261)/2))

#### add weights data column)

## first get the correct bin  - assign as column in data frame
G_261$STDAGE_t2_bin<-  cut(G_261$STDAGE_t2, cutvec_261)
## then get bin means
G_261_bin_means <- tapply(G_261$B_plt_t2_MgHa, cut(G_261$STDAGE_t2,  cutvec_261), mean)

## make column weights.2
G_261$nls_weights.2 <- as.numeric(1/(G_261_bin_means[match(G_261$STDAGE_t2_bin, names(G_261_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_261.1 <- nls(f_1, data = G_261, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_261$nls_weights.2), 
 )

## phi
try(
  nls_261.2 <- nls(f_2, data=G_261, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_261$nls_weights.2), 
 )

# phi/alpha
try(
  nls_261.3 <- nls(f_3 , data = G_261, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_261$nls_weights.2), 
 )

## test
if(exists("nls_261.1") & exists("nls_261.2") & exists("nls_261.3")){
  print(anova(nls_261.1, nls_261.2, nls_261.3))
} else if(exists("nls_261.2") & exists("nls_261.3")){
  print(anova(nls_261.2, nls_261.3))
} else if(exists("nls_261.1") & exists("nls_261.2")){
  print(anova(nls_261.1, nls_261.2))
}
 
## AIC comparison
AIC1_261 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_261.1"), AIC(get("nls_261.1")), NA),
            ifelse(exists("nls_261.2"), AIC(get("nls_261.2")), NA),
            ifelse(exists("nls_261.3"), AIC(get("nls_261.3")), NA)
            ))

print(AIC1_261) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_261[!is.na(AIC1_261$AIC) &AIC1_261$AIC == min(AIC1_261$AIC, na.rm = T),]$model

try(summary(get(paste("nls_261.",  Mod.Sel1, sep =""))) )   #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_261.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_261.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_261.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_261.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_261.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_261.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_261.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_261.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_261.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_261,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_261$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_261.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_261,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_261$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_261.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_261,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_261$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_261.", Mod.Sel1, sep ="")) &
     exists(paste("nls_261.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_261.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_261.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_261.", Mod.Sel1, sep ="")),
             get(paste("nls_261.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_261.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_261.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_261.", Mod.Sel1, sep ="")) &
         exists(paste("nls_261.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_261.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_261.", Mod.Sel1, sep ="")),
               get(paste("nls_261.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_261.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_261.", Mod.Sel1, sep ="")) &
           exists(paste("nls_261.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_261.", Mod.Sel1, sep ="")),
                 get(paste("nls_261.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_261.", Mod.Sel1, sep ="")) &
              exists(paste("nls_261.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_261.", Mod.Sel1, sep ="")),
                    get(paste("nls_261.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_261.", Mod.Sel1, sep ="")) &
                exists(paste("nls_261.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_261.", Mod.Sel1, sep ="")),
                      get(paste("nls_261.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_261 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_261.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_261.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_261.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_261.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_261.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_261.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_261.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_261.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_261)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_261[!is.na(AIC2_261$AIC) & AIC2_261$AIC == min(AIC2_261$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "261",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_261.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_261.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "261",]$ge.variance <- vcov(get(paste("nls_261.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "261",]$phi.variance <- vcov(get(paste("nls_261.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "261",]$alpha.variance <- vcov(get(paste("nls_261.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "261",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "261",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "261",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "261",]$A <- coefs["A"]
nls.param.df_nh[nls.param.df_nh$Code == "261",]$k <- coefs["k"]

nls.param.df_nh[nls.param.df_nh$Code == "261",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "261",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "261",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "261",]$A.2.5 <- intervals_low["A"]
nls.param.df_nh[nls.param.df_nh$Code == "261",]$k.2.5 <- intervals_low["k"]

nls.param.df_nh[nls.param.df_nh$Code == "261",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "261",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "261",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "261",]$A.97.5 <- intervals_high["A"]
nls.param.df_nh[nls.param.df_nh$Code == "261",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_261.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_261.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_261.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_261.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

* unable to fit model (only 64 observations)

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_261$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_261.4 <- nls(f_4, data = G_261, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_261$nls_weights.2), 
 )

## phi
try(
  nls_261.5 <- nls(f_5, data=G_261, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_261$nls_weights.2), 
 )

# phi/alpha
try(
  nls_261.6 <- nls(f_6, data = G_261, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_261$nls_weights.2), 
 )

## test
if(exists("nls_261.4") & exists("nls_261.5") & exists("nls_261.6")){
  print(anova(nls_261.4, nls_261.5, nls_261.6))
} else if(exists("nls_261.4") & exists("nls_261.6")){
  print(anova(nls_261.4, nls_261.6))
} else if(exists("nls_261.5") & exists("nls_261.6")){
  print(anova(nls_261.5, nls_261.6))
} else if(exists("nls_261.4") & exists("nls_261.5")){
  print(anova(nls_261.4, nls_261.5))
}

## AIC comparison
AIC3_261 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_261[AIC2_261$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_261.4"), AIC(get("nls_261.4")), NA),
            ifelse(exists("nls_261.5"), AIC(get("nls_261.5")), NA),
            ifelse(exists("nls_261.6"), AIC(get("nls_261.6")), NA)
            ))

print(AIC3_261) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_261[!is.na(AIC3_261$AIC) & AIC3_261$AIC == min(AIC3_261$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "261",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_nh[Best_mods.P_nh$Code == "261",]$Best.Mod <- Mod.Sel3


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "261",]$ge.variance <- vcov(get(paste("nls_261.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "261",]$phi.variance <- vcov(get(paste("nls_261.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "261",]$alpha.variance <- vcov(get(paste("nls_261.",  Mod.Sel3, sep ="")))["alpha","alpha"]


## write coefficients to table 
coefs <- coef(get(paste("nls_261.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_261.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df_nh[nls.param.df_nh$Code == "261",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "261",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "261",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "261",]$a <- coefs["a"]
nls.param.df_nh[nls.param.df_nh$Code == "261",]$b <- coefs["b"]
nls.param.df_nh[nls.param.df_nh$Code == "261",]$c <- coefs["c"]
nls.param.df_nh[nls.param.df_nh$Code == "261",]$d <- coefs["d"]

nls.param.df_nh[nls.param.df_nh$Code == "261",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "261",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "261",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "261",]$a.2.5 <- intervals_low["a"]
nls.param.df_nh[nls.param.df_nh$Code == "261",]$b.2.5 <- intervals_low["b"]
nls.param.df_nh[nls.param.df_nh$Code == "261",]$c.2.5 <- intervals_low["c"]
nls.param.df_nh[nls.param.df_nh$Code == "261",]$d.2.5 <- intervals_low["d"]

nls.param.df_nh[nls.param.df_nh$Code == "261",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "261",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "261",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "261",]$a.97.5 <- intervals_high["a"]
nls.param.df_nh[nls.param.df_nh$Code == "261",]$b.97.5 <- intervals_high["b"]
nls.param.df_nh[nls.param.df_nh$Code == "261",]$c.97.5 <- intervals_high["c"]
nls.param.df_nh[nls.param.df_nh$Code == "261",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_261.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_261.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_261.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_261.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_261 <- nlsResiduals(
  get(paste("nls_261.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_261)

## test residuals
if(length(G_261$pltID) < 5001) {test.nlsResiduals(resid_261)}

}  else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_261_pred <- predict(get(paste("nls_261.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_261$MEASTIME_t2, na.rm = T), max(G_261$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_261$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_261$MEASTIME_t2, na.rm = T), max(G_261$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_261$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_261$DeltaPDSI, na.rm = T), max(G_261$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_261$MEASTIME_t2, na.rm = T), max(G_261$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_261$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_261$B_L_prop, na.rm = T), max(G_261$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_261$DeltaPDSI, na.rm = T), max(G_261$STDAGE_t2)))
                      } )

G_261_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_261$STDAGE_t2),by = 1),  
                            "fitted"=G_261_pred)

## plot
gg.261 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_261, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_261, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length(bin_mids_261))), breaks = cutvec_261) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_261_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_261_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("261 - California Coastal Chaparral Forest and Shrub") + 
          
          #ylim(0, max(G_261_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_261*1.05)), expand = c(0,0))

gg.261

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_261 <- data.frame(
  bin = as.factor(levels(cut(G_261$STDAGE_t2, cutvec_261))),
  data.mean = tapply(G_261$B_plt_t2_MgHa, cut(G_261$STDAGE_t2, cutvec_261), 
                     mean), 
  data.CI.high =  tapply(G_261$B_plt_t2_MgHa, cut(G_261$STDAGE_t2, cutvec_261), 
                    high.CI), 
  data.CI.low = tapply(G_261$B_plt_t2_MgHa, cut(G_261$STDAGE_t2, cutvec_261),
                    low.CI), 
  pred.mean = G_261_pred_df[G_261_pred_df$STDAGE_t2 %in% bin_mids_261,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_261 <-  DM_compare_261 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_261$bin)[gtools::mixedorder(levels(DM_compare_261$bin))]))

## ggplot
gg.261.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_261) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_261))), 
                              labels = levels(DM_compare_261$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("261 - California Coastal Chaparral Forest and Shrub",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +         
           theme_classic() + 
           # xlim(min(DM_compare_261$data.CI.low)-0.25, max(DM_compare_261$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_261$pred.CI.low)-0.25, max(DM_compare_261$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.261.B2

}   else {print("cannot plot observed vs. predicted")}
```

## 262 - California Dry Steppe
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_262 <- round(quantile(G_262$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_262)))){
  cutvec_262 <- round(quantile(G_262$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_262 <- unname(round(cutvec_262[-length(cutvec_262)] + diff(cutvec_262)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_262$STDAGE_t2_bin<-  cut(G_262$STDAGE_t2, cutvec_262)
## then get bin means
G_262_bin_means <- tapply(G_262$B_plt_t2_MgHa, cut(G_262$STDAGE_t2,  cutvec_262), mean)

## make column weights.2
G_262$nls_weights.2 <- as.numeric(1/(G_262_bin_means[match(G_262$STDAGE_t2_bin, names(G_262_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_262.1 <- nls(f_1, data = G_262, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_262$nls_weights.2), 
 )

## phi
try(
  nls_262.2 <- nls(f_2, data=G_262, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_262$nls_weights.2), 
 )

# phi/alpha
try(
  nls_262.3 <- nls(f_3 , data = G_262, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_262$nls_weights.2), 
 )

## test
if(exists("nls_262.1") & exists("nls_262.2") & exists("nls_262.3")){
  print(anova(nls_262.1, nls_262.2, nls_262.3))
} else if(exists("nls_262.2") & exists("nls_262.3")){
  print(anova(nls_262.2, nls_262.3))
} else if(exists("nls_262.1") & exists("nls_262.2")){
  print(anova(nls_262.1, nls_262.2))
}
 
## AIC comparison
AIC1_262 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_262.1"), AIC(get("nls_262.1")), NA),
            ifelse(exists("nls_262.2"), AIC(get("nls_262.2")), NA),
            ifelse(exists("nls_262.3"), AIC(get("nls_262.3")), NA)
            ))

print(AIC1_262) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_262[!is.na(AIC1_262$AIC) & AIC1_262$AIC == min(AIC1_262$AIC, na.rm = T),]$model

try(summary(get(paste("nls_262.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_262.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_262.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_262.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_262.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_262.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_262.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_262.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_262.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_262.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_262,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_262$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_262.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_262,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_262$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_262.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_262,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_262$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_262.", Mod.Sel1, sep ="")) &
     exists(paste("nls_262.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_262.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_262.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_262.", Mod.Sel1, sep ="")),
             get(paste("nls_262.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_262.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_262.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_262.", Mod.Sel1, sep ="")) &
         exists(paste("nls_262.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_262.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_262.", Mod.Sel1, sep ="")),
               get(paste("nls_262.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_262.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_262.", Mod.Sel1, sep ="")) &
           exists(paste("nls_262.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_262.", Mod.Sel1, sep ="")),
                 get(paste("nls_262.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_262.", Mod.Sel1, sep ="")) &
              exists(paste("nls_262.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_262.", Mod.Sel1, sep ="")),
                    get(paste("nls_262.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_262.", Mod.Sel1, sep ="")) &
                exists(paste("nls_262.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_262.", Mod.Sel1, sep ="")),
                      get(paste("nls_262.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_262 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_262.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_262.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_262.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_262.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_262.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_262.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_262.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_262.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_262)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_262[!is.na(AIC2_262$AIC) & AIC2_262$AIC == min(AIC2_262$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "262",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_262.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_262.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "262",]$ge.variance <- vcov(get(paste("nls_262.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "262",]$phi.variance <- vcov(get(paste("nls_262.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "262",]$alpha.variance <- vcov(get(paste("nls_262.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "262",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "262",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "262",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "262",]$A <- coefs["A"]
nls.param.df_nh[nls.param.df_nh$Code == "262",]$k <- coefs["k"]

nls.param.df_nh[nls.param.df_nh$Code == "262",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "262",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "262",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "262",]$A.2.5 <- intervals_low["A"]
nls.param.df_nh[nls.param.df_nh$Code == "262",]$k.2.5 <- intervals_low["k"]

nls.param.df_nh[nls.param.df_nh$Code == "262",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "262",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "262",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "262",]$A.97.5 <- intervals_high["A"]
nls.param.df_nh[nls.param.df_nh$Code == "262",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_262.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_262.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_262.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_262.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

* unable to fit model (0 observations)

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_262$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_262.4 <- nls(f_4, data = G_262, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_262$nls_weights.2), 
 )

## phi
try(
  nls_262.5 <- nls(f_5, data=G_262, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_262$nls_weights.2), 
 )

# phi/alpha
try(
  nls_262.6 <- nls(f_6, data = G_262, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_262$nls_weights.2), 
 )

## test
if(exists("nls_262.4") & exists("nls_262.5") & exists("nls_262.6")){
  print(anova(nls_262.4, nls_262.5, nls_262.6))
} else if(exists("nls_262.4") & exists("nls_262.6")){
  print(anova(nls_262.4, nls_262.6))
} else if(exists("nls_262.5") & exists("nls_262.6")){
  print(anova(nls_262.5, nls_262.6))
} else if(exists("nls_262.4") & exists("nls_262.5")){
  print(anova(nls_262.4, nls_262.5))
}

## AIC comparison
AIC3_262 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_262[AIC2_262$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_262.4"), AIC(get("nls_262.4")), NA),
            ifelse(exists("nls_262.5"), AIC(get("nls_262.5")), NA),
            ifelse(exists("nls_262.6"), AIC(get("nls_262.6")), NA)
            ))

print(AIC3_262) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_262[!is.na(AIC3_262$AIC) & AIC3_262$AIC == min(AIC3_262$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "262",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_nh[Best_mods.P_nh$Code == "262",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_262.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_262.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "262",]$ge.variance <- vcov(get(paste("nls_262.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "262",]$phi.variance <- vcov(get(paste("nls_262.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "262",]$alpha.variance <- vcov(get(paste("nls_262.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "262",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "262",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "262",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "262",]$a <- coefs["a"]
nls.param.df_nh[nls.param.df_nh$Code == "262",]$b <- coefs["b"]
nls.param.df_nh[nls.param.df_nh$Code == "262",]$c <- coefs["c"]
nls.param.df_nh[nls.param.df_nh$Code == "262",]$d <- coefs["d"]

nls.param.df_nh[nls.param.df_nh$Code == "262",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "262",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "262",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "262",]$a.2.5 <- intervals_low["a"]
nls.param.df_nh[nls.param.df_nh$Code == "262",]$b.2.5 <- intervals_low["b"]
nls.param.df_nh[nls.param.df_nh$Code == "262",]$c.2.5 <- intervals_low["c"]
nls.param.df_nh[nls.param.df_nh$Code == "262",]$d.2.5 <- intervals_low["d"]

nls.param.df_nh[nls.param.df_nh$Code == "262",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "262",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "262",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "262",]$a.97.5 <- intervals_high["a"]
nls.param.df_nh[nls.param.df_nh$Code == "262",]$b.97.5 <- intervals_high["b"]
nls.param.df_nh[nls.param.df_nh$Code == "262",]$c.97.5 <- intervals_high["c"]
nls.param.df_nh[nls.param.df_nh$Code == "262",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_262.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_262.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_262.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_262.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_262 <- nlsResiduals(
  get(paste("nls_262.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_262)

## test residuals
if(length(G_262$pltID) < 5001) {test.nlsResiduals(resid_262)}

}  else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_262_pred <- predict(get(paste("nls_262.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_262$MEASTIME_t2, na.rm = T), max(G_262$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_262$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_262$MEASTIME_t2, na.rm = T), max(G_262$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_262$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_262$DeltaPDSI, na.rm = T), max(G_262$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_262$MEASTIME_t2, na.rm = T), max(G_262$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_262$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_262$B_L_prop, na.rm = T), max(G_262$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_262$DeltaPDSI, na.rm = T), max(G_262$STDAGE_t2)))
                      } )

G_262_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_262$STDAGE_t2),by = 1),  
                            "fitted"=G_262_pred)

## plot
gg.262 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_262, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_262, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_262))), breaks = cutvec_262) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_262_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_262_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("262 - California Dry Steppe") + 
          
          #ylim(0, max(G_262_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_262,1)*1.05), expand = c(0,0))

gg.262

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_262 <- data.frame(
  bin = as.factor(levels(cut(G_262$STDAGE_t2, cutvec_262))),
  data.mean = tapply(G_262$B_plt_t2_MgHa, cut(G_262$STDAGE_t2, cutvec_262), 
                     mean), 
  data.CI.high =  tapply(G_262$B_plt_t2_MgHa, cut(G_262$STDAGE_t2, cutvec_262), 
                    high.CI), 
  data.CI.low = tapply(G_262$B_plt_t2_MgHa, cut(G_262$STDAGE_t2, cutvec_262),
                    low.CI), 
  pred.mean = G_262_pred_df[G_262_pred_df$STDAGE_t2 %in% bin_mids_262,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_262 <-  DM_compare_262 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_262$bin)[gtools::mixedorder(levels(DM_compare_262$bin))]))

## ggplot
gg.262.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_262) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_262))), 
                              labels = levels(DM_compare_262$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("262 - California Dry Steppe",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +        
           theme_classic() + 
           # xlim(min(DM_compare_262$data.CI.low)-0.25, max(DM_compare_262$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_262$pred.CI.low)-0.25, max(DM_compare_262$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.262.B2

}   else {print("cannot plot observed vs. predicted")}
```

## 263 - California Coastal Steppe - Mixed Forest and Redwood Forest
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_263 <- round(quantile(G_263$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_263)))){
  cutvec_263 <- round(quantile(G_263$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_263 <- unname(round(cutvec_263[-length(cutvec_263)] + diff(cutvec_263)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_263$STDAGE_t2_bin<-  cut(G_263$STDAGE_t2, cutvec_263)
## then get bin means
G_263_bin_means <- tapply(G_263$B_plt_t2_MgHa, cut(G_263$STDAGE_t2,  cutvec_263), mean)

## make column weights.2
G_263$nls_weights.2 <- as.numeric(1/(G_263_bin_means[match(G_263$STDAGE_t2_bin, names(G_263_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_263.1 <- nls(f_1, data = G_263, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_263$nls_weights.2), 
 )

## phi
try(
  nls_263.2 <- nls(f_2, data=G_263, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_263$nls_weights.2), 
 )

# phi/alpha
try(
  nls_263.3 <- nls(f_3 , data = G_263, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_263$nls_weights.2), 
 )

## test
if(exists("nls_263.1") & exists("nls_263.2") & exists("nls_263.3")){
  print(anova(nls_263.1, nls_263.2, nls_263.3))
} else if(exists("nls_263.2") & exists("nls_263.3")){
  print(anova(nls_263.2, nls_263.3))
} else if(exists("nls_263.1") & exists("nls_263.2")){
  print(anova(nls_263.1, nls_263.2))
}
 
## AIC comparison
AIC1_263 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_263.1"), AIC(get("nls_263.1")), NA),
            ifelse(exists("nls_263.2"), AIC(get("nls_263.2")), NA),
            ifelse(exists("nls_263.3"), AIC(get("nls_263.3")), NA)
            ))

print(AIC1_263) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_263[!is.na(AIC1_263$AIC) & AIC1_263$AIC == min(AIC1_263$AIC, na.rm = T),]$model

try(summary(get(paste("nls_263.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_263.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_263.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_263.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_263.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_263.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_263.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_263.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_263.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_263.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_263,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_263$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_263.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_263,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_263$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_263.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_263,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_263$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_263.", Mod.Sel1, sep ="")) &
     exists(paste("nls_263.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_263.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_263.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_263.", Mod.Sel1, sep ="")),
             get(paste("nls_263.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_263.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_263.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_263.", Mod.Sel1, sep ="")) &
         exists(paste("nls_263.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_263.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_263.", Mod.Sel1, sep ="")),
               get(paste("nls_263.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_263.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_263.", Mod.Sel1, sep ="")) &
           exists(paste("nls_263.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_263.", Mod.Sel1, sep ="")),
                 get(paste("nls_263.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_263.", Mod.Sel1, sep ="")) &
              exists(paste("nls_263.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_263.", Mod.Sel1, sep ="")),
                    get(paste("nls_263.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_263.", Mod.Sel1, sep ="")) &
                exists(paste("nls_263.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_263.", Mod.Sel1, sep ="")),
                      get(paste("nls_263.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_263 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_263.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_263.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_263.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_263.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_263.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_263.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_263.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_263.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_263)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_263[!is.na(AIC2_263$AIC) & AIC2_263$AIC == min(AIC2_263$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "263",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_263.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_263.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "263",]$ge.variance <- vcov(get(paste("nls_263.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "263",]$phi.variance <- vcov(get(paste("nls_263.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "263",]$alpha.variance <- vcov(get(paste("nls_263.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "263",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "263",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "263",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "263",]$A <- coefs["A"]
nls.param.df_nh[nls.param.df_nh$Code == "263",]$k <- coefs["k"]

nls.param.df_nh[nls.param.df_nh$Code == "263",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "263",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "263",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "263",]$A.2.5 <- intervals_low["A"]
nls.param.df_nh[nls.param.df_nh$Code == "263",]$k.2.5 <- intervals_low["k"]

nls.param.df_nh[nls.param.df_nh$Code == "263",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "263",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "263",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "263",]$A.97.5 <- intervals_high["A"]
nls.param.df_nh[nls.param.df_nh$Code == "263",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_263.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_263.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_263.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_263.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_263$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_263.4 <- nls(f_4, data = G_263, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_263$nls_weights.2), 
 )

## phi
try(
  nls_263.5 <- nls(f_5, data=G_263, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_263$nls_weights.2), 
 )

# phi/alpha
try(
  nls_263.6 <- nls(f_6, data = G_263, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_263$nls_weights.2), 
 )

## test
if(exists("nls_263.4") & exists("nls_263.5") & exists("nls_263.6")){
  print(anova(nls_263.4, nls_263.5, nls_263.6))
} else if(exists("nls_263.4") & exists("nls_263.6")){
  print(anova(nls_263.4, nls_263.6))
} else if(exists("nls_263.5") & exists("nls_263.6")){
  print(anova(nls_263.5, nls_263.6))
} else if(exists("nls_263.4") & exists("nls_263.5")){
  print(anova(nls_263.4, nls_263.5))
}

## AIC comparison
AIC3_263 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_263[AIC2_263$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_263.4"), AIC(get("nls_263.4")), NA),
            ifelse(exists("nls_263.5"), AIC(get("nls_263.5")), NA),
            ifelse(exists("nls_263.6"), AIC(get("nls_263.6")), NA)
            ))

print(AIC3_263) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_263[!is.na(AIC3_263$AIC) & AIC3_263$AIC == min(AIC3_263$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "263",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_nh[Best_mods.P_nh$Code == "263",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_263.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_263.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "263",]$ge.variance <- vcov(get(paste("nls_263.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "263",]$phi.variance <- vcov(get(paste("nls_263.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "263",]$alpha.variance <- vcov(get(paste("nls_263.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "263",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "263",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "263",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "263",]$a <- coefs["a"]
nls.param.df_nh[nls.param.df_nh$Code == "263",]$b <- coefs["b"]
nls.param.df_nh[nls.param.df_nh$Code == "263",]$c <- coefs["c"]
nls.param.df_nh[nls.param.df_nh$Code == "263",]$d <- coefs["d"]

nls.param.df_nh[nls.param.df_nh$Code == "263",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "263",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "263",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "263",]$a.2.5 <- intervals_low["a"]
nls.param.df_nh[nls.param.df_nh$Code == "263",]$b.2.5 <- intervals_low["b"]
nls.param.df_nh[nls.param.df_nh$Code == "263",]$c.2.5 <- intervals_low["c"]
nls.param.df_nh[nls.param.df_nh$Code == "263",]$d.2.5 <- intervals_low["d"]

nls.param.df_nh[nls.param.df_nh$Code == "263",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "263",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "263",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "263",]$a.97.5 <- intervals_high["a"]
nls.param.df_nh[nls.param.df_nh$Code == "263",]$b.97.5 <- intervals_high["b"]
nls.param.df_nh[nls.param.df_nh$Code == "263",]$c.97.5 <- intervals_high["c"]
nls.param.df_nh[nls.param.df_nh$Code == "263",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_263.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_263.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_263.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_263.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_263 <- nlsResiduals(
  get(paste("nls_263.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_263)

## test residuals
if(length(G_263$pltID) < 5001) {test.nlsResiduals(resid_263)}

}  else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_263_pred <- predict(get(paste("nls_263.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_263$MEASTIME_t2, na.rm = T), max(G_263$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_263$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_263$MEASTIME_t2, na.rm = T), max(G_263$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_263$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_263$DeltaPDSI, na.rm = T), max(G_263$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_263$MEASTIME_t2, na.rm = T), max(G_263$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_263$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_263$B_L_prop, na.rm = T), max(G_263$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_263$DeltaPDSI, na.rm = T), max(G_263$STDAGE_t2)))
                      } )

G_263_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_263$STDAGE_t2),by = 1),  
                            "fitted"=G_263_pred)

## plot
gg.263 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_263, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_263, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1, length.out = length(bin_mids_263))), breaks = cutvec_263) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_263_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_263_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("263 - California Coastal Steppe - Mixed Forest and Redwood Forest") + 
          
          #ylim(0, max(G_263_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_263,1)*1.05), expand = c(0,0))

gg.263

}  else {print("cannot plot data with prediction")}
```

### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_263 <- data.frame(
  bin = as.factor(levels(cut(G_263$STDAGE_t2, cutvec_263))),
  data.mean = tapply(G_263$B_plt_t2_MgHa, cut(G_263$STDAGE_t2, cutvec_263), 
                     mean), 
  data.CI.high =  tapply(G_263$B_plt_t2_MgHa, cut(G_263$STDAGE_t2, cutvec_263), 
                    high.CI), 
  data.CI.low = tapply(G_263$B_plt_t2_MgHa, cut(G_263$STDAGE_t2, cutvec_263),
                    low.CI), 
  pred.mean = G_263_pred_df[G_263_pred_df$STDAGE_t2 %in% bin_mids_263,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_263 <-  DM_compare_263 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_263$bin)[gtools::mixedorder(levels(DM_compare_263$bin))]))

## ggplot
gg.263.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_263) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_263))), 
                              labels = levels(DM_compare_263$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("263 - California Coastal Steppe - Mixed Forest and Redwood Forest",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +        
           theme_classic() + 
           # xlim(min(DM_compare_263$data.CI.low)-0.25, max(DM_compare_263$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_263$pred.CI.low)-0.25, max(DM_compare_263$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.263.B2

}   else {print("cannot plot observed vs. predicted")}
```

## 313 - Colorado Plateau Semi-Desert
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_313 <- round(quantile(G_313$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_313)))){
  cutvec_313 <- round(quantile(G_313$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_313 <- unname(round(cutvec_313[-length(cutvec_313)] + diff(cutvec_313)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_313$STDAGE_t2_bin<-  cut(G_313$STDAGE_t2, cutvec_313)
## then get bin means
G_313_bin_means <- tapply(G_313$B_plt_t2_MgHa, cut(G_313$STDAGE_t2,  cutvec_313), mean)

## make column weights.2
G_313$nls_weights.2 <- as.numeric(1/(G_313_bin_means[match(G_313$STDAGE_t2_bin, names(G_313_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_313.1 <- nls(f_1, data = G_313, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_313$nls_weights.2), 
 )

## phi
try(
  nls_313.2 <- nls(f_2, data=G_313, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_313$nls_weights.2), 
 )

# phi/alpha
try(
  nls_313.3 <- nls(f_3 , data = G_313, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_313$nls_weights.2), 
 )

## test
if(exists("nls_313.1") & exists("nls_313.2") & exists("nls_313.3")){
  print(anova(nls_313.1, nls_313.2, nls_313.3))
} else if(exists("nls_313.2") & exists("nls_313.3")){
  print(anova(nls_313.2, nls_313.3))
} else if(exists("nls_313.1") & exists("nls_313.2")){
  print(anova(nls_313.1, nls_313.2))
}
 
## AIC comparison
AIC1_313 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_313.1"), AIC(get("nls_313.1")), NA),
            ifelse(exists("nls_313.2"), AIC(get("nls_313.2")), NA),
            ifelse(exists("nls_313.3"), AIC(get("nls_313.3")), NA)
            ))

print(AIC1_313) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_313[!is.na(AIC1_313$AIC) & AIC1_313$AIC == min(AIC1_313$AIC, na.rm = T),]$model

try(summary(get(paste("nls_313.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_313.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_313.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_313.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_313.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_313.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_313.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_313.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_313.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_313.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_313,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_313$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_313.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_313,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_313$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_313.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_313,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_313$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_313.", Mod.Sel1, sep ="")) &
     exists(paste("nls_313.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_313.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_313.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_313.", Mod.Sel1, sep ="")),
             get(paste("nls_313.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_313.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_313.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_313.", Mod.Sel1, sep ="")) &
         exists(paste("nls_313.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_313.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_313.", Mod.Sel1, sep ="")),
               get(paste("nls_313.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_313.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_313.", Mod.Sel1, sep ="")) &
           exists(paste("nls_313.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_313.", Mod.Sel1, sep ="")),
                 get(paste("nls_313.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_313.", Mod.Sel1, sep ="")) &
              exists(paste("nls_313.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_313.", Mod.Sel1, sep ="")),
                    get(paste("nls_313.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_313.", Mod.Sel1, sep ="")) &
                exists(paste("nls_313.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_313.", Mod.Sel1, sep ="")),
                      get(paste("nls_313.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_313 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_313.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_313.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_313.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_313.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_313.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_313.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_313.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_313.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_313)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_313[!is.na(AIC2_313$AIC) & AIC2_313$AIC == min(AIC2_313$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "313",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_313.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_313.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "313",]$ge.variance <- vcov(get(paste("nls_313.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "313",]$phi.variance <- vcov(get(paste("nls_313.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "313",]$alpha.variance <- vcov(get(paste("nls_313.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "313",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "313",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "313",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "313",]$A <- coefs["A"]
nls.param.df_nh[nls.param.df_nh$Code == "313",]$k <- coefs["k"]

nls.param.df_nh[nls.param.df_nh$Code == "313",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "313",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "313",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "313",]$A.2.5 <- intervals_low["A"]
nls.param.df_nh[nls.param.df_nh$Code == "313",]$k.2.5 <- intervals_low["k"]

nls.param.df_nh[nls.param.df_nh$Code == "313",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "313",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "313",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "313",]$A.97.5 <- intervals_high["A"]
nls.param.df_nh[nls.param.df_nh$Code == "313",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_313.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_313.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_313.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_313.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_313$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_313.4 <- nls(f_4, data = G_313, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_313$nls_weights.2), 
 )

## phi
try(
  nls_313.5 <- nls(f_5, data=G_313, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_313$nls_weights.2), 
 )

# phi/alpha
try(
  nls_313.6 <- nls(f_6, data = G_313, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_313$nls_weights.2), 
 )

## test
if(exists("nls_313.4") & exists("nls_313.5") & exists("nls_313.6")){
  print(anova(nls_313.4, nls_313.5, nls_313.6))
} else if(exists("nls_313.4") & exists("nls_313.6")){
  print(anova(nls_313.4, nls_313.6))
} else if(exists("nls_313.5") & exists("nls_313.6")){
  print(anova(nls_313.5, nls_313.6))
} else if(exists("nls_313.4") & exists("nls_313.5")){
  print(anova(nls_313.4, nls_313.5))
}

## AIC comparison
AIC3_313 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_313[AIC2_313$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_313.4"), AIC(get("nls_313.4")), NA),
            ifelse(exists("nls_313.5"), AIC(get("nls_313.5")), NA),
            ifelse(exists("nls_313.6"), AIC(get("nls_313.6")), NA)
            ))

print(AIC3_313) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_313[!is.na(AIC3_313$AIC) & AIC3_313$AIC == min(AIC3_313$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "313",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_nh[Best_mods.P_nh$Code == "313",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_313.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_313.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "313",]$ge.variance <- vcov(get(paste("nls_313.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "313",]$phi.variance <- vcov(get(paste("nls_313.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "313",]$alpha.variance <- vcov(get(paste("nls_313.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "313",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "313",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "313",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "313",]$a <- coefs["a"]
nls.param.df_nh[nls.param.df_nh$Code == "313",]$b <- coefs["b"]
nls.param.df_nh[nls.param.df_nh$Code == "313",]$c <- coefs["c"]
nls.param.df_nh[nls.param.df_nh$Code == "313",]$d <- coefs["d"]

nls.param.df_nh[nls.param.df_nh$Code == "313",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "313",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "313",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "313",]$a.2.5 <- intervals_low["a"]
nls.param.df_nh[nls.param.df_nh$Code == "313",]$b.2.5 <- intervals_low["b"]
nls.param.df_nh[nls.param.df_nh$Code == "313",]$c.2.5 <- intervals_low["c"]
nls.param.df_nh[nls.param.df_nh$Code == "313",]$d.2.5 <- intervals_low["d"]

nls.param.df_nh[nls.param.df_nh$Code == "313",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "313",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "313",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "313",]$a.97.5 <- intervals_high["a"]
nls.param.df_nh[nls.param.df_nh$Code == "313",]$b.97.5 <- intervals_high["b"]
nls.param.df_nh[nls.param.df_nh$Code == "313",]$c.97.5 <- intervals_high["c"]
nls.param.df_nh[nls.param.df_nh$Code == "313",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_313.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_313.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_313.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_313.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_313 <- nlsResiduals(
  get(paste("nls_313.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_313)

## test residuals
if(length(G_313$pltID) < 5001) {test.nlsResiduals(resid_313)}

}  else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## predict model fit 
G_313_pred <- predict(get(paste("nls_313.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_313$MEASTIME_t2, na.rm = T), max(G_313$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_313$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_313$MEASTIME_t2, na.rm = T), max(G_313$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_313$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_313$DeltaPDSI, na.rm = T), max(G_313$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_313$MEASTIME_t2, na.rm = T), max(G_313$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_313$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_313$B_L_prop, na.rm = T), max(G_313$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_313$DeltaPDSI, na.rm = T), max(G_313$STDAGE_t2)))
                      } )

G_313_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_313$STDAGE_t2),by = 1),  
                            "fitted"=G_313_pred)

## plot
gg.313 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_313, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_313, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_313))), breaks = cutvec_313) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_313_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_313_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("313 - Colorado Plateau Semi-Desert") + 
          
          #ylim(0, max(G_313_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_313,1)*1.05), expand = c(0,0))


gg.313

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_313 <- data.frame(
  bin = as.factor(levels(cut(G_313$STDAGE_t2, cutvec_313))),
  data.mean = tapply(G_313$B_plt_t2_MgHa, cut(G_313$STDAGE_t2, cutvec_313), 
                     mean), 
  data.CI.high =  tapply(G_313$B_plt_t2_MgHa, cut(G_313$STDAGE_t2, cutvec_313), 
                    high.CI), 
  data.CI.low = tapply(G_313$B_plt_t2_MgHa, cut(G_313$STDAGE_t2, cutvec_313),
                    low.CI), 
  pred.mean = G_313_pred_df[G_313_pred_df$STDAGE_t2 %in% bin_mids_313,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_313 <-  DM_compare_313 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_313$bin)[gtools::mixedorder(levels(DM_compare_313$bin))]))

## ggplot
gg.313.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_313) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_313))), 
                              labels = levels(DM_compare_313$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("313 -  Colorado Plateau Semi-Desert",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +         
           theme_classic() + 
           # xlim(min(DM_compare_313$data.CI.low)-0.25, max(DM_compare_313$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_313$pred.CI.low)-0.25, max(DM_compare_313$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.313.B2

}   else {print("cannot plot observed vs. predicted")}
```

## 315 - Southwest Plateau and Plains Dry Steppe and Shrub
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_315 <- round(quantile(G_315$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_315)))){
  cutvec_315 <- round(quantile(G_315$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_315 <- unname(round(cutvec_315[-length(cutvec_315)] + diff(cutvec_315)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_315$STDAGE_t2_bin<-  cut(G_315$STDAGE_t2, cutvec_315)
## then get bin means
G_315_bin_means <- tapply(G_315$B_plt_t2_MgHa, cut(G_315$STDAGE_t2, cutvec_315), mean)

## make column weights.2
G_315$nls_weights.2 <- as.numeric(1/(G_315_bin_means[match(G_315$STDAGE_t2_bin, names(G_315_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_315.1 <- nls(f_1, data = G_315, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_315$nls_weights.2), 
 )

## phi
try(
  nls_315.2 <- nls(f_2, data=G_315, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_315$nls_weights.2), 
 )

# phi/alpha
try(
  nls_315.3 <- nls(f_3 , data = G_315, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_315$nls_weights.2), 
 )

## test
if(exists("nls_315.1") & exists("nls_315.2") & exists("nls_315.3")){
  print(anova(nls_315.1, nls_315.2, nls_315.3))
} else if(exists("nls_315.2") & exists("nls_315.3")){
  print(anova(nls_315.2, nls_315.3))
} else if(exists("nls_315.1") & exists("nls_315.2")){
  print(anova(nls_315.1, nls_315.2))
}
 
## AIC comparison
AIC1_315 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_315.1"), AIC(get("nls_315.1")), NA),
            ifelse(exists("nls_315.2"), AIC(get("nls_315.2")), NA),
            ifelse(exists("nls_315.3"), AIC(get("nls_315.3")), NA)
            ))

print(AIC1_315) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_315[!is.na(AIC1_315$AIC) & AIC1_315$AIC == min(AIC1_315$AIC, na.rm = T),]$model

try(summary(get(paste("nls_315.",  Mod.Sel1, sep =""))) ) #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_315.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_315.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_315.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_315.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_315.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_315.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_315.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_315.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_315.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_315,
         start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_315$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_315.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_315,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_315$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_315.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_315,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_315$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_315.", Mod.Sel1, sep ="")) &
     exists(paste("nls_315.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_315.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_315.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_315.", Mod.Sel1, sep ="")),
             get(paste("nls_315.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_315.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_315.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_315.", Mod.Sel1, sep ="")) &
         exists(paste("nls_315.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_315.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_315.", Mod.Sel1, sep ="")),
               get(paste("nls_315.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_315.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_315.", Mod.Sel1, sep ="")) &
           exists(paste("nls_315.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_315.", Mod.Sel1, sep ="")),
                 get(paste("nls_315.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_315.", Mod.Sel1, sep ="")) &
              exists(paste("nls_315.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_315.", Mod.Sel1, sep ="")),
                    get(paste("nls_315.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_315.", Mod.Sel1, sep ="")) &
                exists(paste("nls_315.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_315.", Mod.Sel1, sep ="")),
                      get(paste("nls_315.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_315 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_315.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_315.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_315.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_315.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_315.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_315.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_315.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_315.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_315)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_315[!is.na(AIC2_315$AIC) & AIC2_315$AIC == min(AIC2_315$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "315",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_315.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_315.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "315",]$ge.variance <- vcov(get(paste("nls_315.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "315",]$phi.variance <- vcov(get(paste("nls_315.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "315",]$alpha.variance <- vcov(get(paste("nls_315.",  Mod.Sel2, sep ="")))["alpha","alpha"]

nls.param.df_nh[nls.param.df_nh$Code == "315",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "315",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "315",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "315",]$A <- coefs["A"]
nls.param.df_nh[nls.param.df_nh$Code == "315",]$k <- coefs["k"]

nls.param.df_nh[nls.param.df_nh$Code == "315",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "315",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "315",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "315",]$A.2.5 <- intervals_low["A"]
nls.param.df_nh[nls.param.df_nh$Code == "315",]$k.2.5 <- intervals_low["k"]

nls.param.df_nh[nls.param.df_nh$Code == "315",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "315",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "315",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "315",]$A.97.5 <- intervals_high["A"]
nls.param.df_nh[nls.param.df_nh$Code == "315",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_315.",  Mod.Sel2, sep =""))) ) 

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_315.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_315.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_315.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_315$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_315.4 <- nls(f_4, data = G_315, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_315$nls_weights.2), 
 )

## phi
try(
  nls_315.5 <- nls(f_5, data=G_315, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_315$nls_weights.2), 
 )

# phi/alpha
try(
  nls_315.6 <- nls(f_6, data = G_315, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_315$nls_weights.2), 
 )

## test
if(exists("nls_315.4") & exists("nls_315.5") & exists("nls_315.6")){
  print(anova(nls_315.4, nls_315.5, nls_315.6))
} else if(exists("nls_315.4") & exists("nls_315.6")){
  print(anova(nls_315.4, nls_315.6))
} else if(exists("nls_315.5") & exists("nls_315.6")){
  print(anova(nls_315.5, nls_315.6))
} else if(exists("nls_315.4") & exists("nls_315.5")){
  print(anova(nls_315.4, nls_315.5))
}

## AIC comparison
AIC3_315 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_315[AIC2_315$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_315.4"), AIC(get("nls_315.4")), NA),
            ifelse(exists("nls_315.5"), AIC(get("nls_315.5")), NA),
            ifelse(exists("nls_315.6"), AIC(get("nls_315.6")), NA)
            ))

print(AIC3_315) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_315[!is.na(AIC3_315$AIC) & AIC3_315$AIC == min(AIC3_315$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "315",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_nh[Best_mods.P_nh$Code == "315",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_315.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_315.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "315",]$ge.variance <- vcov(get(paste("nls_315.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "315",]$phi.variance <- vcov(get(paste("nls_315.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "315",]$alpha.variance <- vcov(get(paste("nls_315.",  Mod.Sel3, sep ="")))["alpha","alpha"]

nls.param.df_nh[nls.param.df_nh$Code == "315",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "315",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "315",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "315",]$a <- coefs["a"]
nls.param.df_nh[nls.param.df_nh$Code == "315",]$b <- coefs["b"]
nls.param.df_nh[nls.param.df_nh$Code == "315",]$c <- coefs["c"]
nls.param.df_nh[nls.param.df_nh$Code == "315",]$d <- coefs["d"]

nls.param.df_nh[nls.param.df_nh$Code == "315",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "315",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "315",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "315",]$a.2.5 <- intervals_low["a"]
nls.param.df_nh[nls.param.df_nh$Code == "315",]$b.2.5 <- intervals_low["b"]
nls.param.df_nh[nls.param.df_nh$Code == "315",]$c.2.5 <- intervals_low["c"]
nls.param.df_nh[nls.param.df_nh$Code == "315",]$d.2.5 <- intervals_low["d"]

nls.param.df_nh[nls.param.df_nh$Code == "315",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "315",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "315",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "315",]$a.97.5 <- intervals_high["a"]
nls.param.df_nh[nls.param.df_nh$Code == "315",]$b.97.5 <- intervals_high["b"]
nls.param.df_nh[nls.param.df_nh$Code == "315",]$c.97.5 <- intervals_high["c"]
nls.param.df_nh[nls.param.df_nh$Code == "315",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_315.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_315.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_315.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_315.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_315 <- nlsResiduals(
  get(paste("nls_315.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_315)

## test residuals
if(length(G_315$pltID) < 5001) {test.nlsResiduals(resid_315)}

}  else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_315_pred <- predict(get(paste("nls_315.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_315$MEASTIME_t2, na.rm = T), max(G_315$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_315$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_315$MEASTIME_t2, na.rm = T), max(G_315$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_315$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_315$DeltaPDSI, na.rm = T), max(G_315$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_315$MEASTIME_t2, na.rm = T), max(G_315$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_315$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_315$B_L_prop, na.rm = T), max(G_315$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_315$DeltaPDSI, na.rm = T), max(G_315$STDAGE_t2)))
                      } )

G_315_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_315$STDAGE_t2),by = 1),  
                            "fitted"=G_315_pred)

## plot
gg.315 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_315, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_315, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_315))), breaks = cutvec_315) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_315_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_315_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("315 -  Southwest Plateau and Plains Dry Steppe and Shrub") + 
          
          #ylim(0, max(G_315_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_315,1)*1.05), expand = c(0,0))

gg.315

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_315 <- data.frame(
  bin = as.factor(levels(cut(G_315$STDAGE_t2, cutvec_315))),
  data.mean = tapply(G_315$B_plt_t2_MgHa, cut(G_315$STDAGE_t2, cutvec_315), 
                     mean), 
  data.CI.high =  tapply(G_315$B_plt_t2_MgHa, cut(G_315$STDAGE_t2, cutvec_315), 
                    high.CI), 
  data.CI.low = tapply(G_315$B_plt_t2_MgHa, cut(G_315$STDAGE_t2, cutvec_315),
                    low.CI), 
  pred.mean = G_315_pred_df[G_315_pred_df$STDAGE_t2 %in% bin_mids_315,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_315 <-  DM_compare_315 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_315$bin)[gtools::mixedorder(levels(DM_compare_315$bin))]))

## ggplot
gg.315.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_315) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_315))), 
                              labels = levels(DM_compare_315$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("315 -  Southwest Plateau and Plains Dry Steppe and Shrub",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +       
           theme_classic() + 
           # xlim(min(DM_compare_315$data.CI.low)-0.25, max(DM_compare_315$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_315$pred.CI.low)-0.25, max(DM_compare_315$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.315.B2

}   else {print("cannot plot observed vs. predicted")}
```

## 321 - Chihuahuan Semi-Desert
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_321 <- round(quantile(G_321$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_321)))){
  cutvec_321 <- round(quantile(G_321$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_321 <- unname(round(cutvec_321[-length(cutvec_321)] + diff(cutvec_321)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_321$STDAGE_t2_bin<-  cut(G_321$STDAGE_t2, cutvec_321)
## then get bin means
G_321_bin_means <- tapply(G_321$B_plt_t2_MgHa, cut(G_321$STDAGE_t2, cutvec_321), mean)

## make column weights.2
G_321$nls_weights.2 <- as.numeric(1/(G_321_bin_means[match(G_321$STDAGE_t2_bin, names(G_321_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_321.1 <- nls(f_1, data = G_321, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_321$nls_weights.2), 
 )

## phi
try(
  nls_321.2 <- nls(f_2, data=G_321, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_321$nls_weights.2), 
 )

# phi/alpha
try(
  nls_321.3 <- nls(f_3 , data = G_321, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_321$nls_weights.2), 
 )

## test
if(exists("nls_321.1") & exists("nls_321.2") & exists("nls_321.3")){
  print(anova(nls_321.1, nls_321.2, nls_321.3))
} else if(exists("nls_321.2") & exists("nls_321.3")){
  print(anova(nls_321.2, nls_321.3))
} else if(exists("nls_321.1") & exists("nls_321.2")){
  print(anova(nls_321.1, nls_321.2))
}
 
## AIC comparison
AIC1_321 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_321.1"), AIC(get("nls_321.1")), NA),
            ifelse(exists("nls_321.2"), AIC(get("nls_321.2")), NA),
            ifelse(exists("nls_321.3"), AIC(get("nls_321.3")), NA)
            ))

print(AIC1_321) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_321[!is.na(AIC1_321$AIC) & AIC1_321$AIC == min(AIC1_321$AIC, na.rm = T),]$model

try(summary(get(paste("nls_321.",  Mod.Sel1, sep =""))) ) #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_321.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_321.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_321.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_321.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_321.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_321.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_321.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_321.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_321.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_321,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_321$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_321.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_321,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_321$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_321.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_321,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_321$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_321.", Mod.Sel1, sep ="")) &
     exists(paste("nls_321.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_321.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_321.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_321.", Mod.Sel1, sep ="")),
             get(paste("nls_321.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_321.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_321.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_321.", Mod.Sel1, sep ="")) &
         exists(paste("nls_321.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_321.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_321.", Mod.Sel1, sep ="")),
               get(paste("nls_321.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_321.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_321.", Mod.Sel1, sep ="")) &
           exists(paste("nls_321.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_321.", Mod.Sel1, sep ="")),
                 get(paste("nls_321.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_321.", Mod.Sel1, sep ="")) &
              exists(paste("nls_321.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_321.", Mod.Sel1, sep ="")),
                    get(paste("nls_321.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_321.", Mod.Sel1, sep ="")) &
                exists(paste("nls_321.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_321.", Mod.Sel1, sep ="")),
                      get(paste("nls_321.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_321 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_321.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_321.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_321.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_321.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_321.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_321.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_321.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_321.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_321)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_321[!is.na(AIC2_321$AIC) & AIC2_321$AIC == min(AIC2_321$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "321",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_321.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_321.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "315",]$ge.variance <- vcov(get(paste("nls_315.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "315",]$phi.variance <- vcov(get(paste("nls_315.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "315",]$alpha.variance <- vcov(get(paste("nls_315.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "321",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "321",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "321",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "321",]$A <- coefs["A"]
nls.param.df_nh[nls.param.df_nh$Code == "321",]$k <- coefs["k"]

nls.param.df_nh[nls.param.df_nh$Code == "321",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "321",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "321",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "321",]$A.2.5 <- intervals_low["A"]
nls.param.df_nh[nls.param.df_nh$Code == "321",]$k.2.5 <- intervals_low["k"]

nls.param.df_nh[nls.param.df_nh$Code == "321",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "321",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "321",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "321",]$A.97.5 <- intervals_high["A"]
nls.param.df_nh[nls.param.df_nh$Code == "321",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_321.",  Mod.Sel2, sep =""))) ) 

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_321.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_321.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_321.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_321$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_321.4 <- nls(f_4, data = G_321, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_321$nls_weights.2), 
 )

## phi
try(
  nls_321.5 <- nls(f_5, data=G_321, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_321$nls_weights.2), 
 )

# phi/alpha
try(
  nls_321.6 <- nls(f_6, data = G_321, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_321$nls_weights.2), 
 )

## test
if(exists("nls_321.4") & exists("nls_321.5") & exists("nls_321.6")){
  print(anova(nls_321.4, nls_321.5, nls_321.6))
} else if(exists("nls_321.4") & exists("nls_321.6")){
  print(anova(nls_321.4, nls_321.6))
} else if(exists("nls_321.5") & exists("nls_321.6")){
  print(anova(nls_321.5, nls_321.6))
} else if(exists("nls_321.4") & exists("nls_321.5")){
  print(anova(nls_321.4, nls_321.5))
}

## AIC comparison
AIC3_321 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_321[AIC2_321$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_321.4"), AIC(get("nls_321.4")), NA),
            ifelse(exists("nls_321.5"), AIC(get("nls_321.5")), NA),
            ifelse(exists("nls_321.6"), AIC(get("nls_321.6")), NA)
            ))

print(AIC3_321) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_321[!is.na(AIC3_321$AIC) & AIC3_321$AIC == min(AIC3_321$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "321",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_nh[Best_mods.P_nh$Code == "321",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_321.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_321.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "321",]$ge.variance <- vcov(get(paste("nls_321.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "321",]$phi.variance <- vcov(get(paste("nls_321.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "321",]$alpha.variance <- vcov(get(paste("nls_321.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "321",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "321",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "321",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "321",]$a <- coefs["a"]
nls.param.df_nh[nls.param.df_nh$Code == "321",]$b <- coefs["b"]
nls.param.df_nh[nls.param.df_nh$Code == "321",]$c <- coefs["c"]
nls.param.df_nh[nls.param.df_nh$Code == "321",]$d <- coefs["d"]

nls.param.df_nh[nls.param.df_nh$Code == "321",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "321",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "321",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "321",]$a.2.5 <- intervals_low["a"]
nls.param.df_nh[nls.param.df_nh$Code == "321",]$b.2.5 <- intervals_low["b"]
nls.param.df_nh[nls.param.df_nh$Code == "321",]$c.2.5 <- intervals_low["c"]
nls.param.df_nh[nls.param.df_nh$Code == "321",]$d.2.5 <- intervals_low["d"]

nls.param.df_nh[nls.param.df_nh$Code == "321",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "321",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "321",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "321",]$a.97.5 <- intervals_high["a"]
nls.param.df_nh[nls.param.df_nh$Code == "321",]$b.97.5 <- intervals_high["b"]
nls.param.df_nh[nls.param.df_nh$Code == "321",]$c.97.5 <- intervals_high["c"]
nls.param.df_nh[nls.param.df_nh$Code == "321",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_321.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_321.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_321.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_321.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_321 <- nlsResiduals(
  get(paste("nls_321.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_321)

## test residuals
if(length(G_321$pltID) < 5001) {test.nlsResiduals(resid_321)}

}  else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_321_pred <- predict(get(paste("nls_321.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_321$MEASTIME_t2, na.rm = T), max(G_321$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_321$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_321$MEASTIME_t2, na.rm = T), max(G_321$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_321$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_321$DeltaPDSI, na.rm = T), max(G_321$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_321$MEASTIME_t2, na.rm = T), max(G_321$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_321$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_321$B_L_prop, na.rm = T), max(G_321$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_321$DeltaPDSI, na.rm = T), max(G_321$STDAGE_t2)))
                      } )

G_321_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_321$STDAGE_t2),by = 1),  
                            "fitted"=G_321_pred)

## plot
gg.321 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_321, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_321, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_321))), breaks = cutvec_321) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_321_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_321_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("321 - Chihuahuan Semi-Desert") + 
          
          #ylim(0, max(G_321_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_321,1)*1.05), expand = c(0,0))

gg.321

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_321 <- data.frame(
  bin = as.factor(levels(cut(G_321$STDAGE_t2, cutvec_321))),
  data.mean = tapply(G_321$B_plt_t2_MgHa, cut(G_321$STDAGE_t2, cutvec_321), 
                     mean), 
  data.CI.high =  tapply(G_321$B_plt_t2_MgHa, cut(G_321$STDAGE_t2, cutvec_321), 
                    high.CI), 
  data.CI.low = tapply(G_321$B_plt_t2_MgHa, cut(G_321$STDAGE_t2, cutvec_321),
                    low.CI), 
  pred.mean = G_321_pred_df[G_321_pred_df$STDAGE_t2 %in% bin_mids_321,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_321 <-  DM_compare_321 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_321$bin)[gtools::mixedorder(levels(DM_compare_321$bin))]))

## ggplot
gg.321.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_321) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_321))), 
                              labels = levels(DM_compare_321$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("321 - Chihuahuan Semi-Desert",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +         
           theme_classic() + 
           # xlim(min(DM_compare_321$data.CI.low)-0.25, max(DM_compare_321$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_321$pred.CI.low)-0.25, max(DM_compare_321$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.321.B2

}   else {print("cannot plot observed vs. predicted")}
```

## 322 - American Semidesert and Desert
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_322 <- round(quantile(G_322$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_322)))){
  cutvec_322 <- round(quantile(G_322$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_322 <- unname(round(cutvec_322[-length(cutvec_322)] + diff(cutvec_322)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_322$STDAGE_t2_bin<-  cut(G_322$STDAGE_t2, cutvec_322)
## then get bin means
G_322_bin_means <- tapply(G_322$B_plt_t2_MgHa, cut(G_322$STDAGE_t2, cutvec_322), mean)

## make column weights.2
G_322$nls_weights.2 <- as.numeric(1/(G_322_bin_means[match(G_322$STDAGE_t2_bin, names(G_322_bin_means))])^2)

}
```

### model selection 1

```{r}
# simple
try(
  nls_322.1 <- nls(f_1, data = G_322, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_322$nls_weights.2), 
 )

## phi
try(
  nls_322.2 <- nls(f_2, data=G_322, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_322$nls_weights.2), 
 )

# phi/alpha
try(
  nls_322.3 <- nls(f_3 , data = G_322, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_322$nls_weights.2), 
 )

## test
if(exists("nls_322.1") & exists("nls_322.2") & exists("nls_322.3")){
  print(anova(nls_322.1, nls_322.2, nls_322.3))
} else if(exists("nls_322.2") & exists("nls_322.3")){
  print(anova(nls_322.2, nls_322.3))
} else if(exists("nls_322.1") & exists("nls_322.2")){
  print(anova(nls_322.1, nls_322.2))
}
 
## AIC comparison
AIC1_322 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_322.1"), AIC(get("nls_322.1")), NA),
            ifelse(exists("nls_322.2"), AIC(get("nls_322.2")), NA),
            ifelse(exists("nls_322.3"), AIC(get("nls_322.3")), NA)
            ))

print(AIC1_322) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_322[!is.na(AIC1_322$AIC) & AIC1_322$AIC == min(AIC1_322$AIC, na.rm = T),]$model

try(summary(get(paste("nls_322.",  Mod.Sel1, sep =""))) ) #model summary
```
#### summary 
* simple model: `r ifelse(exists("nls_322.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_322.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_322.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_322.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_322.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_322.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_322.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_322.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_322.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_322,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_322$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_322.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_322,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_322$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_322.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_322,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_322$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_322.", Mod.Sel1, sep ="")) &
     exists(paste("nls_322.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_322.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_322.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_322.", Mod.Sel1, sep ="")),
             get(paste("nls_322.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_322.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_322.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_322.", Mod.Sel1, sep ="")) &
         exists(paste("nls_322.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_322.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_322.", Mod.Sel1, sep ="")),
               get(paste("nls_322.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_322.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_322.", Mod.Sel1, sep ="")) &
           exists(paste("nls_322.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_322.", Mod.Sel1, sep ="")),
                 get(paste("nls_322.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_322.", Mod.Sel1, sep ="")) &
              exists(paste("nls_322.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_322.", Mod.Sel1, sep ="")),
                    get(paste("nls_322.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_322.", Mod.Sel1, sep ="")) &
                exists(paste("nls_322.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_322.", Mod.Sel1, sep ="")),
                      get(paste("nls_322.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_322 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_322.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_322.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_322.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_322.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_322.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_322.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_322.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_322.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_322)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_322[!is.na(AIC2_322$AIC) & AIC2_322$AIC == min(AIC2_322$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "322",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_322.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_322.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "322",]$ge.variance <- vcov(get(paste("nls_322.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "322",]$phi.variance <- vcov(get(paste("nls_322.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "322",]$alpha.variance <- vcov(get(paste("nls_322.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "322",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "322",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "322",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "322",]$A <- coefs["A"]
nls.param.df_nh[nls.param.df_nh$Code == "322",]$k <- coefs["k"]

nls.param.df_nh[nls.param.df_nh$Code == "322",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "322",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "322",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "322",]$A.2.5 <- intervals_low["A"]
nls.param.df_nh[nls.param.df_nh$Code == "322",]$k.2.5 <- intervals_low["k"]

nls.param.df_nh[nls.param.df_nh$Code == "322",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "322",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "322",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "322",]$A.97.5 <- intervals_high["A"]
nls.param.df_nh[nls.param.df_nh$Code == "322",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_322.",  Mod.Sel2, sep =""))) ) 

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_322.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_322.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_322.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_322$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_322.4 <- nls(f_4, data = G_322, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_322$nls_weights.2), 
 )

## phi
try(
  nls_322.5 <- nls(f_5, data=G_322, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_322$nls_weights.2), 
 )

# phi/alpha
try(
  nls_322.6 <- nls(f_6, data = G_322, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_322$nls_weights.2), 
 )

## test
if(exists("nls_322.4") & exists("nls_322.5") & exists("nls_322.6")){
  print(anova(nls_322.4, nls_322.5, nls_322.6))
} else if(exists("nls_322.4") & exists("nls_322.6")){
  print(anova(nls_322.4, nls_322.6))
} else if(exists("nls_322.5") & exists("nls_322.6")){
  print(anova(nls_322.5, nls_322.6))
} else if(exists("nls_322.4") & exists("nls_322.5")){
  print(anova(nls_322.4, nls_322.5))
}

## AIC comparison
AIC3_322 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_322[AIC2_322$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_322.4"), AIC(get("nls_322.4")), NA),
            ifelse(exists("nls_322.5"), AIC(get("nls_322.5")), NA),
            ifelse(exists("nls_322.6"), AIC(get("nls_322.6")), NA)
            ))

print(AIC3_322) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_322[!is.na(AIC3_322$AIC) & AIC3_322$AIC == min(AIC3_322$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "322",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_nh[Best_mods.P_nh$Code == "322",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_322.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_322.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "322",]$ge.variance <- vcov(get(paste("nls_322.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "322",]$phi.variance <- vcov(get(paste("nls_322.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "322",]$alpha.variance <- vcov(get(paste("nls_322.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "322",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "322",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "322",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "322",]$a <- coefs["a"]
nls.param.df_nh[nls.param.df_nh$Code == "322",]$b <- coefs["b"]
nls.param.df_nh[nls.param.df_nh$Code == "322",]$c <- coefs["c"]
nls.param.df_nh[nls.param.df_nh$Code == "322",]$d <- coefs["d"]

nls.param.df_nh[nls.param.df_nh$Code == "322",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "322",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "322",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "322",]$a.2.5 <- intervals_low["a"]
nls.param.df_nh[nls.param.df_nh$Code == "322",]$b.2.5 <- intervals_low["b"]
nls.param.df_nh[nls.param.df_nh$Code == "322",]$c.2.5 <- intervals_low["c"]
nls.param.df_nh[nls.param.df_nh$Code == "322",]$d.2.5 <- intervals_low["d"]

nls.param.df_nh[nls.param.df_nh$Code == "322",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "322",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "322",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "322",]$a.97.5 <- intervals_high["a"]
nls.param.df_nh[nls.param.df_nh$Code == "322",]$b.97.5 <- intervals_high["b"]
nls.param.df_nh[nls.param.df_nh$Code == "322",]$c.97.5 <- intervals_high["c"]
nls.param.df_nh[nls.param.df_nh$Code == "322",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_322.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_322.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_321.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_321.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_322 <- nlsResiduals(
  get(paste("nls_322.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_322)

## test residuals
if(length(G_322$pltID) < 5001) {test.nlsResiduals(resid_322)}

}  else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_322_pred <- predict(get(paste("nls_322.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_322$MEASTIME_t2, na.rm = T), max(G_322$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_322$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_322$MEASTIME_t2, na.rm = T), max(G_322$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_322$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_322$DeltaPDSI, na.rm = T), max(G_322$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_322$MEASTIME_t2, na.rm = T), max(G_322$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_322$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_322$B_L_prop, na.rm = T), max(G_322$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_322$DeltaPDSI, na.rm = T), max(G_322$STDAGE_t2)))
                      } )

G_322_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_322$STDAGE_t2),by = 1),  
                            "fitted"=G_322_pred)

## plot
gg.322 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_322, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_322, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_332))), breaks = cutvec_322) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_322_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_322_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("322 - American Semidesert and Desert") + 
          
          #ylim(0, max(G_322_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_322,1)*1.05), expand = c(0,0))

gg.322

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_322 <- data.frame(
  bin = as.factor(levels(cut(G_322$STDAGE_t2, cutvec_322))),
  data.mean = tapply(G_322$B_plt_t2_MgHa, cut(G_322$STDAGE_t2, cutvec_322), 
                     mean), 
  data.CI.high =  tapply(G_322$B_plt_t2_MgHa, cut(G_322$STDAGE_t2, cutvec_322), 
                    high.CI), 
  data.CI.low = tapply(G_322$B_plt_t2_MgHa, cut(G_322$STDAGE_t2, cutvec_322),
                    low.CI), 
  pred.mean = G_322_pred_df[G_322_pred_df$STDAGE_t2 %in% bin_mids_322,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_322 <-  DM_compare_322 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_322$bin)[gtools::mixedorder(levels(DM_compare_322$bin))]))

## ggplot
gg.322.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_322) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_322))), 
                              labels = levels(DM_compare_322$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("322 - American Semidesert and Desert",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +         
           theme_classic() + 
           # xlim(min(DM_compare_322$data.CI.low)-0.25, max(DM_compare_322$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_322$pred.CI.low)-0.25, max(DM_compare_322$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.322.B2

}    else {print("cannot plot observed vs. predicted")}
```

* Cannot fit model 
* not enough data (only 3 observations)

## 331 - Great Plains/Palouse Dry Steppe
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_331 <- round(quantile(G_331$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_331)))){
  cutvec_331 <- round(quantile(G_331$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_331 <- unname(round(cutvec_331[-length(cutvec_331)] + diff(cutvec_331)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_331$STDAGE_t2_bin<-  cut(G_331$STDAGE_t2, cutvec_331)
## then get bin means
G_331_bin_means <- tapply(G_331$B_plt_t2_MgHa, cut(G_331$STDAGE_t2, cutvec_331), mean)

## make column weights.2
G_331$nls_weights.2 <- as.numeric(1/(G_331_bin_means[match(G_331$STDAGE_t2_bin, names(G_331_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_331.1 <- nls(f_1, data = G_331, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_331$nls_weights.2), 
 )

## phi
try(
  nls_331.2 <- nls(f_2, data=G_331, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_331$nls_weights.2), 
 )

# phi/alpha
try(
  nls_331.3 <- nls(f_3 , data = G_331, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_331$nls_weights.2), 
 )

## test
if(exists("nls_331.1") & exists("nls_331.2") & exists("nls_331.3")){
  print(anova(nls_331.1, nls_331.2, nls_331.3))
} else if(exists("nls_331.2") & exists("nls_331.3")){
  print(anova(nls_331.2, nls_331.3))
} else if(exists("nls_331.1") & exists("nls_331.2")){
  print(anova(nls_331.1, nls_331.2))
}
 
## AIC comparison
AIC1_331 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_331.1"), AIC(get("nls_331.1")), NA),
            ifelse(exists("nls_331.2"), AIC(get("nls_331.2")), NA),
            ifelse(exists("nls_331.3"), AIC(get("nls_331.3")), NA)
            ))

print(AIC1_331) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_331[!is.na(AIC1_331$AIC) & AIC1_331$AIC == min(AIC1_331$AIC, na.rm = T),]$model

try(summary(get(paste("nls_331.",  Mod.Sel1, sep =""))) ) #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_331.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_331.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_331.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
#ge.fit <- round(coef(get(paste("nls_331.",  Mod.Sel1, sep ="")))["ge"], 1)
ge.fit <-  -0.2
phi.fit <- round(coef(get(paste("nls_331.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_331.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_331.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_331.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_331.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_331,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 

          weights = G_331$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_331.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_331,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_331$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_331.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_331,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_331$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_331.", Mod.Sel1, sep ="")) &
     exists(paste("nls_331.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_331.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_331.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_331.", Mod.Sel1, sep ="")),
             get(paste("nls_331.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_331.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_331.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_331.", Mod.Sel1, sep ="")) &
         exists(paste("nls_331.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_331.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_331.", Mod.Sel1, sep ="")),
               get(paste("nls_331.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_331.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_331.", Mod.Sel1, sep ="")) &
           exists(paste("nls_331.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_331.", Mod.Sel1, sep ="")),
                 get(paste("nls_331.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_331.", Mod.Sel1, sep ="")) &
              exists(paste("nls_331.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_331.", Mod.Sel1, sep ="")),
                    get(paste("nls_331.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_331.", Mod.Sel1, sep ="")) &
                exists(paste("nls_331.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_331.", Mod.Sel1, sep ="")),
                      get(paste("nls_331.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_331 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_331.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_331.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_331.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_331.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_331.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_331.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_331.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_331.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_331)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_331[!is.na(AIC2_331$AIC) & AIC2_331$AIC == min(AIC2_331$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "331",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_331.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_331.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "331",]$ge.variance <- vcov(get(paste("nls_331.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "331",]$phi.variance <- vcov(get(paste("nls_331.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "331",]$alpha.variance <- vcov(get(paste("nls_331.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "331",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "331",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "331",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "331",]$A <- coefs["A"]
nls.param.df_nh[nls.param.df_nh$Code == "331",]$k <- coefs["k"]

nls.param.df_nh[nls.param.df_nh$Code == "331",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "331",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "331",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "331",]$A.2.5 <- intervals_low["A"]
nls.param.df_nh[nls.param.df_nh$Code == "331",]$k.2.5 <- intervals_low["k"]

nls.param.df_nh[nls.param.df_nh$Code == "331",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "331",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "331",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "331",]$A.97.5 <- intervals_high["A"]
nls.param.df_nh[nls.param.df_nh$Code == "331",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_331.",  Mod.Sel2, sep =""))) ) 

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_331.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_331.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_331.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_331$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_331.4 <- nls(f_4, data = G_331, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_331$nls_weights.2), 
 )

## phi
try(
  nls_331.5 <- nls(f_5, data=G_331, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_331$nls_weights.2), 
 )

# phi/alpha
try(
  nls_331.6 <- nls(f_6, data = G_331, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_331$nls_weights.2), 
 )

## test
if(exists("nls_331.4") & exists("nls_331.5") & exists("nls_331.6")){
  print(anova(nls_331.4, nls_331.5, nls_331.6))
} else if(exists("nls_331.4") & exists("nls_331.6")){
  print(anova(nls_331.4, nls_331.6))
} else if(exists("nls_331.5") & exists("nls_331.6")){
  print(anova(nls_331.5, nls_331.6))
} else if(exists("nls_331.4") & exists("nls_331.5")){
  print(anova(nls_331.4, nls_331.5))
}

## AIC comparison
AIC3_331 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_331[AIC2_331$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_331.4"), AIC(get("nls_331.4")), NA),
            ifelse(exists("nls_331.5"), AIC(get("nls_331.5")), NA),
            ifelse(exists("nls_331.6"), AIC(get("nls_331.6")), NA)
            ))

print(AIC3_331) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_331[!is.na(AIC3_331$AIC) & AIC3_331$AIC == min(AIC3_331$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "331",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_nh[Best_mods.P_nh$Code == "331",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_331.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_331.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "331",]$ge.variance <- vcov(get(paste("nls_331.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "331",]$phi.variance <- vcov(get(paste("nls_331.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "331",]$alpha.variance <- vcov(get(paste("nls_331.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "331",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "331",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "331",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "331",]$a <- coefs["a"]
nls.param.df_nh[nls.param.df_nh$Code == "331",]$b <- coefs["b"]
nls.param.df_nh[nls.param.df_nh$Code == "331",]$c <- coefs["c"]
nls.param.df_nh[nls.param.df_nh$Code == "331",]$d <- coefs["d"]

nls.param.df_nh[nls.param.df_nh$Code == "331",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "331",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "331",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "331",]$a.2.5 <- intervals_low["a"]
nls.param.df_nh[nls.param.df_nh$Code == "331",]$b.2.5 <- intervals_low["b"]
nls.param.df_nh[nls.param.df_nh$Code == "331",]$c.2.5 <- intervals_low["c"]
nls.param.df_nh[nls.param.df_nh$Code == "331",]$d.2.5 <- intervals_low["d"]

nls.param.df_nh[nls.param.df_nh$Code == "331",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "331",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "331",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "331",]$a.97.5 <- intervals_high["a"]
nls.param.df_nh[nls.param.df_nh$Code == "331",]$b.97.5 <- intervals_high["b"]
nls.param.df_nh[nls.param.df_nh$Code == "331",]$c.97.5 <- intervals_high["c"]
nls.param.df_nh[nls.param.df_nh$Code == "331",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_331.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_331.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_331.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_331.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_331 <- nlsResiduals(
  get(paste("nls_331.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_331)

## test residuals
if(length(G_331$pltID) < 5001) {test.nlsResiduals(resid_331)}

}  else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_331_pred <- predict(get(paste("nls_331.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_331$MEASTIME_t2, na.rm = T), max(G_331$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_331$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_331$MEASTIME_t2, na.rm = T), max(G_331$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_331$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_331$DeltaPDSI, na.rm = T), max(G_331$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_331$MEASTIME_t2, na.rm = T), max(G_331$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_331$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_331$B_L_prop, na.rm = T), max(G_331$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_331$DeltaPDSI, na.rm = T), max(G_331$STDAGE_t2)))
                      } )

G_331_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_331$STDAGE_t2),by = 1),  
                            "fitted"=G_331_pred)

## plot
gg.331 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_331, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_331, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_331))), breaks = cutvec_331) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_331_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_331_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("331 - Great Plains/Palouse Dry Steppe") + 
          
          #ylim(0, max(G_331_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_331,1)*1.05), expand = c(0,0))

gg.331

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_331 <- data.frame(
  bin = as.factor(levels(cut(G_331$STDAGE_t2, cutvec_331))),
  data.mean = tapply(G_331$B_plt_t2_MgHa, cut(G_331$STDAGE_t2, cutvec_331), 
                     mean), 
  data.CI.high =  tapply(G_331$B_plt_t2_MgHa, cut(G_331$STDAGE_t2, cutvec_331), 
                    high.CI), 
  data.CI.low = tapply(G_331$B_plt_t2_MgHa, cut(G_331$STDAGE_t2, cutvec_331),
                    low.CI), 
  pred.mean = G_331_pred_df[G_331_pred_df$STDAGE_t2 %in% bin_mids_331,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_331 <-  DM_compare_331 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_331$bin)[gtools::mixedorder(levels(DM_compare_331$bin))]))

## ggplot
gg.331.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_331) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_331))), 
                              labels = levels(DM_compare_331$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("331 - Great Plains/Palouse Dry Steppe",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +         
           theme_classic() + 
           # xlim(min(DM_compare_331$data.CI.low)-0.25, max(DM_compare_331$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_331$pred.CI.low)-0.25, max(DM_compare_331$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.331.B2

}    else {print("cannot plot observed vs. predicted")}
```
* Cannot fit model 

## 332 - Great Plains Steppe
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_332 <- round(quantile(G_332$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_332)))){
  cutvec_332 <- round(quantile(G_332$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_332 <- unname(round(cutvec_332[-length(cutvec_332)] + diff(cutvec_332)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_332$STDAGE_t2_bin<-  cut(G_332$STDAGE_t2, cutvec_332)
## then get bin means
G_332_bin_means <- tapply(G_332$B_plt_t2_MgHa, cut(G_332$STDAGE_t2,  cutvec_332), mean)

## make column weights.2
G_332$nls_weights.2 <- as.numeric(1/(G_332_bin_means[match(G_332$STDAGE_t2_bin, names(G_332_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_332.1 <- nls(f_1, data = G_332, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_332$nls_weights.2), 
 )

## phi
try(
  nls_332.2 <- nls(f_2, data=G_332, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_332$nls_weights.2), 
 )

# phi/alpha
try(
  nls_332.3 <- nls(f_3 , data = G_332, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_332$nls_weights.2), 
 )

## test
if(exists("nls_332.1") & exists("nls_332.2") & exists("nls_332.3")){
  print(anova(nls_332.1, nls_332.2, nls_332.3))
} else if(exists("nls_332.2") & exists("nls_332.3")){
  print(anova(nls_332.2, nls_332.3))
} else if(exists("nls_332.1") & exists("nls_332.2")){
  print(anova(nls_332.1, nls_332.2))
}
 
## AIC comparison
AIC1_332 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_332.1"), AIC(get("nls_332.1")), NA),
            ifelse(exists("nls_332.2"), AIC(get("nls_332.2")), NA),
            ifelse(exists("nls_332.3"), AIC(get("nls_332.3")), NA)
            ))

print(AIC1_332) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_332[!is.na(AIC1_332$AIC) & AIC1_332$AIC == min(AIC1_332$AIC, na.rm = T),]$model

try(summary(get(paste("nls_332.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_332.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_332.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_332.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_332.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_332.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_332.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_332.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_332.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_332.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_332,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_332$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_332.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_332,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_332$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_332.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_332,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_332$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_332.", Mod.Sel1, sep ="")) &
     exists(paste("nls_332.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_332.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_332.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_332.", Mod.Sel1, sep ="")),
             get(paste("nls_332.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_332.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_332.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_332.", Mod.Sel1, sep ="")) &
         exists(paste("nls_332.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_332.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_332.", Mod.Sel1, sep ="")),
               get(paste("nls_332.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_332.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_332.", Mod.Sel1, sep ="")) &
           exists(paste("nls_332.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_332.", Mod.Sel1, sep ="")),
                 get(paste("nls_332.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_332.", Mod.Sel1, sep ="")) &
              exists(paste("nls_332.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_332.", Mod.Sel1, sep ="")),
                    get(paste("nls_332.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_332.", Mod.Sel1, sep ="")) &
                exists(paste("nls_332.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_332.", Mod.Sel1, sep ="")),
                      get(paste("nls_332.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_332 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_332.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_332.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_332.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_332.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_332.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_332.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_332.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_332.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_332)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_332[!is.na(AIC2_332$AIC) & AIC2_332$AIC == min(AIC2_332$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "332",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_332.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_332.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "332",]$ge.variance <- vcov(get(paste("nls_332.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "332",]$phi.variance <- vcov(get(paste("nls_332.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "332",]$alpha.variance <- vcov(get(paste("nls_332.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "332",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "332",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "332",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "332",]$A <- coefs["A"]
nls.param.df_nh[nls.param.df_nh$Code == "332",]$k <- coefs["k"]

nls.param.df_nh[nls.param.df_nh$Code == "332",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "332",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "332",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "332",]$A.2.5 <- intervals_low["A"]
nls.param.df_nh[nls.param.df_nh$Code == "332",]$k.2.5 <- intervals_low["k"]

nls.param.df_nh[nls.param.df_nh$Code == "332",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "332",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "332",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "332",]$A.97.5 <- intervals_high["A"]
nls.param.df_nh[nls.param.df_nh$Code == "332",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_332.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_332.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_332.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_332.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_332$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_332.4 <- nls(f_4, data = G_332, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_332$nls_weights.2), 
 )

## phi
try(
  nls_332.5 <- nls(f_5, data=G_332, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_332$nls_weights.2), 
 )

# phi/alpha
try(
  nls_332.6 <- nls(f_6, data = G_332, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_332$nls_weights.2), 
 )

## test
if(exists("nls_332.4") & exists("nls_332.5") & exists("nls_332.6")){
  print(anova(nls_332.4, nls_332.5, nls_332.6))
} else if(exists("nls_332.4") & exists("nls_332.6")){
  print(anova(nls_332.4, nls_332.6))
} else if(exists("nls_332.5") & exists("nls_332.6")){
  print(anova(nls_332.5, nls_332.6))
} else if(exists("nls_332.4") & exists("nls_332.5")){
  print(anova(nls_332.4, nls_332.5))
}

## AIC comparison
AIC3_332 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_332[AIC2_332$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_332.4"), AIC(get("nls_332.4")), NA),
            ifelse(exists("nls_332.5"), AIC(get("nls_332.5")), NA),
            ifelse(exists("nls_332.6"), AIC(get("nls_332.6")), NA)
            ))

print(AIC3_332) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_332[!is.na(AIC3_332$AIC) & AIC3_332$AIC == min(AIC3_332$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "332",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_nh[Best_mods.P_nh$Code == "332",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_332.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_332.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "332",]$ge.variance <- vcov(get(paste("nls_332.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "332",]$phi.variance <- vcov(get(paste("nls_332.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "332",]$alpha.variance <- vcov(get(paste("nls_332.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "332",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "332",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "332",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "332",]$a <- coefs["a"]
nls.param.df_nh[nls.param.df_nh$Code == "332",]$b <- coefs["b"]
nls.param.df_nh[nls.param.df_nh$Code == "332",]$c <- coefs["c"]
nls.param.df_nh[nls.param.df_nh$Code == "332",]$d <- coefs["d"]

nls.param.df_nh[nls.param.df_nh$Code == "332",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "332",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "332",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "332",]$a.2.5 <- intervals_low["a"]
nls.param.df_nh[nls.param.df_nh$Code == "332",]$b.2.5 <- intervals_low["b"]
nls.param.df_nh[nls.param.df_nh$Code == "332",]$c.2.5 <- intervals_low["c"]
nls.param.df_nh[nls.param.df_nh$Code == "332",]$d.2.5 <- intervals_low["d"]

nls.param.df_nh[nls.param.df_nh$Code == "332",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "332",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "332",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "332",]$a.97.5 <- intervals_high["a"]
nls.param.df_nh[nls.param.df_nh$Code == "332",]$b.97.5 <- intervals_high["b"]
nls.param.df_nh[nls.param.df_nh$Code == "332",]$c.97.5 <- intervals_high["c"]
nls.param.df_nh[nls.param.df_nh$Code == "332",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_332.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_332.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_332.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_332.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_332 <- nlsResiduals(
  get(paste("nls_332.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_332)

## test residuals
if(length(G_332$pltID) < 5001) {test.nlsResiduals(resid_332)}

}  else {print("cannot plot residuals")}
```


### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_332_pred <- predict(get(paste("nls_332.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_332$MEASTIME_t2, na.rm = T), max(G_332$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_332$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_332$MEASTIME_t2, na.rm = T), max(G_332$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_332$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_332$DeltaPDSI, na.rm = T), max(G_332$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_332$MEASTIME_t2, na.rm = T), max(G_332$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_332$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_332$B_L_prop, na.rm = T), max(G_332$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_332$DeltaPDSI, na.rm = T), max(G_332$STDAGE_t2)))
                      } )

G_332_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_332$STDAGE_t2),by = 1),  
                            "fitted"=G_332_pred)

## plot
gg.332 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_332, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_332, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_332))), breaks = cutvec_332) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_332_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_332_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("332 - Southwest Plateau and Plains Dry Steppe and Shrub") + 
          
          #ylim(0, max(G_332_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_332,1)*1.05), expand = c(0,0))

gg.332

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_332 <- data.frame(
  bin = as.factor(levels(cut(G_332$STDAGE_t2, cutvec_332))),
  data.mean = tapply(G_332$B_plt_t2_MgHa, cut(G_332$STDAGE_t2, cutvec_332), 
                     mean), 
  data.CI.high =  tapply(G_332$B_plt_t2_MgHa, cut(G_332$STDAGE_t2, cutvec_332), 
                    high.CI), 
  data.CI.low = tapply(G_332$B_plt_t2_MgHa, cut(G_332$STDAGE_t2, cutvec_332),
                    low.CI), 
  pred.mean = G_332_pred_df[G_332_pred_df$STDAGE_t2 %in% bin_mids_332,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_332 <-  DM_compare_332 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_332$bin)[gtools::mixedorder(levels(DM_compare_332$bin))]))

## ggplot
gg.332.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_332) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_332))), 
                              labels = levels(DM_compare_332$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("332 - Southwest Plateau and Plains Dry Steppe and Shrub",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +        
           theme_classic() + 
           # xlim(min(DM_compare_332$data.CI.low)-0.25, max(DM_compare_332$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_332$pred.CI.low)-0.25, max(DM_compare_332$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.332.B2

}    else {print("cannot plot observed vs. predicted")}
```

## 341 - Nevada-Utah Mountains Semi-Desert - Coniferous Forest - Alpine Meadow
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_341 <- round(quantile(G_341$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_341)))){
  cutvec_341 <- round(quantile(G_341$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_341 <- unname(round(cutvec_341[-length(cutvec_341)] + diff(cutvec_341)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_341$STDAGE_t2_bin<-  cut(G_341$STDAGE_t2, cutvec_341)
## then get bin means
G_341_bin_means <- tapply(G_341$B_plt_t2_MgHa, cut(G_341$STDAGE_t2,  cutvec_341), mean)

## make column weights.2
G_341$nls_weights.2 <- as.numeric(1/(G_341_bin_means[match(G_341$STDAGE_t2_bin, names(G_341_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_341.1 <- nls(f_1, data = G_341, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_341$nls_weights.2), 
 )

## phi
try(
  nls_341.2 <- nls(f_2, data=G_341, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_341$nls_weights.2), 
 )

# phi/alpha
try(
  nls_341.3 <- nls(f_3 , data = G_341, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_341$nls_weights.2), 
 )

## test
if(exists("nls_341.1") & exists("nls_341.2") & exists("nls_341.3")){
  print(anova(nls_341.1, nls_341.2, nls_341.3))
} else if(exists("nls_341.2") & exists("nls_341.3")){
  print(anova(nls_341.2, nls_341.3))
} else if(exists("nls_341.1") & exists("nls_341.2")){
  print(anova(nls_341.1, nls_341.2))
}
 
## AIC comparison
AIC1_341 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_341.1"), AIC(get("nls_341.1")), NA),
            ifelse(exists("nls_341.2"), AIC(get("nls_341.2")), NA),
            ifelse(exists("nls_341.3"), AIC(get("nls_341.3")), NA)
            ))

print(AIC1_341) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_341[!is.na(AIC1_341$AIC) & AIC1_341$AIC == min(AIC1_341$AIC, na.rm = T),]$model

try(summary(get(paste("nls_341.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_341.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_341.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_341.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_341.",  Mod.Sel1, sep ="")))["ge"], 1)
#phi.fit <- round(coef(get(paste("nls_341.",  Mod.Sel1, sep ="")))["phi"], 1)
#alpha.fit <- round(coef(get(paste("nls_341.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_341.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_341.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_341.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_341,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_341$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_341.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_341,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_341$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_341.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_341,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_341$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_341.", Mod.Sel1, sep ="")) &
     exists(paste("nls_341.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_341.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_341.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_341.", Mod.Sel1, sep ="")),
             get(paste("nls_341.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_341.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_341.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_341.", Mod.Sel1, sep ="")) &
         exists(paste("nls_341.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_341.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_341.", Mod.Sel1, sep ="")),
               get(paste("nls_341.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_341.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_341.", Mod.Sel1, sep ="")) &
           exists(paste("nls_341.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_341.", Mod.Sel1, sep ="")),
                 get(paste("nls_341.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_341.", Mod.Sel1, sep ="")) &
              exists(paste("nls_341.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_341.", Mod.Sel1, sep ="")),
                    get(paste("nls_341.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_341.", Mod.Sel1, sep ="")) &
                exists(paste("nls_341.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_341.", Mod.Sel1, sep ="")),
                      get(paste("nls_341.", Mod.Sel1, "b", sep =""))
                      ))
              }              
                
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_341 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_341.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_341.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_341.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_341.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_341.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_341.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_341.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_341.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_341)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_341[!is.na(AIC2_341$AIC) & AIC2_341$AIC == min(AIC2_341$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "341",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_341.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_341.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "341",]$ge.variance <- vcov(get(paste("nls_341.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "341",]$phi.variance <- vcov(get(paste("nls_341.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "341",]$alpha.variance <- vcov(get(paste("nls_341.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "341",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "341",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "341",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "341",]$A <- coefs["A"]
nls.param.df_nh[nls.param.df_nh$Code == "341",]$k <- coefs["k"]

nls.param.df_nh[nls.param.df_nh$Code == "341",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "341",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "341",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "341",]$A.2.5 <- intervals_low["A"]
nls.param.df_nh[nls.param.df_nh$Code == "341",]$k.2.5 <- intervals_low["k"]

nls.param.df_nh[nls.param.df_nh$Code == "341",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "341",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "341",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "341",]$A.97.5 <- intervals_high["A"]
nls.param.df_nh[nls.param.df_nh$Code == "341",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_341.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_341.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_341.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_341.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_341$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_341.4 <- nls(f_4, data = G_341, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_341$nls_weights.2), 
 )

## phi
try(
  nls_341.5 <- nls(f_5, data=G_341, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_341$nls_weights.2), 
 )

# phi/alpha
try(
  nls_341.6 <- nls(f_6, data = G_341, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_341$nls_weights.2), 
 )

## test
if(exists("nls_341.4") & exists("nls_341.5") & exists("nls_341.6")){
  print(anova(nls_341.4, nls_341.5, nls_341.6))
} else if(exists("nls_341.4") & exists("nls_341.6")){
  print(anova(nls_341.4, nls_341.6))
} else if(exists("nls_341.5") & exists("nls_341.6")){
  print(anova(nls_341.5, nls_341.6))
} else if(exists("nls_341.4") & exists("nls_341.5")){
  print(anova(nls_341.4, nls_341.5))
}

## AIC comparison
AIC3_341 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_341[AIC2_341$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_341.4"), AIC(get("nls_341.4")), NA),
            ifelse(exists("nls_341.5"), AIC(get("nls_341.5")), NA),
            ifelse(exists("nls_341.6"), AIC(get("nls_341.6")), NA)
            ))

print(AIC3_341) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_341[!is.na(AIC3_341$AIC) & AIC3_341$AIC == min(AIC3_341$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "341",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_nh[Best_mods.P_nh$Code == "341",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_341.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_341.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "341",]$ge.variance <- vcov(get(paste("nls_341.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "341",]$phi.variance <- vcov(get(paste("nls_341.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "341",]$alpha.variance <- vcov(get(paste("nls_341.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "341",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "341",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "341",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "341",]$a <- coefs["a"]
nls.param.df_nh[nls.param.df_nh$Code == "341",]$b <- coefs["b"]
nls.param.df_nh[nls.param.df_nh$Code == "341",]$c <- coefs["c"]
nls.param.df_nh[nls.param.df_nh$Code == "341",]$d <- coefs["d"]

nls.param.df_nh[nls.param.df_nh$Code == "341",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "341",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "341",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "341",]$a.2.5 <- intervals_low["a"]
nls.param.df_nh[nls.param.df_nh$Code == "341",]$b.2.5 <- intervals_low["b"]
nls.param.df_nh[nls.param.df_nh$Code == "341",]$c.2.5 <- intervals_low["c"]
nls.param.df_nh[nls.param.df_nh$Code == "341",]$d.2.5 <- intervals_low["d"]

nls.param.df_nh[nls.param.df_nh$Code == "341",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "341",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "341",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "341",]$a.97.5 <- intervals_high["a"]
nls.param.df_nh[nls.param.df_nh$Code == "341",]$b.97.5 <- intervals_high["b"]
nls.param.df_nh[nls.param.df_nh$Code == "341",]$c.97.5 <- intervals_high["c"]
nls.param.df_nh[nls.param.df_nh$Code == "341",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_341.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_341.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_341.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_341.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_341 <- nlsResiduals(
  get(paste("nls_341.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_341)

## test residuals
if(length(G_341$pltID) < 5001) {test.nlsResiduals(resid_341)}

}  else {print("cannot plot residuals")}
```

* model not fitted because only 62 observations

### predict and plot 

```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & fit.models == T) {

## predict model fit
G_341_pred <- predict(get(paste("nls_341.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_341$MEASTIME_t2, na.rm = T), max(G_341$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_341$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_341$MEASTIME_t2, na.rm = T), max(G_341$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_341$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_341$DeltaPDSI, na.rm = T), max(G_341$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_341$MEASTIME_t2, na.rm = T), max(G_341$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_341$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_341$B_L_prop, na.rm = T), max(G_341$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_341$DeltaPDSI, na.rm = T), max(G_341$STDAGE_t2)))
                      } )

G_341_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_341$STDAGE_t2),by = 1),
                            "fitted"=G_341_pred)

## plot
gg.341 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_341, alpha = 0.5, shape ="+", col = "#60606080") +

          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_341,
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res},
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_341))), breaks = cutvec_341) +

          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`),
                      #data = G_341_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +

          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_341_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) +


          theme_classic() +
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"),
               x = "Stand Age (yrs)") +  ggtitle("341 - Nevada-Utah Mountains Semi-Desert - Coniferous Forest - Alpine Meadow") +

          #ylim(0, max(G_341_pred_df$`Prop.97.5%` + 0.25)) +
          scale_x_continuous(limits = c(0, max(G_341$STDAGE_t2)), expand = c(0,0))

gg.341

}    else {print("cannot plot data with prediction")}
```

### plotting 2

```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & fit.models == T) {

## data wrangling:
DM_compare_341 <- data.frame(
  bin = as.factor(levels(cut(G_341$STDAGE_t2, cutvec_341))),
  data.mean = tapply(G_341$B_plt_t2_MgHa, cut(G_341$STDAGE_t2, cutvec_341),
                     mean),
  data.CI.high =  tapply(G_341$B_plt_t2_MgHa, cut(G_341$STDAGE_t2, cutvec_341),
                    high.CI),
  data.CI.low = tapply(G_341$B_plt_t2_MgHa, cut(G_341$STDAGE_t2, cutvec_341),
                    low.CI),
  pred.mean = G_341_pred_df[G_341_pred_df$STDAGE_t2 %in% bin_mids_341,]$fitted)

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY
DM_compare_341 <-  DM_compare_341 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_341$bin)[gtools::mixedorder(levels(DM_compare_341$bin))]))

## ggplot
gg.341.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_341) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_341))),
                              labels = levels(DM_compare_341$bin),
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +
           labs(x = expression("observed biomass (Mg ha"^-1*")"),
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("341 - Nevada-Utah Mountains Semi-Desert - Coniferous Forest - Alpine Meadow",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +
           theme_classic() +
           # xlim(min(DM_compare_341$data.CI.low)-0.25, max(DM_compare_341$data.CI.high)+0.25) +
           # ylim(min(DM_compare_341$pred.CI.low)-0.25, max(DM_compare_341$pred.CI.high)+0.25) +
           theme(legend.position = "top") + tune::coord_obs_pred()

gg.341.B2

}   else {print("cannot plot observed vs. predicted")}
```

## 342 - Intermountain Semi-Desert
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_342 <- round(quantile(G_342$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_342)))){
  cutvec_342 <- round(quantile(G_342$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_342 <- unname(round(cutvec_342[-length(cutvec_342)] + diff(cutvec_342)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_342$STDAGE_t2_bin<-  cut(G_342$STDAGE_t2, cutvec_342)
## then get bin means
G_342_bin_means <- tapply(G_342$B_plt_t2_MgHa, cut(G_342$STDAGE_t2,  cutvec_342), mean)

## make column weights.2
G_342$nls_weights.2 <- as.numeric(1/(G_342_bin_means[match(G_342$STDAGE_t2_bin, names(G_342_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_342.1 <- nls(f_1, data = G_342, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_342$nls_weights.2), 
 )

## phi
try(
  nls_342.2 <- nls(f_2, data=G_342, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_342$nls_weights.2), 
 )

# phi/alpha
try(
  nls_342.3 <- nls(f_3 , data = G_342, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_342$nls_weights.2), 
 )

## test
if(exists("nls_342.1") & exists("nls_342.2") & exists("nls_342.3")){
  print(anova(nls_342.1, nls_342.2, nls_342.3))
} else if(exists("nls_342.2") & exists("nls_342.3")){
  print(anova(nls_342.2, nls_342.3))
} else if(exists("nls_342.1") & exists("nls_342.2")){
  print(anova(nls_342.1, nls_342.2))
}
 
## AIC comparison
AIC1_342 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_342.1"), AIC(get("nls_342.1")), NA),
            ifelse(exists("nls_342.2"), AIC(get("nls_342.2")), NA),
            ifelse(exists("nls_342.3"), AIC(get("nls_342.3")), NA)
            ))

print(AIC1_342) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_342[!is.na(AIC1_342$AIC) &AIC1_342$AIC == min(AIC1_342$AIC, na.rm = T),]$model

try(summary(get(paste("nls_342.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_342.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_342.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_342.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_342.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_342.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_342.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_342.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_342.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_342.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_342,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_342$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_342.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_342,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_342$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_342.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_342,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_342$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_342.", Mod.Sel1, sep ="")) &
     exists(paste("nls_342.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_342.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_342.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_342.", Mod.Sel1, sep ="")),
             get(paste("nls_342.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_342.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_342.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_342.", Mod.Sel1, sep ="")) &
         exists(paste("nls_342.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_342.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_342.", Mod.Sel1, sep ="")),
               get(paste("nls_342.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_342.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_342.", Mod.Sel1, sep ="")) &
           exists(paste("nls_342.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_342.", Mod.Sel1, sep ="")),
                 get(paste("nls_342.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_342.", Mod.Sel1, sep ="")) &
              exists(paste("nls_342.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_342.", Mod.Sel1, sep ="")),
                    get(paste("nls_342.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_342.", Mod.Sel1, sep ="")) &
                exists(paste("nls_342.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_342.", Mod.Sel1, sep ="")),
                      get(paste("nls_342.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_342 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_342.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_342.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_342.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_342.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_342.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_342.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_342.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_342.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_342)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_342[!is.na(AIC2_342$AIC) & AIC2_342$AIC == min(AIC2_342$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "342",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_342.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_342.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "342",]$ge.variance <- vcov(get(paste("nls_342.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "342",]$phi.variance <- vcov(get(paste("nls_342.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "342",]$alpha.variance <- vcov(get(paste("nls_342.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "342",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "342",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "342",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "342",]$A <- coefs["A"]
nls.param.df_nh[nls.param.df_nh$Code == "342",]$k <- coefs["k"]

nls.param.df_nh[nls.param.df_nh$Code == "342",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "342",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "342",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "342",]$A.2.5 <- intervals_low["A"]
nls.param.df_nh[nls.param.df_nh$Code == "342",]$k.2.5 <- intervals_low["k"]

nls.param.df_nh[nls.param.df_nh$Code == "342",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "342",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "342",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "342",]$A.97.5 <- intervals_high["A"]
nls.param.df_nh[nls.param.df_nh$Code == "342",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_342.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_342.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_342.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_342.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_342$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_342.4 <- nls(f_4, data = G_342, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_342$nls_weights.2), 
 )

## phi
try(
  nls_342.5 <- nls(f_5, data=G_342, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_342$nls_weights.2), 
 )

# phi/alpha
try(
  nls_342.6 <- nls(f_6, data = G_342, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_342$nls_weights.2), 
 )

## test
if(exists("nls_342.4") & exists("nls_342.5") & exists("nls_342.6")){
  print(anova(nls_342.4, nls_342.5, nls_342.6))
} else if(exists("nls_342.4") & exists("nls_342.6")){
  print(anova(nls_342.4, nls_342.6))
} else if(exists("nls_342.5") & exists("nls_342.6")){
  print(anova(nls_342.5, nls_342.6))
} else if(exists("nls_342.4") & exists("nls_342.5")){
  print(anova(nls_342.4, nls_342.5))
}

## AIC comparison
AIC3_342 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_342[AIC2_342$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_342.4"), AIC(get("nls_342.4")), NA),
            ifelse(exists("nls_342.5"), AIC(get("nls_342.5")), NA),
            ifelse(exists("nls_342.6"), AIC(get("nls_342.6")), NA)
            ))

print(AIC3_342) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_342[!is.na(AIC3_342$AIC) & AIC3_342$AIC == min(AIC3_342$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "342",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_nh[Best_mods.P_nh$Code == "342",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_342.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_342.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "342",]$ge.variance <- vcov(get(paste("nls_342.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "342",]$phi.variance <- vcov(get(paste("nls_342.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "342",]$alpha.variance <- vcov(get(paste("nls_342.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "342",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "342",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "342",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "342",]$a <- coefs["a"]
nls.param.df_nh[nls.param.df_nh$Code == "342",]$b <- coefs["b"]
nls.param.df_nh[nls.param.df_nh$Code == "342",]$c <- coefs["c"]
nls.param.df_nh[nls.param.df_nh$Code == "342",]$d <- coefs["d"]

nls.param.df_nh[nls.param.df_nh$Code == "342",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "342",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "342",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "342",]$a.2.5 <- intervals_low["a"]
nls.param.df_nh[nls.param.df_nh$Code == "342",]$b.2.5 <- intervals_low["b"]
nls.param.df_nh[nls.param.df_nh$Code == "342",]$c.2.5 <- intervals_low["c"]
nls.param.df_nh[nls.param.df_nh$Code == "342",]$d.2.5 <- intervals_low["d"]

nls.param.df_nh[nls.param.df_nh$Code == "342",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "342",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "342",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "342",]$a.97.5 <- intervals_high["a"]
nls.param.df_nh[nls.param.df_nh$Code == "342",]$b.97.5 <- intervals_high["b"]
nls.param.df_nh[nls.param.df_nh$Code == "342",]$c.97.5 <- intervals_high["c"]
nls.param.df_nh[nls.param.df_nh$Code == "342",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_342.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_342.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_342.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_342.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_342 <- nlsResiduals(
  get(paste("nls_342.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_342)

## test residuals
if(length(G_342$pltID) < 5001) {test.nlsResiduals(resid_342)}

}   else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_342_pred <- predict(get(paste("nls_342.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_342$MEASTIME_t2, na.rm = T), max(G_342$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_342$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_342$MEASTIME_t2, na.rm = T), max(G_342$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_342$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_342$DeltaPDSI, na.rm = T), max(G_342$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_342$MEASTIME_t2, na.rm = T), max(G_342$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_342$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_342$B_L_prop, na.rm = T), max(G_342$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_342$DeltaPDSI, na.rm = T), max(G_342$STDAGE_t2)))
                      } )

G_342_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_342$STDAGE_t2),by = 1),  
                            "fitted"=G_342_pred)

## plot
gg.342 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_342, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_342, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_342)-1)), breaks = cutvec_342) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_342_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_342_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("342 - Intermountain Semi-Desert") + 
          
          #ylim(0, max(G_342_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_342,1)*1.05), expand = c(0,0))

gg.342

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_342 <- data.frame(
  bin = as.factor(levels(cut(G_342$STDAGE_t2, cutvec_342))),
  data.mean = tapply(G_342$B_plt_t2_MgHa, cut(G_342$STDAGE_t2, cutvec_342), 
                     mean), 
  data.CI.high =  tapply(G_342$B_plt_t2_MgHa, cut(G_342$STDAGE_t2, cutvec_342), 
                    high.CI), 
  data.CI.low = tapply(G_342$B_plt_t2_MgHa, cut(G_342$STDAGE_t2, cutvec_342),
                    low.CI), 
  pred.mean = G_342_pred_df[G_342_pred_df$STDAGE_t2 %in% bin_mids_342,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_342 <-  DM_compare_342 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_342$bin)[gtools::mixedorder(levels(DM_compare_342$bin))]))

## ggplot
gg.342.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_342) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_342))), 
                              labels = levels(DM_compare_342$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("342 - Northeastern Mixed Forest",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +        
           theme_classic() + 
           # xlim(min(DM_compare_342$data.CI.low)-0.25, max(DM_compare_342$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_342$pred.CI.low)-0.25, max(DM_compare_342$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.342.B2

}   else {print("cannot plot observed vs. predicted")}
```

## 411 - Everglades
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_411 <- round(quantile(G_411$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_411)))){
  cutvec_411 <- round(quantile(G_411$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_411 <- unname(round(cutvec_411[-length(cutvec_411)] + diff(cutvec_411)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_411$STDAGE_t2_bin<-  cut(G_411$STDAGE_t2, cutvec_411)
## then get bin means
G_411_bin_means <- tapply(G_411$B_plt_t2_MgHa, cut(G_411$STDAGE_t2,  cutvec_411), mean)

## make column weights.2
G_411$nls_weights.2 <- as.numeric(1/(G_411_bin_means[match(G_411$STDAGE_t2_bin, names(G_411_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_411.1 <- nls(f_1, data = G_411, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_411$nls_weights.2), 
 )

## phi
try(
  nls_411.2 <- nls(f_2, data=G_411, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_411$nls_weights.2), 
 )

# phi/alpha
try(
  nls_411.3 <- nls(f_3 , data = G_411, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_411$nls_weights.2), 
 )

## test
if(exists("nls_411.1") & exists("nls_411.2") & exists("nls_411.3")){
  print(anova(nls_411.1, nls_411.2, nls_411.3))
} else if(exists("nls_411.2") & exists("nls_411.3")){
  print(anova(nls_411.2, nls_411.3))
} else if(exists("nls_411.1") & exists("nls_411.2")){
  print(anova(nls_411.1, nls_411.2))
}
 
## AIC comparison
AIC1_411 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_411.1"), AIC(get("nls_411.1")), NA),
            ifelse(exists("nls_411.2"), AIC(get("nls_411.2")), NA),
            ifelse(exists("nls_411.3"), AIC(get("nls_411.3")), NA)
            ))

print(AIC1_411) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_411[!is.na(AIC1_411$AIC) & AIC1_411$AIC == min(AIC1_411$AIC, na.rm = T),]$model

try(summary(get(paste("nls_411.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_411.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_411.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_411.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_411.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_411.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_411.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_411.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_411.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_411.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_411,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 

          weights = G_411$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_411.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_411,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_411$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_411.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_411,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_411$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_411.", Mod.Sel1, sep ="")) &
     exists(paste("nls_411.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_411.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_411.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_411.", Mod.Sel1, sep ="")),
             get(paste("nls_411.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_411.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_411.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_411.", Mod.Sel1, sep ="")) &
         exists(paste("nls_411.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_411.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_411.", Mod.Sel1, sep ="")),
               get(paste("nls_411.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_411.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_411.", Mod.Sel1, sep ="")) &
           exists(paste("nls_411.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_411.", Mod.Sel1, sep ="")),
                 get(paste("nls_411.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_411.", Mod.Sel1, sep ="")) &
              exists(paste("nls_411.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_411.", Mod.Sel1, sep ="")),
                    get(paste("nls_411.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_411.", Mod.Sel1, sep ="")) &
                exists(paste("nls_411.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_411.", Mod.Sel1, sep ="")),
                      get(paste("nls_411.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_411 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_411.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_411.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_411.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_411.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_411.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_411.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_411.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_411.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_411)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_411[!is.na(AIC2_411$AIC) & AIC2_411$AIC == min(AIC2_411$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "411",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_411.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_411.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "411",]$ge.variance <- vcov(get(paste("nls_411.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "411",]$phi.variance <- vcov(get(paste("nls_411.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "411",]$alpha.variance <- vcov(get(paste("nls_411.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "411",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "411",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "411",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "411",]$A <- coefs["A"]
nls.param.df_nh[nls.param.df_nh$Code == "411",]$k <- coefs["k"]

nls.param.df_nh[nls.param.df_nh$Code == "411",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "411",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "411",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "411",]$A.2.5 <- intervals_low["A"]
nls.param.df_nh[nls.param.df_nh$Code == "411",]$k.2.5 <- intervals_low["k"]

nls.param.df_nh[nls.param.df_nh$Code == "411",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "411",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "411",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "411",]$A.97.5 <- intervals_high["A"]
nls.param.df_nh[nls.param.df_nh$Code == "411",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_411.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_411.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_411.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_411.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_411$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_411.4 <- nls(f_4, data = G_411, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_411$nls_weights.2), 
 )

## phi
try(
  nls_411.5 <- nls(f_5, data=G_411, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_411$nls_weights.2), 
 )

# phi/alpha
try(
  nls_411.6 <- nls(f_6, data = G_411, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_411$nls_weights.2), 
 )

## test
if(exists("nls_411.4") & exists("nls_411.5") & exists("nls_411.6")){
  print(anova(nls_411.4, nls_411.5, nls_411.6))
} else if(exists("nls_411.4") & exists("nls_411.6")){
  print(anova(nls_411.4, nls_411.6))
} else if(exists("nls_411.5") & exists("nls_411.6")){
  print(anova(nls_411.5, nls_411.6))
} else if(exists("nls_411.4") & exists("nls_411.5")){
  print(anova(nls_411.4, nls_411.5))
}

## AIC comparison
AIC3_411 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_411[AIC2_411$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_411.4"), AIC(get("nls_411.4")), NA),
            ifelse(exists("nls_411.5"), AIC(get("nls_411.5")), NA),
            ifelse(exists("nls_411.6"), AIC(get("nls_411.6")), NA)
            ))

print(AIC3_411) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_411[!is.na(AIC3_411$AIC) & AIC3_411$AIC == min(AIC3_411$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "411",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_nh[Best_mods.P_nh$Code == "411",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_411.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_411.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "411",]$ge.variance <- vcov(get(paste("nls_411.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "411",]$phi.variance <- vcov(get(paste("nls_411.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "411",]$alpha.variance <- vcov(get(paste("nls_411.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "411",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "411",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "411",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "411",]$a <- coefs["a"]
nls.param.df_nh[nls.param.df_nh$Code == "411",]$b <- coefs["b"]
nls.param.df_nh[nls.param.df_nh$Code == "411",]$c <- coefs["c"]
nls.param.df_nh[nls.param.df_nh$Code == "411",]$d <- coefs["d"]

nls.param.df_nh[nls.param.df_nh$Code == "411",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "411",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "411",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "411",]$a.2.5 <- intervals_low["a"]
nls.param.df_nh[nls.param.df_nh$Code == "411",]$b.2.5 <- intervals_low["b"]
nls.param.df_nh[nls.param.df_nh$Code == "411",]$c.2.5 <- intervals_low["c"]
nls.param.df_nh[nls.param.df_nh$Code == "411",]$d.2.5 <- intervals_low["d"]

nls.param.df_nh[nls.param.df_nh$Code == "411",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "411",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "411",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "411",]$a.97.5 <- intervals_high["a"]
nls.param.df_nh[nls.param.df_nh$Code == "411",]$b.97.5 <- intervals_high["b"]
nls.param.df_nh[nls.param.df_nh$Code == "411",]$c.97.5 <- intervals_high["c"]
nls.param.df_nh[nls.param.df_nh$Code == "411",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_411.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_411.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_411.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_411.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_411 <- nlsResiduals(
  get(paste("nls_411.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_411)

## test residuals
if(length(G_411$pltID) < 5001) {test.nlsResiduals(resid_411)}

}   else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## predict model fit
G_411_pred <- predict(get(paste("nls_411.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_411$MEASTIME_t2, na.rm = T), max(G_411$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_411$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_411$MEASTIME_t2, na.rm = T), max(G_411$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_411$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_411$DeltaPDSI, na.rm = T), max(G_411$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_411$MEASTIME_t2, na.rm = T), max(G_411$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_411$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_411$B_L_prop, na.rm = T), max(G_411$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_411$DeltaPDSI, na.rm = T), max(G_411$STDAGE_t2)))
                      } )

G_411_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_411$STDAGE_t2),by = 1),
                            "fitted" =G_411_pred)

## plot
gg.411 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_411, alpha = 0.5, shape ="+", col = "#60606080") +

          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_411,
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res},
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_411))), breaks = cutvec_411) +

          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`),
                      #data = G_411_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +

          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_411_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) +


          theme_classic() +
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"),
               x = "Stand Age (yrs)") +  ggtitle("411 - Intermountain Semi-Desert") +

          #ylim(0, max(G_411_pred_df$`Prop.97.5%` + 0.25)) +
          scale_x_continuous(limits = c(0, max(G_411$STDAGE_t2)), expand = c(0,0))

gg.411

}  else {print("cannot plot data with prediction")}
```

### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_411 <- data.frame(
  bin = as.factor(levels(cut(G_411$STDAGE_t2, cutvec_411))),
  data.mean = tapply(G_411$B_plt_t2_MgHa, cut(G_411$STDAGE_t2, cutvec_411),
                     mean),
  data.CI.high =  tapply(G_411$B_plt_t2_MgHa, cut(G_411$STDAGE_t2, cutvec_411),
                    high.CI),
  data.CI.low = tapply(G_411$B_plt_t2_MgHa, cut(G_411$STDAGE_t2, cutvec_411),
                    low.CI),
  pred.mean = G_411_pred_df[G_411_pred_df$STDAGE_t2 %in% bin_mids_411,]$fitted)

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY
DM_compare_411 <-  DM_compare_411 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_411$bin)[gtools::mixedorder(levels(DM_compare_411$bin))]))

## ggplot
gg.411.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_411) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_411))),
                              labels = levels(DM_compare_411$bin),
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +
           labs(x = expression("observed biomass (Mg ha"^-1*")"),
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("411 -  Everglades",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +
           theme_classic() +
           # xlim(min(DM_compare_411$data.CI.low)-0.25, max(DM_compare_411$data.CI.high)+0.25) +
           # ylim(min(DM_compare_411$pred.CI.low)-0.25, max(DM_compare_411$pred.CI.high)+0.25) +
           theme(legend.position = "top") + tune::coord_obs_pred()

gg.411.B2

}   else {print("cannot plot observed vs. predicted")}
```

## M211 - Adirondack-New England Mixed forest - Coniferous Forest - Alpine Meadow
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_M211 <- round(quantile(G_M211$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M211)))){
  cutvec_M211 <- round(quantile(G_M211$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_M211 <- unname(round(cutvec_M211[-length(cutvec_M211)] + diff(cutvec_M211)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_M211$STDAGE_t2_bin<-  cut(G_M211$STDAGE_t2, cutvec_M211)
## then get bin means
G_M211_bin_means <- tapply(G_M211$B_plt_t2_MgHa, cut(G_M211$STDAGE_t2,  cutvec_M211), mean)

## make column weights.2
G_M211$nls_weights.2 <- as.numeric(1/(G_M211_bin_means[match(G_M211$STDAGE_t2_bin, names(G_M211_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_M211.1 <- nls(f_1, data = G_M211, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_M211$nls_weights.2), 
 )

## phi
try(
  nls_M211.2 <- nls(f_2, data=G_M211, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_M211$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M211.3 <- nls(f_3 , data = G_M211, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_M211$nls_weights.2), 
 )

## test
if(exists("nls_M211.1") & exists("nls_M211.2") & exists("nls_M211.3")){
  print(anova(nls_M211.1, nls_M211.2, nls_M211.3))
} else if(exists("nls_M211.2") & exists("nls_M211.3")){
  print(anova(nls_M211.2, nls_M211.3))
} else if(exists("nls_M211.1") & exists("nls_M211.2")){
  print(anova(nls_M211.1, nls_M211.2))
}
 
## AIC comparison
AIC1_M211 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_M211.1"), AIC(get("nls_M211.1")), NA),
            ifelse(exists("nls_M211.2"), AIC(get("nls_M211.2")), NA),
            ifelse(exists("nls_M211.3"), AIC(get("nls_M211.3")), NA)
            ))

print(AIC1_M211) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M211[!is.na(AIC1_M211$AIC) & AIC1_M211$AIC == min(AIC1_M211$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M211.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_M211.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M211.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_M211.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M211.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M211.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_M211.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_M211.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M211.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M211.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_M211,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_M211$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M211.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_M211,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_M211$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_M211.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_M211,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_M211$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M211.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M211.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M211.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M211.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M211.", Mod.Sel1, sep ="")),
             get(paste("nls_M211.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M211.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M211.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M211.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M211.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M211.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M211.", Mod.Sel1, sep ="")),
               get(paste("nls_M211.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M211.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M211.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M211.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M211.", Mod.Sel1, sep ="")),
                 get(paste("nls_M211.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M211.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M211.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M211.", Mod.Sel1, sep ="")),
                    get(paste("nls_M211.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M211.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M211.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M211.", Mod.Sel1, sep ="")),
                      get(paste("nls_M211.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M211 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M211.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M211.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M211.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M211.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M211.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M211.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M211.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M211.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M211)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M211[!is.na(AIC2_M211$AIC) & AIC2_M211$AIC == min(AIC2_M211$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "M211",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M211.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M211.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "M211",]$ge.variance <- vcov(get(paste("nls_M211.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "M211",]$phi.variance <- vcov(get(paste("nls_M211.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "M211",]$alpha.variance <- vcov(get(paste("nls_M211.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "M211",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M211",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M211",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M211",]$A <- coefs["A"]
nls.param.df_nh[nls.param.df_nh$Code == "M211",]$k <- coefs["k"]

nls.param.df_nh[nls.param.df_nh$Code == "M211",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M211",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M211",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M211",]$A.2.5 <- intervals_low["A"]
nls.param.df_nh[nls.param.df_nh$Code == "M211",]$k.2.5 <- intervals_low["k"]

nls.param.df_nh[nls.param.df_nh$Code == "M211",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M211",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M211",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M211",]$A.97.5 <- intervals_high["A"]
nls.param.df_nh[nls.param.df_nh$Code == "M211",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M211.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M211.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M211.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M211.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_M211$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_M211.4 <- nls(f_4, data = G_M211, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M211$nls_weights.2), 
 )

## phi
try(
  nls_M211.5 <- nls(f_5, data=G_M211, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M211$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M211.6 <- nls(f_6, data = G_M211, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M211$nls_weights.2), 
 )

## test
if(exists("nls_M211.4") & exists("nls_M211.5") & exists("nls_M211.6")){
  print(anova(nls_M211.4, nls_M211.5, nls_M211.6))
} else if(exists("nls_M211.4") & exists("nls_M211.6")){
  print(anova(nls_M211.4, nls_M211.6))
} else if(exists("nls_M211.5") & exists("nls_M211.6")){
  print(anova(nls_M211.5, nls_M211.6))
} else if(exists("nls_M211.4") & exists("nls_M211.5")){
  print(anova(nls_M211.4, nls_M211.5))
}

## AIC comparison
AIC3_M211 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_M211[AIC2_M211$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_M211.4"), AIC(get("nls_M211.4")), NA),
            ifelse(exists("nls_M211.5"), AIC(get("nls_M211.5")), NA),
            ifelse(exists("nls_M211.6"), AIC(get("nls_M211.6")), NA)
            ))

print(AIC3_M211) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_M211[!is.na(AIC3_M211$AIC) & AIC3_M211$AIC == min(AIC3_M211$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "M211",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_nh[Best_mods.P_nh$Code == "M211",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_M211.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M211.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "M211",]$ge.variance <- vcov(get(paste("nls_M211.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "M211",]$phi.variance <- vcov(get(paste("nls_M211.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "M211",]$alpha.variance <- vcov(get(paste("nls_M211.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "M211",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M211",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M211",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M211",]$a <- coefs["a"]
nls.param.df_nh[nls.param.df_nh$Code == "M211",]$b <- coefs["b"]
nls.param.df_nh[nls.param.df_nh$Code == "M211",]$c <- coefs["c"]
nls.param.df_nh[nls.param.df_nh$Code == "M211",]$d <- coefs["d"]

nls.param.df_nh[nls.param.df_nh$Code == "M211",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M211",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M211",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M211",]$a.2.5 <- intervals_low["a"]
nls.param.df_nh[nls.param.df_nh$Code == "M211",]$b.2.5 <- intervals_low["b"]
nls.param.df_nh[nls.param.df_nh$Code == "M211",]$c.2.5 <- intervals_low["c"]
nls.param.df_nh[nls.param.df_nh$Code == "M211",]$d.2.5 <- intervals_low["d"]

nls.param.df_nh[nls.param.df_nh$Code == "M211",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M211",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M211",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M211",]$a.97.5 <- intervals_high["a"]
nls.param.df_nh[nls.param.df_nh$Code == "M211",]$b.97.5 <- intervals_high["b"]
nls.param.df_nh[nls.param.df_nh$Code == "M211",]$c.97.5 <- intervals_high["c"]
nls.param.df_nh[nls.param.df_nh$Code == "M211",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_M211.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_M211.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_M211.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_M211.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_M211 <- nlsResiduals(
  get(paste("nls_M211.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_M211)

## test residuals
if(length(G_M211$pltID) < 5001) {test.nlsResiduals(resid_M211)}

}   else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_M211_pred <- predict(get(paste("nls_M211.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M211$MEASTIME_t2, na.rm = T), max(G_M211$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M211$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M211$MEASTIME_t2, na.rm = T), max(G_M211$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M211$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_M211$DeltaPDSI, na.rm = T), max(G_M211$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M211$MEASTIME_t2, na.rm = T), max(G_M211$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M211$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_M211$B_L_prop, na.rm = T), max(G_M211$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_M211$DeltaPDSI, na.rm = T), max(G_M211$STDAGE_t2)))
                      } )

G_M211_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_M211$STDAGE_t2),by = 1),  
                            "fitted"=G_M211_pred)

## plot
gg.M211 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M211, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M211, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M211))), breaks = cutvec_M211) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_M211_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_M211_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("M211 -  Adirondack-New England Mixed forest - Coniferous Forest - Alpine Meadow") + 
          
          #ylim(0, max(G_M211_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_M211,1)*1.05), expand = c(0,0))

gg.M211

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_M211 <- data.frame(
  bin = as.factor(levels(cut(G_M211$STDAGE_t2, cutvec_M211))),
  data.mean = tapply(G_M211$B_plt_t2_MgHa, cut(G_M211$STDAGE_t2, cutvec_M211), 
                     mean), 
  data.CI.high =  tapply(G_M211$B_plt_t2_MgHa, cut(G_M211$STDAGE_t2, cutvec_M211), 
                    high.CI), 
  data.CI.low = tapply(G_M211$B_plt_t2_MgHa, cut(G_M211$STDAGE_t2, cutvec_M211),
                    low.CI), 
  pred.mean = G_M211_pred_df[G_M211_pred_df$STDAGE_t2 %in% bin_mids_M211,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M211 <-  DM_compare_M211 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M211$bin)[gtools::mixedorder(levels(DM_compare_M211$bin))]))

## ggplot
gg.M211.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M211) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M211))), 
                              labels = levels(DM_compare_M211$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("M211 - Adirondack-New England Mixed forest - Coniferous Forest - Alpine Meadow",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +       
           theme_classic() + 
           # xlim(min(DM_compare_M211$data.CI.low)-0.25, max(DM_compare_M211$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_M211$pred.CI.low)-0.25, max(DM_compare_M211$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M211.B2

}   else {print("cannot plot observed vs. predicted")}
```

## M221 - Eastern Broadleaf Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_M221 <- round(quantile(G_M221$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M221)))){
  cutvec_M221 <- round(quantile(G_M221$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_M221 <- unname(round(cutvec_M221[-length(cutvec_M221)] + diff(cutvec_M221)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_M221$STDAGE_t2_bin<-  cut(G_M221$STDAGE_t2, cutvec_M221)
## then get bin means
G_M221_bin_means <- tapply(G_M221$B_plt_t2_MgHa, cut(G_M221$STDAGE_t2,  cutvec_M221), mean)

## make column weights.2
G_M221$nls_weights.2 <- as.numeric(1/(G_M221_bin_means[match(G_M221$STDAGE_t2_bin, names(G_M221_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_M221.1 <- nls(f_1, data = G_M221, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_M221$nls_weights.2), 
 )

## phi
try(
  nls_M221.2 <- nls(f_2, data=G_M221, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_M221$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M221.3 <- nls(f_3 , data = G_M221, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_M221$nls_weights.2), 
 )

## test
if(exists("nls_M221.1") & exists("nls_M221.2") & exists("nls_M221.3")){
  print(anova(nls_M221.1, nls_M221.2, nls_M221.3))
} else if(exists("nls_M221.2") & exists("nls_M221.3")){
  print(anova(nls_M221.2, nls_M221.3))
} else if(exists("nls_M221.1") & exists("nls_M221.2")){
  print(anova(nls_M221.1, nls_M221.2))
}
 
## AIC comparison
AIC1_M221 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_M221.1"), AIC(get("nls_M221.1")), NA),
            ifelse(exists("nls_M221.2"), AIC(get("nls_M221.2")), NA),
            ifelse(exists("nls_M221.3"), AIC(get("nls_M221.3")), NA)
            ))

print(AIC1_M221) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M221[!is.na(AIC1_M221$AIC) &AIC1_M221$AIC == min(AIC1_M221$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M221.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_M221.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M221.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_M221.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M221.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M221.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_M221.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_M221.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M221.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M221.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_M221,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_M221$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M221.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_M221,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_M221$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_M221.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_M221,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_M221$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M221.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M221.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M221.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M221.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M221.", Mod.Sel1, sep ="")),
             get(paste("nls_M221.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M221.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M221.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M221.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M221.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M221.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M221.", Mod.Sel1, sep ="")),
               get(paste("nls_M221.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M221.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M221.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M221.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M221.", Mod.Sel1, sep ="")),
                 get(paste("nls_M221.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M221.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M221.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M221.", Mod.Sel1, sep ="")),
                    get(paste("nls_M221.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M221.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M221.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M221.", Mod.Sel1, sep ="")),
                      get(paste("nls_M221.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M221 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M221.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M221.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M221.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M221.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M221.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M221.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M221.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M221.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M221)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M221[!is.na(AIC2_M221$AIC) & AIC2_M221$AIC == min(AIC2_M221$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "M221",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M221.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M221.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "M221",]$ge.variance <- vcov(get(paste("nls_M221.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "M221",]$phi.variance <- vcov(get(paste("nls_M221.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "M221",]$alpha.variance <- vcov(get(paste("nls_M221.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "M221",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M221",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M221",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M221",]$A <- coefs["A"]
nls.param.df_nh[nls.param.df_nh$Code == "M221",]$k <- coefs["k"]

nls.param.df_nh[nls.param.df_nh$Code == "M221",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M221",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M221",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M221",]$A.2.5 <- intervals_low["A"]
nls.param.df_nh[nls.param.df_nh$Code == "M221",]$k.2.5 <- intervals_low["k"]

nls.param.df_nh[nls.param.df_nh$Code == "M221",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M221",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M221",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M221",]$A.97.5 <- intervals_high["A"]
nls.param.df_nh[nls.param.df_nh$Code == "M221",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M221.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M221.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M221.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M221.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_M221$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_M221.4 <- nls(f_4, data = G_M221, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M221$nls_weights.2), 
 )

## phi
try(
  nls_M221.5 <- nls(f_5, data=G_M221, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M221$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M221.6 <- nls(f_6, data = G_M221, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M221$nls_weights.2), 
 )

## test
if(exists("nls_M221.4") & exists("nls_M221.5") & exists("nls_M221.6")){
  print(anova(nls_M221.4, nls_M221.5, nls_M221.6))
} else if(exists("nls_M221.4") & exists("nls_M221.6")){
  print(anova(nls_M221.4, nls_M221.6))
} else if(exists("nls_M221.5") & exists("nls_M221.6")){
  print(anova(nls_M221.5, nls_M221.6))
} else if(exists("nls_M221.4") & exists("nls_M221.5")){
  print(anova(nls_M221.4, nls_M221.5))
}

## AIC comparison
AIC3_M221 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_M221[AIC2_M221$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_M221.4"), AIC(get("nls_M221.4")), NA),
            ifelse(exists("nls_M221.5"), AIC(get("nls_M221.5")), NA),
            ifelse(exists("nls_M221.6"), AIC(get("nls_M221.6")), NA)
            ))

print(AIC3_M221) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_M221[!is.na(AIC3_M221$AIC) & AIC3_M221$AIC == min(AIC3_M221$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "M221",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_nh[Best_mods.P_nh$Code == "M221",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_M221.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M221.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "M221",]$ge.variance <- vcov(get(paste("nls_M221.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "M221",]$phi.variance <- vcov(get(paste("nls_M221.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "M221",]$alpha.variance <- vcov(get(paste("nls_M221.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "M221",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M221",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M221",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M221",]$a <- coefs["a"]
nls.param.df_nh[nls.param.df_nh$Code == "M221",]$b <- coefs["b"]
nls.param.df_nh[nls.param.df_nh$Code == "M221",]$c <- coefs["c"]
nls.param.df_nh[nls.param.df_nh$Code == "M221",]$d <- coefs["d"]

nls.param.df_nh[nls.param.df_nh$Code == "M221",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M221",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M221",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M221",]$a.2.5 <- intervals_low["a"]
nls.param.df_nh[nls.param.df_nh$Code == "M221",]$b.2.5 <- intervals_low["b"]
nls.param.df_nh[nls.param.df_nh$Code == "M221",]$c.2.5 <- intervals_low["c"]
nls.param.df_nh[nls.param.df_nh$Code == "M221",]$d.2.5 <- intervals_low["d"]

nls.param.df_nh[nls.param.df_nh$Code == "M221",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M221",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M221",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M221",]$a.97.5 <- intervals_high["a"]
nls.param.df_nh[nls.param.df_nh$Code == "M221",]$b.97.5 <- intervals_high["b"]
nls.param.df_nh[nls.param.df_nh$Code == "M221",]$c.97.5 <- intervals_high["c"]
nls.param.df_nh[nls.param.df_nh$Code == "M221",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_M221.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_M221.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_M221.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_M221.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_M221 <- nlsResiduals(
  get(paste("nls_M221.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_M221)

## test residuals
if(length(G_M221$pltID) < 5001) {test.nlsResiduals(resid_M221)}

}   else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_M221_pred <- predict(get(paste("nls_M221.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M221$MEASTIME_t2, na.rm = T), max(G_M221$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M221$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M221$MEASTIME_t2, na.rm = T), max(G_M221$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M221$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_M221$DeltaPDSI, na.rm = T), max(G_M221$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M221$MEASTIME_t2, na.rm = T), max(G_M221$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M221$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_M221$B_L_prop, na.rm = T), max(G_M221$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_M221$DeltaPDSI, na.rm = T), max(G_M221$STDAGE_t2)))
                      } )

G_M221_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_M221$STDAGE_t2),by = 1),  
                            "fitted"=G_M221_pred)

## plot
gg.M221 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M221, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M221, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M221))), breaks = cutvec_M221) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_M221_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_M221_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("M221 - Eastern Broadleaf Forest") + 
          
          #ylim(0, max(G_M221_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_M221,1)*1.05), expand = c(0,0))

gg.M221

}  else {print("cannot plot data with prediction")}
```

### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_M221 <- data.frame(
  bin = as.factor(levels(cut(G_M221$STDAGE_t2, cutvec_M221))),
  data.mean = tapply(G_M221$B_plt_t2_MgHa, cut(G_M221$STDAGE_t2, cutvec_M221), 
                     mean), 
  data.CI.high =  tapply(G_M221$B_plt_t2_MgHa, cut(G_M221$STDAGE_t2, cutvec_M221), 
                    high.CI), 
  data.CI.low = tapply(G_M221$B_plt_t2_MgHa, cut(G_M221$STDAGE_t2, cutvec_M221),
                    low.CI), 
  pred.mean = G_M221_pred_df[G_M221_pred_df$STDAGE_t2 %in% bin_mids_M221,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M221 <-  DM_compare_M221 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M221$bin)[gtools::mixedorder(levels(DM_compare_M221$bin))]))

## ggplot
gg.M221.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M221) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M221))), 
                              labels = levels(DM_compare_M221$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("M221 - Eastern Broadleaf Forest",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +        
           theme_classic() + 
           # xlim(min(DM_compare_M221$data.CI.low)-0.25, max(DM_compare_M221$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_M221$pred.CI.low)-0.25, max(DM_compare_M221$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M221.B2

}   else {print("cannot plot observed vs. predicted")}
```

## M223 - Ozark Broadleaf Forest Meadow
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_M223 <- round(quantile(G_M223$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M223)))){
  cutvec_M223 <- round(quantile(G_M223$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_M223 <- unname(round(cutvec_M223[-length(cutvec_M223)] + diff(cutvec_M223)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_M223$STDAGE_t2_bin<-  cut(G_M223$STDAGE_t2, cutvec_M223)
## then get bin means
G_M223_bin_means <- tapply(G_M223$B_plt_t2_MgHa, cut(G_M223$STDAGE_t2,  cutvec_M223), mean)

## make column weights.2
G_M223$nls_weights.2 <- as.numeric(1/(G_M223_bin_means[match(G_M223$STDAGE_t2_bin, names(G_M223_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_M223.1 <- nls(f_1, data = G_M223, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_M223$nls_weights.2), 
 )

## phi
try(
  nls_M223.2 <- nls(f_2, data=G_M223, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_M223$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M223.3 <- nls(f_3 , data = G_M223, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_M223$nls_weights.2), 
 )

## test
if(exists("nls_M223.1") & exists("nls_M223.2") & exists("nls_M223.3")){
  print(anova(nls_M223.1, nls_M223.2, nls_M223.3))
} else if(exists("nls_M223.2") & exists("nls_M223.3")){
  print(anova(nls_M223.2, nls_M223.3))
} else if(exists("nls_M223.1") & exists("nls_M223.2")){
  print(anova(nls_M223.1, nls_M223.2))
}
 
## AIC comparison
AIC1_M223 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_M223.1"), AIC(get("nls_M223.1")), NA),
            ifelse(exists("nls_M223.2"), AIC(get("nls_M223.2")), NA),
            ifelse(exists("nls_M223.3"), AIC(get("nls_M223.3")), NA)
            ))

print(AIC1_M223) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M223[!is.na(AIC1_M223$AIC) & AIC1_M223$AIC == min(AIC1_M223$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M223.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_M223.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M223.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_M223.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M223.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M223.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_M223.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_M223.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M223.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M223.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_M223,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_M223$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M223.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_M223,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_M223$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_M223.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_M223,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_M223$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M223.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M223.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M223.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M223.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M223.", Mod.Sel1, sep ="")),
             get(paste("nls_M223.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M223.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M223.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M223.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M223.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M223.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M223.", Mod.Sel1, sep ="")),
               get(paste("nls_M223.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M223.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M223.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M223.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M223.", Mod.Sel1, sep ="")),
                 get(paste("nls_M223.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M223.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M223.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M223.", Mod.Sel1, sep ="")),
                    get(paste("nls_M223.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M223.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M223.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M223.", Mod.Sel1, sep ="")),
                      get(paste("nls_M223.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M223 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M223.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M223.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M223.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M223.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M223.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M223.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M223.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M223.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M223)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M223[!is.na(AIC2_M223$AIC) & AIC2_M223$AIC == min(AIC2_M223$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "M223",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M223.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M223.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "M223",]$ge.variance <- vcov(get(paste("nls_M223.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "M223",]$phi.variance <- vcov(get(paste("nls_M223.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "M223",]$alpha.variance <- vcov(get(paste("nls_M223.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "M223",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M223",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M223",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M223",]$A <- coefs["A"]
nls.param.df_nh[nls.param.df_nh$Code == "M223",]$k <- coefs["k"]

nls.param.df_nh[nls.param.df_nh$Code == "M223",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M223",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M223",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M223",]$A.2.5 <- intervals_low["A"]
nls.param.df_nh[nls.param.df_nh$Code == "M223",]$k.2.5 <- intervals_low["k"]

nls.param.df_nh[nls.param.df_nh$Code == "M223",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M223",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M223",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M223",]$A.97.5 <- intervals_high["A"]
nls.param.df_nh[nls.param.df_nh$Code == "M223",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M223.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M223.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M223.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M223.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_M223$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_M223.4 <- nls(f_4, data = G_M223, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M223$nls_weights.2), 
 )

## phi
try(
  nls_M223.5 <- nls(f_5, data=G_M223, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M223$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M223.6 <- nls(f_6, data = G_M223, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M223$nls_weights.2), 
 )

## test
if(exists("nls_M223.4") & exists("nls_M223.5") & exists("nls_M223.6")){
  print(anova(nls_M223.4, nls_M223.5, nls_M223.6))
} else if(exists("nls_M223.4") & exists("nls_M223.6")){
  print(anova(nls_M223.4, nls_M223.6))
} else if(exists("nls_M223.5") & exists("nls_M223.6")){
  print(anova(nls_M223.5, nls_M223.6))
} else if(exists("nls_M223.4") & exists("nls_M223.5")){
  print(anova(nls_M223.4, nls_M223.5))
}

## AIC comparison
AIC3_M223 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_M223[AIC2_M223$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_M223.4"), AIC(get("nls_M223.4")), NA),
            ifelse(exists("nls_M223.5"), AIC(get("nls_M223.5")), NA),
            ifelse(exists("nls_M223.6"), AIC(get("nls_M223.6")), NA)
            ))

print(AIC3_M223) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_M223[!is.na(AIC3_M223$AIC) & AIC3_M223$AIC == min(AIC3_M223$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "M223",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_nh[Best_mods.P_nh$Code == "M223",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_M223.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M223.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "M223",]$ge.variance <- vcov(get(paste("nls_M223.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "M223",]$phi.variance <- vcov(get(paste("nls_M223.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "M223",]$alpha.variance <- vcov(get(paste("nls_M223.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "M223",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M223",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M223",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M223",]$a <- coefs["a"]
nls.param.df_nh[nls.param.df_nh$Code == "M223",]$b <- coefs["b"]
nls.param.df_nh[nls.param.df_nh$Code == "M223",]$c <- coefs["c"]
nls.param.df_nh[nls.param.df_nh$Code == "M223",]$d <- coefs["d"]

nls.param.df_nh[nls.param.df_nh$Code == "M223",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M223",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M223",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M223",]$a.2.5 <- intervals_low["a"]
nls.param.df_nh[nls.param.df_nh$Code == "M223",]$b.2.5 <- intervals_low["b"]
nls.param.df_nh[nls.param.df_nh$Code == "M223",]$c.2.5 <- intervals_low["c"]
nls.param.df_nh[nls.param.df_nh$Code == "M223",]$d.2.5 <- intervals_low["d"]

nls.param.df_nh[nls.param.df_nh$Code == "M223",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M223",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M223",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M223",]$a.97.5 <- intervals_high["a"]
nls.param.df_nh[nls.param.df_nh$Code == "M223",]$b.97.5 <- intervals_high["b"]
nls.param.df_nh[nls.param.df_nh$Code == "M223",]$c.97.5 <- intervals_high["c"]
nls.param.df_nh[nls.param.df_nh$Code == "M223",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_M223.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_M223.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_M223.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_M223.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_M223 <- nlsResiduals(
  get(paste("nls_M223.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_M223)

## test residuals
if(length(G_M223$pltID) < 5001) {test.nlsResiduals(resid_M223)}

}   else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_M223_pred <- predict(get(paste("nls_M223.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M223$MEASTIME_t2, na.rm = T), max(G_M223$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M223$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M223$MEASTIME_t2, na.rm = T), max(G_M223$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M223$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_M223$DeltaPDSI, na.rm = T), max(G_M223$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M223$MEASTIME_t2, na.rm = T), max(G_M223$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M223$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_M223$B_L_prop, na.rm = T), max(G_M223$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_M223$DeltaPDSI, na.rm = T), max(G_M223$STDAGE_t2)))
                      } )

G_M223_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_M223$STDAGE_t2),by = 1),  
                            "fitted"=G_M223_pred)

## plot
gg.M223 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M223, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M223, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M223))), breaks = cutvec_M223) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_M223_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_M223_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("M223 - Ozark Broadleaf Forest Meadow") + 
          
          #ylim(0, max(G_M223_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_M223,1)*1.05), expand = c(0,0))

gg.M223

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_M223 <- data.frame(
  bin = as.factor(levels(cut(G_M223$STDAGE_t2, cutvec_M223))),
  data.mean = tapply(G_M223$B_plt_t2_MgHa, cut(G_M223$STDAGE_t2, cutvec_M223), 
                     mean), 
  data.CI.high =  tapply(G_M223$B_plt_t2_MgHa, cut(G_M223$STDAGE_t2, cutvec_M223), 
                    high.CI), 
  data.CI.low = tapply(G_M223$B_plt_t2_MgHa, cut(G_M223$STDAGE_t2, cutvec_M223),
                    low.CI), 
  pred.mean = G_M223_pred_df[G_M223_pred_df$STDAGE_t2 %in% bin_mids_M223,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M223 <-  DM_compare_M223 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M223$bin)[gtools::mixedorder(levels(DM_compare_M223$bin))]))

## ggplot
gg.M223.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M223) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M223))), 
                              labels = levels(DM_compare_M223$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("M223 - Ozark Broadleaf Forest Meadow",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +       
           theme_classic() + 
           # xlim(min(DM_compare_M223$data.CI.low)-0.25, max(DM_compare_M223$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_M223$pred.CI.low)-0.25, max(DM_compare_M223$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M223.B2

}   else {print("cannot plot observed vs. predicted")}
```

## M231 - Ouachita Mixed Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_M231 <- round(quantile(G_M231$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M231)))){
  cutvec_M231 <- round(quantile(G_M231$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_M231 <- unname(round(cutvec_M231[-length(cutvec_M231)] + diff(cutvec_M231)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_M231$STDAGE_t2_bin<-  cut(G_M231$STDAGE_t2, cutvec_M231)
## then get bin means
G_M231_bin_means <- tapply(G_M231$B_plt_t2_MgHa, cut(G_M231$STDAGE_t2, cutvec_M231), mean)

## make column weights.2
G_M231$nls_weights.2 <- as.numeric(1/(G_M231_bin_means[match(G_M231$STDAGE_t2_bin, names(G_M231_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_M231.1 <- nls(f_1, data = G_M231, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_M231$nls_weights.2), 
 )

## phi
try(
  nls_M231.2 <- nls(f_2, data=G_M231, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_M231$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M231.3 <- nls(f_3 , data = G_M231, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_M231$nls_weights.2), 
 )

## test
if(exists("nls_M231.1") & exists("nls_M231.2") & exists("nls_M231.3")){
  print(anova(nls_M231.1, nls_M231.2, nls_M231.3))
} else if(exists("nls_M231.2") & exists("nls_M231.3")){
  print(anova(nls_M231.2, nls_M231.3))
} else if(exists("nls_M231.1") & exists("nls_M231.2")){
  print(anova(nls_M231.1, nls_M231.2))
}
 
## AIC comparison
AIC1_M231 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_M231.1"), AIC(get("nls_M231.1")), NA),
            ifelse(exists("nls_M231.2"), AIC(get("nls_M231.2")), NA),
            ifelse(exists("nls_M231.3"), AIC(get("nls_M231.3")), NA)
            ))

print(AIC1_M231) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M231[!is.na(AIC1_M231$AIC) & AIC1_M231$AIC == min(AIC1_M231$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M231.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_M231.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M231.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_M231.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M231.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M231.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_M231.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_M231.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M231.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M231.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_M231,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_M231$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M231.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_M231,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_M231$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_M231.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_M231,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_M231$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M231.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M231.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M231.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M231.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M231.", Mod.Sel1, sep ="")),
             get(paste("nls_M231.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M231.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M231.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M231.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M231.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M231.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M231.", Mod.Sel1, sep ="")),
               get(paste("nls_M231.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M231.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M231.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M231.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M231.", Mod.Sel1, sep ="")),
                 get(paste("nls_M231.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M231.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M231.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M231.", Mod.Sel1, sep ="")),
                    get(paste("nls_M231.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M231.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M231.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M231.", Mod.Sel1, sep ="")),
                      get(paste("nls_M231.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M231 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M231.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M231.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M231.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M231.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M231.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M231.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M231.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M231.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M231)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M231[!is.na(AIC2_M231$AIC) & AIC2_M231$AIC == min(AIC2_M231$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "M231",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M231.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M231.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "M231",]$ge.variance <- vcov(get(paste("nls_M231.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "M231",]$phi.variance <- vcov(get(paste("nls_M231.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "M231",]$alpha.variance <- vcov(get(paste("nls_M231.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "M231",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M231",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M231",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M231",]$A <- coefs["A"]
nls.param.df_nh[nls.param.df_nh$Code == "M231",]$k <- coefs["k"]

nls.param.df_nh[nls.param.df_nh$Code == "M231",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M231",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M231",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M231",]$A.2.5 <- intervals_low["A"]
nls.param.df_nh[nls.param.df_nh$Code == "M231",]$k.2.5 <- intervals_low["k"]

nls.param.df_nh[nls.param.df_nh$Code == "M231",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M231",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M231",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M231",]$A.97.5 <- intervals_high["A"]
nls.param.df_nh[nls.param.df_nh$Code == "M231",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M231.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M231.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M231.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M231.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_M231$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_M231.4 <- nls(f_4, data = G_M231, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M231$nls_weights.2), 
 )

## phi
try(
  nls_M231.5 <- nls(f_5, data=G_M231, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M231$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M231.6 <- nls(f_6, data = G_M231, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M231$nls_weights.2), 
 )

## test
if(exists("nls_M231.4") & exists("nls_M231.5") & exists("nls_M231.6")){
  print(anova(nls_M231.4, nls_M231.5, nls_M231.6))
} else if(exists("nls_M231.4") & exists("nls_M231.6")){
  print(anova(nls_M231.4, nls_M231.6))
} else if(exists("nls_M231.5") & exists("nls_M231.6")){
  print(anova(nls_M231.5, nls_M231.6))
} else if(exists("nls_M231.4") & exists("nls_M231.5")){
  print(anova(nls_M231.4, nls_M231.5))
}

## AIC comparison
AIC3_M231 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_M231[AIC2_M231$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_M231.4"), AIC(get("nls_M231.4")), NA),
            ifelse(exists("nls_M231.5"), AIC(get("nls_M231.5")), NA),
            ifelse(exists("nls_M231.6"), AIC(get("nls_M231.6")), NA)
            ))

print(AIC3_M231) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_M231[!is.na(AIC3_M231$AIC) & AIC3_M231$AIC == min(AIC3_M231$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "M231",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_nh[Best_mods.P_nh$Code == "M231",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_M231.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M231.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "M231",]$ge.variance <- vcov(get(paste("nls_M231.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "M231",]$phi.variance <- vcov(get(paste("nls_M231.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "M231",]$alpha.variance <- vcov(get(paste("nls_M231.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "M231",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M231",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M231",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M231",]$a <- coefs["a"]
nls.param.df_nh[nls.param.df_nh$Code == "M231",]$b <- coefs["b"]
nls.param.df_nh[nls.param.df_nh$Code == "M231",]$c <- coefs["c"]
nls.param.df_nh[nls.param.df_nh$Code == "M231",]$d <- coefs["d"]

nls.param.df_nh[nls.param.df_nh$Code == "M231",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M231",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M231",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M231",]$a.2.5 <- intervals_low["a"]
nls.param.df_nh[nls.param.df_nh$Code == "M231",]$b.2.5 <- intervals_low["b"]
nls.param.df_nh[nls.param.df_nh$Code == "M231",]$c.2.5 <- intervals_low["c"]
nls.param.df_nh[nls.param.df_nh$Code == "M231",]$d.2.5 <- intervals_low["d"]

nls.param.df_nh[nls.param.df_nh$Code == "M231",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M231",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M231",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M231",]$a.97.5 <- intervals_high["a"]
nls.param.df_nh[nls.param.df_nh$Code == "M231",]$b.97.5 <- intervals_high["b"]
nls.param.df_nh[nls.param.df_nh$Code == "M231",]$c.97.5 <- intervals_high["c"]
nls.param.df_nh[nls.param.df_nh$Code == "M231",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_M231.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_M231.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_M231.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_M231.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_M231 <- nlsResiduals(
  get(paste("nls_M231.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_M231)

## test residuals
if(length(G_M231$pltID) < 5001) {test.nlsResiduals(resid_M231)}

}  else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_M231_pred <- predict(get(paste("nls_M231.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M231$MEASTIME_t2, na.rm = T), max(G_M231$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M231$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M231$MEASTIME_t2, na.rm = T), max(G_M231$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M231$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_M231$DeltaPDSI, na.rm = T), max(G_M231$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M231$MEASTIME_t2, na.rm = T), max(G_M231$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M231$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_M231$B_L_prop, na.rm = T), max(G_M231$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_M231$DeltaPDSI, na.rm = T), max(G_M231$STDAGE_t2)))
                      } )

G_M231_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_M231$STDAGE_t2),by = 1),  
                            "fitted"=G_M231_pred)

## plot
gg.M231 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M231, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M231, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M231))), breaks = cutvec_M231) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_M231_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_M231_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("M231 - Ouachita Mixed Forest") + 
          
          #ylim(0, max(G_M231_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_M231,1)*1.05), expand = c(0,0))

gg.M231

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_M231 <- data.frame(
  bin = as.factor(levels(cut(G_M231$STDAGE_t2, cutvec_M231))),
  data.mean = tapply(G_M231$B_plt_t2_MgHa, cut(G_M231$STDAGE_t2, cutvec_M231), 
                     mean), 
  data.CI.high =  tapply(G_M231$B_plt_t2_MgHa, cut(G_M231$STDAGE_t2, cutvec_M231), 
                    high.CI), 
  data.CI.low = tapply(G_M231$B_plt_t2_MgHa, cut(G_M231$STDAGE_t2, cutvec_M231),
                    low.CI), 
  pred.mean = G_M231_pred_df[G_M231_pred_df$STDAGE_t2 %in% bin_mids_M231,]$fitted) 
 
### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M231 <-  DM_compare_M231 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M231$bin)[gtools::mixedorder(levels(DM_compare_M231$bin))]))

## ggplot
gg.M231.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M231) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M231))), 
                              labels = levels(DM_compare_M231$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("M231 - Ouachita Mixed Forest",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +        
           theme_classic() + 
           # xlim(min(DM_compare_M231$data.CI.low)-0.25, max(DM_compare_M231$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_M231$pred.CI.low)-0.25, max(DM_compare_M231$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M231.B2

}   else {print("cannot plot observed vs. predicted")}
```

## M242 - Cascade Mixed Forest
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_M242 <- round(quantile(G_M242$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M242)))){
  cutvec_M242 <- round(quantile(G_M242$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_M242 <- unname(round(cutvec_M242[-length(cutvec_M242)] + diff(cutvec_M242)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_M242$STDAGE_t2_bin<-  cut(G_M242$STDAGE_t2, cutvec_M242)
## then get bin means
G_M242_bin_means <- tapply(G_M242$B_plt_t2_MgHa, cut(G_M242$STDAGE_t2, cutvec_M242), mean)

## make column weights.2
G_M242$nls_weights.2 <- as.numeric(1/(G_M242_bin_means[match(G_M242$STDAGE_t2_bin, names(G_M242_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_M242.1 <- nls(f_1, data = G_M242, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_M242$nls_weights.2), 
 )

## phi
try(
  nls_M242.2 <- nls(f_2, data=G_M242, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_M242$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M242.3 <- nls(f_3 , data = G_M242, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_M242$nls_weights.2), 
 )

## test
if(exists("nls_M242.1") & exists("nls_M242.2") & exists("nls_M242.3")){
  print(anova(nls_M242.1, nls_M242.2, nls_M242.3))
} else if(exists("nls_M242.2") & exists("nls_M242.3")){
  print(anova(nls_M242.2, nls_M242.3))
} else if(exists("nls_M242.1") & exists("nls_M242.2")){
  print(anova(nls_M242.1, nls_M242.2))
}
 
## AIC comparison
AIC1_M242 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_M242.1"), AIC(get("nls_M242.1")), NA),
            ifelse(exists("nls_M242.2"), AIC(get("nls_M242.2")), NA),
            ifelse(exists("nls_M242.3"), AIC(get("nls_M242.3")), NA)
            ))

print(AIC1_M242) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M242[!is.na(AIC1_M242$AIC) & AIC1_M242$AIC == min(AIC1_M242$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M242.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_M242.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M242.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_M242.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M242.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M242.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_M242.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_M242.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M242.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M242.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_M242,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_M242$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M242.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_M242,
         start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_M242$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_M242.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_M242,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
				
          weights = G_M242$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M242.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M242.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M242.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M242.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M242.", Mod.Sel1, sep ="")),
             get(paste("nls_M242.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M242.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M242.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M242.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M242.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M242.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M242.", Mod.Sel1, sep ="")),
               get(paste("nls_M242.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M242.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M242.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M242.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M242.", Mod.Sel1, sep ="")),
                 get(paste("nls_M242.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M242.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M242.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M242.", Mod.Sel1, sep ="")),
                    get(paste("nls_M242.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M242.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M242.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M242.", Mod.Sel1, sep ="")),
                      get(paste("nls_M242.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M242 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M242.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M242.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M242.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M242.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M242.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M242.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M242.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M242.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M242)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M242[!is.na(AIC2_M242$AIC) & AIC2_M242$AIC == min(AIC2_M242$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "M242",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M242.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M242.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "M242",]$ge.variance <- vcov(get(paste("nls_M242.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "M242",]$phi.variance <- vcov(get(paste("nls_M242.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "M242",]$alpha.variance <- vcov(get(paste("nls_M242.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "M242",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M242",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M242",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M242",]$A <- coefs["A"]
nls.param.df_nh[nls.param.df_nh$Code == "M242",]$k <- coefs["k"]

nls.param.df_nh[nls.param.df_nh$Code == "M242",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M242",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M242",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M242",]$A.2.5 <- intervals_low["A"]
nls.param.df_nh[nls.param.df_nh$Code == "M242",]$k.2.5 <- intervals_low["k"]

nls.param.df_nh[nls.param.df_nh$Code == "M242",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M242",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M242",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M242",]$A.97.5 <- intervals_high["A"]
nls.param.df_nh[nls.param.df_nh$Code == "M242",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M242.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M242.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M242.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M242.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_M242$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_M242.4 <- nls(f_4, data = G_M242, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M242$nls_weights.2), 
 )

## phi
try(
  nls_M242.5 <- nls(f_5, data=G_M242, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M242$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M242.6 <- nls(f_6, data = G_M242, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M242$nls_weights.2), 
 )

## test
if(exists("nls_M242.4") & exists("nls_M242.5") & exists("nls_M242.6")){
  print(anova(nls_M242.4, nls_M242.5, nls_M242.6))
} else if(exists("nls_M242.4") & exists("nls_M242.6")){
  print(anova(nls_M242.4, nls_M242.6))
} else if(exists("nls_M242.5") & exists("nls_M242.6")){
  print(anova(nls_M242.5, nls_M242.6))
} else if(exists("nls_M242.4") & exists("nls_M242.5")){
  print(anova(nls_M242.4, nls_M242.5))
}

## AIC comparison
AIC3_M242 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_M242[AIC2_M242$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_M242.4"), AIC(get("nls_M242.4")), NA),
            ifelse(exists("nls_M242.5"), AIC(get("nls_M242.5")), NA),
            ifelse(exists("nls_M242.6"), AIC(get("nls_M242.6")), NA)
            ))

print(AIC3_M242) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_M242[!is.na(AIC3_M242$AIC) & AIC3_M242$AIC == min(AIC3_M242$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "M242",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_nh[Best_mods.P_nh$Code == "M242",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_M242.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M242.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "M242",]$ge.variance <- vcov(get(paste("nls_M242.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "M242",]$phi.variance <- vcov(get(paste("nls_M242.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "M242",]$alpha.variance <- vcov(get(paste("nls_M242.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "M242",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M242",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M242",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M242",]$a <- coefs["a"]
nls.param.df_nh[nls.param.df_nh$Code == "M242",]$b <- coefs["b"]
nls.param.df_nh[nls.param.df_nh$Code == "M242",]$c <- coefs["c"]
nls.param.df_nh[nls.param.df_nh$Code == "M242",]$d <- coefs["d"]

nls.param.df_nh[nls.param.df_nh$Code == "M242",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M242",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M242",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M242",]$a.2.5 <- intervals_low["a"]
nls.param.df_nh[nls.param.df_nh$Code == "M242",]$b.2.5 <- intervals_low["b"]
nls.param.df_nh[nls.param.df_nh$Code == "M242",]$c.2.5 <- intervals_low["c"]
nls.param.df_nh[nls.param.df_nh$Code == "M242",]$d.2.5 <- intervals_low["d"]

nls.param.df_nh[nls.param.df_nh$Code == "M242",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M242",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M242",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M242",]$a.97.5 <- intervals_high["a"]
nls.param.df_nh[nls.param.df_nh$Code == "M242",]$b.97.5 <- intervals_high["b"]
nls.param.df_nh[nls.param.df_nh$Code == "M242",]$c.97.5 <- intervals_high["c"]
nls.param.df_nh[nls.param.df_nh$Code == "M242",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_M242.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_M242.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_M242.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_M242.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_M242 <- nlsResiduals(
  get(paste("nls_M242.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_M242)

## test residuals
if(length(G_M242$pltID) < 5001) {test.nlsResiduals(resid_M242)}
 
}   else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_M242_pred <- predict(get(paste("nls_M242.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M242$MEASTIME_t2, na.rm = T), max(G_M242$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M242$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M242$MEASTIME_t2, na.rm = T), max(G_M242$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M242$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_M242$DeltaPDSI, na.rm = T), max(G_M242$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M242$MEASTIME_t2, na.rm = T), max(G_M242$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M242$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_M242$B_L_prop, na.rm = T), max(G_M242$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_M242$DeltaPDSI, na.rm = T), max(G_M242$STDAGE_t2)))
                      } )

G_M242_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_M242$STDAGE_t2),by = 1),  
                            "fitted"=G_M242_pred)

## plot
gg.M242 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M242, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M242, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M242))), breaks = cutvec_M242) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_M242_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_M242_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("M242 - Cascade Mixed Forest") + 
          
          #ylim(0, max(G_M242_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_M242,1)*1.05), expand = c(0,0))

gg.M242

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_M242 <- data.frame(
  bin = as.factor(levels(cut(G_M242$STDAGE_t2, cutvec_M242))),
  data.mean = tapply(G_M242$B_plt_t2_MgHa, cut(G_M242$STDAGE_t2, cutvec_M242), 
                     mean), 
  data.CI.high =  tapply(G_M242$B_plt_t2_MgHa, cut(G_M242$STDAGE_t2, cutvec_M242), 
                    high.CI), 
  data.CI.low = tapply(G_M242$B_plt_t2_MgHa, cut(G_M242$STDAGE_t2, cutvec_M242),
                    low.CI), 
  pred.mean = G_M242_pred_df[G_M242_pred_df$STDAGE_t2 %in% bin_mids_M242,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M242 <-  DM_compare_M242 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M242$bin)[gtools::mixedorder(levels(DM_compare_M242$bin))]))

## ggplot
gg.M242.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M242) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M242))), 
                              labels = levels(DM_compare_M242$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("M242 - Cascade Mixed Forest",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +        
           theme_classic() + 
           # xlim(min(DM_compare_M242$data.CI.low)-0.25, max(DM_compare_M242$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_M242$pred.CI.low)-0.25, max(DM_compare_M242$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M242.B2

}   else {print("cannot plot observed vs. predicted")}
```

## M261 - Sierran Steppe - Mixed Forest - Coniferous Forest - Alpine Meadow
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_M261 <- round(quantile(G_M261$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M261)))){
  cutvec_M261 <- round(quantile(G_M261$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_M261 <- unname(round(cutvec_M261[-length(cutvec_M261)] + diff(cutvec_M261)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_M261$STDAGE_t2_bin<-  cut(G_M261$STDAGE_t2, cutvec_M261)
## then get bin means
G_M261_bin_means <- tapply(G_M261$B_plt_t2_MgHa, cut(G_M261$STDAGE_t2,  cutvec_M261), mean)

## make column weights.2
G_M261$nls_weights.2 <- as.numeric(1/(G_M261_bin_means[match(G_M261$STDAGE_t2_bin, names(G_M261_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_M261.1 <- nls(f_1, data = G_M261, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_M261$nls_weights.2), 
 )

## phi
try(
  nls_M261.2 <- nls(f_2, data=G_M261, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_M261$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M261.3 <- nls(f_3 , data = G_M261, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_M261$nls_weights.2), 
 )

## test
if(exists("nls_M261.1") & exists("nls_M261.2") & exists("nls_M261.3")){
  print(anova(nls_M261.1, nls_M261.2, nls_M261.3))
} else if(exists("nls_M261.2") & exists("nls_M261.3")){
  print(anova(nls_M261.2, nls_M261.3))
} else if(exists("nls_M261.1") & exists("nls_M261.2")){
  print(anova(nls_M261.1, nls_M261.2))
}
 
## AIC comparison
AIC1_M261 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_M261.1"), AIC(get("nls_M261.1")), NA),
            ifelse(exists("nls_M261.2"), AIC(get("nls_M261.2")), NA),
            ifelse(exists("nls_M261.3"), AIC(get("nls_M261.3")), NA)
            ))

print(AIC1_M261) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M261[!is.na(AIC1_M261$AIC) & AIC1_M261$AIC == min(AIC1_M261$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M261.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_M261.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M261.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_M261.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M261.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M261.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_M261.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_M261.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M261.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M261.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_M261,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_M261$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M261.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_M261,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_M261$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_M261.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_M261,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_M261$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M261.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M261.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M261.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M261.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M261.", Mod.Sel1, sep ="")),
             get(paste("nls_M261.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M261.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M261.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M261.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M261.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M261.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M261.", Mod.Sel1, sep ="")),
               get(paste("nls_M261.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M261.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M261.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M261.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M261.", Mod.Sel1, sep ="")),
                 get(paste("nls_M261.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M261.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M261.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M261.", Mod.Sel1, sep ="")),
                    get(paste("nls_M261.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M261.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M261.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M261.", Mod.Sel1, sep ="")),
                      get(paste("nls_M261.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M261 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M261.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M261.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M261.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M261.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M261.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M261.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M261.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M261.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M261)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M261[!is.na(AIC2_M261$AIC) & AIC2_M261$AIC == min(AIC2_M261$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "M261",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M261.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M261.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "M261",]$ge.variance <- vcov(get(paste("nls_M261.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "M261",]$phi.variance <- vcov(get(paste("nls_M261.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "M261",]$alpha.variance <- vcov(get(paste("nls_M261.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "M261",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M261",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M261",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M261",]$A <- coefs["A"]
nls.param.df_nh[nls.param.df_nh$Code == "M261",]$k <- coefs["k"]

nls.param.df_nh[nls.param.df_nh$Code == "M261",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M261",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M261",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M261",]$A.2.5 <- intervals_low["A"]
nls.param.df_nh[nls.param.df_nh$Code == "M261",]$k.2.5 <- intervals_low["k"]

nls.param.df_nh[nls.param.df_nh$Code == "M261",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M261",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M261",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M261",]$A.97.5 <- intervals_high["A"]
nls.param.df_nh[nls.param.df_nh$Code == "M261",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M261.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M261.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M261.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M261.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_M261$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_M261.4 <- nls(f_4, data = G_M261, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M261$nls_weights.2), 
 )

## phi
try(
  nls_M261.5 <- nls(f_5, data=G_M261, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M261$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M261.6 <- nls(f_6, data = G_M261, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M261$nls_weights.2), 
 )

## test
if(exists("nls_M261.4") & exists("nls_M261.5") & exists("nls_M261.6")){
  print(anova(nls_M261.4, nls_M261.5, nls_M261.6))
} else if(exists("nls_M261.4") & exists("nls_M261.6")){
  print(anova(nls_M261.4, nls_M261.6))
} else if(exists("nls_M261.5") & exists("nls_M261.6")){
  print(anova(nls_M261.5, nls_M261.6))
} else if(exists("nls_M261.4") & exists("nls_M261.5")){
  print(anova(nls_M261.4, nls_M261.5))
}

## AIC comparison
AIC3_M261 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_M261[AIC2_M261$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_M261.4"), AIC(get("nls_M261.4")), NA),
            ifelse(exists("nls_M261.5"), AIC(get("nls_M261.5")), NA),
            ifelse(exists("nls_M261.6"), AIC(get("nls_M261.6")), NA)
            ))

print(AIC3_M261) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_M261[!is.na(AIC3_M261$AIC) & AIC3_M261$AIC == min(AIC3_M261$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "M261",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_nh[Best_mods.P_nh$Code == "M261",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_M261.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M261.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "M261",]$ge.variance <- vcov(get(paste("nls_M261.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "M261",]$phi.variance <- vcov(get(paste("nls_M261.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "M261",]$alpha.variance <- vcov(get(paste("nls_M261.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "M261",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M261",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M261",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M261",]$a <- coefs["a"]
nls.param.df_nh[nls.param.df_nh$Code == "M261",]$b <- coefs["b"]
nls.param.df_nh[nls.param.df_nh$Code == "M261",]$c <- coefs["c"]
nls.param.df_nh[nls.param.df_nh$Code == "M261",]$d <- coefs["d"]

nls.param.df_nh[nls.param.df_nh$Code == "M261",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M261",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M261",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M261",]$a.2.5 <- intervals_low["a"]
nls.param.df_nh[nls.param.df_nh$Code == "M261",]$b.2.5 <- intervals_low["b"]
nls.param.df_nh[nls.param.df_nh$Code == "M261",]$c.2.5 <- intervals_low["c"]
nls.param.df_nh[nls.param.df_nh$Code == "M261",]$d.2.5 <- intervals_low["d"]

nls.param.df_nh[nls.param.df_nh$Code == "M261",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M261",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M261",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M261",]$a.97.5 <- intervals_high["a"]
nls.param.df_nh[nls.param.df_nh$Code == "M261",]$b.97.5 <- intervals_high["b"]
nls.param.df_nh[nls.param.df_nh$Code == "M261",]$c.97.5 <- intervals_high["c"]
nls.param.df_nh[nls.param.df_nh$Code == "M261",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_M261.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_M261.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_M261.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_M261.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_M261 <- nlsResiduals(
  get(paste("nls_M261.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_M261)

## test residuals
if(length(G_M261$pltID) < 5001) {test.nlsResiduals(resid_M261)}

}   else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_M261_pred <- predict(get(paste("nls_M261.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M261$MEASTIME_t2, na.rm = T), max(G_M261$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M261$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M261$MEASTIME_t2, na.rm = T), max(G_M261$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M261$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_M261$DeltaPDSI, na.rm = T), max(G_M261$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M261$MEASTIME_t2, na.rm = T), max(G_M261$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M261$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_M261$B_L_prop, na.rm = T), max(G_M261$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_M261$DeltaPDSI, na.rm = T), max(G_M261$STDAGE_t2)))
                      } )

G_M261_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_M261$STDAGE_t2),by = 1),  
                            "fitted"=G_M261_pred)

## plot
gg.M261 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M261, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M261, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M261))), breaks = cutvec_M261) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_M261_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_M261_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("M261 - Sierran Steppe - Mixed Forest - Coniferous Forest - Alpine Meadow") + 
          
          #ylim(0, max(G_M261_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_M261,1)*1.05), expand = c(0,0))

gg.M261

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_M261 <- data.frame(
  bin = as.factor(levels(cut(G_M261$STDAGE_t2, cutvec_M261))),
  data.mean = tapply(G_M261$B_plt_t2_MgHa, cut(G_M261$STDAGE_t2, cutvec_M261), 
                     mean), 
  data.CI.high =  tapply(G_M261$B_plt_t2_MgHa, cut(G_M261$STDAGE_t2, cutvec_M261), 
                    high.CI), 
  data.CI.low = tapply(G_M261$B_plt_t2_MgHa, cut(G_M261$STDAGE_t2, cutvec_M261),
                    low.CI), 
  pred.mean = G_M261_pred_df[G_M261_pred_df$STDAGE_t2 %in% bin_mids_M261,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M261 <-  DM_compare_M261 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M261$bin)[gtools::mixedorder(levels(DM_compare_M261$bin))]))

## ggplot
gg.M261.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M261) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M261))), 
                              labels = levels(DM_compare_M261$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("M261 - Sierran Steppe - Mixed Forest - Coniferous Forest - Alpine Meadow",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +       
           theme_classic() + 
           # xlim(min(DM_compare_M261$data.CI.low)-0.25, max(DM_compare_M261$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_M261$pred.CI.low)-0.25, max(DM_compare_M261$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M261.B2


}  else {print("cannot plot data with prediction")}
```

## M262 - California coastal range - coniferous forest - open woodland - shrub meadow
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_M262 <- round(quantile(G_M262$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M262)))){
  cutvec_M262 <- round(quantile(G_M262$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_M262 <- unname(round(cutvec_M262[-length(cutvec_M262)] + diff(cutvec_M262)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_M262$STDAGE_t2_bin<-  cut(G_M262$STDAGE_t2, cutvec_M262)
## then get bin means
G_M262_bin_means <- tapply(G_M262$B_plt_t2_MgHa, cut(G_M262$STDAGE_t2,  cutvec_M262), mean)

## make column weights.2
G_M262$nls_weights.2 <- as.numeric(1/(G_M262_bin_means[match(G_M262$STDAGE_t2_bin, names(G_M262_bin_means))])^2)

}
```
 
## Model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_M262.1 <- nls(f_1, data = G_M262, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_M262$nls_weights.2), 
 )

## phi
try(
  nls_M262.2 <- nls(f_2, data=G_M262, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_M262$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M262.3 <- nls(f_3 , data = G_M262, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_M262$nls_weights.2), 
 )

## test
if(exists("nls_M262.1") & exists("nls_M262.2") & exists("nls_M262.3")){
  print(anova(nls_M262.1, nls_M262.2, nls_M262.3))
} else if(exists("nls_M262.2") & exists("nls_M262.3")){
  print(anova(nls_M262.2, nls_M262.3))
} else if(exists("nls_M262.1") & exists("nls_M262.2")){
  print(anova(nls_M262.1, nls_M262.2))
}
 
## AIC comparison
AIC1_M262 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_M262.1"), AIC(get("nls_M262.1")), NA),
            ifelse(exists("nls_M262.2"), AIC(get("nls_M262.2")), NA),
            ifelse(exists("nls_M262.3"), AIC(get("nls_M262.3")), NA)
            ))

print(AIC1_M262) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M262[!is.na(AIC1_M262$AIC) & AIC1_M262$AIC == min(AIC1_M262$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M262.",  Mod.Sel1, sep =""))) )  #model summary

}
```

#### summary 
* simple model: `r ifelse(exists("nls_M262.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M262.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_M262.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M262.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M262.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_M262.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_M262.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M262.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M262.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_M262,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_M262$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M262.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_M262,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_M262$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_M262.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_M262,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_M262$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M262.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M262.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M262.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M262.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M262.", Mod.Sel1, sep ="")),
             get(paste("nls_M262.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M262.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M262.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M262.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M262.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M262.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M262.", Mod.Sel1, sep ="")),
               get(paste("nls_M262.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M262.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M262.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M262.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M262.", Mod.Sel1, sep ="")),
                 get(paste("nls_M262.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M262.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M262.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M262.", Mod.Sel1, sep ="")),
                    get(paste("nls_M262.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M262.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M262.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M262.", Mod.Sel1, sep ="")),
                      get(paste("nls_M262.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M262 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M262.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M262.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M262.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M262.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M262.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M262.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M262.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M262.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M262)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M262[!is.na(AIC2_M262$AIC) & AIC2_M262$AIC == min(AIC2_M262$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "M262",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M262.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M262.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "M262",]$ge.variance <- vcov(get(paste("nls_M262.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "M262",]$phi.variance <- vcov(get(paste("nls_M262.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "M262",]$alpha.variance <- vcov(get(paste("nls_M262.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "M262",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M262",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M262",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M262",]$A <- coefs["A"]
nls.param.df_nh[nls.param.df_nh$Code == "M262",]$k <- coefs["k"]

nls.param.df_nh[nls.param.df_nh$Code == "M262",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M262",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M262",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M262",]$A.2.5 <- intervals_low["A"]
nls.param.df_nh[nls.param.df_nh$Code == "M262",]$k.2.5 <- intervals_low["k"]

nls.param.df_nh[nls.param.df_nh$Code == "M262",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M262",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M262",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M262",]$A.97.5 <- intervals_high["A"]
nls.param.df_nh[nls.param.df_nh$Code == "M262",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M262.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M262.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M262.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M262.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_M262$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_M262.4 <- nls(f_4, data = G_M262, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M262$nls_weights.2), 
 )

## phi
try(
  nls_M262.5 <- nls(f_5, data=G_M262, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M262$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M262.6 <- nls(f_6, data = G_M262, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M262$nls_weights.2), 
 )

## test
if(exists("nls_M262.4") & exists("nls_M262.5") & exists("nls_M262.6")){
  print(anova(nls_M262.4, nls_M262.5, nls_M262.6))
} else if(exists("nls_M262.4") & exists("nls_M262.6")){
  print(anova(nls_M262.4, nls_M262.6))
} else if(exists("nls_M262.5") & exists("nls_M262.6")){
  print(anova(nls_M262.5, nls_M262.6))
} else if(exists("nls_M262.4") & exists("nls_M262.5")){
  print(anova(nls_M262.4, nls_M262.5))
}

## AIC comparison
AIC3_M262 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_M262[AIC2_M262$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_M262.4"), AIC(get("nls_M262.4")), NA),
            ifelse(exists("nls_M262.5"), AIC(get("nls_M262.5")), NA),
            ifelse(exists("nls_M262.6"), AIC(get("nls_M262.6")), NA)
            ))

print(AIC3_M262) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_M262[!is.na(AIC3_M262$AIC) & AIC3_M262$AIC == min(AIC3_M262$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "M262",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_nh[Best_mods.P_nh$Code == "M262",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_M262.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M262.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "M262",]$ge.variance <- vcov(get(paste("nls_M262.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "M262",]$phi.variance <- vcov(get(paste("nls_M262.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "M262",]$alpha.variance <- vcov(get(paste("nls_M262.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "M262",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M262",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M262",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M262",]$a <- coefs["a"]
nls.param.df_nh[nls.param.df_nh$Code == "M262",]$b <- coefs["b"]
nls.param.df_nh[nls.param.df_nh$Code == "M262",]$c <- coefs["c"]
nls.param.df_nh[nls.param.df_nh$Code == "M262",]$d <- coefs["d"]

nls.param.df_nh[nls.param.df_nh$Code == "M262",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M262",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M262",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M262",]$a.2.5 <- intervals_low["a"]
nls.param.df_nh[nls.param.df_nh$Code == "M262",]$b.2.5 <- intervals_low["b"]
nls.param.df_nh[nls.param.df_nh$Code == "M262",]$c.2.5 <- intervals_low["c"]
nls.param.df_nh[nls.param.df_nh$Code == "M262",]$d.2.5 <- intervals_low["d"]

nls.param.df_nh[nls.param.df_nh$Code == "M262",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M262",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M262",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M262",]$a.97.5 <- intervals_high["a"]
nls.param.df_nh[nls.param.df_nh$Code == "M262",]$b.97.5 <- intervals_high["b"]
nls.param.df_nh[nls.param.df_nh$Code == "M262",]$c.97.5 <- intervals_high["c"]
nls.param.df_nh[nls.param.df_nh$Code == "M262",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_M262.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_M262.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_M262.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_M262.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_M262 <- nlsResiduals(
  get(paste("nls_M262.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_M262)

## test residuals
if(length(G_M262$pltID) < 5001) {test.nlsResiduals(resid_M262)}

}   else {print("cannot plot residuals")}
```

* model can fit - but K is negative  (only 19 observations) - model excluded

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_M262_pred <- predict(get(paste("nls_M262.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M262$MEASTIME_t2, na.rm = T), max(G_M262$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M262$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M262$MEASTIME_t2, na.rm = T), max(G_M262$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M262$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_M262$DeltaPDSI, na.rm = T), max(G_M262$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M262$MEASTIME_t2, na.rm = T), max(G_M262$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M262$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_M262$B_L_prop, na.rm = T), max(G_M262$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_M262$DeltaPDSI, na.rm = T), max(G_M262$STDAGE_t2)))
                      } )

G_M262_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_M262$STDAGE_t2),by = 1),
                            "fitted"=G_M262_pred)

## plot
gg.M262 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M262, alpha = 0.5, shape ="+", col = "#60606080") +

          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M262,
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res},
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M262))), breaks = cutvec_M262) +

          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`),
                      #data = G_M262_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +

          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_M262_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) +


          theme_classic() +
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"),
               x = "Stand Age (yrs)") +  ggtitle("M262 - California coastal range - coniferous forest - open woodland - shrub meadow") +

          #ylim(0, max(G_M262_pred_df$`Prop.97.5%` + 0.25)) +
          scale_x_continuous(limits = c(0, tail(cutvec_M262,1)*1.05), expand = c(0,0))

gg.M262

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_M262 <- data.frame(
  bin = as.factor(levels(cut(G_M262$STDAGE_t2, cutvec_M262))),
  data.mean = tapply(G_M262$B_plt_t2_MgHa, cut(G_M262$STDAGE_t2, cutvec_M262),
                     mean),
  data.CI.high =  tapply(G_M262$B_plt_t2_MgHa, cut(G_M262$STDAGE_t2, cutvec_M262),
                    high.CI),
  data.CI.low = tapply(G_M262$B_plt_t2_MgHa, cut(G_M262$STDAGE_t2, cutvec_M262),
                    low.CI),
  pred.mean = G_M262_pred_df[G_M262_pred_df$STDAGE_t2 %in% bin_mids_M262,]$fitted)

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY
DM_compare_M262 <-  DM_compare_M262 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M262$bin)[gtools::mixedorder(levels(DM_compare_M262$bin))]))

## ggplot
gg.M262.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M262) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M262))),
                              labels = levels(DM_compare_M262$bin),
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +
           labs(x = expression("observed biomass (Mg ha"^-1*")"),
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("M262 - California coastal range - coniferous forest - open woodland - shrub meadow",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +
           theme_classic() +
           # xlim(min(DM_compare_M262$data.CI.low)-0.25, max(DM_compare_M262$data.CI.high)+0.25) +
           # ylim(min(DM_compare_M262$pred.CI.low)-0.25, max(DM_compare_M262$pred.CI.high)+0.25) +
           theme(legend.position = "top") + tune::coord_obs_pred()

gg.M262.B2

}
```

## M313 - Arizona-New Mexico Mountains Semi-Desert - Open Woodland - Coniferous Forest - Alpine Meadow
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_M313 <- round(quantile(G_M313$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M313)))){
  cutvec_M313 <- round(quantile(G_M313$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_M313 <- unname(round(cutvec_M313[-length(cutvec_M313)] + diff(cutvec_M313)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_M313$STDAGE_t2_bin<-  cut(G_M313$STDAGE_t2, cutvec_M313)
## then get bin means
G_M313_bin_means <- tapply(G_M313$B_plt_t2_MgHa, cut(G_M313$STDAGE_t2,  cutvec_M313), mean)

## make column weights.2
G_M313$nls_weights.2 <- as.numeric(1/(G_M313_bin_means[match(G_M313$STDAGE_t2_bin, names(G_M313_bin_means))])^2)

}
```

### model selection 1
```{r}
if(fit.models == T) {

# simple
try(
  nls_M313.1 <- nls(f_1, data = G_M313, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_M313$nls_weights.2), 
 )

## phi
try(
  nls_M313.2 <- nls(f_2, data=G_M313, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_M313$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M313.3 <- nls(f_3 , data = G_M313, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_M313$nls_weights.2), 
 )

## test
if(exists("nls_M313.1") & exists("nls_M313.2") & exists("nls_M313.3")){
  print(anova(nls_M313.1, nls_M313.2, nls_M313.3))
} else if(exists("nls_M313.2") & exists("nls_M313.3")){
  print(anova(nls_M313.2, nls_M313.3))
} else if(exists("nls_M313.1") & exists("nls_M313.2")){
  print(anova(nls_M313.1, nls_M313.2))
}
 
## AIC comparison
AIC1_M313 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_M313.1"), AIC(get("nls_M313.1")), NA),
            ifelse(exists("nls_M313.2"), AIC(get("nls_M313.2")), NA),
            ifelse(exists("nls_M313.3"), AIC(get("nls_M313.3")), NA)
            ))

print(AIC1_M313) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M313[!is.na(AIC1_M313$AIC) & AIC1_M313$AIC == min(AIC1_M313$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M313.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_M313.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M313.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_M313.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M313.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M313.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_M313.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_M313.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M313.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M313.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_M313,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_M313$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M313.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_M313,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_M313$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_M313.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_M313,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_M313$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M313.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M313.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M313.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M313.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M313.", Mod.Sel1, sep ="")),
             get(paste("nls_M313.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M313.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M313.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M313.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M313.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M313.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M313.", Mod.Sel1, sep ="")),
               get(paste("nls_M313.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M313.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M313.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M313.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M313.", Mod.Sel1, sep ="")),
                 get(paste("nls_M313.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M313.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M313.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M313.", Mod.Sel1, sep ="")),
                    get(paste("nls_M313.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M313.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M313.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M313.", Mod.Sel1, sep ="")),
                      get(paste("nls_M313.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M313 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M313.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M313.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M313.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M313.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M313.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M313.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M313.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M313.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M313)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M313[!is.na(AIC2_M313$AIC) & AIC2_M313$AIC == min(AIC2_M313$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "M313",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M313.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M313.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "M313",]$ge.variance <- vcov(get(paste("nls_M313.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "M313",]$phi.variance <- vcov(get(paste("nls_M313.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "M313",]$alpha.variance <- vcov(get(paste("nls_M313.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "M313",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M313",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M313",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M313",]$A <- coefs["A"]
nls.param.df_nh[nls.param.df_nh$Code == "M313",]$k <- coefs["k"]

nls.param.df_nh[nls.param.df_nh$Code == "M313",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M313",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M313",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M313",]$A.2.5 <- intervals_low["A"]
nls.param.df_nh[nls.param.df_nh$Code == "M313",]$k.2.5 <- intervals_low["k"]

nls.param.df_nh[nls.param.df_nh$Code == "M313",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M313",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M313",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M313",]$A.97.5 <- intervals_high["A"]
nls.param.df_nh[nls.param.df_nh$Code == "M313",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M313.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M313.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M313.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M313.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_M313$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_M313.4 <- nls(f_4, data = G_M313, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M313$nls_weights.2), 
 )

## phi
try(
  nls_M313.5 <- nls(f_5, data=G_M313, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M313$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M313.6 <- nls(f_6, data = G_M313, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M313$nls_weights.2), 
 )

## test
if(exists("nls_M313.4") & exists("nls_M313.5") & exists("nls_M313.6")){
  print(anova(nls_M313.4, nls_M313.5, nls_M313.6))
} else if(exists("nls_M313.4") & exists("nls_M313.6")){
  print(anova(nls_M313.4, nls_M313.6))
} else if(exists("nls_M313.5") & exists("nls_M313.6")){
  print(anova(nls_M313.5, nls_M313.6))
} else if(exists("nls_M313.4") & exists("nls_M313.5")){
  print(anova(nls_M313.4, nls_M313.5))
}

## AIC comparison
AIC3_M313 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_M313[AIC2_M313$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_M313.4"), AIC(get("nls_M313.4")), NA),
            ifelse(exists("nls_M313.5"), AIC(get("nls_M313.5")), NA),
            ifelse(exists("nls_M313.6"), AIC(get("nls_M313.6")), NA)
            ))

print(AIC3_M313) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_M313[!is.na(AIC3_M313$AIC) & AIC3_M313$AIC == min(AIC3_M313$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "M313",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_nh[Best_mods.P_nh$Code == "M313",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_M313.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M313.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "M313",]$ge.variance <- vcov(get(paste("nls_M313.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "M313",]$phi.variance <- vcov(get(paste("nls_M313.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "M313",]$alpha.variance <- vcov(get(paste("nls_M313.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "M313",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M313",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M313",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M313",]$a <- coefs["a"]
nls.param.df_nh[nls.param.df_nh$Code == "M313",]$b <- coefs["b"]
nls.param.df_nh[nls.param.df_nh$Code == "M313",]$c <- coefs["c"]
nls.param.df_nh[nls.param.df_nh$Code == "M313",]$d <- coefs["d"]

nls.param.df_nh[nls.param.df_nh$Code == "M313",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M313",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M313",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M313",]$a.2.5 <- intervals_low["a"]
nls.param.df_nh[nls.param.df_nh$Code == "M313",]$b.2.5 <- intervals_low["b"]
nls.param.df_nh[nls.param.df_nh$Code == "M313",]$c.2.5 <- intervals_low["c"]
nls.param.df_nh[nls.param.df_nh$Code == "M313",]$d.2.5 <- intervals_low["d"]

nls.param.df_nh[nls.param.df_nh$Code == "M313",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M313",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M313",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M313",]$a.97.5 <- intervals_high["a"]
nls.param.df_nh[nls.param.df_nh$Code == "M313",]$b.97.5 <- intervals_high["b"]
nls.param.df_nh[nls.param.df_nh$Code == "M313",]$c.97.5 <- intervals_high["c"]
nls.param.df_nh[nls.param.df_nh$Code == "M313",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_M313.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_M313.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_M313.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_M313.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {
  
## calculate residuals
resid_M313 <- nlsResiduals(
  get(paste("nls_M313.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_M313)

## test residuals
if(length(G_M313$pltID) < 5001) {test.nlsResiduals(resid_M313)}

}   else {print("cannot plot residuals")}
```


### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_M313_pred <- predict(get(paste("nls_M313.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M313$MEASTIME_t2, na.rm = T), max(G_M313$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M313$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M313$MEASTIME_t2, na.rm = T), max(G_M313$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M313$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_M313$DeltaPDSI, na.rm = T), max(G_M313$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M313$MEASTIME_t2, na.rm = T), max(G_M313$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M313$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_M313$B_L_prop, na.rm = T), max(G_M313$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_M313$DeltaPDSI, na.rm = T), max(G_M313$STDAGE_t2)))
                      } )

G_M313_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_M313$STDAGE_t2),by = 1),  
                            "fitted"=G_M313_pred)

## plot
gg.M313 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M313, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M313, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M313))), breaks = cutvec_M313) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_M313_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_M313_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("M313 - Arizona-New Mexico Mountains Semi-Desert - Open Woodland - Coniferous Forest - Alpine Meadow") + 
          
          #ylim(0, max(G_M313_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_M313,1)*1.05), expand = c(0,0))

gg.M313

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_M313 <- data.frame(
  bin = as.factor(levels(cut(G_M313$STDAGE_t2, cutvec_M313))),
  data.mean = tapply(G_M313$B_plt_t2_MgHa, cut(G_M313$STDAGE_t2, cutvec_M313), 
                     mean), 
  data.CI.high =  tapply(G_M313$B_plt_t2_MgHa, cut(G_M313$STDAGE_t2, cutvec_M313), 
                    high.CI), 
  data.CI.low = tapply(G_M313$B_plt_t2_MgHa, cut(G_M313$STDAGE_t2, cutvec_M313),
                    low.CI), 
  pred.mean = G_M313_pred_df[G_M313_pred_df$STDAGE_t2 %in% bin_mids_M313,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M313 <-  DM_compare_M313 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M313$bin)[gtools::mixedorder(levels(DM_compare_M313$bin))]))

## ggplot
gg.M313.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M313) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M313))), 
                              labels = levels(DM_compare_M313$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("M313 - Arizona-New Mexico Mountains Semi-Desert - Open Woodland - Coniferous Forest - Alpine Meadow",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +         
           theme_classic() + 
           # xlim(min(DM_compare_M313$data.CI.low)-0.25, max(DM_compare_M313$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_M313$pred.CI.low)-0.25, max(DM_compare_M313$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M313.B2

}
```

## M331 - Southern Rocky Mountain Steppe - Open Woodland - Coniferous Forest - Alpine Meadow
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_M331 <- round(quantile(G_M331$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M331)))){
  cutvec_M331 <- round(quantile(G_M331$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_M331 <- unname(round(cutvec_M331[-length(cutvec_M331)] + diff(cutvec_M331)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_M331$STDAGE_t2_bin<-  cut(G_M331$STDAGE_t2, cutvec_M313)
## then get bin means
G_M331_bin_means <- tapply(G_M331$B_plt_t2_MgHa, cut(G_M331$STDAGE_t2,  cutvec_M313), mean)

## make column weights.2
G_M331$nls_weights.2 <- as.numeric(1/(G_M331_bin_means[match(G_M331$STDAGE_t2_bin, names(G_M331_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_M331.1 <- nls(f_1, data = G_M331, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_M331$nls_weights.2), 
 )

## phi
try(
  nls_M331.2 <- nls(f_2, data=G_M331, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_M331$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M331.3 <- nls(f_3 , data = G_M331, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_M331$nls_weights.2), 
 )

## test
if(exists("nls_M331.1") & exists("nls_M331.2") & exists("nls_M331.3")){
  print(anova(nls_M331.1, nls_M331.2, nls_M331.3))
} else if(exists("nls_M331.2") & exists("nls_M331.3")){
  print(anova(nls_M331.2, nls_M331.3))
} else if(exists("nls_M331.1") & exists("nls_M331.2")){
  print(anova(nls_M331.1, nls_M331.2))
}
 
## AIC comparison
AIC1_M331 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_M331.1"), AIC(get("nls_M331.1")), NA),
            ifelse(exists("nls_M331.2"), AIC(get("nls_M331.2")), NA),
            ifelse(exists("nls_M331.3"), AIC(get("nls_M331.3")), NA)
            ))

print(AIC1_M331) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M331[!is.na(AIC1_M331$AIC) &AIC1_M331$AIC == min(AIC1_M331$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M331.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_M331.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M331.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_M331.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M331.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M331.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_M331.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_M331.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M331.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M331.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_M331,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_M331$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M331.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_M331,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_M331$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_M331.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_M331,
          sstart = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_M331$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M331.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M331.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M331.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M331.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M331.", Mod.Sel1, sep ="")),
             get(paste("nls_M331.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M331.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M331.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M331.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M331.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M331.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M331.", Mod.Sel1, sep ="")),
               get(paste("nls_M331.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M331.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M331.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M331.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M331.", Mod.Sel1, sep ="")),
                 get(paste("nls_M331.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M331.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M331.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M331.", Mod.Sel1, sep ="")),
                    get(paste("nls_M331.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M331.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M331.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M331.", Mod.Sel1, sep ="")),
                      get(paste("nls_M331.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M331 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M331.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M331.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M331.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M331.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M331.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M331.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M331.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M331.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M331)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M331[!is.na(AIC2_M331$AIC) & AIC2_M331$AIC == min(AIC2_M331$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "M331",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M331.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M331.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "M313",]$ge.variance <- vcov(get(paste("nls_M331.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "M331",]$phi.variance <- vcov(get(paste("nls_M331.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "M331",]$alpha.variance <- vcov(get(paste("nls_M331.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "M331",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M331",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M331",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M331",]$A <- coefs["A"]
nls.param.df_nh[nls.param.df_nh$Code == "M331",]$k <- coefs["k"]

nls.param.df_nh[nls.param.df_nh$Code == "M331",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M331",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M331",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M331",]$A.2.5 <- intervals_low["A"]
nls.param.df_nh[nls.param.df_nh$Code == "M331",]$k.2.5 <- intervals_low["k"]

nls.param.df_nh[nls.param.df_nh$Code == "M331",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M331",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M331",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M331",]$A.97.5 <- intervals_high["A"]
nls.param.df_nh[nls.param.df_nh$Code == "M331",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M331.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M331.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M331.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M331.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_M331$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_M331.4 <- nls(f_4, data = G_M331, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M331$nls_weights.2), 
 )

## phi
try(
  nls_M331.5 <- nls(f_5, data=G_M331, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M331$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M331.6 <- nls(f_6, data = G_M331, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M331$nls_weights.2), 
 )

## test
if(exists("nls_M331.4") & exists("nls_M331.5") & exists("nls_M331.6")){
  print(anova(nls_M331.4, nls_M331.5, nls_M331.6))
} else if(exists("nls_M331.4") & exists("nls_M331.6")){
  print(anova(nls_M331.4, nls_M331.6))
} else if(exists("nls_M331.5") & exists("nls_M331.6")){
  print(anova(nls_M331.5, nls_M331.6))
} else if(exists("nls_M331.4") & exists("nls_M331.5")){
  print(anova(nls_M331.4, nls_M331.5))
}

## AIC comparison
AIC3_M331 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_M331[AIC2_M331$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_M331.4"), AIC(get("nls_M331.4")), NA),
            ifelse(exists("nls_M331.5"), AIC(get("nls_M331.5")), NA),
            ifelse(exists("nls_M331.6"), AIC(get("nls_M331.6")), NA)
            ))

print(AIC3_M331) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_M331[!is.na(AIC3_M331$AIC) & AIC3_M331$AIC == min(AIC3_M331$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "M331",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_nh[Best_mods.P_nh$Code == "M331",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_M331.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M331.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "M331",]$ge.variance <- vcov(get(paste("nls_M331.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "M331",]$phi.variance <- vcov(get(paste("nls_M331.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "M331",]$alpha.variance <- vcov(get(paste("nls_M331.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "M331",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M331",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M331",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M331",]$a <- coefs["a"]
nls.param.df_nh[nls.param.df_nh$Code == "M331",]$b <- coefs["b"]
nls.param.df_nh[nls.param.df_nh$Code == "M331",]$c <- coefs["c"]
nls.param.df_nh[nls.param.df_nh$Code == "M331",]$d <- coefs["d"]

nls.param.df_nh[nls.param.df_nh$Code == "M331",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M331",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M331",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M331",]$a.2.5 <- intervals_low["a"]
nls.param.df_nh[nls.param.df_nh$Code == "M331",]$b.2.5 <- intervals_low["b"]
nls.param.df_nh[nls.param.df_nh$Code == "M331",]$c.2.5 <- intervals_low["c"]
nls.param.df_nh[nls.param.df_nh$Code == "M331",]$d.2.5 <- intervals_low["d"]

nls.param.df_nh[nls.param.df_nh$Code == "M331",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M331",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M331",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M331",]$a.97.5 <- intervals_high["a"]
nls.param.df_nh[nls.param.df_nh$Code == "M331",]$b.97.5 <- intervals_high["b"]
nls.param.df_nh[nls.param.df_nh$Code == "M331",]$c.97.5 <- intervals_high["c"]
nls.param.df_nh[nls.param.df_nh$Code == "M331",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_M331.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_M331.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_M331.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_M331.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {
  
## calculate residuals
resid_M331 <- nlsResiduals(
  get(paste("nls_M331.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_M331)

## test residuals
if(length(G_M331$pltID) < 5001) {test.nlsResiduals(resid_M331)}

}   else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_M331_pred <- predict(get(paste("nls_M331.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M331$MEASTIME_t2, na.rm = T), max(G_M331$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M331$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M331$MEASTIME_t2, na.rm = T), max(G_M331$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M331$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_M331$DeltaPDSI, na.rm = T), max(G_M331$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M331$MEASTIME_t2, na.rm = T), max(G_M331$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M331$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_M331$B_L_prop, na.rm = T), max(G_M331$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_M331$DeltaPDSI, na.rm = T), max(G_M331$STDAGE_t2)))
                      } )


G_M331_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_M331$STDAGE_t2),by = 1),  
                            "fitted"=G_M331_pred)

## plot
gg.M331 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M331, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M331, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M331))), breaks = cutvec_M331) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_M331_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_M331_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("M331 - Southern Rocky Mountain Steppe - Open Woodland - Coniferous Forest - Alpine Meadow") + 
          
          #ylim(0, max(G_M331_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_M331,1)*1.05), expand = c(0,0))

gg.M331

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_M331 <- data.frame(
  bin = as.factor(levels(cut(G_M331$STDAGE_t2, cutvec_M331))),
  data.mean = tapply(G_M331$B_plt_t2_MgHa, cut(G_M331$STDAGE_t2, cutvec_M331), 
                     mean), 
  data.CI.high =  tapply(G_M331$B_plt_t2_MgHa, cut(G_M331$STDAGE_t2, cutvec_M331), 
                    high.CI), 
  data.CI.low = tapply(G_M331$B_plt_t2_MgHa, cut(G_M331$STDAGE_t2, cutvec_M331),
                    low.CI), 
  pred.mean = G_M331_pred_df[G_M331_pred_df$STDAGE_t2 %in% bin_mids_M331,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M331 <-  DM_compare_M331 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M331$bin)[gtools::mixedorder(levels(DM_compare_M331$bin))]))

## ggplot
gg.M331.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M331) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M331))), 
                              labels = levels(DM_compare_M331$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("M331 - Southern Rocky Mountain Steppe - Open Woodland - Coniferous Forest - Alpine Meadow",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +     
           theme_classic() + 
           # xlim(min(DM_compare_M331$data.CI.low)-0.25, max(DM_compare_M331$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_M331$pred.CI.low)-0.25, max(DM_compare_M331$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M331.B2

}
```

## M332 - Middle Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_M332 <- round(quantile(G_M332$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M332)))){
  cutvec_M332 <- round(quantile(G_M332$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_M332 <- unname(round(cutvec_M332[-length(cutvec_M332)] + diff(cutvec_M332)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_M332$STDAGE_t2_bin<-  cut(G_M332$STDAGE_t2, cutvec_M332)
## then get bin means
G_M332_bin_means <- tapply(G_M332$B_plt_t2_MgHa, cut(G_M332$STDAGE_t2,  cutvec_M332), mean)

## make column weights.2
G_M332$nls_weights.2 <- as.numeric(1/(G_M332_bin_means[match(G_M332$STDAGE_t2_bin, names(G_M332_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_M332.1 <- nls(f_1, data = G_M332, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_M332$nls_weights.2), 
 )

## phi
try(
  nls_M332.2 <- nls(f_2, data=G_M332, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_M332$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M332.3 <- nls(f_3 , data = G_M332, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_M332$nls_weights.2), 
 )

## test
if(exists("nls_M332.1") & exists("nls_M332.2") & exists("nls_M332.3")){
  print(anova(nls_M332.1, nls_M332.2, nls_M332.3))
} else if(exists("nls_M332.2") & exists("nls_M332.3")){
  print(anova(nls_M332.2, nls_M332.3))
} else if(exists("nls_M332.1") & exists("nls_M332.2")){
  print(anova(nls_M332.1, nls_M332.2))
}
 
## AIC comparison
AIC1_M332 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_M332.1"), AIC(get("nls_M332.1")), NA),
            ifelse(exists("nls_M332.2"), AIC(get("nls_M332.2")), NA),
            ifelse(exists("nls_M332.3"), AIC(get("nls_M332.3")), NA)
            ))

print(AIC1_M332) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M332[!is.na(AIC1_M332$AIC) &AIC1_M332$AIC == min(AIC1_M332$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M332.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_M332.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M332.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_M332.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M332.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M332.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_M332.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_M332.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M332.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M332.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_M332,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_M332$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M332.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_M332,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_M332$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_M332.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_M332,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_M332$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M332.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M332.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M332.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M332.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M332.", Mod.Sel1, sep ="")),
             get(paste("nls_M332.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M332.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M332.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M332.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M332.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M332.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M332.", Mod.Sel1, sep ="")),
               get(paste("nls_M332.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M332.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M332.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M332.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M332.", Mod.Sel1, sep ="")),
                 get(paste("nls_M332.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M332.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M332.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M332.", Mod.Sel1, sep ="")),
                    get(paste("nls_M332.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M332.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M332.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M332.", Mod.Sel1, sep ="")),
                      get(paste("nls_M332.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M332 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M332.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M332.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M332.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M332.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M332.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M332.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M332.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M332.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M332)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M332[!is.na(AIC2_M332$AIC) & AIC2_M332$AIC == min(AIC2_M332$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "M332",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M332.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M332.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "M332",]$ge.variance <- vcov(get(paste("nls_M332.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "M332",]$phi.variance <- vcov(get(paste("nls_M332.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "M332",]$alpha.variance <- vcov(get(paste("nls_M332.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "M332",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M332",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M332",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M332",]$A <- coefs["A"]
nls.param.df_nh[nls.param.df_nh$Code == "M332",]$k <- coefs["k"]

nls.param.df_nh[nls.param.df_nh$Code == "M332",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M332",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M332",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M332",]$A.2.5 <- intervals_low["A"]
nls.param.df_nh[nls.param.df_nh$Code == "M332",]$k.2.5 <- intervals_low["k"]

nls.param.df_nh[nls.param.df_nh$Code == "M332",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M332",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M332",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M332",]$A.97.5 <- intervals_high["A"]
nls.param.df_nh[nls.param.df_nh$Code == "M332",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M332.",  Mod.Sel2, sep =""))))

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M332.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M332.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M332.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_M332$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_M332.4 <- nls(f_4, data = G_M332, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M332$nls_weights.2), 
 )

## phi
try(
  nls_M332.5 <- nls(f_5, data=G_M332, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M332$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M332.6 <- nls(f_6, data = G_M332, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M332$nls_weights.2), 
 )

## test
if(exists("nls_M332.4") & exists("nls_M332.5") & exists("nls_M332.6")){
  print(anova(nls_M332.4, nls_M332.5, nls_M332.6))
} else if(exists("nls_M332.4") & exists("nls_M332.6")){
  print(anova(nls_M332.4, nls_M332.6))
} else if(exists("nls_M332.5") & exists("nls_M332.6")){
  print(anova(nls_M332.5, nls_M332.6))
} else if(exists("nls_M332.4") & exists("nls_M332.5")){
  print(anova(nls_M332.4, nls_M332.5))
}

## AIC comparison
AIC3_M332 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_M332[AIC2_M332$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_M332.4"), AIC(get("nls_M332.4")), NA),
            ifelse(exists("nls_M332.5"), AIC(get("nls_M332.5")), NA),
            ifelse(exists("nls_M332.6"), AIC(get("nls_M332.6")), NA)
            ))

print(AIC3_M332) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_M332[!is.na(AIC3_M332$AIC) & AIC3_M332$AIC == min(AIC3_M332$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "M332",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_nh[Best_mods.P_nh$Code == "M332",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_M332.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M332.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "M332",]$ge.variance <- vcov(get(paste("nls_M332.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "M332",]$phi.variance <- vcov(get(paste("nls_M332.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "M332",]$alpha.variance <- vcov(get(paste("nls_M332.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "M332",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M332",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M332",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M332",]$a <- coefs["a"]
nls.param.df_nh[nls.param.df_nh$Code == "M332",]$b <- coefs["b"]
nls.param.df_nh[nls.param.df_nh$Code == "M332",]$c <- coefs["c"]
nls.param.df_nh[nls.param.df_nh$Code == "M332",]$d <- coefs["d"]

nls.param.df_nh[nls.param.df_nh$Code == "M332",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M332",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M332",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M332",]$a.2.5 <- intervals_low["a"]
nls.param.df_nh[nls.param.df_nh$Code == "M332",]$b.2.5 <- intervals_low["b"]
nls.param.df_nh[nls.param.df_nh$Code == "M332",]$c.2.5 <- intervals_low["c"]
nls.param.df_nh[nls.param.df_nh$Code == "M332",]$d.2.5 <- intervals_low["d"]

nls.param.df_nh[nls.param.df_nh$Code == "M332",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M332",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M332",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M332",]$a.97.5 <- intervals_high["a"]
nls.param.df_nh[nls.param.df_nh$Code == "M332",]$b.97.5 <- intervals_high["b"]
nls.param.df_nh[nls.param.df_nh$Code == "M332",]$c.97.5 <- intervals_high["c"]
nls.param.df_nh[nls.param.df_nh$Code == "M332",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_M332.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_M332.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_M332.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_M332.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_M332 <- nlsResiduals(
  get(paste("nls_M332.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_M332)

## test residuals
if(length(G_M332$pltID) < 5001) {test.nlsResiduals(resid_M332)}

}   else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_M332_pred <- predict(get(paste("nls_M332.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M332$MEASTIME_t2, na.rm = T), max(G_M332$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M332$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M332$MEASTIME_t2, na.rm = T), max(G_M332$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M332$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_M332$DeltaPDSI, na.rm = T), max(G_M332$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M332$MEASTIME_t2, na.rm = T), max(G_M332$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M332$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_M332$B_L_prop, na.rm = T), max(G_M332$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_M332$DeltaPDSI, na.rm = T), max(G_M332$STDAGE_t2)))
                      } )

G_M332_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_M332$STDAGE_t2),by = 1),  
                            "fitted"=G_M332_pred)

## plot
gg.M332 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M332, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M332, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M332))), breaks = cutvec_M332) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_M332_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_M332_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("M332 - Middle Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow") + 
          
          #ylim(0, max(G_M332_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_M332,1)*1.05), expand = c(0,0))

gg.M332

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_M332 <- data.frame(
  bin = as.factor(levels(cut(G_M332$STDAGE_t2, cutvec_M332))),
  data.mean = tapply(G_M332$B_plt_t2_MgHa, cut(G_M332$STDAGE_t2, cutvec_M332), 
                     mean), 
  data.CI.high =  tapply(G_M332$B_plt_t2_MgHa, cut(G_M332$STDAGE_t2, cutvec_M332), 
                    high.CI), 
  data.CI.low = tapply(G_M332$B_plt_t2_MgHa, cut(G_M332$STDAGE_t2, cutvec_M332),
                    low.CI), 
  pred.mean = G_M332_pred_df[G_M332_pred_df$STDAGE_t2 %in% bin_mids_M332,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M332 <-  DM_compare_M332 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M332$bin)[gtools::mixedorder(levels(DM_compare_M332$bin))]))

## ggplot
gg.M332.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M332) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M332))), 
                              labels = levels(DM_compare_M332$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("M332 - Middle Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +       
           theme_classic() + 
           # xlim(min(DM_compare_M332$data.CI.low)-0.25, max(DM_compare_M332$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_M332$pred.CI.low)-0.25, max(DM_compare_M332$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M332.B2

}
```

## M333 - Northern Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_M333 <- round(quantile(G_M333$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M333)))){
  cutvec_M333 <- round(quantile(G_M333$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_M333 <- unname(round(cutvec_M333[-length(cutvec_M333)] + diff(cutvec_M333)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_M333$STDAGE_t2_bin<-  cut(G_M333$STDAGE_t2, cutvec_M333)
## then get bin means
G_M333_bin_means <- tapply(G_M333$B_plt_t2_MgHa, cut(G_M333$STDAGE_t2, cutvec_M333), mean)

## make column weights.2
G_M333$nls_weights.2 <- as.numeric(1/(G_M333_bin_means[match(G_M333$STDAGE_t2_bin, names(G_M333_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_M333.1 <- nls(f_1, data = G_M333, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_M333$nls_weights.2), 
 )

## phi
try(
  nls_M333.2 <- nls(f_2, data=G_M333, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_M333$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M333.3 <- nls(f_3 , data = G_M333, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_M333$nls_weights.2), 
 )

## test
if(exists("nls_M333.1") & exists("nls_M333.2") & exists("nls_M333.3")){
  print(anova(nls_M333.1, nls_M333.2, nls_M333.3))
} else if(exists("nls_M333.2") & exists("nls_M333.3")){
  print(anova(nls_M333.2, nls_M333.3))
} else if(exists("nls_M333.1") & exists("nls_M333.2")){
  print(anova(nls_M333.1, nls_M333.2))
}
 
## AIC comparison
AIC1_M333 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_M333.1"), AIC(get("nls_M333.1")), NA),
            ifelse(exists("nls_M333.2"), AIC(get("nls_M333.2")), NA),
            ifelse(exists("nls_M333.3"), AIC(get("nls_M333.3")), NA)
            ))

print(AIC1_M333) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M333[!is.na(AIC1_M333$AIC) &AIC1_M333$AIC == min(AIC1_M333$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M333.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_M333.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M333.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_M333.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {
  
### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M333.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M333.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_M333.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_M333.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M333.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M333.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_M333,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_M333$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M333.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_M333,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_M333$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_M333.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_M333,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_M333$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M333.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M333.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M333.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M333.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M333.", Mod.Sel1, sep ="")),
             get(paste("nls_M333.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M333.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M333.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M333.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M333.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M333.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M333.", Mod.Sel1, sep ="")),
               get(paste("nls_M333.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M333.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M333.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M333.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M333.", Mod.Sel1, sep ="")),
                 get(paste("nls_M333.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M333.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M333.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M333.", Mod.Sel1, sep ="")),
                    get(paste("nls_M333.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M333.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M333.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M333.", Mod.Sel1, sep ="")),
                      get(paste("nls_M333.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M333 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M333.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M333.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M333.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M333.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M333.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M333.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M333.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M333.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M333)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M333[!is.na(AIC2_M333$AIC) & AIC2_M333$AIC == min(AIC2_M333$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "M333",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M333.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M333.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "M333",]$ge.variance <- vcov(get(paste("nls_M333.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "M333",]$phi.variance <- vcov(get(paste("nls_M333.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "M333",]$alpha.variance <- vcov(get(paste("nls_M333.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "M333",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M333",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M333",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M333",]$A <- coefs["A"]
nls.param.df_nh[nls.param.df_nh$Code == "M333",]$k <- coefs["k"]

nls.param.df_nh[nls.param.df_nh$Code == "M333",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M333",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M333",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M333",]$A.2.5 <- intervals_low["A"]
nls.param.df_nh[nls.param.df_nh$Code == "M333",]$k.2.5 <- intervals_low["k"]

nls.param.df_nh[nls.param.df_nh$Code == "M333",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M333",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M333",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M333",]$A.97.5 <- intervals_high["A"]
nls.param.df_nh[nls.param.df_nh$Code == "M333",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M333.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M333.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M333.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M333.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_M333$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_M333.4 <- nls(f_4, data = G_M333, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M333$nls_weights.2), 
 )

## phi
try(
  nls_M333.5 <- nls(f_5, data=G_M333, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M333$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M333.6 <- nls(f_6, data = G_M333, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M333$nls_weights.2), 
 )

## test
if(exists("nls_M333.4") & exists("nls_M333.5") & exists("nls_M333.6")){
  print(anova(nls_M333.4, nls_M333.5, nls_M333.6))
} else if(exists("nls_M333.4") & exists("nls_M333.6")){
  print(anova(nls_M333.4, nls_M333.6))
} else if(exists("nls_M333.5") & exists("nls_M333.6")){
  print(anova(nls_M333.5, nls_M333.6))
} else if(exists("nls_M333.4") & exists("nls_M333.5")){
  print(anova(nls_M333.4, nls_M333.5))
}

## AIC comparison
AIC3_M333 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_M333[AIC2_M333$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_M333.4"), AIC(get("nls_M333.4")), NA),
            ifelse(exists("nls_M333.5"), AIC(get("nls_M333.5")), NA),
            ifelse(exists("nls_M333.6"), AIC(get("nls_M333.6")), NA)
            ))

print(AIC3_M333) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_M333[!is.na(AIC3_M333$AIC) & AIC3_M333$AIC == min(AIC3_M333$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "M333",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_nh[Best_mods.P_nh$Code == "M333",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_M333.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M333.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "M333",]$ge.variance <- vcov(get(paste("nls_M333.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "M333",]$phi.variance <- vcov(get(paste("nls_M333.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "M333",]$alpha.variance <- vcov(get(paste("nls_M333.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "M333",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M333",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M333",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M333",]$a <- coefs["a"]
nls.param.df_nh[nls.param.df_nh$Code == "M333",]$b <- coefs["b"]
nls.param.df_nh[nls.param.df_nh$Code == "M333",]$c <- coefs["c"]
nls.param.df_nh[nls.param.df_nh$Code == "M333",]$d <- coefs["d"]

nls.param.df_nh[nls.param.df_nh$Code == "M333",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M333",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M333",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M333",]$a.2.5 <- intervals_low["a"]
nls.param.df_nh[nls.param.df_nh$Code == "M333",]$b.2.5 <- intervals_low["b"]
nls.param.df_nh[nls.param.df_nh$Code == "M333",]$c.2.5 <- intervals_low["c"]
nls.param.df_nh[nls.param.df_nh$Code == "M333",]$d.2.5 <- intervals_low["d"]

nls.param.df_nh[nls.param.df_nh$Code == "M333",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M333",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M333",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M333",]$a.97.5 <- intervals_high["a"]
nls.param.df_nh[nls.param.df_nh$Code == "M333",]$b.97.5 <- intervals_high["b"]
nls.param.df_nh[nls.param.df_nh$Code == "M333",]$c.97.5 <- intervals_high["c"]
nls.param.df_nh[nls.param.df_nh$Code == "M333",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_M333.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_M333.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_M333.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_M333.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_M333 <- nlsResiduals(
  get(paste("nls_M333.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_M333)

## test residuals
if(length(G_M333$pltID) < 5001) {test.nlsResiduals(resid_M333)}

}   else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_M333_pred <- predict(get(paste("nls_M333.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M333$MEASTIME_t2, na.rm = T), max(G_M333$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M333$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M333$MEASTIME_t2, na.rm = T), max(G_M333$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M333$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_M333$DeltaPDSI, na.rm = T), max(G_M333$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M333$MEASTIME_t2, na.rm = T), max(G_M333$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M333$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_M333$B_L_prop, na.rm = T), max(G_M333$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_M333$DeltaPDSI, na.rm = T), max(G_M333$STDAGE_t2)))
                      } )

G_M333_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_M333$STDAGE_t2),by = 1),  
                            "fitted"=G_M333_pred)

## plot
gg.M333 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M333, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M333, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M333))), breaks = cutvec_M333) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_M333_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_M333_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("M333 - Northern Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow") + 
          
          #ylim(0, max(G_M333_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_M333,1)*1.05), expand = c(0,0))

gg.M333

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_M333 <- data.frame(
  bin = as.factor(levels(cut(G_M333$STDAGE_t2, cutvec_M333))),
  data.mean = tapply(G_M333$B_plt_t2_MgHa, cut(G_M333$STDAGE_t2, cutvec_M333), 
                     mean), 
  data.CI.high =  tapply(G_M333$B_plt_t2_MgHa, cut(G_M333$STDAGE_t2, cutvec_M333), 
                    high.CI), 
  data.CI.low = tapply(G_M333$B_plt_t2_MgHa, cut(G_M333$STDAGE_t2, cutvec_M333),
                    low.CI), 
  pred.mean = G_M333_pred_df[G_M333_pred_df$STDAGE_t2 %in% bin_mids_M333,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M333 <-  DM_compare_M333 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M333$bin)[gtools::mixedorder(levels(DM_compare_M333$bin))]))

## ggplot
gg.M333.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M333) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M333))), 
                              labels = levels(DM_compare_M333$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("M333 - Northern Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +       
           theme_classic() + 
           # xlim(min(DM_compare_M333$data.CI.low)-0.25, max(DM_compare_M333$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_M333$pred.CI.low)-0.25, max(DM_compare_M333$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M333.B2

}
```

## M334 - Black Hills Coniferous Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_M334 <- round(quantile(G_M334$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M334)))){
  cutvec_M334 <- round(quantile(G_M334$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_M334 <- unname(round(cutvec_M334[-length(cutvec_M334)] + diff(cutvec_M334)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_M334$STDAGE_t2_bin<-  cut(G_M334$STDAGE_t2, cutvec_M334)
## then get bin means
G_M334_bin_means <- tapply(G_M334$B_plt_t2_MgHa, cut(G_M334$STDAGE_t2,  cutvec_M334), mean)

## make column weights.2
G_M334$nls_weights.2 <- as.numeric(1/(G_M334_bin_means[match(G_M334$STDAGE_t2_bin, names(G_M334_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_M334.1 <- nls(f_1, data = G_M334, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_M334$nls_weights.2), 
 )

## phi
try(
  nls_M334.2 <- nls(f_2, data=G_M334, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_M334$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M334.3 <- nls(f_3 , data = G_M334, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_M334$nls_weights.2), 
 )

## test
if(exists("nls_M334.1") & exists("nls_M334.2") & exists("nls_M334.3")){
  print(anova(nls_M334.1, nls_M334.2, nls_M334.3))
} else if(exists("nls_M334.2") & exists("nls_M334.3")){
  print(anova(nls_M334.2, nls_M334.3))
} else if(exists("nls_M334.1") & exists("nls_M334.2")){
  print(anova(nls_M334.1, nls_M334.2))
}
 
## AIC comparison
AIC1_M334 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_M334.1"), AIC(get("nls_M334.1")), NA),
            ifelse(exists("nls_M334.2"), AIC(get("nls_M334.2")), NA),
            ifelse(exists("nls_M334.3"), AIC(get("nls_M334.3")), NA)
            ))

print(AIC1_M334) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M334[!is.na(AIC1_M334$AIC) & AIC1_M334$AIC == min(AIC1_M334$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M334.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_M334.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M334.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_M334.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M334.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M334.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_M334.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_M334.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M334.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M334.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_M334,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_M334$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M334.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_M334,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_M334$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_M334.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_M334,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_M334$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M334.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M334.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M334.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M334.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M334.", Mod.Sel1, sep ="")),
             get(paste("nls_M334.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M334.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M334.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M334.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M334.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M334.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M334.", Mod.Sel1, sep ="")),
               get(paste("nls_M334.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M334.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M334.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M334.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M334.", Mod.Sel1, sep ="")),
                 get(paste("nls_M334.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M334.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M334.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M334.", Mod.Sel1, sep ="")),
                    get(paste("nls_M334.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M334.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M334.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M334.", Mod.Sel1, sep ="")),
                      get(paste("nls_M334.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M334 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M334.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M334.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M334.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M334.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M334.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M334.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M334.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M334.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M334)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M334[!is.na(AIC2_M334$AIC) & AIC2_M334$AIC == min(AIC2_M334$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "M334",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M334.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M334.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "M334",]$ge.variance <- vcov(get(paste("nls_M334.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "M334",]$phi.variance <- vcov(get(paste("nls_M334.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "M334",]$alpha.variance <- vcov(get(paste("nls_M334.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "M334",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M334",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M334",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M334",]$A <- coefs["A"]
nls.param.df_nh[nls.param.df_nh$Code == "M334",]$k <- coefs["k"]

nls.param.df_nh[nls.param.df_nh$Code == "M334",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M334",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M334",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M334",]$A.2.5 <- intervals_low["A"]
nls.param.df_nh[nls.param.df_nh$Code == "M334",]$k.2.5 <- intervals_low["k"]

nls.param.df_nh[nls.param.df_nh$Code == "M334",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M334",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M334",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M334",]$A.97.5 <- intervals_high["A"]
nls.param.df_nh[nls.param.df_nh$Code == "M334",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M334.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M334.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M334.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M334.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_M334$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_M334.4 <- nls(f_4, data = G_M334, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M334$nls_weights.2), 
 )

## phi
try(
  nls_M334.5 <- nls(f_5, data=G_M334, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M334$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M334.6 <- nls(f_6, data = G_M334, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M334$nls_weights.2), 
 )

## test
if(exists("nls_M334.4") & exists("nls_M334.5") & exists("nls_M334.6")){
  print(anova(nls_M334.4, nls_M334.5, nls_M334.6))
} else if(exists("nls_M334.4") & exists("nls_M334.6")){
  print(anova(nls_M334.4, nls_M334.6))
} else if(exists("nls_M334.5") & exists("nls_M334.6")){
  print(anova(nls_M334.5, nls_M334.6))
} else if(exists("nls_M334.4") & exists("nls_M334.5")){
  print(anova(nls_M334.4, nls_M334.5))
}

## AIC comparison
AIC3_M334 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_M334[AIC2_M334$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_M334.4"), AIC(get("nls_M334.4")), NA),
            ifelse(exists("nls_M334.5"), AIC(get("nls_M334.5")), NA),
            ifelse(exists("nls_M334.6"), AIC(get("nls_M334.6")), NA)
            ))

print(AIC3_M334) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_M334[!is.na(AIC3_M334$AIC) & AIC3_M334$AIC == min(AIC3_M334$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "M334",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_nh[Best_mods.P_nh$Code == "M334",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_M334.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M334.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "M334",]$ge.variance <- vcov(get(paste("nls_M334.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "M334",]$phi.variance <- vcov(get(paste("nls_M334.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "M334",]$alpha.variance <- vcov(get(paste("nls_M334.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "M334",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M334",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M334",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M334",]$a <- coefs["a"]
nls.param.df_nh[nls.param.df_nh$Code == "M334",]$b <- coefs["b"]
nls.param.df_nh[nls.param.df_nh$Code == "M334",]$c <- coefs["c"]
nls.param.df_nh[nls.param.df_nh$Code == "M334",]$d <- coefs["d"]

nls.param.df_nh[nls.param.df_nh$Code == "M334",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M334",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M334",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M334",]$a.2.5 <- intervals_low["a"]
nls.param.df_nh[nls.param.df_nh$Code == "M334",]$b.2.5 <- intervals_low["b"]
nls.param.df_nh[nls.param.df_nh$Code == "M334",]$c.2.5 <- intervals_low["c"]
nls.param.df_nh[nls.param.df_nh$Code == "M334",]$d.2.5 <- intervals_low["d"]

nls.param.df_nh[nls.param.df_nh$Code == "M334",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M334",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M334",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M334",]$a.97.5 <- intervals_high["a"]
nls.param.df_nh[nls.param.df_nh$Code == "M334",]$b.97.5 <- intervals_high["b"]
nls.param.df_nh[nls.param.df_nh$Code == "M334",]$c.97.5 <- intervals_high["c"]
nls.param.df_nh[nls.param.df_nh$Code == "M334",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_M334.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_M334.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_M334.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_M334.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_M334 <- nlsResiduals(
  get(paste("nls_M334.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_M334)

## test residuals
if(length(G_M334$pltID) < 5001) {test.nlsResiduals(resid_M334)}

}   else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_M334_pred <- predict(get(paste("nls_M334.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M334$MEASTIME_t2, na.rm = T), max(G_M334$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M334$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M334$MEASTIME_t2, na.rm = T), max(G_M334$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M334$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_M334$DeltaPDSI, na.rm = T), max(G_M334$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M334$MEASTIME_t2, na.rm = T), max(G_M334$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M334$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_M334$B_L_prop, na.rm = T), max(G_M334$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_M334$DeltaPDSI, na.rm = T), max(G_M334$STDAGE_t2)))
                      } )

G_M334_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_M334$STDAGE_t2),by = 1),  
                            "fitted"=G_M334_pred)

## plot
gg.M334 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M334, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M334, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M334))), breaks = cutvec_M334) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_M334_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_M334_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("M334 - Black Hills Coniferous Forest") + 
          
          #ylim(0, max(G_M334_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_M334,1)*1.05), expand = c(0,0))

gg.M334

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_M334 <- data.frame(
  bin = as.factor(levels(cut(G_M334$STDAGE_t2, cutvec_M334))),
  data.mean = tapply(G_M334$B_plt_t2_MgHa, cut(G_M334$STDAGE_t2, cutvec_M334), 
                     mean), 
  data.CI.high =  tapply(G_M334$B_plt_t2_MgHa, cut(G_M334$STDAGE_t2, cutvec_M334), 
                    high.CI), 
  data.CI.low = tapply(G_M334$B_plt_t2_MgHa, cut(G_M334$STDAGE_t2, cutvec_M334),
                    low.CI), 
  pred.mean = G_M334_pred_df[G_M334_pred_df$STDAGE_t2 %in% bin_mids_M334,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M334 <-  DM_compare_M334 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M334$bin)[gtools::mixedorder(levels(DM_compare_M334$bin))]))

## ggplot
gg.M334.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M334) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M334))), 
                              labels = levels(DM_compare_M334$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("M334 - Black Hills Coniferous Forest",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +        
           theme_classic() + 
           # xlim(min(DM_compare_M334$data.CI.low)-0.25, max(DM_compare_M334$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_M334$pred.CI.low)-0.25, max(DM_compare_M334$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M334.B2

}
```

## M341 - Nevada-Utah Mountains Semi-Desert - Coniferous Forest - Alpine Meadow
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_M341 <- round(quantile(G_M341$STDAGE_t2, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M341)))){
  cutvec_M341 <- round(quantile(G_M341$STDAGE_t2, seq(0,1, length.out = 11)))
}

bin_mids_M341 <- unname(round(cutvec_M341[-length(cutvec_M341)] + diff(cutvec_M341)/2))

#### add weights data column
## first get the correct bin  - assign as column in data frame
G_M341$STDAGE_t2_bin<-  cut(G_M341$STDAGE_t2, cutvec_M341)
## then get bin means
G_M341_bin_means <- tapply(G_M341$B_plt_t2_MgHa, cut(G_M341$STDAGE_t2,  cutvec_M341), mean)

## make column weights.2
G_M341$nls_weights.2 <- as.numeric(1/(G_M341_bin_means[match(G_M341$STDAGE_t2_bin, names(G_M341_bin_means))])^2)

}
```

### model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_M341.1 <- nls(f_1, data = G_M341, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_M341$nls_weights.2), 
 )

## phi
try(
  nls_M341.2 <- nls(f_2, data=G_M341, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_M341$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M341.3 <- nls(f_3 , data = G_M341, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_M341$nls_weights.2), 
 )

## test
if(exists("nls_M341.1") & exists("nls_M341.2") & exists("nls_M341.3")){
  print(anova(nls_M341.1, nls_M341.2, nls_M341.3))
} else if(exists("nls_M341.2") & exists("nls_M341.3")){
  print(anova(nls_M341.2, nls_M341.3))
} else if(exists("nls_M341.1") & exists("nls_M341.2")){
  print(anova(nls_M341.1, nls_M341.2))
}
 
## AIC comparison
AIC1_M341 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_M341.1"), AIC(get("nls_M341.1")), NA),
            ifelse(exists("nls_M341.2"), AIC(get("nls_M341.2")), NA),
            ifelse(exists("nls_M341.3"), AIC(get("nls_M341.3")), NA)
            ))

print(AIC1_M341) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M341[!is.na(AIC1_M341$AIC) & AIC1_M341$AIC == min(AIC1_M341$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M341.",  Mod.Sel1, sep =""))) )  #model summary

}
```
#### summary 
* simple model: `r ifelse(exists("nls_M341.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M341.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_M341.3"), "fits", "does not fit")`

### model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M341.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M341.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_M341.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_M341.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M341.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M341.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "a", sep ="")), 
          data = G_M341,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_M341$nls_weights.2))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M341.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "b", sep ="")), 
          data = G_M341,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_M341$nls_weights.2)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_M341.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("f_", Mod.Sel1, "c", sep ="")), 
          data = G_M341,
          start = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_M341$nls_weights.2))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M341.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M341.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M341.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M341.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M341.", Mod.Sel1, sep ="")),
             get(paste("nls_M341.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M341.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M341.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M341.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M341.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M341.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M341.", Mod.Sel1, sep ="")),
               get(paste("nls_M341.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M341.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M341.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M341.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M341.", Mod.Sel1, sep ="")),
                 get(paste("nls_M341.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M341.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M341.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M341.", Mod.Sel1, sep ="")),
                    get(paste("nls_M341.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M341.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M341.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M341.", Mod.Sel1, sep ="")),
                      get(paste("nls_M341.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M341 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M341.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M341.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M341.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M341.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M341.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M341.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M341.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M341.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M341)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M341[!is.na(AIC2_M341$AIC) & AIC2_M341$AIC == min(AIC2_M341$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "M341",]$Sel.Mod.2 <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M341.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M341.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "M341",]$ge.variance <- vcov(get(paste("nls_M341.",  Mod.Sel2, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "M341",]$phi.variance <- vcov(get(paste("nls_M341.",  Mod.Sel2, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "M341",]$alpha.variance <- vcov(get(paste("nls_M341.",  Mod.Sel2, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "M341",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M341",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M341",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M341",]$A <- coefs["A"]
nls.param.df_nh[nls.param.df_nh$Code == "M341",]$k <- coefs["k"]

nls.param.df_nh[nls.param.df_nh$Code == "M341",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M341",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M341",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M341",]$A.2.5 <- intervals_low["A"]
nls.param.df_nh[nls.param.df_nh$Code == "M341",]$k.2.5 <- intervals_low["k"]

nls.param.df_nh[nls.param.df_nh$Code == "M341",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M341",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M341",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M341",]$A.97.5 <- intervals_high["A"]
nls.param.df_nh[nls.param.df_nh$Code == "M341",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M341.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M341.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M341.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M341.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

### model selection 3

```{r}
if(fit.models == T) {

# define b.start
b.start <- mean(G_M341$B_plt_t2_MgHa, na.rm = T)  

# simple
try(
  nls_M341.4 <- nls(f_4, data = G_M341, 
                   start = c(ge=ge.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M341$nls_weights.2), 
 )

## phi
try(
  nls_M341.5 <- nls(f_5, data=G_M341, 
                   start = c(ge=ge.start, phi=phi.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, a= 1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M341$nls_weights.2), 
 )

# phi/alpha
try(
  nls_M341.6 <- nls(f_6, data = G_M341, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, a=a.start, b=b.start, c=c.start, d=d.start), 
                   lower = c(ge=-5, phi=-2, alpha= 0, a=0, b=0, c=0, d=0), 
                   upper = c(ge=5, phi=2, alpha= 2, a=1000, b=1000, c= 5000, d=10),
                   algorithm= "port",
                   weights = G_M341$nls_weights.2), 
 )

## test
if(exists("nls_M341.4") & exists("nls_M341.5") & exists("nls_M341.6")){
  print(anova(nls_M341.4, nls_M341.5, nls_M341.6))
} else if(exists("nls_M341.4") & exists("nls_M341.6")){
  print(anova(nls_M341.4, nls_M341.6))
} else if(exists("nls_M341.5") & exists("nls_M341.6")){
  print(anova(nls_M341.5, nls_M341.6))
} else if(exists("nls_M341.4") & exists("nls_M341.5")){
  print(anova(nls_M341.4, nls_M341.5))
}

## AIC comparison
AIC3_M341 <- data.frame(model = c(Mod.Sel2, 4,5,6), AIC = c(
            AIC2_M341[AIC2_M341$model == Mod.Sel2,]$AIC,
            ifelse(exists("nls_M341.4"), AIC(get("nls_M341.4")), NA),
            ifelse(exists("nls_M341.5"), AIC(get("nls_M341.5")), NA),
            ifelse(exists("nls_M341.6"), AIC(get("nls_M341.6")), NA)
            ))

print(AIC3_M341) ## print AIC3 table 
            
## min AIC model - store result from model selection 1
Mod.Sel3 <- AIC3_M341[!is.na(AIC3_M341$AIC) & AIC3_M341$AIC == min(AIC3_M341$AIC, na.rm = T),]$model

if(length(Mod.Sel3>0)) {

## best model -- write the best fitting model to Best_mods df
Best_mods.P_nh[Best_mods.P_nh$Code == "M341",]$Sel.Mod.3 <- Mod.Sel3
Best_mods.P_nh[Best_mods.P_nh$Code == "M341",]$Best.Mod <- Mod.Sel3

## write coefficients to table 
coefs <- coef(get(paste("nls_M341.",  Mod.Sel3, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M341.",  Mod.Sel3, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector


## get variance in ge, phi and alpha
nls.param.df_nh[nls.param.df_nh$Code == "M341",]$ge.variance <- vcov(get(paste("nls_M341.",  Mod.Sel3, sep ="")))["ge","ge"]

nls.param.df_nh[nls.param.df_nh$Code == "M341",]$phi.variance <- vcov(get(paste("nls_M341.",  Mod.Sel3, sep ="")))["phi","phi"]

nls.param.df_nh[nls.param.df_nh$Code == "M341",]$alpha.variance <- vcov(get(paste("nls_M341.",  Mod.Sel3, sep ="")))["alpha","alpha"]


nls.param.df_nh[nls.param.df_nh$Code == "M341",]$ge <- coefs["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M341",]$phi <- coefs["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M341",]$alpha <- coefs["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M341",]$a <- coefs["a"]
nls.param.df_nh[nls.param.df_nh$Code == "M341",]$b <- coefs["b"]
nls.param.df_nh[nls.param.df_nh$Code == "M341",]$c <- coefs["c"]
nls.param.df_nh[nls.param.df_nh$Code == "M341",]$d <- coefs["d"]

nls.param.df_nh[nls.param.df_nh$Code == "M341",]$ge.2.5 <- intervals_low["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M341",]$phi.2.5 <- intervals_low["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M341",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M341",]$a.2.5 <- intervals_low["a"]
nls.param.df_nh[nls.param.df_nh$Code == "M341",]$b.2.5 <- intervals_low["b"]
nls.param.df_nh[nls.param.df_nh$Code == "M341",]$c.2.5 <- intervals_low["c"]
nls.param.df_nh[nls.param.df_nh$Code == "M341",]$d.2.5 <- intervals_low["d"]

nls.param.df_nh[nls.param.df_nh$Code == "M341",]$ge.97.5 <- intervals_high["ge"]
nls.param.df_nh[nls.param.df_nh$Code == "M341",]$phi.97.5 <- intervals_high["phi"]
nls.param.df_nh[nls.param.df_nh$Code == "M341",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df_nh[nls.param.df_nh$Code == "M341",]$a.97.5 <- intervals_high["a"]
nls.param.df_nh[nls.param.df_nh$Code == "M341",]$b.97.5 <- intervals_high["b"]
nls.param.df_nh[nls.param.df_nh$Code == "M341",]$c.97.5 <- intervals_high["c"]
nls.param.df_nh[nls.param.df_nh$Code == "M341",]$d.97.5 <- intervals_high["d"]
## end write coefficients to table 

}

try(summary(get(paste("nls_M341.",  Mod.Sel3, sep =""))) ) #model summary

}
```

#### summary 
* simple log-normal model: `r ifelse(exists("nls_M341.4"), "fits", "does not fit")`
* log-normal phi model: `r ifelse(exists("nls_M341.5"), "fits", "does not fit")`
* log-normal phi-alpha model: `r ifelse(exists("nls_M341.6"), "fits", "does not fit")`

### plot residuals
```{r}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## calculate residuals
resid_M341 <- nlsResiduals(
  get(paste("nls_M341.",  Mod.Sel2, sep =""))
  )

### plot residuals
plot(resid_M341)

## test residuals
if(length(G_M341$pltID) < 5001) {test.nlsResiduals(resid_M341)}

}   else {print("cannot plot residuals")}
```

### predict and plot 
```{r, cache= T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

G_M341_pred <- predict(get(paste("nls_M341.",  Mod.Sel3, sep ="")),
                      newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M341$MEASTIME_t2, na.rm = T), max(G_M341$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M341$STDAGE_t2), by = 1))
                     } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M341$MEASTIME_t2, na.rm = T), max(G_M341$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M341$STDAGE_t2), by = 1),
                                   "DeltaPDSI" = rep(mean(G_M341$DeltaPDSI, na.rm = T), max(G_M341$STDAGE_t2)))
                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                        data.frame("MEASTIME_t2" = rep(mean(G_M341$MEASTIME_t2, na.rm = T), max(G_M341$STDAGE_t2)),
                                   "STDAGE_t2" = seq(1, max(G_M341$STDAGE_t2), by = 1),
                                   "B_L_prop" = rep(mean(G_M341$B_L_prop, na.rm = T), max(G_M341$STDAGE_t2)), 
                                   "DeltaPDSI" = rep(mean(G_M341$DeltaPDSI, na.rm = T), max(G_M341$STDAGE_t2)))
                      } )

G_M341_pred_df <- data.frame("STDAGE_t2"=seq(1,max(G_M341$STDAGE_t2),by = 1),  
                            "fitted"=G_M341_pred)

## plot
gg.M341 <- ggplot() +
          geom_point(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M341, alpha = 0.5, shape ="+", col = "#60606080") +
         
          stat_summary_bin(aes(x = STDAGE_t2, y = B_plt_t2_MgHa), data = G_M341, 
                            fun.data = function(x) {
                              res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                              names(res) <- c("ymin","y","ymax")
                              res}, 
                            col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M341))), breaks = cutvec_M341) +  
          
          #geom_ribbon(aes(x = STDAGE_t2, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
                      #data = G_M341_pred_df,  color = "#FF8000", fill ="#0072B280", alpha = 0.25, lty =3) +
          
          geom_line(aes(x = STDAGE_t2, y = fitted), data = G_M341_pred_df,  color = "#FF8000", alpha = 0.5, lwd = 2) + 
          
  
          theme_classic() + 
          labs(y = expression("Stand Biomass (Mg ha"^-1*")"), 
               x = "Stand Age (yrs)") +  ggtitle("M341 - Nevada-Utah Mountains Semi-Desert - Coniferous Forest - Alpine Meadow") + 
          
          #ylim(0, max(G_M341_pred_df$`Prop.97.5%` + 0.25)) + 
          scale_x_continuous(limits = c(0, tail(cutvec_M341,1)*1.05), expand = c(0,0))

gg.M341

}  else {print("cannot plot data with prediction")}
```


### plotting 2
```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & (length(Mod.Sel2) > 0 | length(Mod.Sel3) > 0) & fit.models == T) {

## data wrangling:
DM_compare_M341 <- data.frame(
  bin = as.factor(levels(cut(G_M341$STDAGE_t2, cutvec_M341))),
  data.mean = tapply(G_M341$B_plt_t2_MgHa, cut(G_M341$STDAGE_t2, cutvec_M341), 
                     mean), 
  data.CI.high =  tapply(G_M341$B_plt_t2_MgHa, cut(G_M341$STDAGE_t2, cutvec_M341), 
                    high.CI), 
  data.CI.low = tapply(G_M341$B_plt_t2_MgHa, cut(G_M341$STDAGE_t2, cutvec_M341),
                    low.CI), 
  pred.mean = G_M341_pred_df[G_M341_pred_df$STDAGE_t2 %in% bin_mids_M341,]$fitted) 

### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M341 <-  DM_compare_M341 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M341$bin)[gtools::mixedorder(levels(DM_compare_M341$bin))]))

## ggplot
gg.M341.B2 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M341) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M341))), 
                              labels = levels(DM_compare_M341$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +         
           labs(x = expression("observed biomass (Mg ha"^-1*")"), 
                y = expression("nls predicted biomass (Mg ha"^-1*")"))  +
           ggtitle("M341 - Nevada-Utah Mountains Semi-Desert - Coniferous Forest - Alpine Meadow",
                   subtitle = substitute(paste("selected model = ", xx), list(xx=Mod.Sel3))) +        
           theme_classic() + 
           # xlim(min(DM_compare_M341$data.CI.low)-0.25, max(DM_compare_M341$data.CI.high)+0.25) + 
           # ylim(min(DM_compare_M341$pred.CI.low)-0.25, max(DM_compare_M341$pred.CI.high)+0.25) + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M341.B2

}
```

---

## Fitted parameters

### Best / selected models by ecoprovince 

```{r}
## clean up the Best_mods.P_nh dataframe
Best_mods.P_nh$Code <- as.factor(Best_mods.P_nh$Code)
Best_mods.P_nh$Ecoregion <- as.factor(Best_mods.P_nh$Ecoregion)

Best_mods.P_nh$Sel.Mod.2 <- as.factor(Best_mods.P_nh$Sel.Mod.2)
Best_mods.P_nh$Sel.Mod.3 <- as.factor(Best_mods.P_nh$Sel.Mod.3)
Best_mods.P_nh$Best.Mod <- as.factor(Best_mods.P_nh$Best.Mod)


knitr::kable(Best_mods.P_nh) %>% kableExtra::kable_material(c("striped", "hover"))        
```

### table by ecoprovince

```{r, echo = FALSE, cache= T, warning = FALSE}
## clean up the table -- remove the -9999
nls.param.df_nh[nls.param.df_nh == -9999] <- NA

knitr::kable(nls.param.df_nh) %>% kableExtra::kable_material(c("striped", "hover"))                      
```

### plot ge

```{r, echo= FALSE, message = FALSE, warning = FALSE, out.width = "200%"}
## order data
nls.param.df_nh$Ecoregion<- factor(nls.param.df_nh$Ecoregion, levels = nls.param.df_nh[rev(order(nls.param.df_nh$ge)), "Ecoregion"])

library(ggplot2)

#### create color vector 
col_vec.ge <- rep(NA, length(nls.param.df_nh$ge))

for (i in 1:length(nls.param.df_nh$ge)) {
  if(is.na(nls.param.df_nh$ge[i])){
     col_vec.ge[i] <-  "white"
  } else if(nls.param.df_nh$ge.2.5[i]>0) {
       col_vec.ge[i] <- scales::muted("green")  
    } else if(nls.param.df_nh$ge.97.5[i]<0){
          col_vec.ge[i] <- scales::muted("red") 
      } else {
              col_vec.ge[i] <- "gray50"
        }
}

## plot
gg.ge_ECOSUBCD <- ggplot(aes(x=Ecoregion, y=ge, shape = region), 
                        data = nls.param.df_nh) + 
                 geom_hline(yintercept =0, lty = 2) +
                 geom_point(size = 2, col = col_vec.ge) + 
                 geom_errorbar(aes(ymax = ge.2.5, ymin = ge.97.5), 
                               col = col_vec.ge) + 
                 theme_classic() + #coord_flip() + 
                 labs(y =expression(italic(ge)*" (% "*year^-1*")"), x = "Ecoregion") + 
                 scale_shape_manual(values = c(16,15,17)) + 
                 theme(legend.position = "top", 
                       axis.text.x = element_text(size = 5, angle = 45, hjust = 1, vjust = 1,)) +
                 ylim(c(-6,8)) 

# tiff(file = "GE_nls3_plotB_StdAge_ReconciledG.tiff", width = 15, height = 12, units = "cm", res = 600, compression = "lzw")
gg.ge_ECOSUBCD
# dev.off()
```

#### map
```{r, message = F, warning = F}
############################################################
##################################### CODE FOR MAP PREP
############################################################

## libraries
library(tidyverse)
library(rgdal)
library(broom)
library(ggplot2)
library(ggpattern)
library(ggthemes)

############################################################
## read in the shape file 
spdf <- readOGR(dsn="C:/Users/hogan.jaaron/Dropbox/FIA_R/Mapping/S_USA.EcoMapProvinces/S_USA.EcoMapProvinces.shp")  
# spdf <- readOGR(dsn="C:/Users/hogie/Dropbox/FIA_R/Mapping/S_USA.EcoMapProvinces/S_USA.EcoMapProvinces.shp")       # if working on P-50

## change projection 
spdf <- spTransform(spdf, CRS("+init=epsg:5070"))

### tidy up 
spdf_tidy <- tidy(spdf)

## left_join
spdf$id <- row.names(spdf)
spdf_tidy <- left_join(spdf_tidy, spdf@data)

## add in the growth Enhancemnet data
## including missing rows
ge_df <-  data.frame( ECOPROVCD = as.factor(c(nls.param.df_nh$Code,"Water")), ge = as.numeric(c(nls.param.df_nh[,"ge"], NA)))

### add row for fill classification - statistically significant ge / data deficient etc.
ge_df$classification <- rep(NA, length(ge_df$ge))
  
for (i in 1:length(ge_df$ge)) {
  if(ge_df$ECOPROVCD[i] == "Water") {
    ge_df$classification[i] <- "Water"
    }else if(is.na(ge_df$ge[i])){
      ge_df$classification[i] <-  "data deficient"
      } else if(nls.param.df_nh$ge.2.5[i]>0) {
        ge_df$classification[i] <- "signif"  
        } else if(nls.param.df_nh$ge.97.5[i]<0) {
          ge_df$classification[i] <- "signif" 
          } else {
            ge_df$classification[i] <- "non-significant"
            } 
}

ge_df$classification <- as.factor(ge_df$classification)

### left_join
spdf_tidy <- left_join(spdf_tidy, ge_df, by = c("MAP_UNIT_S" = "ECOPROVCD"), keep = F)

############ ---------------------------------------------------------------------------------------  ############
######################### MAPPING ###################

## https://timogrossenbacher.ch/2016/12/beautiful-thematic-maps-with-ggplot2-only/

## theme
theme_map <- function(...) {
  theme_minimal() +
    theme(
      text = element_text(family = "Ubuntu Regular", color = "#22211d"),
      axis.line = element_blank(),
      axis.text.x = element_blank(),
      axis.text.y = element_blank(),
      axis.ticks = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      # panel.grid.minor = element_line(color = "#ebebe5", size = 0.2),
      panel.grid.major = element_line(color = "#ebebe5", size = 0.2),
      panel.grid.minor = element_blank(),
      plot.background = element_rect(fill = "#f5f5f2", color = NA), 
      panel.background = element_rect(fill = "#f5f5f2", color = NA), 
      legend.background = element_rect(fill = "#f5f5f2", color = NA),
      panel.border = element_blank(),
      ...
    )
}

```


```{r, message=F, warning = F}
library(ggnewscale)

mapper2  <- ggplot(aes(x = long, y = lat, group = group), data = spdf_tidy) +
  geom_polygon(aes_string(fill = "ge"), data = spdf_tidy[spdf_tidy$classification == "signif",], color = "black", size = 0.1)  +
  metR::scale_fill_divergent(
                       low = scales::muted("red"),
                       mid = "white",
                       high = scales::muted("green"),
                       name = "biomass stock enhancement (%/yr)",
                       # here we use guide_colourbar because it is still a continuous scale
                       guide = guide_colorbar(
                       direction = "horizontal",
                       barheight = unit(2, units = "mm"),
                       barwidth = unit(50, units = "mm"),
                       draw.ulim = F,
                       title.position = 'top',
                       # some shifting around
                       title.hjust = 0.5,
                       label.hjust = 0.5)) +   
  new_scale_fill() + 
  geom_polygon(aes_string(fill="classification"), data = spdf_tidy[!spdf_tidy$classification == "signif",], color = "black", size = 0.1)  +
  scale_fill_manual(values = c("#404040", "#BABABA", "dark blue")) +
  coord_equal() + theme(legend.position = "bottom") +
  theme_map() 
 

#+ 
  #geom_segment(data=lines, aes(x= x, y = y , xend = xend, yend = yend), 
               #inherit.aes = F, color = "black", alpha = 0.25)

# tiff(filename = "GE_mapper_biomass_age_11.7.22.tiff", width = 15, height = 8, units = "cm", res= 600, compression = "lzw")
mapper2 

# dev.off()
```


### plot phi (effect of DeltaPDSI)

```{r, echo= FALSE, message = FALSE, warning = FALSE, out.width = "200%"}
## order data 
nls.param.df_nh <- nls.param.df_nh[order(nls.param.df_nh$phi),]

nls.param.df_nh$Ecoregion<- factor(nls.param.df_nh$Ecoregion, levels = nls.param.df_nh[order(nls.param.df_nh$phi), "Ecoregion"])

library(ggplot2)

#### create color vector 
col_vec.phi <- rep(NA, length(nls.param.df_nh$phi))

for (i in 1:length(nls.param.df_nh$phi)) {
  if(is.na(nls.param.df_nh$phi[i])){
     col_vec.phi[i] <-  "white"
  } else if(nls.param.df_nh$phi.2.5[i]>0) {
       col_vec.phi[i] <- scales::muted("blue") 
    } else if(nls.param.df_nh$phi.97.5[i]<0){
          col_vec.phi[i] <- scales::muted("orange")
      } else {
              col_vec.phi[i] <- "gray50"
        }
}

## plot
gg.phi_ECOSUBCD <- ggplot(aes(x=Ecoregion, y=phi, shape = region), 
                        data = nls.param.df_nh) + 
                 geom_hline(yintercept =0, lty = 2) +
                 geom_point(size = 2, col = col_vec.phi) + 
                 geom_errorbar(aes(ymax = phi.2.5, ymin = phi.97.5), 
                               col = col_vec.phi) + 
                 theme_classic() + #coord_flip() + 
                 labs(y = expression(italic("\u03D5")), x = "Ecoregion") + 
                 scale_shape_manual(values = c(16,15,17)) + 
                 theme(legend.position = "top", 
                       axis.text.x = element_text(size = 5, angle = 45, hjust = 1, vjust = 1)) + 
                 ylim(c(-0.4,0.3))

#tiff(file = "nls_ge_byEcoregion_part1_9.2.2022.tiff", width = 25, height = 14, units = "cm", res = 600, compression = "lzw")
gg.phi_ECOSUBCD
#dev.off()
```

### plot alpha (biomass compensation effect)

```{r, echo= FALSE, message = FALSE, warning = FALSE, out.width = "200%"}
## order data
nls.param.df_nh <- nls.param.df_nh[order(nls.param.df_nh$alpha),]

nls.param.df_nh$Ecoregion<- factor(nls.param.df_nh$Ecoregion, levels = nls.param.df_nh[order(nls.param.df_nh$alpha), "Ecoregion"])

library(ggplot2)

## plot
gg.alpha_ECOSUBCD <- ggplot(aes(x=Ecoregion, y=alpha, shape = region), 
                        data = nls.param.df_nh) + 
                 geom_hline(yintercept = 0.5, lty = 2, col = "gray") +
                 geom_hline(yintercept = 1, lty = 2, col = "gray") +
                 geom_hline(yintercept = 0) +
                 #geom_hline(yintercept = -0.5, lty = 2, col = "gray") +
                 #geom_hline(yintercept = -1, lty = 2, col = "gray") +
                 geom_point(size = 2) + 
                 geom_errorbar(aes(ymax = alpha.2.5, ymin = alpha.97.5)) + 
                 theme_classic() + coord_flip() + 
                 labs(y =expression(italic("\u03B1")), x = "Ecoregion") + 
                 scale_shape_manual(values = c(16,15,17)) + 
                 theme(legend.position = "top") + ylim(c(-0.5,1.5))

#tiff(file = "nls_ge_byEcoregion_part1_9.2.2022.tiff", width = 25, height = 14, units = "cm", res = 600, compression = "lzw")
gg.alpha_ECOSUBCD
#dev.off()
```

### plot A (asymptote of B)

```{r}
## order data
nls.param.df_nh <- nls.param.df_nh[order(nls.param.df_nh$A),]

nls.param.df_nh$Ecoregion<- factor(nls.param.df_nh$Ecoregion, levels = nls.param.df_nh[order(nls.param.df_nh$A), "Ecoregion"])

library(ggplot2)

## plot
gg.A_ECOSUBCD <- ggplot(aes(x=Ecoregion, y=A, shape = region), 
                        data = nls.param.df_nh) + 
                 #geom_hline(yintercept =0, lty = 2) +
                 geom_point(size = 2) + 
                 geom_errorbar(aes(ymax = A.2.5, ymin = A.97.5)) + 
                 theme_classic() + coord_flip() + 
                 labs(y = expression(italic("A")*" (Mg ha"^-1*")"), x = "Ecoregion") + 
                 scale_shape_manual(values = c(16,15,17)) + 
                 theme(legend.position = "top") + ylim(c(0,1500))

#tiff(file = "nls_ge_byEcoregion_part1_9.2.2022.tiff", width = 25, height = 14, units = "cm", res = 600, compression = "lzw")
gg.A_ECOSUBCD
#dev.off()
```

### plot k (stand age at half biomass asymptote)

```{r}
## order data
nls.param.df_nh <- nls.param.df_nh[order(nls.param.df_nh$k),]

nls.param.df_nh$Ecoregion<- factor(nls.param.df_nh$Ecoregion, levels = nls.param.df_nh[order(nls.param.df_nh$k), "Ecoregion"])

library(ggplot2)

## plot
gg.k_ECOSUBCD <- ggplot(aes(x=Ecoregion, y=k, shape = region), 
                        data = nls.param.df_nh) + 
                 geom_hline(yintercept =0, lty = 2) +
                 geom_point(size = 2) + 
                 geom_errorbar(aes(ymax = k.2.5, ymin = k.97.5)) + 
                 theme_classic() + coord_flip() + 
                 labs(y = expression(italic("k")*" (yrs)"), x = "Ecoregion") + 
                 scale_shape_manual(values = c(16,15,17)) + 
                 theme(legend.position = "top") + ylim(c(-100,1500))

#tiff(file = "nls_ge_byEcoregion_part1_9.2.2022.tiff", width = 25, height = 14, units = "cm", res = 600, compression = "lzw")
gg.k_ECOSUBCD
#dev.off()
```

## Caclulations - weighted averages 

### ge (stand biomass enhancement factor in % 2000-2021)
```{r}
### set up for calculations 

## big N - the total number of plots all ecoprovs
N <- sum(nls.param.df_nh$`n.plots`)

## add weights 
nls.param.df_nh$weight.sq <- (nls.param.df_nh$n.plots / N)^2


weighted.ge.df <-  data.frame(
  region = c("entire US", "pacific",  "east", "interior west"),
## all
  "weighted ge" = c(sum(nls.param.df_nh$ge*nls.param.df_nh$n.plots, na.rm = T) / N,
                    
## pacific
sum(nls.param.df_nh[nls.param.df_nh$region == "pacific",]$ge * nls.param.df_nh[nls.param.df_nh$region == "pacific",]$n.plots, na.rm = T) / N,

## east 
sum(nls.param.df_nh[nls.param.df_nh$region == "east",]$ge * nls.param.df_nh[nls.param.df_nh$region == "east",]$n.plots, na.rm = T) / N,

## west
sum(nls.param.df_nh[nls.param.df_nh$region == "interior west",]$ge * nls.param.df_nh[nls.param.df_nh$region == "interior west",]$n.plots, na.rm = T) / N),

###############################
## weighted ge S.E. calculation
###############################

## all
  "weighted.ge.std_Error" = c(
    sqrt(sum(nls.param.df_nh$ge.variance * nls.param.df_nh$weight.sq, na.rm = T)),
    
## pacific
sqrt(sum(nls.param.df_nh[nls.param.df_nh$region == "pacific",]$ge.variance * nls.param.df_nh[nls.param.df_nh$region == "pacific",]$weight.sq, na.rm = T)),
                               
## east
sqrt(sum(nls.param.df_nh[nls.param.df_nh$region == "east",]$ge.variance * nls.param.df_nh[nls.param.df_nh$region == "east",]$weight.sq, na.rm = T)),

## west
sqrt(sum(nls.param.df_nh[nls.param.df_nh$region == "interior west",]$ge.variance * nls.param.df_nh[nls.param.df_nh$region == "interior west",]$weight.sq, na.rm = T)))

)

weighted.ge.df$`95 % CI, upper` <-  weighted.ge.df$weighted.ge + 1.96* weighted.ge.df$weighted.ge.std_Error

weighted.ge.df$`95 % CI, lower` <-  weighted.ge.df$weighted.ge - 1.96* weighted.ge.df$weighted.ge.std_Error


weighted.ge.df
```

### phi (effect of DeltaPDSI)
```{r}
weighted.phi.df <-  data.frame(
  region = c("entire US", "pacific", "east", "interior west"),
## all
  "weighted phi" = c(sum(nls.param.df_nh$phi*nls.param.df_nh$n.plots, na.rm = T) / N,
                    
## pacific
sum(nls.param.df_nh[nls.param.df_nh$region == "pacific",]$phi * nls.param.df_nh[nls.param.df_nh$region == "pacific",]$n.plots, na.rm = T) / N,

## east 
sum(nls.param.df_nh[nls.param.df_nh$region == "east",]$phi * nls.param.df_nh[nls.param.df_nh$region == "east",]$n.plots, na.rm = T) / N,

## west
sum(nls.param.df_nh[nls.param.df_nh$region == "interior west",]$phi * nls.param.df_nh[nls.param.df_nh$region == "interior west",]$n.plots, na.rm = T) / N),

###############################
## weighted ge S.E. calculation
###############################

## all
  "weighted.phi.std_Error" = c(
    sqrt(sum(nls.param.df_nh$phi.variance * nls.param.df_nh$weight.sq, na.rm = T)) / N,
    
## pacific
sqrt(sum(nls.param.df_nh[nls.param.df_nh$region == "pacific",]$phi.variance * nls.param.df_nh[nls.param.df_nh$region == "pacific",]$weight.sq, na.rm = T)) / N,
                               
## east
sqrt(sum(nls.param.df_nh[nls.param.df_nh$region == "east",]$phi.variance * nls.param.df_nh[nls.param.df_nh$region == "east",]$weight.sq, na.rm = T))/ N,

## west
sqrt(sum(nls.param.df_nh[nls.param.df_nh$region == "interior west",]$phi.variance * nls.param.df_nh[nls.param.df_nh$region == "interior west",]$weight.sq, na.rm = T)) / N)

)

weighted.phi.df$`95 % CI, upper` <-  weighted.phi.df$weighted.phi + 1.96* weighted.phi.df$weighted.phi.std_Error

weighted.phi.df$`95 % CI, lower` <-  weighted.phi.df$weighted.phi - 1.96* weighted.phi.df$weighted.phi.std_Error


weighted.phi.df
```

### alpha (biomass compensation effect)
```{r}
weighted.alpha.df <-  data.frame(
  region = c("entire US", "pacific", "east", "interior west"),
## all
  "weighted alpha" = c(sum(nls.param.df_nh$alpha * nls.param.df_nh$n.plots, na.rm = T) / N,
                    
## pacific
sum(nls.param.df_nh[nls.param.df_nh$region == "pacific",]$alpha * nls.param.df_nh[nls.param.df_nh$region == "pacific",]$n.plots, na.rm = T) / N,

## east 
sum(nls.param.df_nh[nls.param.df_nh$region == "east",]$alpha * nls.param.df_nh[nls.param.df_nh$region == "east",]$n.plots, na.rm = T) / N,

## west
sum(nls.param.df_nh[nls.param.df_nh$region == "interior west",]$alpha * nls.param.df_nh[nls.param.df_nh$region == "interior west",]$n.plots, na.rm = T) / N),

###############################
## weighted ge S.E. calculation
###############################

## all
  "weighted.alpha.std_Error" = c(
    sqrt(sum(nls.param.df_nh$alpha.variance * nls.param.df_nh$weight.sq, na.rm = T)) / N,
    
## pacific
sqrt(sum(nls.param.df_nh[nls.param.df_nh$region == "pacific",]$alpha.variance * nls.param.df_nh[nls.param.df_nh$region == "pacific",]$weight.sq, na.rm = T)) / N,
                               
## east
sqrt(sum(nls.param.df_nh[nls.param.df_nh$region == "east",]$alpha.variance * nls.param.df_nh[nls.param.df_nh$region == "east",]$weight.sq, na.rm = T))/ N,

## west
sqrt(sum(nls.param.df_nh[nls.param.df_nh$region == "interior west",]$alpha.variance * nls.param.df_nh[nls.param.df_nh$region == "interior west",]$weight.sq, na.rm = T)) / N)

)

weighted.alpha.df$`95 % CI, upper` <-  weighted.alpha.df$weighted.alpha + 1.96* weighted.alpha.df$weighted.alpha.std_Error

weighted.alpha.df$`95 % CI, lower` <-  weighted.alpha.df$weighted.alpha - 1.96* weighted.alpha.df$weighted.alpha.std_Error


weighted.alpha.df
```

### A (asymptote of forest biomass in Mg/ha)
```{r}
weighted.A.df <-  data.frame(
  region = c("entire US", "pacific",  "east", "interior west"),
  ## all
 "weighted A" = c(sum(nls.param.df_nh$A*nls.param.df_nh$n.plots, na.rm =T) /sum(nls.param.df_nh$n.plots, na.rm =T) 
,
## pacific
sum(nls.param.df_nh[nls.param.df_nh$region == "pacific",]$A * nls.param.df_nh[nls.param.df_nh$region == "pacific",]$n.plots, na.rm =T) / sum(nls.param.df_nh[nls.param.df_nh$region == "pacific",]$n.plots, na.rm =T) 
,
## east 
sum(nls.param.df_nh[nls.param.df_nh$region == "east",]$A * nls.param.df_nh[nls.param.df_nh$region == "east",]$n.plots, na.rm =T) / sum(nls.param.df_nh[nls.param.df_nh$region == "east",]$n.plots, na.rm =T)
,
## west
sum(nls.param.df_nh[nls.param.df_nh$region == "interior west",]$A * nls.param.df_nh[nls.param.df_nh$region == "west",]$n.plots, na.rm =T) / sum(nls.param.df_nh[nls.param.df_nh$region == "interior west",]$n.plots, na.rm =T)))


weighted.A.df
```


### K (stand age at half maturation in years)
```{r}
weighted.k.df <-  data.frame(
  region = c("entire US", "pacific", "east", "interior west"),
## all
 "weighted k" = c(sum(nls.param.df_nh$k*nls.param.df_nh$n.plots, na.rm =T) /sum(nls.param.df_nh$n.plots, na.rm =T) 
,
## pacific
sum(nls.param.df_nh[nls.param.df_nh$region == "pacific",]$k * nls.param.df_nh[nls.param.df_nh$region == "pacific",]$n.plots, na.rm =T) / sum(nls.param.df_nh[nls.param.df_nh$region == "pacific",]$n.plots, na.rm =T) 
,
## east 
sum(nls.param.df_nh[nls.param.df_nh$region == "east",]$k * nls.param.df_nh[nls.param.df_nh$region == "east",]$n.plots, na.rm =T) / sum(nls.param.df_nh[nls.param.df_nh$region == "east",]$n.plots, na.rm =T)
,
## west
sum(nls.param.df_nh[nls.param.df_nh$region == "interior west",]$k * nls.param.df_nh[nls.param.df_nh$region == "interior west",]$n.plots, na.rm =T) / sum(nls.param.df_nh[nls.param.df_nh$region == "interior west",]$n.plots, na.rm =T)))

weighted.k.df
```

---
```{r}
# # left join fitted values to data by STDAGE_t2
# G_211 <-  left_join(G_211,G_211_pred_df, by= c("STDAGE_t1"="STDAGE_t2"))
# colnames(G_211)[63] <- "B_plt_t1_pred" 
# 
# # left join fitted values to data by STDAGE_t2
# G_211 <-  left_join(G_211,G_211_pred_df)
# colnames(G_211)[64] <- "B_plt_t2_pred"  ## rename column 
# 
# # calculate delta-B due to delta STDAGE -- simple subtraction
# G_211$DeltaB_DeltaSTDAGE <- (G_211$B_plt_t2_pred - G_211$B_plt_t1_pred) / REMPER
```


## Model Bookeeping

### 1. Delta-B due to Delta-STDAGE

```{r}
#### 211

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "211",]$Best.Mod == "NA"){
    
    G_211$B_pred_age2 <- predict(get(paste("nls_211.",  Best_mods.P_nh[Best_mods.P_nh$Code == 211,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_211$MEASTIME_t1,
                                               "STDAGE_t2" = G_211$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_211$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_211$STDAGE_t2,
                                                 "DeltaPDSI" = G_211$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_211$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_211$STDAGE_t2,
                                                   "B_L_prop" = G_211$B_L_prop, 
                                                   "DeltaPDSI" = G_211$DeltaPDSI)
                                        } )
    
    G_211$B_pred_age1 <- predict(get(paste("nls_211.",  Best_mods.P_nh[Best_mods.P_nh$Code == 211,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_211$MEASTIME_t1,
                                               "STDAGE_t2" = G_211$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_211$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_211$STDAGE_t1,
                                                 "DeltaPDSI" = G_211$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_211$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_211$STDAGE_t1,
                                                   "B_L_prop" = G_211$B_L_prop, 
                                                   "DeltaPDSI" = G_211$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_211$DeltaB_age <- (G_211$B_pred_age2 - G_211$B_pred_age1) / G_211$REMPER
}
    
    
#### 212

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "212",]$Best.Mod == "NA"){
    
    G_212$B_pred_age2 <- predict(get(paste("nls_212.",  Best_mods.P_nh[Best_mods.P_nh$Code == 212,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_212$MEASTIME_t1,
                                               "STDAGE_t2" = G_212$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_212$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_212$STDAGE_t2,
                                                 "DeltaPDSI" = G_212$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_212$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_212$STDAGE_t2,
                                                   "B_L_prop" = G_212$B_L_prop, 
                                                   "DeltaPDSI" = G_212$DeltaPDSI)
                                        } )
    
    G_212$B_pred_age1 <- predict(get(paste("nls_212.",  Best_mods.P_nh[Best_mods.P_nh$Code == 212,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_212$MEASTIME_t1,
                                               "STDAGE_t2" = G_212$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_212$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_212$STDAGE_t1,
                                                 "DeltaPDSI" = G_212$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_212$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_212$STDAGE_t1,
                                                   "B_L_prop" = G_212$B_L_prop, 
                                                   "DeltaPDSI" = G_212$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_212$DeltaB_age <- (G_212$B_pred_age2 - G_212$B_pred_age1) / G_212$REMPER
}

#### 221

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "221",]$Best.Mod == "NA"){
    
    G_221$B_pred_age2 <- predict(get(paste("nls_221.",  Best_mods.P_nh[Best_mods.P_nh$Code == 221,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_221$MEASTIME_t1,
                                               "STDAGE_t2" = G_221$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_221$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_221$STDAGE_t2,
                                                 "DeltaPDSI" = G_221$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_221$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_221$STDAGE_t2,
                                                   "B_L_prop" = G_221$B_L_prop, 
                                                   "DeltaPDSI" = G_221$DeltaPDSI)
                                        } )
    
    G_221$B_pred_age1 <- predict(get(paste("nls_221.",  Best_mods.P_nh[Best_mods.P_nh$Code == 221,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_221$MEASTIME_t1,
                                               "STDAGE_t2" = G_221$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_221$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_221$STDAGE_t1,
                                                 "DeltaPDSI" = G_221$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_221$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_221$STDAGE_t1,
                                                   "B_L_prop" = G_221$B_L_prop, 
                                                   "DeltaPDSI" = G_221$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_221$DeltaB_age <- (G_221$B_pred_age2 - G_221$B_pred_age1) / G_221$REMPER
}

#### 222

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "222",]$Best.Mod == "NA"){
    
    G_222$B_pred_age2 <- predict(get(paste("nls_222.",  Best_mods.P_nh[Best_mods.P_nh$Code == 222,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_222$MEASTIME_t1,
                                               "STDAGE_t2" = G_222$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_222$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_222$STDAGE_t2,
                                                 "DeltaPDSI" = G_222$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_222$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_222$STDAGE_t2,
                                                   "B_L_prop" = G_222$B_L_prop, 
                                                   "DeltaPDSI" = G_222$DeltaPDSI)
                                        } )
    
    G_222$B_pred_age1 <- predict(get(paste("nls_222.",  Best_mods.P_nh[Best_mods.P_nh$Code == 222,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_222$MEASTIME_t1,
                                               "STDAGE_t2" = G_222$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_222$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_222$STDAGE_t1,
                                                 "DeltaPDSI" = G_222$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_222$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_222$STDAGE_t1,
                                                   "B_L_prop" = G_222$B_L_prop, 
                                                   "DeltaPDSI" = G_222$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_222$DeltaB_age <- (G_222$B_pred_age2 - G_222$B_pred_age1) / G_222$REMPER
}

#### 223

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "223",]$Best.Mod == "NA"){
    
    G_223$B_pred_age2 <- predict(get(paste("nls_223.",  Best_mods.P_nh[Best_mods.P_nh$Code == 223,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_223$MEASTIME_t1,
                                               "STDAGE_t2" = G_223$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_223$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_223$STDAGE_t2,
                                                 "DeltaPDSI" = G_223$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_223$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_223$STDAGE_t2,
                                                   "B_L_prop" = G_223$B_L_prop, 
                                                   "DeltaPDSI" = G_223$DeltaPDSI)
                                        } )
    
    G_223$B_pred_age1 <- predict(get(paste("nls_223.",  Best_mods.P_nh[Best_mods.P_nh$Code == 223,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_223$MEASTIME_t1,
                                               "STDAGE_t2" = G_223$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_223$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_223$STDAGE_t1,
                                                 "DeltaPDSI" = G_223$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_223$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_223$STDAGE_t1,
                                                   "B_L_prop" = G_223$B_L_prop, 
                                                   "DeltaPDSI" = G_223$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_223$DeltaB_age <- (G_223$B_pred_age2 - G_223$B_pred_age1) / G_223$REMPER
}

#### 231

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "231",]$Best.Mod == "NA"){
    
    G_231$B_pred_age2 <- predict(get(paste("nls_231.",  Best_mods.P_nh[Best_mods.P_nh$Code == 231,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_231$MEASTIME_t1,
                                               "STDAGE_t2" = G_231$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_231$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_231$STDAGE_t2,
                                                 "DeltaPDSI" = G_231$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_231$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_231$STDAGE_t2,
                                                   "B_L_prop" = G_231$B_L_prop, 
                                                   "DeltaPDSI" = G_231$DeltaPDSI)
                                        } )
    
    G_231$B_pred_age1 <- predict(get(paste("nls_231.",  Best_mods.P_nh[Best_mods.P_nh$Code == 231,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_231$MEASTIME_t1,
                                               "STDAGE_t2" = G_231$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_231$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_231$STDAGE_t1,
                                                 "DeltaPDSI" = G_231$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_231$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_231$STDAGE_t1,
                                                   "B_L_prop" = G_231$B_L_prop, 
                                                   "DeltaPDSI" = G_231$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_231$DeltaB_age <- (G_231$B_pred_age2 - G_231$B_pred_age1) / G_231$REMPER
}

#### 232

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "232",]$Best.Mod == "NA"){
    
    G_232$B_pred_age2 <- predict(get(paste("nls_232.",  Best_mods.P_nh[Best_mods.P_nh$Code == 232,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_232$MEASTIME_t1,
                                               "STDAGE_t2" = G_232$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_232$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_232$STDAGE_t2,
                                                 "DeltaPDSI" = G_232$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_232$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_232$STDAGE_t2,
                                                   "B_L_prop" = G_232$B_L_prop, 
                                                   "DeltaPDSI" = G_232$DeltaPDSI)
                                        } )
    
    G_232$B_pred_age1 <- predict(get(paste("nls_232.",  Best_mods.P_nh[Best_mods.P_nh$Code == 232,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_232$MEASTIME_t1,
                                               "STDAGE_t2" = G_232$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_232$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_232$STDAGE_t1,
                                                 "DeltaPDSI" = G_232$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_232$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_232$STDAGE_t1,
                                                   "B_L_prop" = G_232$B_L_prop, 
                                                   "DeltaPDSI" = G_232$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_232$DeltaB_age <- (G_232$B_pred_age2 - G_232$B_pred_age1) / G_232$REMPER
}

#### 234

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "234",]$Best.Mod == "NA"){
    
    G_234$B_pred_age2 <- predict(get(paste("nls_234.",  Best_mods.P_nh[Best_mods.P_nh$Code == 234,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_234$MEASTIME_t1,
                                               "STDAGE_t2" = G_234$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_234$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_234$STDAGE_t2,
                                                 "DeltaPDSI" = G_234$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_234$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_234$STDAGE_t2,
                                                   "B_L_prop" = G_234$B_L_prop, 
                                                   "DeltaPDSI" = G_234$DeltaPDSI)
                                        } )
    
    G_234$B_pred_age1 <- predict(get(paste("nls_234.",  Best_mods.P_nh[Best_mods.P_nh$Code == 234,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_234$MEASTIME_t1,
                                               "STDAGE_t2" = G_234$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_234$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_234$STDAGE_t1,
                                                 "DeltaPDSI" = G_234$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_234$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_234$STDAGE_t1,
                                                   "B_L_prop" = G_234$B_L_prop, 
                                                   "DeltaPDSI" = G_234$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_234$DeltaB_age <- (G_234$B_pred_age2 - G_234$B_pred_age1) / G_234$REMPER
}

#### 242

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "242",]$Best.Mod == "NA"){
    
    G_242$B_pred_age2 <- predict(get(paste("nls_242.",  Best_mods.P_nh[Best_mods.P_nh$Code == 242,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_242$MEASTIME_t1,
                                               "STDAGE_t2" = G_242$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_242$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_242$STDAGE_t2,
                                                 "DeltaPDSI" = G_242$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_242$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_242$STDAGE_t2,
                                                   "B_L_prop" = G_242$B_L_prop, 
                                                   "DeltaPDSI" = G_242$DeltaPDSI)
                                        } )
    
    G_242$B_pred_age1 <- predict(get(paste("nls_242.",  Best_mods.P_nh[Best_mods.P_nh$Code == 242,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_242$MEASTIME_t1,
                                               "STDAGE_t2" = G_242$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_242$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_242$STDAGE_t1,
                                                 "DeltaPDSI" = G_242$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_242$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_242$STDAGE_t1,
                                                   "B_L_prop" = G_242$B_L_prop, 
                                                   "DeltaPDSI" = G_242$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_242$DeltaB_age <- (G_242$B_pred_age2 - G_242$B_pred_age1) / G_242$REMPER
}

#### 251

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "251",]$Best.Mod == "NA"){
    
    G_251$B_pred_age2 <- predict(get(paste("nls_251.",  Best_mods.P_nh[Best_mods.P_nh$Code == 251,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_251$MEASTIME_t1,
                                               "STDAGE_t2" = G_251$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_251$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_251$STDAGE_t2,
                                                 "DeltaPDSI" = G_251$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_251$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_251$STDAGE_t2,
                                                   "B_L_prop" = G_251$B_L_prop, 
                                                   "DeltaPDSI" = G_251$DeltaPDSI)
                                        } )
    
    G_251$B_pred_age1 <- predict(get(paste("nls_251.",  Best_mods.P_nh[Best_mods.P_nh$Code == 251,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_251$MEASTIME_t1,
                                               "STDAGE_t2" = G_251$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_251$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_251$STDAGE_t1,
                                                 "DeltaPDSI" = G_251$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_251$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_251$STDAGE_t1,
                                                   "B_L_prop" = G_251$B_L_prop, 
                                                   "DeltaPDSI" = G_251$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_251$DeltaB_age <- (G_251$B_pred_age2 - G_251$B_pred_age1) / G_251$REMPER
}

#### 255

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "255",]$Best.Mod == "NA"){
    
    G_255$B_pred_age2 <- predict(get(paste("nls_255.",  Best_mods.P_nh[Best_mods.P_nh$Code == 255,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_255$MEASTIME_t1,
                                               "STDAGE_t2" = G_255$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_255$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_255$STDAGE_t2,
                                                 "DeltaPDSI" = G_255$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_255$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_255$STDAGE_t2,
                                                   "B_L_prop" = G_255$B_L_prop, 
                                                   "DeltaPDSI" = G_255$DeltaPDSI)
                                        } )
    
    G_255$B_pred_age1 <- predict(get(paste("nls_255.",  Best_mods.P_nh[Best_mods.P_nh$Code == 255,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_255$MEASTIME_t1,
                                               "STDAGE_t2" = G_255$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_255$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_255$STDAGE_t1,
                                                 "DeltaPDSI" = G_255$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_255$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_255$STDAGE_t1,
                                                   "B_L_prop" = G_255$B_L_prop, 
                                                   "DeltaPDSI" = G_255$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_255$DeltaB_age <- (G_255$B_pred_age2 - G_255$B_pred_age1) / G_255$REMPER
}

#### 261
if(!Best_mods.P_nh[Best_mods.P_nh$Code == "261",]$Best.Mod == "NA"){
    
    G_261$B_pred_age2 <- predict(get(paste("nls_261.",  Best_mods.P_nh[Best_mods.P_nh$Code == 261,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_261$MEASTIME_t1,
                                               "STDAGE_t2" = G_261$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_261$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_261$STDAGE_t2,
                                                 "DeltaPDSI" = G_261$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_261$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_261$STDAGE_t2,
                                                   "B_L_prop" = G_261$B_L_prop, 
                                                   "DeltaPDSI" = G_261$DeltaPDSI)
                                        } )
    
    G_261$B_pred_age1 <- predict(get(paste("nls_261.",  Best_mods.P_nh[Best_mods.P_nh$Code == 261,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_261$MEASTIME_t1,
                                               "STDAGE_t2" = G_261$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_261$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_261$STDAGE_t1,
                                                 "DeltaPDSI" = G_261$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_261$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_261$STDAGE_t1,
                                                   "B_L_prop" = G_261$B_L_prop, 
                                                   "DeltaPDSI" = G_261$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_261$DeltaB_age <- (G_261$B_pred_age2 - G_261$B_pred_age1) / G_261$REMPER
}

#### 262
if(!Best_mods.P_nh[Best_mods.P_nh$Code == "262",]$Best.Mod == "NA"){
    
    G_262$B_pred_age2 <- predict(get(paste("nls_262.",  Best_mods.P_nh[Best_mods.P_nh$Code == 262,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_262$MEASTIME_t1,
                                               "STDAGE_t2" = G_262$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_262$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_262$STDAGE_t2,
                                                 "DeltaPDSI" = G_262$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_262$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_262$STDAGE_t2,
                                                   "B_L_prop" = G_262$B_L_prop, 
                                                   "DeltaPDSI" = G_262$DeltaPDSI)
                                        } )
    
    G_262$B_pred_age1 <- predict(get(paste("nls_262.",  Best_mods.P_nh[Best_mods.P_nh$Code == 262,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_262$MEASTIME_t1,
                                               "STDAGE_t2" = G_262$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_262$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_262$STDAGE_t1,
                                                 "DeltaPDSI" = G_262$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_262$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_262$STDAGE_t1,
                                                   "B_L_prop" = G_262$B_L_prop, 
                                                   "DeltaPDSI" = G_262$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_262$DeltaB_age <- (G_262$B_pred_age2 - G_262$B_pred_age1) / G_262$REMPER
}

#### 263

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "263",]$Best.Mod == "NA"){
    
    G_263$B_pred_age2 <- predict(get(paste("nls_263.",  Best_mods.P_nh[Best_mods.P_nh$Code == 263,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_263$MEASTIME_t1,
                                               "STDAGE_t2" = G_263$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_263$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_263$STDAGE_t2,
                                                 "DeltaPDSI" = G_263$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_263$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_263$STDAGE_t2,
                                                   "B_L_prop" = G_263$B_L_prop, 
                                                   "DeltaPDSI" = G_263$DeltaPDSI)
                                        } )
    
    G_263$B_pred_age1 <- predict(get(paste("nls_263.",  Best_mods.P_nh[Best_mods.P_nh$Code == 263,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_263$MEASTIME_t1,
                                               "STDAGE_t2" = G_263$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_263$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_263$STDAGE_t1,
                                                 "DeltaPDSI" = G_263$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_263$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_263$STDAGE_t1,
                                                   "B_L_prop" = G_263$B_L_prop, 
                                                   "DeltaPDSI" = G_263$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_263$DeltaB_age <- (G_263$B_pred_age2 - G_263$B_pred_age1) / G_263$REMPER
}

#### 313

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "313",]$Best.Mod == "NA"){
    
    G_313$B_pred_age2 <- predict(get(paste("nls_313.",  Best_mods.P_nh[Best_mods.P_nh$Code == 313,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_313$MEASTIME_t1,
                                               "STDAGE_t2" = G_313$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_313$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_313$STDAGE_t2,
                                                 "DeltaPDSI" = G_313$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_313$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_313$STDAGE_t2,
                                                   "B_L_prop" = G_313$B_L_prop, 
                                                   "DeltaPDSI" = G_313$DeltaPDSI)
                                        } )
    
    G_313$B_pred_age1 <- predict(get(paste("nls_313.",  Best_mods.P_nh[Best_mods.P_nh$Code == 313,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_313$MEASTIME_t1,
                                               "STDAGE_t2" = G_313$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_313$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_313$STDAGE_t1,
                                                 "DeltaPDSI" = G_313$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_313$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_313$STDAGE_t1,
                                                   "B_L_prop" = G_313$B_L_prop, 
                                                   "DeltaPDSI" = G_313$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_313$DeltaB_age <- (G_313$B_pred_age2 - G_313$B_pred_age1) / G_313$REMPER
}

#### 315

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "315",]$Best.Mod == "NA"){
    
    G_315$B_pred_age2 <- predict(get(paste("nls_315.",  Best_mods.P_nh[Best_mods.P_nh$Code == 315,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_315$MEASTIME_t1,
                                               "STDAGE_t2" = G_315$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_315$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_315$STDAGE_t2,
                                                 "DeltaPDSI" = G_315$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_315$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_315$STDAGE_t2,
                                                   "B_L_prop" = G_315$B_L_prop, 
                                                   "DeltaPDSI" = G_315$DeltaPDSI)
                                        } )
    
    G_315$B_pred_age1 <- predict(get(paste("nls_315.",  Best_mods.P_nh[Best_mods.P_nh$Code == 315,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_315$MEASTIME_t1,
                                               "STDAGE_t2" = G_315$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_315$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_315$STDAGE_t1,
                                                 "DeltaPDSI" = G_315$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_315$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_315$STDAGE_t1,
                                                   "B_L_prop" = G_315$B_L_prop, 
                                                   "DeltaPDSI" = G_315$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_315$DeltaB_age <- (G_315$B_pred_age2 - G_315$B_pred_age1) / G_315$REMPER
}

#### 321

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "321",]$Best.Mod == "NA"){
    
    G_321$B_pred_age2 <- predict(get(paste("nls_321.",  Best_mods.P_nh[Best_mods.P_nh$Code == 321,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_321$MEASTIME_t1,
                                               "STDAGE_t2" = G_321$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_321$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_321$STDAGE_t2,
                                                 "DeltaPDSI" = G_321$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_321$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_321$STDAGE_t2,
                                                   "B_L_prop" = G_321$B_L_prop, 
                                                   "DeltaPDSI" = G_321$DeltaPDSI)
                                        } )
    
    G_321$B_pred_age1 <- predict(get(paste("nls_321.",  Best_mods.P_nh[Best_mods.P_nh$Code == 321,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_321$MEASTIME_t1,
                                               "STDAGE_t2" = G_321$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_321$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_321$STDAGE_t1,
                                                 "DeltaPDSI" = G_321$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_321$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_321$STDAGE_t1,
                                                   "B_L_prop" = G_321$B_L_prop, 
                                                   "DeltaPDSI" = G_321$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_321$DeltaB_age <- (G_321$B_pred_age2 - G_321$B_pred_age1) / G_321$REMPER
}

#### 322

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "322",]$Best.Mod == "NA"){
    
    G_322$B_pred_age2 <- predict(get(paste("nls_322.",  Best_mods.P_nh[Best_mods.P_nh$Code == 322,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_322$MEASTIME_t1,
                                               "STDAGE_t2" = G_322$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_322$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_322$STDAGE_t2,
                                                 "DeltaPDSI" = G_322$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_322$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_322$STDAGE_t2,
                                                   "B_L_prop" = G_322$B_L_prop, 
                                                   "DeltaPDSI" = G_322$DeltaPDSI)
                                        } )
    
    G_322$B_pred_age1 <- predict(get(paste("nls_322.",  Best_mods.P_nh[Best_mods.P_nh$Code == 322,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_322$MEASTIME_t1,
                                               "STDAGE_t2" = G_322$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_322$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_322$STDAGE_t1,
                                                 "DeltaPDSI" = G_322$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_322$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_322$STDAGE_t1,
                                                   "B_L_prop" = G_322$B_L_prop, 
                                                   "DeltaPDSI" = G_322$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_322$DeltaB_age <- (G_322$B_pred_age2 - G_322$B_pred_age1) / G_322$REMPER
}

#### 331

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "331",]$Best.Mod == "NA"){
    
    G_331$B_pred_age2 <- predict(get(paste("nls_331.",  Best_mods.P_nh[Best_mods.P_nh$Code == 331,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_331$MEASTIME_t1,
                                               "STDAGE_t2" = G_331$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_331$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_331$STDAGE_t2,
                                                 "DeltaPDSI" = G_331$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_331$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_331$STDAGE_t2,
                                                   "B_L_prop" = G_331$B_L_prop, 
                                                   "DeltaPDSI" = G_331$DeltaPDSI)
                                        } )
    
    G_331$B_pred_age1 <- predict(get(paste("nls_331.",  Best_mods.P_nh[Best_mods.P_nh$Code == 331,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_331$MEASTIME_t1,
                                               "STDAGE_t2" = G_331$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_331$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_331$STDAGE_t1,
                                                 "DeltaPDSI" = G_331$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_331$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_331$STDAGE_t1,
                                                   "B_L_prop" = G_331$B_L_prop, 
                                                   "DeltaPDSI" = G_331$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_331$DeltaB_age <- (G_331$B_pred_age2 - G_331$B_pred_age1) / G_331$REMPER
}

#### 332

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "332",]$Best.Mod == "NA"){
    
    G_332$B_pred_age2 <- predict(get(paste("nls_332.",  Best_mods.P_nh[Best_mods.P_nh$Code == 332,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_332$MEASTIME_t1,
                                               "STDAGE_t2" = G_332$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_332$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_332$STDAGE_t2,
                                                 "DeltaPDSI" = G_332$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_332$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_332$STDAGE_t2,
                                                   "B_L_prop" = G_332$B_L_prop, 
                                                   "DeltaPDSI" = G_332$DeltaPDSI)
                                        } )
    
    G_332$B_pred_age1 <- predict(get(paste("nls_332.",  Best_mods.P_nh[Best_mods.P_nh$Code == 332,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_332$MEASTIME_t1,
                                               "STDAGE_t2" = G_332$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_332$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_332$STDAGE_t1,
                                                 "DeltaPDSI" = G_332$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_332$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_332$STDAGE_t1,
                                                   "B_L_prop" = G_332$B_L_prop, 
                                                   "DeltaPDSI" = G_332$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_332$DeltaB_age <- (G_332$B_pred_age2 - G_332$B_pred_age1) / G_332$REMPER
}

#### 341

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "341",]$Best.Mod == "NA"){
    
    G_341$B_pred_age2 <- predict(get(paste("nls_341.",  Best_mods.P_nh[Best_mods.P_nh$Code == 341,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_341$MEASTIME_t1,
                                               "STDAGE_t2" = G_341$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_341$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_341$STDAGE_t2,
                                                 "DeltaPDSI" = G_341$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_341$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_341$STDAGE_t2,
                                                   "B_L_prop" = G_341$B_L_prop, 
                                                   "DeltaPDSI" = G_341$DeltaPDSI)
                                        } )
    
    G_341$B_pred_age1 <- predict(get(paste("nls_341.",  Best_mods.P_nh[Best_mods.P_nh$Code == 341,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_341$MEASTIME_t1,
                                               "STDAGE_t2" = G_341$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_341$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_341$STDAGE_t1,
                                                 "DeltaPDSI" = G_341$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_341$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_341$STDAGE_t1,
                                                   "B_L_prop" = G_341$B_L_prop, 
                                                   "DeltaPDSI" = G_341$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_341$DeltaB_age <- (G_341$B_pred_age2 - G_341$B_pred_age1) / G_341$REMPER
}

#### 342

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "342",]$Best.Mod == "NA"){
    
    G_342$B_pred_age2 <- predict(get(paste("nls_342.",  Best_mods.P_nh[Best_mods.P_nh$Code == 342,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_342$MEASTIME_t1,
                                               "STDAGE_t2" = G_342$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_342$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_342$STDAGE_t2,
                                                 "DeltaPDSI" = G_342$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_342$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_342$STDAGE_t2,
                                                   "B_L_prop" = G_342$B_L_prop, 
                                                   "DeltaPDSI" = G_342$DeltaPDSI)
                                        } )
    
    G_342$B_pred_age1 <- predict(get(paste("nls_342.",  Best_mods.P_nh[Best_mods.P_nh$Code == 342,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_342$MEASTIME_t1,
                                               "STDAGE_t2" = G_342$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_342$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_342$STDAGE_t1,
                                                 "DeltaPDSI" = G_342$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_342$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_342$STDAGE_t1,
                                                   "B_L_prop" = G_342$B_L_prop, 
                                                   "DeltaPDSI" = G_342$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_342$DeltaB_age <- (G_342$B_pred_age2 - G_342$B_pred_age1) / G_342$REMPER
}

#### 411

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "411",]$Best.Mod == "NA"){
    
    G_411$B_pred_age2 <- predict(get(paste("nls_411.",  Best_mods.P_nh[Best_mods.P_nh$Code == 411,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_411$MEASTIME_t1,
                                               "STDAGE_t2" = G_411$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_411$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_411$STDAGE_t2,
                                                 "DeltaPDSI" = G_411$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_411$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_411$STDAGE_t2,
                                                   "B_L_prop" = G_411$B_L_prop, 
                                                   "DeltaPDSI" = G_411$DeltaPDSI)
                                        } )
    
    G_411$B_pred_age1 <- predict(get(paste("nls_411.",  Best_mods.P_nh[Best_mods.P_nh$Code == 411,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_411$MEASTIME_t1,
                                               "STDAGE_t2" = G_411$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_411$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_411$STDAGE_t1,
                                                 "DeltaPDSI" = G_411$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_411$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_411$STDAGE_t1,
                                                   "B_L_prop" = G_411$B_L_prop, 
                                                   "DeltaPDSI" = G_411$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_411$DeltaB_age <- (G_411$B_pred_age2 - G_411$B_pred_age1) / G_411$REMPER
}

#### M211

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "M211",]$Best.Mod == "NA"){
    
    G_M211$B_pred_age2 <- predict(get(paste("nls_M211.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M211",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M211$MEASTIME_t1,
                                               "STDAGE_t2" = G_M211$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M211$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M211$STDAGE_t2,
                                                 "DeltaPDSI" = G_M211$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M211$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M211$STDAGE_t2,
                                                   "B_L_prop" = G_M211$B_L_prop, 
                                                   "DeltaPDSI" = G_M211$DeltaPDSI)
                                        } )
    
    G_M211$B_pred_age1 <- predict(get(paste("nls_M211.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M211",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M211$MEASTIME_t1,
                                               "STDAGE_t2" = G_M211$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M211$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M211$STDAGE_t1,
                                                 "DeltaPDSI" = G_M211$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M211$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M211$STDAGE_t1,
                                                   "B_L_prop" = G_M211$B_L_prop, 
                                                   "DeltaPDSI" = G_M211$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_M211$DeltaB_age <- (G_M211$B_pred_age2 - G_M211$B_pred_age1) / G_M211$REMPER
}

#### M223

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "M223",]$Best.Mod == "NA"){
    
    G_M223$B_pred_age2 <- predict(get(paste("nls_M223.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M223",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M223$MEASTIME_t1,
                                               "STDAGE_t2" = G_M223$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M223$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M223$STDAGE_t2,
                                                 "DeltaPDSI" = G_M223$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M223$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M223$STDAGE_t2,
                                                   "B_L_prop" = G_M223$B_L_prop, 
                                                   "DeltaPDSI" = G_M223$DeltaPDSI)
                                        } )
    
    G_M223$B_pred_age1 <- predict(get(paste("nls_M223.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M223",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M223$MEASTIME_t1,
                                               "STDAGE_t2" = G_M223$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M223$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M223$STDAGE_t1,
                                                 "DeltaPDSI" = G_M223$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M223$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M223$STDAGE_t1,
                                                   "B_L_prop" = G_M223$B_L_prop, 
                                                   "DeltaPDSI" = G_M223$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_M223$DeltaB_age <- (G_M223$B_pred_age2 - G_M223$B_pred_age1) / G_M223$REMPER
}

#### M231

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "M231",]$Best.Mod == "NA"){
    
    G_M231$B_pred_age2 <- predict(get(paste("nls_M231.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M231",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M231$MEASTIME_t1,
                                               "STDAGE_t2" = G_M231$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M231$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M231$STDAGE_t2,
                                                 "DeltaPDSI" = G_M231$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M231$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M231$STDAGE_t2,
                                                   "B_L_prop" = G_M231$B_L_prop, 
                                                   "DeltaPDSI" = G_M231$DeltaPDSI)
                                        } )
    
    G_M231$B_pred_age1 <- predict(get(paste("nls_M231.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M231",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M231$MEASTIME_t1,
                                               "STDAGE_t2" = G_M231$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M231$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M231$STDAGE_t1,
                                                 "DeltaPDSI" = G_M231$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M231$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M231$STDAGE_t1,
                                                   "B_L_prop" = G_M231$B_L_prop, 
                                                   "DeltaPDSI" = G_M231$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_M231$DeltaB_age <- (G_M231$B_pred_age2 - G_M231$B_pred_age1) / G_M231$REMPER
}

#### M242

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "M242",]$Best.Mod == "NA"){
    
    G_M242$B_pred_age2 <- predict(get(paste("nls_M242.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M242",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M242$MEASTIME_t1,
                                               "STDAGE_t2" = G_M242$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M242$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M242$STDAGE_t2,
                                                 "DeltaPDSI" = G_M242$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M242$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M242$STDAGE_t2,
                                                   "B_L_prop" = G_M242$B_L_prop, 
                                                   "DeltaPDSI" = G_M242$DeltaPDSI)
                                        } )
    
    G_M242$B_pred_age1 <- predict(get(paste("nls_M242.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M242",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M242$MEASTIME_t1,
                                               "STDAGE_t2" = G_M242$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M242$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M242$STDAGE_t1,
                                                 "DeltaPDSI" = G_M242$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M242$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M242$STDAGE_t1,
                                                   "B_L_prop" = G_M242$B_L_prop, 
                                                   "DeltaPDSI" = G_M242$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_M242$DeltaB_age <- (G_M242$B_pred_age2 - G_M242$B_pred_age1) / G_M242$REMPER
}

#### M261

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "M261",]$Best.Mod == "NA"){
    
    G_M261$B_pred_age2 <- predict(get(paste("nls_M261.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M261",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M261$MEASTIME_t1,
                                               "STDAGE_t2" = G_M261$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M261$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M261$STDAGE_t2,
                                                 "DeltaPDSI" = G_M261$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M261$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M261$STDAGE_t2,
                                                   "B_L_prop" = G_M261$B_L_prop, 
                                                   "DeltaPDSI" = G_M261$DeltaPDSI)
                                        } )
    
    G_M261$B_pred_age1 <- predict(get(paste("nls_M261.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M261",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M261$MEASTIME_t1,
                                               "STDAGE_t2" = G_M261$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M261$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M261$STDAGE_t1,
                                                 "DeltaPDSI" = G_M261$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M261$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M261$STDAGE_t1,
                                                   "B_L_prop" = G_M261$B_L_prop, 
                                                   "DeltaPDSI" = G_M261$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_M261$DeltaB_age <- (G_M261$B_pred_age2 - G_M261$B_pred_age1) / G_M261$REMPER
}

#### M262

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "M262",]$Best.Mod == "NA"){
    
    G_M262$B_pred_age2 <- predict(get(paste("nls_M262.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M262",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M262$MEASTIME_t1,
                                               "STDAGE_t2" = G_M262$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M262$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M262$STDAGE_t2,
                                                 "DeltaPDSI" = G_M262$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M262$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M262$STDAGE_t2,
                                                   "B_L_prop" = G_M262$B_L_prop, 
                                                   "DeltaPDSI" = G_M262$DeltaPDSI)
                                        } )
    
    G_M262$B_pred_age1 <- predict(get(paste("nls_M262.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M262",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M262$MEASTIME_t1,
                                               "STDAGE_t2" = G_M262$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M262$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M262$STDAGE_t1,
                                                 "DeltaPDSI" = G_M262$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M262$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M262$STDAGE_t1,
                                                   "B_L_prop" = G_M262$B_L_prop, 
                                                   "DeltaPDSI" = G_M262$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_M262$DeltaB_age <- (G_M262$B_pred_age2 - G_M262$B_pred_age1) / G_M262$REMPER
}

#### M313

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "M313",]$Best.Mod == "NA"){
    
    G_M313$B_pred_age2 <- predict(get(paste("nls_M313.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M313",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M313$MEASTIME_t1,
                                               "STDAGE_t2" = G_M313$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M313$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M313$STDAGE_t2,
                                                 "DeltaPDSI" = G_M313$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M313$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M313$STDAGE_t2,
                                                   "B_L_prop" = G_M313$B_L_prop, 
                                                   "DeltaPDSI" = G_M313$DeltaPDSI)
                                        } )
    
    G_M313$B_pred_age1 <- predict(get(paste("nls_M313.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M313",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M313$MEASTIME_t1,
                                               "STDAGE_t2" = G_M313$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M313$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M313$STDAGE_t1,
                                                 "DeltaPDSI" = G_M313$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M313$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M313$STDAGE_t1,
                                                   "B_L_prop" = G_M313$B_L_prop, 
                                                   "DeltaPDSI" = G_M313$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_M313$DeltaB_age <- (G_M313$B_pred_age2 - G_M313$B_pred_age1) / G_M313$REMPER
}

#### M331

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "M331",]$Best.Mod == "NA"){
    
    G_M331$B_pred_age2 <- predict(get(paste("nls_M331.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M331",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M331$MEASTIME_t1,
                                               "STDAGE_t2" = G_M331$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M331$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M331$STDAGE_t2,
                                                 "DeltaPDSI" = G_M331$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M331$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M331$STDAGE_t2,
                                                   "B_L_prop" = G_M331$B_L_prop, 
                                                   "DeltaPDSI" = G_M331$DeltaPDSI)
                                        } )
    
    G_M331$B_pred_age1 <- predict(get(paste("nls_M331.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M331",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M331$MEASTIME_t1,
                                               "STDAGE_t2" = G_M331$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M331$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M331$STDAGE_t1,
                                                 "DeltaPDSI" = G_M331$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M331$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M331$STDAGE_t1,
                                                   "B_L_prop" = G_M331$B_L_prop, 
                                                   "DeltaPDSI" = G_M331$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_M331$DeltaB_age <- (G_M331$B_pred_age2 - G_M331$B_pred_age1) / G_M331$REMPER
}

#### M332

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "M332",]$Best.Mod == "NA"){
    
    G_M332$B_pred_age2 <- predict(get(paste("nls_M332.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M332",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M332$MEASTIME_t1,
                                               "STDAGE_t2" = G_M332$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M332$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M332$STDAGE_t2,
                                                 "DeltaPDSI" = G_M332$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M332$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M332$STDAGE_t2,
                                                   "B_L_prop" = G_M332$B_L_prop, 
                                                   "DeltaPDSI" = G_M332$DeltaPDSI)
                                        } )
    
    G_M332$B_pred_age1 <- predict(get(paste("nls_M332.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M332",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M332$MEASTIME_t1,
                                               "STDAGE_t2" = G_M332$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M332$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M332$STDAGE_t1,
                                                 "DeltaPDSI" = G_M332$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M332$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M332$STDAGE_t1,
                                                   "B_L_prop" = G_M332$B_L_prop, 
                                                   "DeltaPDSI" = G_M332$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_M332$DeltaB_age <- (G_M332$B_pred_age2 - G_M332$B_pred_age1) / G_M332$REMPER
}

#### M333

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "M333",]$Best.Mod == "NA"){
    
    G_M333$B_pred_age2 <- predict(get(paste("nls_M333.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M333",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M333$MEASTIME_t1,
                                               "STDAGE_t2" = G_M333$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M333$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M333$STDAGE_t2,
                                                 "DeltaPDSI" = G_M333$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M333$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M333$STDAGE_t2,
                                                   "B_L_prop" = G_M333$B_L_prop, 
                                                   "DeltaPDSI" = G_M333$DeltaPDSI)
                                        } )
    
    G_M333$B_pred_age1 <- predict(get(paste("nls_M333.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M333",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M333$MEASTIME_t1,
                                               "STDAGE_t2" = G_M333$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M333$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M333$STDAGE_t1,
                                                 "DeltaPDSI" = G_M333$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M333$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M333$STDAGE_t1,
                                                   "B_L_prop" = G_M333$B_L_prop, 
                                                   "DeltaPDSI" = G_M333$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_M333$DeltaB_age <- (G_M333$B_pred_age2 - G_M333$B_pred_age1) / G_M333$REMPER
}

#### M334

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "M334",]$Best.Mod == "NA"){
    
    G_M334$B_pred_age2 <- predict(get(paste("nls_M334.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M334",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M334$MEASTIME_t1,
                                               "STDAGE_t2" = G_M334$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M334$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M334$STDAGE_t2,
                                                 "DeltaPDSI" = G_M334$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M334$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M334$STDAGE_t2,
                                                   "B_L_prop" = G_M334$B_L_prop, 
                                                   "DeltaPDSI" = G_M334$DeltaPDSI)
                                        } )
    
    G_M334$B_pred_age1 <- predict(get(paste("nls_M334.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M334",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M334$MEASTIME_t1,
                                               "STDAGE_t2" = G_M334$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M334$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M334$STDAGE_t1,
                                                 "DeltaPDSI" = G_M334$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M334$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M334$STDAGE_t1,
                                                   "B_L_prop" = G_M334$B_L_prop, 
                                                   "DeltaPDSI" = G_M334$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_M334$DeltaB_age <- (G_M334$B_pred_age2 - G_M334$B_pred_age1) / G_M334$REMPER
}

#### M341

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "M341",]$Best.Mod == "NA"){
    
    G_M341$B_pred_age2 <- predict(get(paste("nls_M341.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M341",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M341$MEASTIME_t1,
                                               "STDAGE_t2" = G_M341$STDAGE_t2)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M341$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M341$STDAGE_t2,
                                                 "DeltaPDSI" = G_M341$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M341$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M341$STDAGE_t2,
                                                   "B_L_prop" = G_M341$B_L_prop, 
                                                   "DeltaPDSI" = G_M341$DeltaPDSI)
                                        } )
    
    G_M341$B_pred_age1 <- predict(get(paste("nls_M341.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M341",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M341$MEASTIME_t1,
                                               "STDAGE_t2" = G_M341$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M341$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M341$STDAGE_t1,
                                                 "DeltaPDSI" = G_M341$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M341$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M341$STDAGE_t1,
                                                   "B_L_prop" = G_M341$B_L_prop, 
                                                   "DeltaPDSI" = G_M341$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to delta STDAGE -- simple subtraction
    G_M341$DeltaB_age <- (G_M341$B_pred_age2 - G_M341$B_pred_age1) / G_M341$REMPER
}

```








### 2. Delta-B due to Delta-Year (_ge_)
```{r}
#### 211

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "211",]$Best.Mod == "NA"){

    G_211$B_pred_year1 <- predict(get(paste("nls_211.",  Best_mods.P_nh[Best_mods.P_nh$Code == 211,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_211$MEASTIME_t1,
                                               "STDAGE_t2" = G_211$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_211$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_211$STDAGE_t1,
                                                 "DeltaPDSI" = G_211$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_211$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_211$STDAGE_t1,
                                                   "B_L_prop" = G_211$B_L_prop, 
                                                   "DeltaPDSI" = G_211$DeltaPDSI)
                                        } )
    
    G_211$B_pred_year2 <- predict(get(paste("nls_211.",  Best_mods.P_nh[Best_mods.P_nh$Code == 211,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_211$MEASTIME_t2,
                                               "STDAGE_t2" = G_211$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_211$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_211$STDAGE_t1,
                                                 "DeltaPDSI" = G_211$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_211$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_211$STDAGE_t1,
                                                   "B_L_prop" = G_211$B_L_prop, 
                                                   "DeltaPDSI" = G_211$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_211$DeltaB_year<- (G_211$B_pred_year2 - G_211$B_pred_year1) / G_211$REMPER
}

#### 212

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "212",]$Best.Mod == "NA"){

    G_212$B_pred_year1 <- predict(get(paste("nls_212.",  Best_mods.P_nh[Best_mods.P_nh$Code == 212,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_212$MEASTIME_t1,
                                               "STDAGE_t2" = G_212$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_212$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_212$STDAGE_t1,
                                                 "DeltaPDSI" = G_212$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_212$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_212$STDAGE_t1,
                                                   "B_L_prop" = G_212$B_L_prop, 
                                                   "DeltaPDSI" = G_212$DeltaPDSI)
                                        } )
    
    G_212$B_pred_year2 <- predict(get(paste("nls_212.",  Best_mods.P_nh[Best_mods.P_nh$Code == 212,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_212$MEASTIME_t2,
                                               "STDAGE_t2" = G_212$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_212$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_212$STDAGE_t1,
                                                 "DeltaPDSI" = G_212$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_212$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_212$STDAGE_t1,
                                                   "B_L_prop" = G_212$B_L_prop, 
                                                   "DeltaPDSI" = G_212$DeltaPDSI)

                                                                                } )

    # calculate delta-B due to year (ge) -- simple subtraction
    G_212$DeltaB_year<- (G_212$B_pred_year2 - G_212$B_pred_year1) / G_212$REMPER
}

#### 221

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "221",]$Best.Mod == "NA"){

    G_221$B_pred_year1 <- predict(get(paste("nls_221.",  Best_mods.P_nh[Best_mods.P_nh$Code == 221,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_221$MEASTIME_t1,
                                               "STDAGE_t2" = G_221$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_221$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_221$STDAGE_t1,
                                                 "DeltaPDSI" = G_221$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_221$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_221$STDAGE_t1,
                                                   "B_L_prop" = G_221$B_L_prop, 
                                                   "DeltaPDSI" = G_221$DeltaPDSI)
                                        } )
    
    G_221$B_pred_year2 <- predict(get(paste("nls_221.",  Best_mods.P_nh[Best_mods.P_nh$Code == 221,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_221$MEASTIME_t2,
                                               "STDAGE_t2" = G_221$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_221$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_221$STDAGE_t1,
                                                 "DeltaPDSI" = G_221$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_221$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_221$STDAGE_t1,
                                                   "B_L_prop" = G_221$B_L_prop, 
                                                   "DeltaPDSI" = G_221$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_221$DeltaB_year<- (G_221$B_pred_year2 - G_221$B_pred_year1) / G_221$REMPER
}

#### 222

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "222",]$Best.Mod == "NA"){

    G_222$B_pred_year1 <- predict(get(paste("nls_222.",  Best_mods.P_nh[Best_mods.P_nh$Code == 222,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_222$MEASTIME_t1,
                                               "STDAGE_t2" = G_222$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_222$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_222$STDAGE_t1,
                                                 "DeltaPDSI" = G_222$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_222$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_222$STDAGE_t1,
                                                   "B_L_prop" = G_222$B_L_prop, 
                                                   "DeltaPDSI" = G_222$DeltaPDSI)
                                        } )
    
    G_222$B_pred_year2 <- predict(get(paste("nls_222.",  Best_mods.P_nh[Best_mods.P_nh$Code == 222,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_222$MEASTIME_t2,
                                               "STDAGE_t2" = G_222$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_222$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_222$STDAGE_t1,
                                                 "DeltaPDSI" = G_222$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_222$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_222$STDAGE_t1,
                                                   "B_L_prop" = G_222$B_L_prop, 
                                                   "DeltaPDSI" = G_222$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_222$DeltaB_year<- (G_222$B_pred_year2 - G_222$B_pred_year1) / G_222$REMPER
}

#### 223

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "223",]$Best.Mod == "NA"){

    G_223$B_pred_year1 <- predict(get(paste("nls_223.",  Best_mods.P_nh[Best_mods.P_nh$Code == 223,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_223$MEASTIME_t1,
                                               "STDAGE_t2" = G_223$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_223$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_223$STDAGE_t1,
                                                 "DeltaPDSI" = G_223$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_223$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_223$STDAGE_t1,
                                                   "B_L_prop" = G_223$B_L_prop, 
                                                   "DeltaPDSI" = G_223$DeltaPDSI)
                                        } )
    
    G_223$B_pred_year2 <- predict(get(paste("nls_223.",  Best_mods.P_nh[Best_mods.P_nh$Code == 223,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_223$MEASTIME_t2,
                                               "STDAGE_t2" = G_223$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_223$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_223$STDAGE_t1,
                                                 "DeltaPDSI" = G_223$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_223$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_223$STDAGE_t1,
                                                   "B_L_prop" = G_223$B_L_prop, 
                                                   "DeltaPDSI" = G_223$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_223$DeltaB_year<- (G_223$B_pred_year2 - G_223$B_pred_year1) / G_223$REMPER
}

#### 231

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "231",]$Best.Mod == "NA"){

    G_231$B_pred_year1 <- predict(get(paste("nls_231.",  Best_mods.P_nh[Best_mods.P_nh$Code == 231,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_231$MEASTIME_t1,
                                               "STDAGE_t2" = G_231$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_231$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_231$STDAGE_t1,
                                                 "DeltaPDSI" = G_231$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_231$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_231$STDAGE_t1,
                                                   "B_L_prop" = G_231$B_L_prop, 
                                                   "DeltaPDSI" = G_231$DeltaPDSI)
                                        } )
    
    G_231$B_pred_year2 <- predict(get(paste("nls_231.",  Best_mods.P_nh[Best_mods.P_nh$Code == 231,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_231$MEASTIME_t2,
                                               "STDAGE_t2" = G_231$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_231$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_231$STDAGE_t1,
                                                 "DeltaPDSI" = G_231$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_231$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_231$STDAGE_t1,
                                                   "B_L_prop" = G_231$B_L_prop, 
                                                   "DeltaPDSI" = G_231$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_231$DeltaB_year<- (G_231$B_pred_year2 - G_231$B_pred_year1) / G_231$REMPER
}

#### 232

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "232",]$Best.Mod == "NA"){

    G_232$B_pred_year1 <- predict(get(paste("nls_232.",  Best_mods.P_nh[Best_mods.P_nh$Code == 232,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_232$MEASTIME_t1,
                                               "STDAGE_t2" = G_232$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_232$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_232$STDAGE_t1,
                                                 "DeltaPDSI" = G_232$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_232$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_232$STDAGE_t1,
                                                   "B_L_prop" = G_232$B_L_prop, 
                                                   "DeltaPDSI" = G_232$DeltaPDSI)
                                        } )
    
    G_232$B_pred_year2 <- predict(get(paste("nls_232.",  Best_mods.P_nh[Best_mods.P_nh$Code == 232,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_232$MEASTIME_t2,
                                               "STDAGE_t2" = G_232$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_232$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_232$STDAGE_t1,
                                                 "DeltaPDSI" = G_232$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_232$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_232$STDAGE_t1,
                                                   "B_L_prop" = G_232$B_L_prop, 
                                                   "DeltaPDSI" = G_232$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_232$DeltaB_year<- (G_232$B_pred_year2 - G_232$B_pred_year1) / G_232$REMPER
}

#### 234

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "234",]$Best.Mod == "NA"){

    G_234$B_pred_year1 <- predict(get(paste("nls_234.",  Best_mods.P_nh[Best_mods.P_nh$Code == 234,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_234$MEASTIME_t1,
                                               "STDAGE_t2" = G_234$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_234$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_234$STDAGE_t1,
                                                 "DeltaPDSI" = G_234$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_234$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_234$STDAGE_t1,
                                                   "B_L_prop" = G_234$B_L_prop, 
                                                   "DeltaPDSI" = G_234$DeltaPDSI)
                                        } )
    
    G_234$B_pred_year2 <- predict(get(paste("nls_234.",  Best_mods.P_nh[Best_mods.P_nh$Code == 234,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_234$MEASTIME_t2,
                                               "STDAGE_t2" = G_234$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_234$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_234$STDAGE_t1,
                                                 "DeltaPDSI" = G_234$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_234$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_234$STDAGE_t1,
                                                   "B_L_prop" = G_234$B_L_prop, 
                                                   "DeltaPDSI" = G_234$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_234$DeltaB_year<- (G_234$B_pred_year2 - G_234$B_pred_year1) / G_234$REMPER
}

#### 242

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "242",]$Best.Mod == "NA"){

    G_242$B_pred_year1 <- predict(get(paste("nls_242.",  Best_mods.P_nh[Best_mods.P_nh$Code == 242,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_242$MEASTIME_t1,
                                               "STDAGE_t2" = G_242$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_242$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_242$STDAGE_t1,
                                                 "DeltaPDSI" = G_242$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_242$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_242$STDAGE_t1,
                                                   "B_L_prop" = G_242$B_L_prop, 
                                                   "DeltaPDSI" = G_242$DeltaPDSI)
                                        } )
    
    G_242$B_pred_year2 <- predict(get(paste("nls_242.",  Best_mods.P_nh[Best_mods.P_nh$Code == 242,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_242$MEASTIME_t2,
                                               "STDAGE_t2" = G_242$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_242$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_242$STDAGE_t1,
                                                 "DeltaPDSI" = G_242$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_242$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_242$STDAGE_t1,
                                                   "B_L_prop" = G_242$B_L_prop, 
                                                   "DeltaPDSI" = G_242$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_242$DeltaB_year<- (G_242$B_pred_year2 - G_242$B_pred_year1) / G_242$REMPER
}

#### 251

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "251",]$Best.Mod == "NA"){

    G_251$B_pred_year1 <- predict(get(paste("nls_251.",  Best_mods.P_nh[Best_mods.P_nh$Code == 251,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_251$MEASTIME_t1,
                                               "STDAGE_t2" = G_251$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_251$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_251$STDAGE_t1,
                                                 "DeltaPDSI" = G_251$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_251$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_251$STDAGE_t1,
                                                   "B_L_prop" = G_251$B_L_prop, 
                                                   "DeltaPDSI" = G_251$DeltaPDSI)
                                        } )
    
    G_251$B_pred_year2 <- predict(get(paste("nls_251.",  Best_mods.P_nh[Best_mods.P_nh$Code == 251,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_251$MEASTIME_t2,
                                               "STDAGE_t2" = G_251$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_251$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_251$STDAGE_t1,
                                                 "DeltaPDSI" = G_251$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_251$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_251$STDAGE_t1,
                                                   "B_L_prop" = G_251$B_L_prop, 
                                                   "DeltaPDSI" = G_251$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_251$DeltaB_year<- (G_251$B_pred_year2 - G_251$B_pred_year1) / G_251$REMPER
}

#### 255

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "255",]$Best.Mod == "NA"){

    G_255$B_pred_year1 <- predict(get(paste("nls_255.",  Best_mods.P_nh[Best_mods.P_nh$Code == 255,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_255$MEASTIME_t1,
                                               "STDAGE_t2" = G_255$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_255$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_255$STDAGE_t1,
                                                 "DeltaPDSI" = G_255$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_255$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_255$STDAGE_t1,
                                                   "B_L_prop" = G_255$B_L_prop, 
                                                   "DeltaPDSI" = G_255$DeltaPDSI)
                                        } )
    
    G_255$B_pred_year2 <- predict(get(paste("nls_255.",  Best_mods.P_nh[Best_mods.P_nh$Code == 255,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_255$MEASTIME_t2,
                                               "STDAGE_t2" = G_255$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_255$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_255$STDAGE_t1,
                                                 "DeltaPDSI" = G_255$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_255$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_255$STDAGE_t1,
                                                   "B_L_prop" = G_255$B_L_prop, 
                                                   "DeltaPDSI" = G_255$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_255$DeltaB_year<- (G_255$B_pred_year2 - G_255$B_pred_year1) / G_255$REMPER
}

#### 261

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "261",]$Best.Mod == "NA"){

    G_261$B_pred_year1 <- predict(get(paste("nls_261.",  Best_mods.P_nh[Best_mods.P_nh$Code == 261,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_261$MEASTIME_t1,
                                               "STDAGE_t2" = G_261$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_261$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_261$STDAGE_t1,
                                                 "DeltaPDSI" = G_261$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_261$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_261$STDAGE_t1,
                                                   "B_L_prop" = G_261$B_L_prop, 
                                                   "DeltaPDSI" = G_261$DeltaPDSI)
                                        } )
    
    G_261$B_pred_year2 <- predict(get(paste("nls_261.",  Best_mods.P_nh[Best_mods.P_nh$Code == 261,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_261$MEASTIME_t2,
                                               "STDAGE_t2" = G_261$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_261$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_261$STDAGE_t1,
                                                 "DeltaPDSI" = G_261$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_261$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_261$STDAGE_t1,
                                                   "B_L_prop" = G_261$B_L_prop, 
                                                   "DeltaPDSI" = G_261$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_261$DeltaB_year<- (G_261$B_pred_year2 - G_261$B_pred_year1) / G_261$REMPER
}

#### 262

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "262",]$Best.Mod == "NA"){

    G_262$B_pred_year1 <- predict(get(paste("nls_262.",  Best_mods.P_nh[Best_mods.P_nh$Code == 262,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_262$MEASTIME_t1,
                                               "STDAGE_t2" = G_262$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_262$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_262$STDAGE_t1,
                                                 "DeltaPDSI" = G_262$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_262$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_262$STDAGE_t1,
                                                   "B_L_prop" = G_262$B_L_prop, 
                                                   "DeltaPDSI" = G_262$DeltaPDSI)
                                        } )
    
    G_262$B_pred_year2 <- predict(get(paste("nls_262.",  Best_mods.P_nh[Best_mods.P_nh$Code == 262,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_262$MEASTIME_t2,
                                               "STDAGE_t2" = G_262$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_262$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_262$STDAGE_t1,
                                                 "DeltaPDSI" = G_262$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_262$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_262$STDAGE_t1,
                                                   "B_L_prop" = G_262$B_L_prop, 
                                                   "DeltaPDSI" = G_262$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_262$DeltaB_year<- (G_262$B_pred_year2 - G_262$B_pred_year1) / G_262$REMPER
}

#### 263

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "263",]$Best.Mod == "NA"){

    G_263$B_pred_year1 <- predict(get(paste("nls_263.",  Best_mods.P_nh[Best_mods.P_nh$Code == 263,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_263$MEASTIME_t1,
                                               "STDAGE_t2" = G_263$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_263$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_263$STDAGE_t1,
                                                 "DeltaPDSI" = G_263$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_263$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_263$STDAGE_t1,
                                                   "B_L_prop" = G_263$B_L_prop, 
                                                   "DeltaPDSI" = G_263$DeltaPDSI)
                                        } )
    
    G_263$B_pred_year2 <- predict(get(paste("nls_263.",  Best_mods.P_nh[Best_mods.P_nh$Code == 263,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_263$MEASTIME_t2,
                                               "STDAGE_t2" = G_263$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_263$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_263$STDAGE_t1,
                                                 "DeltaPDSI" = G_263$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_263$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_263$STDAGE_t1,
                                                   "B_L_prop" = G_263$B_L_prop, 
                                                   "DeltaPDSI" = G_263$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_263$DeltaB_year<- (G_263$B_pred_year2 - G_263$B_pred_year1) / G_263$REMPER
}

#### 313

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "313",]$Best.Mod == "NA"){

    G_313$B_pred_year1 <- predict(get(paste("nls_313.",  Best_mods.P_nh[Best_mods.P_nh$Code == 313,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_313$MEASTIME_t1,
                                               "STDAGE_t2" = G_313$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_313$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_313$STDAGE_t1,
                                                 "DeltaPDSI" = G_313$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_313$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_313$STDAGE_t1,
                                                   "B_L_prop" = G_313$B_L_prop, 
                                                   "DeltaPDSI" = G_313$DeltaPDSI)
                                        } )
    
    G_313$B_pred_year2 <- predict(get(paste("nls_313.",  Best_mods.P_nh[Best_mods.P_nh$Code == 313,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_313$MEASTIME_t2,
                                               "STDAGE_t2" = G_313$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_313$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_313$STDAGE_t1,
                                                 "DeltaPDSI" = G_313$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_313$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_313$STDAGE_t1,
                                                   "B_L_prop" = G_313$B_L_prop, 
                                                   "DeltaPDSI" = G_313$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_313$DeltaB_year<- (G_313$B_pred_year2 - G_313$B_pred_year1) / G_313$REMPER
}

#### 315

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "315",]$Best.Mod == "NA"){

    G_315$B_pred_year1 <- predict(get(paste("nls_315.",  Best_mods.P_nh[Best_mods.P_nh$Code == 315,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_315$MEASTIME_t1,
                                               "STDAGE_t2" = G_315$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_315$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_315$STDAGE_t1,
                                                 "DeltaPDSI" = G_315$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_315$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_315$STDAGE_t1,
                                                   "B_L_prop" = G_315$B_L_prop, 
                                                   "DeltaPDSI" = G_315$DeltaPDSI)
                                        } )
    
    G_315$B_pred_year2 <- predict(get(paste("nls_315.",  Best_mods.P_nh[Best_mods.P_nh$Code == 315,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_315$MEASTIME_t2,
                                               "STDAGE_t2" = G_315$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_315$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_315$STDAGE_t1,
                                                 "DeltaPDSI" = G_315$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_315$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_315$STDAGE_t1,
                                                   "B_L_prop" = G_315$B_L_prop, 
                                                   "DeltaPDSI" = G_315$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_315$DeltaB_year<- (G_315$B_pred_year2 - G_315$B_pred_year1) / G_315$REMPER
}

#### 321

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "321",]$Best.Mod == "NA"){

    G_321$B_pred_year1 <- predict(get(paste("nls_321.",  Best_mods.P_nh[Best_mods.P_nh$Code == 321,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_321$MEASTIME_t1,
                                               "STDAGE_t2" = G_321$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_321$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_321$STDAGE_t1,
                                                 "DeltaPDSI" = G_321$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_321$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_321$STDAGE_t1,
                                                   "B_L_prop" = G_321$B_L_prop, 
                                                   "DeltaPDSI" = G_321$DeltaPDSI)
                                        } )
    
    G_321$B_pred_year2 <- predict(get(paste("nls_321.",  Best_mods.P_nh[Best_mods.P_nh$Code == 321,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_321$MEASTIME_t2,
                                               "STDAGE_t2" = G_321$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_321$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_321$STDAGE_t1,
                                                 "DeltaPDSI" = G_321$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_321$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_321$STDAGE_t1,
                                                   "B_L_prop" = G_321$B_L_prop, 
                                                   "DeltaPDSI" = G_321$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_321$DeltaB_year<- (G_321$B_pred_year2 - G_321$B_pred_year1) / G_321$REMPER
}

#### 322

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "322",]$Best.Mod == "NA"){

    G_322$B_pred_year1 <- predict(get(paste("nls_322.",  Best_mods.P_nh[Best_mods.P_nh$Code == 322,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_322$MEASTIME_t1,
                                               "STDAGE_t2" = G_322$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_322$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_322$STDAGE_t1,
                                                 "DeltaPDSI" = G_322$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_322$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_322$STDAGE_t1,
                                                   "B_L_prop" = G_322$B_L_prop, 
                                                   "DeltaPDSI" = G_322$DeltaPDSI)
                                        } )
    
    G_322$B_pred_year2 <- predict(get(paste("nls_322.",  Best_mods.P_nh[Best_mods.P_nh$Code == 322,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_322$MEASTIME_t2,
                                               "STDAGE_t2" = G_322$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_322$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_322$STDAGE_t1,
                                                 "DeltaPDSI" = G_322$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_322$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_322$STDAGE_t1,
                                                   "B_L_prop" = G_322$B_L_prop, 
                                                   "DeltaPDSI" = G_322$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_322$DeltaB_year<- (G_322$B_pred_year2 - G_322$B_pred_year1) / G_322$REMPER
}

#### 331

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "331",]$Best.Mod == "NA"){

    G_331$B_pred_year1 <- predict(get(paste("nls_331.",  Best_mods.P_nh[Best_mods.P_nh$Code == 331,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_331$MEASTIME_t1,
                                               "STDAGE_t2" = G_331$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_331$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_331$STDAGE_t1,
                                                 "DeltaPDSI" = G_331$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_331$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_331$STDAGE_t1,
                                                   "B_L_prop" = G_331$B_L_prop, 
                                                   "DeltaPDSI" = G_331$DeltaPDSI)
                                        } )
    
    G_331$B_pred_year2 <- predict(get(paste("nls_331.",  Best_mods.P_nh[Best_mods.P_nh$Code == 331,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_331$MEASTIME_t2,
                                               "STDAGE_t2" = G_331$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_331$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_331$STDAGE_t1,
                                                 "DeltaPDSI" = G_331$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_331$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_331$STDAGE_t1,
                                                   "B_L_prop" = G_331$B_L_prop, 
                                                   "DeltaPDSI" = G_331$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_331$DeltaB_year<- (G_331$B_pred_year2 - G_331$B_pred_year1) / G_331$REMPER
}

#### 332

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "332",]$Best.Mod == "NA"){

    G_332$B_pred_year1 <- predict(get(paste("nls_332.",  Best_mods.P_nh[Best_mods.P_nh$Code == 332,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_332$MEASTIME_t1,
                                               "STDAGE_t2" = G_332$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_332$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_332$STDAGE_t1,
                                                 "DeltaPDSI" = G_332$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_332$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_332$STDAGE_t1,
                                                   "B_L_prop" = G_332$B_L_prop, 
                                                   "DeltaPDSI" = G_332$DeltaPDSI)
                                        } )
    
    G_332$B_pred_year2 <- predict(get(paste("nls_332.",  Best_mods.P_nh[Best_mods.P_nh$Code == 332,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_332$MEASTIME_t2,
                                               "STDAGE_t2" = G_332$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_332$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_332$STDAGE_t1,
                                                 "DeltaPDSI" = G_332$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_332$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_332$STDAGE_t1,
                                                   "B_L_prop" = G_332$B_L_prop, 
                                                   "DeltaPDSI" = G_332$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_332$DeltaB_year<- (G_332$B_pred_year2 - G_332$B_pred_year1) / G_332$REMPER
}

#### 341

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "341",]$Best.Mod == "NA"){

    G_341$B_pred_year1 <- predict(get(paste("nls_341.",  Best_mods.P_nh[Best_mods.P_nh$Code == 341,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_341$MEASTIME_t1,
                                               "STDAGE_t2" = G_341$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_341$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_341$STDAGE_t1,
                                                 "DeltaPDSI" = G_341$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_341$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_341$STDAGE_t1,
                                                   "B_L_prop" = G_341$B_L_prop, 
                                                   "DeltaPDSI" = G_341$DeltaPDSI)
                                        } )
    
    G_341$B_pred_year2 <- predict(get(paste("nls_341.",  Best_mods.P_nh[Best_mods.P_nh$Code == 341,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_341$MEASTIME_t2,
                                               "STDAGE_t2" = G_341$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_341$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_341$STDAGE_t1,
                                                 "DeltaPDSI" = G_341$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_341$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_341$STDAGE_t1,
                                                   "B_L_prop" = G_341$B_L_prop, 
                                                   "DeltaPDSI" = G_341$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_341$DeltaB_year<- (G_341$B_pred_year2 - G_341$B_pred_year1) / G_341$REMPER
}

#### 342

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "342",]$Best.Mod == "NA"){

    G_342$B_pred_year1 <- predict(get(paste("nls_342.",  Best_mods.P_nh[Best_mods.P_nh$Code == 342,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_342$MEASTIME_t1,
                                               "STDAGE_t2" = G_342$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_342$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_342$STDAGE_t1,
                                                 "DeltaPDSI" = G_342$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_342$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_342$STDAGE_t1,
                                                   "B_L_prop" = G_342$B_L_prop, 
                                                   "DeltaPDSI" = G_342$DeltaPDSI)
                                        } )
    
    G_342$B_pred_year2 <- predict(get(paste("nls_342.",  Best_mods.P_nh[Best_mods.P_nh$Code == 342,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_342$MEASTIME_t2,
                                               "STDAGE_t2" = G_342$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_342$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_342$STDAGE_t1,
                                                 "DeltaPDSI" = G_342$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_342$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_342$STDAGE_t1,
                                                   "B_L_prop" = G_342$B_L_prop, 
                                                   "DeltaPDSI" = G_342$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_342$DeltaB_year<- (G_342$B_pred_year2 - G_342$B_pred_year1) / G_342$REMPER
}

#### 411

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "411",]$Best.Mod == "NA"){

    G_411$B_pred_year1 <- predict(get(paste("nls_411.",  Best_mods.P_nh[Best_mods.P_nh$Code == 411,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_411$MEASTIME_t1,
                                               "STDAGE_t2" = G_411$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_411$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_411$STDAGE_t1,
                                                 "DeltaPDSI" = G_411$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_411$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_411$STDAGE_t1,
                                                   "B_L_prop" = G_411$B_L_prop, 
                                                   "DeltaPDSI" = G_411$DeltaPDSI)
                                        } )
    
    G_411$B_pred_year2 <- predict(get(paste("nls_411.",  Best_mods.P_nh[Best_mods.P_nh$Code == 411,]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_411$MEASTIME_t2,
                                               "STDAGE_t2" = G_411$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_411$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_411$STDAGE_t1,
                                                 "DeltaPDSI" = G_411$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_411$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_411$STDAGE_t1,
                                                   "B_L_prop" = G_411$B_L_prop, 
                                                   "DeltaPDSI" = G_411$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_411$DeltaB_year<- (G_411$B_pred_year2 - G_411$B_pred_year1) / G_411$REMPER
}

#### M211

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "M211",]$Best.Mod == "NA"){

    G_M211$B_pred_year1 <- predict(get(paste("nls_M211.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M211",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M211$MEASTIME_t1,
                                               "STDAGE_t2" = G_M211$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M211$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M211$STDAGE_t1,
                                                 "DeltaPDSI" = G_M211$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M211$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M211$STDAGE_t1,
                                                   "B_L_prop" = G_M211$B_L_prop, 
                                                   "DeltaPDSI" = G_M211$DeltaPDSI)
                                        } )
    
    G_M211$B_pred_year2 <- predict(get(paste("nls_M211.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M211",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M211$MEASTIME_t2,
                                               "STDAGE_t2" = G_M211$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M211$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_M211$STDAGE_t1,
                                                 "DeltaPDSI" = G_M211$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M211$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_M211$STDAGE_t1,
                                                   "B_L_prop" = G_M211$B_L_prop, 
                                                   "DeltaPDSI" = G_M211$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_M211$DeltaB_year<- (G_M211$B_pred_year2 - G_M211$B_pred_year1) / G_M211$REMPER
}

#### M223

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "M223",]$Best.Mod == "NA"){

    G_M223$B_pred_year1 <- predict(get(paste("nls_M223.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M223",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M223$MEASTIME_t1,
                                               "STDAGE_t2" = G_M223$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M223$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M223$STDAGE_t1,
                                                 "DeltaPDSI" = G_M223$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M223$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M223$STDAGE_t1,
                                                   "B_L_prop" = G_M223$B_L_prop, 
                                                   "DeltaPDSI" = G_M223$DeltaPDSI)
                                        } )
    
    G_M223$B_pred_year2 <- predict(get(paste("nls_M223.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M223",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M223$MEASTIME_t2,
                                               "STDAGE_t2" = G_M223$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M223$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_M223$STDAGE_t1,
                                                 "DeltaPDSI" = G_M223$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M223$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_M223$STDAGE_t1,
                                                   "B_L_prop" = G_M223$B_L_prop, 
                                                   "DeltaPDSI" = G_M223$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_M223$DeltaB_year<- (G_M223$B_pred_year2 - G_M223$B_pred_year1) / G_M223$REMPER
}

#### M231

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "M231",]$Best.Mod == "NA"){

    G_M231$B_pred_year1 <- predict(get(paste("nls_M231.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M231",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M231$MEASTIME_t1,
                                               "STDAGE_t2" = G_M231$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M231$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M231$STDAGE_t1,
                                                 "DeltaPDSI" = G_M231$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M231$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M231$STDAGE_t1,
                                                   "B_L_prop" = G_M231$B_L_prop, 
                                                   "DeltaPDSI" = G_M231$DeltaPDSI)
                                        } )
    
    G_M231$B_pred_year2 <- predict(get(paste("nls_M231.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M231",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M231$MEASTIME_t2,
                                               "STDAGE_t2" = G_M231$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M231$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_M231$STDAGE_t1,
                                                 "DeltaPDSI" = G_M231$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M231$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_M231$STDAGE_t1,
                                                   "B_L_prop" = G_M231$B_L_prop, 
                                                   "DeltaPDSI" = G_M231$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_M231$DeltaB_year<- (G_M231$B_pred_year2 - G_M231$B_pred_year1) / G_M231$REMPER
}

#### M242

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "M242",]$Best.Mod == "NA"){

    G_M242$B_pred_year1 <- predict(get(paste("nls_M242.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M242",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M242$MEASTIME_t1,
                                               "STDAGE_t2" = G_M242$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M242$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M242$STDAGE_t1,
                                                 "DeltaPDSI" = G_M242$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M242$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M242$STDAGE_t1,
                                                   "B_L_prop" = G_M242$B_L_prop, 
                                                   "DeltaPDSI" = G_M242$DeltaPDSI)
                                        } )
    
    G_M242$B_pred_year2 <- predict(get(paste("nls_M242.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M242",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M242$MEASTIME_t2,
                                               "STDAGE_t2" = G_M242$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M242$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_M242$STDAGE_t1,
                                                 "DeltaPDSI" = G_M242$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M242$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_M242$STDAGE_t1,
                                                   "B_L_prop" = G_M242$B_L_prop, 
                                                   "DeltaPDSI" = G_M242$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_M242$DeltaB_year<- (G_M242$B_pred_year2 - G_M242$B_pred_year1) / G_M242$REMPER
}

#### M261

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "M261",]$Best.Mod == "NA"){

    G_M261$B_pred_year1 <- predict(get(paste("nls_M261.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M261",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M261$MEASTIME_t1,
                                               "STDAGE_t2" = G_M261$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M261$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M261$STDAGE_t1,
                                                 "DeltaPDSI" = G_M261$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M261$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M261$STDAGE_t1,
                                                   "B_L_prop" = G_M261$B_L_prop, 
                                                   "DeltaPDSI" = G_M261$DeltaPDSI)
                                        } )
    
    G_M261$B_pred_year2 <- predict(get(paste("nls_M261.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M261",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M261$MEASTIME_t2,
                                               "STDAGE_t2" = G_M261$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M261$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_M261$STDAGE_t1,
                                                 "DeltaPDSI" = G_M261$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M261$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_M261$STDAGE_t1,
                                                   "B_L_prop" = G_M261$B_L_prop, 
                                                   "DeltaPDSI" = G_M261$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_M261$DeltaB_year<- (G_M261$B_pred_year2 - G_M261$B_pred_year1) / G_M261$REMPER
}

#### M262

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "M262",]$Best.Mod == "NA"){

    G_M262$B_pred_year1 <- predict(get(paste("nls_M262.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M262",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M262$MEASTIME_t1,
                                               "STDAGE_t2" = G_M262$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M262$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M262$STDAGE_t1,
                                                 "DeltaPDSI" = G_M262$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M262$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M262$STDAGE_t1,
                                                   "B_L_prop" = G_M262$B_L_prop, 
                                                   "DeltaPDSI" = G_M262$DeltaPDSI)
                                        } )
    
    G_M262$B_pred_year2 <- predict(get(paste("nls_M262.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M262",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M262$MEASTIME_t2,
                                               "STDAGE_t2" = G_M262$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M262$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_M262$STDAGE_t1,
                                                 "DeltaPDSI" = G_M262$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M262$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_M262$STDAGE_t1,
                                                   "B_L_prop" = G_M262$B_L_prop, 
                                                   "DeltaPDSI" = G_M262$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_M262$DeltaB_year<- (G_M262$B_pred_year2 - G_M262$B_pred_year1) / G_M262$REMPER
}

#### M313

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "M313",]$Best.Mod == "NA"){

    G_M313$B_pred_year1 <- predict(get(paste("nls_M313.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M313",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M313$MEASTIME_t1,
                                               "STDAGE_t2" = G_M313$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M313$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M313$STDAGE_t1,
                                                 "DeltaPDSI" = G_M313$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M313$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M313$STDAGE_t1,
                                                   "B_L_prop" = G_M313$B_L_prop, 
                                                   "DeltaPDSI" = G_M313$DeltaPDSI)
                                        } )
    
    G_M313$B_pred_year2 <- predict(get(paste("nls_M313.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M313",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M313$MEASTIME_t2,
                                               "STDAGE_t2" = G_M313$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M313$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_M313$STDAGE_t1,
                                                 "DeltaPDSI" = G_M313$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M313$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_M313$STDAGE_t1,
                                                   "B_L_prop" = G_M313$B_L_prop, 
                                                   "DeltaPDSI" = G_M313$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_M313$DeltaB_year<- (G_M313$B_pred_year2 - G_M313$B_pred_year1) / G_M313$REMPER
}

#### M331

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "M331",]$Best.Mod == "NA"){

    G_M331$B_pred_year1 <- predict(get(paste("nls_M331.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M331",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M331$MEASTIME_t1,
                                               "STDAGE_t2" = G_M331$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M331$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M331$STDAGE_t1,
                                                 "DeltaPDSI" = G_M331$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M331$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M331$STDAGE_t1,
                                                   "B_L_prop" = G_M331$B_L_prop, 
                                                   "DeltaPDSI" = G_M331$DeltaPDSI)
                                        } )
    
    G_M331$B_pred_year2 <- predict(get(paste("nls_M331.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M331",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M331$MEASTIME_t2,
                                               "STDAGE_t2" = G_M331$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M331$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_M331$STDAGE_t1,
                                                 "DeltaPDSI" = G_M331$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M331$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_M331$STDAGE_t1,
                                                   "B_L_prop" = G_M331$B_L_prop, 
                                                   "DeltaPDSI" = G_M331$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_M331$DeltaB_year<- (G_M331$B_pred_year2 - G_M331$B_pred_year1) / G_M331$REMPER
}

#### M332

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "M332",]$Best.Mod == "NA"){

    G_M332$B_pred_year1 <- predict(get(paste("nls_M332.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M332",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M332$MEASTIME_t1,
                                               "STDAGE_t2" = G_M332$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M332$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M332$STDAGE_t1,
                                                 "DeltaPDSI" = G_M332$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M332$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M332$STDAGE_t1,
                                                   "B_L_prop" = G_M332$B_L_prop, 
                                                   "DeltaPDSI" = G_M332$DeltaPDSI)
                                        } )
    
    G_M332$B_pred_year2 <- predict(get(paste("nls_M332.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M332",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M332$MEASTIME_t2,
                                               "STDAGE_t2" = G_M332$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M332$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_M332$STDAGE_t1,
                                                 "DeltaPDSI" = G_M332$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M332$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_M332$STDAGE_t1,
                                                   "B_L_prop" = G_M332$B_L_prop, 
                                                   "DeltaPDSI" = G_M332$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_M332$DeltaB_year<- (G_M332$B_pred_year2 - G_M332$B_pred_year1) / G_M332$REMPER
}

#### M333

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "M333",]$Best.Mod == "NA"){

    G_M333$B_pred_year1 <- predict(get(paste("nls_M333.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M333",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M333$MEASTIME_t1,
                                               "STDAGE_t2" = G_M333$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M333$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M333$STDAGE_t1,
                                                 "DeltaPDSI" = G_M333$DeltaPDSI, na.rm = T)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M333$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M333$STDAGE_t1,
                                                   "B_L_prop" = G_M333$B_L_prop, 
                                                   "DeltaPDSI" = G_M333$DeltaPDSI)
                                        } )
    
    G_M333$B_pred_year2 <- predict(get(paste("nls_M333.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M333",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M333$MEASTIME_t2,
                                               "STDAGE_t2" = G_M333$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M333$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_M333$STDAGE_t1,
                                                 "DeltaPDSI" = G_M333$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M333$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_M333$STDAGE_t1,
                                                   "B_L_prop" = G_M333$B_L_prop, 
                                                   "DeltaPDSI" = G_M333$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_M333$DeltaB_year<- (G_M333$B_pred_year2 - G_M333$B_pred_year1) / G_M333$REMPER
}

#### M334

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "M334",]$Best.Mod == "NA"){

    G_M334$B_pred_year1 <- predict(get(paste("nls_M334.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M334",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M334$MEASTIME_t1,
                                               "STDAGE_t2" = G_M334$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M334$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M334$STDAGE_t1,
                                                 "DeltaPDSI" = G_M334$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M334$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M334$STDAGE_t1,
                                                   "B_L_prop" = G_M334$B_L_prop, 
                                                   "DeltaPDSI" = G_M334$DeltaPDSI)
                                        } )
    
    G_M334$B_pred_year2 <- predict(get(paste("nls_M334.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M334",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M334$MEASTIME_t2,
                                               "STDAGE_t2" = G_M334$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M334$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_M334$STDAGE_t1,
                                                 "DeltaPDSI" = G_M334$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M334$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_M334$STDAGE_t1,
                                                   "B_L_prop" = G_M334$B_L_prop, 
                                                   "DeltaPDSI" = G_M334$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_M334$DeltaB_year<- (G_M334$B_pred_year2 - G_M334$B_pred_year1) / G_M334$REMPER
}

#### M341

if(!Best_mods.P_nh[Best_mods.P_nh$Code == "M341",]$Best.Mod == "NA"){

    G_M341$B_pred_year1 <- predict(get(paste("nls_M341.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M341",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M341$MEASTIME_t1,
                                               "STDAGE_t2" = G_M341$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M341$MEASTIME_t1,
                                                 "STDAGE_t2" =  G_M341$STDAGE_t1,
                                                 "DeltaPDSI" = G_M341$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M341$MEASTIME_t1,
                                                   "STDAGE_t2" =  G_M341$STDAGE_t1,
                                                   "B_L_prop" = G_M341$B_L_prop, 
                                                   "DeltaPDSI" = G_M341$DeltaPDSI)
                                        } )
    
    G_M341$B_pred_year2 <- predict(get(paste("nls_M341.",  Best_mods.P_nh[Best_mods.P_nh$Code == "M341",]$Best.Mod, sep ="")),
                                  newdata = if(Mod.Sel3 %in% c(1,"1a","1b","1c",4)){
                                    data.frame("MEASTIME_t2" = G_M341$MEASTIME_t2,
                                               "STDAGE_t2" = G_M341$STDAGE_t1)
                                    } else if (Mod.Sel3 %in% c(2,"2a","2b","2c",5)){
                                      data.frame("MEASTIME_t2" =  G_M341$MEASTIME_t2,
                                                 "STDAGE_t2" =  G_M341$STDAGE_t1,
                                                 "DeltaPDSI" = G_M341$DeltaPDSI)
                                      } else if (Mod.Sel3 %in% c(3,"3a","3b","3c",6)){
                                        data.frame("MEASTIME_t2" =  G_M341$MEASTIME_t2,
                                                   "STDAGE_t2" =  G_M341$STDAGE_t1,
                                                   "B_L_prop" = G_M341$B_L_prop, 
                                                   "DeltaPDSI" = G_M341$DeltaPDSI)
                                        } )
    
    # calculate delta-B due to year (ge) -- simple subtraction
    G_M341$DeltaB_year<- (G_M341$B_pred_year2 - G_M341$B_pred_year1) / G_M341$REMPER
}

```




```{r}
### Data wrangling

BK_df <-  cbind(Region = c(rep("east", length(G_211$pltID)), 
                                rep("east", length(G_212$pltID)),
                                rep("east", length(G_221$pltID)),
                                rep("east", length(G_222$pltID)),
                                rep("east", length(G_223$pltID)),
                                rep("east", length(G_231$pltID)),
                                rep("east", length(G_232$pltID)),
                                rep("east", length(G_234$pltID)),
                                rep("east", length(G_251$pltID)),
                                rep("east", length(G_255$pltID)),
                                #rep("interior west", length(G_313$pltID)),
                                #rep("interior west", length(G_331$pltID)),
                                rep("interior west", length(G_332$pltID)),
                                rep("east", length(G_M211$pltID)),
                                rep("east", length(G_M223$pltID)),
                                #rep("pacific", length(G_M242$pltID)),
                                rep("pacific", length(G_M261$pltID)),
                                #rep("interior west", length(G_M313$pltID)),
                                #rep("interior west", length(G_M331$pltID)),
                                #rep("interior west", length(G_M332$pltID)),
                                #rep("interior west", length(G_M333$pltID)),
                                rep("interior west", length(G_M334$pltID))),
                                #rep("interior west", length(G_M341$pltID))),
                # Ecoprovince = c(rep("211 - Northeastern Mixed Forest", length(G_211$pltID)), 
                #                 rep("212 - Laurentian Mixed Forest", length(G_212$pltID)),
                #                 rep("221 - Eastern Broadleaf Forest", length(G_221$pltID)),
                #                 rep("222 - Midwest Broadleaf Forest", length(G_222$pltID)),
                #                 rep("223 - Central Interior Broadleaf Forest", length(G_223$pltID)),
                #                 rep("231 - Southeastern Mixed Forest", length(G_231$pltID)),
                #                 rep("232 - Outer Coastal Plain Mixed Forest", length(G_232$pltID)),
                #                 rep("234 - Lower Mississippi Riverine Forest", length(G_234$pltID)),
                #                 rep("251 - Temperate Prairie Parkland", length(G_251$pltID)),
                #                 rep("255 - Subtropical Prairie Parkland", length(G_255$pltID)),
                #                 rep("313 - Colorado Plateau Semi-Desert", length(G_313$pltID)),
                #                 rep("331 - Great Plains/Palouse Dry Steppe", length(G_331$pltID)),
                #                 rep("332 - Great Plains Steppe", length(G_332$pltID)),
                #                 rep("M211 - Adirondack-New England Mixed forest - Coniferous Forest - Alpine Meadow", length(G_M211$pltID)),
                #                 rep("M223 - Ozark Broadleaf Forest Meadow", length(G_M223$pltID)),
                #                 rep("M242 - Cascade Mixed Forest", length(G_M242$pltID)),
                #                 rep("M261 - Sierran Steppe - Mixed Forest - Coniferous Forest - Alpine Meadow", length(G_M261$pltID)),
                #                 rep("M313 - Arizona-New Mexico Mountains Semi-Desert - Open Woodland - Coniferous Forest - Alpine Meadow", length(G_M313$pltID)),
                #                 rep("M331 - Southern Rocky Mountain Steppe - Open Woodland - Coniferous Forest - Alpine Meadow", length(G_M331$pltID)),
                #                 rep("M332 - Middle Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow", length(G_M332$pltID)),
                #                 rep("M333 - Northern Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow", length(G_M333$pltID)),
                #                 rep("M334 - Black Hills Coniferous Forest", length(G_M334$pltID)),
                #                 rep("M341 - Nevada-Utah Mountains Semi-Desert - Coniferous Forest - Alpine Meadow", length(G_M341$pltID))),
                Ecoprovince = c(rep("211", length(G_211$pltID)), 
                                rep("212", length(G_212$pltID)),
                                rep("221", length(G_221$pltID)),
                                rep("222", length(G_222$pltID)),
                                rep("223", length(G_223$pltID)),
                                rep("231", length(G_231$pltID)),
                                rep("232", length(G_232$pltID)),
                                rep("234", length(G_234$pltID)),
                                rep("251", length(G_251$pltID)),
                                rep("255", length(G_255$pltID)),
                                #rep("313", length(G_313$pltID)),
                                #rep("331", length(G_331$pltID)),
                                rep("332", length(G_332$pltID)),
                                rep("M211", length(G_M211$pltID)),
                                rep("M223", length(G_M223$pltID)),
                                #rep("M242", length(G_M242$pltID)),
                                rep("M261", length(G_M261$pltID)),
                                #rep("M313", length(G_M313$pltID)),
                                #rep("M331", length(G_M331$pltID)),
                                #rep("M332", length(G_M332$pltID)),
                                #rep("M333", length(G_M333$pltID)),
                                rep("M334", length(G_M334$pltID))),
                                #rep("M341", length(G_M341$pltID))),
                rbind(G_211[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      G_212[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      G_221[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      G_222[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      G_223[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      G_231[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      G_232[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      G_234[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      G_251[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      G_255[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      #G_313[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      #G_331[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      G_332[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      G_M211[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      G_M223[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      #G_M242[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      G_M261[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      #G_M313[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      #G_M331[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      #G_M332[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      #G_M333[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")],
                      G_M334[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")]))
                      #G_M341[,c("diff_STDAGE", "DeltaB_age", "DeltaB_year")]))

## reshape data wide to long
BK_df_long <- reshape2::melt(BK_df, id.vars = c("Region", "Ecoprovince"), measure.vars = c("DeltaB_age", "DeltaB_year"))
```


```{r}
## summarySE function

# http://www.cookbook-r.com/Graphs/Plotting_means_and_error_bars_(ggplot2)/

## Gives count, mean, standard deviation, standard error of the mean, and confidence interval (default 95%).
##   data: a data frame.
##   measurevar: the name of a column that contains the variable to be summariezed
##   groupvars: a vector containing names of columns that contain grouping variables
##   na.rm: a boolean that indicates whether to ignore NA's
##   conf.interval: the percent range of the confidence interval (default is 95%)
summarySE <- function(data=NULL, measurevar, groupvars=NULL, na.rm=FALSE,
                      conf.interval=.95, .drop=TRUE) {
    
    # New version of length which can handle NA's: if na.rm==T, don't count them
    length2 <- function (x, na.rm=FALSE) {
        if (na.rm) sum(!is.na(x))
        else       length(x)
    }

    # This does the summary. For each group's data frame, return a vector with
    # N, mean, and sd
    datac <- plyr::ddply(data, groupvars, .drop=.drop,
      .fun = function(xx, col) {
        c(N    = length2(xx[[col]], na.rm=na.rm),
          mean = mean   (xx[[col]], na.rm=na.rm),
          sd   = sd     (xx[[col]], na.rm=na.rm)
        )
      },
      measurevar
    )

    # Rename the "mean" column    
    datac <- plyr::rename(datac, c("mean" = measurevar))

    datac$se <- datac$sd / sqrt(datac$N)  # Calculate standard error of the mean

    # Confidence interval multiplier for standard error
    # Calculate t-statistic for confidence interval: 
    # e.g., if conf.interval is .95, use .975 (above/below), and use df=N-1
    ciMult <- qt(conf.interval/2 + .5, datac$N-1)
    datac$ci <- datac$se * ciMult

    return(datac)
}

BK_df_age_avg <- summarySE(BK_df, measurevar = "DeltaB_age", groupvars = c("Region","Ecoprovince"), na.rm = T)
colnames(BK_df_age_avg)[4] <- "value" # rename the mean to "Value" to match other df

BK_df_age_avg <- BK_df_age_avg[order(BK_df_age_avg$value, decreasing = T),] ### order from greatest to least

BK_df_year_avg <- summarySE(BK_df, measurevar = "DeltaB_year", groupvars = c("Region","Ecoprovince"), na.rm = T)
colnames(BK_df_year_avg)[4] <- "value" # rename the mean to "Value" to match other df

BK_df_year_avg$Ecoprovince <- factor(BK_df_year_avg$Ecoprovince, levels=BK_df_age_avg$Ecoprovince)

## stack the dataframes
BK_df_avg <- rbind(BK_df_age_avg ,BK_df_year_avg )
BK_df_avg$variable <- c(rep("DeltaB_age", 15), rep("DeltaB_year", 15))

BK_df_avg$Ecoprovince <- factor(BK_df_avg$Ecoprovince, levels=BK_df_age_avg$Ecoprovince) ## reorder the levels of the df to match decraseing Delta_B_age order


##############
##################  NEED TO RE-ORDER BK_df_long  factor levels to get order correct for plotting
BK_df_long$Ecoprovince <- factor(BK_df_long$Ecoprovince, levels=BK_df_age_avg$Ecoprovince)
```


#### make a fig
```{r}
gg_BK1 <- ggplot(aes(x=Ecoprovince, y = value, group = variable), data = BK_df_long) +
          geom_hline(yintercept = 0, lty = 2) +
          
          geom_jitter(aes(x=Ecoprovince, y = value, fill = variable), data = BK_df_long,
                      position = position_jitterdodge(0.75), 
                      shape = ".", alpha = 0.05, col = "gray") +
         
          facet_grid(.~Region, scales= "free", space = "free_x", drop = TRUE) +
          
          geom_point(aes(x=Ecoprovince, y = value, col = variable), 
                    data = BK_df_avg, position = position_dodge(width = 0.75),  shape = 15) + 
          geom_errorbar(aes(x=Ecoprovince, y = value, ymax = value+ci, ymin = value-ci, col = variable), 
                    data = BK_df_avg, position = position_dodge(width = 0.75), width = 0.75) +
          scale_color_manual(values = c("#E69F00", "#009E73"),
                             labels = c(expression(Delta*B~age), expression(Delta*B~growth~enhancement)), name="") +
          guides(fill="none") +  ## removed second legend
          ylab(expression(Delta*B~"(Mg ha"^-1~yr^-1*")")) +
  
          theme_classic() +
          theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
                legend.position = "top", legend.margin=margin(c(0,0,0,0))) +
          coord_cartesian(ylim=c(-4, 4))
          
          
#tiff("FIA_Bookkeeper_v1b_12.1.2022.tiff", width = 19, height = 8, units = "cm", res = 600, compression ="lzw")        
gg_BK1
#dev.off()
```

### 3. stand age densities

```{r}
## step 1 take first & last record or each plot 

#### TEMPORALLY BALANCING: 

### grab the pltIDs with >= 2 observations
g1.pltIDs <-  names(table(G$pltID) [table(G$pltID) >1])

# Subset 
G_bal <- G[G$pltID %in% g1.pltIDs,] 

G_first <- G_bal %>% group_by(pltID) %>% slice(c(1))
G_last <- G_bal %>% group_by(pltID) %>% slice(c(n()))

## Do some data wrangling
G_first <- G_first[,c("ECOPROVCD", "STDAGE_t1")]  #subset the needed columns
colnames(G_first)[2] <- "STDAGE"
G_first$meas <- "first"

G_first_mtnWest <- G[G$ECOPROVCD %in% c("313", "M313", "M331", "M341"),c("ECOPROVCD", "STDAGE_t1")]
colnames(G_first_mtnWest)[2] <- "STDAGE"
G_first_mtnWest$meas <- "first"

G_last <- G_last[,c("ECOPROVCD", "STDAGE_t2")]  #subset the needed columns
colnames(G_last)[2] <- "STDAGE"
G_last$meas <- "most-recent"

G_last_mtnWest <- G[G$ECOPROVCD %in% c("313", "M313", "M331", "M341"),c("ECOPROVCD", "STDAGE_t2")]
colnames(G_last_mtnWest)[2] <- "STDAGE"
G_last_mtnWest$meas <- "most-recent"

## stack the two data.frames
G_age <- rbind(G_first,G_first_mtnWest, G_last, G_last_mtnWest)
G_age$meas <- as.factor(G_age$meas)
G_age$ECOPROVCD <- droplevels(G_age$ECOPROVCD)



## subset 
G_age <- G_age[G_age$ECOPROVCD %in% c("221","251", "222", "234", "223", "M223", "211", "M211", "231", "232", "212", "255", "313", "332", "M333", "M313", "331", "M332", "M334", "M341", "M331", "M242", "M261"),]

G_age$ECOPROVCD <- factor(G_age$ECOPROVCD, levels= c("221","251", "222", "234", "223", "M223", "211", "M211", "231", "232", "212", "255", "313", "332", "M333", "M313", "331", "M332", "M334", "M341", "M331", "M242", "M261"))
```

#### make a fig
```{r, fig.width = 4, fig.height = 16}
library(ggridges)


gg_age_dist <- ggplot(aes(y= as.character(ECOPROVCD), x=STDAGE), data = G_age) +
               geom_density_ridges(aes(fill = meas, point_color = meas, linetype = meas), scale = 0.6,
                                   quantile_lines = TRUE, quantiles = 2,
                                   jittered_points = TRUE, position =  "raincloud",
                                   #quantile_lines = TRUE, scale = 0.9, alpha = 0.7,    
                                   #vline_size = 1, vline_color = "red",
                                   alpha = 0.4,
                                   point_shape = ".",  
                                   point_alpha = 0.1) +
               theme_classic() + theme(legend.position = "top",
                                       legend.text = element_text(size = 10), 
                                       legend.key.size = unit(0.75, "lines")) +
               scale_fill_manual(values = c("#CC79A7", "#56B4E9")) +
               #scale_linetype_manual("Line", (values =c("solid","dotted"))) +
               coord_cartesian(xlim=c(0, 150)) + xlab("Stand Age (years)") + ylab("Ecoprovince") +
               theme(legend.title = element_blank(), legend.margin=margin(c(0,0,0,0))) + 
  
               scale_y_discrete(limits = rev(c("221","251", "222", "234", "223", "M223", "211", "M211", 
                                               "231", "232", "212", "255", "313", "332", "M333", "M313", 
                                               "331", "M332", "M334", "M341", "M331", "M242", "M261")))
               
# tiff("FIA_AgeDists_v1_12.1.2022.tiff", width = 6, height = 22, units = "cm", res = 600, compression ="lzw")        
gg_age_dist
# dev.off()
```

```{r}
### make a figure --  Change in Stand Age Distributions vs. Delta B due to AGE (age effects)

## data wrangling 
Age_effect_df <- merge(summarySE(BK_df, measurevar = "diff_STDAGE", groupvars = c("Region","Ecoprovince"), na.rm = T), summarySE(BK_df, measurevar = "DeltaB_age", groupvars = c("Region","Ecoprovince"), na.rm = T), by = c("Region", "Ecoprovince"))

## ggplot

gg.age_effect <- ggplot(aes(x= diff_STDAGE, y= DeltaB_age, shape = Region, col = Ecoprovince),
                        data = Age_effect_df) + 
                 #geom_abline(intercept = 0, slope = 1, lty = 2, size =1, alpha = 0.5) +   
                 geom_point() +
                 geom_errorbarh(aes(xmin = diff_STDAGE-se.x, xmax = diff_STDAGE+se.x)) +
                 geom_errorbar(aes(ymin = DeltaB_age-se.y, ymax = DeltaB_age+se.y)) +
                 theme_classic() + 
                 theme(legend.position = "top", strip.text.x = element_text(size = 6), aspect.ratio =1) + 
                 xlab(expression(~Delta*"Stand Age (yrs)")) + 
                 ylab(expression(~Delta*"B age (Mg ha"^1*" yr"^-1*")")) + guides(shape = guide_legend(ncol =1))


gg.age_effect
```


