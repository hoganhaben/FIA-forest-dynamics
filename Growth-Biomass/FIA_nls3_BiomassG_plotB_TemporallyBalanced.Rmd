---
title: "FIA - NLS Models: Biomass Growth vs. Biomass, Temporally-balanced"
author: "JAH"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_float: yes
    toc_collapsed: yes
    toc_depth: 3
---

```{r, include=FALSE, echo = FALSE}
knitr::opts_chunk$set(tidy.opts=list(width.cutoff=60),tidy=TRUE, echo = FALSE, cache.lazy = FALSE)
```

```{r, message = FALSE, warning = FALSE}
### dependencies
library(propagate); library(nlstools); library(ggplot2); library(dplyr)

## defined functions -- (for later) one for high.CI: mean +1.96sigma, and one for low.CI: mean -1.96sigma
high.CI <-  function(x) {mean(x, na.rm = T) + 1.96*plotrix::std.error(x, na.rm = T)}
low.CI <-  function(x) {mean(x, na.rm = T) - 1.96*plotrix::std.error(x, na.rm = T)}

## set working directory
setwd("C:/Users/hogan.jaaron/Dropbox/FIA_R/NLS_modeling")
# setwd("C:/Users/hogie/Dropbox/FIA_R/NLS_modeling")               # IF WORKING ON P-50
```


# Background

This document has nls (non-linear least squares) regression fits using the Michaelis-Menten functional form to USFS FIA (United States Forest Service Forest Inventory & Analysis) __biomass growth vs. biomass__ relationships.  We use the sum of tree biomass growth increment method for the plot biomass growth ($G$) calculation (see supplementary methods). Models are fitted separately by US ecoprovince 

Hypothetically, the entire functional form of the following Michaelis-Menten non-linear model is considered:  $G = (1 + (yr-1990)* ge/100) \times (1 - \alpha \cdot B_l) \times (1 + \phi \cdot \Delta PDSI) \times \left( \frac {A \cdot B_{t1}} {k+B_{t1}} \right)$, where $G$ is the plot level biomass growth calculated as the sum of tree biomass growth increments, $B_l$ is the calculated proportion of biomass loss over the census interval, $B_{t1}$ is the plot biomass at the first of two FIA plot tree censuses, $\Delta PDSI$ is the difference in the growing season (January-August) annual average PDSI values over the FIA plot measurement intervals and a 30-year climate normal (1969-1990), and $yr$ is the measurement year (all FIA data).  Free parameters are $\alpha$: the growth compensation of lost plot biomass, $ge$: biomass growth enhancement over time, $A$: the Michaelis-Menten asymptote and $k$: the Michaelis-Menten half-saturation constant.

Data have increasing variance in $G$ with increasing $B$, Thus, weighted nls is the best approach. We explore a few weighting options and found that proportional weighting can be achieved by weighting observations by $\frac {1} {meanG}$ in equal-sample sized plot biomass bins (n=20) for each ecoprovince. 

Model selection is used to determine.  to determine the best fitting models, which is implemented in two parts. A first model selection is done to determine the best model form either including $\alpha$: the biomass compensation effect due to lost biomass (natural mortality or harvest), $\phi$: the effect of changing climate (quantified as $\Delta PDSI$, or both. $\Delta PDSI$ is defined the difference in the Palmer drought severity index from January - August for the 10 years preceding the biomass measurement and the 1969-1990 period).  We explored $\Delta PDSI$ using only the summer growing months (June-August) over the same intervals, and analyses were insensitive to that change. For the first model selection the following models are considered: 

__model 1:  simple model__
$G = (1 + (yr-1990)* ge/100) \times \left( \frac {A \cdot B_{t1}} {k+B_{t1}} \right)$

__model 2: phi model__
$G = (1 + (yr-1990)* ge/100) \times (1 + \phi \cdot \Delta PDSI)  \times \left( \frac {A \cdot B_{t1}} {k+B_{t1}} \right)$

__model 3: phi-alpha model__
$G = (1 + (yr-1990)* ge/100) \times (1 + \phi \cdot \Delta PDSI)  \times (1 - \alpha \cdot B_l) \times \left( \frac {A \cdot B_{t1}} {k+B_{t1}} \right)$

Then, a second model selection is done using best-fitting model from part 1 and then considering additional $p$ and $s$ parameters (individually, and then together) to modify the Micheaelis-Menten functional form.  The $p$ parameter allows for an intercept in the model (i.e., for the model to not be forced through the origin), and the $s$ parameter increases model flexibility, with $s$>1 leading to more-sigmoidal shape. 

**sub-model a: p form** $pA + \left( \frac {(1-p)A \cdot B_{t1}} {k+B_{t1}} \right)$

**sub model b: s form** $\left( \frac {A \cdot B_{t1}^s} {k^s+B_{t1}^s} \right)$

**sub model c: p and s together** $pA + \left( \frac {(1-p)A \cdot B_{t1}^s} {k^s+B_{t1}^s} \right)$

*NOTE:*

*This document contains a temporally balanced set of $G$ observations. First, the data set limited to plots that meet our plot-based filtering criteria (see below).  Then the data set was further restricted to plots with at least 2 $G$ observations (i.e., three FIA tree census records), with one in each of the two following decades: 2000-2010 (including censuses part of FIA 3.0 from 1996-2000 as part of the 2000 panel), and 2011-2022.  For plots that had >2 $G$ observations we took the first and last ones.*

1. exclude FIA plots in plantation forests
2. exclude FIA plots with multiple plot conditions (COND_PROP_UNADJ > 0.95)
3. exclude FIA plots non-productive stands (i.e., those with less than 20 ft^3/acre/year timber producing capability; SITECLCD of 7)
4. exclude FIA plots in non-stocked stands (i.e., those with STDSZCD of 5)
5. exclude FIA plots in non-accessible areas (i.e., private lands etc., COND_STATUS_CD not equal to 1)
6. exclude FIA plot visits that are not part of the annual inventories (which also includes FIA plot visits for Phase 3 ozone measurements)

Additionally, in an effort to clean up the data set, we have removed outlier observations, using a quantile threshold approach.  We also calculated plot $G$ using as biomass balance method (see supplementary methods), and the difference between the two methods.  Accordingly, we define $diff_G$ as the difference between tree incremental $G$ and biomass balance $G$. We excluded observations which meet the following criteria using a 0.5% quantile ($QT$): 

* case A: where the $QT$ difference in tree incremental $G$ is > biomass balance plot G (i.e., > 99.5% $diff_G$ positive outliers)

* case B: where the $QT$ difference in tree incremental $G$ is < mass balance plot G (i.e., < 0.5% $diff_G$ negative outliers)

* case C: where the $QT$ difference in tree incremental $G$ is > 0 (i.e., > 99.5% positive outliers)

* case D: where the $QT$ difference in tree incremental $G$ is > 0 (i.e., < 0.5% negative outliers)

These data set cleaning criteria resulted in the exclusion of 1677  observations. 


Below the model fitting procedure is implemented by ecoprovince:

```{r}
### create nls formulae for modeling

### model 1
fg_1 <- formula(G_obs_TreeInc_MgHaYr ~ (1+(MEASTIME_avg-1990)*ge/100) * A*B_plt_t1_MgHa/(k+B_plt_t1_MgHa))
## model 2
fg_2 <-  formula(G_obs_TreeInc_MgHaYr ~ (1+(MEASTIME_avg-1990)*ge/100) * (1 + phi*DeltaPDSI) * A*B_plt_t1_MgHa/(k+B_plt_t1_MgHa))
## model 3
fg_3 <- formula(G_obs_TreeInc_MgHaYr ~ (1+(MEASTIME_avg-1990)*ge/100) * (1 + phi*DeltaPDSI) * (1-alpha*B_L_prop) *A*B_plt_t1_MgHa/(k+B_plt_t1_MgHa))


## model 1 variants
fg_1a <- formula(G_obs_TreeInc_MgHaYr ~ (1+(MEASTIME_avg-1990)*ge/100) * (p*A+((1-p)*A*B_plt_t1_MgHa/(k+B_plt_t1_MgHa))))
fg_1b <- formula(G_obs_TreeInc_MgHaYr ~ (1+(MEASTIME_avg-1990)*ge/100) * (A*B_plt_t1_MgHa^s/(k^s+B_plt_t1_MgHa^s)))
fg_1c <- formula(G_obs_TreeInc_MgHaYr ~ (1+(MEASTIME_avg-1990)*ge/100) * (p*A+((1-p)*A*B_plt_t1_MgHa^s/(k^s+B_plt_t1_MgHa^s))))


## model 2 variants
fg_2a <- formula(G_obs_TreeInc_MgHaYr ~ (1+(MEASTIME_avg-1990)*ge/100) * (1 + phi*DeltaPDSI) * (p*A+((1-p)*A*B_plt_t1_MgHa/(k+B_plt_t1_MgHa))))
fg_2b <- formula(G_obs_TreeInc_MgHaYr ~ (1+(MEASTIME_avg-1990)*ge/100) * (1 + phi*DeltaPDSI) * (A*B_plt_t1_MgHa^s/(k^s+B_plt_t1_MgHa^s)))
fg_2c <- formula(G_obs_TreeInc_MgHaYr ~ (1+(MEASTIME_avg-1990)*ge/100) * (1 + phi*DeltaPDSI) * (p*A+((1-p)*A*B_plt_t1_MgHa^s/(k^s+B_plt_t1_MgHa^s))))


## model 3 variants
fg_3a <- formula(G_obs_TreeInc_MgHaYr ~ (1+(MEASTIME_avg-1990)*ge/100) * (1 + phi*DeltaPDSI) * (1-alpha*B_L_prop) * (p*A+((1-p)*A*B_plt_t1_MgHa/(k+B_plt_t1_MgHa))))
fg_3b <- formula(G_obs_TreeInc_MgHaYr ~ (1+(MEASTIME_avg-1990)*ge/100) * (1 + phi*DeltaPDSI) * (1-alpha*B_L_prop) * (A*B_plt_t1_MgHa^s/(k^s+B_plt_t1_MgHa^s)))
fg_3c <- formula(G_obs_TreeInc_MgHaYr ~ (1+(MEASTIME_avg-1990)*ge/100) * (1 + phi*DeltaPDSI) * (1-alpha*B_L_prop) * (p*A+((1-p)*A*B_plt_t1_MgHa^s/(k^s+B_plt_t1_MgHa^s))))


###########################################

## define nls starting parameters 
A.start = 7
k.start = 50
ge.start= -0.5
phi.start = 0 
alpha.start = 0.8
```

```{r}
# ## load G dataset
# load("C:/Users/hogan.jaaron/Dropbox/FIA_R/BiomassGrowth/Biomass_Growth_calculations_june2022/FIA_G_calc.Rdata")
# # load("C:/Users/hogie/Dropbox/FIA_R/BiomassGrowth/Biomass_Growth_calculations_june2022/FIA_G_calc.Rdata")    # if working on P-50
# 
# ## FILTER THE DATASTET -- Plot Selection Criteria
# ## apply filters to the FIA_G_calc data frame
# #
# # ### create p_Cond_surv --- the combined  plot condition and survey table dataframe for subsetting
# #
# # for FIA plot conditions
# load("C:/Users/hogan.jaaron/Dropbox/FIA_R/Plot_Conditions_rFIA/FIA_conditions_allPlots.Rdata")
# # load("C:/Users/hogie/Dropbox/FIA_R/Plot_Conditions_rFIA/FIA_conditions_allPlots.Rdata")   # if working on P-50
# FIA_conditions$STATE <- as.factor(FIA_conditions$STATE)
# FIA_conditions$PROP_BASIS <- as.factor(FIA_conditions$PROP_BASIS)
# FIA_conditions$MIXEDCONFCD <- as.factor(FIA_conditions$MIXEDCONFCD)
# FIA_conditions$DWM_FUELBED_TYPCD  <-  as.factor(FIA_conditions$DWM_FUELBED_TYPCD)
# 
# # for FIA plots (plot table)
# load("C:/Users/hogan.jaaron/Dropbox/FIA_R/Plot_Conditions_rFIA/FIA_plots_allPlots.Rdata")
# # load("C:/Users/hogie/Dropbox/FIA_R/Plot_Conditions_rFIA/FIA_plots_allPlots.Rdata")   # if working on P-50
# FIA_plots$STATE <- as.factor(FIA_plots$STATE)
# FIA_plots$ECOSUBCD <- as.factor(FIA_plots$ECOSUBCD)
# 
# ##### COMBINE PLOT and CODITION TABLES
# P_cond <- dplyr::left_join(FIA_conditions, FIA_plots, by = c("STATE", "PLOT", "INVYR", "PLT_CN" = "CN"))  #PLT_CN = CN  merges condition table to the plot table using PLT_CN (see FIA data user guide 8.0)
# 
# #### load survey tables
# load("C:/Users/hogan.jaaron/Dropbox/FIA_R/Plot_Conditions_rFIA/FIA_survey.Rdata")
# # load("C:/Users/hogie/Dropbox/FIA_R/Plot_Conditions_rFIA/FIA_survey.Rdata")     # if working on P-50
# ##### COMBINE P_cond and survey tables
# P_cond_surv <- dplyr::left_join(P_cond, FIA_survey[,c("CN", "P3_OZONE_IND", "ANN_INVENTORY")], by = c("SRV_CN" = "CN"))
# 
# ###### COMBINE G_calc -- for plot filtering at T2
# G <- dplyr::left_join(FIA_G_calc, P_cond_surv[,c("STATE", "PLT_CN", "STDAGE", "INVYR", "STDORGCD", "CONDPROP_UNADJ", "SITECLCD","STDSZCD", "COND_STATUS_CD", "P3_OZONE_IND", "ANN_INVENTORY")], by = c("STATE", "CN" = "PLT_CN", "INVYR")) %>% distinct()  # 377825 observations
# 
# ### rename STDAGE for STDAGE_t2
# colnames(G)[39] <- "STDAGE_t2"
# 
# ##########################
# #### APPLYING FILTERS ####
# 
# ## remove cases of NA's STDAGE columns
# G <- G[!is.na(G$STDAGE_t2) & !G$STDAGE_t2 == 9999,]
# ## Filter out plantations
# G <- G[G$STDORGCD == 0, ]
# ## Filter plots with a single condition using a 95% threshold for CONDPROP_UNADJ
# G <- G[G$CONDPROP_UNADJ >= 0.95, ]
# ### Filter out SITECLCD 7 (non productive stands - those with less than 20 ft3/ac/yr)
# G <- G[!G$SITECLCD == 7,]
# ### Filter out non-stocked plots (with STDSZCD == 5)
# G <- G[!G$STDSZCD == 5,]
# 
# ### new filters - MAY 2022
# ### Filter out the the non-accessible plots -- COND_STATUS_CD == 1 is accessible
# G <- G[G$COND_STATUS_CD == 1,]
# ### Filter by survey table --- annual inventories YES
# G <- G[G$ANN_INVENTORY == "Y",]
# ### Filter by survey table --- B3_OZONE NO
# G <- G[G$P3_OZONE_IND == "N",]
# 
# #### DONE APPLYING FILTERS ####
# ###############################
# 
# ## dealing with ECOPROVINCES:
# G$ECOPROVCD <- stringr::str_replace_all(gsub('.{2}$', '', G$ECOSUBCD), stringr::fixed(" "), "")
# 
# G[G$ECOPROVCD == "M332A",]$ECOPROVCD <- "M332"
# G[G$ECOPROVCD == "M332E",]$ECOPROVCD <- "M332"
# 
# G$ECOPROVCD <-  as.factor(G$ECOPROVCD)
# 
# ## calculate & add MEASTIME_avg
# G$MEASTIME_avg <- (G$MEASTIME_t1 + G$MEASTIME_t2) /2
# 
# ############################# For STDAGE T1
# 
# ### subset the condition table to include only the dominant condition for 
# FIA_single_conditions <- FIA_conditions %>% group_by(STATE, PLT_CN, INVYR) %>% filter(row_number() == which.max(CONDPROP_UNADJ))  %>% select(STATE, PLT_CN, INVYR, CONDPROP_UNADJ, STDAGE) %>% unique()
# 
# df_STDAGE_t1 <- as.data.frame(FIA_single_conditions[FIA_single_conditions$PLT_CN %in% G$PREV_PLT_CN ,c("STATE", "PLT_CN",  "INVYR", "STDAGE")])
#                           
# colnames(df_STDAGE_t1)[2] <- "PREV_PLT_CN"
# colnames(df_STDAGE_t1)[4] <- "STDAGE_t1"
# 
# ## left_join  to add to the G dataframe
# G <- left_join(G, df_STDAGE_t1[,c("STATE", "PREV_PLT_CN", "STDAGE_t1")], by = c("STATE", "PREV_PLT_CN"))
# 
# ## for is.na STDAGE_t1 assign STDAGE_t2 value    ## done for 405 records
# G[is.na(G$STDAGE_t1),]$STDAGE_t1 <- G[is.na(G$STDAGE_t1),]$STDAGE_t2
# 
# ## difference in STDAGE
# G$diff_STDAGE <- G$STDAGE_t2 - G$STDAGE_t1
# ############################################################  (END for STDAGE T1)
# 
# save(G, file = "C:/Users/hogan.jaaron/Dropbox/FIA_R/Starter_FIA_data_processing/G_dataset.Rdata")
# 
# rm(P_cond, FIA_G_calc, FIA_conditions, FIA_single_conditions, FIA_plots, FIA_survey, P_cond_surv, df_STDAGE_t1)  #removes other data frames

### Load G dataset
load("C:/Users/hogan.jaaron/Dropbox/FIA_R/Starter_FIA_data_processing/G_dataset.Rdata")
```

```{r}
###  CODE TO CALCULATE delta_PDSI

## Note: This code calculates delta_PDSI -- the difference in the Palmer Drought Severity Index from the baseline (1960-1989) 
## and the census interval -- uncomment to run -- it takes a little while (a few hours) to run, so the output is saved and read in below 

#####################################################
#####################################################
## libraries
# library(terra)
# ## read in the the G data file (has spatial coordinates for plot locations)
# load("C:/Users/hogan.jaaron/Dropbox/FIA_R/Starter_FIA_data_processing/G_dataset.Rdata")
# 
# ### read in the data -  
# pdsi1 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_1_PRISM.nc")
# names(pdsi1) <- as.character(1895:2022)
# 
# pdsi2 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_2_PRISM.nc")
# names(pdsi2) <- as.character(1895:2022)
# 
# pdsi3 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_3_PRISM.nc")
# names(pdsi3) <- as.character(1895:2022)
# 
# pdsi4 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_4_PRISM.nc")
# names(pdsi4) <- as.character(1895:2022)
# 
# pdsi5 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_5_PRISM.nc")
# names(pdsi5) <- as.character(1895:2022)
# 
# ###### first pass: limited analysis to growing season - June, July and August - 
# pdsi6 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_6_PRISM.nc")
# names(pdsi6) <- as.character(1895:2022)
# 
# pdsi7 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_7_PRISM.nc")
# names(pdsi7) <- as.character(1895:2022)
# 
# pdsi8 <- rast("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PRISM_nc_files/pdsi_8_PRISM.nc")
# names(pdsi8) <- as.character(1895:2022)
# 
# ## make null dataframe
# G_pdsi_data <-  data.frame(pltID = G$pltID, 
#                          LAT = G$LAT,  
#                          LON = G$LON, 
#                          MEASTIME_t1 = G$MEASTIME_t1,
#                          MEASTIME_t2 = G$MEASTIME_t2,
#                          pdsi_baseline = rep(-9999, length(G$pltID)), 
#                          pdsi_growInt = rep(-9999, length(G$pltID)))
# 
# ## makes spatVector for spatial points of plot locations
# G_pts <- vect(cbind(G_pdsi_data$LON, G_pdsi_data$LAT), crs="+proj=longlat +datum=WGS84")
# 
# ##################################################### START FOR LOOP
# ### for loop to extract time-series data for each plot location
# for(i in 1:length(G_pdsi_data$pltID)){
#   
#   ### extract values 
#   pdsi_vec.1 <- unlist(terra::extract(pdsi1, G_pts[i]))
#   
#   pdsi_vec.2 <- unlist(terra::extract(pdsi2, G_pts[i]))
#   
#   pdsi_vec.3 <- unlist(terra::extract(pdsi3, G_pts[i]))
#   
#   pdsi_vec.4 <- unlist(terra::extract(pdsi4, G_pts[i]))
#   
#   pdsi_vec.5 <- unlist(terra::extract(pdsi5, G_pts[i]))
#   
#   pdsi_vec.6 <- unlist(terra::extract(pdsi6, G_pts[i]))
#   
#   pdsi_vec.7 <- unlist(terra::extract(pdsi7, G_pts[i]))
#   
#   pdsi_vec.8 <- unlist(terra::extract(pdsi8, G_pts[i]))
#   
#   ### calculate the average baseline value 1960-1989 --- 30 year climate normal 
#   G_pdsi_data$pdsi_baseline[i] <- mean(c(pdsi_vec.1[as.character(rep(1960:1989))], 
#                                          pdsi_vec.2[as.character(rep(1960:1989))], 
#                                          pdsi_vec.3[as.character(rep(1960:1989))], 
#                                          pdsi_vec.4[as.character(rep(1960:1989))], 
#                                          pdsi_vec.5[as.character(rep(1960:1989))], 
#                                          pdsi_vec.6[as.character(rep(1960:1989))],
#                                          pdsi_vec.7[as.character(rep(1960:1989))],
#                                          pdsi_vec.8[as.character(rep(1960:1989))]), 
#                                        na.rm = T)
#   
#   ### calculate the mean over the growth interval
#   G_pdsi_data$pdsi_growInt[i] <- mean(c(pdsi_vec.1[names(pdsi_vec.1) %in% 
#                                                              seq(floor(G_pdsi_data$MEASTIME_t1[i]), floor(G_pdsi_data$MEASTIME_t2[i]))], 
#                                         pdsi_vec.2[names(pdsi_vec.2) %in% 
#                                                              seq(floor(G_pdsi_data$MEASTIME_t1[i]), floor(G_pdsi_data$MEASTIME_t2[i]))],
#                                         pdsi_vec.3[names(pdsi_vec.3) %in% 
#                                                              seq(floor(G_pdsi_data$MEASTIME_t1[i]), floor(G_pdsi_data$MEASTIME_t2[i]))],
#                                         pdsi_vec.4[names(pdsi_vec.4) %in% 
#                                                              seq(floor(G_pdsi_data$MEASTIME_t1[i]), floor(G_pdsi_data$MEASTIME_t2[i]))],
#                                         pdsi_vec.5[names(pdsi_vec.5) %in% 
#                                                              seq(floor(G_pdsi_data$MEASTIME_t1[i]), floor(G_pdsi_data$MEASTIME_t2[i]))],
#                                         pdsi_vec.6[names(pdsi_vec.6) %in% 
#                                                              seq(floor(G_pdsi_data$MEASTIME_t1[i]), floor(G_pdsi_data$MEASTIME_t2[i]))],
#                                         pdsi_vec.7[names(pdsi_vec.7) %in% 
#                                                              seq(floor(G_pdsi_data$MEASTIME_t1[i]), floor(G_pdsi_data$MEASTIME_t2[i]))], 
#                                         pdsi_vec.8[names(pdsi_vec.8) %in% 
#                                                              seq(floor(G_pdsi_data$MEASTIME_t1[i]), floor(G_pdsi_data$MEASTIME_t2[i]))]),
#                                     na.rm = T)
# 
# } ## end for loop
# #####################################################
# 
# ## make column for difference
# G_pdsi_data$DeltaPDSI <-  G_pdsi_data$pdsi_growInt - G_pdsi_data$pdsi_baseline
# 
# ### deal with NaNs
# NaN_vec  <- as.numeric(row.names(G_pdsi_data[is.na(G_pdsi_data$DeltaPDSI),]))
# 
# ### for loop to extract time-series data for each plot location
# for(i in 1:length(NaN_vec)){
#   
#   ### extract values 
#   pdsi_vec.1 <- unlist(terra::extract(pdsi1, G_pts[NaN_vec[i]], method = "bilinear"))
# 
#   pdsi_vec.2 <- unlist(terra::extract(pdsi2, G_pts[NaN_vec[i]], method = "bilinear"))
#   
#   pdsi_vec.3 <- unlist(terra::extract(pdsi3, G_pts[NaN_vec[i]], method = "bilinear"))
#   
#   pdsi_vec.4 <- unlist(terra::extract(pdsi4, G_pts[NaN_vec[i]], method = "bilinear"))
#   
#   pdsi_vec.5 <- unlist(terra::extract(pdsi5, G_pts[NaN_vec[i]], method = "bilinear"))
#   
#   pdsi_vec.6 <- unlist(terra::extract(pdsi6, G_pts[NaN_vec[i]], method = "bilinear"))
#   
#   pdsi_vec.7 <- unlist(terra::extract(pdsi7, G_pts[NaN_vec[i]], method = "bilinear"))
#   
#   pdsi_vec.8 <- unlist(terra::extract(pdsi8, G_pts[NaN_vec[i]], method = "bilinear"))
#   
#   ### calculate the average baseline value 1960-1989 --- 30 year climate normal 
#   G_pdsi_data$pdsi_baseline[NaN_vec[i]] <- mean(c(pdsi_vec.1[as.character(rep(1960:1989))],
#                                                   pdsi_vec.2[as.character(rep(1960:1989))], 
#                                                   pdsi_vec.3[as.character(rep(1960:1989))],
#                                                   pdsi_vec.4[as.character(rep(1960:1989))],
#                                                   pdsi_vec.5[as.character(rep(1960:1989))],
#                                                   pdsi_vec.6[as.character(rep(1960:1989))],
#                                                   pdsi_vec.7[as.character(rep(1960:1989))], 
#                                                   pdsi_vec.8[as.character(rep(1960:1989))]), 
#                                                 na.rm = T)
#   
#   ### calculate the mean over the growth interval
#   G_pdsi_data$pdsi_growInt[NaN_vec[i]] <- mean(c(pdsi_vec.1[names(pdsi_vec.1) %in% 
#                                                              seq(floor(G_pdsi_data$MEASTIME_t1[NaN_vec[i]]), floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]]))], 
#                                                 pdsi_vec.2[names(pdsi_vec.2) %in% 
#                                                              seq(floor(G_pdsi_data$MEASTIME_t1[NaN_vec[i]]), floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]]))],
#                                                 pdsi_vec.3[names(pdsi_vec.3) %in% 
#                                                              seq(floor(G_pdsi_data$MEASTIME_t1[NaN_vec[i]]), floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]]))],
#                                                 pdsi_vec.4[names(pdsi_vec.4) %in% 
#                                                              seq(floor(G_pdsi_data$MEASTIME_t1[NaN_vec[i]]), floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]]))],
#                                                 pdsi_vec.5[names(pdsi_vec.5) %in% 
#                                                              seq(floor(G_pdsi_data$MEASTIME_t1[NaN_vec[i]]), floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]]))],
#                                                  pdsi_vec.6[names(pdsi_vec.6) %in% 
#                                                              seq(floor(G_pdsi_data$MEASTIME_t1[NaN_vec[i]]), floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]]))], 
#                                                  pdsi_vec.7[names(pdsi_vec.7) %in% 
#                                                              seq(floor(G_pdsi_data$MEASTIME_t1[NaN_vec[i]]), floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]]))], 
#                                                  pdsi_vec.8[names(pdsi_vec.8) %in% 
#                                                              seq(floor(G_pdsi_data$MEASTIME_t1[NaN_vec[i]]), floor(G_pdsi_data$MEASTIME_t2[NaN_vec[i]]))]),
#                                                na.rm = T)
# 
# } ## end for loop
# #####################################################
# 
# ## make column for difference
# G_pdsi_data$DeltaPDSI <-  G_pdsi_data$pdsi_growInt - G_pdsi_data$pdsi_baseline
# 
# ########################################
# ### save the result
# setwd("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI")
# save(G_pdsi_data, file = "G_pdsi_data.Rdata")
#####################################################
#####################################################
load("C:/Users/hogan.jaaron/Dropbox/FIA_R/data_PDSI/PDSI_calc_originals/G_pdsi_data_2_JAN-AUG.Rdata")  ## simply load ths finished data product -- the above code takes some time to run...

######## IF WORKING ON P-50
# load("C:/Users/hogie/Dropbox/FIA_R/data_PDSI/G_pdsi_data_2_JAN-AUG.Rdata")  ## simply load ths finished data product -- the above code takes some time to run...

### transfer DeltaPDSI column to G dataframe
G$DeltaPDSI <- G_pdsi_data$DeltaPDSI
```

```{r}
## APPLY CLEANERS 

## this code removes outliers that are greater than or less than a specified quantile threshold
## analyses were done with or without these cleaners, and results did not change 
## substantially quantatively or at all qualatitively. 
## 
## I apply the quantile threshold (XT) cleaners to the FIA biomass growth (G) dataset.  
## 4 cases are explored, investigating plots which fall outside of the quantile ranges (set to 0.005, and 0.0995) for:
## 
## * case A: where the QT difference in tree incremental G (TI) is > mass balance plot G (MB) (> 99.5% diff_G positive outliers)
## * case B: where the QT difference in tree incremental G (TI) is < mass balance plot G (MB) (> 0.5% diff_G negative outliers)
## * case C: where the QT difference in tree incremental G (TI) is > 0  (> 99.5% positive outliers)
## * case D: where the QT difference in tree incremental G (TI) is > 0  (< 0.5% negative outliers)

## step 1
## calculate diff G  - tree increment grwoth method minus mass balance method
G$diff_G_MgHaYr <- G$G_obs_TreeInc_MgHaYr - G$G_MassBal_MgHaYr

## set QT: quantile threshold
QT <- 0.005

# Cleaner case A: cases where TI > MB
## positive outliers for the difference in TreeInc to MassBal G
outliers_cleanerA <- G[G$diff_G_MgHaYr > quantile(G$diff_G_MgHaYr, probs = c(1-QT)),]

# Cleaner case B: cases where TI < MB
## negative outliers for  the difference in TreeInc to MassBal G
outliers_cleanerB <- G[G$diff_G_MgHaYr < quantile(G$diff_G_MgHaYr, probs = c(QT)),]

# Cleaner case C: TI > 0
G_cleanerC <- G[G$G_obs_TreeInc_MgHaYr > 0,]
## positive outliers
outliers_cleanerC <- G_cleanerC[G_cleanerC$G_obs_TreeInc_MgHaYr > quantile(G_cleanerC$G_obs_TreeInc_MgHaYr, probs = c(1-QT)),]

# Cleaner case D: TI < 0
G_cleanerD <- G[G$G_obs_TreeInc_MgHaYr < 0,]
## negative outliers
outliers_cleanerD <- G_cleanerD[G_cleanerD$G_obs_TreeInc_MgHaYr < quantile(G_cleanerD$G_obs_TreeInc_MgHaYr, probs = c(QT)),]

# # compare cases A and C
# ##  A in C
# outliers_cleanerA[,"pltID"] [outliers_cleanerA[,"pltID"] %in% outliers_cleanerC[,"pltID"]]
# ## C in A
# outliers_cleanerC[,"pltID"] [outliers_cleanerC[,"pltID"] %in% outliers_cleanerA[,"pltID"]]

# # compare cases B and D 
# ##  B in D
# outliers_cleanerB[,"pltID"] [outliers_cleanerB[,"pltID"] %in% outliers_cleanerD[,"pltID"]]
# ## D in B
# outliers_cleanerD[,"pltID"] [outliers_cleanerD[,"pltID"] %in% outliers_cleanerB[,"pltID"]]

## make list of cleaner pltIDs
cleaner_pltIDs <- c(outliers_cleanerA$pltID, outliers_cleanerB$pltID, outliers_cleanerC$pltID, outliers_cleanerD$pltID)
cleaner_pltIDs <- cleaner_pltIDs[order(cleaner_pltIDs)]

#### APPLY CLEANERS!
G <- G[!G$pltID %in% cleaner_pltIDs,]
```

# Temporally-balancing the biomass growth data set

Lets look at some quick attributes of the dataset:

* The data set has `r length(G$pltID)` observations, comprised of `r length(unique(G$pltID))` plots. 
* The frequency of growth measurements among plots is as follows : `r table(table(G$pltID))`. 
* Thus `r round(sum(table(G$pltID)>1)/length(unique(G$pltID))*100,2)` % of plots have at least two growth intervals. 

```{r}
### grab the pltIDs with >= 2 observations
g1.pltIDs <-  names(table(G$pltID) [table(G$pltID) >1])

# Subset 
G_bal <- G[G$pltID %in% g1.pltIDs,] 

G_bal <- G_bal %>% group_by(pltID) %>% slice(c(1,n()))
```

```{r, echo = FALSE}
### MAKE DATASETS FOR ECOPROVINCES 

## 211 - Northeastern Mixed Forest
G_211 <- G_bal[G_bal$ECOPROVCD == "211",]
## 212 - Laurentian Mixed Forest
G_212 <- G_bal[G_bal$ECOPROVCD == "212",]
## 221 -  Eastern Broadleaf Forest
G_221 <- G_bal[G_bal$ECOPROVCD == "221",]
## 222 - Midwest Broadleaf Forest
G_222 <- G_bal[G_bal$ECOPROVCD == "222",]
## 223 - Central Interior Broadleaf Forest
G_223 <- G_bal[G_bal$ECOPROVCD == "223",]
## 231 - Southeastern Mixed Forest
G_231 <- G_bal[G_bal$ECOPROVCD == "231",]
## 232 - Outer Coastal Plain Mixed Forest
G_232 <- G_bal[G_bal$ECOPROVCD == "232",]
## 234 - Lower Mississippi Riverine Forest
G_234 <- G_bal[G_bal$ECOPROVCD == "234",]
## 242 - Pacific Lowland Mixed Forest
G_242 <- G_bal[G_bal$ECOPROVCD == "242",]
## 251 - Prairie Parkland (Temperate)
G_251 <- G_bal[G_bal$ECOPROVCD == "251",]
## 255 - Prairie Parkland (Subtropical)
G_255 <- G_bal[G_bal$ECOPROVCD == "255",]
## 263 - California Coastal Steppe - Mixed Forest and Redwood Forest
G_263 <- G_bal[G_bal$ECOPROVCD == "263",]
## 313 - Colorado Plateau Semi-Desert
G_313 <- G_bal[G_bal$ECOPROVCD == "313",]
## 331 - Great Plains/Palouse Dry Steppe
G_331 <- G_bal[G_bal$ECOPROVCD == "331",]
## 332 - Great Plains Steppe
G_332 <- G_bal[G_bal$ECOPROVCD == "332",]
## 342 - Intermountain Semi-Desert
G_342 <- G_bal[G_bal$ECOPROVCD == "342",]
## M211 - Adirondack-New England Mixed forest - Coniferous Forest - Alpine Meadow
G_M211 <- G_bal[G_bal$ECOPROVCD == "M211",]
## M221 - Central Appalachian Broadleaf Forest - Coniferous Forest - Meadow
G_M221 <- G_bal[G_bal$ECOPROVCD == "M221",]
## M223 - Ozark Broadleaf Forest Meadow
G_M223 <- G_bal[G_bal$ECOPROVCD == "M223",]
## M231 - Ouachita Mixed Forest
G_M231 <- G_bal[G_bal$ECOPROVCD == "M231",]
## M242 - Cascade Mixed Forest
G_M242 <- G_bal[G_bal$ECOPROVCD == "M242",]
## M261 - Sierran Steppe - Mixed Forest - Coniferous Forest - Alpine Meadow
G_M261 <- G_bal[G_bal$ECOPROVCD == "M261",]
## M262- California Coastal Range Coniferous Forest - Open Woodland - Shrub - Meadow
G_M262 <- G_bal[G_bal$ECOPROVCD == "M262",]
## M313 - Arizona-New Mexico Mountains Semi-Desert - Open Woodland - Coniferous Forest - Alpine Meadow
G_M313 <- G_bal[G_bal$ECOPROVCD == "M313",]
## M331 - Southern Rocky Mountain Steppe - Open Woodland - Coniferous Forest - Alpine Meadow
G_M331 <- G_bal[G_bal$ECOPROVCD == "M331",]
## M332 - Middle Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow
G_M332 <- G_bal[G_bal$ECOPROVCD == "M332",]
# M333 - Northern Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow
G_M333 <- G_bal[G_bal$ECOPROVCD == "M333",]
## M334 - Black Hills Coniferous Forest
G_M334 <- G_bal[G_bal$ECOPROVCD == "M334",]

##ECOPROVINCES NOT INCLUDED:
            ## 261 - California Coastal Chaparral Forest and Shrub
            G_261 <- G_bal[G_bal$ECOPROVCD == "261",]

            ## 262 - California Dry Steppe
            G_262 <- G_bal[G_bal$ECOPROVCD == "262",]

            ## 315 - Southwest Plateau and Plains Dry Steppe and Shrub
            G_315 <- G_bal[G_bal$ECOPROVCD == "315",]

            ## 321 - Chihuahuan Semi-Desert 
            G_321 <- G_bal[G_bal$ECOPROVCD == "321",]

            ## 322 - American Semidesert and Desert
            G_322 <- G_bal[G_bal$ECOPROVCD == "322",]
  
            ## 341 - Intermountain Semi-Desert and Desert
            G_341 <- G_bal[G_bal$ECOPROVCD == "341",]
            
            ## 411 - Everglades
            G_411 <- G_bal[G_bal$ECOPROVCD == "411",]
            
            ## M341 - Nevada-Utah Mountains semi-Desert - Coniferous Forest - Alpine Meadow
            G_M341 <- G_bal[G_bal$ECOPROVCD == "M341",]
```


```{r}
#### create BEST MODEL DATA FRAME -- to be filled in later 

Best_mods.G <- data.frame(
  Code = c("211", "212", "221", "222", "223", "231", 
           "232", "234", "242", "251", "255", "261", 
           "262", "263", "313", "315", "321", "322", 
           "331", "332", "341", "342", "411", "M211", 
           "M221", "M223", "M231", "M242", "M261", "M262", "M313", 
           "M331", "M332", "M333", "M334", "M341"),
  Ecoregion = c(
      "Northeastern Mixed Forest", "Laurentian Mixed Forest", "Eastern Broadleaf Forest",
      "Midwest Broadleaf Forest", "Central Interior Broadleaf Forest", "Southeastern Mixed Forest",
      "Outer Coastal Plain Mixed Forest", "Lower Mississippi Riverine Forest", "Pacific Lowland Mixed Forest",
      "Prairie Parkland (Temperate)", "Prairie Parkland (Subtropical)", "California Coastal Chaparral Forest and Shrub",
      "California Dry Steppe", "California Coastal Steppe - Mixed Forest and Redwood Forest", "Colorado Plateau Semi-Desert",
      "Southwest Plateau and Plains Dry Steppe and Shrub", "Chihuahuan Semi-Desert", "American Semidesert and Desert",
      "Great Plains/Palouse Dry Steppe", "Great Plains Steppe", "Intermountain Semi-Desert and Desert",
      "Intermountain Semi-Desert", "Everglades", "Adirondack-New England Mixed forest - Coniferous Forest - Alpine Meadow",
      "Central Appalachian Broadleaf Forest - Coniferous Forest - Meadow", "Ozark Broadleaf Forest Meadow", "Ouachita Mixed Forest",
      "Cascade Mixed Forest", "Sierran Steppe - Mixed Forest - Coniferous Forest - Alpine Meadow", 
      "California Coastal Range Coniferous Forest - Open Woodland - Shrub - Meadow", 
      "Arizona-New Mexico Mountains Semi-Desert - Open Woodland - Coniferous Forest - Alpine Meadow", 
      "Southern Rocky Mountain Steppe - Open Woodland - Coniferous Forest - Alpine Meadow", 
      "Middle Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow", 
      "Northern Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow", "Black Hills Coniferous Forest", 
      "Nevada-Utah Mountains Semi-Desert - Coniferous Forest - Alpine Meadow"),  
  Sel.Mod = rep("NA", 36)
)
```

```{r}
nls.param.df2 <- data.frame(
   Code = c("211", "212", "221", "222", "223", "231", 
           "232", "234", "242", "251", "255", "261", 
           "262", "263", "313", "315", "321", "322", 
           "331", "332", "341", "342", "411", "M211", 
           "M221", "M223", "M231", "M242", "M261", "M262", "M313", 
           "M331", "M332", "M333", "M334", "M341"),
  Ecoregion = c(
      "Northeastern Mixed Forest", "Laurentian Mixed Forest", "Eastern Broadleaf Forest",
      "Midwest Broadleaf Forest", "Central Interior Broadleaf Forest", "Southeastern Mixed Forest",
      "Outer Coastal Plain Mixed Forest", "Lower Mississippi Riverine Forest", "Pacific Lowland Mixed Forest",
      "Prairie Parkland (Temperate)", "Prairie Parkland (Subtropical)", "California Coastal Chaparral Forest and Shrub",
      "California Dry Steppe", "California Coastal Steppe - Mixed Forest and Redwood Forest", "Colorado Plateau Semi-Desert",
      "Southwest Plateau and Plains Dry Steppe and Shrub", "Chihuahuan Semi-Desert", "American Semidesert and Desert",
      "Great Plains/Palouse Dry Steppe", "Great Plains Steppe", "Intermountain Semi-Desert and Desert",
      "Intermountain Semi-Desert", "Everglades", "Adirondack-New England Mixed forest - Coniferous Forest - Alpine Meadow",
      "Central Appalachian Broadleaf Forest - Coniferous Forest - Meadow", "Ozark Broadleaf Forest Meadow", "Ouachita Mixed Forest",
      "Cascade Mixed Forest", "Sierran Steppe - Mixed Forest - Coniferous Forest - Alpine Meadow", 
      "California Coastal Range Coniferous Forest - Open Woodland - Shrub - Meadow", 
      "Arizona-New Mexico Mountains Semi-Desert - Open Woodland - Coniferous Forest - Alpine Meadow", 
      "Southern Rocky Mountain Steppe - Open Woodland - Coniferous Forest - Alpine Meadow", 
      "Middle Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow", 
      "Northern Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow", "Black Hills Coniferous Forest", 
      "Nevada-Utah Mountains Semi-Desert - Coniferous Forest - Alpine Meadow"), 
  region = c("east", "east", "east", "east", "east", "east", 
             "east", "east", "pacific", "east", "pacific", "pacific",  
             "pacific", "pacific", "interior west", "interior west", "interior west", "interior west", 
             "interior west", "interior west", "interior west", "interior west", "east", "east", 
             "east", "east", "east", "pacific", "pacific",  "interior west", 
             "interior west", "interior west", "interior west", "interior west", "interior west", "interior west"),
             ## note: everglades treated as east, but not technically east -- separate region
  `n.obs` = c(length(G_211$pltID), length(G_212$pltID), length(G_221$pltID),
              length(G_222$pltID), length(G_223$pltID), length(G_231$pltID),
              length(G_232$pltID), length(G_234$pltID), length(G_242$pltID), 
              length(G_251$pltID),  length(G_255$pltID), length(G_261$pltID),
              length(G_262$pltID), length(G_263$pltID), length(G_313$pltID),
              length(G_315$pltID), length(G_321$pltID), length(G_322$pltID),
              length(G_331$pltID), length(G_332$pltID), length(G_341$pltID),
              length(G_342$pltID), length(G_411$pltID), length(G_M211$pltID),  
              length(G_M221$pltID), length(G_M223$pltID), length(G_M231$pltID),
              length(G_M242$pltID), length(G_M261$pltID), length(G_M262$pltID), 
              length(G_M313$pltID), length(G_M331$pltID), length(G_M332$pltID),
              length(G_M333$pltID), length(G_M334$pltID), length(G_M341$pltID)), 
  `n.plots` = c(length(unique(G_211$pltID)), length(unique(G_212$pltID)), length(unique(G_221$pltID)),
                length(unique(G_222$pltID)), length(unique(G_223$pltID)), length(unique(G_231$pltID)),
                length(unique(G_232$pltID)), length(unique(G_234$pltID)), length(unique(G_242$pltID)), 
                length(unique(G_251$pltID)), length(unique(G_255$pltID)), length(unique(G_261$pltID)),
                length(unique(G_262$pltID)), length(unique(G_263$pltID)), length(unique(G_313$pltID)),
                length(unique(G_315$pltID)), length(unique(G_321$pltID)), length(unique(G_322$pltID)),
                length(unique(G_331$pltID)), length(unique(G_332$pltID)), length(unique(G_341$pltID)),
                length(unique(G_342$pltID)), length(unique(G_411$pltID)), length(unique(G_M211$pltID)),  
                length(unique(G_M221$pltID)), length(unique(G_M223$pltID)), length(unique(G_M231$pltID)),
                length(unique(G_M242$pltID)), length(unique(G_M261$pltID)), length(unique(G_M262$pltID)),
                length(unique(G_M313$pltID)), length(unique(G_M331$pltID)), length(unique(G_M332$pltID)),
                length(unique(G_M333$pltID)), length(unique(G_M334$pltID)), length(unique(G_M341$pltID))),
   ge             = rep(-9999, 36), 
   `ge.2.5`       = rep(-9999, 36),
   `ge.97.5`      = rep(-9999, 36),
   phi            = rep(-9999, 36),
  `phi.2.5`       = rep(-9999, 36),
   `phi.97.5`     = rep(-9999, 36),
   `alpha`        = rep(-9999, 36),
   `alpha.2.5`    = rep(-9999, 36),
   `alpha.97.5`   = rep(-9999, 36),
   A              = rep(-9999, 36),
   `A.2.5`        = rep(-9999, 36),
   `A.97.5`       = rep(-9999, 36),
   k              = rep(-9999, 36), 
   `k.2.5`        = rep(-9999, 36),
   `k.97.5`       = rep(-9999, 36)
  )
```

# 211 - Northeastern Mixed Forest

```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_211 <- round(quantile(G_211$B_plt_t1_MgHa, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_211)))){
  cutvec_211 <- round(quantile(G_211$B_plt_t1_MgHa, seq(0,1, length.out = 11)))
}

bin_mids_211 <- unname(round(cutvec_211[-length(cutvec_211)] + diff(cutvec_211)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_211$Plt_B_bin <-  cut(G_211$B_plt_t1_MgHa, cutvec_211)
## get bin means
G_bin_means <- tapply(G_211$G_obs_TreeInc_MgHaYr, cut(G_211$B_plt_t1_MgHa, cutvec_211), mean)

## make column weights.1
G_211$nls_weights <- as.vector(1/G_bin_means[match(G_211$Plt_B_bin, names(G_bin_means))])

}
```

## model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_211.1 <- nls(fg_1, data = G_211, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_211$nls_weights), 
 )

## phi
try(
  nls_211.2 <- nls(fg_2, data=G_211, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_211$nls_weights), 
 )

# phi/alpha
try(
  nls_211.3 <- nls(fg_3, data = G_211, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_211$nls_weights), 
 )

## test
if(exists("nls_211.1") & exists("nls_211.2") & exists("nls_211.3")){
  print(anova(nls_211.1, nls_211.2, nls_211.3))
} else if(exists("nls_211.2") & exists("nls_211.3")){
  print(anova(nls_211.2, nls_211.3))
} else if(exists("nls_211.1") & exists("nls_211.2")){
  print(anova(nls_211.1, nls_211.2))
}
 
## AIC comparison
AIC1_211 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_211.1"), AIC(get("nls_211.1")), NA),
            ifelse(exists("nls_211.2"), AIC(get("nls_211.2")), NA),
            ifelse(exists("nls_211.3"), AIC(get("nls_211.3")), NA)
            ))

print(AIC1_211) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_211[!is.na(AIC1_211$AIC) & AIC1_211$AIC == min(AIC1_211$AIC, na.rm = T),]$model

try(summary(get(paste("nls_211.",  Mod.Sel1, sep =""))) ) #model summary

}
```
### summary 
* simple model: `r ifelse(exists("nls_211.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_211.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_211.3"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_211.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_211.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_211.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_211.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_211.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_211.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "a", sep ="")), 
          data = G_211,
          start = 
            if(Mod.Sel1 == 1) {
              c(ge.fit, A.fit, k.fit, p=0.1)
              } else if(Mod.Sel1 == 2){
                  c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
                } else if(Mod.Sel1 == 3) {
                       c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},  
          weights = G_211$nls_weights))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_211.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "b", sep ="")), 
          data = G_211,
          start = if(Mod.Sel1 == 1) {
              c(ge.fit, A.fit, k.fit, s=1.5)
              } else if(Mod.Sel1 == 2){
                  c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
                } else if(Mod.Sel1 == 3) {
                       c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_211$nls_weights)) 
 )

## c-model:  with s and p parameters
try(
  assign(
    paste("nls_211.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "c", sep ="")), 
          data = G_211,
          start = if(Mod.Sel1 == 1) {
              c(ge.fit, A.fit, k.fit,  p=0.1, s=1.5)
              } else if(Mod.Sel1 == 2){
                  c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
                } else if(Mod.Sel1 == 3) {
                       c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_211$nls_weights))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_211.", Mod.Sel1, sep ="")) &
     exists(paste("nls_211.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_211.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_211.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_211.", Mod.Sel1, sep ="")),
             get(paste("nls_211.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_211.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_211.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_211.", Mod.Sel1, sep ="")) &
         exists(paste("nls_211.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_211.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_211.", Mod.Sel1, sep ="")),
               get(paste("nls_211.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_211.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_211.", Mod.Sel1, sep ="")) &
           exists(paste("nls_211.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_211.", Mod.Sel1, sep ="")),
                 get(paste("nls_211.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_211.", Mod.Sel1, sep ="")) &
              exists(paste("nls_211.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_211.", Mod.Sel1, sep ="")),
                    get(paste("nls_211.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_211.", Mod.Sel1, sep ="")) &
                exists(paste("nls_211.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_211.", Mod.Sel1, sep ="")),
                      get(paste("nls_211.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_211 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_211.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_211.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_211.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_211.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_211.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_211.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_211.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_211.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_211)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_211[!is.na(AIC2_211$AIC) & AIC2_211$AIC == min(AIC2_211$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.G[Best_mods.G$Code == "211",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_211.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_211.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df2[nls.param.df2$Code == "211",]$ge <- coefs["ge"]
nls.param.df2[nls.param.df2$Code == "211",]$phi <- coefs["phi"]
nls.param.df2[nls.param.df2$Code == "211",]$alpha <- coefs["alpha"]
nls.param.df2[nls.param.df2$Code == "211",]$A <- coefs["A"]
nls.param.df2[nls.param.df2$Code == "211",]$k <- coefs["k"]

nls.param.df2[nls.param.df2$Code == "211",]$ge.2.5 <- intervals_low["ge"]
nls.param.df2[nls.param.df2$Code == "211",]$phi.2.5 <- intervals_low["phi"]
nls.param.df2[nls.param.df2$Code == "211",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df2[nls.param.df2$Code == "211",]$A.2.5 <- intervals_low["A"]
nls.param.df2[nls.param.df2$Code == "211",]$k.2.5 <- intervals_low["k"]

nls.param.df2[nls.param.df2$Code == "211",]$ge.97.5 <- intervals_high["ge"]
nls.param.df2[nls.param.df2$Code == "211",]$phi.97.5 <- intervals_high["phi"]
nls.param.df2[nls.param.df2$Code == "211",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df2[nls.param.df2$Code == "211",]$A.97.5 <- intervals_high["A"]
nls.param.df2[nls.param.df2$Code == "211",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_211.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_211.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_211.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_211.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals

```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_211 <- nlsResiduals(
  get(paste("nls_211.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_211)

## test residuals
if(length(G_211$pltID) < 5001) {test.nlsResiduals(resid_211)}

}  else {print("cannot plot residuals")}
```

## predict and plot

```{r, message = FALSE, cache=T}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

`211_pred2` <- predict(get(paste("nls_211.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME_avg"= rep(mean(G_211$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME_avg"= rep(mean(G_211$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "DeltaPDSI"= rep(mean(G_211$DeltaPDSI, na.rm =T), 1501))
                      } else if (Mod.Sel1 == 3){
                        data.frame("MEASTIME_avg"= rep(mean(G_211$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "B_L_prop"= rep(mean(G_211$B_L_prop, na.rm =T), 1501), 
                                   "DeltaPDSI"= rep(mean(G_211$DeltaPDSI, na.rm =T), 1501))
                      } )

## predicted interval data.frame
`211_pred_df` <- data.frame("B_plt_t1_MgHa" = seq(0,1500,by =1), fitted=`211_pred2`)

## PLOTTING 2
gg.211.2 <- ggplot() +
             geom_jitter(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_211, 
                         alpha = 0.5, color = "#00000080", shape = "+") +
             ## dark ponts = "#1E88E580"
             geom_hline(yintercept =0, lty =3) +
            
             stat_summary_bin(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_211, 
                              fun.data = function(x) {
                                res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                                names(res) <- c("ymin","y","ymax")
                                res}, 
                              col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_211)+1)), breaks = cutvec_211) +         
    
             # geom_ribbon(aes(x = B_plt_t1_MgHa, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
             #             data = 211_pred_df, color="#FF000080", fill ="#FF000080", alpha = 0.25, lty =3) +
             geom_line(aes(x = B_plt_t1_MgHa, y = fitted), data = `211_pred_df`, color="#FF000080", alpha = 0.5, lwd = 2) + 
             ## red = "#D6272880" 
    
             labs(x = expression("biomass (Mg ha"^-1*")"), 
                 y = expression("biomass growth (Mg ha"^-1*" yr"^-1*")")) + 
             ggtitle("211 - Northeastern Mixed Forest") +
             theme_classic() + theme(axis.text.x=element_text(angle=90,hjust=1)) + 
             scale_x_continuous(limits = c(0, tail(cutvec_211,1)*1.05), expand =c(0,0))  +
             coord_cartesian(ylim=c(-2, 10))

             #ylim(c(min(211_pred_df$`Prop.2.5%`)-0.25, max(211_pred_df$`Prop.97.5%`)+0.25))
             #ylim(c(-2,8))
            
gg.211.2

}  else {print("cannot plot data with prediction")}
```

## plotting 2

```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_211 <-data.frame(
  bin = as.factor(levels(cut(G_211$B_plt_t1_MgHa, cutvec_211))),
  data.mean = tapply(G_211$G_obs_TreeInc_MgHaYr, cut(G_211$B_plt_t1_MgHa, cutvec_211), 
                     mean), 
  data.CI.high =  tapply(G_211$G_obs_TreeInc_MgHaYr, cut(G_211$B_plt_t1_MgHa, cutvec_211), 
                    high.CI), 
  data.CI.low = tapply(G_211$G_obs_TreeInc_MgHaYr, cut(G_211$B_plt_t1_MgHa, cutvec_211),
                    low.CI), 
  pred.mean = `211_pred_df`[`211_pred_df`$B_plt_t1_MgHa %in% bin_mids_211,]$fitted) 


### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_211 <-  DM_compare_211 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_211$bin)[gtools::mixedorder(levels(DM_compare_211$bin))]))
                                                                                                        
## ggplot
gg.211.3 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_211) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_211))), 
                              labels = levels(DM_compare_211$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1,  alpha = 0.5) +         
           labs(x = expression("calculated G (Mg ha"^-1*" yr"^-1*")"), 
                y = expression("nls predicted G (Mg ha"^-1*" yr"^-1*")")) +
           ggtitle("211 - Northeastern Mixed Forest") +         
           theme_classic() + 
           theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.211.3

}
```

# 212 - Laurentian Mixed Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_212 <- round(quantile(G_212$B_plt_t1_MgHa, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_212)))){
  cutvec_212 <- round(quantile(G_212$B_plt_t1_MgHa, seq(0,1, length.out = 11)))
}

bin_mids_212 <- unname(round(cutvec_212[-length(cutvec_212)] + diff(cutvec_212)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_212$Plt_B_bin <-  cut(G_212$B_plt_t1_MgHa, cutvec_212)
## get bin means
G_bin_means <- tapply(G_212$G_obs_TreeInc_MgHaYr, cut(G_212$B_plt_t1_MgHa, cutvec_212), mean)

## make column weights.1
G_212$nls_weights <- as.vector(1/G_bin_means[match(G_212$Plt_B_bin, names(G_bin_means))])

}
```

## model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_212.1 <- nls(fg_1, data = G_212, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_212$nls_weights), 
 )

## phi
try(
  nls_212.2 <- nls(fg_2, data=G_212, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_212$nls_weights), 
 )

# phi/alpha
try(
  nls_212.3 <- nls(fg_3 , data = G_212, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_212$nls_weights), 
 )

## test
if(exists("nls_212.1") & exists("nls_212.2") & exists("nls_212.3")){
  print(anova(nls_212.1, nls_212.2, nls_212.3))
} else if(exists("nls_212.2") & exists("nls_212.3")){
  print(anova(nls_212.2, nls_212.3))
} else if(exists("nls_212.1") & exists("nls_212.2")){
  print(anova(nls_212.1, nls_212.2))
}
 
## AIC comparison
AIC1_212 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_212.1"), AIC(get("nls_212.1")), NA),
            ifelse(exists("nls_212.2"), AIC(get("nls_212.2")), NA),
            ifelse(exists("nls_212.3"), AIC(get("nls_212.3")), NA)
            ))

print(AIC1_212) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_212[!is.na(AIC1_212$AIC) & AIC1_212$AIC == min(AIC1_212$AIC, na.rm = T),]$model

try(summary(get(paste("nls_212.",  Mod.Sel1, sep =""))) ) #model summary

}
```
### summary 
* simple model: `r ifelse(exists("nls_212.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_212.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_212.3"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_212.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_212.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_212.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_212.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_212.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_212.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "a", sep ="")), 
          data = G_212,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit,  p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit,  p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit,  p=0.1)},
          weights = G_212$nls_weights))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_212.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "b", sep ="")), 
          data = G_212,
           start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit,s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit,  s=1.5)}, 
          weights = G_212$nls_weights)) 
 )

## c-model: with s and p parameters
try(
  assign(
    paste("nls_212.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "c", sep ="")), 
          data = G_212,
           start = if(Mod.Sel1 == 1) {
              c(ge.fit, A.fit, k.fit,  p=0.1, s=1.5)
              } else if(Mod.Sel1 == 2){
                  c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
                } else if(Mod.Sel1 == 3) {
                       c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_212$nls_weights))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_212.", Mod.Sel1, sep ="")) &
     exists(paste("nls_212.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_212.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_212.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_212.", Mod.Sel1, sep ="")),
             get(paste("nls_212.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_212.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_212.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_212.", Mod.Sel1, sep ="")) &
         exists(paste("nls_212.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_212.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_212.", Mod.Sel1, sep ="")),
               get(paste("nls_212.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_212.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_212.", Mod.Sel1, sep ="")) &
           exists(paste("nls_212.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_212.", Mod.Sel1, sep ="")),
                 get(paste("nls_212.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_212.", Mod.Sel1, sep ="")) &
              exists(paste("nls_212.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_212.", Mod.Sel1, sep ="")),
                    get(paste("nls_212.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_212.", Mod.Sel1, sep ="")) &
                exists(paste("nls_212.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_212.", Mod.Sel1, sep ="")),
                      get(paste("nls_212.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_212 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_212.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_212.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_212.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_212.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_212.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_212.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_212.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_212.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_212)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_212[!is.na(AIC2_212$AIC) & AIC2_212$AIC == min(AIC2_212$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.G[Best_mods.G$Code == "212",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_212.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_212.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df2[nls.param.df2$Code == "212",]$ge <- coefs["ge"]
nls.param.df2[nls.param.df2$Code == "212",]$phi <- coefs["phi"]
nls.param.df2[nls.param.df2$Code == "212",]$alpha <- coefs["alpha"]
nls.param.df2[nls.param.df2$Code == "212",]$A <- coefs["A"]
nls.param.df2[nls.param.df2$Code == "212",]$k <- coefs["k"]

nls.param.df2[nls.param.df2$Code == "212",]$ge.2.5 <- intervals_low["ge"]
nls.param.df2[nls.param.df2$Code == "212",]$phi.2.5 <- intervals_low["phi"]
nls.param.df2[nls.param.df2$Code == "212",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df2[nls.param.df2$Code == "212",]$A.2.5 <- intervals_low["A"]
nls.param.df2[nls.param.df2$Code == "212",]$k.2.5 <- intervals_low["k"]

nls.param.df2[nls.param.df2$Code == "212",]$ge.97.5 <- intervals_high["ge"]
nls.param.df2[nls.param.df2$Code == "212",]$phi.97.5 <- intervals_high["phi"]
nls.param.df2[nls.param.df2$Code == "212",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df2[nls.param.df2$Code == "212",]$A.97.5 <- intervals_high["A"]
nls.param.df2[nls.param.df2$Code == "212",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_212.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_212.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_212.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_212.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals

```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_212 <- nlsResiduals(
  get(paste("nls_212.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_212)

## test residuals
if(length(G_212$pltID) < 5001) {test.nlsResiduals(resid_212)}

}  else {print("cannot plot residuals")}
```

## predict and plot

```{r, message = FALSE, cache=T}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

`212_pred2` <- predict(get(paste("nls_212.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME_avg"= rep(mean(G_212$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME_avg"= rep(mean(G_212$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "DeltaPDSI"= rep(mean(G_212$DeltaPDSI, na.rm =T), 1501))
                      } else if (Mod.Sel1 == 3){
                        data.frame("MEASTIME_avg"= rep(mean(G_212$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "B_L_prop"= rep(mean(G_212$B_L_prop, na.rm =T), 1501), 
                                   "DeltaPDSI"= rep(mean(G_212$DeltaPDSI, na.rm =T), 1501))
                      } )


## predicted interval data.frame
`212_pred_df` <- data.frame("B_plt_t1_MgHa" = seq(0,1500,by =1), fitted=`212_pred2`)

## PLOTTING 2
gg.212.2 <- ggplot() +
             geom_jitter(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_212, 
                         alpha = 0.5, color = "#00000080", shape = "+") +
             ## dark ponts = "#1E88E580"
             geom_hline(yintercept =0, lty =3) +
            
             stat_summary_bin(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_212, 
                              fun.data = function(x) {
                                res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                                names(res) <- c("ymin","y","ymax")
                                res}, 
                              col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_212))), breaks = cutvec_212) +         
    
             # geom_ribbon(aes(x = B_plt_t1_MgHa, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
             #             data = 212_pred_df, color="#FF000080", fill ="#FF000080", alpha = 0.25, lty =3) +
             geom_line(aes(x = B_plt_t1_MgHa, y = fitted), data = `212_pred_df`, color="#FF000080", alpha = 0.5, lwd = 2) + 
             ## red = "#D6272880" 
    
             labs(x = expression("biomass (Mg ha"^-1*")"), 
                 y = expression("biomass growth (Mg ha"^-1*" yr"^-1*")")) + 
             ggtitle("212 - Laurentian Mixed Forest") +
             theme_classic() + theme(axis.text.x=element_text(angle=90,hjust=1)) + 
             scale_x_continuous(limits = c(0, tail(cutvec_212,1)*1.05), expand =c(0,0))  +
             coord_cartesian(ylim=c(-2, 10))

             #ylim(c(min(212_pred_df$`Prop.2.5%`)-0.25, max(212_pred_df$`Prop.97.5%`)+0.25))
             #ylim(c(-2,8))
            
gg.212.2

}  else {print("cannot plot data with prediction")}
```

## plotting 2

```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_212 <-data.frame(
  bin = as.factor(levels(cut(G_212$B_plt_t1_MgHa, cutvec_212))),
  data.mean = tapply(G_212$G_obs_TreeInc_MgHaYr, cut(G_212$B_plt_t1_MgHa, cutvec_212), 
                     mean, na.rm =T), 
  data.CI.high =  tapply(G_212$G_obs_TreeInc_MgHaYr, cut(G_212$B_plt_t1_MgHa, cutvec_212), 
                    high.CI), 
  data.CI.low = tapply(G_212$G_obs_TreeInc_MgHaYr, cut(G_212$B_plt_t1_MgHa, cutvec_212),
                    low.CI), 
  pred.mean = `212_pred_df`[`212_pred_df`$B_plt_t1_MgHa %in% bin_mids_212,]$fitted) 


### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_212 <-  DM_compare_212 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_212$bin)[gtools::mixedorder(levels(DM_compare_212$bin))]))
                                                                                                        
## ggplot
gg.212.3 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_212) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_212))), 
                              labels = levels(DM_compare_212$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1,  alpha = 0.5) +         
           labs(x = expression("calculated G (Mg ha"^-1*" yr"^-1*")"), 
                y = expression("nls predicted G (Mg ha"^-1*" yr"^-1*")")) +
           ggtitle("212 - Laurentian Mixed Forest") +         
           theme_classic() + 
            theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.212.3

}
```

# 221 - Eastern Broadleaf Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_221 <- round(quantile(G_221$B_plt_t1_MgHa, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_221)))){
  cutvec_221 <- round(quantile(G_221$B_plt_t1_MgHa, seq(0,1, length.out = 11)))
}

bin_mids_221 <- unname(round(cutvec_221[-length(cutvec_221)] + diff(cutvec_221)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_221$Plt_B_bin <-  cut(G_221$B_plt_t1_MgHa, cutvec_221)
## get bin means
G_bin_means <- tapply(G_221$G_obs_TreeInc_MgHaYr, cut(G_221$B_plt_t1_MgHa, cutvec_221), mean)

## make column weights.1
G_221$nls_weights <- as.vector(1/G_bin_means[match(G_221$Plt_B_bin, names(G_bin_means))])

}
```

## model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_221.1 <- nls(fg_1, data = G_221, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_221$nls_weights), 
 )

## phi
try(
  nls_221.2 <- nls(fg_2, data=G_221, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_221$nls_weights), 
 )

# phi/alpha
try(
  nls_221.3 <- nls(fg_3 , data = G_221, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_221$nls_weights), 
 )

## test
if(exists("nls_221.1") & exists("nls_221.2") & exists("nls_221.3")){
  print(anova(nls_221.1, nls_221.2, nls_221.3))
} else if(exists("nls_221.2") & exists("nls_221.3")){
  print(anova(nls_221.2, nls_221.3))
} else if(exists("nls_221.1") & exists("nls_221.2")){
  print(anova(nls_221.1, nls_221.2))
}
 
## AIC comparison
AIC1_221 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_221.1"), AIC(get("nls_221.1")), NA),
            ifelse(exists("nls_221.2"), AIC(get("nls_221.2")), NA),
            ifelse(exists("nls_221.3"), AIC(get("nls_221.3")), NA)
            ))

print(AIC1_221) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_221[!is.na(AIC1_221$AIC) & AIC1_221$AIC == min(AIC1_221$AIC, na.rm = T),]$model

try(summary(get(paste("nls_221.",  Mod.Sel1, sep =""))) ) #model summary

}
```
### summary 
* simple model: `r ifelse(exists("nls_221.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_221.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_221.3"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_221.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_221.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_221.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_221.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_221.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_221.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "a", sep ="")), 
          data = G_221,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_221$nls_weights))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_221.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "b", sep ="")), 
          data = G_221,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_221$nls_weights)) 
 )

## c-model: with s and p parameters
try(
  assign(
    paste("nls_221.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "c", sep ="")), 
          data = G_221,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit,  p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_221$nls_weights))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_221.", Mod.Sel1, sep ="")) &
     exists(paste("nls_221.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_221.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_221.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_221.", Mod.Sel1, sep ="")),
             get(paste("nls_221.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_221.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_221.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_221.", Mod.Sel1, sep ="")) &
         exists(paste("nls_221.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_221.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_221.", Mod.Sel1, sep ="")),
               get(paste("nls_221.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_221.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_221.", Mod.Sel1, sep ="")) &
           exists(paste("nls_221.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_221.", Mod.Sel1, sep ="")),
                 get(paste("nls_221.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_221.", Mod.Sel1, sep ="")) &
              exists(paste("nls_221.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_221.", Mod.Sel1, sep ="")),
                    get(paste("nls_221.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_221.", Mod.Sel1, sep ="")) &
                exists(paste("nls_221.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_221.", Mod.Sel1, sep ="")),
                      get(paste("nls_221.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_221 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_221.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_221.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_221.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_221.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_221.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_221.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_221.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_221.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_221)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_221[!is.na(AIC2_221$AIC) & AIC2_221$AIC == min(AIC2_221$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.G[Best_mods.G$Code == "221",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_221.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_221.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df2[nls.param.df2$Code == "221",]$ge <- coefs["ge"]
nls.param.df2[nls.param.df2$Code == "221",]$phi <- coefs["phi"]
nls.param.df2[nls.param.df2$Code == "221",]$alpha <- coefs["alpha"]
nls.param.df2[nls.param.df2$Code == "221",]$A <- coefs["A"]
nls.param.df2[nls.param.df2$Code == "221",]$k <- coefs["k"]

nls.param.df2[nls.param.df2$Code == "221",]$ge.2.5 <- intervals_low["ge"]
nls.param.df2[nls.param.df2$Code == "221",]$phi.2.5 <- intervals_low["phi"]
nls.param.df2[nls.param.df2$Code == "221",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df2[nls.param.df2$Code == "221",]$A.2.5 <- intervals_low["A"]
nls.param.df2[nls.param.df2$Code == "221",]$k.2.5 <- intervals_low["k"]

nls.param.df2[nls.param.df2$Code == "221",]$ge.97.5 <- intervals_high["ge"]
nls.param.df2[nls.param.df2$Code == "221",]$phi.97.5 <- intervals_high["phi"]
nls.param.df2[nls.param.df2$Code == "221",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df2[nls.param.df2$Code == "221",]$A.97.5 <- intervals_high["A"]
nls.param.df2[nls.param.df2$Code == "221",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_221.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_221.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_221.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_221.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals

```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_221 <- nlsResiduals(
  get(paste("nls_221.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_221)

## test residuals
if(length(G_221$pltID) < 5001) {test.nlsResiduals(resid_221)}

}  else {print("cannot plot residuals")}
```

## predict and plot

```{r, message = FALSE, cache=T}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

`221_pred2` <- predict(get(paste("nls_221.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME_avg"= rep(mean(G_221$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME_avg"= rep(mean(G_221$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "DeltaPDSI"= rep(mean(G_221$DeltaPDSI, na.rm =T), 1501))
                      } else if (Mod.Sel1 == 3){
                        data.frame("MEASTIME_avg"= rep(mean(G_221$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "B_L_prop"= rep(mean(G_221$B_L_prop, na.rm =T), 1501), 
                                   "DeltaPDSI"= rep(mean(G_221$DeltaPDSI, na.rm =T), 1501))
                      } )

## predicted interval data.frame
`221_pred_df` <- data.frame("B_plt_t1_MgHa" = seq(0,1500,by =1), fitted=`221_pred2`)

## PLOTTING 2
gg.221.2 <- ggplot() +
             geom_jitter(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_221, 
                         alpha = 0.5, color = "#00000080", shape = "+") +
             ## dark ponts = "#1E88E580"
             geom_hline(yintercept =0, lty =3) +
            
             stat_summary_bin(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_221, 
                              fun.data = function(x) {
                                res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                                names(res) <- c("ymin","y","ymax")
                                res}, 
                              col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_221))), breaks = cutvec_221) +         
    
             # geom_ribbon(aes(x = B_plt_t1_MgHa, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
             #             data = 221_pred_df, color="#FF000080", fill ="#FF000080", alpha = 0.25, lty =3) +
             geom_line(aes(x = B_plt_t1_MgHa, y = fitted), data = `221_pred_df`, color="#FF000080", alpha = 0.5, lwd = 2) + 
             ## red = "#D6272880" 
    
             labs(x = expression("biomass (Mg ha"^-1*")"), 
                 y = expression("biomass growth (Mg ha"^-1*" yr"^-1*")")) + 
             ggtitle("221 - Eastern Broadleaf Forest") +
             theme_classic() + theme(axis.text.x=element_text(angle=90,hjust=1)) + 
             scale_x_continuous(limits = c(0, tail(cutvec_221,1)*1.05), expand =c(0,0))  +
             coord_cartesian(ylim=c(-2, 10))
 
             #ylim(c(min(221_pred_df$`Prop.2.5%`)-0.25, max(221_pred_df$`Prop.97.5%`)+0.25))
             #ylim(c(-2,8))
            
gg.221.2

}  else {print("cannot plot data with prediction")}
```

## plotting 2

```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_221 <-data.frame(
  bin = as.factor(levels(cut(G_221$B_plt_t1_MgHa, cutvec_221))),
  data.mean = tapply(G_221$G_obs_TreeInc_MgHaYr, cut(G_221$B_plt_t1_MgHa, cutvec_221), 
                     mean, na.rm =T), 
  data.CI.high =  tapply(G_221$G_obs_TreeInc_MgHaYr, cut(G_221$B_plt_t1_MgHa, cutvec_221), 
                    high.CI), 
  data.CI.low = tapply(G_221$G_obs_TreeInc_MgHaYr, cut(G_221$B_plt_t1_MgHa, cutvec_221),
                    low.CI), 
  pred.mean = `221_pred_df`[`221_pred_df`$B_plt_t1_MgHa %in% bin_mids_221,]$fitted) 


### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_221 <-  DM_compare_221 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_221$bin)[gtools::mixedorder(levels(DM_compare_221$bin))]))
                                                                                                        
## ggplot
gg.221.3 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_221) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_221))), 
                              labels = levels(DM_compare_221$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1,  alpha = 0.5) +         
           labs(x = expression("calculated G (Mg ha"^-1*" yr"^-1*")"), 
                y = expression("nls predicted G (Mg ha"^-1*" yr"^-1*")")) +
           ggtitle("221 - Eastern Broadleaf Forest") +         
           theme_classic() + 
            theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.221.3

}
```

# 222 - Midwest Broadleaf Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_222 <- round(quantile(G_222$B_plt_t1_MgHa, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_222)))){
  cutvec_222 <- round(quantile(G_222$B_plt_t1_MgHa, seq(0,1, length.out = 11)))
}

bin_mids_222 <- unname(round(cutvec_222[-length(cutvec_222)] + diff(cutvec_222)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_222$Plt_B_bin <-  cut(G_222$B_plt_t1_MgHa, cutvec_222)
## get bin means
G_bin_means <- tapply(G_222$G_obs_TreeInc_MgHaYr, cut(G_222$B_plt_t1_MgHa, cutvec_222), mean)

## make column weights.1
G_222$nls_weights <- as.vector(1/G_bin_means[match(G_222$Plt_B_bin, names(G_bin_means))])

}
```

## model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_222.1 <- nls(fg_1, data = G_222, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_222$nls_weights), 
 )

## phi
try(
  nls_222.2 <- nls(fg_2, data=G_222, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_222$nls_weights), 
 )

# phi/alpha
try(
  nls_222.3 <- nls(fg_3 , data = G_222, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_222$nls_weights), 
 )

## test
if(exists("nls_222.1") & exists("nls_222.2") & exists("nls_222.3")){
  print(anova(nls_222.1, nls_222.2, nls_222.3))
} else if(exists("nls_222.2") & exists("nls_222.3")){
  print(anova(nls_222.2, nls_222.3))
} else if(exists("nls_222.1") & exists("nls_222.2")){
  print(anova(nls_222.1, nls_222.2))
}
 
## AIC comparison
AIC1_222 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_222.1"), AIC(get("nls_222.1")), NA),
            ifelse(exists("nls_222.2"), AIC(get("nls_222.2")), NA),
            ifelse(exists("nls_222.3"), AIC(get("nls_222.3")), NA)
            ))

print(AIC1_222) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_222[!is.na(AIC1_222$AIC) & AIC1_222$AIC == min(AIC1_222$AIC, na.rm = T),]$model

try(summary(get(paste("nls_222.",  Mod.Sel1, sep =""))) ) #model summary

}
```
### summary 
* simple model: `r ifelse(exists("nls_222.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_222.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_222.3"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_222.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_222.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_222.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_222.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_222.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_222.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "a", sep ="")), 
          data = G_222,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_222$nls_weights))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_222.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "b", sep ="")), 
          data = G_222,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_222$nls_weights)) 
 )

## c-model: with s and p parameters
try(
  assign(
    paste("nls_222.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "c", sep ="")), 
          data = G_222,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5, p=0.1)}, 
          weights = G_222$nls_weights))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_222.", Mod.Sel1, sep ="")) &
     exists(paste("nls_222.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_222.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_222.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_222.", Mod.Sel1, sep ="")),
             get(paste("nls_222.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_222.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_222.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_222.", Mod.Sel1, sep ="")) &
         exists(paste("nls_222.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_222.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_222.", Mod.Sel1, sep ="")),
               get(paste("nls_222.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_222.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_222.", Mod.Sel1, sep ="")) &
           exists(paste("nls_222.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_222.", Mod.Sel1, sep ="")),
                 get(paste("nls_222.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_222.", Mod.Sel1, sep ="")) &
              exists(paste("nls_222.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_222.", Mod.Sel1, sep ="")),
                    get(paste("nls_222.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_222.", Mod.Sel1, sep ="")) &
                exists(paste("nls_222.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_222.", Mod.Sel1, sep ="")),
                      get(paste("nls_222.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_222 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_222.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_222.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_222.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_222.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_222.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_222.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_222.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_222.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_222)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_222[!is.na(AIC2_222$AIC) & AIC2_222$AIC == min(AIC2_222$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.G[Best_mods.G$Code == "222",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_222.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_222.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df2[nls.param.df2$Code == "222",]$ge <- coefs["ge"]
nls.param.df2[nls.param.df2$Code == "222",]$phi <- coefs["phi"]
nls.param.df2[nls.param.df2$Code == "222",]$alpha <- coefs["alpha"]
nls.param.df2[nls.param.df2$Code == "222",]$A <- coefs["A"]
nls.param.df2[nls.param.df2$Code == "222",]$k <- coefs["k"]

nls.param.df2[nls.param.df2$Code == "222",]$ge.2.5 <- intervals_low["ge"]
nls.param.df2[nls.param.df2$Code == "222",]$phi.2.5 <- intervals_low["phi"]
nls.param.df2[nls.param.df2$Code == "222",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df2[nls.param.df2$Code == "222",]$A.2.5 <- intervals_low["A"]
nls.param.df2[nls.param.df2$Code == "222",]$k.2.5 <- intervals_low["k"]

nls.param.df2[nls.param.df2$Code == "222",]$ge.97.5 <- intervals_high["ge"]
nls.param.df2[nls.param.df2$Code == "222",]$phi.97.5 <- intervals_high["phi"]
nls.param.df2[nls.param.df2$Code == "222",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df2[nls.param.df2$Code == "222",]$A.97.5 <- intervals_high["A"]
nls.param.df2[nls.param.df2$Code == "222",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_222.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_222.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_222.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_222.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals

```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_222 <- nlsResiduals(
  get(paste("nls_222.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_222)

## test residuals
if(length(G_222$pltID) < 5001) {test.nlsResiduals(resid_222)}

}  else {print("cannot plot residuals")}
```

## predict and plot

```{r, message = FALSE, cache=T}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

`222_pred2` <- predict(get(paste("nls_222.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME_avg"= rep(mean(G_222$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME_avg"= rep(mean(G_222$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "DeltaPDSI"= rep(mean(G_222$DeltaPDSI, na.rm =T), 1501))
                      } else if (Mod.Sel1 == 3){
                        data.frame("MEASTIME_avg"= rep(mean(G_222$MEASTIME_avg), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "B_L_prop"= rep(mean(G_222$B_L_prop, na.rm =T), 1501), 
                                   "DeltaPDSI"= rep(mean(G_222$DeltaPDSI, na.rm =T), 1501))
                      } )

## predicted interval data.frame
`222_pred_df` <- data.frame("B_plt_t1_MgHa" = seq(0,1500,by =1), fitted=`222_pred2`)

## PLOTTING 2
gg.222.2 <- ggplot() +
             geom_jitter(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_222, 
                         alpha = 0.5, color = "#00000080", shape = "+") +
             ## dark ponts = "#1E88E580"
             geom_hline(yintercept =0, lty =3) +
            
             stat_summary_bin(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_222, 
                              fun.data = function(x) {
                                res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                                names(res) <- c("ymin","y","ymax")
                                res}, 
                              col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_222))), breaks = cutvec_222) +         
    
             # geom_ribbon(aes(x = B_plt_t1_MgHa, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
             #             data = 222_pred_df, color="#FF000080", fill ="#FF000080", alpha = 0.25, lty =3) +
             geom_line(aes(x = B_plt_t1_MgHa, y = fitted), data = `222_pred_df`, color="#FF000080", alpha = 0.5, lwd = 2) + 
             ## red = "#D6272880" 
    
             labs(x = expression("biomass (Mg ha"^-1*")"), 
                 y = expression("biomass growth (Mg ha"^-1*" yr"^-1*")")) + 
             ggtitle("222 - Midwest Broadleaf Forest") +
             theme_classic() + theme(axis.text.x=element_text(angle=90,hjust=1)) + 
             scale_x_continuous(limits = c(0, tail(cutvec_222,1)*1.05), expand =c(0,0)) +
             coord_cartesian(ylim=c(-2, 10))
  
             #ylim(c(min(222_pred_df$`Prop.2.5%`)-0.25, max(222_pred_df$`Prop.97.5%`)+0.25))
             #ylim(c(-2,8))
            
gg.222.2

}  else {print("cannot plot data with prediction")}
```

## plotting 2

```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_222 <-data.frame(
  bin = as.factor(levels(cut(G_222$B_plt_t1_MgHa, cutvec_222))),
  data.mean = tapply(G_222$G_obs_TreeInc_MgHaYr, cut(G_222$B_plt_t1_MgHa, cutvec_222), 
                     mean), 
  data.CI.high =  tapply(G_222$G_obs_TreeInc_MgHaYr, cut(G_222$B_plt_t1_MgHa, cutvec_222), 
                    high.CI), 
  data.CI.low = tapply(G_222$G_obs_TreeInc_MgHaYr, cut(G_222$B_plt_t1_MgHa, cutvec_222),
                    low.CI), 
  pred.mean = `222_pred_df`[`222_pred_df`$B_plt_t1_MgHa %in% bin_mids_222,]$fitted) 


### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_222 <-  DM_compare_222 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_222$bin)[gtools::mixedorder(levels(DM_compare_222$bin))]))
                                                                                                        
## ggplot
gg.222.3 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_222) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_222))), 
                              labels = levels(DM_compare_222$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1,  alpha = 0.5) +         
           labs(x = expression("calculated G (Mg ha"^-1*" yr"^-1*")"), 
                y = expression("nls predicted G (Mg ha"^-1*" yr"^-1*")")) +
           ggtitle("222 - Midwest Broadleaf Forest") +         
           theme_classic() + 
            theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.222.3

}
```

# 223 - Central Interior Broadleaf Forest

```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_223 <- round(quantile(G_223$B_plt_t1_MgHa, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_223)))){
  cutvec_223 <- round(quantile(G_223$B_plt_t1_MgHa, seq(0,1, length.out = 11)))
}

bin_mids_223 <- unname(round(cutvec_223[-length(cutvec_223)] + diff(cutvec_223)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_223$Plt_B_bin <-  cut(G_223$B_plt_t1_MgHa, cutvec_223)
## get bin means
G_bin_means <- tapply(G_223$G_obs_TreeInc_MgHaYr, cut(G_223$B_plt_t1_MgHa, cutvec_223), mean)

## make column weights.1
G_223$nls_weights <- as.vector(1/G_bin_means[match(G_223$Plt_B_bin, names(G_bin_means))])

}
```

## model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_223.1 <- nls(fg_1, data = G_223, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_223$nls_weights), 
 )

## phi
try(
  nls_223.2 <- nls(fg_2, data=G_223, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_223$nls_weights), 
 )

# phi/alpha
try(
  nls_223.3 <- nls(fg_3 , data = G_223, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_223$nls_weights), 
 )

## test
if(exists("nls_223.1") & exists("nls_223.2") & exists("nls_223.3")){
  print(anova(nls_223.1, nls_223.2, nls_223.3))
} else if(exists("nls_223.2") & exists("nls_223.3")){
  print(anova(nls_223.2, nls_223.3))
} else if(exists("nls_223.1") & exists("nls_223.2")){
  print(anova(nls_223.1, nls_223.2))
}
 
## AIC comparison
AIC1_223 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_223.1"), AIC(get("nls_223.1")), NA),
            ifelse(exists("nls_223.2"), AIC(get("nls_223.2")), NA),
            ifelse(exists("nls_223.3"), AIC(get("nls_223.3")), NA)
            ))

print(AIC1_223) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_223[!is.na(AIC1_223$AIC) & AIC1_223$AIC == min(AIC1_223$AIC, na.rm = T),]$model

try(summary(get(paste("nls_223.",  Mod.Sel1, sep =""))) ) #model summary

}
```
### summary 
* simple model: `r ifelse(exists("nls_223.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_223.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_223.3"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_223.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_223.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_223.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_223.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_223.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_223.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "a", sep ="")), 
          data = G_223,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_223$nls_weights))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_223.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "b", sep ="")), 
          data = G_223,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_223$nls_weights)) 
 )

## c-model: with s and p parameters
try(
  assign(
    paste("nls_223.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "c", sep ="")), 
          data = G_223,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5, p=0.1)},
          weights = G_223$nls_weights))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_223.", Mod.Sel1, sep ="")) &
     exists(paste("nls_223.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_223.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_223.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_223.", Mod.Sel1, sep ="")),
             get(paste("nls_223.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_223.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_223.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_223.", Mod.Sel1, sep ="")) &
         exists(paste("nls_223.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_223.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_223.", Mod.Sel1, sep ="")),
               get(paste("nls_223.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_223.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_223.", Mod.Sel1, sep ="")) &
           exists(paste("nls_223.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_223.", Mod.Sel1, sep ="")),
                 get(paste("nls_223.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_223.", Mod.Sel1, sep ="")) &
              exists(paste("nls_223.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_223.", Mod.Sel1, sep ="")),
                    get(paste("nls_223.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_223.", Mod.Sel1, sep ="")) &
                exists(paste("nls_223.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_223.", Mod.Sel1, sep ="")),
                      get(paste("nls_223.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_223 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_223.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_223.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_223.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_223.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_223.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_223.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_223.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_223.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_223)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_223[!is.na(AIC2_223$AIC) & AIC2_223$AIC == min(AIC2_223$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.G[Best_mods.G$Code == "223",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_223.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_223.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df2[nls.param.df2$Code == "223",]$ge <- coefs["ge"]
nls.param.df2[nls.param.df2$Code == "223",]$phi <- coefs["phi"]
nls.param.df2[nls.param.df2$Code == "223",]$alpha <- coefs["alpha"]
nls.param.df2[nls.param.df2$Code == "223",]$A <- coefs["A"]
nls.param.df2[nls.param.df2$Code == "223",]$k <- coefs["k"]

nls.param.df2[nls.param.df2$Code == "223",]$ge.2.5 <- intervals_low["ge"]
nls.param.df2[nls.param.df2$Code == "223",]$phi.2.5 <- intervals_low["phi"]
nls.param.df2[nls.param.df2$Code == "223",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df2[nls.param.df2$Code == "223",]$A.2.5 <- intervals_low["A"]
nls.param.df2[nls.param.df2$Code == "223",]$k.2.5 <- intervals_low["k"]

nls.param.df2[nls.param.df2$Code == "223",]$ge.97.5 <- intervals_high["ge"]
nls.param.df2[nls.param.df2$Code == "223",]$phi.97.5 <- intervals_high["phi"]
nls.param.df2[nls.param.df2$Code == "223",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df2[nls.param.df2$Code == "223",]$A.97.5 <- intervals_high["A"]
nls.param.df2[nls.param.df2$Code == "223",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_223.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_223.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_223.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_223.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals

```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_223 <- nlsResiduals(
  get(paste("nls_223.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_223)

## test residuals
if(length(G_223$pltID) < 5001) {test.nlsResiduals(resid_223)}

}  else {print("cannot plot residuals")}
```

## predict and plot

```{r, message = FALSE, cache=T}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

`223_pred2` <- predict(get(paste("nls_223.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME_avg"= rep(mean(G_223$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME_avg"= rep(mean(G_223$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "DeltaPDSI"= rep(mean(G_223$DeltaPDSI, na.rm =T), 1501))
                      } else if (Mod.Sel1 == 3){
                        data.frame("MEASTIME_avg"= rep(mean(G_223$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "B_L_prop"= rep(mean(G_223$B_L_prop, na.rm =T), 1501), 
                                   "DeltaPDSI"= rep(mean(G_223$DeltaPDSI, na.rm =T), 1501))
                      } )

## predicted interval data.frame
`223_pred_df` <- data.frame("B_plt_t1_MgHa" = seq(0,1500,by =1), fitted=`223_pred2`)

## PLOTTING 2
gg.223.2 <- ggplot() +
             geom_jitter(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_223, 
                         alpha = 0.5, color = "#00000080", shape = "+") +
             ## dark ponts = "#1E88E580"
             geom_hline(yintercept =0, lty =3) +
            
             stat_summary_bin(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_223, 
                              fun.data = function(x) {
                                res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                                names(res) <- c("ymin","y","ymax")
                                res}, 
                              col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_223))), breaks = cutvec_223) +         
    
             # geom_ribbon(aes(x = B_plt_t1_MgHa, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
             #             data = 223_pred_df, color="#FF000080", fill ="#FF000080", alpha = 0.25, lty =3) +
             geom_line(aes(x = B_plt_t1_MgHa, y = fitted), data = `223_pred_df`, color="#FF000080", alpha = 0.5, lwd = 2) + 
             ## red = "#D6272880" 
    
             labs(x = expression("biomass (Mg ha"^-1*")"), 
                 y = expression("biomass growth (Mg ha"^-1*" yr"^-1*")")) + 
             ggtitle("223 - Central Interior Broadleaf Forest") +
             theme_classic() + theme(axis.text.x=element_text(angle=90,hjust=1)) + 
             scale_x_continuous(limits = c(0, tail(cutvec_223,1)*1.05), expand =c(0,0)) +
             coord_cartesian(ylim=c(-2, 10))

             #ylim(c(min(223_pred_df$`Prop.2.5%`)-0.25, max(223_pred_df$`Prop.97.5%`)+0.25))
             #ylim(c(-2,8))
            
gg.223.2

}  else {print("cannot plot data with prediction")}
```

## plotting 2

```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_223 <-data.frame(
  bin = as.factor(levels(cut(G_223$B_plt_t1_MgHa, cutvec_223))),
  data.mean = tapply(G_223$G_obs_TreeInc_MgHaYr, cut(G_223$B_plt_t1_MgHa, cutvec_223), 
                     mean), 
  data.CI.high =  tapply(G_223$G_obs_TreeInc_MgHaYr, cut(G_223$B_plt_t1_MgHa, cutvec_223), 
                    high.CI), 
  data.CI.low = tapply(G_223$G_obs_TreeInc_MgHaYr, cut(G_223$B_plt_t1_MgHa, cutvec_223),
                    low.CI), 
  pred.mean = `223_pred_df`[`223_pred_df`$B_plt_t1_MgHa %in% bin_mids_223,]$fitted) 


### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_223 <-  DM_compare_223 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_223$bin)[gtools::mixedorder(levels(DM_compare_223$bin))]))
                                                                                                        
## ggplot
gg.223.3 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_223) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_223))), 
                              labels = levels(DM_compare_223$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1,  alpha = 0.5) +         
           labs(x = expression("calculated G (Mg ha"^-1*" yr"^-1*")"), 
                y = expression("nls predicted G (Mg ha"^-1*" yr"^-1*")")) +
           ggtitle("223 - Central Interior Broadleaf Forest") +         
           theme_classic() + 
            theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.223.3

}
```

# 231 - Southeastern Mixed Forest

```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_231 <- round(quantile(G_231$B_plt_t1_MgHa, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_231)))){
  cutvec_231 <- round(quantile(G_231$B_plt_t1_MgHa, seq(0,1, length.out = 11)))
}

bin_mids_231 <- unname(round(cutvec_231[-length(cutvec_231)] + diff(cutvec_231)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_231$Plt_B_bin <-  cut(G_231$B_plt_t1_MgHa, cutvec_231)
## get bin means
G_bin_means <- tapply(G_231$G_obs_TreeInc_MgHaYr, cut(G_231$B_plt_t1_MgHa, cutvec_231), mean)

## make column weights.1
G_231$nls_weights <- as.vector(1/G_bin_means[match(G_231$Plt_B_bin, names(G_bin_means))])

}
```

## model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_231.1 <- nls(fg_1, data = G_231, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_231$nls_weights), 
 )

## phi
try(
  nls_231.2 <- nls(fg_2, data=G_231, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_231$nls_weights), 
 )

# phi/alpha
try(
  nls_231.3 <- nls(fg_3 , data = G_231, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_231$nls_weights), 
 )

## test
if(exists("nls_231.1") & exists("nls_231.2") & exists("nls_231.3")){
  print(anova(nls_231.1, nls_231.2, nls_231.3))
} else if(exists("nls_231.2") & exists("nls_231.3")){
  print(anova(nls_231.2, nls_231.3))
} else if(exists("nls_231.1") & exists("nls_231.2")){
  print(anova(nls_231.1, nls_231.2))
}
 
## AIC comparison
AIC1_231 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_231.1"), AIC(get("nls_231.1")), NA),
            ifelse(exists("nls_231.2"), AIC(get("nls_231.2")), NA),
            ifelse(exists("nls_231.3"), AIC(get("nls_231.3")), NA)
            ))

print(AIC1_231) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_231[!is.na(AIC1_231$AIC) & AIC1_231$AIC == min(AIC1_231$AIC, na.rm = T),]$model

try(summary(get(paste("nls_231.",  Mod.Sel1, sep =""))) ) #model summary

}
```
### summary 
* simple model: `r ifelse(exists("nls_231.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_231.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_231.3"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_231.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_231.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_231.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_231.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_231.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_231.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "a", sep ="")), 
          data = G_231,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_231$nls_weights))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_231.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "b", sep ="")), 
          data = G_231,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_231$nls_weights)) 
 )

## c-model: with s and p parameters
try(
  assign(
    paste("nls_231.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "c", sep ="")), 
          data = G_231,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5, p=0.1)},
          weights = G_231$nls_weights))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_231.", Mod.Sel1, sep ="")) &
     exists(paste("nls_231.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_231.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_231.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_231.", Mod.Sel1, sep ="")),
             get(paste("nls_231.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_231.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_231.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_231.", Mod.Sel1, sep ="")) &
         exists(paste("nls_231.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_231.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_231.", Mod.Sel1, sep ="")),
               get(paste("nls_231.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_231.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_231.", Mod.Sel1, sep ="")) &
           exists(paste("nls_231.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_231.", Mod.Sel1, sep ="")),
                 get(paste("nls_231.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_231.", Mod.Sel1, sep ="")) &
              exists(paste("nls_231.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_231.", Mod.Sel1, sep ="")),
                    get(paste("nls_231.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_231.", Mod.Sel1, sep ="")) &
                exists(paste("nls_231.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_231.", Mod.Sel1, sep ="")),
                      get(paste("nls_231.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_231 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_231.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_231.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_231.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_231.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_231.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_231.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_231.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_231.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_231)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_231[!is.na(AIC2_231$AIC) & AIC2_231$AIC == min(AIC2_231$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.G[Best_mods.G$Code == "231",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_231.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_231.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df2[nls.param.df2$Code == "231",]$ge <- coefs["ge"]
nls.param.df2[nls.param.df2$Code == "231",]$phi <- coefs["phi"]
nls.param.df2[nls.param.df2$Code == "231",]$alpha <- coefs["alpha"]
nls.param.df2[nls.param.df2$Code == "231",]$A <- coefs["A"]
nls.param.df2[nls.param.df2$Code == "231",]$k <- coefs["k"]

nls.param.df2[nls.param.df2$Code == "231",]$ge.2.5 <- intervals_low["ge"]
nls.param.df2[nls.param.df2$Code == "231",]$phi.2.5 <- intervals_low["phi"]
nls.param.df2[nls.param.df2$Code == "231",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df2[nls.param.df2$Code == "231",]$A.2.5 <- intervals_low["A"]
nls.param.df2[nls.param.df2$Code == "231",]$k.2.5 <- intervals_low["k"]

nls.param.df2[nls.param.df2$Code == "231",]$ge.97.5 <- intervals_high["ge"]
nls.param.df2[nls.param.df2$Code == "231",]$phi.97.5 <- intervals_high["phi"]
nls.param.df2[nls.param.df2$Code == "231",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df2[nls.param.df2$Code == "231",]$A.97.5 <- intervals_high["A"]
nls.param.df2[nls.param.df2$Code == "231",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_231.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_231.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_231.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_231.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals

```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_231 <- nlsResiduals(
  get(paste("nls_231.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_231)

## test residuals
if(length(G_231$pltID) < 5001) {test.nlsResiduals(resid_231)}

}  else {print("cannot plot residuals")}
```

## predict and plot

```{r, message = FALSE, cache=T}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

`231_pred2` <- predict(get(paste("nls_231.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME_avg"= rep(mean(G_231$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME_avg"= rep(mean(G_231$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "DeltaPDSI"= rep(mean(G_231$DeltaPDSI, na.rm =T), 1501))
                      } else if (Mod.Sel1 == 3){
                        data.frame("MEASTIME_avg"= rep(mean(G_231$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "B_L_prop"= rep(mean(G_231$B_L_prop, na.rm =T), 1501), 
                                   "DeltaPDSI"= rep(mean(G_231$DeltaPDSI, na.rm =T), 1501))
                      } )

## predicted interval data.frame
`231_pred_df` <- data.frame("B_plt_t1_MgHa" = seq(0,1500,by =1), fitted=`231_pred2`)

## PLOTTING 2
gg.231.2 <- ggplot() +
             geom_jitter(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_231, 
                         alpha = 0.5, color = "#00000080", shape = "+") +
             ## dark ponts = "#1E88E580"
             geom_hline(yintercept =0, lty =3) +
            
             stat_summary_bin(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_231, 
                              fun.data = function(x) {
                                res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                                names(res) <- c("ymin","y","ymax")
                                res}, 
                              col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_231)+1)), breaks = cutvec_231) +         
    
             # geom_ribbon(aes(x = B_plt_t1_MgHa, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
             #             data = 231_pred_df, color="#FF000080", fill ="#FF000080", alpha = 0.25, lty =3) +
             geom_line(aes(x = B_plt_t1_MgHa, y = fitted), data = `231_pred_df`, color="#FF000080", alpha = 0.5, lwd = 2) + 
             ## red = "#D6272880" 
    
             labs(x = expression("biomass (Mg ha"^-1*")"), 
                 y = expression("biomass growth (Mg ha"^-1*" yr"^-1*")")) + 
             ggtitle("231 - Southeastern Mixed Forest") +
             theme_classic() + theme(axis.text.x=element_text(angle=90,hjust=1)) + 
             scale_x_continuous(limits = c(0, tail(cutvec_231,1)*1.05), expand =c(0,0)) +
             coord_cartesian(ylim=c(-2, 10))

             #ylim(c(min(231_pred_df$`Prop.2.5%`)-0.25, max(231_pred_df$`Prop.97.5%`)+0.25))
             #ylim(c(-2,8))
            
gg.231.2

}  else {print("cannot plot data with prediction")}
```

## plotting 2

```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_231 <-data.frame(
  bin = as.factor(levels(cut(G_231$B_plt_t1_MgHa, cutvec_231))),
  data.mean = tapply(G_231$G_obs_TreeInc_MgHaYr, cut(G_231$B_plt_t1_MgHa, cutvec_231), 
                     mean), 
  data.CI.high =  tapply(G_231$G_obs_TreeInc_MgHaYr, cut(G_231$B_plt_t1_MgHa, cutvec_231), 
                    high.CI), 
  data.CI.low = tapply(G_231$G_obs_TreeInc_MgHaYr, cut(G_231$B_plt_t1_MgHa, cutvec_231),
                    low.CI), 
  pred.mean = `231_pred_df`[`231_pred_df`$B_plt_t1_MgHa %in% bin_mids_231,]$fitted) 


### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_231 <-  DM_compare_231 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_231$bin)[gtools::mixedorder(levels(DM_compare_231$bin))]))
                                                                                                        
## ggplot
gg.231.3 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_231) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_231))), 
                              labels = levels(DM_compare_231$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1,  alpha = 0.5) +         
           labs(x = expression("calculated G (Mg ha"^-1*" yr"^-1*")"), 
                y = expression("nls predicted G (Mg ha"^-1*" yr"^-1*")")) +
           ggtitle("231 - Southeastern Mixed Forest") +         
           theme_classic() + 
            theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.231.3

}
```

# 232 - Outer Coastal Plain Mixed Forest
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_232 <- round(quantile(G_232$B_plt_t1_MgHa, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_232)))){
  cutvec_232 <- round(quantile(G_232$B_plt_t1_MgHa, seq(0,1, length.out = 11)))
}

bin_mids_232 <- unname(round(cutvec_232[-length(cutvec_232)] + diff(cutvec_232)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_232$Plt_B_bin <-  cut(G_232$B_plt_t1_MgHa, cutvec_232)
## get bin means
G_bin_means <- tapply(G_232$G_obs_TreeInc_MgHaYr, cut(G_232$B_plt_t1_MgHa, cutvec_232), mean)

## make column weights.1
G_232$nls_weights <- as.vector(1/G_bin_means[match(G_232$Plt_B_bin, names(G_bin_means))])

}
```

## model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_232.1 <- nls(fg_1, data = G_232, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_232$nls_weights), 
 )

## phi
try(
  nls_232.2 <- nls(fg_2, data=G_232, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_232$nls_weights), 
 )

# phi/alpha
try(
  nls_232.3 <- nls(fg_3 , data = G_232, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_232$nls_weights), 
 )

## test
if(exists("nls_232.1") & exists("nls_232.2") & exists("nls_232.3")){
  print(anova(nls_232.1, nls_232.2, nls_232.3))
} else if(exists("nls_232.2") & exists("nls_232.3")){
  print(anova(nls_232.2, nls_232.3))
} else if(exists("nls_232.1") & exists("nls_232.2")){
  print(anova(nls_232.1, nls_232.2))
}
 
## AIC comparison
AIC1_232 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_232.1"), AIC(get("nls_232.1")), NA),
            ifelse(exists("nls_232.2"), AIC(get("nls_232.2")), NA),
            ifelse(exists("nls_232.3"), AIC(get("nls_232.3")), NA)
            ))

print(AIC1_232) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_232[!is.na(AIC1_232$AIC) & AIC1_232$AIC == min(AIC1_232$AIC, na.rm = T),]$model

try(summary(get(paste("nls_232.",  Mod.Sel1, sep =""))) ) #model summary

}
```
### summary 
* simple model: `r ifelse(exists("nls_232.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_232.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_232.3"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_232.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_232.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_232.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_232.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_232.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_232.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "a", sep ="")), 
          data = G_232,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_232$nls_weights))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_232.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "b", sep ="")), 
          data = G_232,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_232$nls_weights)) 
 )

## c-model: with s and p parameters
try(
  assign(
    paste("nls_232.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "c", sep ="")), 
          data = G_232,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5, p=0.1)},
          weights = G_232$nls_weights))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_232.", Mod.Sel1, sep ="")) &
     exists(paste("nls_232.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_232.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_232.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_232.", Mod.Sel1, sep ="")),
             get(paste("nls_232.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_232.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_232.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_232.", Mod.Sel1, sep ="")) &
         exists(paste("nls_232.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_232.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_232.", Mod.Sel1, sep ="")),
               get(paste("nls_232.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_232.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_232.", Mod.Sel1, sep ="")) &
           exists(paste("nls_232.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_232.", Mod.Sel1, sep ="")),
                 get(paste("nls_232.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_232.", Mod.Sel1, sep ="")) &
              exists(paste("nls_232.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_232.", Mod.Sel1, sep ="")),
                    get(paste("nls_232.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_232.", Mod.Sel1, sep ="")) &
                exists(paste("nls_232.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_232.", Mod.Sel1, sep ="")),
                      get(paste("nls_232.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_232 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_232.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_232.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_232.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_232.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_232.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_232.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_232.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_232.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_232)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_232[!is.na(AIC2_232$AIC) & AIC2_232$AIC == min(AIC2_232$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.G[Best_mods.G$Code == "232",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_232.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_232.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df2[nls.param.df2$Code == "232",]$ge <- coefs["ge"]
nls.param.df2[nls.param.df2$Code == "232",]$phi <- coefs["phi"]
nls.param.df2[nls.param.df2$Code == "232",]$alpha <- coefs["alpha"]
nls.param.df2[nls.param.df2$Code == "232",]$A <- coefs["A"]
nls.param.df2[nls.param.df2$Code == "232",]$k <- coefs["k"]

nls.param.df2[nls.param.df2$Code == "232",]$ge.2.5 <- intervals_low["ge"]
nls.param.df2[nls.param.df2$Code == "232",]$phi.2.5 <- intervals_low["phi"]
nls.param.df2[nls.param.df2$Code == "232",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df2[nls.param.df2$Code == "232",]$A.2.5 <- intervals_low["A"]
nls.param.df2[nls.param.df2$Code == "232",]$k.2.5 <- intervals_low["k"]

nls.param.df2[nls.param.df2$Code == "232",]$ge.97.5 <- intervals_high["ge"]
nls.param.df2[nls.param.df2$Code == "232",]$phi.97.5 <- intervals_high["phi"]
nls.param.df2[nls.param.df2$Code == "232",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df2[nls.param.df2$Code == "232",]$A.97.5 <- intervals_high["A"]
nls.param.df2[nls.param.df2$Code == "232",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_232.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_232.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_232.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_232.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals

```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_232 <- nlsResiduals(
  get(paste("nls_232.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_232)

## test residuals
if(length(G_232$pltID) < 5001) {test.nlsResiduals(resid_232)}

}  else {print("cannot plot residuals")}
```

## predict and plot

```{r, message = FALSE, cache=T}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

`232_pred2` <- predict(get(paste("nls_232.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME_avg"= rep(mean(G_232$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME_avg"= rep(mean(G_232$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "DeltaPDSI"= rep(mean(G_232$DeltaPDSI, na.rm =T), 1501))
                      } else if (Mod.Sel1 == 3){
                        data.frame("MEASTIME_avg"= rep(mean(G_232$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "B_L_prop"= rep(mean(G_232$B_L_prop, na.rm =T), 1501), 
                                   "DeltaPDSI"= rep(mean(G_232$DeltaPDSI, na.rm =T), 1501))
                      } )

## predicted interval data.frame
`232_pred_df` <- data.frame("B_plt_t1_MgHa" = seq(0,1500,by =1), fitted=`232_pred2`)

## PLOTTING 2
gg.232.2 <- ggplot() +
             geom_jitter(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_232, 
                         alpha = 0.5, color = "#00000080", shape = "+") +
             ## dark ponts = "#1E88E580"
             geom_hline(yintercept =0, lty =3) +
            
             stat_summary_bin(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_232, 
                              fun.data = function(x) {
                                res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                                names(res) <- c("ymin","y","ymax")
                                res}, 
                              col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_232)+1)), breaks = cutvec_232) +         
    
             # geom_ribbon(aes(x = B_plt_t1_MgHa, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
             #             data = 232_pred_df, color="#FF000080", fill ="#FF000080", alpha = 0.25, lty =3) +
             geom_line(aes(x = B_plt_t1_MgHa, y = fitted), data = `232_pred_df`, color="#FF000080", alpha = 0.5, lwd = 2) + 
             ## red = "#D6272880" 
    
             labs(x = expression("biomass (Mg ha"^-1*")"), 
                 y = expression("biomass growth (Mg ha"^-1*" yr"^-1*")")) + 
             ggtitle("232 - Outer Coastal Plain Mixed Forest") +
             theme_classic() + theme(axis.text.x=element_text(angle=90,hjust=1)) + 
             scale_x_continuous(limits = c(0, tail(cutvec_232,1)*1.05), expand =c(0,0)) +
             coord_cartesian(ylim=c(-2, 10))

             #ylim(c(min(232_pred_df$`Prop.2.5%`)-0.25, max(232_pred_df$`Prop.97.5%`)+0.25))
             #ylim(c(-2,8))
            
gg.232.2

}  else {print("cannot plot data with prediction")}
```

## plotting 2

```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_232 <-data.frame(
  bin = as.factor(levels(cut(G_232$B_plt_t1_MgHa, cutvec_232))),
  data.mean = tapply(G_232$G_obs_TreeInc_MgHaYr, cut(G_232$B_plt_t1_MgHa, cutvec_232), 
                     mean), 
  data.CI.high =  tapply(G_232$G_obs_TreeInc_MgHaYr, cut(G_232$B_plt_t1_MgHa, cutvec_232), 
                    high.CI), 
  data.CI.low = tapply(G_232$G_obs_TreeInc_MgHaYr, cut(G_232$B_plt_t1_MgHa, cutvec_232),
                    low.CI), 
  pred.mean = `232_pred_df`[`232_pred_df`$B_plt_t1_MgHa %in% bin_mids_232,]$fitted) 


### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_232 <-  DM_compare_232 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_232$bin)[gtools::mixedorder(levels(DM_compare_232$bin))]))
                                                                                                        
## ggplot
gg.232.3 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_232) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_232))), 
                              labels = levels(DM_compare_232$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1,  alpha = 0.5) +         
           labs(x = expression("calculated G (Mg ha"^-1*" yr"^-1*")"), 
                y = expression("nls predicted G (Mg ha"^-1*" yr"^-1*")")) +
           ggtitle("232 - Outer Coastal Plain Mixed Forest") +         
           theme_classic() + 
            theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.232.3

}
```


# 234 - Lower Mississippi Riverine Forest

```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_234 <- round(quantile(G_234$B_plt_t1_MgHa, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_234)))){
  cutvec_234 <- round(quantile(G_234$B_plt_t1_MgHa, seq(0,1, length.out = 11)))
}

bin_mids_234 <- unname(round(cutvec_234[-length(cutvec_234)] + diff(cutvec_234)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_234$Plt_B_bin <-  cut(G_234$B_plt_t1_MgHa, cutvec_234)
## get bin means
G_bin_means <- tapply(G_234$G_obs_TreeInc_MgHaYr, cut(G_234$B_plt_t1_MgHa, cutvec_234), mean)

## make column weights.1
G_234$nls_weights <- as.vector(1/G_bin_means[match(G_234$Plt_B_bin, names(G_bin_means))])

}
```


## model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_234.1 <- nls(fg_1, data = G_234, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_234$nls_weights), 
 )

## phi
try(
  nls_234.2 <- nls(fg_2, data=G_234, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_234$nls_weights), 
 )

# phi/alpha
try(
  nls_234.3 <- nls(fg_3 , data = G_234, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_234$nls_weights), 
 )

## test
if(exists("nls_234.1") & exists("nls_234.2") & exists("nls_234.3")){
  print(anova(nls_234.1, nls_234.2, nls_234.3))
} else if(exists("nls_234.2") & exists("nls_234.3")){
  print(anova(nls_234.2, nls_234.3))
} else if(exists("nls_234.1") & exists("nls_234.2")){
  print(anova(nls_234.1, nls_234.2))
}
 
## AIC comparison
AIC1_234 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_234.1"), AIC(get("nls_234.1")), NA),
            ifelse(exists("nls_234.2"), AIC(get("nls_234.2")), NA),
            ifelse(exists("nls_234.3"), AIC(get("nls_234.3")), NA)
            ))

print(AIC1_234) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_234[!is.na(AIC1_234$AIC) & AIC1_234$AIC == min(AIC1_234$AIC, na.rm = T),]$model

try(summary(get(paste("nls_234.",  Mod.Sel1, sep =""))) ) #model summary

}
```
### summary 
* simple model: `r ifelse(exists("nls_234.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_234.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_234.3"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_234.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_234.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_234.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_234.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_234.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_234.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "a", sep ="")), 
          data = G_234,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_234$nls_weights))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_234.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "b", sep ="")), 
          data = G_234,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_234$nls_weights)) 
 )

## c-model: with s and p parameters
try(
  assign(
    paste("nls_234.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "c", sep ="")), 
          data = G_234,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_234$nls_weights))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_234.", Mod.Sel1, sep ="")) &
     exists(paste("nls_234.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_234.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_234.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_234.", Mod.Sel1, sep ="")),
             get(paste("nls_234.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_234.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_234.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_234.", Mod.Sel1, sep ="")) &
         exists(paste("nls_234.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_234.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_234.", Mod.Sel1, sep ="")),
               get(paste("nls_234.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_234.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_234.", Mod.Sel1, sep ="")) &
           exists(paste("nls_234.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_234.", Mod.Sel1, sep ="")),
                 get(paste("nls_234.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_234.", Mod.Sel1, sep ="")) &
              exists(paste("nls_234.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_234.", Mod.Sel1, sep ="")),
                    get(paste("nls_234.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_234.", Mod.Sel1, sep ="")) &
                exists(paste("nls_234.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_234.", Mod.Sel1, sep ="")),
                      get(paste("nls_234.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_234 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_234.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_234.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_234.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_234.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_234.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_234.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_234.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_234.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_234)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_234[!is.na(AIC2_234$AIC) & AIC2_234$AIC == min(AIC2_234$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.G[Best_mods.G$Code == "234",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_234.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_234.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df2[nls.param.df2$Code == "234",]$ge <- coefs["ge"]
nls.param.df2[nls.param.df2$Code == "234",]$phi <- coefs["phi"]
nls.param.df2[nls.param.df2$Code == "234",]$alpha <- coefs["alpha"]
nls.param.df2[nls.param.df2$Code == "234",]$A <- coefs["A"]
nls.param.df2[nls.param.df2$Code == "234",]$k <- coefs["k"]

nls.param.df2[nls.param.df2$Code == "234",]$ge.2.5 <- intervals_low["ge"]
nls.param.df2[nls.param.df2$Code == "234",]$phi.2.5 <- intervals_low["phi"]
nls.param.df2[nls.param.df2$Code == "234",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df2[nls.param.df2$Code == "234",]$A.2.5 <- intervals_low["A"]
nls.param.df2[nls.param.df2$Code == "234",]$k.2.5 <- intervals_low["k"]

nls.param.df2[nls.param.df2$Code == "234",]$ge.97.5 <- intervals_high["ge"]
nls.param.df2[nls.param.df2$Code == "234",]$phi.97.5 <- intervals_high["phi"]
nls.param.df2[nls.param.df2$Code == "234",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df2[nls.param.df2$Code == "234",]$A.97.5 <- intervals_high["A"]
nls.param.df2[nls.param.df2$Code == "234",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_234.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_234.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_234.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_234.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals

```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_234 <- nlsResiduals(
  get(paste("nls_234.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_234)

## test residuals
if(length(G_234$pltID) < 5001) {test.nlsResiduals(resid_234)}

}  else {print("cannot plot residuals")}
```

## predict and plot

```{r, message = FALSE, cache=T}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

`234_pred2` <- predict(get(paste("nls_234.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME_avg"= rep(mean(G_234$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME_avg"= rep(mean(G_234$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "DeltaPDSI"= rep(mean(G_234$DeltaPDSI, na.rm =T), 1501))
                      } else if (Mod.Sel1 == 3){
                        data.frame("MEASTIME_avg"= rep(mean(G_234$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "B_L_prop"= rep(mean(G_234$B_L_prop, na.rm =T), 1501), 
                                   "DeltaPDSI"= rep(mean(G_234$DeltaPDSI, na.rm =T), 1501))
                      } )

## predicted interval data.frame
`234_pred_df` <- data.frame("B_plt_t1_MgHa" = seq(0,1500,by =1), fitted=`234_pred2`)

## PLOTTING 2
gg.234.2 <- ggplot() +
             geom_jitter(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_234, 
                         alpha = 0.5, color = "#00000080", shape = "+") +
             ## dark ponts = "#1E88E580"
             geom_hline(yintercept =0, lty =3) +
            
             stat_summary_bin(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_234, 
                              fun.data = function(x) {
                                res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                                names(res) <- c("ymin","y","ymax")
                                res}, 
                              col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_234)+1)), breaks = cutvec_234) +         
    
             # geom_ribbon(aes(x = B_plt_t1_MgHa, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
             #             data = 234_pred_df, color="#FF000080", fill ="#FF000080", alpha = 0.25, lty =3) +
             geom_line(aes(x = B_plt_t1_MgHa, y = fitted), data = `234_pred_df`, color="#FF000080", alpha = 0.5, lwd = 2) + 
             ## red = "#D6272880" 
    
             labs(x = expression("biomass (Mg ha"^-1*")"), 
                 y = expression("biomass growth (Mg ha"^-1*" yr"^-1*")")) + 
             ggtitle("234 - Lower Mississippi Riverine Forest") +
             theme_classic() + theme(axis.text.x=element_text(angle=90,hjust=1)) + 
             scale_x_continuous(limits = c(0, tail(cutvec_234,1)*1.05), expand =c(0,0)) +
             coord_cartesian(ylim=c(-2, 10))
  
             #ylim(c(min(234_pred_df$`Prop.2.5%`)-0.25, max(234_pred_df$`Prop.97.5%`)+0.25))
             #ylim(c(-2,8))
            
gg.234.2

}  else {print("cannot plot data with prediction")}
```

## plotting 2

```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_234 <-data.frame(
  bin = as.factor(levels(cut(G_234$B_plt_t1_MgHa, cutvec_234))),
  data.mean = tapply(G_234$G_obs_TreeInc_MgHaYr, cut(G_234$B_plt_t1_MgHa, cutvec_234), 
                     mean), 
  data.CI.high =  tapply(G_234$G_obs_TreeInc_MgHaYr, cut(G_234$B_plt_t1_MgHa, cutvec_234), 
                    high.CI), 
  data.CI.low = tapply(G_234$G_obs_TreeInc_MgHaYr, cut(G_234$B_plt_t1_MgHa, cutvec_234),
                    low.CI), 
  pred.mean = `234_pred_df`[`234_pred_df`$B_plt_t1_MgHa %in% bin_mids_234,]$fitted) 


### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_234 <-  DM_compare_234 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_234$bin)[gtools::mixedorder(levels(DM_compare_234$bin))]))
                                                                                                        
## ggplot
gg.234.3 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_234) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_234))), 
                              labels = levels(DM_compare_234$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1,  alpha = 0.5) +         
           labs(x = expression("calculated G (Mg ha"^-1*" yr"^-1*")"), 
                y = expression("nls predicted G (Mg ha"^-1*" yr"^-1*")")) +
           ggtitle("234 - Lower Mississippi Riverine Forest") +         
           theme_classic() + 
            theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.234.3

}
```

# 242 - Pacific Lowland Mixed Forest

```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_242 <- round(quantile(G_242$B_plt_t1_MgHa, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_242)))){
  cutvec_242 <- round(quantile(G_242$B_plt_t1_MgHa, seq(0,1, length.out = 11)))
}

bin_mids_242 <- unname(round(cutvec_242[-length(cutvec_242)] + diff(cutvec_242)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_242$Plt_B_bin <-  cut(G_242$B_plt_t1_MgHa, cutvec_242)
## get bin means
G_bin_means <- tapply(G_242$G_obs_TreeInc_MgHaYr, cut(G_242$B_plt_t1_MgHa, cutvec_242), mean)

## make column weights.1
G_242$nls_weights <- as.vector(1/G_bin_means[match(G_242$Plt_B_bin, names(G_bin_means))])

}
```

## model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_242.1 <- nls(fg_1, data = G_242, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_242$nls_weights), 
 )

## phi
try(
  nls_242.2 <- nls(fg_2, data=G_242, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_242$nls_weights), 
 )

# phi/alpha
try(
  nls_242.3 <- nls(fg_3 , data = G_242, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_242$nls_weights), 
 )

## test
if(exists("nls_242.1") & exists("nls_242.2") & exists("nls_242.3")){
  print(anova(nls_242.1, nls_242.2, nls_242.3))
} else if(exists("nls_242.2") & exists("nls_242.3")){
  print(anova(nls_242.2, nls_242.3))
} else if(exists("nls_242.1") & exists("nls_242.2")){
  print(anova(nls_242.1, nls_242.2))
}
 
## AIC comparison
AIC1_242 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_242.1"), AIC(get("nls_242.1")), NA),
            ifelse(exists("nls_242.2"), AIC(get("nls_242.2")), NA),
            ifelse(exists("nls_242.3"), AIC(get("nls_242.3")), NA)
            ))

print(AIC1_242) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_242[!is.na(AIC1_242$AIC) & AIC1_242$AIC == min(AIC1_242$AIC, na.rm = T),]$model

try(summary(get(paste("nls_242.",  Mod.Sel1, sep =""))) ) #model summary

}
```
### summary 
* simple model: `r ifelse(exists("nls_242.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_242.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_242.3"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_242.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_242.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_242.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_242.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_242.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_242.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "a", sep ="")), 
          data = G_242,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_242$nls_weights))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_242.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "b", sep ="")), 
          data = G_242,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_242$nls_weights)) 
 )

## c-model: with s and p parameters
try(
  assign(
    paste("nls_242.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "c", sep ="")), 
          data = G_242,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5, p=0.1)}, 
          weights = G_242$nls_weights))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_242.", Mod.Sel1, sep ="")) &
     exists(paste("nls_242.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_242.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_242.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_242.", Mod.Sel1, sep ="")),
             get(paste("nls_242.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_242.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_242.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_242.", Mod.Sel1, sep ="")) &
         exists(paste("nls_242.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_242.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_242.", Mod.Sel1, sep ="")),
               get(paste("nls_242.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_242.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_242.", Mod.Sel1, sep ="")) &
           exists(paste("nls_242.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_242.", Mod.Sel1, sep ="")),
                 get(paste("nls_242.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_242.", Mod.Sel1, sep ="")) &
              exists(paste("nls_242.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_242.", Mod.Sel1, sep ="")),
                    get(paste("nls_242.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_242.", Mod.Sel1, sep ="")) &
                exists(paste("nls_242.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_242.", Mod.Sel1, sep ="")),
                      get(paste("nls_242.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_242 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_242.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_242.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_242.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_242.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_242.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_242.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_242.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_242.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_242)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_242[!is.na(AIC2_242$AIC) & AIC2_242$AIC == min(AIC2_242$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.G[Best_mods.G$Code == "242",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_242.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_242.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df2[nls.param.df2$Code == "242",]$ge <- coefs["ge"]
nls.param.df2[nls.param.df2$Code == "242",]$phi <- coefs["phi"]
nls.param.df2[nls.param.df2$Code == "242",]$alpha <- coefs["alpha"]
nls.param.df2[nls.param.df2$Code == "242",]$A <- coefs["A"]
nls.param.df2[nls.param.df2$Code == "242",]$k <- coefs["k"]

nls.param.df2[nls.param.df2$Code == "242",]$ge.2.5 <- intervals_low["ge"]
nls.param.df2[nls.param.df2$Code == "242",]$phi.2.5 <- intervals_low["phi"]
nls.param.df2[nls.param.df2$Code == "242",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df2[nls.param.df2$Code == "242",]$A.2.5 <- intervals_low["A"]
nls.param.df2[nls.param.df2$Code == "242",]$k.2.5 <- intervals_low["k"]

nls.param.df2[nls.param.df2$Code == "242",]$ge.97.5 <- intervals_high["ge"]
nls.param.df2[nls.param.df2$Code == "242",]$phi.97.5 <- intervals_high["phi"]
nls.param.df2[nls.param.df2$Code == "242",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df2[nls.param.df2$Code == "242",]$A.97.5 <- intervals_high["A"]
nls.param.df2[nls.param.df2$Code == "242",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_242.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_242.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_242.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_242.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals

```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_242 <- nlsResiduals(
  get(paste("nls_242.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_242)

## test residuals
if(length(G_242$pltID) < 5001) {test.nlsResiduals(resid_242)}

}  else {print("cannot plot residuals")}
```

## predict and plot

```{r, message = FALSE, cache=T}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

`242_pred2` <- predict(get(paste("nls_242.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME_avg"= rep(mean(G_242$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME_avg"= rep(mean(G_242$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "DeltaPDSI"= rep(mean(G_242$DeltaPDSI, na.rm =T), 1501))
                      } else if (Mod.Sel1 == 3){
                        data.frame("MEASTIME_avg"= rep(mean(G_242$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "B_L_prop"= rep(mean(G_242$B_L_prop, na.rm =T), 1501), 
                                   "DeltaPDSI"= rep(mean(G_242$DeltaPDSI, na.rm =T), 1501))
                      } )

## predicted interval data.frame
`242_pred_df` <- data.frame("B_plt_t1_MgHa" = seq(0,1500,by =1), fitted=`242_pred2`)

## PLOTTING 2
gg.242.2 <- ggplot() +
             geom_jitter(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_242, 
                         alpha = 0.5, color = "#00000080", shape = "+") +
             ## dark ponts = "#1E88E580"
             geom_hline(yintercept =0, lty =3) +
            
             stat_summary_bin(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_242, 
                              fun.data = function(x) {
                                res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                                names(res) <- c("ymin","y","ymax")
                                res}, 
                              col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_242))), breaks = cutvec_242) +         
    
             # geom_ribbon(aes(x = B_plt_t1_MgHa, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
             #             data = 242_pred_df, color="#FF000080", fill ="#FF000080", alpha = 0.25, lty =3) +
             geom_line(aes(x = B_plt_t1_MgHa, y = fitted), data = `242_pred_df`, color="#FF000080", alpha = 0.5, lwd = 2) + 
             ## red = "#D6272880" 
    
             labs(x = expression("biomass (Mg ha"^-1*")"), 
                 y = expression("biomass growth (Mg ha"^-1*" yr"^-1*")")) + 
             ggtitle("242 - Pacific Lowland Mixed Forest") +
             theme_classic() + theme(axis.text.x=element_text(angle=90,hjust=1)) + 
             scale_x_continuous(limits = c(0, tail(cutvec_242,1)*1.05), expand =c(0,0)) +
             coord_cartesian(ylim=c(-2, 10))

             #ylim(c(min(242_pred_df$`Prop.2.5%`)-0.25, max(242_pred_df$`Prop.97.5%`)+0.25))
             #ylim(c(-2,8))
            
gg.242.2

}  else {print("cannot plot data with prediction")}
```

## plotting 2

```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_242 <-data.frame(
  bin = as.factor(levels(cut(G_242$B_plt_t1_MgHa, cutvec_242))),
  data.mean = tapply(G_242$G_obs_TreeInc_MgHaYr, cut(G_242$B_plt_t1_MgHa, cutvec_242), 
                     mean), 
  data.CI.high =  tapply(G_242$G_obs_TreeInc_MgHaYr, cut(G_242$B_plt_t1_MgHa, cutvec_242), 
                    high.CI), 
  data.CI.low = tapply(G_242$G_obs_TreeInc_MgHaYr, cut(G_242$B_plt_t1_MgHa, cutvec_242),
                    low.CI), 
  pred.mean = `242_pred_df`[`242_pred_df`$B_plt_t1_MgHa %in% bin_mids_242,]$fitted) 


### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_242 <-  DM_compare_242 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_242$bin)[gtools::mixedorder(levels(DM_compare_242$bin))]))
                                                                                                        
## ggplot
gg.242.3 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_242) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_242))), 
                              labels = levels(DM_compare_242$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1,  alpha = 0.5) +         
           labs(x = expression("calculated G (Mg ha"^-1*" yr"^-1*")"), 
                y = expression("nls predicted G (Mg ha"^-1*" yr"^-1*")")) +
           ggtitle("242 - Pacific Lowland Mixed Forest") +         
           theme_classic() + 
            theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.242.3

}
```

# 251 - Prairie Parkland (Temperate)

```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_251 <- round(quantile(G_251$B_plt_t1_MgHa, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_251)))){
  cutvec_251 <- round(quantile(G_251$B_plt_t1_MgHa, seq(0,1, length.out = 11)))
}

bin_mids_251 <- unname(round(cutvec_251[-length(cutvec_251)] + diff(cutvec_251)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_251$Plt_B_bin <-  cut(G_251$B_plt_t1_MgHa, cutvec_251)
## get bin means
G_bin_means <- tapply(G_251$G_obs_TreeInc_MgHaYr, cut(G_251$B_plt_t1_MgHa, cutvec_251), mean)

## make column weights.1
G_251$nls_weights <- as.vector(1/G_bin_means[match(G_251$Plt_B_bin, names(G_bin_means))])

}
```

## model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_251.1 <- nls(fg_1, data = G_251, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_251$nls_weights), 
 )

## phi
try(
  nls_251.2 <- nls(fg_2, data=G_251, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_251$nls_weights), 
 )

# phi/alpha
try(
  nls_251.3 <- nls(fg_3 , data = G_251, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_251$nls_weights), 
 )

## test
if(exists("nls_251.1") & exists("nls_251.2") & exists("nls_251.3")){
  print(anova(nls_251.1, nls_251.2, nls_251.3))
} else if(exists("nls_251.2") & exists("nls_251.3")){
  print(anova(nls_251.2, nls_251.3))
} else if(exists("nls_251.1") & exists("nls_251.2")){
  print(anova(nls_251.1, nls_251.2))
}
 
## AIC comparison
AIC1_251 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_251.1"), AIC(get("nls_251.1")), NA),
            ifelse(exists("nls_251.2"), AIC(get("nls_251.2")), NA),
            ifelse(exists("nls_251.3"), AIC(get("nls_251.3")), NA)
            ))

print(AIC1_251) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_251[!is.na(AIC1_251$AIC) & AIC1_251$AIC == min(AIC1_251$AIC, na.rm = T),]$model

try(summary(get(paste("nls_251.",  Mod.Sel1, sep =""))) ) #model summary

}
```
### summary 
* simple model: `r ifelse(exists("nls_251.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_251.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_251.3"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_251.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_251.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_251.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_251.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_251.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_251.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "a", sep ="")), 
          data = G_251,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_251$nls_weights))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_251.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "b", sep ="")), 
          data = G_251,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_251$nls_weights)) 
 )

## c-model: with s and p parameters
try(
  assign(
    paste("nls_251.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "c", sep ="")), 
          data = G_251,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5, p=0.1)},
          weights = G_251$nls_weights))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_251.", Mod.Sel1, sep ="")) &
     exists(paste("nls_251.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_251.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_251.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_251.", Mod.Sel1, sep ="")),
             get(paste("nls_251.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_251.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_251.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_251.", Mod.Sel1, sep ="")) &
         exists(paste("nls_251.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_251.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_251.", Mod.Sel1, sep ="")),
               get(paste("nls_251.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_251.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_251.", Mod.Sel1, sep ="")) &
           exists(paste("nls_251.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_251.", Mod.Sel1, sep ="")),
                 get(paste("nls_251.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_251.", Mod.Sel1, sep ="")) &
              exists(paste("nls_251.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_251.", Mod.Sel1, sep ="")),
                    get(paste("nls_251.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_251.", Mod.Sel1, sep ="")) &
                exists(paste("nls_251.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_251.", Mod.Sel1, sep ="")),
                      get(paste("nls_251.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_251 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_251.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_251.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_251.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_251.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_251.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_251.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_251.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_251.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_251)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_251[!is.na(AIC2_251$AIC) & AIC2_251$AIC == min(AIC2_251$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.G[Best_mods.G$Code == "251",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_251.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_251.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df2[nls.param.df2$Code == "251",]$ge <- coefs["ge"]
nls.param.df2[nls.param.df2$Code == "251",]$phi <- coefs["phi"]
nls.param.df2[nls.param.df2$Code == "251",]$alpha <- coefs["alpha"]
nls.param.df2[nls.param.df2$Code == "251",]$A <- coefs["A"]
nls.param.df2[nls.param.df2$Code == "251",]$k <- coefs["k"]

nls.param.df2[nls.param.df2$Code == "251",]$ge.2.5 <- intervals_low["ge"]
nls.param.df2[nls.param.df2$Code == "251",]$phi.2.5 <- intervals_low["phi"]
nls.param.df2[nls.param.df2$Code == "251",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df2[nls.param.df2$Code == "251",]$A.2.5 <- intervals_low["A"]
nls.param.df2[nls.param.df2$Code == "251",]$k.2.5 <- intervals_low["k"]

nls.param.df2[nls.param.df2$Code == "251",]$ge.97.5 <- intervals_high["ge"]
nls.param.df2[nls.param.df2$Code == "251",]$phi.97.5 <- intervals_high["phi"]
nls.param.df2[nls.param.df2$Code == "251",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df2[nls.param.df2$Code == "251",]$A.97.5 <- intervals_high["A"]
nls.param.df2[nls.param.df2$Code == "251",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_251.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_251.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_251.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_251.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals

```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_251 <- nlsResiduals(
  get(paste("nls_251.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_251)

## test residuals
if(length(G_251$pltID) < 5001) {test.nlsResiduals(resid_251)}

}  else {print("cannot plot residuals")}
```

## predict and plot

```{r, message = FALSE, cache=T}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

`251_pred2` <- predict(get(paste("nls_251.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME_avg"= rep(mean(G_251$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME_avg"= rep(mean(G_251$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "DeltaPDSI"= rep(mean(G_251$DeltaPDSI, na.rm =T), 1501))
                      } else if (Mod.Sel1 == 3){
                        data.frame("MEASTIME_avg"= rep(mean(G_251$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "B_L_prop"= rep(mean(G_251$B_L_prop, na.rm =T), 1501), 
                                   "DeltaPDSI"= rep(mean(G_251$DeltaPDSI, na.rm =T), 1501))
                      } )

## predicted interval data.frame
`251_pred_df` <- data.frame("B_plt_t1_MgHa" = seq(0,1500,by =1), fitted=`251_pred2`)

## PLOTTING 2
gg.251.2 <- ggplot() +
             geom_jitter(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_251, 
                         alpha = 0.5, color = "#00000080", shape = "+") +
             ## dark ponts = "#1E88E580"
             geom_hline(yintercept =0, lty =3) +
            
             stat_summary_bin(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_251, 
                              fun.data = function(x) {
                                res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                                names(res) <- c("ymin","y","ymax")
                                res}, 
                              col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_251)+1)), breaks = cutvec_251) +         
    
             # geom_ribbon(aes(x = B_plt_t1_MgHa, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
             #             data = 251_pred_df, color="#FF000080", fill ="#FF000080", alpha = 0.25, lty =3) +
             geom_line(aes(x = B_plt_t1_MgHa, y = fitted), data = `251_pred_df`, color="#FF000080", alpha = 0.5, lwd = 2) + 
             ## red = "#D6272880" 
    
             labs(x = expression("biomass (Mg ha"^-1*")"), 
                 y = expression("biomass growth (Mg ha"^-1*" yr"^-1*")")) + 
             ggtitle("251 - Prairie Parkland (Temperate)") +
             theme_classic() + theme(axis.text.x=element_text(angle=90,hjust=1)) + 
             scale_x_continuous(limits = c(0, tail(cutvec_251,1)*1.05), expand =c(0,0))  +
             coord_cartesian(ylim=c(-2, 10))
 
             #ylim(c(min(251_pred_df$`Prop.2.5%`)-0.25, max(251_pred_df$`Prop.97.5%`)+0.25))
             #ylim(c(-2,8))
            
gg.251.2

}  else {print("cannot plot data with prediction")}
```

## plotting 2

```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_251 <-data.frame(
  bin = as.factor(levels(cut(G_251$B_plt_t1_MgHa, cutvec_251))),
  data.mean = tapply(G_251$G_obs_TreeInc_MgHaYr, cut(G_251$B_plt_t1_MgHa, cutvec_251), 
                     mean), 
  data.CI.high =  tapply(G_251$G_obs_TreeInc_MgHaYr, cut(G_251$B_plt_t1_MgHa, cutvec_251), 
                    high.CI), 
  data.CI.low = tapply(G_251$G_obs_TreeInc_MgHaYr, cut(G_251$B_plt_t1_MgHa, cutvec_251),
                    low.CI), 
  pred.mean = `251_pred_df`[`251_pred_df`$B_plt_t1_MgHa %in% bin_mids_251,]$fitted) 


### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_251 <-  DM_compare_251 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_251$bin)[gtools::mixedorder(levels(DM_compare_251$bin))]))
                                                                                                        
## ggplot
gg.251.3 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_251) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_251))), 
                              labels = levels(DM_compare_251$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1,  alpha = 0.5) +         
           labs(x = expression("calculated G (Mg ha"^-1*" yr"^-1*")"), 
                y = expression("nls predicted G (Mg ha"^-1*" yr"^-1*")")) +
           ggtitle("251 - Prairie Parkland (Temperate)") +         
           theme_classic() + 
            theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.251.3

}
```

# 255 - Prairie Parkland (Subtropical)

```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {

### cutvec and bin mids
cutvec_255 <- round(quantile(G_255$B_plt_t1_MgHa, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_255)))){
  cutvec_255 <- round(quantile(G_255$B_plt_t1_MgHa, seq(0,1, length.out = 11)))
}

bin_mids_255 <- unname(round(cutvec_255[-length(cutvec_255)] + diff(cutvec_255)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_255$Plt_B_bin <-  cut(G_255$B_plt_t1_MgHa, cutvec_255)
## get bin means
G_255_bin_means <- tapply(G_255$G_obs_TreeInc_MgHaYr, cut(G_255$B_plt_t1_MgHa, cutvec_255), mean)

## make column weights.1
G_255$nls_weights <- as.vector(1/G_bin_means[match(G_255$Plt_B_bin, names(G_bin_means))])

}
```

## model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_255.1 <- nls(fg_1, data = G_255, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_255$nls_weights), 
 )

## phi
try(
  nls_255.2 <- nls(fg_2, data=G_255, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_255$nls_weights), 
 )

# phi/alpha
try(
  nls_255.3 <- nls(fg_3 , data = G_255, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_255$nls_weights), 
 )

## test
if(exists("nls_255.1") & exists("nls_255.2") & exists("nls_255.3")){
  print(anova(nls_255.1, nls_255.2, nls_255.3))
} else if(exists("nls_255.2") & exists("nls_255.3")){
  print(anova(nls_255.2, nls_255.3))
} else if(exists("nls_255.1") & exists("nls_255.2")){
  print(anova(nls_255.1, nls_255.2))
}
 
## AIC comparison
AIC1_255 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_255.1"), AIC(get("nls_255.1")), NA),
            ifelse(exists("nls_255.2"), AIC(get("nls_255.2")), NA),
            ifelse(exists("nls_255.3"), AIC(get("nls_255.3")), NA)
            ))

print(AIC1_255) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_255[!is.na(AIC1_255$AIC) & AIC1_255$AIC == min(AIC1_255$AIC, na.rm = T),]$model

try(summary(get(paste("nls_255.",  Mod.Sel1, sep =""))) ) #model summary

}
```
### summary 
* simple model: `r ifelse(exists("nls_255.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_255.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_255.3"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_255.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_255.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_255.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_255.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_255.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_255.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "a", sep ="")), 
          data = G_255,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_255$nls_weights))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_255.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "b", sep ="")), 
          data = G_255,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_255$nls_weights)) 
 )

## c-model: with s and p parameters
try(
  assign(
    paste("nls_255.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "c", sep ="")), 
          data = G_255,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5, p=0.1)},
          weights = G_255$nls_weights))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_255.", Mod.Sel1, sep ="")) &
     exists(paste("nls_255.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_255.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_255.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_255.", Mod.Sel1, sep ="")),
             get(paste("nls_255.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_255.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_255.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_255.", Mod.Sel1, sep ="")) &
         exists(paste("nls_255.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_255.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_255.", Mod.Sel1, sep ="")),
               get(paste("nls_255.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_255.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_255.", Mod.Sel1, sep ="")) &
           exists(paste("nls_255.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_255.", Mod.Sel1, sep ="")),
                 get(paste("nls_255.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_255.", Mod.Sel1, sep ="")) &
              exists(paste("nls_255.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_255.", Mod.Sel1, sep ="")),
                    get(paste("nls_255.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_255.", Mod.Sel1, sep ="")) &
                exists(paste("nls_255.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_255.", Mod.Sel1, sep ="")),
                      get(paste("nls_255.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_255 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_255.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_255.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_255.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_255.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_255.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_255.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_255.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_255.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_255)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_255[!is.na(AIC2_255$AIC) & AIC2_255$AIC == min(AIC2_255$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.G[Best_mods.G$Code == "255",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_255.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_255.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df2[nls.param.df2$Code == "255",]$ge <- coefs["ge"]
nls.param.df2[nls.param.df2$Code == "255",]$phi <- coefs["phi"]
nls.param.df2[nls.param.df2$Code == "255",]$alpha <- coefs["alpha"]
nls.param.df2[nls.param.df2$Code == "255",]$A <- coefs["A"]
nls.param.df2[nls.param.df2$Code == "255",]$k <- coefs["k"]

nls.param.df2[nls.param.df2$Code == "255",]$ge.2.5 <- intervals_low["ge"]
nls.param.df2[nls.param.df2$Code == "255",]$phi.2.5 <- intervals_low["phi"]
nls.param.df2[nls.param.df2$Code == "255",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df2[nls.param.df2$Code == "255",]$A.2.5 <- intervals_low["A"]
nls.param.df2[nls.param.df2$Code == "255",]$k.2.5 <- intervals_low["k"]

nls.param.df2[nls.param.df2$Code == "255",]$ge.97.5 <- intervals_high["ge"]
nls.param.df2[nls.param.df2$Code == "255",]$phi.97.5 <- intervals_high["phi"]
nls.param.df2[nls.param.df2$Code == "255",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df2[nls.param.df2$Code == "255",]$A.97.5 <- intervals_high["A"]
nls.param.df2[nls.param.df2$Code == "255",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_255.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_255.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_255.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_255.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals

```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_255 <- nlsResiduals(
  get(paste("nls_255.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_255)

## test residuals
if(length(G_255$pltID) < 5001) {test.nlsResiduals(resid_255)}

}  else {print("cannot plot residuals")}
```

## predict and plot

```{r, message = FALSE, cache=T}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

`255_pred2` <- predict(get(paste("nls_255.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME_avg"= rep(mean(G_255$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME_avg"= rep(mean(G_255$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "DeltaPDSI"= rep(mean(G_255$DeltaPDSI, na.rm =T), 1501))
                      } else if (Mod.Sel1 == 3){
                        data.frame("MEASTIME_avg"= rep(mean(G_255$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "B_L_prop"= rep(mean(G_255$B_L_prop, na.rm =T), 1501), 
                                   "DeltaPDSI"= rep(mean(G_255$DeltaPDSI, na.rm =T), 1501))
                      } )


## predicted interval data.frame
`255_pred_df` <- data.frame("B_plt_t1_MgHa" = seq(0,1500,by =1), fitted=`255_pred2`)

## PLOTTING 2
gg.255.2 <- ggplot() +
             geom_jitter(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_255, 
                         alpha = 0.5, color = "#00000080", shape = "+") +
             ## dark ponts = "#1E88E580"
             geom_hline(yintercept =0, lty =3) +
            
             stat_summary_bin(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_255, 
                              fun.data = function(x) {
                                res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                                names(res) <- c("ymin","y","ymax")
                                res}, 
                              col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_255))), breaks = cutvec_255) +         
    
             # geom_ribbon(aes(x = B_plt_t1_MgHa, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
             #             data = 255_pred_df, color="#FF000080", fill ="#FF000080", alpha = 0.25, lty =3) +
             geom_line(aes(x = B_plt_t1_MgHa, y = fitted), data = `255_pred_df`, color="#FF000080", alpha = 0.5, lwd = 2) + 
             ## red = "#D6272880" 
    
             labs(x = expression("biomass (Mg ha"^-1*")"), 
                 y = expression("biomass growth (Mg ha"^-1*" yr"^-1*")")) + 
             ggtitle("255 - Prairie Parkland (Subtropical)") +
             theme_classic() + theme(axis.text.x=element_text(angle=90,hjust=1)) + 
             scale_x_continuous(limits = c(0, tail(cutvec_255,1)*1.05), expand =c(0,0)) +
             coord_cartesian(ylim=c(-2, 10))

             #ylim(c(min(255_pred_df$`Prop.2.5%`)-0.25, max(255_pred_df$`Prop.97.5%`)+0.25))
             #ylim(c(-2,8))
            
gg.255.2

}  else {print("cannot plot data with prediction")}
```

## plotting 2

```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_255 <-data.frame(
  bin = as.factor(levels(cut(G_255$B_plt_t1_MgHa, cutvec_255))),
  data.mean = tapply(G_255$G_obs_TreeInc_MgHaYr, cut(G_255$B_plt_t1_MgHa, cutvec_255), 
                     mean), 
  data.CI.high =  tapply(G_255$G_obs_TreeInc_MgHaYr, cut(G_255$B_plt_t1_MgHa, cutvec_255), 
                    high.CI), 
  data.CI.low = tapply(G_255$G_obs_TreeInc_MgHaYr, cut(G_255$B_plt_t1_MgHa, cutvec_255),
                    low.CI), 
  pred.mean = `255_pred_df`[`255_pred_df`$B_plt_t1_MgHa %in% bin_mids_255,]$fitted) 


### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_255 <-  DM_compare_255 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_255$bin)[gtools::mixedorder(levels(DM_compare_255$bin))]))
                                                                                                        
## ggplot
gg.255.3 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_255) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_255))), 
                              labels = levels(DM_compare_255$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1,  alpha = 0.5) +         
           labs(x = expression("calculated G (Mg ha"^-1*" yr"^-1*")"), 
                y = expression("nls predicted G (Mg ha"^-1*" yr"^-1*")")) +
           ggtitle("255 - Prairie Parkland (Subtropical)") +         
           theme_classic() + 
            theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.255.3

}
```


# 261 - California Coastal Chaparral Forest and Shrub

```{r, echo = F}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_261 <- round(quantile(G_261$B_plt_t1_MgHa, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_261)))){
  cutvec_261 <- round(quantile(G_261$B_plt_t1_MgHa, seq(0,1, length.out = 11)))
}

bin_mids_261 <- unname(round(cutvec_261[-length(cutvec_261)] + diff(cutvec_261)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_261$Plt_B_bin <-  cut(G_261$B_plt_t1_MgHa, cutvec_261)
## get bin means
G_bin_means <- tapply(G_261$G_obs_TreeInc_MgHaYr, cut(G_261$B_plt_t1_MgHa, cutvec_261), mean)

## make column weights.1
G_261$nls_weights <- as.vector(1/G_bin_means[match(G_261$Plt_B_bin, names(G_bin_means))])

}
```

## model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_261.1 <- nls(fg_1, data = G_261, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_261$nls_weights), 
 )

## phi
try(
  nls_261.2 <- nls(fg_2, data=G_261, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_261$nls_weights), 
 )

# phi/alpha
try(
  nls_261.3 <- nls(fg_3 , data = G_261, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_261$nls_weights), 
 )

## test
if(exists("nls_261.1") & exists("nls_261.2") & exists("nls_261.3")){
  print(anova(nls_261.1, nls_261.2, nls_261.3))
} else if(exists("nls_261.2") & exists("nls_261.3")){
  print(anova(nls_261.2, nls_261.3))
} else if(exists("nls_261.1") & exists("nls_261.2")){
  print(anova(nls_261.1, nls_261.2))
}
 
## AIC comparison
AIC1_261 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_261.1"), AIC(get("nls_261.1")), NA),
            ifelse(exists("nls_261.2"), AIC(get("nls_261.2")), NA),
            ifelse(exists("nls_261.3"), AIC(get("nls_261.3")), NA)
            ))

print(AIC1_261) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_261[!is.na(AIC1_261$AIC) & AIC1_261$AIC == min(AIC1_261$AIC, na.rm = T),]$model

try(summary(get(paste("nls_261.",  Mod.Sel1, sep =""))) ) #model summary

}
```
### summary 
* simple model: `r ifelse(exists("nls_261.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_261.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_261.3"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_261.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_261.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_261.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_261.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_261.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_261.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "a", sep ="")), 
          data = G_261,
         start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_261$nls_weights))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_261.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "b", sep ="")), 
          data = G_261,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_261$nls_weights)) 
 )

## c-model: with s and p parameters
try(
  assign(
    paste("nls_261.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "c", sep ="")), 
          data = G_261,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5, p=0.1)}, 
          weights = G_261$nls_weights))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_261.", Mod.Sel1, sep ="")) &
     exists(paste("nls_261.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_261.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_261.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_261.", Mod.Sel1, sep ="")),
             get(paste("nls_261.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_261.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_261.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_261.", Mod.Sel1, sep ="")) &
         exists(paste("nls_261.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_261.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_261.", Mod.Sel1, sep ="")),
               get(paste("nls_261.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_261.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_261.", Mod.Sel1, sep ="")) &
           exists(paste("nls_261.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_261.", Mod.Sel1, sep ="")),
                 get(paste("nls_261.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_261.", Mod.Sel1, sep ="")) &
              exists(paste("nls_261.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_261.", Mod.Sel1, sep ="")),
                    get(paste("nls_261.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_261.", Mod.Sel1, sep ="")) &
                exists(paste("nls_261.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_261.", Mod.Sel1, sep ="")),
                      get(paste("nls_261.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_261 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_261.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_261.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_261.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_261.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_261.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_261.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_261.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_261.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_261)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_261[!is.na(AIC2_261$AIC) & AIC2_261$AIC == min(AIC2_261$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.G[Best_mods.G$Code == "261",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_261.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_261.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df2[nls.param.df2$Code == "261",]$ge <- coefs["ge"]
nls.param.df2[nls.param.df2$Code == "261",]$phi <- coefs["phi"]
nls.param.df2[nls.param.df2$Code == "261",]$alpha <- coefs["alpha"]
nls.param.df2[nls.param.df2$Code == "261",]$A <- coefs["A"]
nls.param.df2[nls.param.df2$Code == "261",]$k <- coefs["k"]

nls.param.df2[nls.param.df2$Code == "261",]$ge.2.5 <- intervals_low["ge"]
nls.param.df2[nls.param.df2$Code == "261",]$phi.2.5 <- intervals_low["phi"]
nls.param.df2[nls.param.df2$Code == "261",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df2[nls.param.df2$Code == "261",]$A.2.5 <- intervals_low["A"]
nls.param.df2[nls.param.df2$Code == "261",]$k.2.5 <- intervals_low["k"]

nls.param.df2[nls.param.df2$Code == "261",]$ge.97.5 <- intervals_high["ge"]
nls.param.df2[nls.param.df2$Code == "261",]$phi.97.5 <- intervals_high["phi"]
nls.param.df2[nls.param.df2$Code == "261",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df2[nls.param.df2$Code == "261",]$A.97.5 <- intervals_high["A"]
nls.param.df2[nls.param.df2$Code == "261",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_261.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_261.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_261.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_261.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals

```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_261 <- nlsResiduals(
  get(paste("nls_261.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_261)

## test residuals
if(length(G_261$pltID) < 5001) {test.nlsResiduals(resid_261)}

}  else {print("cannot plot residuals")}
```

## predict and plot

```{r, message = FALSE, cache=T}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

`261_pred2` <- predict(get(paste("nls_261.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME_avg"= rep(mean(G_261$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME_avg"= rep(mean(G_261$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "DeltaPDSI"= rep(mean(G_261$DeltaPDSI, na.rm =T), 1501))
                      } else if (Mod.Sel1 == 3){
                        data.frame("MEASTIME_avg"= rep(mean(G_261$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "B_L_prop"= rep(mean(G_261$B_L_prop, na.rm =T), 1501), 
                                   "DeltaPDSI"= rep(mean(G_261$DeltaPDSI, na.rm =T), 1501))
                      } )

## predicted interval data.frame
`261_pred_df` <- data.frame("B_plt_t1_MgHa" = seq(0,1500,by =1), fitted=`261_pred2`)

## PLOTTING 2
gg.261.2 <- ggplot() +
             geom_jitter(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_261, 
                         alpha = 0.5, color = "#00000080", shape = "+") +
             ## dark ponts = "#1E88E580"
             geom_hline(yintercept =0, lty =3) +
            
             stat_summary_bin(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_261, 
                              fun.data = function(x) {
                                res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                                names(res) <- c("ymin","y","ymax")
                                res}, 
                              col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_261))), breaks = cutvec_261) +         
    
             # geom_ribbon(aes(x = B_plt_t1_MgHa, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
             #             data = 261_pred_df, color="#FF000080", fill ="#FF000080", alpha = 0.25, lty =3) +
             geom_line(aes(x = B_plt_t1_MgHa, y = fitted), data = `261_pred_df`, color="#FF000080", alpha = 0.5, lwd = 2) + 
             ## red = "#D6272880" 
    
             labs(x = expression("biomass (Mg ha"^-1*")"), 
                 y = expression("biomass growth (Mg ha"^-1*" yr"^-1*")")) + 
             ggtitle("261 - California Coastal Chaparral Forest and Shrub") +
             theme_classic() + theme(axis.text.x=element_text(angle=90,hjust=1)) + 
             scale_x_continuous(limits = c(0, tail(cutvec_261,1)*1.05), expand =c(0,0)) +
             coord_cartesian(ylim=c(-2, 10))
  
             #ylim(c(min(261_pred_df$`Prop.2.5%`)-0.25, max(261_pred_df$`Prop.97.5%`)+0.25))
             #ylim(c(-2,8))
            
gg.261.2

}  else {print("cannot plot data with prediction")}
```

## plotting 2

```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_261 <-data.frame(
  bin = as.factor(levels(cut(G_261$B_plt_t1_MgHa, cutvec_261))),
  data.mean = tapply(G_261$G_obs_TreeInc_MgHaYr, cut(G_261$B_plt_t1_MgHa, cutvec_261), 
                     mean), 
  data.CI.high =  tapply(G_261$G_obs_TreeInc_MgHaYr, cut(G_261$B_plt_t1_MgHa, cutvec_261), 
                    high.CI), 
  data.CI.low = tapply(G_261$G_obs_TreeInc_MgHaYr, cut(G_261$B_plt_t1_MgHa, cutvec_261),
                    low.CI), 
  pred.mean = `261_pred_df`[`261_pred_df`$B_plt_t1_MgHa %in% bin_mids_261,]$fitted) 


### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_261 <-  DM_compare_261 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_261$bin)[gtools::mixedorder(levels(DM_compare_261$bin))]))
                                                                                                        
## ggplot
gg.261.3 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_261) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_261))), 
                              labels = levels(DM_compare_261$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1,  alpha = 0.5) +         
           labs(x = expression("calculated G (Mg ha"^-1*" yr"^-1*")"), 
                y = expression("nls predicted G (Mg ha"^-1*" yr"^-1*")")) +
           ggtitle("261 - California Coastal Chaparral Forest and Shrub") +         
           theme_classic() + 
            theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.261.3

}
```

# 262 - California Dry Steppe

```{r, echo = F}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_262 <- round(quantile(G_262$B_plt_t1_MgHa, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_262)))){
  cutvec_262 <- round(quantile(G_262$B_plt_t1_MgHa, seq(0,1, length.out = 11)))
}

bin_mids_262 <- unname(round(cutvec_262[-length(cutvec_262)] + diff(cutvec_262)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_262$Plt_B_bin <-  cut(G_262$B_plt_t1_MgHa, cutvec_262)
## get bin means
G_bin_means <- tapply(G_262$G_obs_TreeInc_MgHaYr, cut(G_262$B_plt_t1_MgHa, cutvec_262), mean)

## make column weights.1
G_262$nls_weights <- as.vector(1/G_bin_means[match(G_262$Plt_B_bin, names(G_bin_means))])

}
```

## model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_262.1 <- nls(fg_1, data = G_262, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_262$nls_weights), 
 )

## phi
try(
  nls_262.2 <- nls(fg_2, data=G_262, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_262$nls_weights), 
 )

# phi/alpha
try(
  nls_262.3 <- nls(fg_3 , data = G_262, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_262$nls_weights), 
 )

## test
if(exists("nls_262.1") & exists("nls_262.2") & exists("nls_262.3")){
  print(anova(nls_262.1, nls_262.2, nls_262.3))
} else if(exists("nls_262.2") & exists("nls_262.3")){
  print(anova(nls_262.2, nls_262.3))
} else if(exists("nls_262.1") & exists("nls_262.2")){
  print(anova(nls_262.1, nls_262.2))
}
 
## AIC comparison
AIC1_262 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_262.1"), AIC(get("nls_262.1")), NA),
            ifelse(exists("nls_262.2"), AIC(get("nls_262.2")), NA),
            ifelse(exists("nls_262.3"), AIC(get("nls_262.3")), NA)
            ))

print(AIC1_262) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_262[!is.na(AIC1_262$AIC) & AIC1_262$AIC == min(AIC1_262$AIC, na.rm = T),]$model

try(summary(get(paste("nls_262.",  Mod.Sel1, sep =""))) ) #model summary

}
```
### summary 
* simple model: `r ifelse(exists("nls_262.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_262.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_262.3"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_262.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_262.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_262.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_262.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_262.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_262.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "a", sep ="")), 
          data = G_262,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_262$nls_weights))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_262.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "b", sep ="")), 
          data = G_262,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_262$nls_weights)) 
 )

## c-model: with s and p parameters
try(
  assign(
    paste("nls_262.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "c", sep ="")), 
          data = G_262,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5, p=0.1)}, 
          weights = G_262$nls_weights))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_262.", Mod.Sel1, sep ="")) &
     exists(paste("nls_262.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_262.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_262.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_262.", Mod.Sel1, sep ="")),
             get(paste("nls_262.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_262.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_262.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_262.", Mod.Sel1, sep ="")) &
         exists(paste("nls_262.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_262.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_262.", Mod.Sel1, sep ="")),
               get(paste("nls_262.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_262.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_262.", Mod.Sel1, sep ="")) &
           exists(paste("nls_262.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_262.", Mod.Sel1, sep ="")),
                 get(paste("nls_262.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_262.", Mod.Sel1, sep ="")) &
              exists(paste("nls_262.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_262.", Mod.Sel1, sep ="")),
                    get(paste("nls_262.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_262.", Mod.Sel1, sep ="")) &
                exists(paste("nls_262.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_262.", Mod.Sel1, sep ="")),
                      get(paste("nls_262.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_262 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_262.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_262.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_262.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_262.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_262.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_262.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_262.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_262.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_262)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_262[!is.na(AIC2_262$AIC) & AIC2_262$AIC == min(AIC2_262$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.G[Best_mods.G$Code == "262",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_262.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_262.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df2[nls.param.df2$Code == "262",]$ge <- coefs["ge"]
nls.param.df2[nls.param.df2$Code == "262",]$phi <- coefs["phi"]
nls.param.df2[nls.param.df2$Code == "262",]$alpha <- coefs["alpha"]
nls.param.df2[nls.param.df2$Code == "262",]$A <- coefs["A"]
nls.param.df2[nls.param.df2$Code == "262",]$k <- coefs["k"]

nls.param.df2[nls.param.df2$Code == "262",]$ge.2.5 <- intervals_low["ge"]
nls.param.df2[nls.param.df2$Code == "262",]$phi.2.5 <- intervals_low["phi"]
nls.param.df2[nls.param.df2$Code == "262",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df2[nls.param.df2$Code == "262",]$A.2.5 <- intervals_low["A"]
nls.param.df2[nls.param.df2$Code == "262",]$k.2.5 <- intervals_low["k"]

nls.param.df2[nls.param.df2$Code == "262",]$ge.97.5 <- intervals_high["ge"]
nls.param.df2[nls.param.df2$Code == "262",]$phi.97.5 <- intervals_high["phi"]
nls.param.df2[nls.param.df2$Code == "262",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df2[nls.param.df2$Code == "262",]$A.97.5 <- intervals_high["A"]
nls.param.df2[nls.param.df2$Code == "262",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_262.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_262.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_262.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_262.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals

```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_262 <- nlsResiduals(
  get(paste("nls_262.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_262)

## test residuals
if(length(G_262$pltID) < 5001) {test.nlsResiduals(resid_262)}

}  else {print("cannot plot residuals")}
```

## predict and plot

```{r, message = FALSE, cache=T}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

`262_pred2` <- predict(get(paste("nls_262.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME_avg"= rep(mean(G_262$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME_avg"= rep(mean(G_262$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "DeltaPDSI"= rep(mean(G_262$DeltaPDSI, na.rm =T), 1501))
                      } else if (Mod.Sel1 == 3){
                        data.frame("MEASTIME_avg"= rep(mean(G_262$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "B_L_prop"= rep(mean(G_262$B_L_prop, na.rm =T), 1501), 
                                   "DeltaPDSI"= rep(mean(G_262$DeltaPDSI, na.rm =T), 1501))
                      } )


## predicted interval data.frame
`262_pred_df` <- data.frame("B_plt_t1_MgHa" = seq(0,1500,by =1), fitted=`262_pred2`)

## PLOTTING 2
gg.262.2 <- ggplot() +
             geom_jitter(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_262, 
                         alpha = 0.5, color = "#00000080", shape = "+") +
             ## dark ponts = "#1E88E580"
             geom_hline(yintercept =0, lty =3) +
            
             stat_summary_bin(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_262, 
                              fun.data = function(x) {
                                res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                                names(res) <- c("ymin","y","ymax")
                                res}, 
                              col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_262))), breaks = cutvec_262) +         
    
             # geom_ribbon(aes(x = B_plt_t1_MgHa, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
             #             data = 262_pred_df, color="#FF000080", fill ="#FF000080", alpha = 0.25, lty =3) +
             geom_line(aes(x = B_plt_t1_MgHa, y = fitted), data = `262_pred_df`, color="#FF000080", alpha = 0.5, lwd = 2) + 
             ## red = "#D6272880" 
    
             labs(x = expression("biomass (Mg ha"^-1*")"), 
                 y = expression("biomass growth (Mg ha"^-1*" yr"^-1*")")) + 
             ggtitle("262 - California Dry Steppe") +
             theme_classic() + theme(axis.text.x=element_text(angle=90,hjust=1)) + 
             scale_x_continuous(limits = c(0, tail(cutvec_262,1)*1.05), expand =c(0,0)) +
             coord_cartesian(ylim=c(-2, 10))
  
             #ylim(c(min(262_pred_df$`Prop.2.5%`)-0.25, max(262_pred_df$`Prop.97.5%`)+0.25))
             #ylim(c(-2,8))
            
gg.262.2

}  else {print("cannot plot data with prediction")}
```

## plotting 2

```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_262 <-data.frame(
  bin = as.factor(levels(cut(G_262$B_plt_t1_MgHa, cutvec_262))),
  data.mean = tapply(G_262$G_obs_TreeInc_MgHaYr, cut(G_262$B_plt_t1_MgHa, cutvec_262), 
                     mean), 
  data.CI.high =  tapply(G_262$G_obs_TreeInc_MgHaYr, cut(G_262$B_plt_t1_MgHa, cutvec_262), 
                    high.CI), 
  data.CI.low = tapply(G_262$G_obs_TreeInc_MgHaYr, cut(G_262$B_plt_t1_MgHa, cutvec_262),
                    low.CI), 
  pred.mean = `262_pred_df`[`262_pred_df`$B_plt_t1_MgHa %in% bin_mids_262,]$fitted) 


### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_262 <-  DM_compare_262 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_262$bin)[gtools::mixedorder(levels(DM_compare_262$bin))]))
                                                                                                        
## ggplot
gg.262.3 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_262) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_262))), 
                              labels = levels(DM_compare_262$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1,  alpha = 0.5) +         
           labs(x = expression("calculated G (Mg ha"^-1*" yr"^-1*")"), 
                y = expression("nls predicted G (Mg ha"^-1*" yr"^-1*")")) +
           ggtitle("262 - California Dry Steppe") +         
           theme_classic() + 
            theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.262.3

}
```


# 263 - California Coastal Steppe - Mixed Forest and Redwood Forest

```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_263 <- round(quantile(G_263$B_plt_t1_MgHa, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_263)))){
  cutvec_263 <- round(quantile(G_263$B_plt_t1_MgHa, seq(0,1, length.out = 11)))
}

bin_mids_263 <- unname(round(cutvec_263[-length(cutvec_263)] + diff(cutvec_263)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_263$Plt_B_bin <-  cut(G_263$B_plt_t1_MgHa, cutvec_263)
## get bin means
G_bin_means <- tapply(G_263$G_obs_TreeInc_MgHaYr, cut(G_263$B_plt_t1_MgHa, cutvec_263), mean)

## make column weights.1
G_263$nls_weights <- as.vector(1/G_bin_means[match(G_263$Plt_B_bin, names(G_bin_means))])

}
```

## model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_263.1 <- nls(fg_1, data = G_263, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_263$nls_weights), 
 )

## phi
try(
  nls_263.2 <- nls(fg_2, data=G_263, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_263$nls_weights), 
 )

# phi/alpha
try(
  nls_263.3 <- nls(fg_3 , data = G_263, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_263$nls_weights), 
 )

## test
if(exists("nls_263.1") & exists("nls_263.2") & exists("nls_263.3")){
  print(anova(nls_263.1, nls_263.2, nls_263.3))
} else if(exists("nls_263.2") & exists("nls_263.3")){
  print(anova(nls_263.2, nls_263.3))
} else if(exists("nls_263.1") & exists("nls_263.2")){
  print(anova(nls_263.1, nls_263.2))
}
 
## AIC comparison
AIC1_263 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_263.1"), AIC(get("nls_263.1")), NA),
            ifelse(exists("nls_263.2"), AIC(get("nls_263.2")), NA),
            ifelse(exists("nls_263.3"), AIC(get("nls_263.3")), NA)
            ))

print(AIC1_263) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_263[!is.na(AIC1_263$AIC) & AIC1_263$AIC == min(AIC1_263$AIC, na.rm = T),]$model

try(summary(get(paste("nls_263.",  Mod.Sel1, sep =""))) ) #model summary

}
```
### summary 
* simple model: `r ifelse(exists("nls_263.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_263.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_263.3"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_263.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_263.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_263.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_263.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_263.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_263.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "a", sep ="")), 
          data = G_263,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_263$nls_weights))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_263.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "b", sep ="")), 
          data = G_263,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_263$nls_weights)) 
 )

## c-model: with s and p parameters
try(
  assign(
    paste("nls_263.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "c", sep ="")), 
          data = G_263,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5, p=0.1)},
          weights = G_263$nls_weights))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_263.", Mod.Sel1, sep ="")) &
     exists(paste("nls_263.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_263.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_263.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_263.", Mod.Sel1, sep ="")),
             get(paste("nls_263.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_263.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_263.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_263.", Mod.Sel1, sep ="")) &
         exists(paste("nls_263.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_263.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_263.", Mod.Sel1, sep ="")),
               get(paste("nls_263.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_263.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_263.", Mod.Sel1, sep ="")) &
           exists(paste("nls_263.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_263.", Mod.Sel1, sep ="")),
                 get(paste("nls_263.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_263.", Mod.Sel1, sep ="")) &
              exists(paste("nls_263.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_263.", Mod.Sel1, sep ="")),
                    get(paste("nls_263.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_263.", Mod.Sel1, sep ="")) &
                exists(paste("nls_263.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_263.", Mod.Sel1, sep ="")),
                      get(paste("nls_263.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_263 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_263.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_263.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_263.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_263.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_263.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_263.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_263.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_263.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_263)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_263[!is.na(AIC2_263$AIC) & AIC2_263$AIC == min(AIC2_263$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.G[Best_mods.G$Code == "263",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_263.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_263.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df2[nls.param.df2$Code == "263",]$ge <- coefs["ge"]
nls.param.df2[nls.param.df2$Code == "263",]$phi <- coefs["phi"]
nls.param.df2[nls.param.df2$Code == "263",]$alpha <- coefs["alpha"]
nls.param.df2[nls.param.df2$Code == "263",]$A <- coefs["A"]
nls.param.df2[nls.param.df2$Code == "263",]$k <- coefs["k"]

nls.param.df2[nls.param.df2$Code == "263",]$ge.2.5 <- intervals_low["ge"]
nls.param.df2[nls.param.df2$Code == "263",]$phi.2.5 <- intervals_low["phi"]
nls.param.df2[nls.param.df2$Code == "263",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df2[nls.param.df2$Code == "263",]$A.2.5 <- intervals_low["A"]
nls.param.df2[nls.param.df2$Code == "263",]$k.2.5 <- intervals_low["k"]

nls.param.df2[nls.param.df2$Code == "263",]$ge.97.5 <- intervals_high["ge"]
nls.param.df2[nls.param.df2$Code == "263",]$phi.97.5 <- intervals_high["phi"]
nls.param.df2[nls.param.df2$Code == "263",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df2[nls.param.df2$Code == "263",]$A.97.5 <- intervals_high["A"]
nls.param.df2[nls.param.df2$Code == "263",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_263.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_263.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_263.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_263.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals

```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_263 <- nlsResiduals(
  get(paste("nls_263.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_263)

## test residuals
if(length(G_263$pltID) < 5001) {test.nlsResiduals(resid_263)}

}  else {print("cannot plot residuals")}
```

## predict and plot

```{r, message = FALSE, cache=T}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

`263_pred2` <- predict(get(paste("nls_263.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME_avg"= rep(mean(G_263$MEASTIME_avg, na.rm =T), 2501),
                                   "B_plt_t1_MgHa"=seq(0,2500,by =1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME_avg"= rep(mean(G_263$MEASTIME_avg, na.rm =T), 2501),
                                   "B_plt_t1_MgHa"=seq(0,2500,by =1),
                                   "DeltaPDSI"= rep(mean(G_263$DeltaPDSI, na.rm =T), 2501))
                      } else if (Mod.Sel1 == 3){
                        data.frame("MEASTIME_avg"= rep(mean(G_263$MEASTIME_avg, na.rm =T), 2501),
                                   "B_plt_t1_MgHa"=seq(0,2500,by =1),
                                   "B_L_prop"= rep(mean(G_263$B_L_prop, na.rm =T), 2501), 
                                   "DeltaPDSI"= rep(mean(G_263$DeltaPDSI, na.rm =T), 2501))
                      } )

## predicted interval data.frame
`263_pred_df` <- data.frame("B_plt_t1_MgHa" = seq(0,2500,by =1), fitted=`263_pred2`)

## PLOTTING 2
gg.263.2 <- ggplot() +
             geom_jitter(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_263, 
                         alpha = 0.5, color = "#00000080", shape = "+") +
             ## dark ponts = "#1E88E580"
             geom_hline(yintercept =0, lty =3) +
            
             stat_summary_bin(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_263, 
                              fun.data = function(x) {
                                res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                                names(res) <- c("ymin","y","ymax")
                                res}, 
                              col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_263))), breaks = cutvec_263) +         
    
             # geom_ribbon(aes(x = B_plt_t1_MgHa, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
             #             data = 263_pred_df, color="#FF000080", fill ="#FF000080", alpha = 0.25, lty =3) +
             geom_line(aes(x = B_plt_t1_MgHa, y = fitted), data = `263_pred_df`, color="#FF000080", alpha = 0.5, lwd = 2) + 
             ## red = "#D6272880" 
    
             labs(x = expression("biomass (Mg ha"^-1*")"), 
                 y = expression("biomass growth (Mg ha"^-1*" yr"^-1*")")) + 
             ggtitle("263 - California Coastal Steppe - Mixed Forest and Redwood Forest") +
             theme_classic() + theme(axis.text.x=element_text(angle=90,hjust=1)) + 
             scale_x_continuous(limits = c(0, tail(cutvec_263,1)*1.05), expand =c(0,0)) +
             coord_cartesian(ylim=c(-2, 10))
  
             #ylim(c(min(263_pred_df$`Prop.2.5%`)-0.25, max(263_pred_df$`Prop.97.5%`)+0.25))
             #ylim(c(-2,8))
            
gg.263.2

}  else {print("cannot plot data with prediction")}
```

## plotting 2

```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_263 <-data.frame(
  bin = as.factor(levels(cut(G_263$B_plt_t1_MgHa, cutvec_263))),
  data.mean = tapply(G_263$G_obs_TreeInc_MgHaYr, cut(G_263$B_plt_t1_MgHa, cutvec_263), 
                     mean), 
  data.CI.high =  tapply(G_263$G_obs_TreeInc_MgHaYr, cut(G_263$B_plt_t1_MgHa, cutvec_263), 
                    high.CI), 
  data.CI.low = tapply(G_263$G_obs_TreeInc_MgHaYr, cut(G_263$B_plt_t1_MgHa, cutvec_263),
                    low.CI), 
  pred.mean = `263_pred_df`[`263_pred_df`$B_plt_t1_MgHa %in% bin_mids_263,]$fitted) 


### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_263 <-  DM_compare_263 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_263$bin)[gtools::mixedorder(levels(DM_compare_263$bin))]))
                                                                                                        
## ggplot
gg.263.3 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_263) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_263))), 
                              labels = levels(DM_compare_263$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1,  alpha = 0.5) +         
           labs(x = expression("calculated G (Mg ha"^-1*" yr"^-1*")"), 
                y = expression("nls predicted G (Mg ha"^-1*" yr"^-1*")")) +
           ggtitle("263 - California Coastal Steppe - Mixed Forest and Redwood Forest") +         
           theme_classic() + 
            theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.263.3

}
```


# 313 - Colorado Plateau Semi-Desert
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_313 <- round(quantile(G_313$B_plt_t1_MgHa, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_313)))){
  cutvec_313 <- round(quantile(G_313$B_plt_t1_MgHa, seq(0,1, length.out = 11)))
}

bin_mids_313 <- unname(round(cutvec_313[-length(cutvec_313)] + diff(cutvec_313)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_313$Plt_B_bin <-  cut(G_313$B_plt_t1_MgHa, cutvec_313)
## get bin means
G_bin_means <- tapply(G_313$G_obs_TreeInc_MgHaYr, cut(G_313$B_plt_t1_MgHa, cutvec_313), mean)

## make column weights.1
G_313$nls_weights <- as.vector(1/G_bin_means[match(G_313$Plt_B_bin, names(G_bin_means))])

}
```

## model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_313.1 <- nls(fg_1, data = G_313, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_313$nls_weights), 
 )

## phi
try(
  nls_313.2 <- nls(fg_2, data=G_313, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_313$nls_weights), 
 )

# phi/alpha
try(
  nls_313.3 <- nls(fg_3 , data = G_313, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_313$nls_weights), 
 )

## test
if(exists("nls_313.1") & exists("nls_313.2") & exists("nls_313.3")){
  print(anova(nls_313.1, nls_313.2, nls_313.3))
} else if(exists("nls_313.2") & exists("nls_313.3")){
  print(anova(nls_313.2, nls_313.3))
} else if(exists("nls_313.1") & exists("nls_313.2")){
  print(anova(nls_313.1, nls_313.2))
}
 
## AIC comparison
AIC1_313 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_313.1"), AIC(get("nls_313.1")), NA),
            ifelse(exists("nls_313.2"), AIC(get("nls_313.2")), NA),
            ifelse(exists("nls_313.3"), AIC(get("nls_313.3")), NA)
            ))

print(AIC1_313) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_313[!is.na(AIC1_313$AIC) & AIC1_313$AIC == min(AIC1_313$AIC, na.rm = T),]$model

try(summary(get(paste("nls_313.",  Mod.Sel1, sep =""))) ) #model summary

}
```
### summary 
* simple model: `r ifelse(exists("nls_313.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_313.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_313.3"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_313.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_313.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_313.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_313.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_313.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_313.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "a", sep ="")), 
          data = G_313,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_313$nls_weights))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_313.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "b", sep ="")), 
          data = G_313,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_313$nls_weights)) 
 )

## c-model: with s and p parameters
try(
  assign(
    paste("nls_313.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "c", sep ="")), 
          data = G_313,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5, p=0.1)}, 
          weights = G_313$nls_weights))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_313.", Mod.Sel1, sep ="")) &
     exists(paste("nls_313.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_313.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_313.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_313.", Mod.Sel1, sep ="")),
             get(paste("nls_313.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_313.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_313.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_313.", Mod.Sel1, sep ="")) &
         exists(paste("nls_313.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_313.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_313.", Mod.Sel1, sep ="")),
               get(paste("nls_313.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_313.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_313.", Mod.Sel1, sep ="")) &
           exists(paste("nls_313.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_313.", Mod.Sel1, sep ="")),
                 get(paste("nls_313.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_313.", Mod.Sel1, sep ="")) &
              exists(paste("nls_313.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_313.", Mod.Sel1, sep ="")),
                    get(paste("nls_313.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_313.", Mod.Sel1, sep ="")) &
                exists(paste("nls_313.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_313.", Mod.Sel1, sep ="")),
                      get(paste("nls_313.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_313 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_313.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_313.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_313.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_313.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_313.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_313.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_313.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_313.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_313)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_313[!is.na(AIC2_313$AIC) & AIC2_313$AIC == min(AIC2_313$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.G[Best_mods.G$Code == "313",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_313.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_313.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df2[nls.param.df2$Code == "313",]$ge <- coefs["ge"]
nls.param.df2[nls.param.df2$Code == "313",]$phi <- coefs["phi"]
nls.param.df2[nls.param.df2$Code == "313",]$alpha <- coefs["alpha"]
nls.param.df2[nls.param.df2$Code == "313",]$A <- coefs["A"]
nls.param.df2[nls.param.df2$Code == "313",]$k <- coefs["k"]

nls.param.df2[nls.param.df2$Code == "313",]$ge.2.5 <- intervals_low["ge"]
nls.param.df2[nls.param.df2$Code == "313",]$phi.2.5 <- intervals_low["phi"]
nls.param.df2[nls.param.df2$Code == "313",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df2[nls.param.df2$Code == "313",]$A.2.5 <- intervals_low["A"]
nls.param.df2[nls.param.df2$Code == "313",]$k.2.5 <- intervals_low["k"]

nls.param.df2[nls.param.df2$Code == "313",]$ge.97.5 <- intervals_high["ge"]
nls.param.df2[nls.param.df2$Code == "313",]$phi.97.5 <- intervals_high["phi"]
nls.param.df2[nls.param.df2$Code == "313",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df2[nls.param.df2$Code == "313",]$A.97.5 <- intervals_high["A"]
nls.param.df2[nls.param.df2$Code == "313",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_313.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_313.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_313.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_313.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals

```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_313 <- nlsResiduals(
  get(paste("nls_313.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_313)

## test residuals
if(length(G_313$pltID) < 5001) {test.nlsResiduals(resid_313)}

}  else {print("cannot plot residuals")}
```

## predict and plot

```{r, message = FALSE, cache=T}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

`313_pred2` <- predict(get(paste("nls_313.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME_avg"= rep(mean(G_313$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME_avg"= rep(mean(G_313$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "DeltaPDSI"= rep(mean(G_313$DeltaPDSI, na.rm =T), 1501))
                      } else if (Mod.Sel1 == 3){
                        data.frame("MEASTIME_avg"= rep(mean(G_313$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "B_L_prop"= rep(mean(G_313$B_L_prop, na.rm =T), 1501), 
                                   "DeltaPDSI"= rep(mean(G_313$DeltaPDSI, na.rm =T), 1501))
                      } )


## predicted interval data.frame
`313_pred_df` <- data.frame("B_plt_t1_MgHa" = seq(0,1500,by =1), fitted=`313_pred2`)

## PLOTTING 2
gg.313.2 <- ggplot() +
             geom_jitter(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_313, 
                         alpha = 0.5, color = "#00000080", shape = "+") +
             ## dark ponts = "#1E88E580"
             geom_hline(yintercept =0, lty =3) +
            
             stat_summary_bin(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_313, 
                              fun.data = function(x) {
                                res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                                names(res) <- c("ymin","y","ymax")
                                res}, 
                              col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_313))), breaks = cutvec_313) +         
    
             # geom_ribbon(aes(x = B_plt_t1_MgHa, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
             #             data = 313_pred_df, color="#FF000080", fill ="#FF000080", alpha = 0.25, lty =3) +
             geom_line(aes(x = B_plt_t1_MgHa, y = fitted), data = `313_pred_df`, color="#FF000080", alpha = 0.5, lwd = 2) + 
             ## red = "#D6272880" 
    
             labs(x = expression("biomass (Mg ha"^-1*")"), 
                 y = expression("biomass growth (Mg ha"^-1*" yr"^-1*")")) + 
             ggtitle("313 - Colorado Plateau Semi-Desert") +
             theme_classic() + theme(axis.text.x=element_text(angle=90,hjust=1)) + 
             scale_x_continuous(limits = c(0, tail(cutvec_313,1)*1.05), expand =c(0,0)) +
             coord_cartesian(ylim=c(-2, 10))
  
             #ylim(c(min(313_pred_df$`Prop.2.5%`)-0.25, max(313_pred_df$`Prop.97.5%`)+0.25))
             #ylim(c(-2,8))
            
gg.313.2

}  else {print("cannot plot data with prediction")}
```

## plotting 2

```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_313 <-data.frame(
  bin = as.factor(levels(cut(G_313$B_plt_t1_MgHa, cutvec_313))),
  data.mean = tapply(G_313$G_obs_TreeInc_MgHaYr, cut(G_313$B_plt_t1_MgHa, cutvec_313), 
                     mean), 
  data.CI.high =  tapply(G_313$G_obs_TreeInc_MgHaYr, cut(G_313$B_plt_t1_MgHa, cutvec_313), 
                    high.CI), 
  data.CI.low = tapply(G_313$G_obs_TreeInc_MgHaYr, cut(G_313$B_plt_t1_MgHa, cutvec_313),
                    low.CI), 
  pred.mean = `313_pred_df`[`313_pred_df`$B_plt_t1_MgHa %in% bin_mids_313,]$fitted) 


### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_313 <-  DM_compare_313 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_313$bin)[gtools::mixedorder(levels(DM_compare_313$bin))]))
                                                                                                        
## ggplot
gg.313.3 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_313) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_313))), 
                              labels = levels(DM_compare_313$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1,  alpha = 0.5) +         
           labs(x = expression("calculated G (Mg ha"^-1*" yr"^-1*")"), 
                y = expression("nls predicted G (Mg ha"^-1*" yr"^-1*")")) +
           ggtitle("313 - Colorado Plateau Semi-Desert") +         
           theme_classic() + 
            theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.313.3

}
```

# 315 - Southwest Plateau and Plains Dry Steppe and Shrub
```{r, echo = F}
## code control
fit.models <-  F
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_315 <- round(quantile(G_315$B_plt_t1_MgHa, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_315)))){
  cutvec_315 <- round(quantile(G_315$B_plt_t1_MgHa, seq(0,1, length.out = 11)))
}

bin_mids_315 <- unname(round(cutvec_315[-length(cutvec_315)] + diff(cutvec_315)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_315$Plt_B_bin <-  cut(G_315$B_plt_t1_MgHa, cutvec_315)
## get bin means
G_bin_means <- tapply(G_315$G_obs_TreeInc_MgHaYr, cut(G_315$B_plt_t1_MgHa, cutvec_315), mean)

## make column weights.1
G_315$nls_weights <- as.vector(1/G_bin_means[match(G_315$Plt_B_bin, names(G_bin_means))])

}
```

## model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_315.1 <- nls(fg_1, data = G_315, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_315$nls_weights), 
 )

## phi
try(
  nls_315.2 <- nls(fg_2, data=G_315, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_315$nls_weights), 
 )

# phi/alpha
try(
  nls_315.3 <- nls(fg_3 , data = G_315, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_315$nls_weights), 
 )

## test
if(exists("nls_315.1") & exists("nls_315.2") & exists("nls_315.3")){
  print(anova(nls_315.1, nls_315.2, nls_315.3))
} else if(exists("nls_315.2") & exists("nls_315.3")){
  print(anova(nls_315.2, nls_315.3))
} else if(exists("nls_315.1") & exists("nls_315.2")){
  print(anova(nls_315.1, nls_315.2))
}
 
## AIC comparison
AIC1_315 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_315.1"), AIC(get("nls_315.1")), NA),
            ifelse(exists("nls_315.2"), AIC(get("nls_315.2")), NA),
            ifelse(exists("nls_315.3"), AIC(get("nls_315.3")), NA)
            ))

print(AIC1_315) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_315[!is.na(AIC1_315$AIC) & AIC1_315$AIC == min(AIC1_315$AIC, na.rm = T),]$model

try(summary(get(paste("nls_315.",  Mod.Sel1, sep =""))) ) #model summary

}
```
### summary 
* simple model: `r ifelse(exists("nls_315.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_315.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_315.3"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_315.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_315.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_315.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_315.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_315.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_315.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "a", sep ="")), 
          data = G_315,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_315$nls_weights))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_315.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "b", sep ="")), 
          data = G_315,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_315$nls_weights)) 
 )

## c-model: with s and p parameters
try(
  assign(
    paste("nls_315.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "c", sep ="")), 
          data = G_315,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5, p=0.1)},
          weights = G_315$nls_weights))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_315.", Mod.Sel1, sep ="")) &
     exists(paste("nls_315.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_315.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_315.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_315.", Mod.Sel1, sep ="")),
             get(paste("nls_315.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_315.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_315.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_315.", Mod.Sel1, sep ="")) &
         exists(paste("nls_315.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_315.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_315.", Mod.Sel1, sep ="")),
               get(paste("nls_315.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_315.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_315.", Mod.Sel1, sep ="")) &
           exists(paste("nls_315.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_315.", Mod.Sel1, sep ="")),
                 get(paste("nls_315.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_315.", Mod.Sel1, sep ="")) &
              exists(paste("nls_315.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_315.", Mod.Sel1, sep ="")),
                    get(paste("nls_315.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_315.", Mod.Sel1, sep ="")) &
                exists(paste("nls_315.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_315.", Mod.Sel1, sep ="")),
                      get(paste("nls_315.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_315 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_315.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_315.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_315.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_315.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_315.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_315.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_315.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_315.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_315)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_315[!is.na(AIC2_315$AIC) & AIC2_315$AIC == min(AIC2_315$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.G[Best_mods.G$Code == "315",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_315.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_315.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df2[nls.param.df2$Code == "315",]$ge <- coefs["ge"]
nls.param.df2[nls.param.df2$Code == "315",]$phi <- coefs["phi"]
nls.param.df2[nls.param.df2$Code == "315",]$alpha <- coefs["alpha"]
nls.param.df2[nls.param.df2$Code == "315",]$A <- coefs["A"]
nls.param.df2[nls.param.df2$Code == "315",]$k <- coefs["k"]

nls.param.df2[nls.param.df2$Code == "315",]$ge.2.5 <- intervals_low["ge"]
nls.param.df2[nls.param.df2$Code == "315",]$phi.2.5 <- intervals_low["phi"]
nls.param.df2[nls.param.df2$Code == "315",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df2[nls.param.df2$Code == "315",]$A.2.5 <- intervals_low["A"]
nls.param.df2[nls.param.df2$Code == "315",]$k.2.5 <- intervals_low["k"]

nls.param.df2[nls.param.df2$Code == "315",]$ge.97.5 <- intervals_high["ge"]
nls.param.df2[nls.param.df2$Code == "315",]$phi.97.5 <- intervals_high["phi"]
nls.param.df2[nls.param.df2$Code == "315",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df2[nls.param.df2$Code == "315",]$A.97.5 <- intervals_high["A"]
nls.param.df2[nls.param.df2$Code == "315",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_315.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_315.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_315.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_315.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals

```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_315 <- nlsResiduals(
  get(paste("nls_315.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_315)

## test residuals
if(length(G_315$pltID) < 5001) {test.nlsResiduals(resid_315)}

}  else {print("cannot plot residuals")}
```

## predict and plot

```{r, message = FALSE, cache=T}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

`315_pred2` <- predict(get(paste("nls_315.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME_avg"= rep(mean(G_315$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME_avg"= rep(mean(G_315$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "DeltaPDSI"= rep(mean(G_315$DeltaPDSI, na.rm =T), 1501))
                      } else if (Mod.Sel1 == 3){
                        data.frame("MEASTIME_avg"= rep(mean(G_315$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "B_L_prop"= rep(mean(G_315$B_L_prop, na.rm =T), 1501), 
                                   "DeltaPDSI"= rep(mean(G_315$DeltaPDSI, na.rm =T), 1501))
                      } )

## predicted interval data.frame
`315_pred_df` <- data.frame("B_plt_t1_MgHa" = seq(0,1500,by =1), fitted=`315_pred2`)

## PLOTTING 2
gg.315.2 <- ggplot() +
             geom_jitter(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_315, 
                         alpha = 0.5, color = "#00000080", shape = "+") +
             ## dark ponts = "#1E88E580"
             geom_hline(yintercept =0, lty =3) +
            
             stat_summary_bin(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_315, 
                              fun.data = function(x) {
                                res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                                names(res) <- c("ymin","y","ymax")
                                res}, 
                              col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_315))), breaks = cutvec_315) +         
    
             # geom_ribbon(aes(x = B_plt_t1_MgHa, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
             #             data = 315_pred_df, color="#FF000080", fill ="#FF000080", alpha = 0.25, lty =3) +
             geom_line(aes(x = B_plt_t1_MgHa, y = fitted), data = `315_pred_df`, color="#FF000080", alpha = 0.5, lwd = 2) + 
             ## red = "#D6272880" 
    
             labs(x = expression("biomass (Mg ha"^-1*")"), 
                 y = expression("biomass growth (Mg ha"^-1*" yr"^-1*")")) + 
             ggtitle("315 - Southwest Plateau and Plains Dry Steppe and Shrub") +
             theme_classic() + theme(axis.text.x=element_text(angle=90,hjust=1)) + 
             scale_x_continuous(limits = c(0, tail(cutvec_315,1)*1.05), expand =c(0,0)) +
             coord_cartesian(ylim=c(-2, 10))
  
             #ylim(c(min(315_pred_df$`Prop.2.5%`)-0.25, max(315_pred_df$`Prop.97.5%`)+0.25))
             #ylim(c(-2,8))
            
gg.315.2

}  else {print("cannot plot data with prediction")}
```

## plotting 2

```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_315 <-data.frame(
  bin = as.factor(levels(cut(G_315$B_plt_t1_MgHa, cutvec_315))),
  data.mean = tapply(G_315$G_obs_TreeInc_MgHaYr, cut(G_315$B_plt_t1_MgHa, cutvec_315), 
                     mean), 
  data.CI.high =  tapply(G_315$G_obs_TreeInc_MgHaYr, cut(G_315$B_plt_t1_MgHa, cutvec_315), 
                    high.CI), 
  data.CI.low = tapply(G_315$G_obs_TreeInc_MgHaYr, cut(G_315$B_plt_t1_MgHa, cutvec_315),
                    low.CI), 
  pred.mean = `315_pred_df`[`315_pred_df`$B_plt_t1_MgHa %in% bin_mids_315,]$fitted) 


### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_315 <-  DM_compare_315 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_315$bin)[gtools::mixedorder(levels(DM_compare_315$bin))]))
                                                                                                        
## ggplot
gg.315.3 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_315) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_315))), 
                              labels = levels(DM_compare_315$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1,  alpha = 0.5) +         
           labs(x = expression("calculated G (Mg ha"^-1*" yr"^-1*")"), 
                y = expression("nls predicted G (Mg ha"^-1*" yr"^-1*")")) +
           ggtitle("315 - Southwest Plateau and Plains Dry Steppe and Shrub") +         
           theme_classic() + 
            theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.315.3

}
```


# 321 - Chihuahuan Semi-Desert
```{r, echo = F}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_321 <- round(quantile(G_321$B_plt_t1_MgHa, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_321)))){
  cutvec_321 <- round(quantile(G_321$B_plt_t1_MgHa, seq(0,1, length.out = 11)))
}

bin_mids_321 <- unname(round(cutvec_321[-length(cutvec_321)] + diff(cutvec_321)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_321$Plt_B_bin <-  cut(G_321$B_plt_t1_MgHa, cutvec_321)
## get bin means
G_bin_means <- tapply(G_321$G_obs_TreeInc_MgHaYr, cut(G_321$B_plt_t1_MgHa, cutvec_321), mean)

## make column weights.1
G_321$nls_weights <- as.vector(1/G_bin_means[match(G_321$Plt_B_bin, names(G_bin_means))])

}
```

## model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_321.1 <- nls(fg_1, data = G_321, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_321$nls_weights), 
 )

## phi
try(
  nls_321.2 <- nls(fg_2, data=G_321, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_321$nls_weights), 
 )

# phi/alpha
try(
  nls_321.3 <- nls(fg_3 , data = G_321, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_321$nls_weights), 
 )

## test
if(exists("nls_321.1") & exists("nls_321.2") & exists("nls_321.3")){
  print(anova(nls_321.1, nls_321.2, nls_321.3))
} else if(exists("nls_321.2") & exists("nls_321.3")){
  print(anova(nls_321.2, nls_321.3))
} else if(exists("nls_321.1") & exists("nls_321.2")){
  print(anova(nls_321.1, nls_321.2))
}
 
## AIC comparison
AIC1_321 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_321.1"), AIC(get("nls_321.1")), NA),
            ifelse(exists("nls_321.2"), AIC(get("nls_321.2")), NA),
            ifelse(exists("nls_321.3"), AIC(get("nls_321.3")), NA)
            ))

print(AIC1_321) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_321[!is.na(AIC1_321$AIC) & AIC1_321$AIC == min(AIC1_321$AIC, na.rm = T),]$model

try(summary(get(paste("nls_321.",  Mod.Sel1, sep =""))) ) #model summary

}
```
### summary 
* simple model: `r ifelse(exists("nls_321.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_321.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_321.3"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_321.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_321.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_321.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_321.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_321.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_321.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "a", sep ="")), 
          data = G_321,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, p=0.1)},
          weights = G_321$nls_weights))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_321.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "b", sep ="")), 
          data = G_321,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 

          weights = G_321$nls_weights)) 
 )

## c-model: with s and p parameters
try(
  assign(
    paste("nls_321.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "c", sep ="")), 
          data = G_321,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_321$nls_weights))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_321.", Mod.Sel1, sep ="")) &
     exists(paste("nls_321.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_321.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_321.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_321.", Mod.Sel1, sep ="")),
             get(paste("nls_321.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_321.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_321.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_321.", Mod.Sel1, sep ="")) &
         exists(paste("nls_321.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_321.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_321.", Mod.Sel1, sep ="")),
               get(paste("nls_321.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_321.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_321.", Mod.Sel1, sep ="")) &
           exists(paste("nls_321.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_321.", Mod.Sel1, sep ="")),
                 get(paste("nls_321.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_321.", Mod.Sel1, sep ="")) &
              exists(paste("nls_321.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_321.", Mod.Sel1, sep ="")),
                    get(paste("nls_321.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_321.", Mod.Sel1, sep ="")) &
                exists(paste("nls_321.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_321.", Mod.Sel1, sep ="")),
                      get(paste("nls_321.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_321 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_321.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_321.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_321.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_321.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_321.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_321.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_321.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_321.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_321)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_321[!is.na(AIC2_321$AIC) & AIC2_321$AIC == min(AIC2_321$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.G[Best_mods.G$Code == "321",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_321.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_321.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df2[nls.param.df2$Code == "321",]$ge <- coefs["ge"]
nls.param.df2[nls.param.df2$Code == "321",]$phi <- coefs["phi"]
nls.param.df2[nls.param.df2$Code == "321",]$alpha <- coefs["alpha"]
nls.param.df2[nls.param.df2$Code == "321",]$A <- coefs["A"]
nls.param.df2[nls.param.df2$Code == "321",]$k <- coefs["k"]

nls.param.df2[nls.param.df2$Code == "321",]$ge.2.5 <- intervals_low["ge"]
nls.param.df2[nls.param.df2$Code == "321",]$phi.2.5 <- intervals_low["phi"]
nls.param.df2[nls.param.df2$Code == "321",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df2[nls.param.df2$Code == "321",]$A.2.5 <- intervals_low["A"]
nls.param.df2[nls.param.df2$Code == "321",]$k.2.5 <- intervals_low["k"]

nls.param.df2[nls.param.df2$Code == "321",]$ge.97.5 <- intervals_high["ge"]
nls.param.df2[nls.param.df2$Code == "321",]$phi.97.5 <- intervals_high["phi"]
nls.param.df2[nls.param.df2$Code == "321",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df2[nls.param.df2$Code == "321",]$A.97.5 <- intervals_high["A"]
nls.param.df2[nls.param.df2$Code == "321",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_321.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_321.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_321.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_321.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals

```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_321 <- nlsResiduals(
  get(paste("nls_321.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_321)

## test residuals
if(length(G_321$pltID) < 5001) {test.nlsResiduals(resid_321)}

}  else {print("cannot plot residuals")}
```

## predict and plot

```{r, message = FALSE, cache=T}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

`321_pred2` <- predict(get(paste("nls_321.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME_avg"= rep(mean(G_321$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME_avg"= rep(mean(G_321$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "DeltaPDSI"= rep(mean(G_321$DeltaPDSI, na.rm =T), 1501))
                      } else if (Mod.Sel1 == 3){
                        data.frame("MEASTIME_avg"= rep(mean(G_321$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "B_L_prop"= rep(mean(G_321$B_L_prop, na.rm =T), 1501), 
                                   "DeltaPDSI"= rep(mean(G_321$DeltaPDSI, na.rm =T), 1501))
                      } )


## predicted interval data.frame
`321_pred_df` <- data.frame("B_plt_t1_MgHa" = seq(0,1500,by =1), fitted=`321_pred2`)

## PLOTTING 2
gg.321.2 <- ggplot() +
             geom_jitter(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_321, 
                         alpha = 0.5, color = "#00000080", shape = "+") +
             ## dark ponts = "#1E88E580"
             geom_hline(yintercept =0, lty =3) +
            
             stat_summary_bin(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_321, 
                              fun.data = function(x) {
                                res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                                names(res) <- c("ymin","y","ymax")
                                res}, 
                              col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_321))), breaks = cutvec_321) +         
    
             # geom_ribbon(aes(x = B_plt_t1_MgHa, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
             #             data = 321_pred_df, color="#FF000080", fill ="#FF000080", alpha = 0.25, lty =3) +
             geom_line(aes(x = B_plt_t1_MgHa, y = fitted), data = `321_pred_df`, color="#FF000080", alpha = 0.5, lwd = 2) + 
             ## red = "#D6272880" 
    
             labs(x = expression("biomass (Mg ha"^-1*")"), 
                 y = expression("biomass growth (Mg ha"^-1*" yr"^-1*")")) + 
             ggtitle("321 - Chihuahuan Semi-Desert") +
             theme_classic() + theme(axis.text.x=element_text(angle=90,hjust=1)) + 
             scale_x_continuous(limits = c(0, tail(cutvec_321,1)*1.05), expand =c(0,0))  
             #ylim(c(min(321_pred_df$`Prop.2.5%`)-0.25, max(321_pred_df$`Prop.97.5%`)+0.25))
             #ylim(c(-2,8))
            
gg.321.2

}  else {print("cannot plot data with prediction")}
```

## plotting 2

```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_321 <-data.frame(
  bin = as.factor(levels(cut(G_321$B_plt_t1_MgHa, cutvec_321))),
  data.mean = tapply(G_321$G_obs_TreeInc_MgHaYr, cut(G_321$B_plt_t1_MgHa, cutvec_321), 
                     mean), 
  data.CI.high =  tapply(G_321$G_obs_TreeInc_MgHaYr, cut(G_321$B_plt_t1_MgHa, cutvec_321), 
                    high.CI), 
  data.CI.low = tapply(G_321$G_obs_TreeInc_MgHaYr, cut(G_321$B_plt_t1_MgHa, cutvec_321),
                    low.CI), 
  pred.mean = `321_pred_df`[`321_pred_df`$B_plt_t1_MgHa %in% bin_mids_321,]$fitted) 


### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_321 <-  DM_compare_321 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_321$bin)[gtools::mixedorder(levels(DM_compare_321$bin))]))
                                                                                                        
## ggplot
gg.321.3 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_321) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_321))), 
                              labels = levels(DM_compare_321$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1,  alpha = 0.5) +         
           labs(x = expression("calculated G (Mg ha"^-1*" yr"^-1*")"), 
                y = expression("nls predicted G (Mg ha"^-1*" yr"^-1*")")) +
           ggtitle("321 - Chihuahuan Semi-Desert") +         
           theme_classic() + 
            theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.321.3

}
```


# 322 - American Semidesert and Desert
```{r, echo = F}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_322 <- round(quantile(G_322$B_plt_t1_MgHa, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_322)))){
  cutvec_322 <- round(quantile(G_322$B_plt_t1_MgHa, seq(0,1, length.out = 11)))
}

bin_mids_322 <- unname(round(cutvec_322[-length(cutvec_322)] + diff(cutvec_322)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_322$Plt_B_bin <-  cut(G_322$B_plt_t1_MgHa, cutvec_322)
## get bin means
G_bin_means <- tapply(G_322$G_obs_TreeInc_MgHaYr, cut(G_322$B_plt_t1_MgHa, cutvec_322), mean)

## make column weights.1
G_322$nls_weights <- as.vector(1/G_bin_means[match(G_322$Plt_B_bin, names(G_bin_means))])

}
```

## model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_322.1 <- nls(fg_1, data = G_322, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_322$nls_weights), 
 )

## phi
try(
  nls_322.2 <- nls(fg_2, data=G_322, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_322$nls_weights), 
 )

# phi/alpha
try(
  nls_322.3 <- nls(fg_3 , data = G_322, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_322$nls_weights), 
 )

## test
if(exists("nls_322.1") & exists("nls_322.2") & exists("nls_322.3")){
  print(anova(nls_322.1, nls_322.2, nls_322.3))
} else if(exists("nls_322.2") & exists("nls_322.3")){
  print(anova(nls_322.2, nls_322.3))
} else if(exists("nls_322.1") & exists("nls_322.2")){
  print(anova(nls_322.1, nls_322.2))
}
 
## AIC comparison
AIC1_322 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_322.1"), AIC(get("nls_322.1")), NA),
            ifelse(exists("nls_322.2"), AIC(get("nls_322.2")), NA),
            ifelse(exists("nls_322.3"), AIC(get("nls_322.3")), NA)
            ))

print(AIC1_322) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_322[!is.na(AIC1_322$AIC) & AIC1_322$AIC == min(AIC1_322$AIC, na.rm = T),]$model

try(summary(get(paste("nls_322.",  Mod.Sel1, sep =""))) ) #model summary

}
```
### summary 
* simple model: `r ifelse(exists("nls_322.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_322.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_322.3"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_322.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_322.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_322.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_322.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_322.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_322.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "a", sep ="")), 
          data = G_322,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, p=0.1)},
          weights = G_322$nls_weights))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_322.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "b", sep ="")), 
          data = G_322,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_322$nls_weights)) 
 )

## c-model: with s and p parameters
try(
  assign(
    paste("nls_322.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "c", sep ="")), 
          data = G_322,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_322$nls_weights))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_322.", Mod.Sel1, sep ="")) &
     exists(paste("nls_322.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_322.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_322.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_322.", Mod.Sel1, sep ="")),
             get(paste("nls_322.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_322.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_322.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_322.", Mod.Sel1, sep ="")) &
         exists(paste("nls_322.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_322.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_322.", Mod.Sel1, sep ="")),
               get(paste("nls_322.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_322.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_322.", Mod.Sel1, sep ="")) &
           exists(paste("nls_322.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_322.", Mod.Sel1, sep ="")),
                 get(paste("nls_322.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_322.", Mod.Sel1, sep ="")) &
              exists(paste("nls_322.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_322.", Mod.Sel1, sep ="")),
                    get(paste("nls_322.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_322.", Mod.Sel1, sep ="")) &
                exists(paste("nls_322.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_322.", Mod.Sel1, sep ="")),
                      get(paste("nls_322.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_322 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_322.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_322.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_322.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_322.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_322.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_322.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_322.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_322.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_322)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_322[!is.na(AIC2_322$AIC) & AIC2_322$AIC == min(AIC2_322$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.G[Best_mods.G$Code == "322",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_322.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_322.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df2[nls.param.df2$Code == "322",]$ge <- coefs["ge"]
nls.param.df2[nls.param.df2$Code == "322",]$phi <- coefs["phi"]
nls.param.df2[nls.param.df2$Code == "322",]$alpha <- coefs["alpha"]
nls.param.df2[nls.param.df2$Code == "322",]$A <- coefs["A"]
nls.param.df2[nls.param.df2$Code == "322",]$k <- coefs["k"]

nls.param.df2[nls.param.df2$Code == "322",]$ge.2.5 <- intervals_low["ge"]
nls.param.df2[nls.param.df2$Code == "322",]$phi.2.5 <- intervals_low["phi"]
nls.param.df2[nls.param.df2$Code == "322",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df2[nls.param.df2$Code == "322",]$A.2.5 <- intervals_low["A"]
nls.param.df2[nls.param.df2$Code == "322",]$k.2.5 <- intervals_low["k"]

nls.param.df2[nls.param.df2$Code == "322",]$ge.97.5 <- intervals_high["ge"]
nls.param.df2[nls.param.df2$Code == "322",]$phi.97.5 <- intervals_high["phi"]
nls.param.df2[nls.param.df2$Code == "322",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df2[nls.param.df2$Code == "322",]$A.97.5 <- intervals_high["A"]
nls.param.df2[nls.param.df2$Code == "322",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_322.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_322.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_322.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_322.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals

```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_322 <- nlsResiduals(
  get(paste("nls_322.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_322)

## test residuals
if(length(G_322$pltID) < 5001) {test.nlsResiduals(resid_322)}

}  else {print("cannot plot residuals")}
```

## predict and plot

```{r, message = FALSE, cache=T}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

`322_pred2` <- predict(get(paste("nls_322.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME_avg"= rep(mean(G_322$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME_avg"= rep(mean(G_322$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "DeltaPDSI"= rep(mean(G_322$DeltaPDSI, na.rm =T), 1501))
                      } else if (Mod.Sel1 == 3){
                        data.frame("MEASTIME_avg"= rep(mean(G_322$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "B_L_prop"= rep(mean(G_322$B_L_prop, na.rm =T), 1501), 
                                   "DeltaPDSI"= rep(mean(G_322$DeltaPDSI, na.rm =T), 1501))
                      } )


## predicted interval data.frame
`322_pred_df` <- data.frame("B_plt_t1_MgHa" = seq(0,1500,by =1), fitted=`322_pred2`)

## PLOTTING 2
gg.322.2 <- ggplot() +
             geom_jitter(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_322, 
                         alpha = 0.5, color = "#00000080", shape = "+") +
             ## dark ponts = "#1E88E580"
             geom_hline(yintercept =0, lty =3) +
            
             stat_summary_bin(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_322, 
                              fun.data = function(x) {
                                res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                                names(res) <- c("ymin","y","ymax")
                                res}, 
                              col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_322))), breaks = cutvec_322) +         
    
             # geom_ribbon(aes(x = B_plt_t1_MgHa, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
             #             data = 322_pred_df, color="#FF000080", fill ="#FF000080", alpha = 0.25, lty =3) +
             geom_line(aes(x = B_plt_t1_MgHa, y = fitted), data = `322_pred_df`, color="#FF000080", alpha = 0.5, lwd = 2) + 
             ## red = "#D6272880" 
    
             labs(x = expression("biomass (Mg ha"^-1*")"), 
                 y = expression("biomass growth (Mg ha"^-1*" yr"^-1*")")) + 
             ggtitle("322 - American Semidesert and Desert") +
             theme_classic() + theme(axis.text.x=element_text(angle=90,hjust=1)) + 
             scale_x_continuous(limits = c(0, tail(cutvec_322,1)*1.05), expand =c(0,0)) +
             coord_cartesian(ylim=c(-2, 10))
  
             #ylim(c(min(322_pred_df$`Prop.2.5%`)-0.25, max(322_pred_df$`Prop.97.5%`)+0.25))
             #ylim(c(-2,8))
            
gg.322.2

}  else {print("cannot plot data with prediction")}
```

## plotting 2

```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_322 <-data.frame(
  bin = as.factor(levels(cut(G_322$B_plt_t1_MgHa, cutvec_322))),
  data.mean = tapply(G_322$G_obs_TreeInc_MgHaYr, cut(G_322$B_plt_t1_MgHa, cutvec_322), 
                     mean), 
  data.CI.high =  tapply(G_322$G_obs_TreeInc_MgHaYr, cut(G_322$B_plt_t1_MgHa, cutvec_322), 
                    high.CI), 
  data.CI.low = tapply(G_322$G_obs_TreeInc_MgHaYr, cut(G_322$B_plt_t1_MgHa, cutvec_322),
                    low.CI), 
  pred.mean = `322_pred_df`[`322_pred_df`$B_plt_t1_MgHa %in% bin_mids_322,]$fitted) 


### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_322 <-  DM_compare_322 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_322$bin)[gtools::mixedorder(levels(DM_compare_322$bin))]))
                                                                                                        
## ggplot
gg.322.3 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_322) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_322))), 
                              labels = levels(DM_compare_322$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1,  alpha = 0.5) +         
           labs(x = expression("calculated G (Mg ha"^-1*" yr"^-1*")"), 
                y = expression("nls predicted G (Mg ha"^-1*" yr"^-1*")")) +
           ggtitle("322 - American Semidesert and Desert") +         
           theme_classic() + 
            theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.322.3

}
```


# 331 - Great Plains/Palouse Dry Steppe
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_331 <- round(quantile(G_331$B_plt_t1_MgHa, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_331)))){
  cutvec_331 <- round(quantile(G_331$B_plt_t1_MgHa, seq(0,1, length.out = 11)))
}

bin_mids_331 <- unname(round(cutvec_331[-length(cutvec_331)] + diff(cutvec_331)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_331$Plt_B_bin <-  cut(G_331$B_plt_t1_MgHa, cutvec_331)
## get bin means
G_bin_means <- tapply(G_331$G_obs_TreeInc_MgHaYr, cut(G_331$B_plt_t1_MgHa, cutvec_331), mean)

## make column weights.1
G_331$nls_weights <- as.vector(1/G_bin_means[match(G_331$Plt_B_bin, names(G_bin_means))])

}
```

## model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_331.1 <- nls(fg_1, data = G_331, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_331$nls_weights), 
 )

## phi
try(
  nls_331.2 <- nls(fg_2, data=G_331, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_331$nls_weights), 
 )

# phi/alpha
try(
  nls_331.3 <- nls(fg_3 , data = G_331, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_331$nls_weights), 
 )

## test
if(exists("nls_331.1") & exists("nls_331.2") & exists("nls_331.3")){
  print(anova(nls_331.1, nls_331.2, nls_331.3))
} else if(exists("nls_331.2") & exists("nls_331.3")){
  print(anova(nls_331.2, nls_331.3))
} else if(exists("nls_331.1") & exists("nls_331.2")){
  print(anova(nls_331.1, nls_331.2))
}
 
## AIC comparison
AIC1_331 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_331.1"), AIC(get("nls_331.1")), NA),
            ifelse(exists("nls_331.2"), AIC(get("nls_331.2")), NA),
            ifelse(exists("nls_331.3"), AIC(get("nls_331.3")), NA)
            ))

print(AIC1_331) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_331[!is.na(AIC1_331$AIC) & AIC1_331$AIC == min(AIC1_331$AIC, na.rm = T),]$model

try(summary(get(paste("nls_331.",  Mod.Sel1, sep =""))) ) #model summary

}
```
### summary 
* simple model: `r ifelse(exists("nls_331.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_331.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_331.3"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_331.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_331.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_331.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_331.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_331.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_331.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "a", sep ="")), 
          data = G_331,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_331$nls_weights))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_331.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "b", sep ="")), 
          data = G_331,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_331$nls_weights)) 
 )

## c-model: with s and p parameters
try(
  assign(
    paste("nls_331.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "c", sep ="")), 
          data = G_331,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_331$nls_weights))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_331.", Mod.Sel1, sep ="")) &
     exists(paste("nls_331.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_331.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_331.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_331.", Mod.Sel1, sep ="")),
             get(paste("nls_331.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_331.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_331.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_331.", Mod.Sel1, sep ="")) &
         exists(paste("nls_331.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_331.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_331.", Mod.Sel1, sep ="")),
               get(paste("nls_331.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_331.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_331.", Mod.Sel1, sep ="")) &
           exists(paste("nls_331.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_331.", Mod.Sel1, sep ="")),
                 get(paste("nls_331.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_331.", Mod.Sel1, sep ="")) &
              exists(paste("nls_331.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_331.", Mod.Sel1, sep ="")),
                    get(paste("nls_331.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_331.", Mod.Sel1, sep ="")) &
                exists(paste("nls_331.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_331.", Mod.Sel1, sep ="")),
                      get(paste("nls_331.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_331 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_331.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_331.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_331.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_331.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_331.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_331.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_331.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_331.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_331)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_331[!is.na(AIC2_331$AIC) & AIC2_331$AIC == min(AIC2_331$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.G[Best_mods.G$Code == "331",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_331.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_331.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df2[nls.param.df2$Code == "331",]$ge <- coefs["ge"]
nls.param.df2[nls.param.df2$Code == "331",]$phi <- coefs["phi"]
nls.param.df2[nls.param.df2$Code == "331",]$alpha <- coefs["alpha"]
nls.param.df2[nls.param.df2$Code == "331",]$A <- coefs["A"]
nls.param.df2[nls.param.df2$Code == "331",]$k <- coefs["k"]

nls.param.df2[nls.param.df2$Code == "331",]$ge.2.5 <- intervals_low["ge"]
nls.param.df2[nls.param.df2$Code == "331",]$phi.2.5 <- intervals_low["phi"]
nls.param.df2[nls.param.df2$Code == "331",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df2[nls.param.df2$Code == "331",]$A.2.5 <- intervals_low["A"]
nls.param.df2[nls.param.df2$Code == "331",]$k.2.5 <- intervals_low["k"]

nls.param.df2[nls.param.df2$Code == "331",]$ge.97.5 <- intervals_high["ge"]
nls.param.df2[nls.param.df2$Code == "331",]$phi.97.5 <- intervals_high["phi"]
nls.param.df2[nls.param.df2$Code == "331",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df2[nls.param.df2$Code == "331",]$A.97.5 <- intervals_high["A"]
nls.param.df2[nls.param.df2$Code == "331",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_331.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_331.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_331.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_331.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals

```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_331 <- nlsResiduals(
  get(paste("nls_331.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_331)

## test residuals
if(length(G_331$pltID) < 5001) {test.nlsResiduals(resid_331)}

}  else {print("cannot plot residuals")}
```

## predict and plot

```{r, message = FALSE, cache=T}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

`331_pred2` <- predict(get(paste("nls_331.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME_avg"= rep(mean(G_331$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME_avg"= rep(mean(G_331$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "DeltaPDSI"= rep(mean(G_331$DeltaPDSI, na.rm =T), 1501))
                      } else if (Mod.Sel1 == 3){
                        data.frame("MEASTIME_avg"= rep(mean(G_331$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "B_L_prop"= rep(mean(G_331$B_L_prop, na.rm =T), 1501), 
                                   "DeltaPDSI"= rep(mean(G_331$DeltaPDSI, na.rm =T), 1501))
                      } )


## predicted interval data.frame
`331_pred_df` <- data.frame("B_plt_t1_MgHa" = seq(0,1500,by =1), fitted=`331_pred2`)

## PLOTTING 2
gg.331.2 <- ggplot() +
             geom_jitter(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_331, 
                         alpha = 0.5, color = "#00000080", shape = "+") +
             ## dark ponts = "#1E88E580"
             geom_hline(yintercept =0, lty =3) +
            
             stat_summary_bin(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_331, 
                              fun.data = function(x) {
                                res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                                names(res) <- c("ymin","y","ymax")
                                res}, 
                              col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_331))), breaks = cutvec_331) +         
    
             # geom_ribbon(aes(x = B_plt_t1_MgHa, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
             #             data = 331_pred_df, color="#FF000080", fill ="#FF000080", alpha = 0.25, lty =3) +
             geom_line(aes(x = B_plt_t1_MgHa, y = fitted), data = `331_pred_df`, color="#FF000080", alpha = 0.5, lwd = 2) + 
             ## red = "#D6272880" 
    
             labs(x = expression("biomass (Mg ha"^-1*")"), 
                 y = expression("biomass growth (Mg ha"^-1*" yr"^-1*")")) + 
             ggtitle("331 - Great Plains/Palouse Dry Steppe") +
             theme_classic() + theme(axis.text.x=element_text(angle=90,hjust=1)) + 
             scale_x_continuous(limits = c(0, tail(cutvec_331,1)*1.05), expand =c(0,0)) +
             coord_cartesian(ylim=c(-2, 10))
  
             #ylim(c(min(331_pred_df$`Prop.2.5%`)-0.25, max(331_pred_df$`Prop.97.5%`)+0.25))
             #ylim(c(-2,8))
            
gg.331.2

}  else {print("cannot plot data with prediction")}
```

## plotting 2

```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_331 <-data.frame(
  bin = as.factor(levels(cut(G_331$B_plt_t1_MgHa, cutvec_331))),
  data.mean = tapply(G_331$G_obs_TreeInc_MgHaYr, cut(G_331$B_plt_t1_MgHa, cutvec_331), 
                     mean), 
  data.CI.high =  tapply(G_331$G_obs_TreeInc_MgHaYr, cut(G_331$B_plt_t1_MgHa, cutvec_331), 
                    high.CI), 
  data.CI.low = tapply(G_331$G_obs_TreeInc_MgHaYr, cut(G_331$B_plt_t1_MgHa, cutvec_331),
                    low.CI), 
  pred.mean = `331_pred_df`[`331_pred_df`$B_plt_t1_MgHa %in% bin_mids_331,]$fitted) 


### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_331 <-  DM_compare_331 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_331$bin)[gtools::mixedorder(levels(DM_compare_331$bin))]))
                                                                                                        
## ggplot
gg.331.3 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_331) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_331))), 
                              labels = levels(DM_compare_331$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1,  alpha = 0.5) +         
           labs(x = expression("calculated G (Mg ha"^-1*" yr"^-1*")"), 
                y = expression("nls predicted G (Mg ha"^-1*" yr"^-1*")")) +
           ggtitle("331 - Great Plains/Palouse Dry Steppe") +         
           theme_classic() + 
            theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.331.3

}
```


# 332 - Great Plains Steppe
```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_332 <- round(quantile(G_332$B_plt_t1_MgHa, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_332)))){
  cutvec_332 <- round(quantile(G_332$B_plt_t1_MgHa, seq(0,1, length.out = 11)))
}

bin_mids_332 <- unname(round(cutvec_332[-length(cutvec_332)] + diff(cutvec_332)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_332$Plt_B_bin <-  cut(G_332$B_plt_t1_MgHa, cutvec_332)
## get bin means
G_bin_means <- tapply(G_332$G_obs_TreeInc_MgHaYr, cut(G_332$B_plt_t1_MgHa, cutvec_332), mean)

## make column weights.1
G_332$nls_weights <- as.vector(1/G_bin_means[match(G_332$Plt_B_bin, names(G_bin_means))])

}
```

## model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_332.1 <- nls(fg_1, data = G_332, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_332$nls_weights), 
 )

## phi
try(
  nls_332.2 <- nls(fg_2, data=G_332, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_332$nls_weights), 
 )

# phi/alpha
try(
  nls_332.3 <- nls(fg_3 , data = G_332, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_332$nls_weights), 
 )

## test
if(exists("nls_332.1") & exists("nls_332.2") & exists("nls_332.3")){
  print(anova(nls_332.1, nls_332.2, nls_332.3))
} else if(exists("nls_332.2") & exists("nls_332.3")){
  print(anova(nls_332.2, nls_332.3))
} else if(exists("nls_332.1") & exists("nls_332.2")){
  print(anova(nls_332.1, nls_332.2))
}
 
## AIC comparison
AIC1_332 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_332.1"), AIC(get("nls_332.1")), NA),
            ifelse(exists("nls_332.2"), AIC(get("nls_332.2")), NA),
            ifelse(exists("nls_332.3"), AIC(get("nls_332.3")), NA)
            ))

print(AIC1_332) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_332[!is.na(AIC1_332$AIC) & AIC1_332$AIC == min(AIC1_332$AIC, na.rm = T),]$model

try(summary(get(paste("nls_332.",  Mod.Sel1, sep =""))) ) #model summary

}
```
### summary 
* simple model: `r ifelse(exists("nls_332.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_332.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_332.3"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_332.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_332.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_332.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_332.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_332.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_332.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "a", sep ="")), 
          data = G_332,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_332$nls_weights))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_332.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "b", sep ="")), 
          data = G_332,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_332$nls_weights)) 
 )

## c-model: with s and p parameters
try(
  assign(
    paste("nls_332.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "c", sep ="")), 
          data = G_332,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_332$nls_weights))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_332.", Mod.Sel1, sep ="")) &
     exists(paste("nls_332.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_332.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_332.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_332.", Mod.Sel1, sep ="")),
             get(paste("nls_332.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_332.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_332.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_332.", Mod.Sel1, sep ="")) &
         exists(paste("nls_332.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_332.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_332.", Mod.Sel1, sep ="")),
               get(paste("nls_332.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_332.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_332.", Mod.Sel1, sep ="")) &
           exists(paste("nls_332.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_332.", Mod.Sel1, sep ="")),
                 get(paste("nls_332.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_332.", Mod.Sel1, sep ="")) &
              exists(paste("nls_332.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_332.", Mod.Sel1, sep ="")),
                    get(paste("nls_332.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_332.", Mod.Sel1, sep ="")) &
                exists(paste("nls_332.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_332.", Mod.Sel1, sep ="")),
                      get(paste("nls_332.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_332 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_332.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_332.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_332.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_332.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_332.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_332.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_332.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_332.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_332)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_332[!is.na(AIC2_332$AIC) & AIC2_332$AIC == min(AIC2_332$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.G[Best_mods.G$Code == "332",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_332.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_332.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df2[nls.param.df2$Code == "332",]$ge <- coefs["ge"]
nls.param.df2[nls.param.df2$Code == "332",]$phi <- coefs["phi"]
nls.param.df2[nls.param.df2$Code == "332",]$alpha <- coefs["alpha"]
nls.param.df2[nls.param.df2$Code == "332",]$A <- coefs["A"]
nls.param.df2[nls.param.df2$Code == "332",]$k <- coefs["k"]

nls.param.df2[nls.param.df2$Code == "332",]$ge.2.5 <- intervals_low["ge"]
nls.param.df2[nls.param.df2$Code == "332",]$phi.2.5 <- intervals_low["phi"]
nls.param.df2[nls.param.df2$Code == "332",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df2[nls.param.df2$Code == "332",]$A.2.5 <- intervals_low["A"]
nls.param.df2[nls.param.df2$Code == "332",]$k.2.5 <- intervals_low["k"]

nls.param.df2[nls.param.df2$Code == "332",]$ge.97.5 <- intervals_high["ge"]
nls.param.df2[nls.param.df2$Code == "332",]$phi.97.5 <- intervals_high["phi"]
nls.param.df2[nls.param.df2$Code == "332",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df2[nls.param.df2$Code == "332",]$A.97.5 <- intervals_high["A"]
nls.param.df2[nls.param.df2$Code == "332",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_332.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_332.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_332.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_332.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals

```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_332 <- nlsResiduals(
  get(paste("nls_332.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_332)

## test residuals
if(length(G_332$pltID) < 5001) {test.nlsResiduals(resid_332)}

}  else {print("cannot plot residuals")}
```

## predict and plot

```{r, message = FALSE, cache=T}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

`332_pred2` <- predict(get(paste("nls_332.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME_avg"= rep(mean(G_332$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME_avg"= rep(mean(G_332$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "DeltaPDSI"= rep(mean(G_332$DeltaPDSI, na.rm =T), 1501))
                      } else if (Mod.Sel1 == 3){
                        data.frame("MEASTIME_avg"= rep(mean(G_332$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "B_L_prop"= rep(mean(G_332$B_L_prop, na.rm =T), 1501), 
                                   "DeltaPDSI"= rep(mean(G_332$DeltaPDSI, na.rm =T), 1501))
                      } )


## predicted interval data.frame
`332_pred_df` <- data.frame("B_plt_t1_MgHa" = seq(0,1500,by =1), fitted=`332_pred2`)

## PLOTTING 2
gg.332.2 <- ggplot() +
             geom_jitter(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_332, 
                         alpha = 0.5, color = "#00000080", shape = "+") +
             ## dark ponts = "#1E88E580"
             geom_hline(yintercept =0, lty =3) +
            
             stat_summary_bin(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_332, 
                              fun.data = function(x) {
                                res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                                names(res) <- c("ymin","y","ymax")
                                res}, 
                              col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_332)+1)), breaks = cutvec_332) +         
    
             # geom_ribbon(aes(x = B_plt_t1_MgHa, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
             #             data = 332_pred_df, color="#FF000080", fill ="#FF000080", alpha = 0.25, lty =3) +
             geom_line(aes(x = B_plt_t1_MgHa, y = fitted), data = `332_pred_df`, color="#FF000080", alpha = 0.5, lwd = 2) + 
             ## red = "#D6272880" 
    
             labs(x = expression("biomass (Mg ha"^-1*")"), 
                 y = expression("biomass growth (Mg ha"^-1*" yr"^-1*")")) + 
             ggtitle("332 - Southwest Plateau and Plains Dry Steppe and Shrub") +
             theme_classic() + theme(axis.text.x=element_text(angle=90,hjust=1)) + 
             scale_x_continuous(limits = c(0, tail(cutvec_332,1)*1.05), expand =c(0,0)) +
             coord_cartesian(ylim=c(-2, 10))
  
             #ylim(c(min(332_pred_df$`Prop.2.5%`)-0.25, max(332_pred_df$`Prop.97.5%`)+0.25))
             #ylim(c(-2,8))
            
gg.332.2

}  else {print("cannot plot data with prediction")}
```

## plotting 2

```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_332 <-data.frame(
  bin = as.factor(levels(cut(G_332$B_plt_t1_MgHa, cutvec_332))),
  data.mean = tapply(G_332$G_obs_TreeInc_MgHaYr, cut(G_332$B_plt_t1_MgHa, cutvec_332), 
                     mean), 
  data.CI.high =  tapply(G_332$G_obs_TreeInc_MgHaYr, cut(G_332$B_plt_t1_MgHa, cutvec_332), 
                    high.CI), 
  data.CI.low = tapply(G_332$G_obs_TreeInc_MgHaYr, cut(G_332$B_plt_t1_MgHa, cutvec_332),
                    low.CI), 
  pred.mean = `332_pred_df`[`332_pred_df`$B_plt_t1_MgHa %in% bin_mids_332,]$fitted) 


### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_332 <-  DM_compare_332 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_332$bin)[gtools::mixedorder(levels(DM_compare_332$bin))]))
                                                                                                        
## ggplot
gg.332.3 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_332) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_332))), 
                              labels = levels(DM_compare_332$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1,  alpha = 0.5) +         
           labs(x = expression("calculated G (Mg ha"^-1*" yr"^-1*")"), 
                y = expression("nls predicted G (Mg ha"^-1*" yr"^-1*")")) +
           ggtitle("332 - Southwest Plateau and Plains Dry Steppe and Shrub") +         
           theme_classic() + 
            theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.332.3

}
```


# 341 - Intermountain Semi-desert & Desert

```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_341 <- round(quantile(G_341$B_plt_t1_MgHa, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_341)))){
  cutvec_341 <- round(quantile(G_341$B_plt_t1_MgHa, seq(0,1, length.out = 11)))
}

bin_mids_341 <- unname(round(cutvec_341[-length(cutvec_341)] + diff(cutvec_341)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_341$Plt_B_bin <-  cut(G_341$B_plt_t1_MgHa, cutvec_341)
## get bin means
G_bin_means <- tapply(G_341$G_obs_TreeInc_MgHaYr, cut(G_341$B_plt_t1_MgHa, cutvec_341), mean)

## make column weights.1
G_341$nls_weights <- as.vector(1/G_bin_means[match(G_341$Plt_B_bin, names(G_bin_means))])

}
```

## model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_341.1 <- nls(fg_1, data = G_341, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_341$nls_weights), 
 )

## phi
try(
  nls_341.2 <- nls(fg_2, data=G_341, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_341$nls_weights), 
 )

# phi/alpha
try(
  nls_341.3 <- nls(fg_3 , data = G_341, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_341$nls_weights), 
 )

## test
if(exists("nls_341.1") & exists("nls_341.2") & exists("nls_341.3")){
  print(anova(nls_341.1, nls_341.2, nls_341.3))
} else if(exists("nls_341.2") & exists("nls_341.3")){
  print(anova(nls_341.2, nls_341.3))
} else if(exists("nls_341.1") & exists("nls_341.2")){
  print(anova(nls_341.1, nls_341.2))
}
 
## AIC comparison
AIC1_341 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_341.1"), AIC(get("nls_341.1")), NA),
            ifelse(exists("nls_341.2"), AIC(get("nls_341.2")), NA),
            ifelse(exists("nls_341.3"), AIC(get("nls_341.3")), NA)
            ))

print(AIC1_341) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_341[!is.na(AIC1_341$AIC) & AIC1_341$AIC == min(AIC1_341$AIC, na.rm = T),]$model

try(summary(get(paste("nls_341.",  Mod.Sel1, sep =""))) ) #model summary

}
```
### summary 
* simple model: `r ifelse(exists("nls_341.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_341.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_341.3"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_341.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_341.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_341.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_341.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_341.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_341.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "a", sep ="")), 
          data = G_341,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_341$nls_weights))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_341.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "b", sep ="")), 
          data = G_341,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_341$nls_weights)) 
 )

## c-model: with s and p parameters
try(
  assign(
    paste("nls_341.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "c", sep ="")), 
          data = G_341,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_341$nls_weights))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_341.", Mod.Sel1, sep ="")) &
     exists(paste("nls_341.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_341.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_341.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_341.", Mod.Sel1, sep ="")),
             get(paste("nls_341.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_341.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_341.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_341.", Mod.Sel1, sep ="")) &
         exists(paste("nls_341.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_341.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_341.", Mod.Sel1, sep ="")),
               get(paste("nls_341.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_341.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_341.", Mod.Sel1, sep ="")) &
           exists(paste("nls_341.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_341.", Mod.Sel1, sep ="")),
                 get(paste("nls_341.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_341.", Mod.Sel1, sep ="")) &
              exists(paste("nls_341.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_341.", Mod.Sel1, sep ="")),
                    get(paste("nls_341.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_341.", Mod.Sel1, sep ="")) &
                exists(paste("nls_341.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_341.", Mod.Sel1, sep ="")),
                      get(paste("nls_341.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_341 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_341.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_341.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_341.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_341.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_341.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_341.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_341.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_341.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_341)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_341[!is.na(AIC2_341$AIC) & AIC2_341$AIC == min(AIC2_341$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.G[Best_mods.G$Code == "341",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_341.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_341.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df2[nls.param.df2$Code == "341",]$ge <- coefs["ge"]
nls.param.df2[nls.param.df2$Code == "341",]$phi <- coefs["phi"]
nls.param.df2[nls.param.df2$Code == "341",]$alpha <- coefs["alpha"]
nls.param.df2[nls.param.df2$Code == "341",]$A <- coefs["A"]
nls.param.df2[nls.param.df2$Code == "341",]$k <- coefs["k"]

nls.param.df2[nls.param.df2$Code == "341",]$ge.2.5 <- intervals_low["ge"]
nls.param.df2[nls.param.df2$Code == "341",]$phi.2.5 <- intervals_low["phi"]
nls.param.df2[nls.param.df2$Code == "341",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df2[nls.param.df2$Code == "341",]$A.2.5 <- intervals_low["A"]
nls.param.df2[nls.param.df2$Code == "341",]$k.2.5 <- intervals_low["k"]

nls.param.df2[nls.param.df2$Code == "341",]$ge.97.5 <- intervals_high["ge"]
nls.param.df2[nls.param.df2$Code == "341",]$phi.97.5 <- intervals_high["phi"]
nls.param.df2[nls.param.df2$Code == "341",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df2[nls.param.df2$Code == "341",]$A.97.5 <- intervals_high["A"]
nls.param.df2[nls.param.df2$Code == "341",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_341.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_341.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_341.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_341.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals

```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_341 <- nlsResiduals(
  get(paste("nls_341.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_341)

## test residuals
if(length(G_341$pltID) < 5001) {test.nlsResiduals(resid_341)}

}  else {print("cannot plot residuals")}
```

## predict and plot

```{r, message = FALSE, cache=T}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

`341_pred2` <- predict(get(paste("nls_341.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME_avg"= rep(mean(G_341$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME_avg"= rep(mean(G_341$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "DeltaPDSI"= rep(mean(G_341$DeltaPDSI, na.rm =T), 1501))
                      } else if (Mod.Sel1 == 3){
                        data.frame("MEASTIME_avg"= rep(mean(G_341$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "B_L_prop"= rep(mean(G_341$B_L_prop, na.rm =T), 1501), 
                                   "DeltaPDSI"= rep(mean(G_341$DeltaPDSI, na.rm =T), 1501))
                      } )


## predicted interval data.frame
`341_pred_df` <- data.frame("B_plt_t1_MgHa" = seq(0,1500,by =1), fitted=`341_pred2`)

## PLOTTING 2
gg.341.2 <- ggplot() +
             geom_jitter(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_341, 
                         alpha = 0.5, color = "#00000080", shape = "+") +
             ## dark ponts = "#1E88E580"
             geom_hline(yintercept =0, lty =3) +
            
             stat_summary_bin(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_341, 
                              fun.data = function(x) {
                                res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                                names(res) <- c("ymin","y","ymax")
                                res}, 
                              col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_341))), breaks = cutvec_341) +         
    
             # geom_ribbon(aes(x = B_plt_t1_MgHa, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
             #             data = 341_pred_df, color="#FF000080", fill ="#FF000080", alpha = 0.25, lty =3) +
             geom_line(aes(x = B_plt_t1_MgHa, y = fitted), data = `341_pred_df`, color="#FF000080", alpha = 0.5, lwd = 2) + 
             ## red = "#D6272880" 
    
             labs(x = expression("biomass (Mg ha"^-1*")"), 
                 y = expression("biomass growth (Mg ha"^-1*" yr"^-1*")")) + 
             ggtitle("341 - Nevada-Utah Mountains Semi-Desert - Coniferous Forest - Alpine Meadow") +
             theme_classic() + theme(axis.text.x=element_text(angle=90,hjust=1)) + 
             scale_x_continuous(limits = c(0, tail(cutvec_341,1)*1.05), expand =c(0,0)) +
             coord_cartesian(ylim=c(-2, 10))
  
             #ylim(c(min(341_pred_df$`Prop.2.5%`)-0.25, max(341_pred_df$`Prop.97.5%`)+0.25))
             #ylim(c(-2,8))
            
gg.341.2

}  else {print("cannot plot data with prediction")}
```

## plotting 2

```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_341 <-data.frame(
  bin = as.factor(levels(cut(G_341$B_plt_t1_MgHa, cutvec_341))),
  data.mean = tapply(G_341$G_obs_TreeInc_MgHaYr, cut(G_341$B_plt_t1_MgHa, cutvec_341), 
                     mean), 
  data.CI.high =  tapply(G_341$G_obs_TreeInc_MgHaYr, cut(G_341$B_plt_t1_MgHa, cutvec_341), 
                    high.CI), 
  data.CI.low = tapply(G_341$G_obs_TreeInc_MgHaYr, cut(G_341$B_plt_t1_MgHa, cutvec_341),
                    low.CI), 
  pred.mean = `341_pred_df`[`341_pred_df`$B_plt_t1_MgHa %in% bin_mids_341,]$fitted) 


### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_341 <-  DM_compare_341 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_341$bin)[gtools::mixedorder(levels(DM_compare_341$bin))]))
                                                                                                        
## ggplot
gg.341.3 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_341) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_341))), 
                              labels = levels(DM_compare_341$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1,  alpha = 0.5) +         
           labs(x = expression("calculated G (Mg ha"^-1*" yr"^-1*")"), 
                y = expression("nls predicted G (Mg ha"^-1*" yr"^-1*")")) +
           ggtitle("341 - Nevada-Utah Mountains Semi-Desert - Coniferous Forest - Alpine Meadow") +         
           theme_classic() + 
            theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.341.3

}
```


# 342 - Intermountain Semi-Desert

```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_342 <- round(quantile(G_342$B_plt_t1_MgHa, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_342)))){
  cutvec_342 <- round(quantile(G_342$B_plt_t1_MgHa, seq(0,1, length.out = 11)))
}

bin_mids_342 <- unname(round(cutvec_342[-length(cutvec_342)] + diff(cutvec_342)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_342$Plt_B_bin <-  cut(G_342$B_plt_t1_MgHa, cutvec_342)
## get bin means
G_bin_means <- tapply(G_342$G_obs_TreeInc_MgHaYr, cut(G_342$B_plt_t1_MgHa, cutvec_342), mean)

## make column weights.1
G_342$nls_weights <- as.vector(1/G_bin_means[match(G_342$Plt_B_bin, names(G_bin_means))])

}
```

## model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_342.1 <- nls(fg_1, data = G_342, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_342$nls_weights), 
 )

## phi
try(
  nls_342.2 <- nls(fg_2, data=G_342, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_342$nls_weights), 
 )

# phi/alpha
try(
  nls_342.3 <- nls(fg_3 , data = G_342, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_342$nls_weights), 
 )

## test
if(exists("nls_342.1") & exists("nls_342.2") & exists("nls_342.3")){
  print(anova(nls_342.1, nls_342.2, nls_342.3))
} else if(exists("nls_342.2") & exists("nls_342.3")){
  print(anova(nls_342.2, nls_342.3))
} else if(exists("nls_342.1") & exists("nls_342.2")){
  print(anova(nls_342.1, nls_342.2))
}
 
## AIC comparison
AIC1_342 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_342.1"), AIC(get("nls_342.1")), NA),
            ifelse(exists("nls_342.2"), AIC(get("nls_342.2")), NA),
            ifelse(exists("nls_342.3"), AIC(get("nls_342.3")), NA)
            ))

print(AIC1_342) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_342[!is.na(AIC1_342$AIC) & AIC1_342$AIC == min(AIC1_342$AIC, na.rm = T),]$model

try(summary(get(paste("nls_342.",  Mod.Sel1, sep =""))) ) #model summary

}
```
### summary 
* simple model: `r ifelse(exists("nls_342.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_342.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_342.3"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_342.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_342.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_342.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_342.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_342.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_342.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "a", sep ="")), 
          data = G_342,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_342$nls_weights))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_342.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "b", sep ="")), 
          data = G_342,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_342$nls_weights)) 
 )

## c-model: with s and p parameters
try(
  assign(
    paste("nls_342.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "c", sep ="")), 
          data = G_342,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_342$nls_weights))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_342.", Mod.Sel1, sep ="")) &
     exists(paste("nls_342.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_342.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_342.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_342.", Mod.Sel1, sep ="")),
             get(paste("nls_342.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_342.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_342.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_342.", Mod.Sel1, sep ="")) &
         exists(paste("nls_342.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_342.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_342.", Mod.Sel1, sep ="")),
               get(paste("nls_342.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_342.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_342.", Mod.Sel1, sep ="")) &
           exists(paste("nls_342.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_342.", Mod.Sel1, sep ="")),
                 get(paste("nls_342.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_342.", Mod.Sel1, sep ="")) &
              exists(paste("nls_342.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_342.", Mod.Sel1, sep ="")),
                    get(paste("nls_342.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_342.", Mod.Sel1, sep ="")) &
                exists(paste("nls_342.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_342.", Mod.Sel1, sep ="")),
                      get(paste("nls_342.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_342 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_342.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_342.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_342.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_342.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_342.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_342.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_342.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_342.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_342)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_342[!is.na(AIC2_342$AIC) & AIC2_342$AIC == min(AIC2_342$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.G[Best_mods.G$Code == "342",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_342.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_342.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df2[nls.param.df2$Code == "342",]$ge <- coefs["ge"]
nls.param.df2[nls.param.df2$Code == "342",]$phi <- coefs["phi"]
nls.param.df2[nls.param.df2$Code == "342",]$alpha <- coefs["alpha"]
nls.param.df2[nls.param.df2$Code == "342",]$A <- coefs["A"]
nls.param.df2[nls.param.df2$Code == "342",]$k <- coefs["k"]

nls.param.df2[nls.param.df2$Code == "342",]$ge.2.5 <- intervals_low["ge"]
nls.param.df2[nls.param.df2$Code == "342",]$phi.2.5 <- intervals_low["phi"]
nls.param.df2[nls.param.df2$Code == "342",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df2[nls.param.df2$Code == "342",]$A.2.5 <- intervals_low["A"]
nls.param.df2[nls.param.df2$Code == "342",]$k.2.5 <- intervals_low["k"]

nls.param.df2[nls.param.df2$Code == "342",]$ge.97.5 <- intervals_high["ge"]
nls.param.df2[nls.param.df2$Code == "342",]$phi.97.5 <- intervals_high["phi"]
nls.param.df2[nls.param.df2$Code == "342",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df2[nls.param.df2$Code == "342",]$A.97.5 <- intervals_high["A"]
nls.param.df2[nls.param.df2$Code == "342",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_342.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_342.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_342.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_342.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals

```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_342 <- nlsResiduals(
  get(paste("nls_342.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_342)

## test residuals
if(length(G_342$pltID) < 5001) {test.nlsResiduals(resid_342)}

}  else {print("cannot plot residuals")}
```

## predict and plot

```{r, message = FALSE, cache=T}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

`342_pred2` <- predict(get(paste("nls_342.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME_avg"= rep(mean(G_342$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME_avg"= rep(mean(G_342$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "DeltaPDSI"= rep(mean(G_342$DeltaPDSI, na.rm =T), 1501))
                      } else if (Mod.Sel1 == 3){
                        data.frame("MEASTIME_avg"= rep(mean(G_342$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "B_L_prop"= rep(mean(G_342$B_L_prop, na.rm =T), 1501), 
                                   "DeltaPDSI"= rep(mean(G_342$DeltaPDSI, na.rm =T), 1501))
                      } )


## predicted interval data.frame
`342_pred_df` <- data.frame("B_plt_t1_MgHa" = seq(0,1500,by =1), fitted=`342_pred2`)

## PLOTTING 2
gg.342.2 <- ggplot() +
             geom_jitter(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_342, 
                         alpha = 0.5, color = "#00000080", shape = "+") +
             ## dark ponts = "#1E88E580"
             geom_hline(yintercept =0, lty =3) +
            
             stat_summary_bin(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_342, 
                              fun.data = function(x) {
                                res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                                names(res) <- c("ymin","y","ymax")
                                res}, 
                              col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_342))), breaks = cutvec_342) +         
    
             # geom_ribbon(aes(x = B_plt_t1_MgHa, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
             #             data = 342_pred_df, color="#FF000080", fill ="#FF000080", alpha = 0.25, lty =3) +
             geom_line(aes(x = B_plt_t1_MgHa, y = fitted), data = `342_pred_df`, color="#FF000080", alpha = 0.5, lwd = 2) + 
             ## red = "#D6272880" 
    
             labs(x = expression("biomass (Mg ha"^-1*")"), 
                 y = expression("biomass growth (Mg ha"^-1*" yr"^-1*")")) + 
             ggtitle("342 - Intermountain Semi-Desert") +
             theme_classic() + theme(axis.text.x=element_text(angle=90,hjust=1)) + 
             scale_x_continuous(limits = c(0, tail(cutvec_342,1)*1.05), expand =c(0,0))  +
             coord_cartesian(ylim=c(-2, 10))
 
             #ylim(c(min(342_pred_df$`Prop.2.5%`)-0.25, max(342_pred_df$`Prop.97.5%`)+0.25))
             #ylim(c(-2,8))
            
gg.342.2

}  else {print("cannot plot data with prediction")}
```

## plotting 2

```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_342 <-data.frame(
  bin = as.factor(levels(cut(G_342$B_plt_t1_MgHa, cutvec_342))),
  data.mean = tapply(G_342$G_obs_TreeInc_MgHaYr, cut(G_342$B_plt_t1_MgHa, cutvec_342), 
                     mean), 
  data.CI.high =  tapply(G_342$G_obs_TreeInc_MgHaYr, cut(G_342$B_plt_t1_MgHa, cutvec_342), 
                    high.CI), 
  data.CI.low = tapply(G_342$G_obs_TreeInc_MgHaYr, cut(G_342$B_plt_t1_MgHa, cutvec_342),
                    low.CI), 
  pred.mean = `342_pred_df`[`342_pred_df`$B_plt_t1_MgHa %in% bin_mids_342,]$fitted) 


### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_342 <-  DM_compare_342 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_342$bin)[gtools::mixedorder(levels(DM_compare_342$bin))]))
                                                                                                        
## ggplot
gg.342.3 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_342) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_342))), 
                              labels = levels(DM_compare_342$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1,  alpha = 0.5) +         
           labs(x = expression("calculated G (Mg ha"^-1*" yr"^-1*")"), 
                y = expression("nls predicted G (Mg ha"^-1*" yr"^-1*")")) +
           ggtitle("342 - Intermountain Semi-Desert") +         
           theme_classic() + 
            theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.342.3

}
```

# 411 - Everglades
```{r, echo = F}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_411 <- round(quantile(G_411$B_plt_t1_MgHa, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_411)))){
  cutvec_411 <- round(quantile(G_411$B_plt_t1_MgHa, seq(0,1, length.out = 11)))
}

bin_mids_411 <- unname(round(cutvec_411[-length(cutvec_411)] + diff(cutvec_411)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_411$Plt_B_bin <-  cut(G_411$B_plt_t1_MgHa, cutvec_411)
## get bin means
G_bin_means <- tapply(G_411$G_obs_TreeInc_MgHaYr, cut(G_411$B_plt_t1_MgHa, cutvec_411), mean)

## make column weights.1
G_411$nls_weights <- as.vector(1/G_bin_means[match(G_411$Plt_B_bin, names(G_bin_means))])

}
```

## model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_411.1 <- nls(fg_1, data = G_411, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_411$nls_weights), 
 )

## phi
try(
  nls_411.2 <- nls(fg_2, data=G_411, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_411$nls_weights), 
 )

# phi/alpha
try(
  nls_411.3 <- nls(fg_3 , data = G_411, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_411$nls_weights), 
 )

## test
if(exists("nls_411.1") & exists("nls_411.2") & exists("nls_411.3")){
  print(anova(nls_411.1, nls_411.2, nls_411.3))
} else if(exists("nls_411.2") & exists("nls_411.3")){
  print(anova(nls_411.2, nls_411.3))
} else if(exists("nls_411.1") & exists("nls_411.2")){
  print(anova(nls_411.1, nls_411.2))
}
 
## AIC comparison
AIC1_411 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_411.1"), AIC(get("nls_411.1")), NA),
            ifelse(exists("nls_411.2"), AIC(get("nls_411.2")), NA),
            ifelse(exists("nls_411.3"), AIC(get("nls_411.3")), NA)
            ))

print(AIC1_411) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_411[!is.na(AIC1_411$AIC) & AIC1_411$AIC == min(AIC1_411$AIC, na.rm = T),]$model

try(summary(get(paste("nls_411.",  Mod.Sel1, sep =""))) ) #model summary

}
```
### summary 
* simple model: `r ifelse(exists("nls_411.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_411.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_411.3"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_411.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_411.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_411.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_411.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_411.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_411.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "a", sep ="")), 
          data = G_411,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_411$nls_weights))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_411.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "b", sep ="")), 
          data = G_411,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_411$nls_weights)) 
 )

## c-model: with s and p parameters
try(
  assign(
    paste("nls_411.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "c", sep ="")), 
          data = G_411,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_411$nls_weights))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_411.", Mod.Sel1, sep ="")) &
     exists(paste("nls_411.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_411.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_411.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_411.", Mod.Sel1, sep ="")),
             get(paste("nls_411.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_411.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_411.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_411.", Mod.Sel1, sep ="")) &
         exists(paste("nls_411.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_411.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_411.", Mod.Sel1, sep ="")),
               get(paste("nls_411.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_411.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_411.", Mod.Sel1, sep ="")) &
           exists(paste("nls_411.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_411.", Mod.Sel1, sep ="")),
                 get(paste("nls_411.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_411.", Mod.Sel1, sep ="")) &
              exists(paste("nls_411.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_411.", Mod.Sel1, sep ="")),
                    get(paste("nls_411.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_411.", Mod.Sel1, sep ="")) &
                exists(paste("nls_411.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_411.", Mod.Sel1, sep ="")),
                      get(paste("nls_411.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_411 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_411.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_411.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_411.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_411.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_411.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_411.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_411.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_411.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_411)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_411[!is.na(AIC2_411$AIC) & AIC2_411$AIC == min(AIC2_411$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.G[Best_mods.G$Code == "411",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_411.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_411.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df2[nls.param.df2$Code == "411",]$ge <- coefs["ge"]
nls.param.df2[nls.param.df2$Code == "411",]$phi <- coefs["phi"]
nls.param.df2[nls.param.df2$Code == "411",]$alpha <- coefs["alpha"]
nls.param.df2[nls.param.df2$Code == "411",]$A <- coefs["A"]
nls.param.df2[nls.param.df2$Code == "411",]$k <- coefs["k"]

nls.param.df2[nls.param.df2$Code == "411",]$ge.2.5 <- intervals_low["ge"]
nls.param.df2[nls.param.df2$Code == "411",]$phi.2.5 <- intervals_low["phi"]
nls.param.df2[nls.param.df2$Code == "411",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df2[nls.param.df2$Code == "411",]$A.2.5 <- intervals_low["A"]
nls.param.df2[nls.param.df2$Code == "411",]$k.2.5 <- intervals_low["k"]

nls.param.df2[nls.param.df2$Code == "411",]$ge.97.5 <- intervals_high["ge"]
nls.param.df2[nls.param.df2$Code == "411",]$phi.97.5 <- intervals_high["phi"]
nls.param.df2[nls.param.df2$Code == "411",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df2[nls.param.df2$Code == "411",]$A.97.5 <- intervals_high["A"]
nls.param.df2[nls.param.df2$Code == "411",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_411.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_411.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_411.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_411.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals

```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_411 <- nlsResiduals(
  get(paste("nls_411.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_411)

## test residuals
if(length(G_411$pltID) < 5001) {test.nlsResiduals(resid_411)}

}  else {print("cannot plot residuals")}
```

## predict and plot

```{r, message = FALSE, cache=T}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

`411_pred2` <- predict(get(paste("nls_411.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME_avg"= rep(mean(G_411$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME_avg"= rep(mean(G_411$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "DeltaPDSI"= rep(mean(G_411$DeltaPDSI, na.rm =T), 1501))
                      } else if (Mod.Sel1 == 3){
                        data.frame("MEASTIME_avg"= rep(mean(G_411$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "B_L_prop"= rep(mean(G_411$B_L_prop, na.rm =T), 1501), 
                                   "DeltaPDSI"= rep(mean(G_411$DeltaPDSI, na.rm =T), 1501))
                      } )

## predicted interval data.frame
`411_pred_df` <- data.frame("B_plt_t1_MgHa" = seq(0,1500,by =1), fitted=`411_pred2`)

## PLOTTING 2
gg.411.2 <- ggplot() +
             geom_jitter(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_411, 
                         alpha = 0.5, color = "#00000080", shape = "+") +
             ## dark ponts = "#1E88E580"
             geom_hline(yintercept =0, lty =3) +
            
             stat_summary_bin(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_411, 
                              fun.data = function(x) {
                                res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                                names(res) <- c("ymin","y","ymax")
                                res}, 
                              col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_411))), breaks = cutvec_411) +         
    
             # geom_ribbon(aes(x = B_plt_t1_MgHa, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
             #             data = 411_pred_df, color="#FF000080", fill ="#FF000080", alpha = 0.25, lty =3) +
             geom_line(aes(x = B_plt_t1_MgHa, y = fitted), data = `411_pred_df`, color="#FF000080", alpha = 0.5, lwd = 2) + 
             ## red = "#D6272880" 
    
             labs(x = expression("biomass (Mg ha"^-1*")"), 
                 y = expression("biomass growth (Mg ha"^-1*" yr"^-1*")")) + 
             ggtitle("411 - Everglades") +
             theme_classic() + theme(axis.text.x=element_text(angle=90,hjust=1)) + 
             scale_x_continuous(limits = c(0, tail(cutvec_411,1)*1.05), expand =c(0,0)) +
             coord_cartesian(ylim=c(-2, 10))
  
             #ylim(c(min(411_pred_df$`Prop.2.5%`)-0.25, max(411_pred_df$`Prop.97.5%`)+0.25))
             #ylim(c(-2,8))
            
gg.411.2

}  else {print("cannot plot data with prediction")}
```

## plotting 2

```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_411 <-data.frame(
  bin = as.factor(levels(cut(G_411$B_plt_t1_MgHa, cutvec_411))),
  data.mean = tapply(G_411$G_obs_TreeInc_MgHaYr, cut(G_411$B_plt_t1_MgHa, cutvec_411), 
                     mean), 
  data.CI.high =  tapply(G_411$G_obs_TreeInc_MgHaYr, cut(G_411$B_plt_t1_MgHa, cutvec_411), 
                    high.CI), 
  data.CI.low = tapply(G_411$G_obs_TreeInc_MgHaYr, cut(G_411$B_plt_t1_MgHa, cutvec_411),
                    low.CI), 
  pred.mean = `411_pred_df`[`411_pred_df`$B_plt_t1_MgHa %in% bin_mids_411,]$fitted) 


### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_411 <-  DM_compare_411 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_411$bin)[gtools::mixedorder(levels(DM_compare_411$bin))]))
                                                                                                        
## ggplot
gg.411.3 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_411) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_411))), 
                              labels = levels(DM_compare_411$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1,  alpha = 0.5) +         
           labs(x = expression("calculated G (Mg ha"^-1*" yr"^-1*")"), 
                y = expression("nls predicted G (Mg ha"^-1*" yr"^-1*")")) +
           ggtitle("411 - Everglades") +         
           theme_classic() + 
            theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.411.3

}
```

# M211 - Adirondack-New England Mixed forest - Coniferous Forest - Alpine Meadow

```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_M211 <- round(quantile(G_M211$B_plt_t1_MgHa, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M211)))){
  cutvec_M211 <- round(quantile(G_M211$B_plt_t1_MgHa, seq(0,1, length.out = 11)))
}

bin_mids_M211 <- unname(round(cutvec_M211[-length(cutvec_M211)] + diff(cutvec_M211)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_M211$Plt_B_bin <-  cut(G_M211$B_plt_t1_MgHa, cutvec_M211)
## get bin means
G_bin_means <- tapply(G_M211$G_obs_TreeInc_MgHaYr, cut(G_M211$B_plt_t1_MgHa, cutvec_M211), mean)

## make column weights.1
G_M211$nls_weights <- as.vector(1/G_bin_means[match(G_M211$Plt_B_bin, names(G_bin_means))])

}
```

## model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_M211.1 <- nls(fg_1, data = G_M211, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_M211$nls_weights), 
 )

## phi
try(
  nls_M211.2 <- nls(fg_2, data=G_M211, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_M211$nls_weights), 
 )

# phi/alpha
try(
  nls_M211.3 <- nls(fg_3 , data = G_M211, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_M211$nls_weights), 
 )

## test
if(exists("nls_M211.1") & exists("nls_M211.2") & exists("nls_M211.3")){
  print(anova(nls_M211.1, nls_M211.2, nls_M211.3))
} else if(exists("nls_M211.2") & exists("nls_M211.3")){
  print(anova(nls_M211.2, nls_M211.3))
} else if(exists("nls_M211.1") & exists("nls_M211.2")){
  print(anova(nls_M211.1, nls_M211.2))
}
 
## AIC comparison
AIC1_M211 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_M211.1"), AIC(get("nls_M211.1")), NA),
            ifelse(exists("nls_M211.2"), AIC(get("nls_M211.2")), NA),
            ifelse(exists("nls_M211.3"), AIC(get("nls_M211.3")), NA)
            ))

print(AIC1_M211) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M211[!is.na(AIC1_M211$AIC) & AIC1_M211$AIC == min(AIC1_M211$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M211.",  Mod.Sel1, sep =""))) ) #model summary

}
```
### summary 
* simple model: `r ifelse(exists("nls_M211.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M211.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_M211.3"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M211.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M211.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_M211.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_M211.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M211.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M211.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "a", sep ="")), 
          data = G_M211,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_M211$nls_weights))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M211.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "b", sep ="")), 
          data = G_M211,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_M211$nls_weights)) 
 )

## c-model: with s and p parameters
try(
  assign(
    paste("nls_M211.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "c", sep ="")), 
          data = G_M211,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_M211$nls_weights))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M211.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M211.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M211.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M211.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M211.", Mod.Sel1, sep ="")),
             get(paste("nls_M211.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M211.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M211.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M211.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M211.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M211.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M211.", Mod.Sel1, sep ="")),
               get(paste("nls_M211.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M211.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M211.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M211.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M211.", Mod.Sel1, sep ="")),
                 get(paste("nls_M211.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M211.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M211.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M211.", Mod.Sel1, sep ="")),
                    get(paste("nls_M211.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M211.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M211.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M211.", Mod.Sel1, sep ="")),
                      get(paste("nls_M211.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M211 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M211.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M211.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M211.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M211.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M211.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M211.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M211.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M211.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M211)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M211[!is.na(AIC2_M211$AIC) & AIC2_M211$AIC == min(AIC2_M211$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.G[Best_mods.G$Code == "M211",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M211.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M211.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df2[nls.param.df2$Code == "M211",]$ge <- coefs["ge"]
nls.param.df2[nls.param.df2$Code == "M211",]$phi <- coefs["phi"]
nls.param.df2[nls.param.df2$Code == "M211",]$alpha <- coefs["alpha"]
nls.param.df2[nls.param.df2$Code == "M211",]$A <- coefs["A"]
nls.param.df2[nls.param.df2$Code == "M211",]$k <- coefs["k"]

nls.param.df2[nls.param.df2$Code == "M211",]$ge.2.5 <- intervals_low["ge"]
nls.param.df2[nls.param.df2$Code == "M211",]$phi.2.5 <- intervals_low["phi"]
nls.param.df2[nls.param.df2$Code == "M211",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df2[nls.param.df2$Code == "M211",]$A.2.5 <- intervals_low["A"]
nls.param.df2[nls.param.df2$Code == "M211",]$k.2.5 <- intervals_low["k"]

nls.param.df2[nls.param.df2$Code == "M211",]$ge.97.5 <- intervals_high["ge"]
nls.param.df2[nls.param.df2$Code == "M211",]$phi.97.5 <- intervals_high["phi"]
nls.param.df2[nls.param.df2$Code == "M211",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df2[nls.param.df2$Code == "M211",]$A.97.5 <- intervals_high["A"]
nls.param.df2[nls.param.df2$Code == "M211",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M211.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M211.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M211.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M211.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals

```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_M211 <- nlsResiduals(
  get(paste("nls_M211.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_M211)

## test residuals
if(length(G_M211$pltID) < 5001) {test.nlsResiduals(resid_M211)}

}  else {print("cannot plot residuals")}
```

## predict and plot

```{r, message = FALSE, cache=T}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

`M211_pred2` <- predict(get(paste("nls_M211.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME_avg"= rep(mean(G_M211$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME_avg"= rep(mean(G_M211$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "DeltaPDSI"= rep(mean(G_M211$DeltaPDSI, na.rm =T), 1501))
                      } else if (Mod.Sel1 == 3){
                        data.frame("MEASTIME_avg"= rep(mean(G_M211$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "B_L_prop"= rep(mean(G_M211$B_L_prop, na.rm =T), 1501), 
                                   "DeltaPDSI"= rep(mean(G_M211$DeltaPDSI, na.rm =T), 1501))
                      } )


## predicted interval data.frame
`M211_pred_df` <- data.frame("B_plt_t1_MgHa" = seq(0,1500,by =1), fitted=`M211_pred2`)

## PLOTTING 2
gg.M211.2 <- ggplot() +
             geom_jitter(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_M211, 
                         alpha = 0.5, color = "#00000080", shape = "+") +
             ## dark ponts = "#1E88E580"
             geom_hline(yintercept =0, lty =3) +
            
             stat_summary_bin(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_M211, 
                              fun.data = function(x) {
                                res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                                names(res) <- c("ymin","y","ymax")
                                res}, 
                              col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M211))), breaks = cutvec_M211) +         
    
             # geom_ribbon(aes(x = B_plt_t1_MgHa, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
             #             data = M211_pred_df, color="#FF000080", fill ="#FF000080", alpha = 0.25, lty =3) +
             geom_line(aes(x = B_plt_t1_MgHa, y = fitted), data = `M211_pred_df`, color="#FF000080", alpha = 0.5, lwd = 2) + 
             ## red = "#D6272880" 
    
             labs(x = expression("biomass (Mg ha"^-1*")"), 
                 y = expression("biomass growth (Mg ha"^-1*" yr"^-1*")")) + 
             ggtitle("M211 - Adirondack-New England Mixed forest - Coniferous Forest - Alpine Meadow") +
             theme_classic() + theme(axis.text.x=element_text(angle=90,hjust=1)) + 
             scale_x_continuous(limits = c(0, tail(cutvec_M211,1)*1.05), expand =c(0,0)) +
             coord_cartesian(ylim=c(-2, 10))
  
             #ylim(c(min(M211_pred_df$`Prop.2.5%`)-0.25, max(M211_pred_df$`Prop.97.5%`)+0.25))
             #ylim(c(-2,8))
            
gg.M211.2

}  else {print("cannot plot data with prediction")}
```

## plotting 2

```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_M211 <-data.frame(
  bin = as.factor(levels(cut(G_M211$B_plt_t1_MgHa, cutvec_M211))),
  data.mean = tapply(G_M211$G_obs_TreeInc_MgHaYr, cut(G_M211$B_plt_t1_MgHa, cutvec_M211), 
                     mean), 
  data.CI.high =  tapply(G_M211$G_obs_TreeInc_MgHaYr, cut(G_M211$B_plt_t1_MgHa, cutvec_M211), 
                    high.CI), 
  data.CI.low = tapply(G_M211$G_obs_TreeInc_MgHaYr, cut(G_M211$B_plt_t1_MgHa, cutvec_M211),
                    low.CI), 
  pred.mean = `M211_pred_df`[`M211_pred_df`$B_plt_t1_MgHa %in% bin_mids_M211,]$fitted) 


### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M211 <-  DM_compare_M211 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M211$bin)[gtools::mixedorder(levels(DM_compare_M211$bin))]))
                                                                                                        
## ggplot
gg.M211.3 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M211) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M211))), 
                              labels = levels(DM_compare_M211$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1,  alpha = 0.5) +         
           labs(x = expression("calculated G (Mg ha"^-1*" yr"^-1*")"), 
                y = expression("nls predicted G (Mg ha"^-1*" yr"^-1*")")) +
           ggtitle("M211 - Adirondack-New England Mixed forest - Coniferous Forest - Alpine Meadow") +         
           theme_classic() + 
            theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M211.3

}
```


# M221 - Eastern Broadleaf Forest

```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_M221 <- round(quantile(G_M221$B_plt_t1_MgHa, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M221)))){
  cutvec_M221 <- round(quantile(G_M221$B_plt_t1_MgHa, seq(0,1, length.out = 11)))
}

bin_mids_M221 <- unname(round(cutvec_M221[-length(cutvec_M221)] + diff(cutvec_M221)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_M221$Plt_B_bin <-  cut(G_M221$B_plt_t1_MgHa, cutvec_M221)
## get bin means
G_bin_means <- tapply(G_M221$G_obs_TreeInc_MgHaYr, cut(G_M221$B_plt_t1_MgHa, cutvec_M221), mean)

## make column weights.1
G_M221$nls_weights <- as.vector(1/G_bin_means[match(G_M221$Plt_B_bin, names(G_bin_means))])

}
```

## model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_M221.1 <- nls(fg_1, data = G_M221, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_M221$nls_weights), 
 )

## phi
try(
  nls_M221.2 <- nls(fg_2, data=G_M221, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_M221$nls_weights), 
 )

# phi/alpha
try(
  nls_M221.3 <- nls(fg_3 , data = G_M221, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_M221$nls_weights), 
 )

## test
if(exists("nls_M221.1") & exists("nls_M221.2") & exists("nls_M221.3")){
  print(anova(nls_M221.1, nls_M221.2, nls_M221.3))
} else if(exists("nls_M221.2") & exists("nls_M221.3")){
  print(anova(nls_M221.2, nls_M221.3))
} else if(exists("nls_M221.1") & exists("nls_M221.2")){
  print(anova(nls_M221.1, nls_M221.2))
}
 
## AIC comparison
AIC1_M221 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_M221.1"), AIC(get("nls_M221.1")), NA),
            ifelse(exists("nls_M221.2"), AIC(get("nls_M221.2")), NA),
            ifelse(exists("nls_M221.3"), AIC(get("nls_M221.3")), NA)
            ))

print(AIC1_M221) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M221[!is.na(AIC1_M221$AIC) & AIC1_M221$AIC == min(AIC1_M221$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M221.",  Mod.Sel1, sep =""))) ) #model summary

}
```
### summary 
* simple model: `r ifelse(exists("nls_M221.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M221.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_M221.3"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M221.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M221.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_M221.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_M221.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M221.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M221.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "a", sep ="")), 
          data = G_M221,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_M221$nls_weights))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M221.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "b", sep ="")), 
          data = G_M221,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_M221$nls_weights)) 
 )

## c-model: with s and p parameters
try(
  assign(
    paste("nls_M221.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "c", sep ="")), 
          data = G_M221,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_M221$nls_weights))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M221.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M221.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M221.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M221.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M221.", Mod.Sel1, sep ="")),
             get(paste("nls_M221.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M221.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M221.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M221.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M221.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M221.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M221.", Mod.Sel1, sep ="")),
               get(paste("nls_M221.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M221.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M221.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M221.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M221.", Mod.Sel1, sep ="")),
                 get(paste("nls_M221.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M221.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M221.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M221.", Mod.Sel1, sep ="")),
                    get(paste("nls_M221.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M221.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M221.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M221.", Mod.Sel1, sep ="")),
                      get(paste("nls_M221.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M221 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M221.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M221.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M221.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M221.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M221.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M221.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M221.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M221.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M221)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M221[!is.na(AIC2_M221$AIC) & AIC2_M221$AIC == min(AIC2_M221$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.G[Best_mods.G$Code == "M221",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M221.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M221.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df2[nls.param.df2$Code == "M221",]$ge <- coefs["ge"]
nls.param.df2[nls.param.df2$Code == "M221",]$phi <- coefs["phi"]
nls.param.df2[nls.param.df2$Code == "M221",]$alpha <- coefs["alpha"]
nls.param.df2[nls.param.df2$Code == "M221",]$A <- coefs["A"]
nls.param.df2[nls.param.df2$Code == "M221",]$k <- coefs["k"]

nls.param.df2[nls.param.df2$Code == "M221",]$ge.2.5 <- intervals_low["ge"]
nls.param.df2[nls.param.df2$Code == "M221",]$phi.2.5 <- intervals_low["phi"]
nls.param.df2[nls.param.df2$Code == "M221",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df2[nls.param.df2$Code == "M221",]$A.2.5 <- intervals_low["A"]
nls.param.df2[nls.param.df2$Code == "M221",]$k.2.5 <- intervals_low["k"]

nls.param.df2[nls.param.df2$Code == "M221",]$ge.97.5 <- intervals_high["ge"]
nls.param.df2[nls.param.df2$Code == "M221",]$phi.97.5 <- intervals_high["phi"]
nls.param.df2[nls.param.df2$Code == "M221",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df2[nls.param.df2$Code == "M221",]$A.97.5 <- intervals_high["A"]
nls.param.df2[nls.param.df2$Code == "M221",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M221.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M221.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M221.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M221.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals

```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_M221 <- nlsResiduals(
  get(paste("nls_M221.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_M221)

## test residuals
if(length(G_M221$pltID) < 5001) {test.nlsResiduals(resid_M221)}

}  else {print("cannot plot residuals")}
```

## predict and plot

```{r, message = FALSE, cache=T}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

`M221_pred2` <- predict(get(paste("nls_M221.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME_avg"= rep(mean(G_M221$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME_avg"= rep(mean(G_M221$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "DeltaPDSI"= rep(mean(G_M221$DeltaPDSI, na.rm =T), 1501))
                      } else if (Mod.Sel1 == 3){
                        data.frame("MEASTIME_avg"= rep(mean(G_M221$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "B_L_prop"= rep(mean(G_M221$B_L_prop, na.rm =T), 1501), 
                                   "DeltaPDSI"= rep(mean(G_M221$DeltaPDSI, na.rm =T), 1501))
                      } )


## predicted interval data.frame
`M221_pred_df` <- data.frame("B_plt_t1_MgHa" = seq(0,1500,by =1), fitted=`M221_pred2`)

## PLOTTING 2
gg.M221.2 <- ggplot() +
             geom_jitter(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_M221, 
                         alpha = 0.5, color = "#00000080", shape = "+") +
             ## dark ponts = "#1E88E580"
             geom_hline(yintercept =0, lty =3) +
            
             stat_summary_bin(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_M221, 
                              fun.data = function(x) {
                                res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                                names(res) <- c("ymin","y","ymax")
                                res}, 
                              col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M221))), breaks = cutvec_M221) +         
    
             # geom_ribbon(aes(x = B_plt_t1_MgHa, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
             #             data = M221_pred_df, color="#FF000080", fill ="#FF000080", alpha = 0.25, lty =3) +
             geom_line(aes(x = B_plt_t1_MgHa, y = fitted), data = `M221_pred_df`, color="#FF000080", alpha = 0.5, lwd = 2) + 
             ## red = "#D6272880" 
    
             labs(x = expression("biomass (Mg ha"^-1*")"), 
                 y = expression("biomass growth (Mg ha"^-1*" yr"^-1*")")) + 
             ggtitle("M221 - Eastern Broadleaf Forest") +
             theme_classic() + theme(axis.text.x=element_text(angle=90,hjust=1)) + 
             scale_x_continuous(limits = c(0, tail(cutvec_M221,1)*1.05), expand =c(0,0)) +
             coord_cartesian(ylim=c(-2, 10))
  
             #ylim(c(min(M221_pred_df$`Prop.2.5%`)-0.25, max(M221_pred_df$`Prop.97.5%`)+0.25))
             #ylim(c(-2,8))
            
gg.M221.2

}  else {print("cannot plot data with prediction")}
```

## plotting 2

```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_M221 <-data.frame(
  bin = as.factor(levels(cut(G_M221$B_plt_t1_MgHa, cutvec_M221))),
  data.mean = tapply(G_M221$G_obs_TreeInc_MgHaYr, cut(G_M221$B_plt_t1_MgHa, cutvec_M221), 
                     mean), 
  data.CI.high =  tapply(G_M221$G_obs_TreeInc_MgHaYr, cut(G_M221$B_plt_t1_MgHa, cutvec_M221), 
                    high.CI), 
  data.CI.low = tapply(G_M221$G_obs_TreeInc_MgHaYr, cut(G_M221$B_plt_t1_MgHa, cutvec_M221),
                    low.CI), 
  pred.mean = `M221_pred_df`[`M221_pred_df`$B_plt_t1_MgHa %in% bin_mids_M221,]$fitted) 


### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M221 <-  DM_compare_M221 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M221$bin)[gtools::mixedorder(levels(DM_compare_M221$bin))]))
                                                                                                        
## ggplot
gg.M221.3 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M221) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M221))), 
                              labels = levels(DM_compare_M221$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1,  alpha = 0.5) +         
           labs(x = expression("calculated G (Mg ha"^-1*" yr"^-1*")"), 
                y = expression("nls predicted G (Mg ha"^-1*" yr"^-1*")")) +
           ggtitle("M221 - Eastern Broadleaf Forest") +         
           theme_classic() + 
            theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M221.3

}
```


# M223 - Ozark Broadleaf Forest Meadow

```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_M223 <- round(quantile(G_M223$B_plt_t1_MgHa, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M223)))){
  cutvec_M223 <- round(quantile(G_M223$B_plt_t1_MgHa, seq(0,1, length.out = 11)))
}

bin_mids_M223 <- unname(round(cutvec_M223[-length(cutvec_M223)] + diff(cutvec_M223)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_M223$Plt_B_bin <-  cut(G_M223$B_plt_t1_MgHa, cutvec_M223)
## get bin means
G_bin_means <- tapply(G_M223$G_obs_TreeInc_MgHaYr, cut(G_M223$B_plt_t1_MgHa, cutvec_M223), mean)

## make column weights.1
G_M223$nls_weights <- as.vector(1/G_bin_means[match(G_M223$Plt_B_bin, names(G_bin_means))])

}
```

## model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_M223.1 <- nls(fg_1, data = G_M223, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_M223$nls_weights), 
 )

## phi
try(
  nls_M223.2 <- nls(fg_2, data=G_M223, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_M223$nls_weights), 
 )

# phi/alpha
try(
  nls_M223.3 <- nls(fg_3 , data = G_M223, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_M223$nls_weights), 
 )

## test
if(exists("nls_M223.1") & exists("nls_M223.2") & exists("nls_M223.3")){
  print(anova(nls_M223.1, nls_M223.2, nls_M223.3))
} else if(exists("nls_M223.2") & exists("nls_M223.3")){
  print(anova(nls_M223.2, nls_M223.3))
} else if(exists("nls_M223.1") & exists("nls_M223.2")){
  print(anova(nls_M223.1, nls_M223.2))
}
 
## AIC comparison
AIC1_M223 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_M223.1"), AIC(get("nls_M223.1")), NA),
            ifelse(exists("nls_M223.2"), AIC(get("nls_M223.2")), NA),
            ifelse(exists("nls_M223.3"), AIC(get("nls_M223.3")), NA)
            ))

print(AIC1_M223) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M223[!is.na(AIC1_M223$AIC) & AIC1_M223$AIC == min(AIC1_M223$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M223.",  Mod.Sel1, sep =""))) ) #model summary

}
```
### summary 
* simple model: `r ifelse(exists("nls_M223.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M223.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_M223.3"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M223.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M223.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_M223.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_M223.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M223.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M223.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "a", sep ="")), 
          data = G_M223,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_M223$nls_weights))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M223.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "b", sep ="")), 
          data = G_M223,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_M223$nls_weights)) 
 )

## c-model: with s and p parameters
try(
  assign(
    paste("nls_M223.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "c", sep ="")), 
          data = G_M223,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_M223$nls_weights))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M223.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M223.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M223.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M223.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M223.", Mod.Sel1, sep ="")),
             get(paste("nls_M223.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M223.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M223.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M223.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M223.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M223.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M223.", Mod.Sel1, sep ="")),
               get(paste("nls_M223.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M223.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M223.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M223.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M223.", Mod.Sel1, sep ="")),
                 get(paste("nls_M223.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M223.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M223.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M223.", Mod.Sel1, sep ="")),
                    get(paste("nls_M223.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M223.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M223.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M223.", Mod.Sel1, sep ="")),
                      get(paste("nls_M223.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M223 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M223.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M223.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M223.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M223.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M223.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M223.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M223.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M223.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M223)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M223[!is.na(AIC2_M223$AIC) & AIC2_M223$AIC == min(AIC2_M223$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.G[Best_mods.G$Code == "M223",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M223.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M223.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df2[nls.param.df2$Code == "M223",]$ge <- coefs["ge"]
nls.param.df2[nls.param.df2$Code == "M223",]$phi <- coefs["phi"]
nls.param.df2[nls.param.df2$Code == "M223",]$alpha <- coefs["alpha"]
nls.param.df2[nls.param.df2$Code == "M223",]$A <- coefs["A"]
nls.param.df2[nls.param.df2$Code == "M223",]$k <- coefs["k"]

nls.param.df2[nls.param.df2$Code == "M223",]$ge.2.5 <- intervals_low["ge"]
nls.param.df2[nls.param.df2$Code == "M223",]$phi.2.5 <- intervals_low["phi"]
nls.param.df2[nls.param.df2$Code == "M223",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df2[nls.param.df2$Code == "M223",]$A.2.5 <- intervals_low["A"]
nls.param.df2[nls.param.df2$Code == "M223",]$k.2.5 <- intervals_low["k"]

nls.param.df2[nls.param.df2$Code == "M223",]$ge.97.5 <- intervals_high["ge"]
nls.param.df2[nls.param.df2$Code == "M223",]$phi.97.5 <- intervals_high["phi"]
nls.param.df2[nls.param.df2$Code == "M223",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df2[nls.param.df2$Code == "M223",]$A.97.5 <- intervals_high["A"]
nls.param.df2[nls.param.df2$Code == "M223",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M223.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M223.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M223.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M223.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals

```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_M223 <- nlsResiduals(
  get(paste("nls_M223.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_M223)

## test residuals
if(length(G_M223$pltID) < 5001) {test.nlsResiduals(resid_M223)}

}  else {print("cannot plot residuals")}
```

## predict and plot

```{r, message = FALSE, cache=T}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

`M223_pred2` <- predict(get(paste("nls_M223.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME_avg"= rep(mean(G_M223$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME_avg"= rep(mean(G_M223$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "DeltaPDSI"= rep(mean(G_M223$DeltaPDSI, na.rm =T), 1501))
                      } else if (Mod.Sel1 == 3){
                        data.frame("MEASTIME_avg"= rep(mean(G_M223$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "B_L_prop"= rep(mean(G_M223$B_L_prop, na.rm =T), 1501), 
                                   "DeltaPDSI"= rep(mean(G_M223$DeltaPDSI, na.rm =T), 1501))
                      } )


## predicted interval data.frame
`M223_pred_df` <- data.frame("B_plt_t1_MgHa" = seq(0,1500,by =1), fitted=`M223_pred2`)

## PLOTTING 2
gg.M223.2 <- ggplot() +
             geom_jitter(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_M223, 
                         alpha = 0.5, color = "#00000080", shape = "+") +
             ## dark ponts = "#1E88E580"
             geom_hline(yintercept =0, lty =3) +
            
             stat_summary_bin(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_M223, 
                              fun.data = function(x) {
                                res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                                names(res) <- c("ymin","y","ymax")
                                res}, 
                              col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M223))), breaks = cutvec_M223) +         
    
             # geom_ribbon(aes(x = B_plt_t1_MgHa, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
             #             data = M223_pred_df, color="#FF000080", fill ="#FF000080", alpha = 0.25, lty =3) +
             geom_line(aes(x = B_plt_t1_MgHa, y = fitted), data = `M223_pred_df`, color="#FF000080", alpha = 0.5, lwd = 2) + 
             ## red = "#D6272880" 
    
             labs(x = expression("biomass (Mg ha"^-1*")"), 
                 y = expression("biomass growth (Mg ha"^-1*" yr"^-1*")")) + 
             ggtitle("M223 - Ozark Broadleaf Forest Meadow") +
             theme_classic() + theme(axis.text.x=element_text(angle=90,hjust=1)) + 
             scale_x_continuous(limits = c(0, tail(cutvec_M223,1)*1.05), expand =c(0,0))  +
             coord_cartesian(ylim=c(-2, 10))
 
             #ylim(c(min(M223_pred_df$`Prop.2.5%`)-0.25, max(M223_pred_df$`Prop.97.5%`)+0.25))
             #ylim(c(-2,8))
            
gg.M223.2

}  else {print("cannot plot data with prediction")}
```

## plotting 2

```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_M223 <-data.frame(
  bin = as.factor(levels(cut(G_M223$B_plt_t1_MgHa, cutvec_M223))),
  data.mean = tapply(G_M223$G_obs_TreeInc_MgHaYr, cut(G_M223$B_plt_t1_MgHa, cutvec_M223), 
                     mean), 
  data.CI.high =  tapply(G_M223$G_obs_TreeInc_MgHaYr, cut(G_M223$B_plt_t1_MgHa, cutvec_M223), 
                    high.CI), 
  data.CI.low = tapply(G_M223$G_obs_TreeInc_MgHaYr, cut(G_M223$B_plt_t1_MgHa, cutvec_M223),
                    low.CI), 
  pred.mean = `M223_pred_df`[`M223_pred_df`$B_plt_t1_MgHa %in% bin_mids_M223,]$fitted) 


### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M223 <-  DM_compare_M223 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M223$bin)[gtools::mixedorder(levels(DM_compare_M223$bin))]))
                                                                                                        
## ggplot
gg.M223.3 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M223) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M223))), 
                              labels = levels(DM_compare_M223$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1,  alpha = 0.5) +         
           labs(x = expression("calculated G (Mg ha"^-1*" yr"^-1*")"), 
                y = expression("nls predicted G (Mg ha"^-1*" yr"^-1*")")) +
           ggtitle("M223 - Ozark Broadleaf Forest Meadow") +         
           theme_classic() + 
            theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M223.3

}
```


# M231 - Ouachita Mixed Forest

```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_M231 <- round(quantile(G_M231$B_plt_t1_MgHa, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M231)))){
  cutvec_M231 <- round(quantile(G_M231$B_plt_t1_MgHa, seq(0,1, length.out = 11)))
}

bin_mids_M231 <- unname(round(cutvec_M231[-length(cutvec_M231)] + diff(cutvec_M231)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_M231$Plt_B_bin <-  cut(G_M231$B_plt_t1_MgHa, cutvec_M231)
## get bin means
G_bin_means <- tapply(G_M231$G_obs_TreeInc_MgHaYr, cut(G_M231$B_plt_t1_MgHa, cutvec_M231), mean)

## make column weights.1
G_M231$nls_weights <- as.vector(1/G_bin_means[match(G_M231$Plt_B_bin, names(G_bin_means))])

}
```

## model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_M231.1 <- nls(fg_1, data = G_M231, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_M231$nls_weights), 
 )

## phi
try(
  nls_M231.2 <- nls(fg_2, data=G_M231, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_M231$nls_weights), 
 )

# phi/alpha
try(
  nls_M231.3 <- nls(fg_3 , data = G_M231, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_M231$nls_weights), 
 )

## test
if(exists("nls_M231.1") & exists("nls_M231.2") & exists("nls_M231.3")){
  print(anova(nls_M231.1, nls_M231.2, nls_M231.3))
} else if(exists("nls_M231.2") & exists("nls_M231.3")){
  print(anova(nls_M231.2, nls_M231.3))
} else if(exists("nls_M231.1") & exists("nls_M231.2")){
  print(anova(nls_M231.1, nls_M231.2))
}
 
## AIC comparison
AIC1_M231 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_M231.1"), AIC(get("nls_M231.1")), NA),
            ifelse(exists("nls_M231.2"), AIC(get("nls_M231.2")), NA),
            ifelse(exists("nls_M231.3"), AIC(get("nls_M231.3")), NA)
            ))

print(AIC1_M231) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M231[!is.na(AIC1_M231$AIC) & AIC1_M231$AIC == min(AIC1_M231$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M231.",  Mod.Sel1, sep =""))) ) #model summary

}
```
### summary 
* simple model: `r ifelse(exists("nls_M231.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M231.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_M231.3"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M231.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M231.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_M231.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_M231.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M231.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M231.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "a", sep ="")), 
          data = G_M231,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_M231$nls_weights))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M231.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "b", sep ="")), 
          data = G_M231,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_M231$nls_weights)) 
 )

## c-model: with s and p parameters
try(
  assign(
    paste("nls_M231.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "c", sep ="")), 
          data = G_M231,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_M231$nls_weights))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M231.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M231.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M231.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M231.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M231.", Mod.Sel1, sep ="")),
             get(paste("nls_M231.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M231.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M231.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M231.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M231.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M231.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M231.", Mod.Sel1, sep ="")),
               get(paste("nls_M231.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M231.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M231.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M231.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M231.", Mod.Sel1, sep ="")),
                 get(paste("nls_M231.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M231.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M231.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M231.", Mod.Sel1, sep ="")),
                    get(paste("nls_M231.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M231.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M231.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M231.", Mod.Sel1, sep ="")),
                      get(paste("nls_M231.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M231 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M231.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M231.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M231.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M231.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M231.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M231.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M231.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M231.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M231)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M231[!is.na(AIC2_M231$AIC) & AIC2_M231$AIC == min(AIC2_M231$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.G[Best_mods.G$Code == "M231",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M231.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M231.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df2[nls.param.df2$Code == "M231",]$ge <- coefs["ge"]
nls.param.df2[nls.param.df2$Code == "M231",]$phi <- coefs["phi"]
nls.param.df2[nls.param.df2$Code == "M231",]$alpha <- coefs["alpha"]
nls.param.df2[nls.param.df2$Code == "M231",]$A <- coefs["A"]
nls.param.df2[nls.param.df2$Code == "M231",]$k <- coefs["k"]

nls.param.df2[nls.param.df2$Code == "M231",]$ge.2.5 <- intervals_low["ge"]
nls.param.df2[nls.param.df2$Code == "M231",]$phi.2.5 <- intervals_low["phi"]
nls.param.df2[nls.param.df2$Code == "M231",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df2[nls.param.df2$Code == "M231",]$A.2.5 <- intervals_low["A"]
nls.param.df2[nls.param.df2$Code == "M231",]$k.2.5 <- intervals_low["k"]

nls.param.df2[nls.param.df2$Code == "M231",]$ge.97.5 <- intervals_high["ge"]
nls.param.df2[nls.param.df2$Code == "M231",]$phi.97.5 <- intervals_high["phi"]
nls.param.df2[nls.param.df2$Code == "M231",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df2[nls.param.df2$Code == "M231",]$A.97.5 <- intervals_high["A"]
nls.param.df2[nls.param.df2$Code == "M231",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M231.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M231.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M231.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M231.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals

```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_M231 <- nlsResiduals(
  get(paste("nls_M231.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_M231)

## test residuals
if(length(G_M231$pltID) < 5001) {test.nlsResiduals(resid_M231)}

}  else {print("cannot plot residuals")}
```

## predict and plot

```{r, message = FALSE, cache=T}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

`M231_pred2` <- predict(get(paste("nls_M231.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME_avg"= rep(mean(G_M231$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME_avg"= rep(mean(G_M231$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "DeltaPDSI"= rep(mean(G_M231$DeltaPDSI, na.rm =T), 1501))
                      } else if (Mod.Sel1 == 3){
                        data.frame("MEASTIME_avg"= rep(mean(G_M231$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "B_L_prop"= rep(mean(G_M231$B_L_prop, na.rm =T), 1501), 
                                   "DeltaPDSI"= rep(mean(G_M231$DeltaPDSI, na.rm =T), 1501))
                      } )


## predicted interval data.frame
`M231_pred_df` <- data.frame("B_plt_t1_MgHa" = seq(0,1500,by =1), fitted=`M231_pred2`)

## PLOTTING 2
gg.M231.2 <- ggplot() +
             geom_jitter(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_M231, 
                         alpha = 0.5, color = "#00000080", shape = "+") +
             ## dark ponts = "#1E88E580"
             geom_hline(yintercept =0, lty =3) +
            
             stat_summary_bin(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_M231, 
                              fun.data = function(x) {
                                res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                                names(res) <- c("ymin","y","ymax")
                                res}, 
                              col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M231)+1)), breaks = cutvec_M231) +         
    
             # geom_ribbon(aes(x = B_plt_t1_MgHa, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
             #             data = M231_pred_df, color="#FF000080", fill ="#FF000080", alpha = 0.25, lty =3) +
             geom_line(aes(x = B_plt_t1_MgHa, y = fitted), data = `M231_pred_df`, color="#FF000080", alpha = 0.5, lwd = 2) + 
             ## red = "#D6272880" 
    
             labs(x = expression("biomass (Mg ha"^-1*")"), 
                 y = expression("biomass growth (Mg ha"^-1*" yr"^-1*")")) + 
             ggtitle("M231 - Ouachita Mixed Forest") +
             theme_classic() + theme(axis.text.x=element_text(angle=90,hjust=1)) + 
             scale_x_continuous(limits = c(0, tail(cutvec_M231,1)*1.05), expand =c(0,0)) +
             coord_cartesian(ylim=c(-2, 10))
  
             #ylim(c(min(M231_pred_df$`Prop.2.5%`)-0.25, max(M231_pred_df$`Prop.97.5%`)+0.25))
             #ylim(c(-2,8))
            
gg.M231.2

}  else {print("cannot plot data with prediction")}
```

## plotting 2

```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_M231 <-data.frame(
  bin = as.factor(levels(cut(G_M231$B_plt_t1_MgHa, cutvec_M231))),
  data.mean = tapply(G_M231$G_obs_TreeInc_MgHaYr, cut(G_M231$B_plt_t1_MgHa, cutvec_M231), 
                     mean), 
  data.CI.high =  tapply(G_M231$G_obs_TreeInc_MgHaYr, cut(G_M231$B_plt_t1_MgHa, cutvec_M231), 
                    high.CI), 
  data.CI.low = tapply(G_M231$G_obs_TreeInc_MgHaYr, cut(G_M231$B_plt_t1_MgHa, cutvec_M231),
                    low.CI), 
  pred.mean = `M231_pred_df`[`M231_pred_df`$B_plt_t1_MgHa %in% bin_mids_M231,]$fitted) 


### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M231 <-  DM_compare_M231 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M231$bin)[gtools::mixedorder(levels(DM_compare_M231$bin))]))
                                                                                                        
## ggplot
gg.M231.3 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M231) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M231))), 
                              labels = levels(DM_compare_M231$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1,  alpha = 0.5) +         
           labs(x = expression("calculated G (Mg ha"^-1*" yr"^-1*")"), 
                y = expression("nls predicted G (Mg ha"^-1*" yr"^-1*")")) +
           ggtitle("M231 - Ouachita Mixed Forest") +         
           theme_classic() + 
            theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M231.3

}
```


# M242 - Cascade Mixed Forest

```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_M242 <- round(quantile(G_M242$B_plt_t1_MgHa, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M242)))){
  cutvec_M242 <- round(quantile(G_M242$B_plt_t1_MgHa, seq(0,1, length.out = 11)))
}

bin_mids_M242 <- unname(round(cutvec_M242[-length(cutvec_M242)] + diff(cutvec_M242)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_M242$Plt_B_bin <-  cut(G_M242$B_plt_t1_MgHa, cutvec_M242)
## get bin means
G_bin_means <- tapply(G_M242$G_obs_TreeInc_MgHaYr, cut(G_M242$B_plt_t1_MgHa, cutvec_M242), mean)

## make column weights.1
G_M242$nls_weights <- as.vector(1/G_bin_means[match(G_M242$Plt_B_bin, names(G_bin_means))])

}
```

## model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_M242.1 <- nls(fg_1, data = G_M242, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_M242$nls_weights), 
 )

## phi
try(
  nls_M242.2 <- nls(fg_2, data=G_M242, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_M242$nls_weights), 
 )

# phi/alpha
try(
  nls_M242.3 <- nls(fg_3 , data = G_M242, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_M242$nls_weights), 
 )

## test
if(exists("nls_M242.1") & exists("nls_M242.2") & exists("nls_M242.3")){
  print(anova(nls_M242.1, nls_M242.2, nls_M242.3))
} else if(exists("nls_M242.2") & exists("nls_M242.3")){
  print(anova(nls_M242.2, nls_M242.3))
} else if(exists("nls_M242.1") & exists("nls_M242.2")){
  print(anova(nls_M242.1, nls_M242.2))
}
 
## AIC comparison
AIC1_M242 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_M242.1"), AIC(get("nls_M242.1")), NA),
            ifelse(exists("nls_M242.2"), AIC(get("nls_M242.2")), NA),
            ifelse(exists("nls_M242.3"), AIC(get("nls_M242.3")), NA)
            ))

print(AIC1_M242) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M242[!is.na(AIC1_M242$AIC) & AIC1_M242$AIC == min(AIC1_M242$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M242.",  Mod.Sel1, sep =""))) ) #model summary

}
```
### summary 
* simple model: `r ifelse(exists("nls_M242.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M242.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_M242.3"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M242.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M242.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_M242.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_M242.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M242.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M242.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "a", sep ="")), 
          data = G_M242,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)},
          weights = G_M242$nls_weights))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M242.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "b", sep ="")), 
          data = G_M242,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_M242$nls_weights)) 
 )

## c-model: with s and p parameters
try(
  assign(
    paste("nls_M242.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "c", sep ="")), 
          data = G_M242,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_M242$nls_weights))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M242.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M242.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M242.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M242.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M242.", Mod.Sel1, sep ="")),
             get(paste("nls_M242.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M242.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M242.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M242.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M242.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M242.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M242.", Mod.Sel1, sep ="")),
               get(paste("nls_M242.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M242.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M242.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M242.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M242.", Mod.Sel1, sep ="")),
                 get(paste("nls_M242.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M242.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M242.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M242.", Mod.Sel1, sep ="")),
                    get(paste("nls_M242.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M242.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M242.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M242.", Mod.Sel1, sep ="")),
                      get(paste("nls_M242.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M242 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M242.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M242.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M242.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M242.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M242.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M242.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M242.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M242.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M242)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M242[!is.na(AIC2_M242$AIC) & AIC2_M242$AIC == min(AIC2_M242$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.G[Best_mods.G$Code == "M242",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M242.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M242.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df2[nls.param.df2$Code == "M242",]$ge <- coefs["ge"]
nls.param.df2[nls.param.df2$Code == "M242",]$phi <- coefs["phi"]
nls.param.df2[nls.param.df2$Code == "M242",]$alpha <- coefs["alpha"]
nls.param.df2[nls.param.df2$Code == "M242",]$A <- coefs["A"]
nls.param.df2[nls.param.df2$Code == "M242",]$k <- coefs["k"]

nls.param.df2[nls.param.df2$Code == "M242",]$ge.2.5 <- intervals_low["ge"]
nls.param.df2[nls.param.df2$Code == "M242",]$phi.2.5 <- intervals_low["phi"]
nls.param.df2[nls.param.df2$Code == "M242",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df2[nls.param.df2$Code == "M242",]$A.2.5 <- intervals_low["A"]
nls.param.df2[nls.param.df2$Code == "M242",]$k.2.5 <- intervals_low["k"]

nls.param.df2[nls.param.df2$Code == "M242",]$ge.97.5 <- intervals_high["ge"]
nls.param.df2[nls.param.df2$Code == "M242",]$phi.97.5 <- intervals_high["phi"]
nls.param.df2[nls.param.df2$Code == "M242",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df2[nls.param.df2$Code == "M242",]$A.97.5 <- intervals_high["A"]
nls.param.df2[nls.param.df2$Code == "M242",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M242.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M242.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M242.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M242.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals

```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_M242 <- nlsResiduals(
  get(paste("nls_M242.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_M242)

## test residuals
if(length(G_M242$pltID) < 5001) {test.nlsResiduals(resid_M242)}

}  else {print("cannot plot residuals")}
```

## predict and plot

```{r, message = FALSE, cache=T}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

`M242_pred2` <- predict(get(paste("nls_M242.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME_avg"= rep(mean(G_M242$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME_avg"= rep(mean(G_M242$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "DeltaPDSI"= rep(mean(G_M242$DeltaPDSI, na.rm =T), 1501))
                      } else if (Mod.Sel1 == 3){
                        data.frame("MEASTIME_avg"= rep(mean(G_M242$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "B_L_prop"= rep(mean(G_M242$B_L_prop, na.rm =T), 1501), 
                                   "DeltaPDSI"= rep(mean(G_M242$DeltaPDSI, na.rm =T), 1501))
                      } )


## predicted interval data.frame
`M242_pred_df` <- data.frame("B_plt_t1_MgHa" = seq(0,1500,by =1), fitted=`M242_pred2`)

## PLOTTING 2
gg.M242.2 <- ggplot() +
             geom_jitter(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_M242, 
                         alpha = 0.5, color = "#00000080", shape = "+") +
             ## dark ponts = "#1E88E580"
             geom_hline(yintercept =0, lty =3) +
            
             stat_summary_bin(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_M242, 
                              fun.data = function(x) {
                                res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                                names(res) <- c("ymin","y","ymax")
                                res}, 
                              col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M242))), breaks = cutvec_M242) +         
    
             # geom_ribbon(aes(x = B_plt_t1_MgHa, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
             #             data = M242_pred_df, color="#FF000080", fill ="#FF000080", alpha = 0.25, lty =3) +
             geom_line(aes(x = B_plt_t1_MgHa, y = fitted), data = `M242_pred_df`, color="#FF000080", alpha = 0.5, lwd = 2) + 
             ## red = "#D6272880" 
    
             labs(x = expression("biomass (Mg ha"^-1*")"), 
                 y = expression("biomass growth (Mg ha"^-1*" yr"^-1*")")) + 
             ggtitle("M242 - Cascade Mixed Forest") +
             theme_classic() + theme(axis.text.x=element_text(angle=90,hjust=1)) + 
             scale_x_continuous(limits = c(0, tail(cutvec_M242,1)*1.05), expand =c(0,0)) +
             coord_cartesian(ylim=c(-2, 10))
  
             #ylim(c(min(M242_pred_df$`Prop.2.5%`)-0.25, max(M242_pred_df$`Prop.97.5%`)+0.25))
             #ylim(c(-2,8))
            
gg.M242.2

}  else {print("cannot plot data with prediction")}
```

## plotting 2

```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_M242 <-data.frame(
  bin = as.factor(levels(cut(G_M242$B_plt_t1_MgHa, cutvec_M242))),
  data.mean = tapply(G_M242$G_obs_TreeInc_MgHaYr, cut(G_M242$B_plt_t1_MgHa, cutvec_M242), 
                     mean), 
  data.CI.high =  tapply(G_M242$G_obs_TreeInc_MgHaYr, cut(G_M242$B_plt_t1_MgHa, cutvec_M242), 
                    high.CI), 
  data.CI.low = tapply(G_M242$G_obs_TreeInc_MgHaYr, cut(G_M242$B_plt_t1_MgHa, cutvec_M242),
                    low.CI), 
  pred.mean = `M242_pred_df`[`M242_pred_df`$B_plt_t1_MgHa %in% bin_mids_M242,]$fitted) 


### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M242 <-  DM_compare_M242 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M242$bin)[gtools::mixedorder(levels(DM_compare_M242$bin))]))
                                                                                                        
## ggplot
gg.M242.3 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M242) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M242))), 
                              labels = levels(DM_compare_M242$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1,  alpha = 0.5) +         
           labs(x = expression("calculated G (Mg ha"^-1*" yr"^-1*")"), 
                y = expression("nls predicted G (Mg ha"^-1*" yr"^-1*")")) +
           ggtitle("M242 - Cascade Mixed Forest") +         
           theme_classic() + 
            theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M242.3

}
```


# M261 - Sierran Steppe - Mixed Forest - Coniferous Forest - Alpine Meadow
```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_M261 <- round(quantile(G_M261$B_plt_t1_MgHa, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M261)))){
  cutvec_M261 <- round(quantile(G_M261$B_plt_t1_MgHa, seq(0,1, length.out = 11)))
}

bin_mids_M261 <- unname(round(cutvec_M261[-length(cutvec_M261)] + diff(cutvec_M261)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_M261$Plt_B_bin <-  cut(G_M261$B_plt_t1_MgHa, cutvec_M261)
## get bin means
G_bin_means <- tapply(G_M261$G_obs_TreeInc_MgHaYr, cut(G_M261$B_plt_t1_MgHa, cutvec_M261), mean)

## make column weights.1
G_M261$nls_weights <- as.vector(1/G_bin_means[match(G_M261$Plt_B_bin, names(G_bin_means))])

}
```

## model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_M261.1 <- nls(fg_1, data = G_M261, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_M261$nls_weights), 
 )

## phi
try(
  nls_M261.2 <- nls(fg_2, data=G_M261, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_M261$nls_weights), 
 )

# phi/alpha
try(
  nls_M261.3 <- nls(fg_3 , data = G_M261, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_M261$nls_weights), 
 )

## test
if(exists("nls_M261.1") & exists("nls_M261.2") & exists("nls_M261.3")){
  print(anova(nls_M261.1, nls_M261.2, nls_M261.3))
} else if(exists("nls_M261.2") & exists("nls_M261.3")){
  print(anova(nls_M261.2, nls_M261.3))
} else if(exists("nls_M261.1") & exists("nls_M261.2")){
  print(anova(nls_M261.1, nls_M261.2))
}
 
## AIC comparison
AIC1_M261 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_M261.1"), AIC(get("nls_M261.1")), NA),
            ifelse(exists("nls_M261.2"), AIC(get("nls_M261.2")), NA),
            ifelse(exists("nls_M261.3"), AIC(get("nls_M261.3")), NA)
            ))

print(AIC1_M261) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M261[!is.na(AIC1_M261$AIC) & AIC1_M261$AIC == min(AIC1_M261$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M261.",  Mod.Sel1, sep =""))) ) #model summary

}
```
### summary 
* simple model: `r ifelse(exists("nls_M261.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M261.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_M261.3"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M261.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M261.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_M261.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_M261.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M261.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M261.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "a", sep ="")), 
          data = G_M261,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_M261$nls_weights))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M261.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "b", sep ="")), 
          data = G_M261,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_M261$nls_weights)) 
 )

## c-model: with s and p parameters
try(
  assign(
    paste("nls_M261.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "c", sep ="")), 
          data = G_M261,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_M261$nls_weights))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M261.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M261.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M261.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M261.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M261.", Mod.Sel1, sep ="")),
             get(paste("nls_M261.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M261.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M261.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M261.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M261.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M261.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M261.", Mod.Sel1, sep ="")),
               get(paste("nls_M261.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M261.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M261.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M261.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M261.", Mod.Sel1, sep ="")),
                 get(paste("nls_M261.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M261.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M261.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M261.", Mod.Sel1, sep ="")),
                    get(paste("nls_M261.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M261.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M261.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M261.", Mod.Sel1, sep ="")),
                      get(paste("nls_M261.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M261 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M261.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M261.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M261.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M261.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M261.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M261.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M261.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M261.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M261)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M261[!is.na(AIC2_M261$AIC) & AIC2_M261$AIC == min(AIC2_M261$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.G[Best_mods.G$Code == "M261",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M261.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M261.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df2[nls.param.df2$Code == "M261",]$ge <- coefs["ge"]
nls.param.df2[nls.param.df2$Code == "M261",]$phi <- coefs["phi"]
nls.param.df2[nls.param.df2$Code == "M261",]$alpha <- coefs["alpha"]
nls.param.df2[nls.param.df2$Code == "M261",]$A <- coefs["A"]
nls.param.df2[nls.param.df2$Code == "M261",]$k <- coefs["k"]

nls.param.df2[nls.param.df2$Code == "M261",]$ge.2.5 <- intervals_low["ge"]
nls.param.df2[nls.param.df2$Code == "M261",]$phi.2.5 <- intervals_low["phi"]
nls.param.df2[nls.param.df2$Code == "M261",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df2[nls.param.df2$Code == "M261",]$A.2.5 <- intervals_low["A"]
nls.param.df2[nls.param.df2$Code == "M261",]$k.2.5 <- intervals_low["k"]

nls.param.df2[nls.param.df2$Code == "M261",]$ge.97.5 <- intervals_high["ge"]
nls.param.df2[nls.param.df2$Code == "M261",]$phi.97.5 <- intervals_high["phi"]
nls.param.df2[nls.param.df2$Code == "M261",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df2[nls.param.df2$Code == "M261",]$A.97.5 <- intervals_high["A"]
nls.param.df2[nls.param.df2$Code == "M261",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M261.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M261.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M261.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M261.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals

```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_M261 <- nlsResiduals(
  get(paste("nls_M261.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_M261)

## test residuals
if(length(G_M261$pltID) < 5001) {test.nlsResiduals(resid_M261)}

}  else {print("cannot plot residuals")}
```

## predict and plot

```{r, message = FALSE, cache=T}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

`M261_pred2` <- predict(get(paste("nls_M261.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME_avg"= rep(mean(G_M261$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME_avg"= rep(mean(G_M261$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "DeltaPDSI"= rep(mean(G_M261$DeltaPDSI, na.rm =T), 1501))
                      } else if (Mod.Sel1 == 3){
                        data.frame("MEASTIME_avg"= rep(mean(G_M261$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "B_L_prop"= rep(mean(G_M261$B_L_prop, na.rm =T), 1501), 
                                   "DeltaPDSI"= rep(mean(G_M261$DeltaPDSI, na.rm =T), 1501))
                      } )


## predicted interval data.frame
`M261_pred_df` <- data.frame("B_plt_t1_MgHa" = seq(0,1500,by =1), fitted=`M261_pred2`)

## PLOTTING 2
gg.M261.2 <- ggplot() +
             geom_jitter(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_M261, 
                         alpha = 0.5, color = "#00000080", shape = "+") +
             ## dark ponts = "#1E88E580"
             geom_hline(yintercept =0, lty =3) +
            
             stat_summary_bin(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_M261, 
                              fun.data = function(x) {
                                res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                                names(res) <- c("ymin","y","ymax")
                                res}, 
                              col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M261))), breaks = cutvec_M261) +         
    
             # geom_ribbon(aes(x = B_plt_t1_MgHa, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
             #             data = M261_pred_df, color="#FF000080", fill ="#FF000080", alpha = 0.25, lty =3) +
             geom_line(aes(x = B_plt_t1_MgHa, y = fitted), data = `M261_pred_df`, color="#FF000080", alpha = 0.5, lwd = 2) + 
             ## red = "#D6272880" 
    
             labs(x = expression("biomass (Mg ha"^-1*")"), 
                 y = expression("biomass growth (Mg ha"^-1*" yr"^-1*")")) + 
             ggtitle("M261 - Sierran Steppe - Mixed Forest - Coniferous Forest - Alpine Meadow") +
             theme_classic() + theme(axis.text.x=element_text(angle=90,hjust=1)) + 
             scale_x_continuous(limits = c(0, tail(cutvec_M261,1)*1.05), expand =c(0,0)) +
             coord_cartesian(ylim=c(-2, 10))
  
             #ylim(c(min(M261_pred_df$`Prop.2.5%`)-0.25, max(M261_pred_df$`Prop.97.5%`)+0.25))
             #ylim(c(-2,8))
            
gg.M261.2

}  else {print("cannot plot data with prediction")}
```

## plotting 2

```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_M261 <-data.frame(
  bin = as.factor(levels(cut(G_M261$B_plt_t1_MgHa, cutvec_M261))),
  data.mean = tapply(G_M261$G_obs_TreeInc_MgHaYr, cut(G_M261$B_plt_t1_MgHa, cutvec_M261), 
                     mean), 
  data.CI.high =  tapply(G_M261$G_obs_TreeInc_MgHaYr, cut(G_M261$B_plt_t1_MgHa, cutvec_M261), 
                    high.CI), 
  data.CI.low = tapply(G_M261$G_obs_TreeInc_MgHaYr, cut(G_M261$B_plt_t1_MgHa, cutvec_M261),
                    low.CI), 
  pred.mean = `M261_pred_df`[`M261_pred_df`$B_plt_t1_MgHa %in% bin_mids_M261,]$fitted) 


### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M261 <-  DM_compare_M261 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M261$bin)[gtools::mixedorder(levels(DM_compare_M261$bin))]))
                                                                                                        
## ggplot
gg.M261.3 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M261) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M261))), 
                              labels = levels(DM_compare_M261$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1,  alpha = 0.5) +         
           labs(x = expression("calculated G (Mg ha"^-1*" yr"^-1*")"), 
                y = expression("nls predicted G (Mg ha"^-1*" yr"^-1*")")) +
           ggtitle("M261 - Sierran Steppe - Mixed Forest - Coniferous Forest - Alpine Meadow") +         
           theme_classic() + 
            theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M261.3

}
```


# M262 - Califormia Coastal Range = Coniferous Forest - Open woodland Shrub Meadow 

```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_M262 <- round(quantile(G_M262$B_plt_t1_MgHa, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M262)))){
  cutvec_M262 <- round(quantile(G_M262$B_plt_t1_MgHa, seq(0,1, length.out = 11)))
}

bin_mids_M262 <- unname(round(cutvec_M262[-length(cutvec_M262)] + diff(cutvec_M262)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_M262$Plt_B_bin <-  cut(G_M262$B_plt_t1_MgHa, cutvec_M262)
## get bin means
G_bin_means <- tapply(G_M262$G_obs_TreeInc_MgHaYr, cut(G_M262$B_plt_t1_MgHa, cutvec_M262), mean)

## make column weights.1
G_M262$nls_weights <- as.vector(1/G_bin_means[match(G_M262$Plt_B_bin, names(G_bin_means))])

}
```

## model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_M262.1 <- nls(fg_1, data = G_M262, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_M262$nls_weights), 
 )

## phi
try(
  nls_M262.2 <- nls(fg_2, data=G_M262, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_M262$nls_weights), 
 )

# phi/alpha
try(
  nls_M262.3 <- nls(fg_3 , data = G_M262, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_M262$nls_weights), 
 )

## test
if(exists("nls_M262.1") & exists("nls_M262.2") & exists("nls_M262.3")){
  print(anova(nls_M262.1, nls_M262.2, nls_M262.3))
} else if(exists("nls_M262.2") & exists("nls_M262.3")){
  print(anova(nls_M262.2, nls_M262.3))
} else if(exists("nls_M262.1") & exists("nls_M262.2")){
  print(anova(nls_M262.1, nls_M262.2))
}
 
## AIC comparison
AIC1_M262 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_M262.1"), AIC(get("nls_M262.1")), NA),
            ifelse(exists("nls_M262.2"), AIC(get("nls_M262.2")), NA),
            ifelse(exists("nls_M262.3"), AIC(get("nls_M262.3")), NA)
            ))

print(AIC1_M262) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M262[!is.na(AIC1_M262$AIC) & AIC1_M262$AIC == min(AIC1_M262$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M262.",  Mod.Sel1, sep =""))) ) #model summary

}
```
### summary 
* simple model: `r ifelse(exists("nls_M262.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M262.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_M262.3"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M262.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M262.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_M262.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_M262.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M262.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M262.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "a", sep ="")), 
          data = G_M262,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_M262$nls_weights))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M262.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "b", sep ="")), 
          data = G_M262,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_M262$nls_weights)) 
 )

## c-model: with s and p parameters
try(
  assign(
    paste("nls_M262.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "c", sep ="")), 
          data = G_M262,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_M262$nls_weights))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M262.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M262.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M262.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M262.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M262.", Mod.Sel1, sep ="")),
             get(paste("nls_M262.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M262.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M262.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M262.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M262.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M262.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M262.", Mod.Sel1, sep ="")),
               get(paste("nls_M262.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M262.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M262.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M262.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M262.", Mod.Sel1, sep ="")),
                 get(paste("nls_M262.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M262.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M262.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M262.", Mod.Sel1, sep ="")),
                    get(paste("nls_M262.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M262.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M262.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M262.", Mod.Sel1, sep ="")),
                      get(paste("nls_M262.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M262 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M262.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M262.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M262.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M262.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M262.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M262.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M262.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M262.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M262)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M262[!is.na(AIC2_M262$AIC) & AIC2_M262$AIC == min(AIC2_M262$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.G[Best_mods.G$Code == "M262",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M262.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M262.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df2[nls.param.df2$Code == "M262",]$ge <- coefs["ge"]
nls.param.df2[nls.param.df2$Code == "M262",]$phi <- coefs["phi"]
nls.param.df2[nls.param.df2$Code == "M262",]$alpha <- coefs["alpha"]
nls.param.df2[nls.param.df2$Code == "M262",]$A <- coefs["A"]
nls.param.df2[nls.param.df2$Code == "M262",]$k <- coefs["k"]

nls.param.df2[nls.param.df2$Code == "M262",]$ge.2.5 <- intervals_low["ge"]
nls.param.df2[nls.param.df2$Code == "M262",]$phi.2.5 <- intervals_low["phi"]
nls.param.df2[nls.param.df2$Code == "M262",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df2[nls.param.df2$Code == "M262",]$A.2.5 <- intervals_low["A"]
nls.param.df2[nls.param.df2$Code == "M262",]$k.2.5 <- intervals_low["k"]

nls.param.df2[nls.param.df2$Code == "M262",]$ge.97.5 <- intervals_high["ge"]
nls.param.df2[nls.param.df2$Code == "M262",]$phi.97.5 <- intervals_high["phi"]
nls.param.df2[nls.param.df2$Code == "M262",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df2[nls.param.df2$Code == "M262",]$A.97.5 <- intervals_high["A"]
nls.param.df2[nls.param.df2$Code == "M262",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M262.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M262.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M262.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M262.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals

```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_M262 <- nlsResiduals(
  get(paste("nls_M262.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_M262)

## test residuals
if(length(G_M262$pltID) < 5001) {test.nlsResiduals(resid_M262)}

}  else {print("cannot plot residuals")}
```

## predict and plot

```{r, message = FALSE, cache=T}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

`M262_pred2` <- predict(get(paste("nls_M262.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME_avg"= rep(mean(G_M262$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME_avg"= rep(mean(G_M262$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "DeltaPDSI"= rep(mean(G_M262$DeltaPDSI, na.rm =T), 1501))
                      } else if (Mod.Sel1 == 3){
                        data.frame("MEASTIME_avg"= rep(mean(G_M262$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "B_L_prop"= rep(mean(G_M262$B_L_prop, na.rm =T), 1501), 
                                   "DeltaPDSI"= rep(mean(G_M262$DeltaPDSI, na.rm =T), 1501))
                      } )


## predicted interval data.frame
`M262_pred_df` <- data.frame("B_plt_t1_MgHa" = seq(0,1500,by =1), fitted=`M262_pred2`)

## PLOTTING 2
gg.M262.2 <- ggplot() +
             geom_jitter(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_M262, 
                         alpha = 0.5, color = "#00000080", shape = "+") +
             ## dark ponts = "#1E88E580"
             geom_hline(yintercept =0, lty =3) +
            
             stat_summary_bin(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_M262, 
                              fun.data = function(x) {
                                res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                                names(res) <- c("ymin","y","ymax")
                                res}, 
                              col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M262))), breaks = cutvec_M262) +         
    
             # geom_ribbon(aes(x = B_plt_t1_MgHa, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
             #             data = M262_pred_df, color="#FF000080", fill ="#FF000080", alpha = 0.25, lty =3) +
             geom_line(aes(x = B_plt_t1_MgHa, y = fitted), data = `M262_pred_df`, color="#FF000080", alpha = 0.5, lwd = 2) + 
             ## red = "#D6272880" 
    
             labs(x = expression("biomass (Mg ha"^-1*")"), 
                 y = expression("biomass growth (Mg ha"^-1*" yr"^-1*")")) + 
             ggtitle("M262 - California coastal range - coniferous forest - open woodland - shrub meadow") +
             theme_classic() + theme(axis.text.x=element_text(angle=90,hjust=1)) + 
             scale_x_continuous(limits = c(0, tail(cutvec_M262,1)*1.05), expand =c(0,0)) +
             coord_cartesian(ylim=c(-2, 10))
  
             #ylim(c(min(M262_pred_df$`Prop.2.5%`)-0.25, max(M262_pred_df$`Prop.97.5%`)+0.25))
             #ylim(c(-2,8))
            
gg.M262.2

}  else {print("cannot plot data with prediction")}
```

## plotting 2

```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_M262 <-data.frame(
  bin = as.factor(levels(cut(G_M262$B_plt_t1_MgHa, cutvec_M262))),
  data.mean = tapply(G_M262$G_obs_TreeInc_MgHaYr, cut(G_M262$B_plt_t1_MgHa, cutvec_M262), 
                     mean), 
  data.CI.high =  tapply(G_M262$G_obs_TreeInc_MgHaYr, cut(G_M262$B_plt_t1_MgHa, cutvec_M262), 
                    high.CI), 
  data.CI.low = tapply(G_M262$G_obs_TreeInc_MgHaYr, cut(G_M262$B_plt_t1_MgHa, cutvec_M262),
                    low.CI), 
  pred.mean = `M262_pred_df`[`M262_pred_df`$B_plt_t1_MgHa %in% bin_mids_M262,]$fitted) 


### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M262 <-  DM_compare_M262 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M262$bin)[gtools::mixedorder(levels(DM_compare_M262$bin))]))
                                                                                                        
## ggplot
gg.M262.3 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M262) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M262))), 
                              labels = levels(DM_compare_M262$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1,  alpha = 0.5) +         
           labs(x = expression("calculated G (Mg ha"^-1*" yr"^-1*")"), 
                y = expression("nls predicted G (Mg ha"^-1*" yr"^-1*")")) +
           ggtitle("M262 - California coastal range - coniferous forest - open woodland - shrub meadow") +         
           theme_classic() + 
            theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M262.3

}
```


# M313 - Arizona-New Mexico Mountains Semi-Desert - Open Woodland - Coniferous Forest - Alpine Meadow

```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_M313 <- round(quantile(G_M313$B_plt_t1_MgHa, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M313)))){
  cutvec_M313 <- round(quantile(G_M313$B_plt_t1_MgHa, seq(0,1, length.out = 11)))
}

bin_mids_M313 <- unname(round(cutvec_M313[-length(cutvec_M313)] + diff(cutvec_M313)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_M313$Plt_B_bin <-  cut(G_M313$B_plt_t1_MgHa, cutvec_M313)
## get bin means
G_bin_means <- tapply(G_M313$G_obs_TreeInc_MgHaYr, cut(G_M313$B_plt_t1_MgHa, cutvec_M313), mean)

## make column weights.1
G_M313$nls_weights <- as.vector(1/G_bin_means[match(G_M313$Plt_B_bin, names(G_bin_means))])

}
```

## model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_M313.1 <- nls(fg_1, data = G_M313, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_M313$nls_weights), 
 )

## phi
try(
  nls_M313.2 <- nls(fg_2, data=G_M313, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_M313$nls_weights), 
 )

# phi/alpha
try(
  nls_M313.3 <- nls(fg_3 , data = G_M313, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_M313$nls_weights), 
 )

## test
if(exists("nls_M313.1") & exists("nls_M313.2") & exists("nls_M313.3")){
  print(anova(nls_M313.1, nls_M313.2, nls_M313.3))
} else if(exists("nls_M313.2") & exists("nls_M313.3")){
  print(anova(nls_M313.2, nls_M313.3))
} else if(exists("nls_M313.1") & exists("nls_M313.2")){
  print(anova(nls_M313.1, nls_M313.2))
}
 
## AIC comparison
AIC1_M313 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_M313.1"), AIC(get("nls_M313.1")), NA),
            ifelse(exists("nls_M313.2"), AIC(get("nls_M313.2")), NA),
            ifelse(exists("nls_M313.3"), AIC(get("nls_M313.3")), NA)
            ))

print(AIC1_M313) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M313[!is.na(AIC1_M313$AIC) & AIC1_M313$AIC == min(AIC1_M313$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M313.",  Mod.Sel1, sep =""))) ) #model summary

}
```
### summary 
* simple model: `r ifelse(exists("nls_M313.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M313.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_M313.3"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M313.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M313.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_M313.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_M313.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M313.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M313.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "a", sep ="")), 
          data = G_M313,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_M313$nls_weights))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M313.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "b", sep ="")), 
          data = G_M313,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_M313$nls_weights)) 
 )

## c-model: with s and p parameters
try(
  assign(
    paste("nls_M313.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "c", sep ="")), 
          data = G_M313,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_M313$nls_weights))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M313.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M313.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M313.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M313.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M313.", Mod.Sel1, sep ="")),
             get(paste("nls_M313.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M313.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M313.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M313.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M313.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M313.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M313.", Mod.Sel1, sep ="")),
               get(paste("nls_M313.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M313.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M313.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M313.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M313.", Mod.Sel1, sep ="")),
                 get(paste("nls_M313.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M313.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M313.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M313.", Mod.Sel1, sep ="")),
                    get(paste("nls_M313.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M313.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M313.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M313.", Mod.Sel1, sep ="")),
                      get(paste("nls_M313.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M313 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M313.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M313.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M313.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M313.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M313.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M313.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M313.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M313.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M313)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M313[!is.na(AIC2_M313$AIC) & AIC2_M313$AIC == min(AIC2_M313$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.G[Best_mods.G$Code == "M313",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M313.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M313.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df2[nls.param.df2$Code == "M313",]$ge <- coefs["ge"]
nls.param.df2[nls.param.df2$Code == "M313",]$phi <- coefs["phi"]
nls.param.df2[nls.param.df2$Code == "M313",]$alpha <- coefs["alpha"]
nls.param.df2[nls.param.df2$Code == "M313",]$A <- coefs["A"]
nls.param.df2[nls.param.df2$Code == "M313",]$k <- coefs["k"]

nls.param.df2[nls.param.df2$Code == "M313",]$ge.2.5 <- intervals_low["ge"]
nls.param.df2[nls.param.df2$Code == "M313",]$phi.2.5 <- intervals_low["phi"]
nls.param.df2[nls.param.df2$Code == "M313",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df2[nls.param.df2$Code == "M313",]$A.2.5 <- intervals_low["A"]
nls.param.df2[nls.param.df2$Code == "M313",]$k.2.5 <- intervals_low["k"]

nls.param.df2[nls.param.df2$Code == "M313",]$ge.97.5 <- intervals_high["ge"]
nls.param.df2[nls.param.df2$Code == "M313",]$phi.97.5 <- intervals_high["phi"]
nls.param.df2[nls.param.df2$Code == "M313",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df2[nls.param.df2$Code == "M313",]$A.97.5 <- intervals_high["A"]
nls.param.df2[nls.param.df2$Code == "M313",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M313.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M313.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M313.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M313.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals

```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_M313 <- nlsResiduals(
  get(paste("nls_M313.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_M313)

## test residuals
if(length(G_M313$pltID) < 5001) {test.nlsResiduals(resid_M313)}

}  else {print("cannot plot residuals")}
```

## predict and plot

```{r, message = FALSE, cache=T}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

`M313_pred2` <- predict(get(paste("nls_M313.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME_avg"= rep(mean(G_M313$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME_avg"= rep(mean(G_M313$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "DeltaPDSI"= rep(mean(G_M313$DeltaPDSI, na.rm =T), 1501))
                      } else if (Mod.Sel1 == 3){
                        data.frame("MEASTIME_avg"= rep(mean(G_M313$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "B_L_prop"= rep(mean(G_M313$B_L_prop, na.rm =T), 1501), 
                                   "DeltaPDSI"= rep(mean(G_M313$DeltaPDSI, na.rm =T), 1501))
                      } )


## predicted interval data.frame
`M313_pred_df` <- data.frame("B_plt_t1_MgHa" = seq(0,1500,by =1), fitted=`M313_pred2`)

## PLOTTING 2
gg.M313.2 <- ggplot() +
             geom_jitter(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_M313, 
                         alpha = 0.5, color = "#00000080", shape = "+") +
             ## dark ponts = "#1E88E580"
             geom_hline(yintercept =0, lty =3) +
            
             stat_summary_bin(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_M313, 
                              fun.data = function(x) {
                                res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                                names(res) <- c("ymin","y","ymax")
                                res}, 
                              col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M313))), breaks = cutvec_M313) +         
    
             # geom_ribbon(aes(x = B_plt_t1_MgHa, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
             #             data = M313_pred_df, color="#FF000080", fill ="#FF000080", alpha = 0.25, lty =3) +
             geom_line(aes(x = B_plt_t1_MgHa, y = fitted), data = `M313_pred_df`, color="#FF000080", alpha = 0.5, lwd = 2) + 
             ## red = "#D6272880" 
    
             labs(x = expression("biomass (Mg ha"^-1*")"), 
                 y = expression("biomass growth (Mg ha"^-1*" yr"^-1*")")) + 
             ggtitle("M313 - Arizona-New Mexico Mountains Semi-Desert - Open Woodland - Coniferous Forest - Alpine Meadow") +
             theme_classic() + theme(axis.text.x=element_text(angle=90,hjust=1)) + 
             scale_x_continuous(limits = c(0, tail(cutvec_M313,1)*1.05), expand =c(0,0)) +
             coord_cartesian(ylim=c(-2, 10))
  
             #ylim(c(min(M313_pred_df$`Prop.2.5%`)-0.25, max(M313_pred_df$`Prop.97.5%`)+0.25))
             #ylim(c(-2,8))
            
gg.M313.2

}  else {print("cannot plot data with prediction")}
```

## plotting 2

```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_M313 <-data.frame(
  bin = as.factor(levels(cut(G_M313$B_plt_t1_MgHa, cutvec_M313))),
  data.mean = tapply(G_M313$G_obs_TreeInc_MgHaYr, cut(G_M313$B_plt_t1_MgHa, cutvec_M313), 
                     mean), 
  data.CI.high =  tapply(G_M313$G_obs_TreeInc_MgHaYr, cut(G_M313$B_plt_t1_MgHa, cutvec_M313), 
                    high.CI), 
  data.CI.low = tapply(G_M313$G_obs_TreeInc_MgHaYr, cut(G_M313$B_plt_t1_MgHa, cutvec_M313),
                    low.CI), 
  pred.mean = `M313_pred_df`[`M313_pred_df`$B_plt_t1_MgHa %in% bin_mids_M313,]$fitted) 


### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M313 <-  DM_compare_M313 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M313$bin)[gtools::mixedorder(levels(DM_compare_M313$bin))]))
                                                                                                        
## ggplot
gg.M313.3 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M313) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M313))), 
                              labels = levels(DM_compare_M313$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1,  alpha = 0.5) +         
           labs(x = expression("calculated G (Mg ha"^-1*" yr"^-1*")"), 
                y = expression("nls predicted G (Mg ha"^-1*" yr"^-1*")")) +
           ggtitle("M313 - Arizona-New Mexico Mountains Semi-Desert - Open Woodland - Coniferous Forest - Alpine Meadow") +         
           theme_classic() + 
            theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M313.3

}
```


# M331 - Southern Rocky Mountain Steppe - Open Woodland - Coniferous Forest - Alpine Meadow

```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_M331 <- round(quantile(G_M331$B_plt_t1_MgHa, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M331)))){
  cutvec_M331 <- round(quantile(G_M331$B_plt_t1_MgHa, seq(0,1, length.out = 11)))
}

bin_mids_M331 <- unname(round(cutvec_M331[-length(cutvec_M331)] + diff(cutvec_M331)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_M331$Plt_B_bin <-  cut(G_M331$B_plt_t1_MgHa, cutvec_M331)
## get bin means
G_bin_means <- tapply(G_M331$G_obs_TreeInc_MgHaYr, cut(G_M331$B_plt_t1_MgHa, cutvec_M331), mean)

## make column weights.1
G_M331$nls_weights <- as.vector(1/G_bin_means[match(G_M331$Plt_B_bin, names(G_bin_means))])

}
```

## model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_M331.1 <- nls(fg_1, data = G_M331, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_M331$nls_weights), 
 )

## phi
try(
  nls_M331.2 <- nls(fg_2, data=G_M331, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_M331$nls_weights), 
 )

# phi/alpha
try(
  nls_M331.3 <- nls(fg_3 , data = G_M331, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_M331$nls_weights), 
 )

## test
if(exists("nls_M331.1") & exists("nls_M331.2") & exists("nls_M331.3")){
  print(anova(nls_M331.1, nls_M331.2, nls_M331.3))
} else if(exists("nls_M331.2") & exists("nls_M331.3")){
  print(anova(nls_M331.2, nls_M331.3))
} else if(exists("nls_M331.1") & exists("nls_M331.2")){
  print(anova(nls_M331.1, nls_M331.2))
}
 
## AIC comparison
AIC1_M331 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_M331.1"), AIC(get("nls_M331.1")), NA),
            ifelse(exists("nls_M331.2"), AIC(get("nls_M331.2")), NA),
            ifelse(exists("nls_M331.3"), AIC(get("nls_M331.3")), NA)
            ))

print(AIC1_M331) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M331[!is.na(AIC1_M331$AIC) & AIC1_M331$AIC == min(AIC1_M331$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M331.",  Mod.Sel1, sep =""))) ) #model summary

}
```
### summary 
* simple model: `r ifelse(exists("nls_M331.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M331.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_M331.3"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M331.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M331.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_M331.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_M331.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M331.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M331.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "a", sep ="")), 
          data = G_M331,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_M331$nls_weights))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M331.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "b", sep ="")), 
          data = G_M331,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_M331$nls_weights)) 
 )

## c-model: with s and p parameters
try(
  assign(
    paste("nls_M331.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "c", sep ="")), 
          data = G_M331,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_M331$nls_weights))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M331.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M331.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M331.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M331.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M331.", Mod.Sel1, sep ="")),
             get(paste("nls_M331.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M331.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M331.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M331.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M331.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M331.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M331.", Mod.Sel1, sep ="")),
               get(paste("nls_M331.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M331.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M331.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M331.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M331.", Mod.Sel1, sep ="")),
                 get(paste("nls_M331.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M331.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M331.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M331.", Mod.Sel1, sep ="")),
                    get(paste("nls_M331.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M331.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M331.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M331.", Mod.Sel1, sep ="")),
                      get(paste("nls_M331.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M331 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M331.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M331.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M331.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M331.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M331.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M331.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M331.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M331.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M331)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M331[!is.na(AIC2_M331$AIC) & AIC2_M331$AIC == min(AIC2_M331$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.G[Best_mods.G$Code == "M331",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M331.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M331.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df2[nls.param.df2$Code == "M331",]$ge <- coefs["ge"]
nls.param.df2[nls.param.df2$Code == "M331",]$phi <- coefs["phi"]
nls.param.df2[nls.param.df2$Code == "M331",]$alpha <- coefs["alpha"]
nls.param.df2[nls.param.df2$Code == "M331",]$A <- coefs["A"]
nls.param.df2[nls.param.df2$Code == "M331",]$k <- coefs["k"]

nls.param.df2[nls.param.df2$Code == "M331",]$ge.2.5 <- intervals_low["ge"]
nls.param.df2[nls.param.df2$Code == "M331",]$phi.2.5 <- intervals_low["phi"]
nls.param.df2[nls.param.df2$Code == "M331",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df2[nls.param.df2$Code == "M331",]$A.2.5 <- intervals_low["A"]
nls.param.df2[nls.param.df2$Code == "M331",]$k.2.5 <- intervals_low["k"]

nls.param.df2[nls.param.df2$Code == "M331",]$ge.97.5 <- intervals_high["ge"]
nls.param.df2[nls.param.df2$Code == "M331",]$phi.97.5 <- intervals_high["phi"]
nls.param.df2[nls.param.df2$Code == "M331",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df2[nls.param.df2$Code == "M331",]$A.97.5 <- intervals_high["A"]
nls.param.df2[nls.param.df2$Code == "M331",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M331.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M331.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M331.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M331.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals

```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_M331 <- nlsResiduals(
  get(paste("nls_M331.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_M331)

## test residuals
if(length(G_M331$pltID) < 5001) {test.nlsResiduals(resid_M331)}

}  else {print("cannot plot residuals")}
```

## predict and plot

```{r, message = FALSE, cache=T}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

`M331_pred2` <- predict(get(paste("nls_M331.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME_avg"= rep(mean(G_M331$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME_avg"= rep(mean(G_M331$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "DeltaPDSI"= rep(mean(G_M331$DeltaPDSI, na.rm =T), 1501))
                      } else if (Mod.Sel1 == 3){
                        data.frame("MEASTIME_avg"= rep(mean(G_M331$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "B_L_prop"= rep(mean(G_M331$B_L_prop, na.rm =T), 1501), 
                                   "DeltaPDSI"= rep(mean(G_M331$DeltaPDSI, na.rm =T), 1501))
                      } )


## predicted interval data.frame
`M331_pred_df` <- data.frame("B_plt_t1_MgHa" = seq(0,1500,by =1), fitted=`M331_pred2`)

## PLOTTING 2
gg.M331.2 <- ggplot() +
             geom_jitter(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_M331, 
                         alpha = 0.5, color = "#00000080", shape = "+") +
             ## dark ponts = "#1E88E580"
             geom_hline(yintercept =0, lty =3) +
            
             stat_summary_bin(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_M331, 
                              fun.data = function(x) {
                                res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                                names(res) <- c("ymin","y","ymax")
                                res}, 
                              col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M331))), breaks = cutvec_M331) +         
    
             # geom_ribbon(aes(x = B_plt_t1_MgHa, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
             #             data = M331_pred_df, color="#FF000080", fill ="#FF000080", alpha = 0.25, lty =3) +
             geom_line(aes(x = B_plt_t1_MgHa, y = fitted), data = `M331_pred_df`, color="#FF000080", alpha = 0.5, lwd = 2) + 
             ## red = "#D6272880" 
    
             labs(x = expression("biomass (Mg ha"^-1*")"), 
                 y = expression("biomass growth (Mg ha"^-1*" yr"^-1*")")) + 
             ggtitle("M331 - Southern Rocky Mountain Steppe - Open Woodland - Coniferous Forest - Alpine Meadow") +
             theme_classic() + theme(axis.text.x=element_text(angle=90,hjust=1)) + 
             scale_x_continuous(limits = c(0, tail(cutvec_M331,1)*1.05), expand =c(0,0)) +
             coord_cartesian(ylim=c(-2, 10))
  
             #ylim(c(min(M331_pred_df$`Prop.2.5%`)-0.25, max(M331_pred_df$`Prop.97.5%`)+0.25))
             #ylim(c(-2,8))
            
gg.M331.2

}  else {print("cannot plot data with prediction")}
```

## plotting 2

```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_M331 <-data.frame(
  bin = as.factor(levels(cut(G_M331$B_plt_t1_MgHa, cutvec_M331))),
  data.mean = tapply(G_M331$G_obs_TreeInc_MgHaYr, cut(G_M331$B_plt_t1_MgHa, cutvec_M331), 
                     mean), 
  data.CI.high =  tapply(G_M331$G_obs_TreeInc_MgHaYr, cut(G_M331$B_plt_t1_MgHa, cutvec_M331), 
                    high.CI), 
  data.CI.low = tapply(G_M331$G_obs_TreeInc_MgHaYr, cut(G_M331$B_plt_t1_MgHa, cutvec_M331),
                    low.CI), 
  pred.mean = `M331_pred_df`[`M331_pred_df`$B_plt_t1_MgHa %in% bin_mids_M331,]$fitted) 


### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M331 <-  DM_compare_M331 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M331$bin)[gtools::mixedorder(levels(DM_compare_M331$bin))]))
                                                                                                        
## ggplot
gg.M331.3 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M331) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M331))), 
                              labels = levels(DM_compare_M331$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1,  alpha = 0.5) +         
           labs(x = expression("calculated G (Mg ha"^-1*" yr"^-1*")"), 
                y = expression("nls predicted G (Mg ha"^-1*" yr"^-1*")")) +
           ggtitle("M331 - Southern Rocky Mountain Steppe - Open Woodland - Coniferous Forest - Alpine Meadow") +         
           theme_classic() + 
            theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M331.3

}
```


# M332 - Middle Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow

```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_M332 <- round(quantile(G_M332$B_plt_t1_MgHa, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M332)))){
  cutvec_M332 <- round(quantile(G_M332$B_plt_t1_MgHa, seq(0,1, length.out = 11)))
}

bin_mids_M332 <- unname(round(cutvec_M332[-length(cutvec_M332)] + diff(cutvec_M332)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_M332$Plt_B_bin <-  cut(G_M332$B_plt_t1_MgHa, cutvec_M332)
## get bin means
G_bin_means <- tapply(G_M332$G_obs_TreeInc_MgHaYr, cut(G_M332$B_plt_t1_MgHa, cutvec_M332), mean)

## make column weights.1
G_M332$nls_weights <- as.vector(1/G_bin_means[match(G_M332$Plt_B_bin, names(G_bin_means))])

}
```

## model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_M332.1 <- nls(fg_1, data = G_M332, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_M332$nls_weights), 
 )

## phi
try(
  nls_M332.2 <- nls(fg_2, data=G_M332, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_M332$nls_weights), 
 )

# phi/alpha
try(
  nls_M332.3 <- nls(fg_3 , data = G_M332, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_M332$nls_weights), 
 )

## test
if(exists("nls_M332.1") & exists("nls_M332.2") & exists("nls_M332.3")){
  print(anova(nls_M332.1, nls_M332.2, nls_M332.3))
} else if(exists("nls_M332.2") & exists("nls_M332.3")){
  print(anova(nls_M332.2, nls_M332.3))
} else if(exists("nls_M332.1") & exists("nls_M332.2")){
  print(anova(nls_M332.1, nls_M332.2))
}
 
## AIC comparison
AIC1_M332 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_M332.1"), AIC(get("nls_M332.1")), NA),
            ifelse(exists("nls_M332.2"), AIC(get("nls_M332.2")), NA),
            ifelse(exists("nls_M332.3"), AIC(get("nls_M332.3")), NA)
            ))

print(AIC1_M332) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M332[!is.na(AIC1_M332$AIC) & AIC1_M332$AIC == min(AIC1_M332$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M332.",  Mod.Sel1, sep =""))) ) #model summary

}
```
### summary 
* simple model: `r ifelse(exists("nls_M332.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M332.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_M332.3"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M332.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M332.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_M332.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_M332.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M332.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M332.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "a", sep ="")), 
          data = G_M332,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_M332$nls_weights))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M332.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "b", sep ="")), 
          data = G_M332,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 
          weights = G_M332$nls_weights)) 
 )

## c-model: with s and p parameters
try(
  assign(
    paste("nls_M332.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "c", sep ="")), 
          data = G_M332,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_M332$nls_weights))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M332.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M332.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M332.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M332.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M332.", Mod.Sel1, sep ="")),
             get(paste("nls_M332.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M332.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M332.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M332.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M332.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M332.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M332.", Mod.Sel1, sep ="")),
               get(paste("nls_M332.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M332.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M332.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M332.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M332.", Mod.Sel1, sep ="")),
                 get(paste("nls_M332.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M332.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M332.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M332.", Mod.Sel1, sep ="")),
                    get(paste("nls_M332.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M332.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M332.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M332.", Mod.Sel1, sep ="")),
                      get(paste("nls_M332.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M332 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M332.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M332.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M332.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M332.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M332.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M332.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M332.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M332.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M332)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M332[!is.na(AIC2_M332$AIC) & AIC2_M332$AIC == min(AIC2_M332$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.G[Best_mods.G$Code == "M332",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M332.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M332.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df2[nls.param.df2$Code == "M332",]$ge <- coefs["ge"]
nls.param.df2[nls.param.df2$Code == "M332",]$phi <- coefs["phi"]
nls.param.df2[nls.param.df2$Code == "M332",]$alpha <- coefs["alpha"]
nls.param.df2[nls.param.df2$Code == "M332",]$A <- coefs["A"]
nls.param.df2[nls.param.df2$Code == "M332",]$k <- coefs["k"]

nls.param.df2[nls.param.df2$Code == "M332",]$ge.2.5 <- intervals_low["ge"]
nls.param.df2[nls.param.df2$Code == "M332",]$phi.2.5 <- intervals_low["phi"]
nls.param.df2[nls.param.df2$Code == "M332",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df2[nls.param.df2$Code == "M332",]$A.2.5 <- intervals_low["A"]
nls.param.df2[nls.param.df2$Code == "M332",]$k.2.5 <- intervals_low["k"]

nls.param.df2[nls.param.df2$Code == "M332",]$ge.97.5 <- intervals_high["ge"]
nls.param.df2[nls.param.df2$Code == "M332",]$phi.97.5 <- intervals_high["phi"]
nls.param.df2[nls.param.df2$Code == "M332",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df2[nls.param.df2$Code == "M332",]$A.97.5 <- intervals_high["A"]
nls.param.df2[nls.param.df2$Code == "M332",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M332.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M332.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M332.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M332.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals

```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_M332 <- nlsResiduals(
  get(paste("nls_M332.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_M332)

## test residuals
if(length(G_M332$pltID) < 5001) {test.nlsResiduals(resid_M332)}

}  else {print("cannot plot residuals")}
```

## predict and plot

```{r, message = FALSE, cache=T}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

`M332_pred2` <- predict(get(paste("nls_M332.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME_avg"= rep(mean(G_M332$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME_avg"= rep(mean(G_M332$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "DeltaPDSI"= rep(mean(G_M332$DeltaPDSI, na.rm =T), 1501))
                      } else if (Mod.Sel1 == 3){
                        data.frame("MEASTIME_avg"= rep(mean(G_M332$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "B_L_prop"= rep(mean(G_M332$B_L_prop, na.rm =T), 1501), 
                                   "DeltaPDSI"= rep(mean(G_M332$DeltaPDSI, na.rm =T), 1501))
                      } )


## predicted interval data.frame
`M332_pred_df` <- data.frame("B_plt_t1_MgHa" = seq(0,1500,by =1), fitted=`M332_pred2`)

## PLOTTING 2
gg.M332.2 <- ggplot() +
             geom_jitter(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_M332, 
                         alpha = 0.5, color = "#00000080", shape = "+") +
             ## dark ponts = "#1E88E580"
             geom_hline(yintercept =0, lty =3) +
            
             stat_summary_bin(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_M332, 
                              fun.data = function(x) {
                                res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                                names(res) <- c("ymin","y","ymax")
                                res}, 
                              col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M332))), breaks = cutvec_M332) +         
    
             # geom_ribbon(aes(x = B_plt_t1_MgHa, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
             #             data = M332_pred_df, color="#FF000080", fill ="#FF000080", alpha = 0.25, lty =3) +
             geom_line(aes(x = B_plt_t1_MgHa, y = fitted), data = `M332_pred_df`, color="#FF000080", alpha = 0.5, lwd = 2) + 
             ## red = "#D6272880" 
    
             labs(x = expression("biomass (Mg ha"^-1*")"), 
                 y = expression("biomass growth (Mg ha"^-1*" yr"^-1*")")) + 
             ggtitle("M332 -  Middle Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow") +
             theme_classic() + theme(axis.text.x=element_text(angle=90,hjust=1)) + 
             scale_x_continuous(limits = c(0, tail(cutvec_M332,1)*1.05), expand =c(0,0)) +
             coord_cartesian(ylim=c(-2, 10))
  
             #ylim(c(min(M332_pred_df$`Prop.2.5%`)-0.25, max(M332_pred_df$`Prop.97.5%`)+0.25))
             #ylim(c(-2,8))
            
gg.M332.2

}  else {print("cannot plot data with prediction")}
```

## plotting 2

```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_M332 <-data.frame(
  bin = as.factor(levels(cut(G_M332$B_plt_t1_MgHa, cutvec_M332))),
  data.mean = tapply(G_M332$G_obs_TreeInc_MgHaYr, cut(G_M332$B_plt_t1_MgHa, cutvec_M332), 
                     mean), 
  data.CI.high =  tapply(G_M332$G_obs_TreeInc_MgHaYr, cut(G_M332$B_plt_t1_MgHa, cutvec_M332), 
                    high.CI), 
  data.CI.low = tapply(G_M332$G_obs_TreeInc_MgHaYr, cut(G_M332$B_plt_t1_MgHa, cutvec_M332),
                    low.CI), 
  pred.mean = `M332_pred_df`[`M332_pred_df`$B_plt_t1_MgHa %in% bin_mids_M332,]$fitted) 


### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M332 <-  DM_compare_M332 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M332$bin)[gtools::mixedorder(levels(DM_compare_M332$bin))]))
                                                                                                        
## ggplot
gg.M332.3 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M332) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M332))), 
                              labels = levels(DM_compare_M332$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1,  alpha = 0.5) +         
           labs(x = expression("calculated G (Mg ha"^-1*" yr"^-1*")"), 
                y = expression("nls predicted G (Mg ha"^-1*" yr"^-1*")")) +
           ggtitle("M332 -  Middle Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow") +         
           theme_classic() + 
            theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M332.3

}
```


# M333 - Northern Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow

```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_M333 <- round(quantile(G_M333$B_plt_t1_MgHa, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M333)))){
  cutvec_M333 <- round(quantile(G_M333$B_plt_t1_MgHa, seq(0,1, length.out = 11)))
}

bin_mids_M333 <- unname(round(cutvec_M333[-length(cutvec_M333)] + diff(cutvec_M333)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_M333$Plt_B_bin <-  cut(G_M333$B_plt_t1_MgHa, cutvec_M333)
## get bin means
G_bin_means <- tapply(G_M333$G_obs_TreeInc_MgHaYr, cut(G_M333$B_plt_t1_MgHa, cutvec_M333), mean)

## make column weights.1
G_M333$nls_weights <- as.vector(1/G_bin_means[match(G_M333$Plt_B_bin, names(G_bin_means))])

}
```

## model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_M333.1 <- nls(fg_1, data = G_M333, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_M333$nls_weights), 
 )

## phi
try(
  nls_M333.2 <- nls(fg_2, data=G_M333, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_M333$nls_weights), 
 )

# phi/alpha
try(
  nls_M333.3 <- nls(fg_3 , data = G_M333, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_M333$nls_weights), 
 )

## test
if(exists("nls_M333.1") & exists("nls_M333.2") & exists("nls_M333.3")){
  print(anova(nls_M333.1, nls_M333.2, nls_M333.3))
} else if(exists("nls_M333.2") & exists("nls_M333.3")){
  print(anova(nls_M333.2, nls_M333.3))
} else if(exists("nls_M333.1") & exists("nls_M333.2")){
  print(anova(nls_M333.1, nls_M333.2))
}
 
## AIC comparison
AIC1_M333 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_M333.1"), AIC(get("nls_M333.1")), NA),
            ifelse(exists("nls_M333.2"), AIC(get("nls_M333.2")), NA),
            ifelse(exists("nls_M333.3"), AIC(get("nls_M333.3")), NA)
            ))

print(AIC1_M333) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M333[!is.na(AIC1_M333$AIC) & AIC1_M333$AIC == min(AIC1_M333$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M333.",  Mod.Sel1, sep =""))) ) #model summary

}
```
### summary 
* simple model: `r ifelse(exists("nls_M333.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M333.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_M333.3"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M333.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M333.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_M333.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_M333.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M333.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M333.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "a", sep ="")), 
          data = G_M333,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_M333$nls_weights))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M333.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "b", sep ="")), 
          data = G_M333,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)}, 

          weights = G_M333$nls_weights)) 
 )

## c-model: with s and p parameters
try(
  assign(
    paste("nls_M333.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "c", sep ="")), 
          data = G_M333,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_M333$nls_weights))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M333.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M333.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M333.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M333.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M333.", Mod.Sel1, sep ="")),
             get(paste("nls_M333.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M333.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M333.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M333.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M333.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M333.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M333.", Mod.Sel1, sep ="")),
               get(paste("nls_M333.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M333.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M333.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M333.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M333.", Mod.Sel1, sep ="")),
                 get(paste("nls_M333.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M333.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M333.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M333.", Mod.Sel1, sep ="")),
                    get(paste("nls_M333.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M333.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M333.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M333.", Mod.Sel1, sep ="")),
                      get(paste("nls_M333.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M333 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M333.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M333.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M333.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M333.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M333.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M333.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M333.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M333.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M333)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M333[!is.na(AIC2_M333$AIC) & AIC2_M333$AIC == min(AIC2_M333$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.G[Best_mods.G$Code == "M333",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M333.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M333.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df2[nls.param.df2$Code == "M333",]$ge <- coefs["ge"]
nls.param.df2[nls.param.df2$Code == "M333",]$phi <- coefs["phi"]
nls.param.df2[nls.param.df2$Code == "M333",]$alpha <- coefs["alpha"]
nls.param.df2[nls.param.df2$Code == "M333",]$A <- coefs["A"]
nls.param.df2[nls.param.df2$Code == "M333",]$k <- coefs["k"]

nls.param.df2[nls.param.df2$Code == "M333",]$ge.2.5 <- intervals_low["ge"]
nls.param.df2[nls.param.df2$Code == "M333",]$phi.2.5 <- intervals_low["phi"]
nls.param.df2[nls.param.df2$Code == "M333",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df2[nls.param.df2$Code == "M333",]$A.2.5 <- intervals_low["A"]
nls.param.df2[nls.param.df2$Code == "M333",]$k.2.5 <- intervals_low["k"]

nls.param.df2[nls.param.df2$Code == "M333",]$ge.97.5 <- intervals_high["ge"]
nls.param.df2[nls.param.df2$Code == "M333",]$phi.97.5 <- intervals_high["phi"]
nls.param.df2[nls.param.df2$Code == "M333",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df2[nls.param.df2$Code == "M333",]$A.97.5 <- intervals_high["A"]
nls.param.df2[nls.param.df2$Code == "M333",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M333.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M333.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M333.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M333.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals

```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_M333 <- nlsResiduals(
  get(paste("nls_M333.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_M333)

## test residuals
if(length(G_M333$pltID) < 5001) {test.nlsResiduals(resid_M333)}

}  else {print("cannot plot residuals")}
```

## predict and plot

```{r, message = FALSE, cache=T}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

`M333_pred2` <- predict(get(paste("nls_M333.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME_avg"= rep(mean(G_M333$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME_avg"= rep(mean(G_M333$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "DeltaPDSI"= rep(mean(G_M333$DeltaPDSI, na.rm =T), 1501))
                      } else if (Mod.Sel1 == 3){
                        data.frame("MEASTIME_avg"= rep(mean(G_M333$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "B_L_prop"= rep(mean(G_M333$B_L_prop, na.rm =T), 1501), 
                                   "DeltaPDSI"= rep(mean(G_M333$DeltaPDSI, na.rm =T), 1501))
                      } )


## predicted interval data.frame
`M333_pred_df` <- data.frame("B_plt_t1_MgHa" = seq(0,1500,by =1), fitted=`M333_pred2`)

## PLOTTING 2
gg.M333.2 <- ggplot() +
             geom_jitter(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_M333, 
                         alpha = 0.5, color = "#00000080", shape = "+") +
             ## dark ponts = "#1E88E580"
             geom_hline(yintercept =0, lty =3) +
            
             stat_summary_bin(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_M333, 
                              fun.data = function(x) {
                                res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                                names(res) <- c("ymin","y","ymax")
                                res}, 
                              col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M333))), breaks = cutvec_M333) +         
    
             # geom_ribbon(aes(x = B_plt_t1_MgHa, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
             #             data = M333_pred_df, color="#FF000080", fill ="#FF000080", alpha = 0.25, lty =3) +
             geom_line(aes(x = B_plt_t1_MgHa, y = fitted), data = `M333_pred_df`, color="#FF000080", alpha = 0.5, lwd = 2) + 
             ## red = "#D6272880" 
    
             labs(x = expression("biomass (Mg ha"^-1*")"), 
                 y = expression("biomass growth (Mg ha"^-1*" yr"^-1*")")) + 
             ggtitle("M333 - Northern Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow") +
             theme_classic() + theme(axis.text.x=element_text(angle=90,hjust=1)) + 
             scale_x_continuous(limits = c(0, tail(cutvec_M333,1)*1.05), expand =c(0,0)) +
             coord_cartesian(ylim=c(-2, 10))
  
             #ylim(c(min(M333_pred_df$`Prop.2.5%`)-0.25, max(M333_pred_df$`Prop.97.5%`)+0.25))
             #ylim(c(-2,8))
            
gg.M333.2

}  else {print("cannot plot data with prediction")}
```

## plotting 2

```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_M333 <-data.frame(
  bin = as.factor(levels(cut(G_M333$B_plt_t1_MgHa, cutvec_M333))),
  data.mean = tapply(G_M333$G_obs_TreeInc_MgHaYr, cut(G_M333$B_plt_t1_MgHa, cutvec_M333), 
                     mean), 
  data.CI.high =  tapply(G_M333$G_obs_TreeInc_MgHaYr, cut(G_M333$B_plt_t1_MgHa, cutvec_M333), 
                    high.CI), 
  data.CI.low = tapply(G_M333$G_obs_TreeInc_MgHaYr, cut(G_M333$B_plt_t1_MgHa, cutvec_M333),
                    low.CI), 
  pred.mean = `M333_pred_df`[`M333_pred_df`$B_plt_t1_MgHa %in% bin_mids_M333,]$fitted) 


### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M333 <-  DM_compare_M333 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M333$bin)[gtools::mixedorder(levels(DM_compare_M333$bin))]))
                                                                                                        
## ggplot
gg.M333.3 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M333) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M333))), 
                              labels = levels(DM_compare_M333$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1,  alpha = 0.5) +         
           labs(x = expression("calculated G (Mg ha"^-1*" yr"^-1*")"), 
                y = expression("nls predicted G (Mg ha"^-1*" yr"^-1*")")) +
           ggtitle("M333 - Northern Rocky Mountain Steppe - Coniferous Forest - Alpine Meadow") +         
           theme_classic() + 
            theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M333.3

}
```


# M334 - Black Hills Coniferous Forest

```{r}
## code control 
fit.models <-  T
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_M334 <- round(quantile(G_M334$B_plt_t1_MgHa, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M334)))){
  cutvec_M334 <- round(quantile(G_M334$B_plt_t1_MgHa, seq(0,1, length.out = 11)))
}

bin_mids_M334 <- unname(round(cutvec_M334[-length(cutvec_M334)] + diff(cutvec_M334)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_M334$Plt_B_bin <-  cut(G_M334$B_plt_t1_MgHa, cutvec_M334)
## get bin means
G_bin_means <- tapply(G_M334$G_obs_TreeInc_MgHaYr, cut(G_M334$B_plt_t1_MgHa, cutvec_M334), mean)

## make column weights.1
G_M334$nls_weights <- as.vector(1/G_bin_means[match(G_M334$Plt_B_bin, names(G_bin_means))])

}
```

## model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_M334.1 <- nls(fg_1, data = G_M334, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_M334$nls_weights), 
 )

## phi
try(
  nls_M334.2 <- nls(fg_2, data=G_M334, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_M334$nls_weights), 
 )

# phi/alpha
try(
  nls_M334.3 <- nls(fg_3 , data = G_M334, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_M334$nls_weights), 
 )

## test
if(exists("nls_M334.1") & exists("nls_M334.2") & exists("nls_M334.3")){
  print(anova(nls_M334.1, nls_M334.2, nls_M334.3))
} else if(exists("nls_M334.2") & exists("nls_M334.3")){
  print(anova(nls_M334.2, nls_M334.3))
} else if(exists("nls_M334.1") & exists("nls_M334.2")){
  print(anova(nls_M334.1, nls_M334.2))
}
 
## AIC comparison
AIC1_M334 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_M334.1"), AIC(get("nls_M334.1")), NA),
            ifelse(exists("nls_M334.2"), AIC(get("nls_M334.2")), NA),
            ifelse(exists("nls_M334.3"), AIC(get("nls_M334.3")), NA)
            ))

print(AIC1_M334) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M334[!is.na(AIC1_M334$AIC) & AIC1_M334$AIC == min(AIC1_M334$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M334.",  Mod.Sel1, sep =""))) ) #model summary

}
```
### summary 
* simple model: `r ifelse(exists("nls_M334.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M334.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_M334.3"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M334.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M334.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_M334.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_M334.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M334.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M334.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "a", sep ="")), 
          data = G_M334,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_M334$nls_weights))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M334.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "b", sep ="")), 
          data = G_M334,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_M334$nls_weights)) 
 )

## c-model: with s and p parameters
try(
  assign(
    paste("nls_M334.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "c", sep ="")), 
          data = G_M334,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)}, 
          weights = G_M334$nls_weights))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M334.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M334.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M334.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M334.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M334.", Mod.Sel1, sep ="")),
             get(paste("nls_M334.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M334.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M334.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M334.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M334.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M334.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M334.", Mod.Sel1, sep ="")),
               get(paste("nls_M334.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M334.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M334.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M334.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M334.", Mod.Sel1, sep ="")),
                 get(paste("nls_M334.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M334.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M334.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M334.", Mod.Sel1, sep ="")),
                    get(paste("nls_M334.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M334.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M334.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M334.", Mod.Sel1, sep ="")),
                      get(paste("nls_M334.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M334 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M334.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M334.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M334.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M334.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M334.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M334.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M334.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M334.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M334)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M334[!is.na(AIC2_M334$AIC) & AIC2_M334$AIC == min(AIC2_M334$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.G[Best_mods.G$Code == "M334",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M334.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M334.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df2[nls.param.df2$Code == "M334",]$ge <- coefs["ge"]
nls.param.df2[nls.param.df2$Code == "M334",]$phi <- coefs["phi"]
nls.param.df2[nls.param.df2$Code == "M334",]$alpha <- coefs["alpha"]
nls.param.df2[nls.param.df2$Code == "M334",]$A <- coefs["A"]
nls.param.df2[nls.param.df2$Code == "M334",]$k <- coefs["k"]

nls.param.df2[nls.param.df2$Code == "M334",]$ge.2.5 <- intervals_low["ge"]
nls.param.df2[nls.param.df2$Code == "M334",]$phi.2.5 <- intervals_low["phi"]
nls.param.df2[nls.param.df2$Code == "M334",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df2[nls.param.df2$Code == "M334",]$A.2.5 <- intervals_low["A"]
nls.param.df2[nls.param.df2$Code == "M334",]$k.2.5 <- intervals_low["k"]

nls.param.df2[nls.param.df2$Code == "M334",]$ge.97.5 <- intervals_high["ge"]
nls.param.df2[nls.param.df2$Code == "M334",]$phi.97.5 <- intervals_high["phi"]
nls.param.df2[nls.param.df2$Code == "M334",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df2[nls.param.df2$Code == "M334",]$A.97.5 <- intervals_high["A"]
nls.param.df2[nls.param.df2$Code == "M334",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M334.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M334.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M334.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M334.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals

```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_M334 <- nlsResiduals(
  get(paste("nls_M334.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_M334)

## test residuals
if(length(G_M334$pltID) < 5001) {test.nlsResiduals(resid_M334)}

}  else {print("cannot plot residuals")}
```

## predict and plot

```{r, message = FALSE, cache=T}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

`M334_pred2` <- predict(get(paste("nls_M334.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME_avg"= rep(mean(G_M334$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME_avg"= rep(mean(G_M334$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "DeltaPDSI"= rep(mean(G_M334$DeltaPDSI, na.rm =T), 1501))
                      } else if (Mod.Sel1 == 3){
                        data.frame("MEASTIME_avg"= rep(mean(G_M334$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "B_L_prop"= rep(mean(G_M334$B_L_prop, na.rm =T), 1501), 
                                   "DeltaPDSI"= rep(mean(G_M334$DeltaPDSI, na.rm =T), 1501))
                      } )


## predicted interval data.frame
`M334_pred_df` <- data.frame("B_plt_t1_MgHa" = seq(0,1500,by =1), fitted=`M334_pred2`)

## PLOTTING 2
gg.M334.2 <- ggplot() +
             geom_jitter(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_M334, 
                         alpha = 0.5, color = "#00000080", shape = "+") +
             ## dark ponts = "#1E88E580"
             geom_hline(yintercept =0, lty =3) +
            
             stat_summary_bin(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_M334, 
                              fun.data = function(x) {
                                res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                                names(res) <- c("ymin","y","ymax")
                                res}, 
                              col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M334))), breaks = cutvec_M334) +         
    
             # geom_ribbon(aes(x = B_plt_t1_MgHa, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
             #             data = M334_pred_df, color="#FF000080", fill ="#FF000080", alpha = 0.25, lty =3) +
             geom_line(aes(x = B_plt_t1_MgHa, y = fitted), data = `M334_pred_df`, color="#FF000080", alpha = 0.5, lwd = 2) + 
             ## red = "#D6272880" 
    
             labs(x = expression("biomass (Mg ha"^-1*")"), 
                 y = expression("biomass growth (Mg ha"^-1*" yr"^-1*")")) + 
             ggtitle("M334 - Black Hills Coniferous Forest") +
             theme_classic() + theme(axis.text.x=element_text(angle=90,hjust=1)) + 
             scale_x_continuous(limits = c(0, tail(cutvec_M334,1)*1.05), expand =c(0,0)) +
             coord_cartesian(ylim=c(-2, 10))
  
             #ylim(c(min(M334_pred_df$`Prop.2.5%`)-0.25, max(M334_pred_df$`Prop.97.5%`)+0.25))
             #ylim(c(-2,8))
            
gg.M334.2

}  else {print("cannot plot data with prediction")}
```

## plotting 2

```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_M334 <-data.frame(
  bin = as.factor(levels(cut(G_M334$B_plt_t1_MgHa, cutvec_M334))),
  data.mean = tapply(G_M334$G_obs_TreeInc_MgHaYr, cut(G_M334$B_plt_t1_MgHa, cutvec_M334), 
                     mean), 
  data.CI.high =  tapply(G_M334$G_obs_TreeInc_MgHaYr, cut(G_M334$B_plt_t1_MgHa, cutvec_M334), 
                    high.CI), 
  data.CI.low = tapply(G_M334$G_obs_TreeInc_MgHaYr, cut(G_M334$B_plt_t1_MgHa, cutvec_M334),
                    low.CI), 
  pred.mean = `M334_pred_df`[`M334_pred_df`$B_plt_t1_MgHa %in% bin_mids_M334,]$fitted) 


### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M334 <-  DM_compare_M334 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M334$bin)[gtools::mixedorder(levels(DM_compare_M334$bin))]))
                                                                                                        
## ggplot
gg.M334.3 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M334) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M334))), 
                              labels = levels(DM_compare_M334$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1,  alpha = 0.5) +         
           labs(x = expression("calculated G (Mg ha"^-1*" yr"^-1*")"), 
                y = expression("nls predicted G (Mg ha"^-1*" yr"^-1*")")) +
           ggtitle("M334 - Black Hills Coniferous Forest") +         
           theme_classic() + 
            theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M334.3

}
```


# M341 - Nevada-Utah Mountains Semi-Desert - Coniferous Forest - Alpine Meadow

```{r}
## code control 
fit.models <-  F
```

```{r}
if(fit.models == T) {
  
### cutvec and bin mids
cutvec_M341 <- round(quantile(G_M341$B_plt_t1_MgHa, seq(0,1, length.out = 21)))

## if there are duplicated cut_vec values when using 20 (i.e., 5% quantile bins), then go to 10% quantile bins
if(any(any(duplicated(cutvec_M341)))){
  cutvec_M341 <- round(quantile(G_M341$B_plt_t1_MgHa, seq(0,1, length.out = 11)))
}

bin_mids_M341 <- unname(round(cutvec_M341[-length(cutvec_M341)] + diff(cutvec_M341)/2))

#### add weights data column 
## first get the correct bin  - assign as column in data frame
G_M341$Plt_B_bin <-  cut(G_M341$B_plt_t1_MgHa, cutvec_M341)
## get bin means
G_bin_means <- tapply(G_M341$G_obs_TreeInc_MgHaYr, cut(G_M341$B_plt_t1_MgHa, cutvec_M341), mean)

## make column weights.1
G_M341$nls_weights <- as.vector(1/G_bin_means[match(G_M341$Plt_B_bin, names(G_bin_means))])

}
```

## model selection 1

```{r}
if(fit.models == T) {

# simple
try(
  nls_M341.1 <- nls(fg_1, data = G_M341, 
                   start = c(ge=ge.start, A=A.start, k=k.start), 
                   weights = G_M341$nls_weights), 
 )

## phi
try(
  nls_M341.2 <- nls(fg_2, data=G_M341, 
                   start = c(ge=ge.start, phi=phi.start, A=A.start, k=k.start), 
                   weights = G_M341$nls_weights), 
 )

# phi/alpha
try(
  nls_M341.3 <- nls(fg_3 , data = G_M341, 
                   start = c(ge=ge.start, phi=phi.start, alpha=alpha.start, A=A.start, k=k.start),
                   weights = G_M341$nls_weights), 
 )

## test
if(exists("nls_M341.1") & exists("nls_M341.2") & exists("nls_M341.3")){
  print(anova(nls_M341.1, nls_M341.2, nls_M341.3))
} else if(exists("nls_M341.2") & exists("nls_M341.3")){
  print(anova(nls_M341.2, nls_M341.3))
} else if(exists("nls_M341.1") & exists("nls_M341.2")){
  print(anova(nls_M341.1, nls_M341.2))
}
 
## AIC comparison
AIC1_M341 <- data.frame(model = c(1,2,3), AIC = c(
            ifelse(exists("nls_M341.1"), AIC(get("nls_M341.1")), NA),
            ifelse(exists("nls_M341.2"), AIC(get("nls_M341.2")), NA),
            ifelse(exists("nls_M341.3"), AIC(get("nls_M341.3")), NA)
            ))

print(AIC1_M341) ## print AIC1 table 
            
## min AIC model - store result from model selection 1
Mod.Sel1 <- AIC1_M341[!is.na(AIC1_M341$AIC) & AIC1_M341$AIC == min(AIC1_M341$AIC, na.rm = T),]$model

try(summary(get(paste("nls_M341.",  Mod.Sel1, sep =""))) ) #model summary

}
```
### summary 
* simple model: `r ifelse(exists("nls_M341.1"), "fits", "does not fit")`
* phi model: `r ifelse(exists("nls_M341.2"), "fits", "does not fit")`
* phi-alpha model: `r ifelse(exists("nls_M341.3"), "fits", "does not fit")`

## model selection 2

```{r}
if(length(Mod.Sel1) > 0 & fit.models == T) {

### define parameters from model selection 1
ge.fit <- round(coef(get(paste("nls_M341.",  Mod.Sel1, sep ="")))["ge"], 1)
phi.fit <- round(coef(get(paste("nls_M341.",  Mod.Sel1, sep ="")))["phi"], 1)
alpha.fit <- round(coef(get(paste("nls_M341.",  Mod.Sel1, sep ="")))["alpha"], 1)
A.fit <- round(coef(get(paste("nls_M341.",  Mod.Sel1, sep ="")))["A"], 1)
k.fit <- round(coef(get(paste("nls_M341.",  Mod.Sel1, sep ="")))["k"], 1)

## MODEL FITTING 2 ---------------------------------------------------------------------------- ##
## a-model:  with p parameter
try(
  assign(
    paste("nls_M341.", Mod.Sel1, "a", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "a", sep ="")), 
          data = G_M341,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1)}, 
          weights = G_M341$nls_weights))
 )

## b-model: with s parameter version
try(
  assign(
    paste("nls_M341.", Mod.Sel1, "b", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "b", sep ="")), 
          data = G_M341,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, s=1.5)},
          weights = G_M341$nls_weights)) 
 )

## c-model: with s and p parameters
try(
  assign(
    paste("nls_M341.", Mod.Sel1, "c", sep =""), 
      nls(get(paste("fg_", Mod.Sel1, "c", sep ="")), 
          data = G_M341,
          start = if(Mod.Sel1 == 1) {
            c(ge.fit, A.fit, k.fit, p=0.1, s=1.5)
            } else if(Mod.Sel1 == 2){
              c(ge.fit, phi.fit, A.fit, k.fit, p=0.1, s=1.5)
              } else if(Mod.Sel1 == 3) {
                c(ge.fit, phi.fit, alpha.fit, A.fit, k.fit, p=0.1, s=1.5)},
          weights = G_M341$nls_weights))
 )
## end MODEL FITTING 2 ----------------------------------------------------------------------- ##

## test models  ANOVA  ----------------------------------------------------------------------- ##
  if(exists(paste("nls_M341.", Mod.Sel1, sep ="")) &
     exists(paste("nls_M341.", Mod.Sel1, "a", sep ="")) &
     exists(paste("nls_M341.", Mod.Sel1, "b", sep ="")) &
     exists(paste("nls_M341.", Mod.Sel1, "c", sep =""))
     ) {    ### compare all 3 models plus base model 
       print(anova(get(paste("nls_M341.", Mod.Sel1, sep ="")),
             get(paste("nls_M341.", Mod.Sel1, "a", sep ="")), 
             get(paste("nls_M341.", Mod.Sel1, "b", sep ="")),
             get(paste("nls_M341.", Mod.Sel1, "c", sep =""))
             ))
       } else if(
         exists(paste("nls_M341.", Mod.Sel1, sep ="")) &
         exists(paste("nls_M341.", Mod.Sel1, "a", sep ="")) &
         exists(paste("nls_M341.", Mod.Sel1, "c", sep =""))
       ) {    ### compare base model plus a & c
         print(anova(get(paste("nls_M341.", Mod.Sel1, sep ="")),
               get(paste("nls_M341.", Mod.Sel1, "a", sep ="")), 
               get(paste("nls_M341.", Mod.Sel1, "c", sep =""))
               ))
         } else if(
           exists(paste("nls_M341.", Mod.Sel1, sep ="")) &
           exists(paste("nls_M341.", Mod.Sel1, "c", sep =""))
         ) {    ### compare base model plus c
           print(anova(get(paste("nls_M341.", Mod.Sel1, sep ="")),
                 get(paste("nls_M341.", Mod.Sel1, "c", sep =""))
                 ))
            } else if(
              exists(paste("nls_M341.", Mod.Sel1, sep ="")) &
              exists(paste("nls_M341.", Mod.Sel1, "a", sep =""))
            ) {    ### compare base model plus a
              print(anova(get(paste("nls_M341.", Mod.Sel1, sep ="")),
                    get(paste("nls_M341.", Mod.Sel1, "a", sep =""))
                    ))
              } else if(
                exists(paste("nls_M341.", Mod.Sel1, sep ="")) &
                exists(paste("nls_M341.", Mod.Sel1, "b", sep =""))
              ) {    ### compare base model plus b
                print(anova(get(paste("nls_M341.", Mod.Sel1, sep ="")),
                      get(paste("nls_M341.", Mod.Sel1, "b", sep =""))
                      ))
              }
## end test models  ANOVA  ------------------------------------------------------------------- ##
   
## AIC comparison
AIC2_M341 <- data.frame(model = c(Mod.Sel1, 
                                 paste(Mod.Sel1,"a",sep=""),
                                 paste(Mod.Sel1,"b",sep=""),
                                 paste(Mod.Sel1,"c",sep="")),
                       AIC = c(
            ifelse(exists(paste("nls_M341.",  Mod.Sel1, sep ="")), AIC(get(paste("nls_M341.",  Mod.Sel1, sep =""))), NA),
            ifelse(exists(paste("nls_M341.", Mod.Sel1, "a", sep ="")), AIC(get(paste("nls_M341.", Mod.Sel1, "a", sep =""))), NA),
            ifelse(exists(paste("nls_M341.", Mod.Sel1, "b", sep ="")), AIC(get(paste("nls_M341.", Mod.Sel1, "b", sep =""))), NA), 
            ifelse(exists(paste("nls_M341.", Mod.Sel1, "c", sep ="")), AIC(get(paste("nls_M341.", Mod.Sel1, "c", sep =""))), NA)
            ))

print(AIC2_M341)  ## print AIC2 

## min AIC model - store result from model selection 2
Mod.Sel2 <- AIC2_M341[!is.na(AIC2_M341$AIC) & AIC2_M341$AIC == min(AIC2_M341$AIC, na.rm = T),]$model

## best model -- write the best fitting model to Best_mods df
Best_mods.G[Best_mods.G$Code == "M341",]$Sel.Mod <- Mod.Sel2

## write coefficients to table 
coefs <- coef(get(paste("nls_M341.",  Mod.Sel2, sep ="")))
intervals <- nlstools::confint2(get(paste("nls_M341.",  Mod.Sel2, sep ="")))
intervals_low <- intervals[,1]
intervals_high <- intervals[,2]  ### create them as named number so returns NA if not in vector

nls.param.df2[nls.param.df2$Code == "M341",]$ge <- coefs["ge"]
nls.param.df2[nls.param.df2$Code == "M341",]$phi <- coefs["phi"]
nls.param.df2[nls.param.df2$Code == "M341",]$alpha <- coefs["alpha"]
nls.param.df2[nls.param.df2$Code == "M341",]$A <- coefs["A"]
nls.param.df2[nls.param.df2$Code == "M341",]$k <- coefs["k"]

nls.param.df2[nls.param.df2$Code == "M341",]$ge.2.5 <- intervals_low["ge"]
nls.param.df2[nls.param.df2$Code == "M341",]$phi.2.5 <- intervals_low["phi"]
nls.param.df2[nls.param.df2$Code == "M341",]$alpha.2.5 <- intervals_low["alpha"]
nls.param.df2[nls.param.df2$Code == "M341",]$A.2.5 <- intervals_low["A"]
nls.param.df2[nls.param.df2$Code == "M341",]$k.2.5 <- intervals_low["k"]

nls.param.df2[nls.param.df2$Code == "M341",]$ge.97.5 <- intervals_high["ge"]
nls.param.df2[nls.param.df2$Code == "M341",]$phi.97.5 <- intervals_high["phi"]
nls.param.df2[nls.param.df2$Code == "M341",]$alpha.97.5 <- intervals_high["alpha"]
nls.param.df2[nls.param.df2$Code == "M341",]$A.97.5 <- intervals_high["A"]
nls.param.df2[nls.param.df2$Code == "M341",]$k.97.5 <- intervals_high["k"]
## end write coefficients to table 

## print summary
try(summary(get(paste("nls_M341.",  Mod.Sel2, sep =""))) )

}
```
### summary

* add p model: `r ifelse(exists(paste("nls_M341.", Mod.Sel1, "a", sep ="")), "fits", "does not fit")`
* add s model: `r ifelse(exists(paste("nls_M341.", Mod.Sel1, "b", sep ="")), "fits", "does not fit")`
* add s+p model: `r ifelse(exists(paste("nls_M341.", Mod.Sel1, "c", sep ="")), "fits", "does not fit")`

## plot residuals

```{r}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## calculate residuals
resid_M341 <- nlsResiduals(
  get(paste("nls_M341.",  Mod.Sel2, sep =""))
  )

## plot residuals
plot(resid_M341)

## test residuals
if(length(G_M341$pltID) < 5001) {test.nlsResiduals(resid_M341)}

}  else {print("cannot plot residuals")}
```

## predict and plot

```{r, message = FALSE, cache=T}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

`M341_pred2` <- predict(get(paste("nls_M341.",  Mod.Sel2, sep ="")),
                      newdata = if(Mod.Sel1 == 1){
                        data.frame("MEASTIME_avg"= rep(mean(G_M341$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1))
                      } else if (Mod.Sel1 == 2){
                        data.frame("MEASTIME_avg"= rep(mean(G_M341$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "DeltaPDSI"= rep(mean(G_M341$DeltaPDSI, na.rm =T), 1501))
                      } else if (Mod.Sel1 == 3){
                        data.frame("MEASTIME_avg"= rep(mean(G_M341$MEASTIME_avg, na.rm =T), 1501),
                                   "B_plt_t1_MgHa"=seq(0,1500,by =1),
                                   "B_L_prop"= rep(mean(G_M341$B_L_prop, na.rm =T), 1501), 
                                   "DeltaPDSI"= rep(mean(G_M341$DeltaPDSI, na.rm =T), 1501))
                      } )


## predicted interval data.frame
`M341_pred_df` <- data.frame("B_plt_t1_MgHa" = seq(0,1500,by =1), fitted=`M341_pred2`)

## PLOTTING 2
gg.M341.2 <- ggplot() +
             geom_jitter(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_M341, 
                         alpha = 0.5, color = "#00000080", shape = "+") +
             ## dark ponts = "#1E88E580"
             geom_hline(yintercept =0, lty =3) +
            
             stat_summary_bin(aes(x = B_plt_t1_MgHa, y = G_obs_TreeInc_MgHaYr), data = G_M341, 
                              fun.data = function(x) {
                                res <- c(high.CI(x), mean(x, na.rm=T), low.CI(x))
                                names(res) <- c("ymin","y","ymax")
                                res}, 
                              col = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M341))), breaks = cutvec_M341) +         
    
             # geom_ribbon(aes(x = B_plt_t1_MgHa, ymin = `Prop.2.5%`, ymax = `Prop.97.5%`), 
             #             data = M341_pred_df, color="#FF000080", fill ="#FF000080", alpha = 0.25, lty =3) +
             geom_line(aes(x = B_plt_t1_MgHa, y = fitted), data = `M341_pred_df`, color="#FF000080", alpha = 0.5, lwd = 2) + 
             ## red = "#D6272880" 
    
             labs(x = expression("biomass (Mg ha"^-1*")"), 
                 y = expression("biomass growth (Mg ha"^-1*" yr"^-1*")")) + 
             ggtitle("M341 - Nevada-Utah Mountains Semi-Desert - Coniferous Forest - Alpine Meadow") +
             theme_classic() + theme(axis.text.x=element_text(angle=90,hjust=1)) + 
             scale_x_continuous(limits = c(0, tail(cutvec_M341,1)*1.05), expand =c(0,0)) +
             coord_cartesian(ylim=c(-2, 10))
  
             #ylim(c(min(M341_pred_df$`Prop.2.5%`)-0.25, max(M341_pred_df$`Prop.97.5%`)+0.25))
             #ylim(c(-2,8))
            
gg.M341.2

}  else {print("cannot plot data with prediction")}
```

## plotting 2

```{r, cache=T, message = F}
if(length(Mod.Sel1) > 0 & length(Mod.Sel2) > 0 & fit.models == T) {

## data wrangling:
DM_compare_M341 <-data.frame(
  bin = as.factor(levels(cut(G_M341$B_plt_t1_MgHa, cutvec_M341))),
  data.mean = tapply(G_M341$G_obs_TreeInc_MgHaYr, cut(G_M341$B_plt_t1_MgHa, cutvec_M341), 
                     mean), 
  data.CI.high =  tapply(G_M341$G_obs_TreeInc_MgHaYr, cut(G_M341$B_plt_t1_MgHa, cutvec_M341), 
                    high.CI), 
  data.CI.low = tapply(G_M341$G_obs_TreeInc_MgHaYr, cut(G_M341$B_plt_t1_MgHa, cutvec_M341),
                    low.CI), 
  pred.mean = `M341_pred_df`[`M341_pred_df`$B_plt_t1_MgHa %in% bin_mids_M341,]$fitted) 


### REORDER FACTORS FOR PLOTTING COLORS CORRECTLY 
DM_compare_M341 <-  DM_compare_M341 %>% mutate(bin = forcats::fct_relevel(bin, levels(DM_compare_M341$bin)[gtools::mixedorder(levels(DM_compare_M341$bin))]))
                                                                                                        
## ggplot
gg.M341.3 <- ggplot(aes(x = data.mean, y = pred.mean, color = bin), data = DM_compare_M341) +
           geom_point() +
           geom_pointrange(aes(xmin = data.CI.low, xmax = data.CI.high)) +
           #geom_pointrange(aes(ymin = pred.CI.low, ymax = pred.CI.high)) +
           scale_color_manual(values = scales::seq_gradient_pal("#00FF00", "#FF00FF")(seq(0,1,length.out=length(bin_mids_M341))), 
                              labels = levels(DM_compare_M341$bin), 
                              name = expression("biomass bin (Mg ha"^-1*")")) +
           geom_abline(intercept = 0, slope = 1, lty = 2, size =1,  alpha = 0.5) +         
           labs(x = expression("calculated G (Mg ha"^-1*" yr"^-1*")"), 
                y = expression("nls predicted G (Mg ha"^-1*" yr"^-1*")")) +
           ggtitle("M341 - Nevada-Utah Mountains Semi-Desert - Coniferous Forest - Alpine Meadow") +         
           theme_classic() + 
            theme(legend.position = "top") + tune::coord_obs_pred()
           
gg.M341.3

}
```

---

# Fitted parameters

## Best / selected models by ecoprovince

```{r}
knitr::kable(Best_mods.G) %>% kableExtra::kable_material(c("striped", "hover"))        
```

## table by ecoprovince

```{r, echo = FALSE, cache= T, warning = FALSE}
## clean up the table -- remove the -9999
nls.param.df2[nls.param.df2 == -9999] <- NA
  
  
knitr::kable(nls.param.df2) %>% kableExtra::kable_material(c("striped", "hover"))                      
```

## plot ge

```{r, echo= FALSE, message = FALSE, warning = FALSE, out.width = "200%"}
## order data
nls.param.df2$Ecoregion<- factor(nls.param.df2$Ecoregion, levels = nls.param.df2[order(nls.param.df2$ge), "Ecoregion"])

library(ggplot2)

#### create color vector 
col_vec.ge <- rep(NA, length(nls.param.df2$ge))

for (i in 1:length(nls.param.df2$ge)) {
  if(is.na(nls.param.df2$ge[i])){
     col_vec.ge[i] <-  "white"
  } else if(nls.param.df2$ge.2.5[i]>0) {
       col_vec.ge[i] <- scales::muted("green") 
    } else if(nls.param.df2$ge.97.5[i]<0){
          col_vec.ge[i] <- scales::muted("red")
      } else {
              col_vec.ge[i] <- "gray50"
        }
}
       
gg.ge_ECOSUBCD <- ggplot(aes(x=Ecoregion, y=ge, shape = region), 
                        data = nls.param.df2) + 
                 geom_hline(yintercept =0, lty = 2) +
                 geom_point(size = 2, col = col_vec.ge) + 
                 geom_errorbar(aes(ymax =  ge.2.5, ymin = ge.97.5), 
                               col = col_vec.ge) + 
                 theme_classic() + coord_flip() + 
                 labs(y =expression(italic("ge")*"(%)"), x = "Ecoregion") + 
                 scale_shape_manual(values = c(16,15,17)) + 
                 theme(legend.position = "top") + ylim(c(-5,9))

#tiff(file = "nls_ge_byEcoregion_part2_9.2.2022.tiff", width = 25, height = 14, units = "cm", res = 600, compression = "lzw")
gg.ge_ECOSUBCD
#dev.off()
```

### map

```{r, message = F, warning = F}
############################################################
##################################### CODE FOR MAP PREP
############################################################

## libraries
library(tidyverse)
library(rgdal)
library(broom)
library(ggplot2)
library(ggpattern)
library(ggthemes)

############################################################
## read in the shape file 
spdf <- readOGR(dsn="C:/Users/hogan.jaaron/Dropbox/FIA_R/Mapping/S_USA.EcoMapProvinces/S_USA.EcoMapProvinces.shp")
# spdf <- readOGR(dsn="C:/Users/hogie/Dropbox/FIA_R/Mapping/S_USA.EcoMapProvinces/S_USA.EcoMapProvinces.shp")               # IF WORKING ON P-50

### tidy up 
spdf_tidy <- tidy(spdf)

## left_join
spdf$id <- row.names(spdf)
spdf_tidy <- left_join(spdf_tidy, spdf@data)

## add in the growth Enhancemnet data
## including missing rows
ge_df <-  data.frame(ECOPROVCD = as.factor(c(nls.param.df2$Code,c("Water"))), ge = as.numeric(c(nls.param.df2[,"ge"],  rep("NA", 1))))

## order data
nls.param.df2$Ecoregion<- factor(nls.param.df2$Ecoregion, levels = nls.param.df2[order(nls.param.df2$ge), "Ecoregion"])

library(ggplot2)

### add row for fill classification - statistically significant ge / data deficient etc.
ge_df$classification <- rep(NA, length(ge_df$ge))
  
for (i in 1:length(ge_df$ge)) {
  if(ge_df$ECOPROVCD[i] == "Water") {
    ge_df$classification[i] <- "Water"
    }else if(is.na(ge_df$ge[i])){
      ge_df$classification[i] <-  "data deficient"
      } else if(nls.param.df2$ge.2.5[i]>0) {
        ge_df$classification[i] <- "signif"  
        } else if(nls.param.df2$ge.97.5[i]<0) {
          ge_df$classification[i] <- "signif" 
          } else {
            ge_df$classification[i] <- "non-significant"
            } 
}

ge_df$classification <- as.factor(ge_df$classification)

###ge_df$ge <- as.factor(ge_df$ge)

### left_join
spdf_tidy <- left_join(spdf_tidy, ge_df, by = c("MAP_UNIT_S" = "ECOPROVCD"), keep = T)

############ ---------------------------------------------------------------------------------------  ############
######################### MAPPING ###################

## https://timogrossenbacher.ch/2016/12/beautiful-thematic-maps-with-ggplot2-only/

## theme
theme_map <- function(...) {
  theme_minimal() +
    theme(
      text = element_text(family = "Ubuntu Regular", color = "#22211d"),
      axis.line = element_blank(),
      axis.text.x = element_blank(),
      axis.text.y = element_blank(),
      axis.ticks = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      # panel.grid.minor = element_line(color = "#ebebe5", size = 0.2),
      panel.grid.major = element_line(color = "#ebebe5", size = 0.2),
      panel.grid.minor = element_blank(),
      plot.background = element_rect(fill = "#f5f5f2", color = NA), 
      panel.background = element_rect(fill = "#f5f5f2", color = NA), 
      legend.background = element_rect(fill = "#f5f5f2", color = NA),
      panel.border = element_blank(),
      ...
    )
}

```

```{r, message = F, warning = F}

############ ---------------------------------------------------------------------------------------  ############
## map again, with fill for ge

mapper <- ggplot(aes(x = long, y = lat, group = group, fill = ge), data = spdf_tidy) +
  geom_polygon(color = "black", size = 0.1)  +
  coord_equal() +   
  theme_map() + 
  theme(legend.position = "bottom") + 
  metR::scale_fill_divergent(    
                      low = scales::muted("red"),
                       mid = "white",
                       high = scales::muted("green"),
                     name = "biomass growth enhancement (%/yr)",
                     # here we use guide_colourbar because it is still a continuous scale
                     guide = guide_colorbar(
                       direction = "horizontal",
                       barheight = unit(2, units = "mm"),
                       barwidth = unit(50, units = "mm"),
                       draw.ulim = F,
                       title.position = 'top',
                       # some shifting around
                       title.hjust = 0.5,
                       label.hjust = 0.5)) 

mapper
```

### map2

```{r}
library(ggnewscale)

mapper2  <- ggplot(aes(x = long, y = lat, group = group), data = spdf_tidy) +
  geom_polygon(aes_string(fill = "ge"), data = spdf_tidy[spdf_tidy$classification == "signif",], color = "black", size = 0.1)  +
  metR::scale_fill_divergent(
                       low = scales::muted("red"),
                       mid = "white",
                       high = scales::muted("green"),
                       name = "biomass growth enhancement (%/yr)",
                       # here we use guide_colourbar because it is still a continuous scale
                       guide = guide_colorbar(
                       direction = "horizontal",
                       barheight = unit(2, units = "mm"),
                       barwidth = unit(50, units = "mm"),
                       draw.ulim = F,
                       title.position = 'top',
                       # some shifting around
                       title.hjust = 0.5,
                       label.hjust = 0.5)) +   
  new_scale_fill() + 
  geom_polygon(aes_string(fill="classification"), data = spdf_tidy[!spdf_tidy$classification == "signif",], color = "black", size = 0.1)  +
  scale_fill_manual(values = c("#404040", "#BABABA", "dark blue")) +
  coord_equal() + theme(legend.position = "bottom") +
  theme_map() 
 

#+ 
  #geom_segment(data=lines, aes(x= x, y = y , xend = xend, yend = yend), 
               #inherit.aes = F, color = "black", alpha = 0.25)

mapper2
```


## plot phi (effect of DeltaPDSI)

```{r, echo= FALSE, message = FALSE, warning = FALSE, out.width = "200%"}
nls.param.df2 <- nls.param.df2[order(nls.param.df2$phi),]

nls.param.df2$Ecoregion <- factor(nls.param.df2$Ecoregion, levels = nls.param.df2[order(nls.param.df2$phi), "Ecoregion"])

library(ggplot2)

#### create color vector 
col_vec.phi <- rep(NA, length(nls.param.df2$phi))

for (i in 1:length(nls.param.df2$phi)) {
  if(is.na(nls.param.df2$phi[i])){
     col_vec.phi[i] <-  "white"
  } else if(nls.param.df2$phi.2.5[i]>0) {
       col_vec.phi[i] <- scales::muted("blue") 
    } else if(nls.param.df2$phi.97.5[i]<0){
          col_vec.phi[i] <- scales::muted("orange")
      } else {
              col_vec.phi[i] <- "gray50"
        }
}

gg.phi_ECOSUBCD <- ggplot(aes(x=Ecoregion, y=phi, shape = region), 
                        data = nls.param.df2) + 
                 geom_hline(yintercept =0, lty = 2) +
                 geom_point(size = 2, col = col_vec.phi) + 
                 geom_errorbar(aes(ymax =  phi.2.5, ymin = phi.97.5), 
                               col = col_vec.phi) + 
                 theme_classic() + coord_flip() + 
                 labs(y = expression(italic("\u03D5")), x = "Ecoregion") + 
                 scale_shape_manual(values = c(16,15,17)) + 
                 theme(legend.position = "top") + ylim(c(-0.25,0.25))

#tiff(file = "nls_ge_byEcoregion_part1_9.2.2022.tiff", width = 25, height = 14, units = "cm", res = 600, compression = "lzw")
gg.phi_ECOSUBCD
#dev.off()
```

## plot alpha (biomass growth compensation effect)

```{r, echo= FALSE, message = FALSE, warning = FALSE, out.width = "200%"}
nls.param.df2 <- nls.param.df2[order(nls.param.df2$alpha),]

nls.param.df2$Ecoregion<- factor(nls.param.df2$Ecoregion, levels = nls.param.df2[order(nls.param.df2$alpha), "Ecoregion"])

library(ggplot2)

gg.alpha_ECOSUBCD <- ggplot(aes(x=Ecoregion, y=alpha, shape = region), 
                        data = nls.param.df2) + 
                 geom_hline(yintercept =0.5, lty = 2) +
                 geom_hline(yintercept =1, lty = 2) +
                 geom_point(size = 2) + 
                 geom_errorbar(aes(ymax = alpha.2.5, ymin = alpha.97.5)) + 
                 theme_classic() + coord_flip() + 
                 labs(y =expression(italic("\u03B1")), x = "Ecoregion") + 
                 scale_shape_manual(values = c(16,15,17)) + 
                 theme(legend.position = "top") + ylim(c(0,1.5))

#tiff(file = "nls_ge_byEcoregion_part1_9.2.2022.tiff", width = 25, height = 14, units = "cm", res = 600, compression = "lzw")
gg.alpha_ECOSUBCD
#dev.off()
```

## plot A (asymptote of forest biomass growth in Mg/ha/yr)

```{r}
nls.param.df2 <- nls.param.df2[order(nls.param.df2$A),]

nls.param.df2$Ecoregion<- factor(nls.param.df2$Ecoregion, levels = nls.param.df2[order(nls.param.df2$A), "Ecoregion"])

library(ggplot2)


gg.A_ECOSUBCD <- ggplot(aes(x=Ecoregion, y=A, shape = region), 
                        data = nls.param.df2) + 
                 geom_hline(yintercept =0, lty = 2) +
                 geom_point(size = 2) + 
                 geom_errorbar(aes(ymax = A.2.5, ymin = A.97.5)) + 
                 theme_classic() + coord_flip() + 
                 labs(y = expression(italic("A")*" (Mg ha"^-1*")"), x = "Ecoregion") + 
                 scale_shape_manual(values = c(16,15,17)) + 
                 theme(legend.position = "top") + ylim(c(-2,22))

#tiff(file = "nls_ge_byEcoregion_part1_9.2.2022.tiff", width = 25, height = 14, units = "cm", res = 600, compression = "lzw")
gg.A_ECOSUBCD
#dev.off()
```

## plot k (stand biomass at half biomss G in Mg/ha)

```{r}
nls.param.d2f <- nls.param.df2[order(nls.param.df2$k),]

nls.param.df2$Ecoregion<- factor(nls.param.df2$Ecoregion, levels = nls.param.df2[order(nls.param.df2$k), "Ecoregion"])

library(ggplot2)

               
gg.k_ECOSUBCD <- ggplot(aes(x=Ecoregion, y=k, shape = region), 
                        data = nls.param.df2) + 
                 geom_hline(yintercept =0, lty = 2) +
                 geom_point(size = 2) + 
                 geom_errorbar(aes(ymax = k.2.5, ymin = k.97.5)) + 
                 theme_classic() + coord_flip() + 
                 labs(y = expression(italic("k")*" (Mg ha"^-1*")"), x = "Ecoregion") + 
                 scale_shape_manual(values = c(16,15,17)) + 
                 theme(legend.position = "top") + ylim(c(-300,1500))

#tiff(file = "nls_ge_byEcoregion_part1_9.2.2022.tiff", width = 25, height = 14, units = "cm", res = 600, compression = "lzw")
gg.k_ECOSUBCD
#dev.off()
```

# Caclulations - weighted averages

## ge (stand biomass growth enhancement factor in % 2000-2021)

```{r}
## note numbers in comments after code are first set of results (reported for ESA 2022 initial abstract submission)

weighted.ge.df2 <-  data.frame(
  region = c("entire US", "pacific", "east", "interior west"),
## all
  "weighted ge" = c(sum(nls.param.df2$ge*nls.param.df2$n.plots, na.rm = T) /sum(nls.param.df2$n.plots, na.rm = T) #0.3650677
,
## pacific
sum(nls.param.df2[nls.param.df2$region == "pacific",]$ge * nls.param.df2[nls.param.df2$region == "pacific",]$n.plots, na.rm = T) / sum(nls.param.df2[nls.param.df2$region == "pacific",]$n.plots, na.rm = T) #0.7590908
,
## east 
sum(nls.param.df2[nls.param.df2$region == "east",]$ge * nls.param.df2[nls.param.df2$region == "east",]$n.plots, na.rm = T) / sum(nls.param.df2[nls.param.df2$region == "east",]$n.plots, na.rm = T) #0.2836302
,
## interior west
sum(nls.param.df2[nls.param.df2$region == "interior west",]$ge * nls.param.df2[nls.param.df2$region == "interior west",]$n.plots, na.rm = T) / sum(nls.param.df2[nls.param.df2$region == "interior west",]$n.plots, na.rm = T) # 0.3980526 
))

weighted.ge.df2
```

## phi (effect of DeltaPDSI)

```{r}
## note numbers in comments after code are first set of results (reported for ESA 2022 intial abstract submission)

weighted.phi.df2 <-  data.frame(
  region = c("entire US", "pacific",  "east", "interior west"),
## all
  "weighted phi" = c(sum(nls.param.df2$phi*nls.param.df2$n.plots, na.rm = T) /sum(nls.param.df2$n.plots,  na.rm = T) #0.3650677
,
## pacific
sum(nls.param.df2[nls.param.df2$region == "pacific",]$phi * nls.param.df2[nls.param.df2$region == "pacific",]$n.plots, na.rm = T) / sum(nls.param.df2[nls.param.df2$region == "pacific",]$n.plots,  na.rm = T) #0.7590908
,
## east 
sum(nls.param.df2[nls.param.df2$region == "east",]$phi * nls.param.df2[nls.param.df2$region == "east",]$n.plots, na.rm = T) / sum(nls.param.df2[nls.param.df2$region == "east",]$n.plots, na.rm = T) #0.2836302
,
## interior west
sum(nls.param.df2[nls.param.df2$region == "interior west",]$phi * nls.param.df2[nls.param.df2$region == "interior west",]$n.plots, na.rm = T) / sum(nls.param.df2[nls.param.df2$region == "interior west",]$n.plots,  na.rm = T) # 0.3980526 
))

weighted.phi.df2
```

## alpha (biomass growth compensation effect)

```{r}
## note numbers in comments after code are first set of results (reported for ESA 2022 intial abstract submission)

weighted.alpha.df2 <-  data.frame(
  region = c("entire US", "pacific",  "east", "interior west"),
## all
  "weighted alpha" = c(sum(nls.param.df2$alpha*nls.param.df2$n.plots, na.rm = T) /sum(nls.param.df2$n.plots,  na.rm = T) #0.3650677
,
## pacific
sum(nls.param.df2[nls.param.df2$region == "pacific",]$alpha * nls.param.df2[nls.param.df2$region == "pacific",]$n.plots, na.rm = T) / sum(nls.param.df2[nls.param.df2$region == "pacific",]$n.plots,  na.rm = T) #0.7590908
,
## east 
sum(nls.param.df2[nls.param.df2$region == "east",]$alpha * nls.param.df2[nls.param.df2$region == "east",]$n.plots, na.rm = T) / sum(nls.param.df2[nls.param.df2$region == "east",]$n.plots,  na.rm = T) #0.2836302
,
## interior west
sum(nls.param.df2[nls.param.df2$region == "interior west",]$alpha * nls.param.df2[nls.param.df2$region == "interior west",]$n.plots, na.rm = T) / sum(nls.param.df2[nls.param.df2$region == "interior west",]$n.plots, na.rm = T) # 0.3980526 
))

weighted.alpha.df2
```

## A (asymptote of forest biomass growth in Mg/ha/yr)

```{r}
weighted.A.df2 <-  data.frame(
  region = c("entire US", "pacific", "east", "interior west"),
  ## all
 "weighted A" = c(sum(nls.param.df2$A*nls.param.df2$n.plots, na.rm =T) /sum(nls.param.df2$n.plots, na.rm = T) 
,
## pacific
sum(nls.param.df2[nls.param.df2$region == "pacific",]$A * nls.param.df2[nls.param.df2$region == "pacific",]$n.plots, na.rm =T) / sum(nls.param.df2[nls.param.df2$region == "pacific",]$n.plots, na.rm = T) 
,
## east 
sum(nls.param.df2[nls.param.df2$region == "east",]$A * nls.param.df2[nls.param.df2$region == "east",]$n.plots, na.rm =T) / sum(nls.param.df2[nls.param.df2$region == "east",]$n.plots, na.rm = T)
,
## west
sum(nls.param.df2[nls.param.df2$region == "interior west",]$A * nls.param.df2[nls.param.df2$region == "interior west",]$n.plots, na.rm =T) / sum(nls.param.df2[nls.param.df2$region == "interior west",]$n.plots, na.rm = T)))


weighted.A.df2
```

## K (stand biomass at half biomss G in Mg/ha)

```{r}
weighted.k.df2 <-  data.frame(
  region = c("entire US", "pacific",  "east", "interior west"),
## all
 "weighted k" = c(sum(nls.param.df2$k*nls.param.df2$n.plots, na.rm =T) /sum(nls.param.df2$n.plots, na.rm =T) 
,
## pacific
sum(nls.param.df2[nls.param.df2$region == "pacific",]$k * nls.param.df2[nls.param.df2$region == "pacific",]$n.plots, na.rm =T) / sum(nls.param.df2[nls.param.df2$region == "pacific",]$n.plots, na.rm =T) 
,
## east 
sum(nls.param.df2[nls.param.df2$region == "east",]$k * nls.param.df2[nls.param.df2$region == "east",]$n.plots, na.rm =T) / sum(nls.param.df2[nls.param.df2$region == "east",]$n.plots, na.rm =T)
,
## west
sum(nls.param.df2[nls.param.df2$region == "interior west",]$k * nls.param.df2[nls.param.df2$region == "interior west",]$n.plots, na.rm =T) / sum(nls.param.df2[nls.param.df2$region == "interior west",]$n.plots, na.rm =T)))

weighted.k.df2
```


# Calculations - weighted averages subsetted to 15 ecoprovinces

* ecoprovince codes: 211, 212, 221, 223, 231, 232, 234, 251, M211, M221, M223, M231, M242, M261, M332

```{r}
nls.param.df2_sub <- nls.param.df2[nls.param.df2$Code %in% c("211","212","221","223","231","232","234","251","M211","M221","M223","M242","M261","M332","M231"), ]
```

## ge
```{r}
weighted.ge.df2_sub <-  data.frame(
  region = c("entire US", "pacific",  "east", "interior west"),
## all
  "weighted ge" = c(sum(nls.param.df2_sub$ge*nls.param.df2_sub$n.plots, na.rm = T) /sum(nls.param.df2_sub$n.plots, na.rm = T) #0.3650677
,
## pacific
sum(nls.param.df2_sub[nls.param.df2_sub$region == "pacific",]$ge * nls.param.df2_sub[nls.param.df2_sub$region == "pacific",]$n.plots, na.rm = T) / sum(nls.param.df2_sub[nls.param.df2_sub$region == "pacific",]$n.plots, na.rm = T) #0.7590908
,
## east 
sum(nls.param.df2_sub[nls.param.df2_sub$region == "east",]$ge * nls.param.df2_sub[nls.param.df2_sub$region == "east",]$n.plots, na.rm = T) / sum(nls.param.df2_sub[nls.param.df2_sub$region == "east",]$n.plots, na.rm = T) #0.2836302
,
## west
sum(nls.param.df2_sub[nls.param.df2_sub$region == "interior west",]$ge * nls.param.df2_sub[nls.param.df2_sub$region == "interior west",]$n.plots, na.rm = T) / sum(nls.param.df2_sub[nls.param.df2_sub$region == "interior west",]$n.plots, na.rm = T) # 0.3980526 
))

weighted.ge.df2_sub
```

## phi
```{r}
## note numbers in comments after code are first set of results (reported for ESA 2022 intial abstract submission)

weighted.phi.df2_sub <-  data.frame(
  region = c("entire US", "pacific", "east", "interior west"),
## all
  "weighted phi" = c(sum(nls.param.df2_sub$phi*nls.param.df2_sub$n.plots, na.rm = T) /sum(nls.param.df2_sub$n.plots) #0.3650677
,
## pacific
sum(nls.param.df2_sub[nls.param.df2_sub$region == "pacific",]$phi * nls.param.df2_sub[nls.param.df2_sub$region == "pacific",]$n.plots, na.rm = T) / sum(nls.param.df2_sub[nls.param.df2_sub$region == "pacific",]$n.plots, na.rm = T) #0.7590908
,
## east 
sum(nls.param.df2_sub[nls.param.df2_sub$region == "east",]$phi * nls.param.df2_sub[nls.param.df2_sub$region == "east",]$n.plots, na.rm = T) / sum(nls.param.df2_sub[nls.param.df2_sub$region == "east",]$n.plots, na.rm = T) #0.2836302
,
## west
sum(nls.param.df2_sub[nls.param.df2_sub$region == "interior west",]$phi * nls.param.df2_sub[nls.param.df2_sub$region == "interior west",]$n.plots, na.rm = T) / sum(nls.param.df2_sub[nls.param.df2_sub$region == "interior west",]$n.plots, na.rm = T))) # 0.3980526 ))

weighted.phi.df2_sub
```

## alpha
```{r}
## note numbers in comments after code are first set of results (reported for ESA 2022 intial abstract submission)

weighted.alpha.df2_sub <-  data.frame(
  region = c("entire US", "pacific", "east", "interior west"),
## all
  "weighted alpha" = c(sum(nls.param.df2_sub$alpha*nls.param.df2_sub$n.plots, na.rm = T) /sum(nls.param.df2_sub$n.plots) #0.3650677
,
## pacific
sum(nls.param.df2_sub[nls.param.df2_sub$region == "pacific",]$alpha * nls.param.df2_sub[nls.param.df2_sub$region == "pacific",]$n.plots, na.rm = T) / sum(nls.param.df2_sub[nls.param.df2_sub$region == "pacific",]$n.plots) #0.7590908
,
## east 
sum(nls.param.df2_sub[nls.param.df2_sub$region == "east",]$alpha * nls.param.df2_sub[nls.param.df2_sub$region == "east",]$n.plots, na.rm = T) / sum(nls.param.df2_sub[nls.param.df2_sub$region == "east",]$n.plots) #0.2836302
,
## west
sum(nls.param.df2_sub[nls.param.df2_sub$region == "interior west",]$alpha * nls.param.df2_sub[nls.param.df2_sub$region == "interior west",]$n.plots, na.rm = T) / sum(nls.param.df2_sub[nls.param.df2_sub$region == "interior west",]$n.plots) # 0.3980526 
))

weighted.alpha.df2_sub
```
